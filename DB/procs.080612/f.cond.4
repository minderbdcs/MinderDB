COMMIT WORK;
SET AUTODDL OFF;
SET TERM ^ ;
 
DROP   TRIGGER DELETE_PRODUCT_COND_STATUS ^

COMMIT^


CREATE TRIGGER DELETE_PRODUCT_COND_STATUS FOR PRODUCT_COND_STATUS 
ACTIVE AFTER DELETE POSITION 10 
AS 

  DECLARE VARIABLE REC_EXIST INTEGER;
  DECLARE VARIABLE WK_GLOBAL VARCHAR(30);
  DECLARE VARIABLE WK_SSN_ID VARCHAR(20) ;
  DECLARE VARIABLE CODE VARCHAR(1) ;
  DECLARE VARIABLE ORIGINAL VARCHAR(1) ;
  DECLARE VARIABLE ADD_PROD VARCHAR(1) ;
  DECLARE VARIABLE WK_NOFAULT CHAR(1) ;
BEGIN
  REC_EXIST = 0;

  
  WK_SSN_ID = OLD.SSN_ID;

  /* test A */
  CODE = 'A';
  /* only interested in 'S' records */
  ORIGINAL = 'S';
  /* Check if record exists */
  REC_EXIST = 0;
  SELECT FIRST 1 1
  FROM PRODUCT_COND_STATUS
  WHERE SSN_ID = :WK_SSN_ID
  AND CODE = :CODE
  AND ORIGINAL_TEST = :ORIGINAL
  INTO :REC_EXIST;

  /* if record not exists then insert */
  IF (REC_EXIST = 0) THEN
  BEGIN
    /* no fault found */
     WK_NOFAULT = 'P';
     EXECUTE PROCEDURE UPDATE_SSN_PRODUCT_COND_STATUS :WK_SSN_ID , :CODE , :ORIGINAL , :WK_NOFAULT ;
  END
  ELSE
  BEGIN
    /* fault found */
     WK_NOFAULT = 'F';
     EXECUTE PROCEDURE UPDATE_SSN_PRODUCT_COND_STATUS :WK_SSN_ID , :CODE , :ORIGINAL , :WK_NOFAULT ;
  END

  /* test B */
  CODE = 'B';
  /* Check if record exists */
  REC_EXIST = 0;
  SELECT FIRST 1 1
  FROM PRODUCT_COND_STATUS
  WHERE SSN_ID = :WK_SSN_ID
  AND CODE = :CODE
  AND ORIGINAL_TEST = :ORIGINAL
  INTO :REC_EXIST;

  /* if record not exists then insert */
  IF (REC_EXIST = 0) THEN
  BEGIN
    /* no fault found */
     WK_NOFAULT = 'P';
     EXECUTE PROCEDURE UPDATE_SSN_PRODUCT_COND_STATUS :WK_SSN_ID , :CODE , :ORIGINAL , :WK_NOFAULT ;
  END
  ELSE
  BEGIN
    /* fault found */
     WK_NOFAULT = 'F';
     EXECUTE PROCEDURE UPDATE_SSN_PRODUCT_COND_STATUS :WK_SSN_ID , :CODE , :ORIGINAL , :WK_NOFAULT ;
  END

  /* test C */
  CODE = 'C';
  /* Check if record exists */
  REC_EXIST = 0;
  SELECT FIRST 1 1
  FROM PRODUCT_COND_STATUS
  WHERE SSN_ID = :WK_SSN_ID
  AND CODE = :CODE
  AND ORIGINAL_TEST = :ORIGINAL
  INTO :REC_EXIST;

  /* if record not exists then insert */
  IF (REC_EXIST = 0) THEN
  BEGIN
    /* no fault found */
     WK_NOFAULT = 'P';
     EXECUTE PROCEDURE UPDATE_SSN_PRODUCT_COND_STATUS :WK_SSN_ID , :CODE , :ORIGINAL , :WK_NOFAULT ;
  END
  ELSE
  BEGIN
    /* fault found */
     WK_NOFAULT = 'F';
     EXECUTE PROCEDURE UPDATE_SSN_PRODUCT_COND_STATUS :WK_SSN_ID , :CODE , :ORIGINAL , :WK_NOFAULT ;
  END

  /* test D */
  CODE = 'D';
  /* Check if record exists */
  REC_EXIST = 0;
  SELECT FIRST 1 1
  FROM PRODUCT_COND_STATUS
  WHERE SSN_ID = :WK_SSN_ID
  AND CODE = :CODE
  AND ORIGINAL_TEST = :ORIGINAL
  INTO :REC_EXIST;

  /* if record not exists then insert */
  IF (REC_EXIST = 0) THEN
  BEGIN
    /* no fault found */
     WK_NOFAULT = 'P';
     EXECUTE PROCEDURE UPDATE_SSN_PRODUCT_COND_STATUS :WK_SSN_ID , :CODE , :ORIGINAL , :WK_NOFAULT ;
  END
  ELSE
  BEGIN
    /* fault found */
     WK_NOFAULT = 'F';
     EXECUTE PROCEDURE UPDATE_SSN_PRODUCT_COND_STATUS :WK_SSN_ID , :CODE , :ORIGINAL , :WK_NOFAULT ;
  END
END ^


SET TERM ; ^
COMMIT WORK;
SET AUTODDL ON;
