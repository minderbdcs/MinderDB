COMMIT WORK;
SET AUTODDL OFF;
SET TERM ^ ;
 

CREATE OR ALTER TRIGGER RUN_TRANSACTION_GNNP FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 160
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_ERROR_TEXT    VARCHAR(255);
/* DECLARE VARIABLE WK_NEW_GRN       VARCHAR(10); */
DECLARE VARIABLE WK_NEW_GRN       GRN;
/* DECLARE VARIABLE WK_OLD_GRN       VARCHAR(10); */
DECLARE VARIABLE WK_OLD_GRN       GRN;
/* DECLARE VARIABLE WK_OLD_ORDER_NO  VARCHAR(10); */
DECLARE VARIABLE WK_OLD_ORDER_NO  ORDER_NO;
/* DECLARE VARIABLE WK_OLD_LINE_NO   VARCHAR(4); */
DECLARE VARIABLE WK_OLD_LINE_NO   ORDER_LINE;
DECLARE VARIABLE WK_OLD_PROD_ID   PRODUCT;
/* DECLARE VARIABLE WK_NEW_ORDER_NO  VARCHAR(10); */
DECLARE VARIABLE WK_NEW_ORDER_NO  ORDER_NO;
/* DECLARE VARIABLE WK_NEW_LINE_NO   VARCHAR(4); */
DECLARE VARIABLE WK_NEW_LINE_NO   ORDER_LINE;
DECLARE VARIABLE WK_NEW_PROD_ID   PRODUCT;
DECLARE VARIABLE WK_RESULT        INTEGER;
DECLARE VARIABLE RECORD_ID        INTEGER;
DECLARE VARIABLE WK_COMPLETE      VARCHAR(1);
BEGIN
   WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
   IF (WK_AUTORUN = 1) THEN
   BEGIN
      IF (NEW.TRN_TYPE = 'GNNP') THEN
      BEGIN
         IF ((NEW.TRN_CODE = 'P') ) THEN
         BEGIN
            /* here the P is for a purchase order */
            WK_OLD_GRN = '';
            WK_NEW_GRN = '';
            WK_OLD_ORDER_NO = '';
            WK_OLD_LINE_NO = '';
            WK_NEW_ORDER_NO = '';
            WK_NEW_LINE_NO = '';
            WK_ERROR_TEXT = '';
            WK_COMPLETE = 'F'; 
            /* here the company is the company of the grn */
            SELECT WK_FIELD_TEXT FROM GET_REFERENCE_FIELD4 (NEW.REFERENCE, 1, '|' ) INTO :WK_OLD_GRN ;
            SELECT WK_FIELD_TEXT FROM GET_REFERENCE_FIELD4 (NEW.REFERENCE, 2, '|' ) INTO :WK_OLD_ORDER_NO ;
            SELECT WK_FIELD_TEXT FROM GET_REFERENCE_FIELD4 (NEW.REFERENCE, 3, '|' ) INTO :WK_OLD_LINE_NO ;
            SELECT WK_FIELD_TEXT FROM GET_REFERENCE_FIELD4 (NEW.REFERENCE, 4, '|' ) INTO :WK_NEW_ORDER_NO ;
            SELECT WK_FIELD_TEXT FROM GET_REFERENCE_FIELD4 (NEW.REFERENCE, 5, '|' ) INTO :WK_NEW_LINE_NO ;
            EXECUTE PROCEDURE GRN_CHANGE_PRODUCT_ID (
            :WK_OLD_GRN,
            :WK_OLD_ORDER_NO,
            :WK_OLD_LINE_NO,
            :WK_NEW_ORDER_NO,
            :WK_NEW_LINE_NO,
            NEW.QTY,
            NEW.REFERENCE,    
            NEW.PERSON_ID,
            NEW.DEVICE_ID,
            NEW.TRN_DATE)
            RETURNING_VALUES :WK_NEW_GRN, :WK_COMPLETE, :WK_ERROR_TEXT;
            RECORD_ID = NEW.RECORD_ID;
            EXECUTE PROCEDURE UPDATE_TRAN (:RECORD_ID, :WK_COMPLETE, :WK_ERROR_TEXT);
         END
         IF ((NEW.TRN_CODE = 'L') ) THEN
         BEGIN
            /* here the L is for a Load of Product */
            WK_OLD_GRN = '';
            WK_NEW_GRN = '';
            WK_OLD_PROD_ID = '';
            WK_NEW_PROD_ID = '';
            WK_ERROR_TEXT = '';
            WK_COMPLETE = 'F'; 
            /* here the company is the company of the grn */
            SELECT WK_FIELD_TEXT FROM GET_REFERENCE_FIELD4 (NEW.REFERENCE, 1, '|' ) INTO :WK_OLD_GRN ;
            SELECT WK_FIELD_TEXT FROM GET_REFERENCE_FIELD4 (NEW.REFERENCE, 2, '|' ) INTO :WK_OLD_PROD_ID ;
            SELECT WK_FIELD_TEXT FROM GET_REFERENCE_FIELD4 (NEW.REFERENCE, 3, '|' ) INTO :WK_NEW_PROD_ID ;
            EXECUTE PROCEDURE GRN_CHANGE_LOAD_PRODUCT_ID (
            :WK_OLD_GRN,
            :WK_OLD_PROD_ID,
            :WK_NEW_PROD_ID,
            NEW.QTY,
            NEW.REFERENCE,    
            NEW.PERSON_ID,
            NEW.DEVICE_ID,
            NEW.TRN_DATE)
            RETURNING_VALUES :WK_NEW_GRN, :WK_COMPLETE, :WK_ERROR_TEXT;
            RECORD_ID = NEW.RECORD_ID;
            EXECUTE PROCEDURE UPDATE_TRAN (:RECORD_ID, :WK_COMPLETE, :WK_ERROR_TEXT);
         END
         /* EXECUTE PROCEDURE TRAN_ARCHIVE; */
      END
   END
END ^


SET TERM ; ^
COMMIT WORK;
SET AUTODDL ON;
