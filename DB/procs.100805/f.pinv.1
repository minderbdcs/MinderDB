COMMIT WORK;
SET AUTODDL OFF;
SET TERM ^ ;

CREATE GENERATOR PICK_INVOICE_GEN^
CREATE GENERATOR PICK_INVOICE_START^
CREATE GENERATOR PICK_INVOICE_STOP^
CREATE GENERATOR PICK_INVOICE_PREFIX ^
SET GENERATOR PICK_INVOICE_STOP TO 99999^
SET GENERATOR PICK_INVOICE_PREFIX TO 82^

ALTER TABLE PICK_DESPATCH ADD INVOICE_NO INVOICE_NO^
ALTER TABLE PICK_DESPATCH ADD INVOICE_TYPE CODE_TWO^
CREATE INDEX PICK_DESPATCH_INVOICE_TYPE ON PICK_DESPATCH(INVOICE_TYPE)^

INSERT INTO PARAM(DATA_ID,MAX_LENGTH,DATA_TYPE,FIXED_LENGTH,SYMBOLOGY_PREFIX,DATA_EXPRESSION ) VALUES('INVOICE_NO','6','1','T',';','[A-Z0-9]*')^

CREATE OR ALTER PROCEDURE GET_PICK_INVOICE_NO RETURNS (PICK_INVOICE_NO VARCHAR(10) )
AS 

DECLARE VARIABLE WK_INVOICE_LENGTH INTEGER;
DECLARE VARIABLE WK_PICK_INVOICE_NO CHAR(10);
DECLARE VARIABLE WK_PICK_INVOICE_START INTEGER;
DECLARE VARIABLE WK_PICK_INVOICE_STOP INTEGER;
DECLARE VARIABLE WK_PICK_INVOICE_PREFIX INTEGER;
DECLARE VARIABLE WK_LEN_INVOICE_NO INTEGER;
DECLARE VARIABLE WK_PICK_ADJUSTMENT INTEGER;
     
BEGIN
   SELECT MAX_LENGTH FROM PARAM WHERE DATA_ID = 'INVOICE_NO' INTO :WK_INVOICE_LENGTH;
  IF (WK_INVOICE_LENGTH IS NULL) THEN
  BEGIN
     WK_INVOICE_LENGTH = 6;
  END
   WK_PICK_INVOICE_NO = GEN_ID(PICK_INVOICE_GEN, 1);
   WK_PICK_INVOICE_START = GEN_ID(PICK_INVOICE_START, 0);
   WK_PICK_INVOICE_STOP = GEN_ID(PICK_INVOICE_STOP, 0);
   WK_PICK_INVOICE_PREFIX = GEN_ID(PICK_INVOICE_PREFIX , 0);
   IF (WK_PICK_INVOICE_NO > WK_PICK_INVOICE_STOP) THEN
   BEGIN
      WK_PICK_ADJUSTMENT = WK_PICK_INVOICE_START - WK_PICK_INVOICE_STOP;
      WK_PICK_INVOICE_NO = GEN_ID(PICK_INVOICE_GEN, WK_PICK_ADJUSTMENT);
      WK_PICK_INVOICE_PREFIX = GEN_ID(PICK_INVOICE_PREFIX , 1);
      WK_PICK_INVOICE_NO = WK_PICK_INVOICE_START;
   END
   WK_LEN_INVOICE_NO = STRLEN(ALLTRIM(WK_PICK_INVOICE_NO)) + 1;     
   /* Get Label prefix */      
   PICK_INVOICE_NO = CHR(WK_PICK_INVOICE_PREFIX);
   /* Padding leading with 0 */
   WHILE (WK_LEN_INVOICE_NO < WK_INVOICE_LENGTH) DO
   BEGIN
      PICK_INVOICE_NO = PICK_INVOICE_NO || '0';      
      WK_LEN_INVOICE_NO = WK_LEN_INVOICE_NO + 1;
   END
   PICK_INVOICE_NO = PICK_INVOICE_NO || ALLTRIM(WK_PICK_INVOICE_NO);
END ^

SET TERM ; ^
COMMIT WORK;
SET AUTODDL ON;

