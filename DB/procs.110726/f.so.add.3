COMMIT WORK;
SET AUTODDL OFF;
SET TERM ^ ;
 

CREATE OR ALTER TRIGGER ADD_PICK_ORDER_TIME FOR PICK_ORDER 
ACTIVE BEFORE INSERT POSITION 20 
AS
DECLARE VARIABLE WK_DUE_DATE TIMESTAMP;
DECLARE VARIABLE WK_DUE_YEAR INTEGER;
DECLARE VARIABLE WK_DUE_MONTH INTEGER;
DECLARE VARIABLE WK_DUE_DAY INTEGER;
DECLARE VARIABLE WK_FILENAME VARCHAR(255);
DECLARE VARIABLE WK_RESULT INTEGER;
DECLARE VARIABLE WK_DO_CHART CHAR(1);
DECLARE VARIABLE WK_LEGACY_CODE VARCHAR(70);
DECLARE VARIABLE WK_LEGACY_LEDGER_CODE VARCHAR(50);
DECLARE VARIABLE WK_FOUND  INTEGER;
DECLARE VARIABLE WK_SO_COUNTRY  VARCHAR(20);
DECLARE VARIABLE WK_SO_TYPE     VARCHAR(2);
DECLARE VARIABLE WK_CN_TAX_RATE DOUBLE PRECISION ;
DECLARE VARIABLE WK_SO_TAXABLE_AMOUNT DOUBLE PRECISION ;
DECLARE VARIABLE WK_SO_TOTAL DOUBLE PRECISION ;
BEGIN
   NEW.LAST_UPDATE_DATE = 'NOW';
   WK_FILENAME = '/tmp/add_so_time.log';
   IF (NEW.CREATE_DATE IS NULL) THEN
   BEGIN
      NEW.CREATE_DATE = 'NOW';
   END
   IF (NEW.PICK_DUE_DATE IS NOT NULL) THEN
   BEGIN
      WK_DUE_DATE = NEW.PICK_DUE_DATE;
      IF (ZEROTIME(WK_DUE_DATE) <> NEW.PICK_DUE_DATE) THEN
      BEGIN
         /* pick_due is a timestamp not a date */
         /* so use the next day */
         WK_DUE_YEAR = MER_YEAR(WK_DUE_DATE);
         WK_DUE_MONTH = MER_MONTH(WK_DUE_DATE);
         WK_DUE_DAY = MER_DAY(WK_DUE_DATE) + 1;
/*
         WK_RESULT = FILE_WRITELN(WK_FILENAME, 'start add pick_order time '); 
         WK_RESULT = FILE_WRITELN(WK_FILENAME, NEW.PICK_ORDER); 
         WK_RESULT = FILE_WRITELN(WK_FILENAME, cast(cast('NOW' as timestamp) as char(22))); 
         WK_RESULT = FILE_WRITELN(WK_FILENAME, cast(wk_due_date as char(22))); 
*/
         NEW.PICK_DUE_DATE = MAKEDATE(:WK_DUE_YEAR, :WK_DUE_MONTH, :WK_DUE_DAY, 0 ,0, 0);
/*
         WK_RESULT = FILE_WRITELN(WK_FILENAME, cast(NEW.PICK_DUE_DATE as char(22))); 
         WK_RESULT = FILE_WRITELN(WK_FILENAME, 'end add pick_order time '); 
*/
      END
   END
   WK_DO_CHART = 'F';
   SELECT LEGACY_LEDGER_ACCOUNTS 
   FROM CONTROL
   INTO :WK_DO_CHART;
   IF (WK_DO_CHART IS NULL) THEN
   BEGIN
      WK_DO_CHART = 'F';
   END
   IF (WK_DO_CHART = 'T') THEN
   BEGIN
      IF ((NEW.LEGACY_LEDGER_ADMIN_FEE_CODE IS NULL) OR (NEW.LEGACY_LEDGER_ADMIN_FEE_CODE = '')) THEN
      BEGIN
         /* no admin fee account code so try ADMIN_FEE_CODE */
         /* WK_LEGACY_CODE = NEW.COMPANY_ID || '|%|ADMIN_FEE'; */
         WK_LEGACY_CODE = NEW.COMPANY_ID || '|ADMIN_FEE_CODE|%';
         WK_LEGACY_LEDGER_CODE = '';
         WK_FOUND = 0;
         FOR SELECT DESCRIPTION 
         FROM OPTIONS
         WHERE GROUP_CODE = 'CMPLGRCODE'
         AND CODE LIKE :WK_LEGACY_CODE 
         INTO :WK_LEGACY_LEDGER_CODE    
         DO
         BEGIN
            IF (WK_FOUND = 0) THEN
            BEGIN
               NEW.LEGACY_LEDGER_ADMIN_FEE_CODE = WK_LEGACY_LEDGER_CODE;
               WK_FOUND = 1;
            END
         END
      END
      IF ((NEW.LEGACY_LEDGER_ADMIN_FEE_CODE IS NULL) OR (NEW.LEGACY_LEDGER_ADMIN_FEE_CODE = '')) THEN
      BEGIN
         /* no admin fee account code so try ADMIN_FEE */
         /* WK_LEGACY_CODE = NEW.COMPANY_ID || '|%|ADMIN_FEE'; */
         WK_LEGACY_CODE = NEW.COMPANY_ID || '|ADMIN_FEE|%';
         WK_LEGACY_LEDGER_CODE = '';
         WK_FOUND = 0;
         FOR SELECT DESCRIPTION 
         FROM OPTIONS
         WHERE GROUP_CODE = 'CMPLGRCODE'
         AND CODE LIKE :WK_LEGACY_CODE 
         INTO :WK_LEGACY_LEDGER_CODE    
         DO
         BEGIN
            IF (WK_FOUND = 0) THEN
            BEGIN
               NEW.LEGACY_LEDGER_ADMIN_FEE_CODE = WK_LEGACY_LEDGER_CODE;
               WK_FOUND = 1;
            END
         END
      END
      IF ((NEW.LEGACY_LEDGER_FREIGHT_CODE IS NULL) OR (NEW.LEGACY_LEDGER_FREIGHT_CODE = '')) THEN
      BEGIN
         /* no freight account code */
         /* WK_LEGACY_CODE = NEW.COMPANY_ID || '|%|FREIGHT_CODE'; */
         WK_LEGACY_CODE = NEW.COMPANY_ID || '|FREIGHT_CODE|%';
         WK_LEGACY_LEDGER_CODE = '';
         WK_FOUND = 0;
         FOR SELECT DESCRIPTION 
         FROM OPTIONS
         WHERE GROUP_CODE = 'CMPLGRCODE'
         AND CODE LIKE :WK_LEGACY_CODE 
         INTO :WK_LEGACY_LEDGER_CODE    
         DO
         BEGIN
            IF (WK_FOUND = 0) THEN
            BEGIN
               NEW.LEGACY_LEDGER_FREIGHT_CODE = WK_LEGACY_LEDGER_CODE;
               WK_FOUND = 1;
            END
         END
      END
      IF ((NEW.LEGACY_LEDGER_DEPOSIT_CODE IS NULL) OR (NEW.LEGACY_LEDGER_DEPOSIT_CODE = '')) THEN
      BEGIN
         /* no desposit account code */
         /* WK_LEGACY_CODE = NEW.COMPANY_ID || '|%|DEPOSIT_CODE'; */
         WK_LEGACY_CODE = NEW.COMPANY_ID || '|DEPOSIT_CODE|%';
         WK_LEGACY_LEDGER_CODE = '';
         WK_FOUND = 0;
         FOR SELECT DESCRIPTION 
         FROM OPTIONS
         WHERE GROUP_CODE = 'CMPLGRCODE'
         AND CODE LIKE :WK_LEGACY_CODE 
         INTO :WK_LEGACY_LEDGER_CODE    
         DO
         BEGIN
            IF (WK_FOUND = 0) THEN
            BEGIN
               NEW.LEGACY_LEDGER_DEPOSIT_CODE = WK_LEGACY_LEDGER_CODE;
               WK_FOUND = 1;
            END
         END
      END
      IF ((NEW.LEGACY_LEDGER_SALE_CODE IS NULL) OR (NEW.LEGACY_LEDGER_SALE_CODE = '')) THEN
      BEGIN
         /* no product sale account code */
         /* WK_LEGACY_CODE = NEW.COMPANY_ID || '|%|SALE_CODE'; */
         WK_LEGACY_CODE = NEW.COMPANY_ID || '|SALE_CODE|%';
         WK_LEGACY_LEDGER_CODE = '';
         WK_FOUND = 0;
         FOR SELECT DESCRIPTION 
         FROM OPTIONS
         WHERE GROUP_CODE = 'CMPLGRCODE'
         AND CODE LIKE :WK_LEGACY_CODE 
         INTO :WK_LEGACY_LEDGER_CODE    
         DO
         BEGIN
            IF (WK_FOUND = 0) THEN
            BEGIN
               NEW.LEGACY_LEDGER_SALE_CODE = WK_LEGACY_LEDGER_CODE;
               WK_FOUND = 1;
            END
         END
      END
      IF ((NEW.LEGACY_LEDGER_SALE_SSN_ID_CODE IS NULL) OR (NEW.LEGACY_LEDGER_SALE_SSN_ID_CODE = '')) THEN
      BEGIN
         /* no product sale account code */
         /* WK_LEGACY_CODE = NEW.COMPANY_ID || '|%|SSN_ID_SALE_CODE'; */
         WK_LEGACY_CODE = NEW.COMPANY_ID || '|SSN_ID_SALE_CODE|%';
         WK_LEGACY_LEDGER_CODE = '';
         WK_FOUND = 0;
         FOR SELECT DESCRIPTION 
         FROM OPTIONS
         WHERE GROUP_CODE = 'CMPLGRCODE'
         AND CODE LIKE :WK_LEGACY_CODE 
         INTO :WK_LEGACY_LEDGER_CODE    
         DO
         BEGIN
            IF (WK_FOUND = 0) THEN
            BEGIN
               NEW.LEGACY_LEDGER_SALE_SSN_ID_CODE = WK_LEGACY_LEDGER_CODE;
               WK_FOUND = 1;
            END
         END
      END
   END
   IF ((NEW.PICK_STATUS IS NULL) OR (NEW.PICK_STATUS IN ('UC','CF','OP'))) THEN
   BEGIN
      /* now set the gst rate */
      WK_SO_COUNTRY = NEW.P_COUNTRY;
      WK_SO_TYPE = NEW.PICK_ORDER_TYPE;
      IF (WK_SO_COUNTRY IS NULL) THEN
      BEGIN
         WK_SO_COUNTRY = '';
      END
      WK_SO_COUNTRY = UPPER(WK_SO_COUNTRY);
      IF (WK_SO_TYPE IS NULL) THEN
      BEGIN
         WK_SO_TYPE = 'SO';
      END
      IF (WK_SO_COUNTRY = '' OR WK_SO_COUNTRY = 'AUSTRALIA' OR WK_SO_COUNTRY = 'AU') THEN
      BEGIN
         SELECT DEFAULT_GST_RATE 
         FROM CONTROL
         INTO :WK_CN_TAX_RATE;
         IF (WK_CN_TAX_RATE IS NULL) THEN
         BEGIN
            WK_CN_TAX_RATE = 0;
         END
         NEW.TAX_RATE = WK_CN_TAX_RATE;
      END
      ELSE
      BEGIN
         /* not au country */
         /* IF (NEW.TAX_RATE IS NULL) THEN */
            NEW.TAX_RATE = 0;
      END
      IF (WK_SO_TYPE = 'SO') THEN
      BEGIN
/*
        sub_total_tax = SELECT SUM(LINE_TOTAL * TAX_RATE / 100) FROM PICK_ITEM WHERE PICK_ORDER =  $orderNo;
        sub_total_amount = SELECT SUM(LINE_TOTAL ) FROM PICK_ITEM WHERE PICK_ORDER =  $orderNo;
        taxable_Amount = (FREIGHT + ((sub_Total_Amount + FREIGHT) * ADMIN_FEE_RATE/100) + ADMIN_FEE_AMOUNT + OTHER_NUM1 + OTHER_NUM2);
        tax_Amount = sub_Total_Tax + taxable_Amount * tax_Rate / 100;
        total = sub_Total_Amount + taxable_Amount + tax_Amount;
        due_Amount = total - AMOUNT_PAID;
        freight_Tax_Amount = FREIGHT * tax_Rate / 100;
*/
        SELECT SUM(COALESCE(LINE_TOTAL,0) * COALESCE(TAX_RATE,0) / 100),
               SUM(COALESCE(LINE_TOTAL,0) )
        FROM PICK_ITEM 
        WHERE PICK_ORDER = NEW.PICK_ORDER
        INTO NEW.SUB_TOTAL_TAX, NEW.SUB_TOTAL_AMOUNT;
        SELECT SUM(COALESCE(LINE_TOTAL,0) )
        FROM PICK_ITEM 
        WHERE PICK_ORDER = NEW.PICK_ORDER
        AND SSN_ID <> ''
        INTO NEW.SUB_TOTAL_AMOUNT_SSN_ID;
        IF (NEW.SUB_TOTAL_AMOUNT_SSN_ID IS NULL) THEN
        BEGIN
           NEW.SUB_TOTAL_AMOUNT_SSN_ID = 0;
        END
        SELECT SUM(COALESCE(LINE_TOTAL,0) )
        FROM PICK_ITEM 
        WHERE PICK_ORDER = NEW.PICK_ORDER
        AND PROD_ID <> ''
        INTO NEW.SUB_TOTAL_AMOUNT_PROD_ID;
        IF (NEW.SUB_TOTAL_AMOUNT_PROD_ID IS NULL) THEN
        BEGIN
           NEW.SUB_TOTAL_AMOUNT_PROD_ID = 0;
        END
        WK_SO_TAXABLE_AMOUNT = (COALESCE(NEW.FREIGHT,0) + ((COALESCE(NEW.SUB_TOTAL_AMOUNT,0) + COALESCE(NEW.FREIGHT,0)) * COALESCE(NEW.ADMIN_FEE_RATE,0)/100) + COALESCE(NEW.ADMIN_FEE_AMOUNT,0) + COALESCE(NEW.OTHER_NUM1,0) + COALESCE(NEW.OTHER_NUM2,0));
        NEW.TAX_AMOUNT = COALESCE(NEW.SUB_TOTAL_TAX,0) + COALESCE(WK_SO_TAXABLE_AMOUNT,0) * COALESCE(NEW.TAX_RATE,0) / 100;
        WK_SO_TOTAL = COALESCE(NEW.SUB_TOTAL_AMOUNT,0) + WK_SO_TAXABLE_AMOUNT + NEW.TAX_AMOUNT;
        NEW.DUE_AMOUNT = WK_SO_TOTAL - COALESCE(NEW.AMOUNT_PAID,0);
        NEW.FREIGHT_TAX_AMOUNT = COALESCE(NEW.FREIGHT,0) * COALESCE(NEW.TAX_RATE,0) / 100;
      END
   END

END ^


SET TERM ; ^
COMMIT WORK;
SET AUTODDL ON;
