COMMIT WORK;
SET AUTODDL OFF;
SET TERM ^ ;


CREATE OR ALTER PROCEDURE RPT_SAFETY_CALIBRATION_EXPIRY (WK_DAYS INTEGER)
RETURNS (SN_SSN_TYPE VARCHAR(40),
SN_SSN_ID VARCHAR(20),
SN_WH_ID CHAR(2),
SN_LOCN_ID VARCHAR(10),
SN_SSN_DESCRIPTION SSN_DESCRIPTION,
SN_LAST_CALIBRATE_CHECK_DATE TIMESTAMP,
SN_CALIBRATE_PERIOD CHAR(1),
SN_CALIBRATE_PERIOD_NO INTEGER,
WK_CALIBRATE_DAYS_SINCE_CHECK INTEGER,
WK_CALIBRATE_EXPIRY_DATE TIMESTAMP,
SN_LAST_SAFETY_CHECK_DATE TIMESTAMP,
SN_SAFETY_PERIOD CHAR(1),
SN_SAFETY_PERIOD_NO INTEGER,
WK_SAFETY_DAYS_SINCE_CHECK INTEGER,
WK_SAFETY_EXPIRY_DATE TIMESTAMP,
SN_CALIBRATE_CHECK CHAR(1),
SN_SAFETY_CHECK CHAR(1),
WK_CALIBRATE_DAYS_TO_CHECK INTEGER,
WK_SAFETY_DAYS_TO_CHECK INTEGER,
WK_DAYS_USED  INTEGER)

AS
DECLARE VARIABLE WK_SAFETY_PERIOD_DAY INTEGER;
DECLARE VARIABLE WK_CALIBRATE_PERIOD_DAY INTEGER;
DECLARE VARIABLE WK_SAFETY_PERIOD_DAYS INTEGER;
DECLARE VARIABLE WK_CALIBRATE_PERIOD_DAYS INTEGER;
DECLARE VARIABLE WK_TEST_DATE TIMESTAMP;
BEGIN
   WK_DAYS_USED = WK_DAYS;
   SUSPEND;
END ^

ALTER  PROCEDURE RPT_SAFETY_CALIBRATION_EXPIRY (WK_DAYS INTEGER)
RETURNS (SN_SSN_TYPE VARCHAR(40),
SN_SSN_ID VARCHAR(20),
SN_WH_ID CHAR(2),
SN_LOCN_ID VARCHAR(10),
SN_SSN_DESCRIPTION SSN_DESCRIPTION,
SN_LAST_CALIBRATE_CHECK_DATE TIMESTAMP,
SN_CALIBRATE_PERIOD CHAR(1),
SN_CALIBRATE_PERIOD_NO INTEGER,
WK_CALIBRATE_DAYS_SINCE_CHECK INTEGER,
WK_CALIBRATE_EXPIRY_DATE TIMESTAMP,
SN_CALIBRATE_CHECK CHAR(1),
WK_CALIBRATE_DAYS_TO_CHECK INTEGER,
WK_CALIBRATE_PERIOD_DAY INTEGER,
WK_CALIBRATE_PERIOD_DAYS INTEGER,
SN_LAST_SAFETY_CHECK_DATE TIMESTAMP,
SN_SAFETY_PERIOD CHAR(1),
SN_SAFETY_PERIOD_NO INTEGER,
WK_SAFETY_DAYS_SINCE_CHECK INTEGER,
WK_SAFETY_EXPIRY_DATE TIMESTAMP,
SN_SAFETY_CHECK CHAR(1),
WK_SAFETY_DAYS_TO_CHECK INTEGER,
WK_SAFETY_PERIOD_DAY INTEGER,
WK_SAFETY_PERIOD_DAYS INTEGER,
WK_TEST_DATE TIMESTAMP,
WK_DAYS_USED  INTEGER)

AS
BEGIN
   WK_DAYS_USED = WK_DAYS;
/*
   WK_TEST_DATE = MAKEDATE(MER_YEAR('TODAY'), MER_MONTH('TODAY'), MER_DAY('TODAY') + WK_DAYS, 0, 0, 0);
*/
   WK_TEST_DATE = DATEADD(DAY, WK_DAYS, TIMESTAMP 'TODAY') ;
   FOR
      SELECT SSN.SSN_TYPE , 
      SSN.SSN_ID , 
      SSN.SSN_DESCRIPTION ,  
      SSN.LOAN_LAST_CALIBRATE_CHECK_DATE , 
      SSN.LOAN_LAST_SAFETY_CHECK_DATE , 
      SSN.WH_ID , 
      SSN.LOCN_ID,
      O2.CODE,
      O4.CODE,
      SSN.LOAN_CALIBRATE_CHECK,
      SSN.LOAN_SAFETY_CHECK,
      SSN.LOAN_CALIBRATE_PERIOD , 
      SSN.LOAN_CALIBRATE_PERIOD_NO , 
      SSN.LOAN_SAFETY_PERIOD , 
      SSN.LOAN_SAFETY_PERIOD_NO  
      FROM SSN 
      LEFT OUTER JOIN OPTIONS O1 ON O1.GROUP_CODE='SAFE_CALIB' AND SSN.LOAN_CALIBRATE_PERIOD = O1.CODE
      LEFT OUTER JOIN OPTIONS O2 ON O2.GROUP_CODE='LOAN_DAYS' AND O1.DESCRIPTION = O2.DESCRIPTION
      LEFT OUTER JOIN OPTIONS O3 ON O3.GROUP_CODE='SAFE_CALIB' AND SSN.LOAN_SAFETY_PERIOD = O3.CODE
      LEFT OUTER JOIN OPTIONS O4 ON O4.GROUP_CODE='LOAN_DAYS' AND O3.DESCRIPTION = O4.DESCRIPTION
      WHERE  LOAN_CALIBRATE_CHECK = 'T'
      OR     LOAN_SAFETY_CHECK = 'T'
      ORDER BY SSN.SSN_TYPE, SSN.WH_ID,SSN.LOCN_ID,SSN.SSN_ID
      INTO :SN_SSN_TYPE,
           :SN_SSN_ID,
           :SN_SSN_DESCRIPTION,
           :SN_LAST_CALIBRATE_CHECK_DATE,
           :SN_LAST_SAFETY_CHECK_DATE,
           :SN_WH_ID,
           :SN_LOCN_ID,
           :WK_CALIBRATE_PERIOD_DAY,
           :WK_SAFETY_PERIOD_DAY,
           :SN_CALIBRATE_CHECK,
           :SN_SAFETY_CHECK,
           :SN_CALIBRATE_PERIOD,
           :SN_CALIBRATE_PERIOD_NO,
           :SN_SAFETY_PERIOD,
           :SN_SAFETY_PERIOD_NO
   DO
   BEGIN
   
      WK_CALIBRATE_PERIOD_DAYS = NULL;
      WK_CALIBRATE_EXPIRY_DATE = NULL;
      WK_CALIBRATE_DAYS_SINCE_CHECK  = NULL;
      WK_CALIBRATE_DAYS_TO_CHECK  = NULL;
      WK_SAFETY_PERIOD_DAYS = NULL;
      WK_SAFETY_EXPIRY_DATE = NULL;
      WK_SAFETY_DAYS_SINCE_CHECK  = NULL;
      WK_SAFETY_DAYS_TO_CHECK  = NULL;
      IF (SN_CALIBRATE_CHECK = 'T') THEN
      BEGIN
         WK_CALIBRATE_DAYS_SINCE_CHECK  = 0;
         WK_CALIBRATE_DAYS_TO_CHECK  = 0;
         IF (SN_LAST_CALIBRATE_CHECK_DATE IS NOT NULL) THEN
         BEGIN
            WK_CALIBRATE_DAYS_SINCE_CHECK = DATEDIFF(DAY, SN_LAST_CALIBRATE_CHECK_DATE, WK_TEST_DATE );
/*
            IF (SN_LAST_CALIBRATE_CHECK_DATE > MAXTIME(WK_TEST_DATE)) THEN
            BEGIN
               WK_CALIBRATE_DAYS_SINCE_CHECK = 0 - DIFFDATE(WK_TEST_DATE, SN_LAST_CALIBRATE_CHECK_DATE, 4); 
            END
            ELSE
            BEGIN
               WK_CALIBRATE_DAYS_SINCE_CHECK = DIFFDATE(SN_LAST_CALIBRATE_CHECK_DATE, WK_TEST_DATE, 4);
            END
*/
            IF ((WK_CALIBRATE_PERIOD_DAY IS NOT NULL)  AND (SN_CALIBRATE_PERIOD_NO IS NOT NULL)) THEN
            BEGIN
               /* calculate days for period */
               WK_CALIBRATE_PERIOD_DAYS = WK_CALIBRATE_PERIOD_DAY * SN_CALIBRATE_PERIOD_NO;
               /* calculate expiry date */
/*
               WK_CALIBRATE_EXPIRY_DATE = MAKEDATE(MER_YEAR(SN_LAST_CALIBRATE_CHECK_DATE), MER_MONTH(SN_LAST_CALIBRATE_CHECK_DATE), MER_DAY(SN_LAST_CALIBRATE_CHECK_DATE) + WK_CALIBRATE_PERIOD_DAYS, 0, 0, 0);
*/
               WK_CALIBRATE_EXPIRY_DATE = DATEADD(DAY, WK_CALIBRATE_PERIOD_DAYS, SN_LAST_CALIBRATE_CHECK_DATE );

               WK_CALIBRATE_DAYS_TO_CHECK = DATEDIFF(DAY, WK_CALIBRATE_EXPIRY_DATE, WK_TEST_DATE );
/*
               IF (WK_CALIBRATE_EXPIRY_DATE > MAXTIME(WK_TEST_DATE)) THEN
               BEGIN
                  WK_CALIBRATE_DAYS_TO_CHECK = 0 - DIFFDATE(WK_TEST_DATE, WK_CALIBRATE_EXPIRY_DATE, 4);
               END
               ELSE
               BEGIN
                  WK_CALIBRATE_DAYS_TO_CHECK = DIFFDATE(WK_CALIBRATE_EXPIRY_DATE, WK_TEST_DATE, 4);
               END
*/
            END
         END
      END
      IF (SN_SAFETY_CHECK = 'T') THEN
      BEGIN
         WK_SAFETY_DAYS_SINCE_CHECK  = 0;
         WK_SAFETY_DAYS_TO_CHECK  = 0;
         IF (SN_LAST_SAFETY_CHECK_DATE IS NOT NULL) THEN
         BEGIN
            WK_SAFETY_DAYS_SINCE_CHECK = DATEDIFF(DAY, SN_LAST_SAFETY_CHECK_DATE, WK_TEST_DATE );
/*
            IF (SN_LAST_SAFETY_CHECK_DATE > MAXTIME(WK_TEST_DATE)) THEN
            BEGIN
               WK_SAFETY_DAYS_SINCE_CHECK = 0 - DIFFDATE(WK_TEST_DATE, SN_LAST_SAFETY_CHECK_DATE, 4);
            END
            ELSE
            BEGIN
               WK_SAFETY_DAYS_SINCE_CHECK = DIFFDATE(SN_LAST_SAFETY_CHECK_DATE, WK_TEST_DATE, 4);
            END
*/
            IF ((WK_SAFETY_PERIOD_DAY IS NOT NULL)  AND (SN_SAFETY_PERIOD_NO IS NOT NULL)) THEN
            BEGIN
               /* calculate days for period */
               WK_SAFETY_PERIOD_DAYS = WK_SAFETY_PERIOD_DAY * SN_SAFETY_PERIOD_NO;
               /* calculate expiry date */
/*
               WK_SAFETY_EXPIRY_DATE = MAKEDATE(MER_YEAR(SN_LAST_SAFETY_CHECK_DATE), MER_MONTH(SN_LAST_SAFETY_CHECK_DATE), MER_DAY(SN_LAST_SAFETY_CHECK_DATE) + WK_SAFETY_PERIOD_DAYS, 0, 0, 0);
*/
               WK_SAFETY_EXPIRY_DATE = DATEADD(DAY, WK_SAFETY_PERIOD_DAYS, SN_LAST_SAFETY_CHECK_DATE);
               WK_SAFETY_DAYS_TO_CHECK = DATEDIFF(DAY, WK_SAFETY_EXPIRY_DATE, WK_TEST_DATE );
/*
               IF (WK_SAFETY_EXPIRY_DATE > MAXTIME(WK_TEST_DATE)) THEN
               BEGIN
                  WK_SAFETY_DAYS_TO_CHECK = 0 - DIFFDATE(WK_TEST_DATE, WK_SAFETY_EXPIRY_DATE, 4);
               END
               ELSE
               BEGIN
                  WK_SAFETY_DAYS_TO_CHECK = DIFFDATE(WK_SAFETY_EXPIRY_DATE, WK_TEST_DATE, 4);
               END
*/
            END
         END
      END
      IF ((WK_CALIBRATE_DAYS_TO_CHECK >= 0) OR (WK_SAFETY_DAYS_TO_CHECK >= 0)) THEN
      BEGIN
         SUSPEND;
      END
   END
END ^


SET TERM ; ^
COMMIT WORK;
SET AUTODDL ON;
