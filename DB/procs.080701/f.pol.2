COMMIT WORK;
SET AUTODDL OFF;
SET TERM ^ ;
 
/*
ALTER TABLE PURCHASE_ORDER_LINE ADD PO_LEGACY_RECV_ID INTEGER^
*/

DROP TRIGGER MOD_PURCHASE_LINE_DATE  ^
COMMIT^

CREATE TRIGGER MOD_PURCHASE_LINE_DATE FOR PURCHASE_ORDER_LINE 
ACTIVE BEFORE UPDATE POSITION 2 
AS
DECLARE VARIABLE WK_PO_STATUS CHAR(2);
DECLARE VARIABLE WK_PO_ORDER VARCHAR(10);
DECLARE VARIABLE WK_POL_LINE CHAR(4);
DECLARE VARIABLE WK_MORE_LINES CHAR(4);
BEGIN
   NEW.LAST_UPDATE_DATE = 'NOW';
   /* check order status */
   IF (NEW.PO_LINE_STATUS = 'CL' OR
       NEW.PO_LINE_STATUS = 'OS')  THEN
   BEGIN
      /* get the orders po_status */
      WK_PO_STATUS = '';
      WK_PO_ORDER = NEW.PURCHASE_ORDER;
      WK_POL_LINE = NEW.PO_LINE;
      SELECT PO_STATUS
      FROM PURCHASE_ORDER
      WHERE PURCHASE_ORDER = :WK_PO_ORDER
      INTO :WK_PO_STATUS;
      IF (WK_PO_STATUS = 'OP' OR
          WK_PO_STATUS = 'CF') THEN
      BEGIN
         /* are there any cf or op lines on this order */
         WK_MORE_LINES = '';
         SELECT FIRST 1 PO_LINE
         FROM PURCHASE_ORDER_LINE
         WHERE PURCHASE_ORDER = :WK_PO_ORDER
         AND PO_LINE <> :WK_POL_LINE
         AND PO_LINE_STATUS IN ('OP','CF')
         INTO :WK_MORE_LINES;
         IF (WK_MORE_LINES IS NULL) THEN
         BEGIN
            WK_MORE_LINES = '';
         END
         IF (WK_MORE_LINES = '') THEN
         BEGIN
            /* update purchase_order.po_status to 'CL' */
            UPDATE PURCHASE_ORDER
            SET PO_STATUS = 'CL'
            WHERE PURCHASE_ORDER = :WK_PO_ORDER;
         END
      END
   END
END ^


SET TERM ; ^
COMMIT WORK;
SET AUTODDL ON;
