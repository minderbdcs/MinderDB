COMMIT WORK;
SET AUTODDL OFF;
SET TERM ^ ;
 

CREATE OR ALTER TRIGGER RUN_TRANSACTION_DSOL FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 77 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_OBJECT  VARCHAR(30);
DECLARE VARIABLE WK_CONSIGNMENT VARCHAR(20);
DECLARE VARIABLE WK_CLASS CHAR(1);
DECLARE VARIABLE WK_REF  VARCHAR(40);
DECLARE VARIABLE WK_WH_ID  VARCHAR(2);
DECLARE VARIABLE WK_LOCN_ID  VARCHAR(10);
DECLARE VARIABLE WK_DESPATCH_ID INTEGER;
DECLARE VARIABLE WK_DATE TIMESTAMP;
DECLARE VARIABLE WK_USER VARCHAR(10);
DECLARE VARIABLE WK_DEVICE VARCHAR(2);
DECLARE VARIABLE WK_LABEL_NO INTEGER;
DECLARE VARIABLE WK_LABEL_NO_F DOUBLE PRECISION;
DECLARE VARIABLE WK_PACK_ID INTEGER;
DECLARE VARIABLE WK_DETAIL_ID INTEGER;
DECLARE VARIABLE WK_FOUND INTEGER;
DECLARE VARIABLE WK_LABEL VARCHAR(40);
DECLARE VARIABLE WK_RECORD INTEGER;
DECLARE VARIABLE WK_QTY INTEGER;
DECLARE VARIABLE WK_PREFIX VARCHAR(5);
DECLARE VARIABLE WK_START INTEGER;
DECLARE VARIABLE WK_END INTEGER;
DECLARE VARIABLE WK_BARCODE_LEN INTEGER;
DECLARE VARIABLE WK_CHARS CHAR(37);
DECLARE VARIABLE WK_REM INTEGER;
DECLARE VARIABLE WK_TOT INTEGER;
DECLARE VARIABLE WK_QUOT INTEGER;
DECLARE VARIABLE WK_CHAR CHAR(1);
DECLARE VARIABLE WK_CNT  INTEGER;
DECLARE VARIABLE WK_LABEL_LEN  INTEGER;
DECLARE VARIABLE WK_LABEL_CURRENT  INTEGER;
DECLARE VARIABLE WK_LABEL_START    INTEGER;
DECLARE VARIABLE WK_LABEL_END  INTEGER;
DECLARE VARIABLE WK_RANGE      INTEGER;

DECLARE VARIABLE WK_LOG_RESULT INTEGER;
DECLARE VARIABLE WK_LOG_BUFFER VARCHAR(1024);
DECLARE VARIABLE WK_LOG_FILENAME VARCHAR(255);

DECLARE VARIABLE WK_LABEL_BASE  INTEGER;

BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'DSOL') THEN
  BEGIN
     WK_LOG_FILENAME = '/tmp/DSOL.log';
     WK_OBJECT = NEW.OBJECT;
     WK_CONSIGNMENT = SUBSTR(WK_OBJECT,1, 20);
     WK_CLASS = NEW.TRN_CODE;
     WK_REF = NEW.REFERENCE;
     /* WK_LABEL = SUBSTR(WK_REF,1,20); */
     WK_LABEL = WK_REF;
     WK_DATE = NEW.TRN_DATE;
     WK_USER = NEW.PERSON_ID;
     WK_QTY = NEW.QTY;
     WK_DEVICE = NEW.DEVICE_ID;
     WK_RECORD = NEW.RECORD_ID; 
     WK_LOG_RESULT = FILE_WRITELN(:WK_LOG_FILENAME,'DSOL START') ;
     WK_LOG_RESULT = FILE_WRITELN(:WK_LOG_FILENAME,'QTY:') ;
     WK_LOG_RESULT = FILE_WRITELN(:WK_LOG_FILENAME,:WK_QTY) ;
     WK_FOUND = 0;
     WK_LABEL_START = 0;
     WK_LABEL_END = 0;
     WK_LABEL_CURRENT = 0;
     IF (WK_CLASS = 'O') THEN
     BEGIN
        WK_PREFIX = '';
        WK_START = 0;
        WK_END = 0;
        WK_LABEL_BASE = 10;
        SELECT FIRST 1 1, CARRIER.PREFIX, CARRIER.START_NO, CARRIER.END_NO , CARRIER.LABEL_NUMBER_BASE
        FROM PICK_DESPATCH
        JOIN CARRIER ON CARRIER.CARRIER_ID = PICK_DESPATCH.PICKD_CARRIER_ID
        WHERE PICK_DESPATCH.AWB_CONSIGNMENT_NO = :WK_CONSIGNMENT
          AND PICK_DESPATCH.DESPATCH_STATUS = 'DC'
        INTO  :WK_FOUND, :WK_PREFIX, :WK_START, :WK_END, :WK_LABEL_BASE;
        IF (WK_FOUND IS NULL) THEN
        BEGIN
           WK_FOUND = 0;
        END
        IF (WK_FOUND = 0) THEN
        BEGIN
           SELECT FIRST 1 CARRIER.PREFIX, CARRIER.START_NO, CARRIER.END_NO , CARRIER.LABEL_NUMBER_BASE
           FROM PICK_DESPATCH
           JOIN CARRIER ON CARRIER.CARRIER_ID = PICK_DESPATCH.PICKD_CARRIER_ID
           WHERE PICK_DESPATCH.ALTERNATE_AWB_CONSIGNMENT_NO = :WK_CONSIGNMENT
             AND PICK_DESPATCH.DESPATCH_STATUS = 'DC'
           INTO  :WK_PREFIX, :WK_START, :WK_END, :WK_LABEL_BASE;
        END
        /* get length of barcode from param */
        SELECT MAX_LENGTH FROM PARAM WHERE DATA_ID = 'DESPATCHADDRESS'
        INTO :WK_BARCODE_LEN; 
        /* remove length of prefix */
        IF (WK_PREFIX IS NULL) THEN
        BEGIN
           WK_PREFIX = '';
        END
        IF (WK_START IS NULL) THEN
        BEGIN
           WK_START = 0;
        END
        WK_BARCODE_LEN = WK_BARCODE_LEN - LEN(WK_PREFIX);
        IF (WK_END IS NULL) THEN
        BEGIN
           WK_END = 9;
           WK_CNT = 1;
           /* end should be barcode len number of 9s */
           WHILE (WK_CNT < WK_BARCODE_LEN) DO
           BEGIN
              WK_END = (WK_END * 10) + 9;
              WK_CNT = WK_CNT + 1;
           END
        END
        WK_RANGE = WK_END - WK_START;
        WK_LOG_RESULT = FILE_WRITELN(:WK_LOG_FILENAME,'RANGE:') ;
        WK_LOG_RESULT = FILE_WRITELN(:WK_LOG_FILENAME,:WK_RANGE) ;
        WK_LOG_RESULT = FILE_WRITELN(:WK_LOG_FILENAME,'START:') ;
        WK_LOG_RESULT = FILE_WRITELN(:WK_LOG_FILENAME,:WK_START) ;
        WK_LOG_RESULT = FILE_WRITELN(:WK_LOG_FILENAME,'END:') ;
        WK_LOG_RESULT = FILE_WRITELN(:WK_LOG_FILENAME,:WK_END) ;

        WK_CHARS = '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ@';
        IF (WK_LABEL_BASE IS NULL) THEN
        BEGIN
           WK_LABEL_BASE = 10;
        END
        WK_CNT = 0;
        WK_LABEL_NO = 0;
        WK_LABEL_NO_F = 0.0;
        WK_LABEL = '';
        IF (WK_CNT < WK_QTY) THEN
        BEGIN
           WK_LABEL_START = gen_id(DESPATCH_DSOT,1);
           WK_LABEL_END = gen_id(DESPATCH_DSOT, WK_QTY -1);
           WK_LABEL_CURRENT = WK_LABEL_START;
        END
        WK_LOG_RESULT = FILE_WRITELN(:WK_LOG_FILENAME,'LABEL START:') ;
        WK_LOG_RESULT = FILE_WRITELN(:WK_LOG_FILENAME,:WK_LABEL_START) ;
        WK_LOG_RESULT = FILE_WRITELN(:WK_LOG_FILENAME,'LABEL_END:') ;
        WK_LOG_RESULT = FILE_WRITELN(:WK_LOG_FILENAME,:WK_LABEL_END) ;
        WK_LOG_RESULT = FILE_WRITELN(:WK_LOG_FILENAME,'LABEL CURRENT:') ;
        WK_LOG_RESULT = FILE_WRITELN(:WK_LOG_FILENAME,:WK_LABEL_CURRENT) ;
        WHILE (WK_CNT < WK_QTY) DO
        BEGIN
           /* WK_LABEL_NO = mod(gen_id(DESPATCH_DSOT,1), :WK_END - :WK_START) + :WK_START; */
           /* WK_LABEL_NO = mod(WK_LABEL_CURRENT, :WK_END - :WK_START) + :WK_START; */
           /* WK_LABEL_NO = MOD(WK_LABEL_CURRENT, :WK_RANGE) + :WK_START; */
           WK_LABEL_NO_F = MOD(WK_LABEL_CURRENT, :WK_RANGE) + :WK_START;
        WK_LOG_RESULT = FILE_WRITELN(:WK_LOG_FILENAME,'LABEL NO F:') ;
        WK_LOG_RESULT = FILE_WRITELN(:WK_LOG_FILENAME,:WK_LABEL_NO_F) ;
           IF (WK_LABEL_NO_F > WK_END) THEN
           BEGIN
              WK_LABEL_NO = WK_END;
           END
           ELSE
           BEGIN
              WK_LABEL_NO = CAST(WK_LABEL_NO_F AS INTEGER);
           END
        WK_LOG_RESULT = FILE_WRITELN(:WK_LOG_FILENAME,'LABEL NO :') ;
        WK_LOG_RESULT = FILE_WRITELN(:WK_LOG_FILENAME,:WK_LABEL_NO) ;

           WK_LABEL = '';
           WK_LABEL_LEN = 0;
           WK_TOT = WK_LABEL_NO;
           WHILE (WK_LABEL_LEN < WK_BARCODE_LEN) DO
           BEGIN
              /* do for length remaining */
              /*
              WK_QUOT = modquot(WK_TOT, 36);
              WK_REM = mod(WK_TOT ,36);
              */
              WK_QUOT = MODQUOT(WK_TOT, WK_LABEL_BASE);
              WK_REM = MOD(WK_TOT ,WK_LABEL_BASE);
              WK_CHAR = SUBSTR(WK_CHARS,WK_REM +1,WK_REM +1);
              WK_LABEL = WK_LABEL || WK_CHAR;
              WK_TOT = WK_QUOT;
              WK_LABEL_LEN = WK_LABEL_LEN + 1;
           END
           /* now swap order */
           WK_LABEL = WK_PREFIX || reverse(WK_LABEL);
   
           SELECT FIRST 1 1,PACK_ID.PACK_ID
           FROM PICK_DESPATCH
           JOIN PACK_ID ON PICK_DESPATCH.DESPATCH_ID = PACK_ID.DESPATCH_ID
           WHERE PICK_DESPATCH.AWB_CONSIGNMENT_NO = :WK_CONSIGNMENT
             AND PACK_ID.DESPATCH_LABEL_NO IS NULL  
            INTO :WK_FOUND, :WK_DETAIL_ID;
           IF (WK_FOUND = 1) THEN
           BEGIN
              UPDATE PACK_ID
              SET DESPATCH_LABEL_NO = :WK_LABEL
              WHERE PACK_ID = :WK_DETAIL_ID;
           END
           WK_CNT = WK_CNT + 1;
           WK_LABEL_CURRENT = WK_LABEL_CURRENT + 1;
           /* WK_LABEL_CURRENT = mod(WK_LABEL_CURRENT, :WK_END - :WK_START); */
           WK_LABEL_CURRENT = MOD(WK_LABEL_CURRENT, :WK_RANGE);
        END /* loop for qty required */
     END /* dso type */
     ELSE
     BEGIN
        SELECT 1 
           FROM PICK_DESPATCH
           JOIN PACK_ID ON PICK_DESPATCH.DESPATCH_ID = PACK_ID.DESPATCH_ID
           WHERE PICK_DESPATCH.AWB_CONSIGNMENT_NO = :WK_CONSIGNMENT
           AND PACK_ID.DESPATCH_LABEL_NO = :WK_LABEL
           INTO :WK_FOUND;
        IF (WK_FOUND = 0) THEN
        BEGIN
           SELECT FIRST 1 1,PACK_ID.PACK_ID
           FROM PICK_DESPATCH  
           JOIN PACK_ID ON PICK_DESPATCH.DESPATCH_ID = PACK_ID.DESPATCH_ID
           WHERE PICK_DESPATCH.AWB_CONSIGNMENT_NO = :WK_CONSIGNMENT
           AND PACK_ID.DESPATCH_LABEL_NO IS NULL  
           INTO :WK_FOUND, :WK_DETAIL_ID;
           IF (WK_FOUND = 1) THEN
           BEGIN
              UPDATE PACK_ID
              SET DESPATCH_LABEL_NO = :WK_LABEL
              WHERE PACK_ID = :WK_DETAIL_ID;
           END
        END
     END /* dss type */
     UPDATE TRANSACTIONS SET COMPLETE='T',ERROR_TEXT='Processed successfully' WHERE RECORD_ID = :WK_RECORD;

   /* EXECUTE PROCEDURE TRAN_ARCHIVE; */
     WK_LOG_RESULT = FILE_WRITELN(:WK_LOG_FILENAME,'DSOL END') ;

  END
 END
END ^


SET TERM ; ^
COMMIT WORK;
SET AUTODDL ON;
