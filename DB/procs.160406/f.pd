
COMMIT WORK;
SET AUTODDL OFF;
SET TERM ^ ;
 

CREATE OR ALTER TRIGGER UPD_PICK_DESPATCH_TIME FOR PICK_DESPATCH
ACTIVE BEFORE UPDATE POSITION 20 
AS
DECLARE VARIABLE WK_FOUND INTEGER;
DECLARE VARIABLE WK_CS_RECORD_ID RECORD_ID;
DECLARE VARIABLE WK_CS_SERVICE_TYPE SERVICE_TYPE;
BEGIN
   NEW.LAST_UPDATE_DATE = 'NOW';
   /* check the carrier matches the service and record */
   IF (NEW.PICKD_CARRIER_ID IS NOT NULL) THEN
   BEGIN
      WK_FOUND = 0;
      WK_CS_SERVICE_TYPE = NULL;
      SELECT CS.RECORD_ID, CS.SERVICE_TYPE
      FROM CARRIER_SERVICE CS 
      WHERE CS.RECORD_ID = NEW.PICKD_SERVICE_RECORD_ID
      AND COALESCE(CS.CARRIER_ID,'') <> NEW.PICKD_CARRIER_ID
      INTO :WK_FOUND, :WK_CS_SERVICE_TYPE;
      IF (WK_FOUND IS NULL) THEN
      BEGIN
         WK_FOUND = 0;
      END
      IF (WK_FOUND <> 0) THEN
      BEGIN
         /* record id is not for the carrier - try to get a record for the service type */
         WK_FOUND = 0;
         WK_CS_RECORD_ID = NULL;
         SELECT FIRST 1 1, CS.RECORD_ID 
         FROM CARRIER_SERVICE CS 
         WHERE CS.CARRIER_ID = NEW.PICKD_CARRIER_ID
         AND   CS.SERVICE_TYPE = NEW.PICKD_SERVICE_TYPE
         INTO :WK_FOUND, :WK_CS_RECORD_ID;
         IF (WK_FOUND IS NULL) THEN
         BEGIN
            WK_FOUND = 0;
         END
         IF (WK_FOUND = 0) THEN
         BEGIN
            /* no record for service type - so update the status to ET */
            NEW.DESPATCH_STATUS = 'ET';
         END
         ELSE
         BEGIN
            NEW.PICKD_SERVICE_RECORD_ID = :WK_CS_RECORD_ID;
         END
      END
   END
   IF (NEW.PICKD_MANIFEST_ID IS NOT NULL) THEN
   BEGIN
      IF (NEW.PICKD_MANIFEST_ID <> '') THEN
      BEGIN
         WK_FOUND = 0;
         SELECT 1 FROM PICK_MANIFEST
         WHERE MANIFEST_ID = NEW.PICKD_MANIFEST_ID
         INTO :WK_FOUND;
         IF (WK_FOUND IS NULL) THEN
         BEGIN
            WK_FOUND = 0;
         END
         IF (WK_FOUND = 0 ) THEN
         BEGIN
            INSERT INTO PICK_MANIFEST (MANIFEST_ID, 
                   PICKM_DATE,
                   CREATE_DATE,
                   USER_ID,
                   LAST_UPDATE_DATE,
                   DEVICE_ID,
                   PICKM_STATUS,
                   PICKM_CARRIER_ID)
            VALUES (NEW.PICKD_MANIFEST_ID,
                    'NOW',
                    'NOW',
                    NEW.USER_ID,
                    'NOW',
                    NEW.DEVICE_ID,
                    NEW.DESPATCH_STATUS,
                    NEW.PICKD_CARRIER_ID);
         END
         ELSE
         BEGIN
            UPDATE PICK_MANIFEST SET PICKM_STATUS = NEW.DESPATCH_STATUS,
                   LAST_UPDATE_DATE = 'NOW',
                   USER_ID = NEW.USER_ID,
                   DEVICE_ID = NEW.DEVICE_ID,
                   PICKM_CARRIER_ID = NEW.PICKD_CARRIER_ID  
            WHERE MANIFEST_ID = NEW.PICKD_MANIFEST_ID; 
         END
      END
   END
END^


SET TERM ; ^
COMMIT WORK;
SET AUTODDL ON;

