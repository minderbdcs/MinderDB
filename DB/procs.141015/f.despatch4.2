COMMIT WORK;
SET AUTODDL OFF;
SET TERM ^ ;


CREATE OR ALTER PROCEDURE GET_TOTAL_BLOCKS (PICK_ORDER VARCHAR(25) CHARACTER SET NONE)
RETURNS (WK_CNT INTEGER, WK_ORDER_STATUS VARCHAR(2))

AS
/* counts blocks on order    */
DECLARE VARIABLE WK_DEVICE       CHAR(2);
DECLARE VARIABLE WK_USER         VARCHAR(10);
DECLARE VARIABLE WK_DATE         TIMESTAMP;
DECLARE VARIABLE WK_LABEL_NO     PICK_LABEL_NO;
DECLARE VARIABLE WK_ORDER_WH_ID  WH_ID;
DECLARE VARIABLE WK_FOUND        INTEGER;
BEGIN
   WK_ORDER_WH_ID = NULL;
   SELECT PICK_STATUS , WH_ID FROM PICK_ORDER WHERE PICK_ORDER = :PICK_ORDER INTO :WK_ORDER_STATUS, :WK_ORDER_WH_ID;

   FOR SELECT COUNT(*) 
   FROM   (
          SELECT PID.DESPATCH_LOCATION  
          FROM PICK_ITEM_DETAIL PID
          JOIN LOCATION ON LOCATION.WH_ID = :WK_ORDER_WH_ID AND LOCATION.LOCN_ID = PID.DESPATCH_LOCATION
            AND LOCATION.MOVEABLE_LOCN = 'T'
          WHERE PID.PICK_ORDER = :PICK_ORDER
            /* AND (PID.PICK_DETAIL_STATUS NOT IN ( 'DX','CN','XX') ) */
            AND PID.PICK_DETAIL_STATUS IN ( 'PL','CL','AC') 
            AND PID.QTY_PICKED > 0
          GROUP BY PID.DESPATCH_LOCATION  
          )
   INTO :WK_CNT
   DO
   BEGIN
      SUSPEND;
   END

END  ^


SET TERM ; ^
COMMIT WORK;
SET AUTODDL ON;
