/*
add to control use remote despatch - attach to legacy url
add to control export name for pick order export
*/
ALTER TABLE CONTROL ADD USE_EXTERNAL_DESPATCH           VALUE_TF;
ALTER TABLE CONTROL ADD IMPORT_PICK_ORDER_EXPORT_NAME   RULES_NAME;
update control set use_external_despatch = 'F';

CREATE TABLE EXPORT_MAP_VAR (RECORD_ID RECORD_ID NOT NULL,
        EMV_RULES_NAME RULES_NAME NOT NULL,
        EMV_EXPORT_COL_NAME VARCHAR(40) NOT NULL,
        EMV_SEQUENCE SEQUENCE_NO DEFAULT 0 NOT NULL,
        EMV_TABLE VARCHAR(40) NOT NULL,
        EMV_FIELDNAME VARCHAR(40) NOT NULL,
        EMV_FIELDTYPE DATA_TYPE,
        EMV_FORMAT VARCHAR(40) ,
        EMV_PRIMARY_FIELD VALUE_TF ,
/* how to convert blob to csv format ? */
        CREATE_BY PERSON,
        CREATE_DATE TIMESTAMP,
        LAST_UPDATE_BY PERSON,
        LAST_UPDATE_DATE TIMESTAMP,
        EMV_PREFIX VARCHAR(40),
        EMV_SUFFIX VARCHAR(40),
        EMV_STATUS STATUS DEFAULT 'OK',
CONSTRAINT EXPORT_MAP_VAR_COL PRIMARY KEY (EMV_RULES_NAME, EMV_SEQUENCE));

CREATE TABLE EXPORT_MAP (RECORD_ID RECORD_ID NOT NULL,
        EM_RULES_NAME RULES_NAME NOT NULL,
/*
want file name base - 
use the primary columns values concatted seperated by _ followed by hhmm  created time and the extension 
*/
        EM_PATH FILESYSTEM_PATH NOT NULL,
        EM_FILENAME_EXTENSN CODE DEFAULT '.csv' NOT NULL,
        EM_SYS_SCREEN_NAME       VARCHAR(40) ,
/*
        EM_SYS_SCREEN_TABLE_NAME VARCHAR(40) ,
        include all sys_screen_table for the sys_screen_name
*/
        EM_WHERE VARCHAR(255) ,
        EM_INCLUDE_HEADER_LINE VALUE_TF,
        CREATE_BY PERSON,
        CREATE_DATE TIMESTAMP,
        LAST_UPDATE_BY PERSON,
        LAST_UPDATE_DATE TIMESTAMP,
        EM_STATUS STATUS DEFAULT 'OK',
CONSTRAINT EXPORT_MAP_NAME PRIMARY KEY (EM_RULES_NAME ));

/*
in pick order have a exported date
then in run to export select pick orders with a null exported date
        EXPORTED_IMPORT_DATE TIMESTAMP,
update all current orders to have this with 'NOW'
*/
ALTER TABLE PICK_ORDER    ADD EXPORTED_IMPORT_DATE TIMESTAMP;
ALTER TABLE PICK_ORDER_DX ADD EXPORTED_IMPORT_DATE TIMESTAMP;
update pick_order set exported_import_date = 'NOW';


create generator MAP_VAR_ID_GEN;

COMMIT WORK;
SET AUTODDL OFF;
SET TERM ^ ;

CREATE OR ALTER TRIGGER ADD_EXPORT_MAP FOR EXPORT_MAP 
ACTIVE BEFORE INSERT POSITION 20 
AS
BEGIN
   IF (NEW.RECORD_ID IS NULL OR NEW.RECORD_ID = 0) THEN
   BEGIN
      NEW.RECORD_ID = GEN_ID(IMPORT_MAP_ID_GEN,1);
   END
  NEW.LAST_UPDATE_DATE = 'NOW';
  NEW.CREATE_DATE = 'NOW';

END ^

CREATE OR ALTER TRIGGER UPD_EXPORT_MAP FOR EXPORT_MAP 
ACTIVE BEFORE UPDATE POSITION 20 
AS
BEGIN
   IF (NEW.RECORD_ID IS NULL OR NEW.RECORD_ID = 0) THEN
   BEGIN
      NEW.RECORD_ID = GEN_ID(IMPORT_MAP_ID_GEN,1);
   END
  NEW.LAST_UPDATE_DATE = 'NOW';
  NEW.CREATE_DATE = 'NOW';

END ^


CREATE OR ALTER TRIGGER ADD_EXPORT_MAP_VAR FOR EXPORT_MAP_VAR
ACTIVE BEFORE INSERT POSITION 10 
AS
BEGIN
   IF (NEW.RECORD_ID IS NULL OR NEW.RECORD_ID = 0 ) THEN
   BEGIN
      NEW.RECORD_ID = GEN_ID(MAP_VAR_ID_GEN,1);
   END
   NEW.LAST_UPDATE_DATE = 'NOW';
   NEW.CREATE_DATE = 'NOW';
END ^

CREATE TRIGGER UPD_EXPORT_MAP_VAR FOR EXPORT_MAP_VAR
ACTIVE BEFORE UPDATE POSITION 10 
AS
BEGIN
   IF (NEW.RECORD_ID IS NULL OR NEW.RECORD_ID = 0 ) THEN
   BEGIN
      NEW.RECORD_ID = GEN_ID(MAP_VAR_ID_GEN,1);
   END
   NEW.LAST_UPDATE_DATE = 'NOW';
END ^


SET TERM ; ^
COMMIT WORK;
SET AUTODDL ON;
