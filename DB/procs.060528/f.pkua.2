ALTER TABLE CONTROL ADD SEND_PKUA CHAR(1);

COMMIT WORK;
SET AUTODDL OFF;
SET TERM ^ ;
 
DROP TRIGGER RUN_TRANSACTION_PKUA ^
COMMIT^

CREATE TRIGGER RUN_TRANSACTION_PKUA FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 50 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_DEVICE CHAR(2);
DECLARE VARIABLE WK_USER VARCHAR(10);
DECLARE VARIABLE WK_RECORD INTEGER;
DECLARE VARIABLE WK_PI_LABEL VARCHAR(7);
DECLARE VARIABLE WK_PI_SSN VARCHAR(20);
DECLARE VARIABLE WK_PI_PROD VARCHAR(30);
DECLARE VARIABLE WK_PI_WH CHAR(2);
DECLARE VARIABLE WK_PI_LOCN VARCHAR(10);
DECLARE VARIABLE WK_PI_LASTLOCN VARCHAR(10);
DECLARE VARIABLE WK_PI_DESP_LOCN VARCHAR(10);
DECLARE VARIABLE WK_PI_QTY INTEGER;
DECLARE VARIABLE WK_PI_STATUS CHAR(2);
DECLARE VARIABLE WK_IS_STATUS CHAR(2);
DECLARE VARIABLE WK_DIRECTORY VARCHAR(80);
DECLARE VARIABLE WK_FILENAME VARCHAR(80);
DECLARE VARIABLE WK_LABEL_LINE VARCHAR(200);
DECLARE VARIABLE WK_RESULT INTEGER;
DECLARE VARIABLE WK_PROD_SSN VARCHAR(20);
DECLARE VARIABLE WK_DO_PKUA CHAR(1);
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'PKUA') THEN
  BEGIN
     WK_DEVICE = NEW.WH_ID;
     WK_USER = NEW.PERSON_ID;
     WK_RECORD = NEW.RECORD_ID;
     /*
         This transaction updates the pick_item to the 
         current location for the 1st issn possible
     */

     WK_DIRECTORY = '';
     SELECT FTP_DIRECTORY,SEND_PKUA 
         FROM CONTROL
         INTO :WK_DIRECTORY, :WK_DO_PKUA;
      WK_FILENAME = WK_DIRECTORY || WK_DEVICE || '.pk';
      IF (WK_DO_PKUA IS NULL) THEN
      BEGIN
         WK_DO_PKUA = 'T';
      END
      IF (WK_DO_PKUA = 'T') THEN
      BEGIN 
        /* clear devices file */
         WK_RESULT = FILE_DELETE(WK_FILENAME);
   /*
    no change to pick_location
         WK_RESULT = FILE_WRITELN(WK_FILENAME, 'DELETE FROM PICK_LOCATIONS'); 
   */
   /*               WHERE PICK_LINE_STATUS IN ('AL', 'PG', 'PL') */
        FOR 
           SELECT PICK_LABEL_NO, 
                  PROD_ID,
                  SSN_ID,
                  PICK_LINE_STATUS,
                  DESPATCH_LOCATION
                  FROM PICK_ITEM
                  WHERE PICK_LINE_STATUS IN ('AL', 'PG' )
                    AND DEVICE_ID = :WK_DEVICE
                  INTO :WK_PI_LABEL, :WK_PI_PROD, :WK_PI_SSN, :WK_PI_STATUS, :WK_PI_DESP_LOCN
        DO
        BEGIN
   /*
    must get
                  WH_ID,
                  LOCN_ID,
                  QTY_AVAIL,
                  ISSN_STATUS
   */
           WK_PI_WH = '';
           WK_PI_LOCN = '';
           WK_PI_LASTLOCN = '';
           WK_PI_QTY = 0;
           /* WK_PI_STATUS = ''; */
           IF (WK_PI_SSN IS NULL) THEN
           BEGIN
              /* a product */
              /* for PM AU - cannot recalc the pick_location */
              FOR
              SELECT FIRST 1 ISSN.WH_ID, ISSN.LOCN_ID, ISSN.CURRENT_QTY, ISSN.ISSN_STATUS, ISSN.SSN_ID
              FROM ISSN 
              WHERE ISSN.PROD_ID = :WK_PI_PROD 
                AND (ISSN.WH_ID < 'X' OR ISSN.WH_ID >'X~') AND ISSN.ISSN_STATUS IN ('RS','AL','ST','PA')
              ORDER BY ISSN.WH_ID, ISSN.LOCN_ID 
              INTO :WK_PI_WH, :WK_PI_LOCN, :WK_PI_QTY, :WK_IS_STATUS, :WK_PROD_SSN
              DO
              BEGIN
                 /* update status */
                 IF (WK_PI_LASTLOCN = '') THEN
                 BEGIN
                    UPDATE PICK_ITEM SET PICK_LOCATION = :WK_PI_LOCN, 
                       WH_ID = :WK_PI_WH 
                    WHERE PICK_LABEL_NO = :WK_PI_LABEL; 
                    WK_PI_LASTLOCN = WK_PI_LOCN;
                 END
   /*
    no change to pick_location
                 -* add to devices file *-
                 WK_LABEL_LINE = 'INSERT INTO PICK_LOCATIONS (PICK_LABEL_NO, PROD_ID , SSN_ID , WH_ID , LOCN_ID , QTY_AVAILABLE , ISSN_STATUS )  VALUES (' ||
                   SQUOTEDSTR(WK_PI_LABEL ) || ',' ||
                   SQUOTEDSTR(WK_PI_PROD ) || ',' ||
                   SQUOTEDSTR(WK_PROD_SSN ) || ',' ||
                   SQUOTEDSTR(WK_PI_WH ) || ',' ||
                   SQUOTEDSTR(WK_PI_LOCN ) || ',' ||
                   SQUOTEDSTR(ALLTRIM(CAST(WK_PI_QTY AS CHAR(6)))) || ',' ||
                   SQUOTEDSTR(WK_IS_STATUS ) || ')';
                 WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE);
   */
              END
           END
           ELSE
           BEGIN
              /* an ssn */
                 /* update status */
              UPDATE ISSN SET ISSN_STATUS = :WK_PI_STATUS WHERE SSN_ID = :WK_PI_SSN;
              SELECT ISSN.WH_ID, ISSN.LOCN_ID, ISSN.CURRENT_QTY  
              FROM ISSN 
              WHERE ISSN.SSN_ID = :WK_PI_SSN 
              INTO :WK_PI_WH, :WK_PI_LOCN, :WK_PI_QTY ;
              UPDATE PICK_ITEM SET PICK_LOCATION = :WK_PI_LOCN 
              WHERE PICK_LABEL_NO = :WK_PI_LABEL; 
   /*
    no change to pick_location
              -* add to devices file *-
              WK_LABEL_LINE = 'INSERT INTO PICK_LOCATIONS (PICK_LABEL_NO, PROD_ID , SSN_ID , WH_ID , LOCN_ID , QTY_AVAILABLE , ISSN_STATUS )  VALUES (' ||
                SQUOTEDSTR(WK_PI_LABEL ) || ',' ||
                SQUOTEDSTR(WK_PI_PROD ) || ',' ||
                SQUOTEDSTR(WK_PI_SSN ) || ',' ||
                SQUOTEDSTR(WK_PI_WH ) || ',' ||
                SQUOTEDSTR(WK_PI_LOCN ) || ',' ||
                SQUOTEDSTR(ALLTRIM(CAST(WK_PI_QTY AS CHAR(6)))) || ',' ||
                SQUOTEDSTR(WK_PI_STATUS ) || ')';
              WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE);
   */
           END
           /* add to devices file */
           WK_LABEL_LINE = 'UPDATE PICK_QTYS SET PICK_LINE_STATUS = ' ||
                   SQUOTEDSTR(WK_PI_STATUS) || ' , DESPATCH_LOCATION = ' ||
                   SQUOTEDSTR(WK_PI_DESP_LOCN) || ' WHERE PICK_LABEL_NO = ' ||
                   SQUOTEDSTR(WK_PI_LABEL );
           WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE);
        END
     END

   EXECUTE PROCEDURE UPDATE_TRAN (WK_RECORD, 'T','Processed successfully');
   /* EXECUTE PROCEDURE TRAN_ARCHIVE; */
  END
 END
END ^
 

SET TERM ; ^
COMMIT WORK;
SET AUTODDL ON;
