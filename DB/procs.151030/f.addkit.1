COMMIT WORK;
SET AUTODDL OFF;
SET TERM ^ ;
 
/*
CREATE OR ALTER PROCEDURE ADD_CHILD_KIT (WK_CHILD_PROD VARCHAR(30) ,
WK_CHILD_EXTENSION VARCHAR(6) ,
WK_STATUS VARCHAR(6) ,
WK_PROD_ID VARCHAR(30) ,
WK_CHILD_QTY INTEGER,
WK_PERSON VARCHAR(10) ,
WK_DATE TIMESTAMP)
*/


CREATE OR ALTER PROCEDURE ADD_CHILD_KIT (WK_CHILD_PROD PRODUCT ,
WK_CHILD_EXTENSION VARCHAR(6) ,
WK_STATUS VARCHAR(6) ,
WK_PROD_ID PRODUCT ,
WK_CHILD_QTY QTY,
WK_PERSON PERSON ,
WK_DATE TIMESTAMP)
AS 
 
/* DECLARE VARIABLE WK_CHILD_PROD_ID VARCHAR(30); */
DECLARE VARIABLE WK_CHILD_PROD_ID PRODUCT;
DECLARE VARIABLE WK_FOUND INTEGER;
DECLARE VARIABLE WK_RES INTEGER;
BEGIN
   WK_CHILD_PROD_ID = WK_CHILD_PROD || WK_CHILD_EXTENSION;
   /* does product exist */
   IF (LEN(WK_CHILD_PROD) > 0) THEN
   BEGIN
      
      WK_FOUND = 0;
      SELECT 1 FROM PROD_PROFILE
      WHERE PROD_ID = :WK_CHILD_PROD_ID
      INTO :WK_FOUND;
      IF (WK_FOUND = 0) THEN
      BEGIN
         /* no prod profile - so create a dummy */
         INSERT INTO PROD_PROFILE(PROD_ID, SHORT_DESC, PROD_RETRIEVE_STATUS )
         VALUES (:WK_CHILD_PROD_ID, :WK_CHILD_PROD_ID, :WK_STATUS);
      END
      ELSE
      BEGIN
         UPDATE PROD_PROFILE 
         SET PROD_RETRIEVE_STATUS = :WK_STATUS
         WHERE PROD_ID = :WK_CHILD_PROD_ID;
      END
      WK_FOUND = 0;
      SELECT 1 FROM PROD_EAN
      WHERE PROD_EAN = :WK_CHILD_PROD AND 
            PROD_EAN_EXTENSION = :WK_CHILD_EXTENSION
      INTO :WK_FOUND;
      IF (WK_FOUND = 0) THEN
      BEGIN
         /* no prod ean - so create one */
         INSERT INTO PROD_EAN(PROD_ID, PROD_EAN, PROD_EAN_EXTENSION)
         VALUES (:WK_CHILD_PROD_ID, :WK_CHILD_PROD, :WK_CHILD_EXTENSION);
      END
      /* check product kit */
      WK_FOUND = 0;
      SELECT 1 
      FROM PRODUCT_KIT
      WHERE KIT_ID = :WK_PROD_ID
      AND   PROD_ID = :WK_CHILD_PROD_ID
      INTO :WK_FOUND ;
      IF (WK_FOUND = 0) THEN
      BEGIN
         /* no kit - so create a dummy */
         INSERT INTO PRODUCT_KIT(KIT_ID, PROD_ID, CREATED_BY, CREATE_DATE, PROD_QTY , STATUS)
         VALUES (:WK_PROD_ID, :WK_CHILD_PROD_ID, :WK_PERSON, :WK_DATE, :WK_CHILD_QTY, 'OK');
      END
      ELSE
      BEGIN
         UPDATE PRODUCT_KIT SET STATUS = 'OK'
         WHERE KIT_ID = :WK_PROD_ID
         AND   PROD_ID = :WK_CHILD_PROD_ID;
      END
   END
END ^


SET TERM ; ^
COMMIT WORK;
SET AUTODDL ON;
