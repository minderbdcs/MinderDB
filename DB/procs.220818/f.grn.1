COMMIT WORK;
SET AUTODDL OFF;
SET TERM ^ ;


CREATE OR ALTER PROCEDURE NEXT_GRN_ID RETURNS (GRN GRN )
AS 

DECLARE VARIABLE WK_GRN_NO GRN;
DECLARE VARIABLE WK_GRN_START INTEGER;
DECLARE VARIABLE WK_GRN_STOP INTEGER;
DECLARE VARIABLE WK_LENGTH INTEGER;
DECLARE VARIABLE WK_GRN_ADJUSTMENT INTEGER;
DECLARE VARIABLE WK_LEN_NO INTEGER;
DECLARE VARIABLE WK_L_GRN_NO  GRN;
DECLARE VARIABLE WK_BUFFER                   VARCHAR(1024);
DECLARE VARIABLE WK_LOG_FILENAME VARCHAR(80);
DECLARE VARIABLE WK_LOG_RESULT INTEGER;
BEGIN
     WK_LOG_FILENAME = '/data/tmp/nextgrn.log';
     SELECT MAX_LENGTH
     FROM PARAM
     WHERE DATA_ID = 'GRN'
     INTO :WK_LENGTH;
/*   WK_GRN_NO = GEN_ID(GRN, 1); */ 
     WK_GRN_NO = NEXT VALUE FOR GRN ;    
     /* WK_GRN_NO = GRN_NO; */
     WK_GRN_START = GEN_ID(GRN_START, 0);
     WK_GRN_STOP = GEN_ID(GRN_STOP, 0);
     IF (WK_GRN_NO > WK_GRN_STOP) THEN
     BEGIN
        WK_GRN_ADJUSTMENT = WK_GRN_START - WK_GRN_STOP;
        WK_GRN_NO = GEN_ID(GRN, WK_GRN_ADJUSTMENT); 
        WK_GRN_NO = WK_GRN_START;
     END
/*   WK_LEN_NO = STRLEN(ALLTRIM(WK_GRN_NO)) ; */
/*   WK_LEN_NO = STRLEN(TRIM(WK_GRN_NO)) ; */
     WK_LEN_NO = CHAR_LENGTH(TRIM(WK_GRN_NO)) ;
     /* Get Label prefix */
     WK_L_GRN_NO = '';
     /* Padding leading with 0 */
     WHILE (WK_LEN_NO < WK_LENGTH) DO
     BEGIN
        WK_L_GRN_NO = WK_L_GRN_NO || '0';
        WK_LEN_NO = WK_LEN_NO + 1;
     END
/*   WK_L_GRN_NO = WK_L_GRN_NO || ALLTRIM(WK_GRN_NO); */
     WK_L_GRN_NO = WK_L_GRN_NO || TRIM(WK_GRN_NO);
     GRN = WK_L_GRN_NO;
     /* GRN_NO_OUT = WK_GRN_NO; */
     SUSPEND;
END ^

SET TERM ; ^
COMMIT WORK;
SET AUTODDL ON;
