
ALTER PROCEDURE PROCESS_TEST_RESULTS 
(
  CATEGORY VARCHAR(1),
  SSNID VARCHAR(20)
)
AS
 DECLARE VARIABLE STRPASSCRITERIA VARCHAR(6);
 DECLARE VARIABLE STRPASSFAIL VARCHAR(6);
 DECLARE VARIABLE INTTESTID INTEGER;
 DECLARE VARIABLE PROCESSFAILED INTEGER;
 DECLARE VARIABLE PROCESSPASSED INTEGER;
 DECLARE VARIABLE STRRESPONSE VARCHAR(50);
 DECLARE VARIABLE STRTEXTRESPONSE VARCHAR(30);
 DECLARE VARIABLE NUMNUMRESPONSE FLOAT;
 DECLARE VARIABLE DATEDATERESPONSE TIMESTAMP;
 DECLARE VARIABLE NUMFIELDTYPE INTEGER;
 DECLARE VARIABLE STRRESULT CHAR(1);
 DECLARE VARIABLE WK_QUESTION INTEGER;
 DECLARE VARIABLE WKORIGINAL VARCHAR(1);
 DECLARE VARIABLE WK_TEST_EXISTS INTEGER;
 DECLARE VARIABLE WK_TEST_ID INTEGER;
 DECLARE VARIABLE WKTESTID  INTEGER;
 DECLARE VARIABLE WKTESTID2  INTEGER;
 DECLARE VARIABLE WK_WHEN  TIMESTAMP;
 DECLARE VARIABLE STRDESC VARCHAR(30);
BEGIN
  STRPASSFAIL = 'PASSED';
  /* REMOVE THIS SSN FROM THE INCOMLETE TEST LIST */
     DELETE FROM RESUME_TEST WHERE SSN_ID = :SSNID;
     PROCESSFAILED = 0;
     PROCESSPASSED = 0;
     WKTESTID = -1;
     FOR SELECT
          INSPECT_PASS_CRITERIA,
          SSN_TEST_ID,
          RESPONSE,
          TEXT_RESPONSE,
          NUMBER_RESPONSE,
          DATE_RESPONSE,
          FIELD_TYPE,
          ORIGINAL_TEST,
          TEST_ID,
          TIME_STAMP
          FROM
          SSN_TEST_RESULTS
          WHERE
          SSN_ID = :SSNID
          AND INSPECT_CATEGORY = :CATEGORY
          AND PROCESSED = 'O'
        INTO
          :STRPASSCRITERIA, :INTTESTID, :STRRESPONSE, :STRTEXTRESPONSE, :NUMNUMRESPONSE, :DATEDATERESPONSE, :NUMFIELDTYPE , :WKORIGINAL, :WKTESTID2, :WK_WHEN
     DO 
     BEGIN
        IF (WKTESTID = -1) THEN
        BEGIN
          WK_TEST_EXISTS = 0;
          SELECT 1, TEST_ID FROM SSN_TEST
              WHERE SSN_ID = :SSNID AND
                    STATUS_TEST = 'OP'
              INTO :WK_TEST_EXISTS, :WK_TEST_ID;
          IF (WK_TEST_EXISTS = 0) THEN
          BEGIN
              /* MUST GET THE NEXT TEST ID */
              WK_TEST_ID = GEN_ID(TEST_ID, 1);
              INSERT INTO SSN_TEST(TEST_ID, SSN_ID, START_DATE, STATUS_TEST)
                     VALUES (:WK_TEST_ID, :SSNID, :WK_WHEN, 'OP');
          END 
          WKTESTID = WK_TEST_ID;
        END 
/*
        IF (NUMFIELDTYPE = 1) THEN
        BEGIN
  -* MEMO TYPE *-
        END
*/
        IF (NUMFIELDTYPE = 2) THEN
        BEGIN
  /* NUMBER TYPE */
  STRRESPONSE = NUMNUMRESPONSE;
        END
        IF (NUMFIELDTYPE = 3) THEN
        BEGIN
  /* DATE TYPE */
  STRRESPONSE = CAST(:DATEDATERESPONSE AS CHAR(22));
        END
        IF (NUMFIELDTYPE = 4) THEN
        BEGIN
  /* TEXT TYPE */
  STRRESPONSE = STRTEXTRESPONSE;
        END

        IF (CATEGORY = 'E') THEN 
        BEGIN
              UPDATE SSN
              SET OTHER5 = :STRRESPONSE
              WHERE SSN_ID = :SSNID;
        END
        ELSE
        BEGIN
            IF (STRPASSCRITERIA = 'FAILED') THEN 
            BEGIN
                STRPASSFAIL = 'FAILED';
                IF (WKORIGINAL = 'O') THEN
                BEGIN
                    EXECUTE PROCEDURE ADD_PROD_COND_STATUS_TEST :SSNID, :CATEGORY, :STRRESPONSE, 'S' 
                      RETURNING_VALUES :STRRESULT;
                END
                EXECUTE PROCEDURE ADD_PROD_COND_STATUS_TEST :SSNID, :CATEGORY, :STRRESPONSE, :WKORIGINAL 
                  RETURNING_VALUES :STRRESULT;
                /* FOUND AT LEAST ON RECORD */
                PROCESSFAILED = 1;
            END
            ELSE
            BEGIN
                IF (STRPASSCRITERIA = 'PASSED') THEN 
                BEGIN
                    /* FOUND AT LEAST ON RECORD */
                    PROCESSPASSED = 1;
                END
            END
        END
          
        UPDATE SSN_TEST_RESULTS SET PROCESSED = 'P', TEST_ID = :WKTESTID
        WHERE SSN_TEST_ID = :INTTESTID;
        WKTESTID = -1;
     END
     
     IF (PROCESSFAILED = 1) THEN 
     BEGIN
                       IF (CATEGORY = 'A') THEN BEGIN
                         EXECUTE PROCEDURE GET_GLOBAL_CONDITION 1, 'F' RETURNING_VALUES :STRDESC;
                         UPDATE SSN
                         /*SET OTHER1 = 'NOT NEW CONDITION'*/
                         SET OTHER1 = :STRDESC
                         WHERE SSN_ID = :SSNID;
                       END
                       IF (CATEGORY = 'B') THEN BEGIN
                         EXECUTE PROCEDURE GET_GLOBAL_CONDITION 2, 'F' RETURNING_VALUES :STRDESC;
                         UPDATE SSN
                         /*SET OTHER2 = 'TESTED - FAULTY'*/
                         SET OTHER2 = :STRDESC
                         WHERE SSN_ID = :SSNID;
                       END
                       IF (CATEGORY = 'C') THEN BEGIN
                         EXECUTE PROCEDURE GET_GLOBAL_CONDITION 3, 'F' RETURNING_VALUES :STRDESC;
                         UPDATE SSN
                         /*SET OTHER3 = 'INCOMPLETE'*/
                         SET OTHER3 = :STRDESC
                         WHERE SSN_ID = :SSNID;
                       END
                       IF (CATEGORY = 'D') THEN BEGIN
                         EXECUTE PROCEDURE GET_GLOBAL_CONDITION 4, 'F' RETURNING_VALUES :STRDESC;
                         UPDATE SSN
                         /*SET OTHER4 = 'SERVICE PROVIDED'*/
                         SET OTHER4 = :STRDESC
                         WHERE SSN_ID = :SSNID;
                       END
     END
     ELSE
     BEGIN
             IF (PROCESSPASSED = 1) THEN 
             BEGIN
                       IF (CATEGORY = 'A') THEN BEGIN
                         EXECUTE PROCEDURE GET_GLOBAL_CONDITION 1, 'P' RETURNING_VALUES :STRDESC;
                         UPDATE SSN
                         /*SET OTHER1 = 'AS NEW CONDITION'*/
                         SET OTHER1 = :STRDESC
                         WHERE SSN_ID = :SSNID;
                       END
                       IF (CATEGORY = 'B') THEN BEGIN
                         EXECUTE PROCEDURE GET_GLOBAL_CONDITION 2, 'P' RETURNING_VALUES :STRDESC;
                         UPDATE SSN
                         /*SET OTHER2 = 'TESTED - OK'*/
                         SET OTHER2 = :STRDESC
                         WHERE SSN_ID = :SSNID;
                       END
                       IF (CATEGORY = 'C') THEN BEGIN
                         EXECUTE PROCEDURE GET_GLOBAL_CONDITION 3, 'P' RETURNING_VALUES :STRDESC;
                         UPDATE SSN
                         /*SET OTHER3 = 'COMPLETE'*/
                         SET OTHER3 = :STRDESC
                         WHERE SSN_ID = :SSNID;
                       END
                       IF (CATEGORY = 'D') THEN BEGIN
                         EXECUTE PROCEDURE GET_GLOBAL_CONDITION 4, 'P' RETURNING_VALUES :STRDESC;
                         UPDATE SSN
                         /*SET OTHER4 = 'NO SERVICE'*/
                         SET OTHER4 = :STRDESC
                         WHERE SSN_ID = :SSNID;
                       END
             END
     END
             /* MUST UPDATE PASSED SSN ANSWER_ID = NULL
                QUESTION_ID = SEQUENCE 0 QUESTION FOR TYPE
             */
             /* GET SEQ 0 QUESTION */
             SELECT TQ.QUESTION_ID
                FROM SSN SN 
                     JOIN TEST_QUESTIONS TQ ON TQ.SSN_TYPE = SN.SSN_TYPE
                WHERE SN.SSN_ID = :SSNID
                     AND TQ.SEQUENCE = 0
                INTO :WK_QUESTION;
            UPDATE SSN SET ANSWER_ID = NULL,QUESTION_ID=:WK_QUESTION, STATUS_SSN ='PA' WHERE SSN_ID = :SSNID;
            UPDATE ISSN SET ISSN_STATUS ='PA' WHERE SSN_ID = :SSNID;
            UPDATE SSN_TEST SET STATUS_TEST = 'CL',END_DATE='NOW' 
                WHERE SSN_ID=:SSNID AND STATUS_TEST = 'OP';

END
 ^

