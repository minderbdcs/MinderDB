Database:  pinpoint, User: sysdba

SET SQL DIALECT 1; 

/* CREATE DATABASE 'pinpoint' DEFAULT CHARACTER SET NONE */

/*  External Function declarations */
DECLARE EXTERNAL FUNCTION ABS 
DOUBLE PRECISION
RETURNS DOUBLE PRECISION BY VALUE 
ENTRY_POINT 'IB_UDF_abs' MODULE_NAME 'ib_udf';

DECLARE EXTERNAL FUNCTION ABSDBL 
DOUBLE PRECISION
RETURNS DOUBLE PRECISION BY VALUE 
ENTRY_POINT 'fudlib_absdbl' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION ABSFLT 
FLOAT
RETURNS FLOAT BY VALUE 
ENTRY_POINT 'fudlib_absflt' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION ABSINT 
INTEGER
RETURNS INTEGER BY VALUE 
ENTRY_POINT 'fudlib_absint' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION ABSSML 
SMALLINT
RETURNS SMALLINT BY VALUE 
ENTRY_POINT 'fudlib_abssml' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION ACOS 
DOUBLE PRECISION
RETURNS DOUBLE PRECISION BY VALUE 
ENTRY_POINT 'IB_UDF_acos' MODULE_NAME 'ib_udf';

DECLARE EXTERNAL FUNCTION ADD_TIME 
TIMESTAMP, INTEGER, INTEGER, INTEGER, INTEGER, INTEGER
RETURNS TIMESTAMP FREE_IT
ENTRY_POINT 'fudlib_addtime' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION ALLTRIM 
CSTRING(256) CHARACTER SET NONE
RETURNS CSTRING(256) CHARACTER SET NONE FREE_IT
ENTRY_POINT 'fudlib_alltrim' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION ALLTRIMC 
CSTRING(256) CHARACTER SET NONE, CHAR(1) CHARACTER SET NONE
RETURNS CSTRING(256) CHARACTER SET NONE FREE_IT
ENTRY_POINT 'fudlib_alltrimc' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION ASCII 
CSTRING(1) CHARACTER SET NONE
RETURNS INTEGER BY VALUE 
ENTRY_POINT 'fudlib_ascii' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION ASCII_CHAR 
INTEGER
RETURNS CHAR(1) CHARACTER SET NONE FREE_IT
ENTRY_POINT 'IB_UDF_ascii_char' MODULE_NAME 'ib_udf';

DECLARE EXTERNAL FUNCTION ASCII_VAL 
CHAR(1) CHARACTER SET NONE
RETURNS INTEGER BY VALUE 
ENTRY_POINT 'IB_UDF_ascii_val' MODULE_NAME 'ib_udf';

DECLARE EXTERNAL FUNCTION ASIN 
DOUBLE PRECISION
RETURNS DOUBLE PRECISION BY VALUE 
ENTRY_POINT 'IB_UDF_asin' MODULE_NAME 'ib_udf';

DECLARE EXTERNAL FUNCTION ATAN 
DOUBLE PRECISION
RETURNS DOUBLE PRECISION BY VALUE 
ENTRY_POINT 'IB_UDF_atan' MODULE_NAME 'ib_udf';

DECLARE EXTERNAL FUNCTION ATAN2 
DOUBLE PRECISION, DOUBLE PRECISION
RETURNS DOUBLE PRECISION BY VALUE 
ENTRY_POINT 'IB_UDF_atan2' MODULE_NAME 'ib_udf';

DECLARE EXTERNAL FUNCTION BIN_AND 
INTEGER, INTEGER
RETURNS INTEGER BY VALUE 
ENTRY_POINT 'IB_UDF_bin_and' MODULE_NAME 'ib_udf';

DECLARE EXTERNAL FUNCTION BIN_OR 
INTEGER, INTEGER
RETURNS INTEGER BY VALUE 
ENTRY_POINT 'IB_UDF_bin_or' MODULE_NAME 'ib_udf';

DECLARE EXTERNAL FUNCTION BIN_XOR 
INTEGER, INTEGER
RETURNS INTEGER BY VALUE 
ENTRY_POINT 'IB_UDF_bin_xor' MODULE_NAME 'ib_udf';

DECLARE EXTERNAL FUNCTION BLOB_BYTECOUNT 
BLOB
RETURNS INTEGER BY VALUE 
ENTRY_POINT 'fn_blob_bytecount' MODULE_NAME 'udflib';

DECLARE EXTERNAL FUNCTION BLOB_LINECOUNT 
BLOB
RETURNS INTEGER BY VALUE 
ENTRY_POINT 'fn_blob_linecount' MODULE_NAME 'udflib';

DECLARE EXTERNAL FUNCTION BLOB_SUBSTR 
BLOB, INTEGER, INTEGER
RETURNS CSTRING(32767) CHARACTER SET NONE FREE_IT
ENTRY_POINT 'fn_blob_substr' MODULE_NAME 'udflib';

DECLARE EXTERNAL FUNCTION CEILING 
DOUBLE PRECISION
RETURNS DOUBLE PRECISION BY VALUE 
ENTRY_POINT 'IB_UDF_ceiling' MODULE_NAME 'ib_udf';

DECLARE EXTERNAL FUNCTION CENTER 
CSTRING(256) CHARACTER SET NONE, CSTRING(1) CHARACTER SET NONE, INTEGER
RETURNS CSTRING(256) CHARACTER SET NONE FREE_IT
ENTRY_POINT 'fudlib_centre' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION CENTRE 
CSTRING(256) CHARACTER SET NONE, CSTRING(1) CHARACTER SET NONE, INTEGER
RETURNS CSTRING(256) CHARACTER SET NONE FREE_IT
ENTRY_POINT 'fudlib_centre' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION CHECK_LOGIN 
INTEGER, CSTRING(40) CHARACTER SET NONE
RETURNS INTEGER BY VALUE 
ENTRY_POINT 'fn_checkcnt' MODULE_NAME 'udflib';

DECLARE EXTERNAL FUNCTION CHR 
INTEGER
RETURNS CSTRING(1) CHARACTER SET NONE FREE_IT
ENTRY_POINT 'fudlib_chr' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION COS 
DOUBLE PRECISION
RETURNS DOUBLE PRECISION BY VALUE 
ENTRY_POINT 'IB_UDF_cos' MODULE_NAME 'ib_udf';

DECLARE EXTERNAL FUNCTION COSH 
DOUBLE PRECISION
RETURNS DOUBLE PRECISION BY VALUE 
ENTRY_POINT 'IB_UDF_cosh' MODULE_NAME 'ib_udf';

DECLARE EXTERNAL FUNCTION COT 
DOUBLE PRECISION
RETURNS DOUBLE PRECISION BY VALUE 
ENTRY_POINT 'IB_UDF_cot' MODULE_NAME 'ib_udf';

DECLARE EXTERNAL FUNCTION CSTRADD 
CSTRING(256) CHARACTER SET NONE, CSTRING(256) CHARACTER SET NONE
RETURNS CSTRING(512) CHARACTER SET NONE FREE_IT
ENTRY_POINT 'fudlib_stradd' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION CSTRDEL 
CSTRING(256) CHARACTER SET NONE, INTEGER, INTEGER
RETURNS CSTRING(256) CHARACTER SET NONE FREE_IT
ENTRY_POINT 'fudlib_strdel' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION CSTR_PLUS_INT 
CSTRING(256) CHARACTER SET NONE, INTEGER
RETURNS CSTRING(256) CHARACTER SET NONE FREE_IT
ENTRY_POINT 'fudlib_cstr_plus_int' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION CSTR_TO_DBL 
CSTRING(256) CHARACTER SET NONE
RETURNS DOUBLE PRECISION BY VALUE 
ENTRY_POINT 'fudlib_cstr_to_dbl' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION DAY_OF_WEEK 
TIMESTAMP
RETURNS CSTRING(255) CHARACTER SET NONE FREE_IT
ENTRY_POINT 'fudlib_day_of_week' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION DEGREES 
DOUBLE PRECISION
RETURNS DOUBLE PRECISION BY VALUE 
ENTRY_POINT 'fudlib_degrees' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION DIFFDATE 
TIMESTAMP, TIMESTAMP, INTEGER
RETURNS INTEGER BY VALUE 
ENTRY_POINT 'fudlib_diffdate' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION DIV 
INTEGER, INTEGER
RETURNS DOUBLE PRECISION BY VALUE 
ENTRY_POINT 'IB_UDF_div' MODULE_NAME 'ib_udf';

DECLARE EXTERNAL FUNCTION DOW 
TIMESTAMP
RETURNS INTEGER BY VALUE 
ENTRY_POINT 'fudlib_dow' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION DQUOTEDSTR 
CSTRING(1024) CHARACTER SET NONE
RETURNS CSTRING(1024) CHARACTER SET NONE FREE_IT
ENTRY_POINT 'Dquotedstr' MODULE_NAME 'udf_file.dll';

DECLARE EXTERNAL FUNCTION EXP 
DOUBLE PRECISION
RETURNS DOUBLE PRECISION BY VALUE 
ENTRY_POINT 'fudlib_exp' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION FACT 
DOUBLE PRECISION
RETURNS DOUBLE PRECISION BY VALUE 
ENTRY_POINT 'fudlib_fact' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION FILE_CONCAT 
CSTRING(1024) CHARACTER SET NONE, CSTRING(124) CHARACTER SET NONE
RETURNS INTEGER BY VALUE 
ENTRY_POINT 'File_concat' MODULE_NAME 'udf_file.dll';

DECLARE EXTERNAL FUNCTION FILE_CREATE 
CSTRING(1024) CHARACTER SET NONE
RETURNS INTEGER BY VALUE 
ENTRY_POINT 'File_create' MODULE_NAME 'udf_file.dll';

DECLARE EXTERNAL FUNCTION FILE_DELETE 
CSTRING(1024) CHARACTER SET NONE
RETURNS INTEGER BY VALUE 
ENTRY_POINT 'File_delete' MODULE_NAME 'udf_file.dll';

DECLARE EXTERNAL FUNCTION FILE_RENAME 
CSTRING(1024) CHARACTER SET NONE, CSTRING(1024) CHARACTER SET NONE
RETURNS INTEGER BY VALUE 
ENTRY_POINT 'File_rename' MODULE_NAME 'udf_file.dll';

DECLARE EXTERNAL FUNCTION FILE_WRITE 
CSTRING(1024) CHARACTER SET NONE, CSTRING(1024) CHARACTER SET NONE
RETURNS INTEGER BY VALUE 
ENTRY_POINT 'File_write' MODULE_NAME 'udf_file.dll';

DECLARE EXTERNAL FUNCTION FILE_WRITELN 
CSTRING(1024) CHARACTER SET NONE, CSTRING(1024) CHARACTER SET NONE
RETURNS INTEGER BY VALUE 
ENTRY_POINT 'File_writeln' MODULE_NAME 'udf_file.dll';

DECLARE EXTERNAL FUNCTION FIRSTDAY 
TIMESTAMP
RETURNS TIMESTAMP FREE_IT
ENTRY_POINT 'fudlib_firstday' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION FLOOR 
DOUBLE PRECISION
RETURNS DOUBLE PRECISION BY VALUE 
ENTRY_POINT 'IB_UDF_floor' MODULE_NAME 'ib_udf';

DECLARE EXTERNAL FUNCTION FUD_ACOS 
DOUBLE PRECISION
RETURNS DOUBLE PRECISION BY VALUE 
ENTRY_POINT 'fudlib_acos' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION FUD_ASIN 
DOUBLE PRECISION
RETURNS DOUBLE PRECISION BY VALUE 
ENTRY_POINT 'fudlib_asin' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION FUD_ATAN 
DOUBLE PRECISION
RETURNS DOUBLE PRECISION BY VALUE 
ENTRY_POINT 'fudlib_atan' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION FUD_ATAN2 
DOUBLE PRECISION, DOUBLE PRECISION
RETURNS DOUBLE PRECISION BY VALUE 
ENTRY_POINT 'fudlib_atan2' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION FUD_COS 
DOUBLE PRECISION
RETURNS DOUBLE PRECISION BY VALUE 
ENTRY_POINT 'fudlib_cos' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION FUD_FLOOR 
DOUBLE PRECISION
RETURNS DOUBLE PRECISION BY VALUE 
ENTRY_POINT 'fudlib_floor' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION FUD_LOG 
DOUBLE PRECISION
RETURNS DOUBLE PRECISION BY VALUE 
ENTRY_POINT 'fudlib_log' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION FUD_LOG10 
DOUBLE PRECISION
RETURNS DOUBLE PRECISION BY VALUE 
ENTRY_POINT 'fudlib_log10' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION FUD_LOWER 
CSTRING(256) CHARACTER SET NONE
RETURNS CSTRING(256) CHARACTER SET NONE 
ENTRY_POINT 'fudlib_lower' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION FUD_PI 

RETURNS DOUBLE PRECISION BY VALUE 
ENTRY_POINT 'fudlib_PI' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION FUD_SIN 
DOUBLE PRECISION
RETURNS DOUBLE PRECISION BY VALUE 
ENTRY_POINT 'fudlib_sin' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION FUD_SOUNDEX 
CSTRING(256) CHARACTER SET NONE
RETURNS CSTRING(256) CHARACTER SET NONE FREE_IT
ENTRY_POINT 'fudlib_soundex' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION FUD_SQRT 
DOUBLE PRECISION
RETURNS DOUBLE PRECISION BY VALUE 
ENTRY_POINT 'fudlib_sqrt' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION FUD_TAN 
DOUBLE PRECISION
RETURNS DOUBLE PRECISION BY VALUE 
ENTRY_POINT 'fudlib_tan' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION FUD_TRUNCATE 
DOUBLE PRECISION, INTEGER
RETURNS DOUBLE PRECISION BY VALUE 
ENTRY_POINT 'fudlib_truncate' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION FUD_TTOC 
TIMESTAMP
RETURNS CSTRING(255) CHARACTER SET NONE FREE_IT
ENTRY_POINT 'fudlib_ttoc' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION FUD_VER 

RETURNS INTEGER BY VALUE 
ENTRY_POINT 'fudlib_fud_ver' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION INT_PLUS_CSTR 
CSTRING(256) CHARACTER SET NONE, INTEGER
RETURNS CSTRING(256) CHARACTER SET NONE FREE_IT
ENTRY_POINT 'fudlib_int_plus_cstr' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION JULIAN 
TIMESTAMP
RETURNS INTEGER BY VALUE 
ENTRY_POINT 'fudlib_julian' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION LASTDAY 
TIMESTAMP
RETURNS TIMESTAMP FREE_IT
ENTRY_POINT 'fudlib_lastday' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION LEFTS 
CSTRING(256) CHARACTER SET NONE, INTEGER
RETURNS CSTRING(256) CHARACTER SET NONE FREE_IT
ENTRY_POINT 'fudlib_lefts' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION LEN 
CSTRING(256) CHARACTER SET NONE
RETURNS INTEGER BY VALUE 
ENTRY_POINT 'fudlib_len' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION LN 
DOUBLE PRECISION
RETURNS DOUBLE PRECISION BY VALUE 
ENTRY_POINT 'IB_UDF_ln' MODULE_NAME 'ib_udf';

DECLARE EXTERNAL FUNCTION LOG 
DOUBLE PRECISION, DOUBLE PRECISION
RETURNS DOUBLE PRECISION BY VALUE 
ENTRY_POINT 'IB_UDF_log' MODULE_NAME 'ib_udf';

DECLARE EXTERNAL FUNCTION LOG10 
DOUBLE PRECISION
RETURNS DOUBLE PRECISION BY VALUE 
ENTRY_POINT 'IB_UDF_log10' MODULE_NAME 'ib_udf';

DECLARE EXTERNAL FUNCTION LOWER 
CSTRING(80) CHARACTER SET NONE
RETURNS CSTRING(80) CHARACTER SET NONE FREE_IT
ENTRY_POINT 'IB_UDF_lower' MODULE_NAME 'ib_udf';

DECLARE EXTERNAL FUNCTION LPAD 
CSTRING(256) CHARACTER SET NONE, CSTRING(1) CHARACTER SET NONE, INTEGER
RETURNS CSTRING(256) CHARACTER SET NONE FREE_IT
ENTRY_POINT 'fudlib_lpad' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION LTRIM 
CSTRING(80) CHARACTER SET NONE
RETURNS CSTRING(80) CHARACTER SET NONE FREE_IT
ENTRY_POINT 'IB_UDF_ltrim' MODULE_NAME 'ib_udf';

DECLARE EXTERNAL FUNCTION LTRIMC 
CSTRING(256) CHARACTER SET NONE, CHAR(1) CHARACTER SET NONE
RETURNS CSTRING(256) CHARACTER SET NONE FREE_IT
ENTRY_POINT 'fudlib_ltrimc' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION MAKEDATE 
INTEGER, INTEGER, INTEGER, INTEGER, INTEGER, INTEGER
RETURNS TIMESTAMP FREE_IT
ENTRY_POINT 'fudlib_makedate' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION MAXDBL 
DOUBLE PRECISION, DOUBLE PRECISION
RETURNS DOUBLE PRECISION BY VALUE 
ENTRY_POINT 'fudlib_maxdbl' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION MAXFLT 
FLOAT, FLOAT
RETURNS FLOAT BY VALUE 
ENTRY_POINT 'fudlib_maxflt' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION MAXINT 
INTEGER, INTEGER
RETURNS INTEGER BY VALUE 
ENTRY_POINT 'fudlib_maxint' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION MAXSML 
SMALLINT, SMALLINT
RETURNS SMALLINT BY VALUE 
ENTRY_POINT 'fudlib_maxsml' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION MAXTIME 
TIMESTAMP
RETURNS TIMESTAMP FREE_IT
ENTRY_POINT 'fudlib_maxtime' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION MER_DAY 
TIMESTAMP
RETURNS INTEGER BY VALUE 
ENTRY_POINT 'fudlib_mer_day' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION MER_HOUR 
TIMESTAMP
RETURNS INTEGER BY VALUE 
ENTRY_POINT 'fudlib_mer_hour' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION MER_MINUTE 
TIMESTAMP
RETURNS INTEGER BY VALUE 
ENTRY_POINT 'fudlib_mer_minute' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION MER_MONTH 
TIMESTAMP
RETURNS INTEGER BY VALUE 
ENTRY_POINT 'fudlib_mer_month' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION MER_YEAR 
TIMESTAMP
RETURNS INTEGER BY VALUE 
ENTRY_POINT 'fudlib_mer_year' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION MINDBL 
DOUBLE PRECISION, DOUBLE PRECISION
RETURNS DOUBLE PRECISION BY VALUE 
ENTRY_POINT 'fudlib_mindbl' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION MINFLT 
FLOAT, FLOAT
RETURNS FLOAT BY VALUE 
ENTRY_POINT 'fudlib_minflt' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION MININT 
INTEGER, INTEGER
RETURNS INTEGER BY VALUE 
ENTRY_POINT 'fudlib_minint' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION MINSML 
SMALLINT, SMALLINT
RETURNS SMALLINT BY VALUE 
ENTRY_POINT 'fudlib_minsml' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION MOD 
INTEGER, INTEGER
RETURNS DOUBLE PRECISION BY VALUE 
ENTRY_POINT 'IB_UDF_mod' MODULE_NAME 'ib_udf';

DECLARE EXTERNAL FUNCTION MODQUOT 
INTEGER, INTEGER
RETURNS INTEGER BY VALUE 
ENTRY_POINT 'fudlib_modquot' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION MODREM 
INTEGER, INTEGER
RETURNS INTEGER BY VALUE 
ENTRY_POINT 'fudlib_modrem' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION MONTH_OF_YEAR 
TIMESTAMP
RETURNS CSTRING(255) CHARACTER SET NONE FREE_IT
ENTRY_POINT 'fudlib_month_of_year' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION MSEC 
TIMESTAMP
RETURNS INTEGER BY VALUE 
ENTRY_POINT 'fudlib_msec' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION NONULL 
CSTRING(1024) CHARACTER SET NONE
RETURNS CSTRING(1024) CHARACTER SET NONE FREE_IT
ENTRY_POINT 'Nonull' MODULE_NAME 'udf_file.dll';

DECLARE EXTERNAL FUNCTION NUMBERFORMAT 
CSTRING(1024) CHARACTER SET NONE, CSTRING(1024) CHARACTER SET NONE
RETURNS CSTRING(1024) CHARACTER SET NONE FREE_IT
ENTRY_POINT 'Numberformat' MODULE_NAME 'udf_file.dll';

DECLARE EXTERNAL FUNCTION PAD 
CSTRING(256) CHARACTER SET NONE, CSTRING(1) CHARACTER SET NONE, INTEGER
RETURNS CSTRING(256) CHARACTER SET NONE FREE_IT
ENTRY_POINT 'fudlib_pad' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION PADLEFT 
CSTRING(1024) CHARACTER SET NONE, INTEGER
RETURNS CSTRING(1024) CHARACTER SET NONE FREE_IT
ENTRY_POINT 'Padleft' MODULE_NAME 'udf_file.dll';

DECLARE EXTERNAL FUNCTION PADRIGHT 
CSTRING(1024) CHARACTER SET NONE, INTEGER
RETURNS CSTRING(1024) CHARACTER SET NONE FREE_IT
ENTRY_POINT 'Padright' MODULE_NAME 'udf_file.dll';

DECLARE EXTERNAL FUNCTION PARSE 
CSTRING(256) CHARACTER SET NONE, CSTRING(1) CHARACTER SET NONE, INTEGER
RETURNS CSTRING(256) CHARACTER SET NONE FREE_IT
ENTRY_POINT 'fudlib_parse' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION PI 

RETURNS DOUBLE PRECISION BY VALUE 
ENTRY_POINT 'IB_UDF_pi' MODULE_NAME 'ib_udf';

DECLARE EXTERNAL FUNCTION POS 
CSTRING(256) CHARACTER SET NONE, CSTRING(256) CHARACTER SET NONE, INTEGER, INTEGER
RETURNS INTEGER BY VALUE 
ENTRY_POINT 'fudlib_pos' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION POW 
DOUBLE PRECISION, DOUBLE PRECISION
RETURNS DOUBLE PRECISION BY VALUE 
ENTRY_POINT 'fudlib_pow' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION POW10 
DOUBLE PRECISION
RETURNS DOUBLE PRECISION BY VALUE 
ENTRY_POINT 'fudlib_pow10' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION PROPER 
CSTRING(256) CHARACTER SET NONE
RETURNS CSTRING(256) CHARACTER SET NONE FREE_IT
ENTRY_POINT 'fudlib_proper' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION QUARTER 
TIMESTAMP, INTEGER
RETURNS CSTRING(255) CHARACTER SET NONE FREE_IT
ENTRY_POINT 'fudlib_quarter' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION RADIANS 
DOUBLE PRECISION
RETURNS DOUBLE PRECISION BY VALUE 
ENTRY_POINT 'fudlib_radians' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION RAND 

RETURNS DOUBLE PRECISION BY VALUE 
ENTRY_POINT 'IB_UDF_rand' MODULE_NAME 'ib_udf';

DECLARE EXTERNAL FUNCTION REPLICATE 
CSTRING(1) CHARACTER SET NONE, INTEGER
RETURNS CSTRING(256) CHARACTER SET NONE FREE_IT
ENTRY_POINT 'fudlib_replicate' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION REVERSE 
CSTRING(256) CHARACTER SET NONE
RETURNS CSTRING(256) CHARACTER SET NONE FREE_IT
ENTRY_POINT 'fudlib_reverse' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION RIGHTS 
CSTRING(256) CHARACTER SET NONE, INTEGER
RETURNS CSTRING(256) CHARACTER SET NONE FREE_IT
ENTRY_POINT 'fudlib_rights' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION ROUND 
DOUBLE PRECISION, INTEGER
RETURNS DOUBLE PRECISION BY VALUE 
ENTRY_POINT 'fudlib_round' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION RTRIM 
CSTRING(80) CHARACTER SET NONE
RETURNS CSTRING(80) CHARACTER SET NONE FREE_IT
ENTRY_POINT 'IB_UDF_rtrim' MODULE_NAME 'ib_udf';

DECLARE EXTERNAL FUNCTION RTRIMC 
CSTRING(256) CHARACTER SET NONE, CHAR(1) CHARACTER SET NONE
RETURNS CSTRING(256) CHARACTER SET NONE FREE_IT
ENTRY_POINT 'fudlib_rtrimc' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION SEC 
TIMESTAMP
RETURNS INTEGER BY VALUE 
ENTRY_POINT 'fudlib_sec' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION SIGN 
DOUBLE PRECISION
RETURNS INTEGER BY VALUE 
ENTRY_POINT 'IB_UDF_sign' MODULE_NAME 'ib_udf';

DECLARE EXTERNAL FUNCTION SIN 
DOUBLE PRECISION
RETURNS DOUBLE PRECISION BY VALUE 
ENTRY_POINT 'IB_UDF_sin' MODULE_NAME 'ib_udf';

DECLARE EXTERNAL FUNCTION SINH 
DOUBLE PRECISION
RETURNS DOUBLE PRECISION BY VALUE 
ENTRY_POINT 'IB_UDF_sinh' MODULE_NAME 'ib_udf';

DECLARE EXTERNAL FUNCTION SQRT 
DOUBLE PRECISION
RETURNS DOUBLE PRECISION BY VALUE 
ENTRY_POINT 'IB_UDF_sqrt' MODULE_NAME 'ib_udf';

DECLARE EXTERNAL FUNCTION SQUOTEDSTR 
CSTRING(1024) CHARACTER SET NONE
RETURNS CSTRING(1024) CHARACTER SET NONE FREE_IT
ENTRY_POINT 'Squotedstr' MODULE_NAME 'udf_file.dll';

DECLARE EXTERNAL FUNCTION STRFORMAT 
CSTRING(1024) CHARACTER SET NONE, CSTRING(1024) CHARACTER SET NONE, CSTRING(1) CHARACTER SET NONE
RETURNS CSTRING(1024) CHARACTER SET NONE FREE_IT
ENTRY_POINT 'Strformat' MODULE_NAME 'udf_file.dll';

DECLARE EXTERNAL FUNCTION STRLEN 
CSTRING(32767) CHARACTER SET NONE
RETURNS INTEGER BY VALUE 
ENTRY_POINT 'IB_UDF_strlen' MODULE_NAME 'ib_udf';

DECLARE EXTERNAL FUNCTION SUBSTR 
CSTRING(80) CHARACTER SET NONE, SMALLINT, SMALLINT
RETURNS CSTRING(80) CHARACTER SET NONE FREE_IT
ENTRY_POINT 'IB_UDF_substr' MODULE_NAME 'ib_udf';

DECLARE EXTERNAL FUNCTION SUB_TIME 
TIMESTAMP, INTEGER, INTEGER, INTEGER, INTEGER, INTEGER
RETURNS TIMESTAMP FREE_IT
ENTRY_POINT 'fudlib_subtime' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION TAN 
DOUBLE PRECISION
RETURNS DOUBLE PRECISION BY VALUE 
ENTRY_POINT 'IB_UDF_tan' MODULE_NAME 'ib_udf';

DECLARE EXTERNAL FUNCTION TANH 
DOUBLE PRECISION
RETURNS DOUBLE PRECISION BY VALUE 
ENTRY_POINT 'IB_UDF_tanh' MODULE_NAME 'ib_udf';

DECLARE EXTERNAL FUNCTION TRUNCATE 
DOUBLE PRECISION, INTEGER
RETURNS DOUBLE PRECISION BY VALUE 
ENTRY_POINT 'fudlib_udftruncate' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION V4ALLTRIM 
CSTRING(1024) CHARACTER SET NONE
RETURNS CSTRING(1024) CHARACTER SET NONE FREE_IT
ENTRY_POINT 'fudlib_alltrim' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION V4PARSE 
CSTRING(1024) CHARACTER SET NONE, CSTRING(1) CHARACTER SET NONE, INTEGER
RETURNS CSTRING(1024) CHARACTER SET NONE FREE_IT
ENTRY_POINT 'fudlib_parse' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION V4POS 
CSTRING(32767) CHARACTER SET NONE, CSTRING(256) CHARACTER SET NONE, INTEGER, INTEGER
RETURNS INTEGER BY VALUE 
ENTRY_POINT 'fudlib_pos' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION V4SUBSTRING 
CSTRING(32767) CHARACTER SET NONE, INTEGER, INTEGER
RETURNS CSTRING(256) CHARACTER SET NONE FREE_IT
ENTRY_POINT 'fudlib_substr' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION VALLTRIM 
CSTRING(256) CHARACTER SET NONE
RETURNS CSTRING(256) CHARACTER SET NONE FREE_IT
ENTRY_POINT 'fudlib_alltrim' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION VALLTRIMC 
CSTRING(256) CHARACTER SET NONE, CSTRING(1) CHARACTER SET NONE
RETURNS CSTRING(256) CHARACTER SET NONE FREE_IT
ENTRY_POINT 'fudlib_alltrimc' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION VCENTER 
CSTRING(256) CHARACTER SET NONE, CSTRING(1) CHARACTER SET NONE, INTEGER
RETURNS CSTRING(256) CHARACTER SET NONE FREE_IT
ENTRY_POINT 'fudlib_centre' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION VCENTRE 
CSTRING(256) CHARACTER SET NONE, CSTRING(1) CHARACTER SET NONE, INTEGER
RETURNS CSTRING(256) CHARACTER SET NONE FREE_IT
ENTRY_POINT 'fudlib_centre' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION VCHARADD 
CSTRING(256) CHARACTER SET NONE, CSTRING(256) CHARACTER SET NONE
RETURNS CSTRING(512) CHARACTER SET NONE FREE_IT
ENTRY_POINT 'fudlib_stradd' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION VCHARDEL 
CSTRING(256) CHARACTER SET NONE, INTEGER, INTEGER
RETURNS CSTRING(256) CHARACTER SET NONE FREE_IT
ENTRY_POINT 'fudlib_strdel' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION VER 

RETURNS DOUBLE PRECISION BY VALUE 
ENTRY_POINT 'fudlib_ver' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION VLEFTS 
CSTRING(256) CHARACTER SET NONE, INTEGER
RETURNS CSTRING(256) CHARACTER SET NONE FREE_IT
ENTRY_POINT 'fudlib_lefts' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION VLEN 
CSTRING(256) CHARACTER SET NONE
RETURNS INTEGER BY VALUE 
ENTRY_POINT 'fudlib_len' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION VLOWER 
CSTRING(256) CHARACTER SET NONE
RETURNS CSTRING(256) CHARACTER SET NONE 
ENTRY_POINT 'fudlib_lower' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION VLPAD 
CSTRING(256) CHARACTER SET NONE, CSTRING(1) CHARACTER SET NONE, INTEGER
RETURNS CSTRING(256) CHARACTER SET NONE FREE_IT
ENTRY_POINT 'fudlib_lpad' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION VLTRIM 
CSTRING(256) CHARACTER SET NONE
RETURNS CSTRING(256) CHARACTER SET NONE FREE_IT
ENTRY_POINT 'fudlib_ltrim' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION VLTRIMC 
CSTRING(256) CHARACTER SET NONE, CSTRING(1) CHARACTER SET NONE
RETURNS CSTRING(256) CHARACTER SET NONE FREE_IT
ENTRY_POINT 'fudlib_ltrimc' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION VPAD 
CSTRING(256) CHARACTER SET NONE, CSTRING(1) CHARACTER SET NONE, INTEGER
RETURNS CSTRING(256) CHARACTER SET NONE FREE_IT
ENTRY_POINT 'fudlib_pad' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION VPARSE 
CSTRING(256) CHARACTER SET NONE, CSTRING(1) CHARACTER SET NONE, INTEGER
RETURNS CSTRING(256) CHARACTER SET NONE FREE_IT
ENTRY_POINT 'fudlib_parse' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION VPOS 
CSTRING(256) CHARACTER SET NONE, CSTRING(256) CHARACTER SET NONE, INTEGER, INTEGER
RETURNS INTEGER BY VALUE 
ENTRY_POINT 'fudlib_pos' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION VPROPER 
CSTRING(256) CHARACTER SET NONE
RETURNS CSTRING(256) CHARACTER SET NONE FREE_IT
ENTRY_POINT 'fudlib_proper' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION VREPLICATE 
CSTRING(1) CHARACTER SET NONE, INTEGER
RETURNS CSTRING(256) CHARACTER SET NONE FREE_IT
ENTRY_POINT 'fudlib_replicate' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION VREVERSE 
CSTRING(256) CHARACTER SET NONE
RETURNS CSTRING(256) CHARACTER SET NONE FREE_IT
ENTRY_POINT 'fudlib_reverse' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION VRIGHTS 
CSTRING(256) CHARACTER SET NONE, INTEGER
RETURNS CSTRING(256) CHARACTER SET NONE FREE_IT
ENTRY_POINT 'fudlib_rights' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION VRTRIM 
CSTRING(256) CHARACTER SET NONE
RETURNS CSTRING(256) CHARACTER SET NONE FREE_IT
ENTRY_POINT 'fudlib_rtrim' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION VRTRIMC 
CSTRING(256) CHARACTER SET NONE, CSTRING(1) CHARACTER SET NONE
RETURNS CSTRING(256) CHARACTER SET NONE FREE_IT
ENTRY_POINT 'fudlib_rtrimc' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION VSUBSTRING 
CSTRING(256) CHARACTER SET NONE, INTEGER, INTEGER
RETURNS CSTRING(256) CHARACTER SET NONE FREE_IT
ENTRY_POINT 'fudlib_substr' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION WEEK 
TIMESTAMP
RETURNS INTEGER BY VALUE 
ENTRY_POINT 'fudlib_week' MODULE_NAME 'fudlib';

DECLARE EXTERNAL FUNCTION ZEROTIME 
TIMESTAMP
RETURNS TIMESTAMP FREE_IT
ENTRY_POINT 'fudlib_zerotime' MODULE_NAME 'fudlib';


/*  Generators or sequences */
CREATE GENERATOR ADDR_GEN;
CREATE GENERATOR AUTOEXEC_TRANSACTIONS;
CREATE GENERATOR BARCODE_CODE_GEN;
CREATE GENERATOR CARRIER_CONNOTE_ID_GEN1;
CREATE GENERATOR CARRIER_CONNOTE_ID_GEN10;
CREATE GENERATOR CARRIER_CONNOTE_ID_GEN11;
CREATE GENERATOR CARRIER_CONNOTE_ID_GEN12;
CREATE GENERATOR CARRIER_CONNOTE_ID_GEN13;
CREATE GENERATOR CARRIER_CONNOTE_ID_GEN14;
CREATE GENERATOR CARRIER_CONNOTE_ID_GEN15;
CREATE GENERATOR CARRIER_CONNOTE_ID_GEN2;
CREATE GENERATOR CARRIER_CONNOTE_ID_GEN3;
CREATE GENERATOR CARRIER_CONNOTE_ID_GEN4;
CREATE GENERATOR CARRIER_CONNOTE_ID_GEN5;
CREATE GENERATOR CARRIER_CONNOTE_ID_GEN6;
CREATE GENERATOR CARRIER_CONNOTE_ID_GEN7;
CREATE GENERATOR CARRIER_CONNOTE_ID_GEN8;
CREATE GENERATOR CARRIER_CONNOTE_ID_GEN9;
CREATE GENERATOR CARRIER_SERVICE_ID_GEN;
CREATE GENERATOR CHANGE_PICK_ORDER;
CREATE GENERATOR CHART_ACCOUNTS_ID_GEN;
CREATE GENERATOR CONNOTE_FTP_GEN1;
CREATE GENERATOR CONNOTE_FTP_GEN2;
CREATE GENERATOR CONNOTE_FTP_GEN5;
CREATE GENERATOR CONNOTE_FTP__GEN3;
CREATE GENERATOR CONNOTE_FTP__GEN4;
CREATE GENERATOR DESPATCH_DSOT;
CREATE GENERATOR DESPATCH_ID_GEN;
CREATE GENERATOR DESPATCH_PACK_ID_GEN;
CREATE GENERATOR EMP_IMAGE_GEN;
CREATE GENERATOR EMP_NO_GEN;
CREATE GENERATOR FORM_NO_GEN;
CREATE GENERATOR FTP_ID_GEN1;
CREATE GENERATOR FTP_ID_GEN2;
CREATE GENERATOR FTP_ID_GEN3;
CREATE GENERATOR FTP_ID_GEN4;
CREATE GENERATOR FTP_ID_GEN5;
CREATE GENERATOR FTP_MANIFEST_GEN1;
CREATE GENERATOR FTP_MANIFEST_GEN2;
CREATE GENERATOR FTP_MANIFEST_GEN3;
CREATE GENERATOR FTP_MANIFEST_GEN4;
CREATE GENERATOR FTP_MANIFEST_GEN5;
CREATE GENERATOR GRN;
CREATE GENERATOR GRN_LABEL_GEN;
CREATE GENERATOR GRN_LABEL_START;
CREATE GENERATOR GRN_LABEL_STOP;
CREATE GENERATOR GRN_START;
CREATE GENERATOR GRN_STOP;
CREATE GENERATOR IMPORT_MAP_ID_GEN;
CREATE GENERATOR IMPORT_SSN_FROM_LEGACY;
CREATE GENERATOR INSP_HIST_RECORD_ID;
CREATE GENERATOR ISSN_SSN_ID;
CREATE GENERATOR LOAD_NO_GEN;
CREATE GENERATOR LOAN_NO_GEN;
CREATE GENERATOR LOAN_RATE_ID_GEN;
CREATE GENERATOR LOG_GEN;
CREATE GENERATOR MESSAGE_ID_GEN;
CREATE GENERATOR OBJECTID_GEN;
CREATE GENERATOR PERSON_ADDRESS_GEN;
CREATE GENERATOR PICK_DETAIL_GEN;
CREATE GENERATOR PICK_INVOICE_GEN;
CREATE GENERATOR PICK_INVOICE_ID_GEN;
CREATE GENERATOR PICK_INVOICE_LINE_ID_GEN;
CREATE GENERATOR PICK_INVOICE_PREFIX;
CREATE GENERATOR PICK_INVOICE_START;
CREATE GENERATOR PICK_INVOICE_STOP;
CREATE GENERATOR PICK_LABEL_GEN;
CREATE GENERATOR PICK_LABEL_PREFIX;
CREATE GENERATOR PICK_LABEL_START;
CREATE GENERATOR PICK_LABEL_STOP;
CREATE GENERATOR PICK_LOCATION_ID_GEN;
CREATE GENERATOR POSTCODE_DEPOT_ID_GEN;
CREATE GENERATOR PRINTSELECT_ID;
CREATE GENERATOR PROD_TYPE_GEN;
CREATE GENERATOR PURCHASE_DETAIL_GEN;
CREATE GENERATOR PURCHASE_ORDER_ID_GEN;
CREATE GENERATOR PURCHASE_SUB_LINE_GEN;
CREATE GENERATOR PUTAWAY_ID_GEN;
CREATE GENERATOR REPORT_DETAIL_ID_GEN;
CREATE GENERATOR REPORT_ID_GEN;
CREATE GENERATOR SALE_ORDER_ID_GEN;
CREATE GENERATOR SO_ADDRESS2;
CREATE GENERATOR SO_INSTR2_FAX;
CREATE GENERATOR SSN_HIST_RECORD_ID;
CREATE GENERATOR SSN_TEST_ID_GEN;
CREATE GENERATOR STOCKTAKE_ID_GEN;
CREATE GENERATOR SYS_ASCII_ID_GEN;
CREATE GENERATOR SYS_LABEL_ID_GEN;
CREATE GENERATOR SYS_LABEL_VAR_ID_GEN;
CREATE GENERATOR SYS_MENU_ID_GEN;
CREATE GENERATOR SYS_SCREEN_ACTION_ID_GEN;
CREATE GENERATOR SYS_SCREEN_BUTTON_ID_GEN;
CREATE GENERATOR SYS_SCREEN_COLOUR_ID_GEN;
CREATE GENERATOR SYS_SCREEN_ID_GEN;
CREATE GENERATOR SYS_SCREEN_ORDER_ID_GEN;
CREATE GENERATOR SYS_SCREEN_PROCEDURE_ID_GEN;
CREATE GENERATOR SYS_SCREEN_TABLE_ID_GEN;
CREATE GENERATOR SYS_SCREEN_TAB_ID_GEN;
CREATE GENERATOR SYS_SCREEN_VAR_ID_GEN;
CREATE GENERATOR TASK_ID_GEN;
CREATE GENERATOR TEMP_ID_GEN;
CREATE GENERATOR TESTS_RECORD_ID_GEN;
CREATE GENERATOR TEST_ID;
CREATE GENERATOR TEST_QUESTIONS_RECORD_ID_GEN;
CREATE GENERATOR TRANSACTION_ID;
CREATE GENERATOR TRN_LINE_NO_GEN;
CREATE GENERATOR UNIQUE_ID_GEN;
CREATE GENERATOR VALID_RESPONSES_RECORD_ID_GEN;

/* Domain definitions */
CREATE DOMAIN ABN AS VARCHAR(30);
CREATE DOMAIN ACCESSION AS VARCHAR(80);
CREATE DOMAIN ACCESS_LEVEL AS CHAR(1);
CREATE DOMAIN ACCOUNTING_PERIODS AS INTEGER;
CREATE DOMAIN ACN AS VARCHAR(30);
CREATE DOMAIN ACQUISITION_COST AS FLOAT;
CREATE DOMAIN ADDRESS_LINE AS VARCHAR(50);
CREATE DOMAIN ADDR_NAME AS VARCHAR(100);
CREATE DOMAIN ALT_NAME AS VARCHAR(128);
CREATE DOMAIN AUDITED AS CHAR(1);
CREATE DOMAIN AUDITED_BY AS VARCHAR(10);
CREATE DOMAIN AUDIT_DATE AS TIMESTAMP;
CREATE DOMAIN AUDIT_RECOUNT_BY AS VARCHAR(10);
CREATE DOMAIN AUDIT_RECOUNT_DATE AS TIMESTAMP;
CREATE DOMAIN AUTO_ALOC_PURCHASE_ORDER AS CHAR(1);
CREATE DOMAIN AUTO_ALOC_SSN AS CHAR(1);
CREATE DOMAIN AWB_CONSIGNMENT_NO AS VARCHAR(20);
CREATE DOMAIN BOOK_VALUE AS FLOAT;
CREATE DOMAIN BRAND AS VARCHAR(40);
CREATE DOMAIN CARRIER AS VARCHAR(10);
CREATE DOMAIN CARRIER_ACCOUNT_NO AS VARCHAR(10);
CREATE DOMAIN CC_C AS VARCHAR(10);
CREATE DOMAIN CHARGE_RATE AS NUMERIC(9, 3);
CREATE DOMAIN CHARGE_TO AS VARCHAR(40);
CREATE DOMAIN CHECKIN_FINISH AS TIMESTAMP;
CREATE DOMAIN CHECKIN_START AS TIMESTAMP;
CREATE DOMAIN CITY AS VARCHAR(25);
CREATE DOMAIN CLOSED AS VARCHAR(6);
CREATE DOMAIN CLOSE_DATE AS TIMESTAMP;
CREATE DOMAIN CLOSE_METHOD AS VARCHAR(6);
CREATE DOMAIN CLOSING_DATE AS TIMESTAMP;
CREATE DOMAIN CLOSING_VALUE AS FLOAT;
CREATE DOMAIN CODE AS VARCHAR(40);
CREATE DOMAIN CODE_128 AS VARCHAR(128);
CREATE DOMAIN CODE_255 AS VARCHAR(255);
CREATE DOMAIN CODE_32K AS VARCHAR(32000);
CREATE DOMAIN CODE_6 AS VARCHAR(6);
CREATE DOMAIN CODE_8K AS VARCHAR(8196);
CREATE DOMAIN CODE_ONE AS CHAR(1);
CREATE DOMAIN CODE_TWO AS CHAR(2);
CREATE DOMAIN CODE_TWO_VAR AS VARCHAR(2);
CREATE DOMAIN COLLECTION_NAME AS VARCHAR(128);
CREATE DOMAIN COLLECTION_TYPE AS VARCHAR(5);
CREATE DOMAIN COMMENTS AS VARCHAR(512);
CREATE DOMAIN COMMISSIONED_DATE AS TIMESTAMP;
CREATE DOMAIN COMPANY AS VARCHAR(20);
CREATE DOMAIN COMPANY_LOGO AS BLOB SUB_TYPE 0 SEGMENT SIZE 80;
CREATE DOMAIN COMPANY_NAME AS VARCHAR(50);
CREATE DOMAIN COMPLETE AS CHAR(1);
CREATE DOMAIN CONTACT AS VARCHAR(50);
CREATE DOMAIN CONTACT_FIRST_NAME AS VARCHAR(25);
CREATE DOMAIN CONTACT_LAST_NAME AS VARCHAR(25);
CREATE DOMAIN CONTACT_NAME AS VARCHAR(50);
CREATE DOMAIN CONTAINER_NO AS VARCHAR(20);
CREATE DOMAIN COST_CENTER AS VARCHAR(40);
CREATE DOMAIN COUNTRY AS VARCHAR(25);
CREATE DOMAIN CRATE_OWNER AS VARCHAR(10);
CREATE DOMAIN CREATE_DATE AS TIMESTAMP;
CREATE DOMAIN CURRENT_LOGGED_ON AS TIMESTAMP;
CREATE DOMAIN CURRENT_PERSON AS VARCHAR(10);
CREATE DOMAIN CUSTOMER_PO_WO AS VARCHAR(20);
CREATE DOMAIN DATA_EXPRESSION AS VARCHAR(20);
CREATE DOMAIN DATA_ID AS VARCHAR(20);
CREATE DOMAIN DATA_SOURCE AS VARCHAR(10);
CREATE DOMAIN DATA_TYPE AS CHAR(1);
CREATE DOMAIN DATETIME AS TIMESTAMP;
CREATE DOMAIN DATE_INTO AS TIMESTAMP;
CREATE DOMAIN DB_VERSION AS CHAR(10);
CREATE DOMAIN DELIVERY_DOCKET AS VARCHAR(10);
CREATE DOMAIN DELIVERY_RUN_NO AS VARCHAR(10);
CREATE DOMAIN DEPARTMENT AS VARCHAR(40);
CREATE DOMAIN DEPOT AS VARCHAR(4);
CREATE DOMAIN DEPOT_ID AS VARCHAR(10);
CREATE DOMAIN DEPRECIATE AS CHAR(1);
CREATE DOMAIN DEPRECIATED_VALUE AS FLOAT;
CREATE DOMAIN DEPRECIATE_DATE AS TIMESTAMP;
CREATE DOMAIN DEPRECIATION_LIMIT AS FLOAT;
CREATE DOMAIN DEPRECIATION_RATE AS FLOAT;
CREATE DOMAIN DEPTH AS DOUBLE PRECISION;
CREATE DOMAIN DESCR AS VARCHAR(75);
CREATE DOMAIN DESCRIPTION AS VARCHAR(50);
CREATE DOMAIN DESPATCHED_VOL AS INTEGER;
CREATE DOMAIN DESPATCH_CARRIER AS VARCHAR(10);
CREATE DOMAIN DESPATCH_FINISH AS TIMESTAMP;
CREATE DOMAIN DESPATCH_ID AS INTEGER;
CREATE DOMAIN DESPATCH_LABEL_NO AS VARCHAR(40);
CREATE DOMAIN DESPATCH_LOCATION AS VARCHAR(10);
CREATE DOMAIN DESPATCH_POST_CODE AS VARCHAR(10);
CREATE DOMAIN DESPATCH_TS AS TIMESTAMP;
CREATE DOMAIN DEVICE_ID AS CHAR(2);
CREATE DOMAIN DEVICE_TYPE AS CHAR(2);
CREATE DOMAIN DISCOUNT AS DOUBLE PRECISION
         default 0;
CREATE DOMAIN DISPOSAL_COST AS FLOAT;
CREATE DOMAIN DISPOSAL_DATE AS TIMESTAMP;
CREATE DOMAIN DISPOSAL_NOTES AS VARCHAR(255);
CREATE DOMAIN DISPOSAL_PRICE AS FLOAT;
CREATE DOMAIN DISPOSED AS CHAR(1);
CREATE DOMAIN DIVISION AS VARCHAR(20);
CREATE DOMAIN DRIVER_LICENSE_CLASS AS VARCHAR(10);
CREATE DOMAIN DRIVER_LICENSE_EXPIRY AS TIMESTAMP;
CREATE DOMAIN DRIVER_LICENSE_NO AS VARCHAR(20);
CREATE DOMAIN DRIVER_LICENSE_STATE AS VARCHAR(10);
CREATE DOMAIN DUE_DATE_DAYS AS INTEGER;
CREATE DOMAIN EDITABLE AS CHAR(1);
CREATE DOMAIN EMAIL AS VARCHAR(50);
CREATE DOMAIN END_NO AS INTEGER;
CREATE DOMAIN EOY_DATE AS TIMESTAMP;
CREATE DOMAIN ERROR_TEXT AS VARCHAR(255);
CREATE DOMAIN ERROR_TEXTV4 AS VARCHAR(255);
CREATE DOMAIN EXPORTED AS INTEGER;
CREATE DOMAIN EXPORT_DATE AS TIMESTAMP;
CREATE DOMAIN EXTERNAL_PRODUCT AS VARCHAR(40);
CREATE DOMAIN FAX_NO AS VARCHAR(30);
CREATE DOMAIN FIB$BOOLEAN AS SMALLINT
         DEFAULT 1
         CHECK (VALUE IN (0,1)) NOT NULL;
CREATE DOMAIN FIELD AS VARCHAR(30);
CREATE DOMAIN FIELD_CODE AS CHAR(1);
CREATE DOMAIN FIELD_ID AS INTEGER;
CREATE DOMAIN FILE_NUMBER AS VARCHAR(50);
CREATE DOMAIN FIRST_NAME AS VARCHAR(50);
CREATE DOMAIN FIXED_LENGTH AS CHAR(1);
CREATE DOMAIN FLAGS AS CHAR(1);
CREATE DOMAIN FREEZE_DATE AS TIMESTAMP;
CREATE DOMAIN FREEZE_VALUE AS FLOAT;
CREATE DOMAIN FREIGHT_ACCOUNT_NO AS VARCHAR(20);
CREATE DOMAIN GENDER AS CHAR(1);
CREATE DOMAIN GENERAL_FLOAT AS FLOAT;
CREATE DOMAIN GENERIC AS VARCHAR(40);
CREATE DOMAIN GOV_TAX AS FLOAT;
CREATE DOMAIN GRN AS VARCHAR(10);
CREATE DOMAIN GRN_DATE AS TIMESTAMP;
CREATE DOMAIN GRN_LABEL_NO AS VARCHAR(20);
CREATE DOMAIN GRN_PRINTED AS TIMESTAMP;
CREATE DOMAIN GRN_STATUS AS CHAR(2)
         DEFAULT 'DL';
CREATE DOMAIN GST_CODE AS VARCHAR(3);
CREATE DOMAIN GST_RATE AS INTEGER;
CREATE DOMAIN GST_VALUE AS INTEGER;
CREATE DOMAIN HAZARD_STATUS AS VARCHAR(5);
CREATE DOMAIN HAZARD_WARNING AS VARCHAR(128);
CREATE DOMAIN HEADER AS INTEGER;
CREATE DOMAIN HEIGHT AS NUMERIC(4, 3);
CREATE DOMAIN HIRE_RATE AS DOUBLE PRECISION;
CREATE DOMAIN IMAGE AS BLOB SUB_TYPE 0 SEGMENT SIZE 80;
CREATE DOMAIN IMAGE_DATE AS TIMESTAMP;
CREATE DOMAIN IMAGE_FORMAT AS VARCHAR(4);
CREATE DOMAIN IMAGE_LOC AS VARCHAR(255);
CREATE DOMAIN IMAGE_NAME AS VARCHAR(20);
CREATE DOMAIN IMAGE_NO AS INTEGER;
CREATE DOMAIN IMAGE_SOURCE AS VARCHAR(50);
CREATE DOMAIN INITIALS AS VARCHAR(3);
CREATE DOMAIN INPUT_SOURCE AS VARCHAR(15);
CREATE DOMAIN INPUT_SOURCEV4 AS VARCHAR(512);
CREATE DOMAIN INSTANCE_ID AS CHAR(10);
CREATE DOMAIN INSURED_VALUE AS FLOAT;
CREATE DOMAIN INTO_DATE AS TIMESTAMP;
CREATE DOMAIN INVENTORY_OPERATOR AS CHAR(1);
CREATE DOMAIN INVOICE_ID AS INTEGER;
CREATE DOMAIN INVOICE_NO AS VARCHAR(10);
CREATE DOMAIN INVOICE_NUMBER AS VARCHAR(15);
CREATE DOMAIN INV_WITH_GOODS AS CHAR(1);
CREATE DOMAIN IP_ADDRESS AS VARCHAR(20);
CREATE DOMAIN ISSUE_PER_ORDER_UNIT AS INTEGER;
CREATE DOMAIN ITEM_CODE AS VARCHAR(20);
CREATE DOMAIN KIT_QTY AS DOUBLE PRECISION;
CREATE DOMAIN LABEL_DATE AS TIMESTAMP;
CREATE DOMAIN LABEL_LOCN AS CHAR(1);
CREATE DOMAIN LANGUAGE AS VARCHAR(20);
CREATE DOMAIN LAST_AUDITED_DATE AS TIMESTAMP;
CREATE DOMAIN LAST_BC_NUMBER AS INTEGER;
CREATE DOMAIN LAST_CHECK AS TIMESTAMP;
CREATE DOMAIN LAST_LOAD_NO AS INTEGER;
CREATE DOMAIN LAST_NAME AS VARCHAR(50);
CREATE DOMAIN LAST_PURCHASE_ORDER AS INTEGER;
CREATE DOMAIN LAST_SSN_ID AS INTEGER;
CREATE DOMAIN LAST_UPDATE_DATE AS TIMESTAMP;
CREATE DOMAIN LEASED AS CHAR(1);
CREATE DOMAIN LEASE_EXPIRY_DATE AS TIMESTAMP;
CREATE DOMAIN LEASOR AS VARCHAR(10);
CREATE DOMAIN LEGACY_ADDRESS_LINE AS VARCHAR(80);
CREATE DOMAIN LEGACY_CODE AS CHAR(4);
CREATE DOMAIN LEGACY_CODE_TWO AS CHAR(2);
CREATE DOMAIN LEGACY_COUNTRY AS VARCHAR(35);
CREATE DOMAIN LEGACY_DESCRIPTION AS VARCHAR(200);
CREATE DOMAIN LEGACY_ID AS VARCHAR(20);
CREATE DOMAIN LEGACY_POST_CODE AS VARCHAR(20);
CREATE DOMAIN LICENCE_NUMBER AS VARCHAR(30);
CREATE DOMAIN LIFE_UNITS AS INTEGER;
CREATE DOMAIN LIFE_UNITS_USED AS INTEGER;
CREATE DOMAIN LOAN_ACTUAL_CHARGE_UNITS AS INTEGER;
CREATE DOMAIN LOAN_ACTUAL_RETURN AS TIMESTAMP;
CREATE DOMAIN LOAN_ACTUAL_START AS TIMESTAMP;
CREATE DOMAIN LOAN_CALIBRATE_CHECK AS CHAR(1);
CREATE DOMAIN LOAN_CALIBRATE_PERIOD AS CHAR(1);
CREATE DOMAIN LOAN_DUE_RETURN AS TIMESTAMP;
CREATE DOMAIN LOAN_LAST_CALIBRATE_CHECK_DATE AS TIMESTAMP;
CREATE DOMAIN LOAN_LAST_SAFETY_CHECK_DATE AS TIMESTAMP;
CREATE DOMAIN LOAN_ORDER_DATE AS TIMESTAMP;
CREATE DOMAIN LOAN_ORDER_LINE_NO AS VARCHAR(4);
CREATE DOMAIN LOAN_ORDER_NO AS VARCHAR(10);
CREATE DOMAIN LOAN_PERIOD AS CHAR(1);
CREATE DOMAIN LOAN_SAFETY_CHECK AS CHAR(1);
CREATE DOMAIN LOAN_SAFETY_PERIOD AS CHAR(1);
CREATE DOMAIN LOAN_START_DATE AS TIMESTAMP;
CREATE DOMAIN LOCN_ID AS VARCHAR(10);
CREATE DOMAIN LOCN_NAME AS VARCHAR(50);
CREATE DOMAIN LOCN_SEQ AS DECIMAL(7, 3);
CREATE DOMAIN LOC_PERM_LEVEL AS CHAR(1);
CREATE DOMAIN LOGIN_DATE AS TIMESTAMP;
CREATE DOMAIN LONG_DESC AS VARCHAR(255);
CREATE DOMAIN LOT_LINE_NO AS VARCHAR(4);
CREATE DOMAIN LOT_NO AS VARCHAR(10);
CREATE DOMAIN LOWEST_LIMIT AS FLOAT;
CREATE DOMAIN MAIL_CITY AS VARCHAR(25);
CREATE DOMAIN MAIL_COUNTRY AS VARCHAR(25);
CREATE DOMAIN MAIL_POST_CODE AS VARCHAR(10);
CREATE DOMAIN MAIL_STATE AS VARCHAR(15);
CREATE DOMAIN MAN_BRAND AS CHAR(1);
CREATE DOMAIN MAN_COST_CENTER AS CHAR(1);
CREATE DOMAIN MAN_GENERIC AS CHAR(1);
CREATE DOMAIN MAN_MODEL AS CHAR(1);
CREATE DOMAIN MAN_SERIAL_NUMBER AS CHAR(1);
CREATE DOMAIN MAN_TYPE AS CHAR(1);
CREATE DOMAIN MAX_LENGTH AS INTEGER;
CREATE DOMAIN MDR_DESCRIPTION AS VARCHAR(50);
CREATE DOMAIN MDR_STATUS AS CHAR(2);
CREATE DOMAIN MDR_USER_ID AS VARCHAR(10);
CREATE DOMAIN MESSAGE_ID AS VARCHAR(10);
CREATE DOMAIN METHOD_CODE AS VARCHAR(3);
CREATE DOMAIN METHOD_CODE10 AS VARCHAR(10);
CREATE DOMAIN METHOD_NAME AS VARCHAR(30);
CREATE DOMAIN MOBILE_NO AS VARCHAR(15);
CREATE DOMAIN MODEL AS VARCHAR(40);
CREATE DOMAIN MOVE_DATE AS TIMESTAMP;
CREATE DOMAIN MOVE_DIRECTION AS CHAR(1);
CREATE DOMAIN MOVE_PERIOD AS VARCHAR(4);
CREATE DOMAIN NAME AS VARCHAR(30);
CREATE DOMAIN NEXT_CHECK AS TIMESTAMP;
CREATE DOMAIN NOTES AS BLOB SUB_TYPE TEXT SEGMENT SIZE 80;
CREATE DOMAIN OBJECT AS VARCHAR(30);
CREATE DOMAIN OBJECT_NAME AS VARCHAR(128);
CREATE DOMAIN OBJECT_NUMBER AS VARCHAR(128);
CREATE DOMAIN OBJECT_REC_ID AS INTEGER;
CREATE DOMAIN OBJECT_STAT AS CHAR(1);
CREATE DOMAIN OCCUPATION AS VARCHAR(25);
CREATE DOMAIN ORDER_LINE AS CHAR(4);
CREATE DOMAIN ORDER_NO AS VARCHAR(10);
CREATE DOMAIN OTHER_CHAR AS VARCHAR(50);
CREATE DOMAIN OTHER_DATE AS TIMESTAMP;
CREATE DOMAIN PACK_EAN_SSCC AS VARCHAR(18);
CREATE DOMAIN PACK_ID AS INTEGER;
CREATE DOMAIN PACK_T AS CHAR(1);
CREATE DOMAIN PALLETS_YN AS CHAR(1);
CREATE DOMAIN PALLET_NO AS VARCHAR(7);
CREATE DOMAIN PALLET_OWNER AS VARCHAR(10);
CREATE DOMAIN PARENT_SSN_ID AS VARCHAR(20);
CREATE DOMAIN PARTIAL_PICK_ALLOWED AS CHAR(1);
CREATE DOMAIN PASS_WORD AS VARCHAR(10);
CREATE DOMAIN PASS_WORD_DATE AS TIMESTAMP;
CREATE DOMAIN PDF_DESCRIPTION AS BLOB SUB_TYPE 0 SEGMENT SIZE 80;
CREATE DOMAIN PERCENT AS SMALLINT
         check (value is null OR value between 0 and 100);
CREATE DOMAIN PERCENT_F AS DOUBLE PRECISION;
CREATE DOMAIN PERIOD_KEY AS VARCHAR(7);
CREATE DOMAIN PERIOD_NAME AS VARCHAR(30);
CREATE DOMAIN PERIOD_NO AS INTEGER;
CREATE DOMAIN PERIOD_YEAR AS VARCHAR(4);
CREATE DOMAIN PERM_LEVEL AS CHAR(1);
CREATE DOMAIN PERSON AS VARCHAR(10);
CREATE DOMAIN PHONE_NO AS VARCHAR(30);
CREATE DOMAIN PICK_DETAIL_ID AS INTEGER;
CREATE DOMAIN PICK_DUE_DATE AS TIMESTAMP;
CREATE DOMAIN PICK_ID AS VARCHAR(40);
CREATE DOMAIN PICK_LABEL_NO AS VARCHAR(7);
CREATE DOMAIN PICK_LINE_DUE_DATE AS TIMESTAMP;
CREATE DOMAIN PICK_LINE_PRIORITY AS INTEGER;
CREATE DOMAIN PICK_ORDER AS VARCHAR(15);
CREATE DOMAIN PICK_ORDER_LINE_NO AS CHAR(4);
CREATE DOMAIN PICK_PRIORITY AS SMALLINT;
CREATE DOMAIN PICK_STARTED AS TIMESTAMP;
CREATE DOMAIN POST_CODE AS VARCHAR(10);
CREATE DOMAIN PO_DATE AS TIMESTAMP;
CREATE DOMAIN PO_DUE_DATE AS TIMESTAMP;
CREATE DOMAIN PO_LINE AS CHAR(4);
CREATE DOMAIN PO_LINE_DUE_DATE AS TIMESTAMP;
CREATE DOMAIN PO_LINE_QTY_F AS DOUBLE PRECISION;
CREATE DOMAIN PO_ORDER AS VARCHAR(10);
CREATE DOMAIN PO_PRINTED AS TIMESTAMP;
CREATE DOMAIN PO_RECEIVE_DATE AS TIMESTAMP;
CREATE DOMAIN PO_REVISION_NO AS CHAR(2);
CREATE DOMAIN PREV_DATE AS TIMESTAMP;
CREATE DOMAIN PREV_LOCN AS VARCHAR(10);
CREATE DOMAIN PREV_LOCN_DATE AS TIMESTAMP;
CREATE DOMAIN PRICE_DECIMAL AS DECIMAL(9, 3);
CREATE DOMAIN PRICE_NUMERIC AS NUMERIC(9, 3);
CREATE DOMAIN PRINTED AS CHAR(1);
CREATE DOMAIN PRINTED_BY AS VARCHAR(10);
CREATE DOMAIN PRIVILIGE_CODE AS INTEGER;
CREATE DOMAIN PRODUCT AS VARCHAR(30);
CREATE DOMAIN PROD_EAN AS VARCHAR(14);
CREATE DOMAIN PROD_EAN_EXTENSION AS VARCHAR(6);
CREATE DOMAIN PROD_IMAGE AS BLOB SUB_TYPE 0 SEGMENT SIZE 80;
CREATE DOMAIN PROD_PERM_LEVEL AS CHAR(1);
CREATE DOMAIN PURCHASE_DATE AS TIMESTAMP;
CREATE DOMAIN PURCHASE_DETAIL_ID AS INTEGER;
CREATE DOMAIN PURCHASE_ORDER AS VARCHAR(10);
CREATE DOMAIN PURCHASE_PRICE AS FLOAT;
CREATE DOMAIN PW_EXPIRY_DATE AS TIMESTAMP;
CREATE DOMAIN QLI$PROCEDURE AS BLOB SUB_TYPE TEXT SEGMENT SIZE 80;
CREATE DOMAIN QLI$PROCEDURE_NAME AS CHAR(31);
CREATE DOMAIN QTY AS INTEGER;
CREATE DOMAIN QTY_DECIMAL AS DOUBLE PRECISION;
CREATE DOMAIN QTY_F AS DOUBLE PRECISION;
CREATE DOMAIN QUERY_FROM_TYPE AS CHAR(4)
         DEFAULT 'SQL'
         CHECK (VALUE IN ('SQL','FUN'));
CREATE DOMAIN QUERY_PROMPT_TYPE AS CHAR(1)
         DEFAULT 'C'
         CHECK (VALUE IN ('C','D','F','I','L','S'));
CREATE DOMAIN QUESTION AS VARCHAR(70);
CREATE DOMAIN RECORDS AS DOUBLE PRECISION;
CREATE DOMAIN RECORD_ID AS INTEGER;
CREATE DOMAIN REFERENCE AS VARCHAR(255);
CREATE DOMAIN RELATIONSHIP AS VARCHAR(20);
CREATE DOMAIN REPLENISH AS CHAR(1);
CREATE DOMAIN REQUISITION_NO AS VARCHAR(10);
CREATE DOMAIN RESPONSE_CODE AS INTEGER;
CREATE DOMAIN RESPONSE_HEADINGS AS VARCHAR(40);
CREATE DOMAIN RETICULATION AS VARCHAR(40);
CREATE DOMAIN RETURN_ORDER_PRINTED AS TIMESTAMP;
CREATE DOMAIN RMA AS VARCHAR(10);
CREATE DOMAIN RMA_DATE AS TIMESTAMP;
CREATE DOMAIN RMA_LINE AS CHAR(4);
CREATE DOMAIN RMA_LINE_DUE_DATE AS TIMESTAMP;
CREATE DOMAIN SECOND_CONTACT_FIRST_NAME AS VARCHAR(25);
CREATE DOMAIN SECOND_CONTACT_LAST_NAME AS VARCHAR(25);
CREATE DOMAIN SECOND_EMAIL AS VARCHAR(50);
CREATE DOMAIN SECOND_FAX_NO AS VARCHAR(30);
CREATE DOMAIN SECOND_MOBILE_NO AS VARCHAR(15);
CREATE DOMAIN SECOND_PHONE_NO AS VARCHAR(30);
CREATE DOMAIN SEQUENCE_NO AS INTEGER;
CREATE DOMAIN SERIAL_NUMBER AS VARCHAR(30);
CREATE DOMAIN SERVICE_TYPE AS VARCHAR(4);
CREATE DOMAIN SHIP_SERVICE AS VARCHAR(10);
CREATE DOMAIN SHIP_VIA AS VARCHAR(10);
CREATE DOMAIN SHORT_DESC AS VARCHAR(255);
CREATE DOMAIN SPECIAL_INSTR AS VARCHAR(50);
CREATE DOMAIN SPECIAL_INSTRUCTIONS1 AS VARCHAR(8192);
CREATE DOMAIN SPECIAL_INSTRUCTIONS2 AS VARCHAR(255);
CREATE DOMAIN SSN_DESCRIPTION AS VARCHAR(80);
CREATE DOMAIN SSN_GROUP AS VARCHAR(20);
CREATE DOMAIN SSN_ID AS VARCHAR(20);
CREATE DOMAIN SSN_REC_ID AS INTEGER;
CREATE DOMAIN SSN_TRACK AS CHAR(1);
CREATE DOMAIN SSN_TYPE AS VARCHAR(40);
CREATE DOMAIN STANDARD_COST AS DOUBLE PRECISION;
CREATE DOMAIN START_DATE AS TIMESTAMP;
CREATE DOMAIN START_NO AS INTEGER;
CREATE DOMAIN STATE AS VARCHAR(15);
CREATE DOMAIN STATUS AS CHAR(2);
CREATE DOMAIN STATUS_CODE AS VARCHAR(10);
CREATE DOMAIN STATUS_CODE_DATE AS TIMESTAMP;
CREATE DOMAIN STATUS_SSN_DATE AS TIMESTAMP;
CREATE DOMAIN STOCK AS CHAR(1);
CREATE DOMAIN SUBURB AS VARCHAR(40);
CREATE DOMAIN SUPERANNUATION_NO AS VARCHAR(20);
CREATE DOMAIN SUPPLIER_ID AS VARCHAR(10);
CREATE DOMAIN SUPPLIER_NO AS VARCHAR(40);
CREATE DOMAIN SUPPLIER_NO_PROD AS VARCHAR(20);
CREATE DOMAIN SUPPLIER_PREFER AS VARCHAR(3);
CREATE DOMAIN SYMBOLOGY_PREFIX AS VARCHAR(20);
CREATE DOMAIN SYSTEM_DATE AS TIMESTAMP;
CREATE DOMAIN SYS_ADMIN AS CHAR(1);
CREATE DOMAIN TASK_PERM_LEVEL AS CHAR(1);
CREATE DOMAIN TAX_AMOUNT AS NUMERIC(15, 2)
         default 0;
CREATE DOMAIN TAX_RATE AS DOUBLE PRECISION
         default 0;
CREATE DOMAIN TERMINATION_VALUE AS FLOAT;
CREATE DOMAIN TEXT_LIST AS BLOB SUB_TYPE 0 SEGMENT SIZE 100;
CREATE DOMAIN TITLE AS VARCHAR(5);
CREATE DOMAIN TRAINING_DATE AS TIMESTAMP;
CREATE DOMAIN TRAINING_PASS AS CHAR(1);
CREATE DOMAIN TRAINING_RESULT AS VARCHAR(20);
CREATE DOMAIN TRN_CODE AS CHAR(1);
CREATE DOMAIN TRN_DATA AS VARCHAR(1024);
CREATE DOMAIN TRN_DATE AS TIMESTAMP;
CREATE DOMAIN TRN_TYPE AS VARCHAR(4);
CREATE DOMAIN TRUEFALSE AS VARCHAR(6);
CREATE DOMAIN TYPE_CODE AS VARCHAR(40);
CREATE DOMAIN UNION_MEMBERSHIP_NO AS VARCHAR(20);
CREATE DOMAIN UNIT_PRICE AS DOUBLE PRECISION;
CREATE DOMAIN UOM AS VARCHAR(10);
CREATE DOMAIN UPL_DATE AS TIMESTAMP;
CREATE DOMAIN UPL_FILE_NAME AS VARCHAR(8);
CREATE DOMAIN URL AS VARCHAR(50);
CREATE DOMAIN USER_ID AS VARCHAR(10);
CREATE DOMAIN USER_TYPE AS CHAR(2);
CREATE DOMAIN USE_BY_DATE AS VARCHAR(20);
CREATE DOMAIN VALUE_FT AS CHAR(1)
         DEFAULT 'T'
         CHECK (VALUE IN ('T','F'));
CREATE DOMAIN VALUE_TF AS CHAR(1)
         DEFAULT 'F';
CREATE DOMAIN VARIABLE_STATUS AS INTEGER;
CREATE DOMAIN VEHICLE_ID AS VARCHAR(8);
CREATE DOMAIN VERSION AS VARCHAR(10);
CREATE DOMAIN VERSION_DATE AS TIMESTAMP;
CREATE DOMAIN VOLUME AS DOUBLE PRECISION;
CREATE DOMAIN WARRANTY_EXPIRY_DATE AS TIMESTAMP;
CREATE DOMAIN WARRANTY_TERM AS VARCHAR(50);
CREATE DOMAIN WEIGHT AS INTEGER;
CREATE DOMAIN WEIGHT_DECIMAL AS DECIMAL(4, 2);
CREATE DOMAIN WEIGHT_DECIMAL3 AS DECIMAL(4, 3);
CREATE DOMAIN WH_ID AS CHAR(2);
CREATE DOMAIN WH_VAR AS VARCHAR(2);
CREATE DOMAIN WIDTH AS DOUBLE PRECISION;
CREATE DOMAIN WORK_DATE AS TIMESTAMP;
CREATE DOMAIN WORK_YEAR AS INTEGER;
CREATE DOMAIN YEAR AS VARCHAR(4);

/* Table: ACCESS_COMPANY, Owner: SYSDBA */
CREATE TABLE ACCESS_COMPANY (USER_ID USER_ID NOT NULL,
        COMPANY_ID COMPANY NOT NULL,
        ACCESS_LEVEL ACCESS_LEVEL NOT NULL,
        EDITABLE EDITABLE,
        CREATE_DATE CREATE_DATE,
        CREATED_BY USER_ID,
PRIMARY KEY (USER_ID, COMPANY_ID));

/* Table: ACCESS_USER, Owner: SYSDBA */
CREATE TABLE ACCESS_USER (USER_ID USER_ID NOT NULL,
        WH_ID WH_ID NOT NULL,
        ACCESS_LEVEL ACCESS_LEVEL NOT NULL,
        EDITABLE EDITABLE,
        CREATE_DATE CREATE_DATE,
        CREATED_BY USER_ID,
PRIMARY KEY (USER_ID, WH_ID));

/* Table: ACCOUNT_PERIODS, Owner: SYSDBA */
CREATE TABLE ACCOUNT_PERIODS (PERIOD_KEY PERIOD_KEY NOT NULL,
        PERIOD_YEAR PERIOD_YEAR,
        PERIOD_NO PERIOD_NO,
        START_DATE START_DATE,
        CLOSE_DATE CLOSE_DATE,
        NAME NAME,
        CLOSED CLOSED,
        LAST_PERIOD PERIOD_KEY,
        CURRENT_PERIOD PERIOD_KEY,
CONSTRAINT ACCOUNT_PERIODS_PX PRIMARY KEY (PERIOD_KEY));

/* Table: AISLES, Owner: SYSDBA */
CREATE TABLE AISLES (WH_ID WH_ID NOT NULL,
        AISLE_SEQ CODE_TWO NOT NULL,
        NAME NAME,
PRIMARY KEY (WH_ID, AISLE_SEQ));

/* Table: ARCHIVE_LAYOUT, Owner: SYSDBA */
CREATE TABLE ARCHIVE_LAYOUT (SEQUENCE INTEGER DEFAULT 1,
        ARCHIVE_TABLE CODE NOT NULL,
        ARCHIVE_FIELD CODE,
        ARCHIVE_METHOD STATUS,
        ARCHIVE_STATUS STATUS,
        ARCHIVE_QUERY VARCHAR(1024),
        ARCHIVE_DAYS INTEGER);

/* Table: AUDIT_CODE, Owner: SYSDBA */
CREATE TABLE AUDIT_CODE (CODE AUDITED NOT NULL,
        DESCRIPTION DESCRIPTION,
        COLOUR CODE,
PRIMARY KEY (CODE));

/* Table: BARCODE_CODES, Owner: SYSDBA */
CREATE TABLE BARCODE_CODES (RECORD_ID INTEGER NOT NULL,
        BARCODE_CODE CODE_255,
        ITEM_COUNT INTEGER,
        DATE_ADD CODE,
PRIMARY KEY (RECORD_ID));

/* Table: BAYS, Owner: SYSDBA */
CREATE TABLE BAYS (AISLE_SEQ CODE_TWO NOT NULL,
        BAY_SEQ CODE_TWO NOT NULL,
        NAME NAME,
PRIMARY KEY (AISLE_SEQ, BAY_SEQ));

/* Table: BRAND, Owner: SYSDBA */
CREATE TABLE BRAND (CODE CODE NOT NULL,
        DESCRIPTION DESCRIPTION,
        LEGACY_CODE LEGACY_CODE,
PRIMARY KEY (CODE));

/* Table: CARDTEXT, Owner: SYSDBA */
CREATE TABLE CARDTEXT (CODE CODE NOT NULL,
        DESCRIPTION VARCHAR(1024),
PRIMARY KEY (CODE));

/* Table: CARRIER, Owner: SYSDBA */
CREATE TABLE CARRIER (CARRIER_ID DESPATCH_CARRIER NOT NULL,
        PREFIX VARCHAR(5),
        ACCOUNT CARRIER_ACCOUNT_NO,
        FILE_EXT VARCHAR(4),
        FTP_IP_ADDRESS IP_ADDRESS,
        FTP_USER CODE,
        FTP_DIRECTORY DESCR,
        START_NO START_NO,
        END_NO END_NO,
        PALLET_LABEL_QTY QTY,
        CARTON_LABEL_QTY QTY,
        SATCHEL_LABEL_QTY QTY,
        FTP_PASSWORD CODE,
        TRN_TYPE TRN_TYPE,
        DISPLAY_BUTTON VALUE_TF,
        CARRIER_LOGO COMPANY_LOGO,
        DEFAULT_CONNOTE_ISSO VALUE_TF,
        LABEL_NUMBER_BASE INTEGER default 10,
        PALLET_LABEL_PRN_TYPE CODE,
        SATCHEL_LABEL_PRN_TYPE CODE,
        CARTON_LABEL_PRN_TYPE CODE,
        UOM_DT CODE_TWO,
        UOM_WT CODE_TWO,
        CONNOTE_PREFIX VARCHAR(15),
        CONNOTE_SUFFIX VARCHAR(15),
        CONNOTE_ACCOUNT CARRIER_ACCOUNT_NO,
        CONNOTE_START_NO START_NO,
        CONNOTE_END_NO END_NO,
        CONNOTE_NUMBER_BASE INTEGER default 10,
        CONNOTE_PRN_TYPE CODE,
        CONNOTE_GENERATOR CODE,
        CONNOTE_PARAM_ID CODE,
        CONNOTE_CHECK_DIGIT_METHOD CODE,
        NOT_LAST_PACK_INDICATOR CODE_TWO_VAR,
        LAST_PACK_INDICATOR CODE_TWO_VAR,
        DEFAULT_SERVICE_TYPE CODE_6,
        FTP_MANIFEST_GENERATOR CODE,
        FTP_ID_GENERATOR CODE,
        CONNOTE_FTP_GENERATOR CODE,
        POST_CODE_DEPOT_ID DEPOT_ID,
        FTP_MANIFEST_START_NO START_NO,
        FTP_MANIFEST_END_NO END_NO,
        FTP_MANIFEST_PREFIX CODE_6,
PRIMARY KEY (CARRIER_ID));

/* Table: CARRIER_SERVICE, Owner: SYSDBA */
CREATE TABLE CARRIER_SERVICE (CARRIER_ID DESPATCH_CARRIER NOT NULL,
        SERVICE_TYPE SERVICE_TYPE,
        DESCRIPTION DESCRIPTION,
        SERVICE_SERVICE_CODE PERSON,
        CS_LABEL_TYPE CODE,
        SERVICE_SIGNATURE_REQD VALUE_TF,
        SERVICE_MULTIPART_CONSIGNMENT VALUE_TF,
        SERVICE_PARTIAL_DELIVERY VALUE_TF,
        SERVICE_CASH_TO_COLLECT VALUE_TF,
        SERVICE_PROFILE_ID PERSON,
        SERVICE_CHARGE_CODES PERSON,
        SERVICE_LOCATION_ID LOCN_ID,
        LAST_UPDATE_DATE LAST_UPDATE_DATE,
        RECORD_ID RECORD_ID NOT NULL,
        SERVICE_TRANSIT_COVER_REQD VALUE_TF,
        SERVICE_TRANSIT_COVER_AMOUNT DOUBLE PRECISION,
        CS_MANIFEST_NAME CODE,
CONSTRAINT CARRIER_SERVICE_PRIMARY PRIMARY KEY (RECORD_ID));

/* Table: CHART_OF_ACCOUNTS, Owner: SYSDBA */
CREATE TABLE CHART_OF_ACCOUNTS (RECORD_ID INTEGER NOT NULL,
        CODE CODE,
        DESCRIPTION DESCRIPTION,
        COMPANY_ID COMPANY,
PRIMARY KEY (RECORD_ID));

/* Table: COMPANY, Owner: SYSDBA */
CREATE TABLE COMPANY (COMPANY_ID COMPANY NOT NULL,
        ADDRESS1 ADDRESS_LINE,
        ADDRESS2 ADDRESS_LINE,
        ADDRESS3 ADDRESS_LINE,
        ACN ACN,
        ABN ABN,
        URL URL,
        EMAIL EMAIL,
        FAX_NO FAX_NO,
        PHONE_NO PHONE_NO,
        NAME VARCHAR(50),
        INV_TEXT1 VARCHAR(255),
        INV_TEXT2 VARCHAR(255),
        BANK_ID_NO1 PERSON,
        BANK_ID_NO2 PERSON,
        BANK_BSB_TITLE1 VARCHAR(20),
        BANK_BSB_NO1 VARCHAR(30),
        BANK_AC_TITLE1 VARCHAR(20),
        BANK_ACCOUNT_1 VARCHAR(50),
        BANK_BSB_TITLE2 VARCHAR(20),
        BANK_BSB_NO2 VARCHAR(30),
        BANK_AC_TITLE2 VARCHAR(20),
        BANK_ACCOUNT_2 VARCHAR(50),
        CREDIT_TO_TITLE1 VARCHAR(20),
        CREDIT_TO_NAME1 VARCHAR(50),
        CREDIT_TO_TITLE2 VARCHAR(20),
        CREDIT_TO_NAME2 VARCHAR(50),
        COMPANY_UDF11 VARCHAR(50),
        COMPANY_UDF12 VARCHAR(50),
        COMPANY_UDF21 VARCHAR(50),
        COMPANY_UDF22 VARCHAR(50),
        BPAY_LOGO IMAGE,
        BPAY_BILLER_CODE VARCHAR(50),
        BPAY_INSTRUCTIONS VARCHAR(100),
        COMPANY_ID_PREFIX VARCHAR(2),
        SEND_STAV VALUE_TF default 'T',
        LEGACY_SYS_ADMIN_EMAIL DESCR,
        GS1_COMPANY_ID VARCHAR(10),
        LEGACY_INTERNAL_ID INTEGER,
        LEGACY_NAME DESCRIPTION,
        MINDER_WH_ID DESCRIPTION,
        COMPANY_LOGO COMPANY_LOGO,
PRIMARY KEY (COMPANY_ID));

/* Table: COMPARTMENTS, Owner: SYSDBA */
CREATE TABLE COMPARTMENTS (SHELF_SEQ CODE_TWO NOT NULL,
        COMPARTMENT_SEQ CODE_TWO NOT NULL,
        NAME NAME,
PRIMARY KEY (SHELF_SEQ, COMPARTMENT_SEQ));

/* Table: CONTROL, Owner: SYSDBA */
CREATE TABLE CONTROL (RECORD_ID RECORD_ID NOT NULL,
        LAST_BC_NUMBER LAST_BC_NUMBER,
        COMPANY_NAME1 COMPANY_NAME,
        COMPANY_NAME2 COMPANY_NAME,
        SYSTEM_DATE SYSTEM_DATE,
        WORK_DATE WORK_DATE,
        EOY_DATE EOY_DATE,
        WORK_YEAR WORK_YEAR,
        ACCOUNTING_PERIODS ACCOUNTING_PERIODS,
        LAST_PURCHASE_ORDER LAST_PURCHASE_ORDER,
        LAST_SSN_ID LAST_SSN_ID,
        AUTO_ALOC_PURCHASE_ORDER AUTO_ALOC_PURCHASE_ORDER,
        AUTO_ALOC_SSN AUTO_ALOC_SSN,
        SSN_REC_ID SSN_REC_ID,
        OBJECT_REC_ID OBJECT_REC_ID,
        DB_VERSION DB_VERSION,
        LAST_LOAD_NO LAST_LOAD_NO,
        DEFAULT_TRANS_REFERENCE REFERENCE,
        MAN_TYPE MAN_TYPE,
        MAN_GENERIC MAN_GENERIC,
        MAN_BRAND MAN_BRAND,
        MAN_MODEL MAN_MODEL,
        MAN_COST_CENTER MAN_COST_CENTER,
        MAN_SERIAL_NUMBER MAN_SERIAL_NUMBER,
        COMPANY_LOGO COMPANY_LOGO,
        HANDHELD_GENERIC_CODE GENERIC  DEFAULT "HANDHELD",
        USER_DEFINED_1_LEGACY_CODE LEGACY_CODE_TWO,
        USER_DEFINED_2_LEGACY_CODE LEGACY_CODE_TWO,
        USER_DEFINED_3_LEGACY_CODE LEGACY_CODE_TWO,
        PRINTER_GENERIC_CODE GENERIC  default "PRINTER",
        PICK_ALLOCATE_QTY QTY,
        FTP_DIRECTORY DESCR,
        LOAD_PREFIX CHAR(3),
        PICK_IMPORT_SSN_STATUS CODE,
        FORM_NO_PREFIX VARCHAR(8),
        EMPLOYEE_FTP_DIRECTORY VARCHAR(80),
        LOAN_PERIOD_NO_1 INTEGER,
        LOAN_PERIOD_NO_2 INTEGER,
        NEW_SSN_STATUS STATUS,
        DEFAULT_WARRANTY WARRANTY_TERM,
        PICK_RESERVED_SSN_STATUS VARCHAR(40),
        DEFAULT_DESPATCH_PRINTER DEVICE_ID  DEFAULT 'PC',
        PICK_WIP_ORDER_METHOD CHAR(4),
        DEFAULT_PICK_PRIORITY SMALLINT,
        PICK_WIP_ITEM_PRELOCN_METHOD CHAR(4),
        PICK_WIP_ITEM_POSTLOCN_METHOD CHAR(4),
        ALLOW_SSN_SUBSTITUTE_DEFAULT CODE_ONE,
        COMPANY_ID COMPANY,
        DEFAULT_WH_ID WH_ID,
        DEFAULT_PRICE PURCHASE_PRICE,
        LICENSE_NO VARCHAR(40),
        NEW_PROD_STATUS STATUS,
        DEFAULT_CONNOTE_PACK CHAR(1) DEFAULT 'C',
        ASSEMBLE_DESPATCH VALUE_TF,
        ORDER_UPDATE CODE_255,
        DEFAULT_CONNOTE_WEIGHT WEIGHT  DEFAULT  1,
        DEFAULT_CONNOTE_QTY_LABELS QTY  DEFAULT  0,
        MAX_PICK_ORDERS INTEGER DEFAULT 1,
        MAX_PICK_PRODUCTS INTEGER DEFAULT  1,
        DEFAULT_DESPATCH_LOCATION LOCN_ID,
        DEFAULT_PICK_PRINTER CHAR(2) default 'PD',
        DEFAULT_TERM VARCHAR(20),
        DEFAULT_PAYMENT_METHOD VARCHAR(20),
        DEFAULT_CARRIER_ID DESPATCH_CARRIER,
        MOVEMENT_TRANS VARCHAR(255),
        DEFAULT_PROD_TYPE DESCRIPTION,
        DEFAULT_RECEIVE_WEIGHTS VALUE_TF,
        DEFAULT_AUTO_DSDX VALUE_TF,
        DEFAULT_DESPATCH_LOC_ORD CHAR(1),
        LEGACY_NAME CODE,
        LEGACY_NAME2 CODE,
        PICK_METHOD CODE,
        DEFAULT_CONNOTE_PACK_QTY INTEGER,
        TEST_FAIL_STATUS CHAR(2),
        PUTAWAY_METHOD CODE,
        TEST_FROM_ALLOWED_SSN_STATUS CODE,
        PICK_UNPICKED_ITEM_STATUS CODE,
        SEND_UCIS_V4 VALUE_TF,
        SEND_UASL_V4 VALUE_TF,
        NEW_LABEL_LOCN_ID LOCN_ID,
        LEGACY_URL VARCHAR(100),
        LEGACY_URL2 VARCHAR(100),
        SEND_DSDX VALUE_TF,
        ACTIVITY_TRANS CODE_255,
        DEFAULT_ISSUE_FROM_LOCATION LOCN_ID,
        PICK_CANCEL_SSN_STATUS CHAR(2),
        IMPORT_SSN_AUTO_UPDATE VALUE_TF,
        EXPORT_TRIL_W VALUE_TF,
        EXPORT_PUTAWAY_PRINTER DEVICE_ID,
        ARCHIVE_WH_ID WH_ID,
        LAST_MIRROR_DATE TIMESTAMP,
        ALLOW_UNPICK_IN_PICK_CANCEL VALUE_TF,
        WARN_PICK_PRIORITY INTEGER,
        DEFAULT_WEIGHT_UNDER PERCENT,
        DEFAULT_WEIGHT_OVER PERCENT,
        DEFAULT_PROD_STOCK CHAR(1),
        PROD_STOCK_OK CODE,
        DEFAULT_GST_RATE DOUBLE PRECISION,
        MAX_PICK_LINES INTEGER default 1,
        PALLET_BASE_PROD_TYPE CODE_TWO,
        PICK_ORDER_MAX_WEIGHT WEIGHT_DECIMAL,
        PICK_IMPORT_CALC_ZONE_LOCN VALUE_TF,
        SEND_SO_CANCEL VALUE_TF,
        EXPORT_SO_HELD_PRINTER DEVICE_ID,
        EXPORT_SO_CANCEL_PRINTER DEVICE_ID,
        ALLOW_HANDHELD_SSN_NOTES CHAR(1),
        EXPORT_DESPATCH CHAR(1),
        EXPORT_DESPATCH_PRINTER CHAR(2),
        CHECK_APPROVED_LINES CODE_ONE,
        SEND_PKUA CHAR(1),
        TRANSFER_PROD_TO_METHOD CODE,
        REPLENISH_METHOD CODE,
        PICK_ORDER_WEIGHT_CALC CHAR(1),
        SSN_ID_BY_LOT_LINE CHAR(1),
        OLD_PICK_METHOD CODE,
        GENERATE_SSN_METHOD VARCHAR(25),
        IMPORTED_ORDERS VARCHAR(40),
        DEFAULT_RECEIVE_PRINTER DEVICE_ID DEFAULT 'PA',
        GENERATE_LABEL_TEXT VALUE_TF,
        DEFAULT_GRN_LABELS INTEGER NOT NULL,
        SEND_AUOB VALUE_TF,
        STOCK_ADJUST_CONFIRM VALUE_TF,
        RETURN_GENERATES_CREDIT VALUE_TF,
        ADD_ISSN_PREFIX VALUE_TF,
        RECEIVE_METHOD DESCRIPTION,
        DEFAULT_PURCHASE_STATUS CODE,
        DEFAULT_PURCHASE_TYPE CODE,
        PICK_DETAIL_DSDX_STATUS CODE,
        STOCKTAKE_METHOD DESCR,
        LEGACY_DB_ACCOUNT CODE,
        SSN_EQ_ISSN_NO VALUE_TF,
        CONFIRM_WITH_NO_PROD VALUE_TF,
        LEGACY_TRYS INTEGER,
        PICK_ORDER_METHOD CODE,
        PICK_CANCEL_PK_STATUS CODE,
        PO_RECEIVE_BY_1_USER VALUE_TF,
        LABEL_FIELD_WRAPPER CHAR(1) default '%',
        DESCRIPTION_METHOD CODE,
        EXTERNAL_SCRIPT_4_LABEL VALUE_TF,
        ALLOW_SOAP_GET_ORDER VALUE_TF,
        TEST_METHOD CODE,
        DESPATCH_METHOD CODE_255,
        PRINTER_METHOD DESCR,
        TRANSFER_METHOD DESCR,
        CAN_GET_ORDER_PICK_STATUS CODE,
        PICK_TRANSFER_STATUS CODE,
        LIMIT_COMPANY_ID VALUE_TF,
        LIMIT_WH_ID VALUE_TF,
        MINDER_VARIANT CODE,
        WHM_VARIANT CODE,
        DEFAULT_DUE_DATE_DAYS DUE_DATE_DAYS,
        DEFAULT_SSN_MARKUP_PERCENT PERCENT_F,
        DEFAULT_PICK_ORDER_STATUS STATUS,
        LEGACY_LEDGER_ACCOUNTS VALUE_TF,
        DEFAULT_EQUIP_LOCN_ID LOCN_ID,
        DEFAULT_SHIPPING_METHOD CARRIER_ACCOUNT_NO,
        PURCHASE_SHIPPING_METHOD CARRIER_ACCOUNT_NO,
        USE_INVOICE VALUE_TF,
        PICK_TROLLEY_PRODUCT_BY VARCHAR(10),
        PICK_TROLLEY_SHOW_FIELDS CODE,
        EXPORT_DESPATCH_METHOD CODE,
        SEND_PRCL_V4 VALUE_TF,
        SEND_GCNA_V4 VALUE_TF,
        SYSTEM_TYPE CODE_6,
        PICK_IMPORT_PROD_STATUS STATUS,
        REIMPORT_PICK_BY_PRIORITY VALUE_TF,
CONSTRAINT CONTROL_PX PRIMARY KEY (RECORD_ID));

/* Table: COST_CENTRE, Owner: SYSDBA */
CREATE TABLE COST_CENTRE (CODE CODE NOT NULL,
        DESCRIPTION DESCRIPTION,
PRIMARY KEY (CODE));

/* Table: DATA_COLLECTION, Owner: SYSDBA */
CREATE TABLE DATA_COLLECTION (HEADER HEADER NOT NULL,
        ITEM_CODE ITEM_CODE NOT NULL,
        FIELD1 FIELD,
        FIELD2 FIELD,
        FIELD3 FIELD,
        FIELD4 FIELD,
        FIELD5 FIELD,
        FIELD6 FIELD,
        FIELD7 FIELD,
        FIELD8 FIELD,
        FIELD9 FIELD,
        FIELD10 FIELD,
CONSTRAINT DATA_COLLECTION_PX PRIMARY KEY (HEADER, ITEM_CODE));

/* Table: DATA_COLLECT_HEADER, Owner: SYSDBA */
CREATE TABLE DATA_COLLECT_HEADER (HEADER HEADER NOT NULL,
        FIELD1 FIELD,
        FIELD2 FIELD,
        FIELD3 FIELD,
        FIELD4 FIELD,
        FIELD5 FIELD,
        FIELD6 FIELD,
        FIELD7 FIELD,
        FIELD8 FIELD,
        FIELD9 FIELD,
        FIELD10 FIELD,
        DESCRIPTION DESCRIPTION,
CONSTRAINT DATA_COLLECT_HEADER_PX PRIMARY KEY (HEADER));

/* Table: DEPARTMENT, Owner: SYSDBA */
CREATE TABLE DEPARTMENT (CODE CODE NOT NULL,
        DESCRIPTION DESCRIPTION,
PRIMARY KEY (CODE));

/* Table: DEPRECIATION, Owner: SYSDBA */
CREATE TABLE DEPRECIATION (SSN_ID SSN_ID,
        PERIOD_KEY PERIOD_KEY,
        YEAR YEAR,
        PERIOD_NO PERIOD_NO,
        PERIOD_NAME PERIOD_NAME,
        CLOSING_VALUE CLOSING_VALUE,
        DEPRECIATED_VALUE DEPRECIATED_VALUE,
        CLOSING_DATE CLOSING_DATE,
        METHOD_NAME METHOD_NAME,
        METHOD METHOD_CODE10,
        CLOSE_METHOD METHOD_CODE10);

/* Table: DEP_METHODS, Owner: SYSDBA */
CREATE TABLE DEP_METHODS (NAME NAME,
        DEPRECIATION_RATE DEPRECIATION_RATE,
        LOWEST_LIMIT LOWEST_LIMIT,
        USE_RATE CHAR(1),
        DEPRECIATION_YEAR NUMERIC(4, 2),
        METHOD METHOD_CODE10,
        METHOD_CODE METHOD_CODE10 NOT NULL,
CONSTRAINT DEP_METHODS_PX PRIMARY KEY (METHOD_CODE));

/* Table: DESCRIPTION_LAYOUT, Owner: SYSDBA */
CREATE TABLE DESCRIPTION_LAYOUT (CODE CODE NOT NULL,
        DESCRIPTION DESCRIPTION,
        SEQUENCE SEQUENCE_NO,
PRIMARY KEY (CODE));

/* Table: DIVISION, Owner: SYSDBA */
CREATE TABLE DIVISION (CODE CODE NOT NULL,
        DESCRIPTION DESCRIPTION,
PRIMARY KEY (CODE));

/* Table: EMPLOYEE, Owner: SYSDBA */
CREATE TABLE EMPLOYEE (EMPLOYEE_ID PERSON NOT NULL,
        PROJECT_ID VARCHAR(10),
        STATUS STATUS,
        INDUCTION_DATE TIMESTAMP,
        TITLE VARCHAR(5),
        FIRST_NAME VARCHAR(25),
        LAST_NAME VARCHAR(25),
        DOB TIMESTAMP,
        PREFERRED_LANGUAGE VARCHAR(20),
        COMPANY_ID VARCHAR(10),
        EMPLOYEE_TYPE CHAR(2),
        LOCATION VARCHAR(40),
        OCCUPATION VARCHAR(30),
        DRIVER_LIC_NO VARCHAR(20),
        DRIVER_LIC_CLASS VARCHAR(10),
        DRIVER_LIC_STATE VARCHAR(3),
        DRIVER_LIC_EXPIRY_DATE TIMESTAMP,
        ADDRESS_LINE1 ADDRESS_LINE,
        ADDRESS_LINE2 ADDRESS_LINE,
        CITY CITY,
        STATE STATE,
        POST_CODE POST_CODE,
        COUNTRY COUNTRY,
        PHONE_NO PHONE_NO,
        FAX_NO FAX_NO,
        MOBILE_NO MOBILE_NO,
        EMAIL EMAIL,
        MAIL_ADDRESS1 ADDRESS_LINE,
        MAIL_ADDRESS2 ADDRESS_LINE,
        MAIL_CITY CITY,
        MAIL_STATE STATE,
        MAIL_POST_CODE POST_CODE,
        MAIL_COUNTRY COUNTRY,
        MAIL_PHONE PHONE_NO,
        CONTACT_FIRST_NAME CONTACT_FIRST_NAME,
        CONTACT_LAST_NAME CONTACT_LAST_NAME,
        CONTACT_ADDRESS1 ADDRESS_LINE,
        CONTACT_ADDRESS2 ADDRESS_LINE,
        CONTACT_CITY CITY,
        CONTACT_STATE STATE,
        CONTACT_POST_CODE POST_CODE,
        CONTACT_COUNTRY COUNTRY,
        CONTACT_PHONE PHONE_NO,
        EMP_UDF1 VARCHAR(50),
        EMP_UDF2 VARCHAR(50),
        EMP_UDF3 VARCHAR(50),
        EMP_UDF4 VARCHAR(50),
        EMP_UDF5 VARCHAR(50),
        EMP_UDF6 VARCHAR(50),
        EMP_UDF7 VARCHAR(50),
        EMP_UDF8 TIMESTAMP,
        EMP_UDF9 VARCHAR(50),
        EMP_UDF10 TIMESTAMP,
        SUPER_FUND_NO VARCHAR(20),
        SUPER_FUND_NAME VARCHAR(50),
        CREATE_DATE CREATE_DATE,
        CREATE_BY PERSON,
        INDUCTION_FORM_NO VARCHAR(8),
        KIT_ID PRODUCT,
        UPDATE_DATE CREATE_DATE,
        UPDATE_BY USER_ID,
        GENDER CHAR(1),
        COMPULSORY_SKILL CHAR(1),
        UNION_MEMBERSHIP CODE,
        UNION_MEMBERSHIP_NO UNION_MEMBERSHIP_NO,
        NOTES DISPOSAL_NOTES,
PRIMARY KEY (EMPLOYEE_ID));

/* Table: EMPLOYEE_IMAGE, Owner: FRANKL */
CREATE TABLE EMPLOYEE_IMAGE (IMAGE_ID IMAGE_NO NOT NULL,
        IMAGE_CAPTURED IMAGE,
        IMAGE_TYPE CHAR(2),
        PERSON_ID PERSON,
        IMAGE_FORMAT VARCHAR(4),
        IMAGE_SOURCE VARCHAR(50),
        IMAGE_TITLE VARCHAR(50),
        CREATE_DATE TIMESTAMP,
        CREATE_BY PERSON,
PRIMARY KEY (IMAGE_ID));

/* Table: EMPLOYEE_ISSUE, Owner: SYSDBA */
CREATE TABLE EMPLOYEE_ISSUE (EMPLOYEE_TYPE CODE_TWO NOT NULL,
        KIT_ID PRODUCT NOT NULL,
PRIMARY KEY (EMPLOYEE_TYPE, KIT_ID));

/* Table: EMPLOYEE_SKILL, Owner: SYSDBA */
CREATE TABLE EMPLOYEE_SKILL (EMPLOYEE_ID PERSON NOT NULL,
        SKILL_CODE VARCHAR(10) NOT NULL,
        TRAINING_DATE TIMESTAMP,
        TRAINING_BY PERSON,
        TRAINING_LOCATION VARCHAR(40),
        TRAINING_AUTHORITY VARCHAR(10),
        TRAINING_PASS CHAR(1),
        TRAINING_RESULT VARCHAR(10),
        TRAINING_CERT_PRTD_DATE TIMESTAMP,
        COMPULSORY_SKILL CHAR(1),
PRIMARY KEY (EMPLOYEE_ID, SKILL_CODE));

/* Table: GENERIC, Owner: SYSDBA */
CREATE TABLE GENERIC (CODE CODE NOT NULL,
        DESCRIPTION DESCRIPTION,
        FIELD1 FIELD,
        FIELD2 FIELD,
        FIELD3 FIELD,
        FIELD4 FIELD,
        FIELD5 FIELD,
        LEGACY_CODE LEGACY_CODE,
        SSN_TYPE SSN_TYPE);

/* Table: GLOBAL_CONDITIONS, Owner: SYSDBA */
CREATE TABLE GLOBAL_CONDITIONS (OTHER_NO INTEGER NOT NULL,
        DESCRIPTION VARCHAR(30) NOT NULL,
        RESULT CHAR(1) NOT NULL,
        MATCH_OPERATOR VARCHAR(5),
        LEGACY_CODE LEGACY_CODE,
PRIMARY KEY (OTHER_NO, DESCRIPTION));

/* Table: GRN, Owner: SYSDBA */
CREATE TABLE GRN (GRN GRN NOT NULL,
        GRN_TYPE CODE_TWO,
        TOTAL_QTY_PACKS QTY,
        PACK_EAN_SSCC PACK_EAN_SSCC,
        CARRIER CARRIER,
        VEHICLE_ID VEHICLE_ID,
        AWB_CONSIGNMENT_NO AWB_CONSIGNMENT_NO,
        GRN_PALLET_QTY QTY,
        DELIVERY_DOCKET DELIVERY_DOCKET,
        PALLETS_YN PALLETS_YN,
        CONTAINER_NO CONTAINER_NO,
        COMMENTS COMMENTS,
        GRN_PRINTED GRN_PRINTED,
        USER_ID USER_ID,
        DEVICE_ID DEVICE_ID,
        GRN_DATE GRN_DATE,
        ORDER_NO ORDER_NO,
        ORDER_LINE_NO ORDER_LINE,
        RETURN_ID PERSON,
        SHIPPED_DATE GRN_DATE,
        RECEIPT_FLAG VALUE_TF,
        LAST_UPDATE_DATE LAST_UPDATE_DATE,
        OWNER_ID COMPANY,
        LAST_LINE_NO INTEGER,
        LAST_PALLET_NO INTEGER,
        SHIP_CONTAINER_TYPE CODE_TWO,
        PACK_CRATE_OWNER PERSON,
        PACK_CRATE_TYPE CODE_TWO,
        PACK_CRATE_QTY QTY,
        CONTAINER_TYPE CODE_TWO,
        SHIPPING_CRATE_OWNER CRATE_OWNER,
        SHIPPING_CRATE_TYPE CODE_TWO,
        SHIPPING_CRATE_QTY QTY,
        GRN_DUE_DATE GRN_DATE,
        GRN_STATUS GRN_STATUS,
        GRN_FREIGHT_FORWARDER PERSON,
        GRN_FREIGHT_ACCOUNT_NO FREIGHT_ACCOUNT_NO,
        GRN_LEGACY_INTERNAL_ID VARCHAR(20),
        GRN_LEGACY_MEMO VARCHAR(1024),
        WH_ID WH_ID,
        GRN_POSTING_PERIOD VARCHAR(20),
        LAST_LOT_NO SERIAL_NUMBER,
        VESSEL_NAME DESCR,
        VOYAGE_NO DESCR,
        OTHER1 OTHER_CHAR,
        OTHER2 OTHER_CHAR,
        OTHER3 OTHER_CHAR,
PRIMARY KEY (GRN));

/* Table: GRN_CANCEL, Owner: SYSDBA */
CREATE TABLE GRN_CANCEL (GRN GRN,
        GRN_TYPE CODE_TWO,
        TOTAL_QTY_PACKS QTY,
        PACK_EAN_SSCC PACK_EAN_SSCC,
        CARRIER CARRIER,
        VEHICLE_ID VEHICLE_ID,
        AWB_CONSIGNMENT_NO AWB_CONSIGNMENT_NO,
        GRN_PALLET_QTY QTY,
        DELIVERY_DOCKET DELIVERY_DOCKET,
        PALLETS_YN PALLETS_YN,
        CONTAINER_NO CONTAINER_NO,
        COMMENTS COMMENTS,
        GRN_PRINTED GRN_PRINTED,
        USER_ID USER_ID,
        DEVICE_ID DEVICE_ID,
        GRN_DATE GRN_DATE,
        ORDER_NO ORDER_NO,
        ORDER_LINE_NO ORDER_LINE,
        RETURN_ID PERSON,
        SHIPPED_DATE GRN_DATE,
        RECEIPT_FLAG VALUE_TF,
        LAST_UPDATE_DATE LAST_UPDATE_DATE,
        OWNER_ID COMPANY,
        LAST_LINE_NO INTEGER,
        LAST_PALLET_NO INTEGER,
        SHIP_CONTAINER_TYPE CODE_TWO,
        PACK_CRATE_OWNER PERSON,
        PACK_CRATE_TYPE CODE_TWO,
        PACK_CRATE_QTY QTY,
        CONTAINER_TYPE CODE_TWO,
        SHIPPING_CRATE_OWNER CRATE_OWNER,
        SHIPPING_CRATE_TYPE CODE_TWO,
        SHIPPING_CRATE_QTY QTY,
        GRN_DUE_DATE GRN_DATE,
        GRN_STATUS GRN_STATUS,
        GRN_FREIGHT_FORWARDER PERSON,
        GRN_FREIGHT_ACCOUNT_NO FREIGHT_ACCOUNT_NO,
        REASON VARCHAR(255),
        CANCEL_DATE LAST_UPDATE_DATE,
        CANCEL_METHOD CHAR(1));

/* Table: GRN_ORDER, Owner: SYSDBA */
CREATE TABLE GRN_ORDER (GRN GRN NOT NULL,
        ORDER_NO ORDER_NO NOT NULL,
        GRN_LABEL_NO GRN_LABEL_NO NOT NULL,
        COMPANY_ID COMPANY,
        SUPPLIER_ID PERSON,
        CREATE_DATE CREATE_DATE,
        CREATED_BY USER_ID,
        LOT_NO LOT_NO,
        LOT_LINE_NO LOT_LINE_NO,
        LABEL_EXTENSION CODE_TWO,
        GRN_PARENT_LABEL_ID GRN_LABEL_NO,
CONSTRAINT GRN_ORDER_PRIMARY PRIMARY KEY (GRN_LABEL_NO));

/* Table: GRN_ORDER_CANCEL, Owner: SYSDBA */
CREATE TABLE GRN_ORDER_CANCEL (GRN GRN,
        ORDER_NO ORDER_NO,
        GRN_LABEL_NO GRN_LABEL_NO,
        COMPANY_ID COMPANY,
        SUPPLIER_ID PERSON,
        CREATE_DATE CREATE_DATE,
        CREATED_BY USER_ID,
        LOT_NO LOT_NO,
        LOT_LINE_NO LOT_LINE_NO,
        REASON VARCHAR(255),
        LAST_UPDATE_DATE LAST_UPDATE_DATE,
        CANCEL_METHOD CHAR(1),
        GRN_PARENT_LABEL_ID GRN_LABEL_NO,
        LABEL_EXTENSION CODE_6);

/* Table: GROUP_COPY, Owner: SYSDBA */
CREATE TABLE GROUP_COPY (CODE CODE NOT NULL,
        SSN_TYPE SSN_TYPE,
        GENERIC GENERIC,
        BRAND BRAND,
        MODEL MODEL,
        PROD_ID PRODUCT,
        SUPPLIER_ID SUPPLIER_ID,
        OTHER6 OTHER_CHAR,
        OTHER7 OTHER_CHAR,
        OTHER8 OTHER_CHAR,
        OTHER9 OTHER_CHAR,
        OTHER10 OTHER_CHAR,
        DESCRIPTION DESCRIPTION,
PRIMARY KEY (CODE));

/* Table: IMAGES, Owner: SYSDBA */
CREATE TABLE IMAGES (IMAGE_NO IMAGE_NO NOT NULL,
        IMAGE_LOC IMAGE_LOC,
        IMAGE IMAGE,
        DESCRIPTION DESCRIPTION,
        IMAGE_NAME IMAGE_NAME,
        IMAGE_ID PERSON NOT NULL,
        IMAGE_BLOB IMAGE,
        IMAGE_TYPE CODE_TWO,
        IMAGE_FORMAT IMAGE_FORMAT,
        IMAGE_SOURCE IMAGE_SOURCE,
        IMAGE_DATE IMAGE_DATE,
        CREATED_BY MDR_USER_ID,
CONSTRAINT IMAGES_PX PRIMARY KEY (IMAGE_NO));

/* Table: IMPORT_MAP, Owner: SYSDBA */
CREATE TABLE IMPORT_MAP (RECORD_ID RECORD_ID NOT NULL,
        MAP_TYPE CHAR(1) NOT NULL,
        MAP_IMPORT_FILENAME VARCHAR(50) NOT NULL,
        MAP_IMPORT_SHEET VARCHAR(40) NOT NULL,
        MAP_IMPORT_COL VARCHAR(30) NOT NULL,
        MAP_IMS_TABLE VARCHAR(40) NOT NULL,
        MAP_IMS_FIELDNAME VARCHAR(40) NOT NULL,
        MAP_IMS_FIELDTYPE INTEGER,
        MAP_IMS_FORMAT VARCHAR(40) NOT NULL,
        MAP_IMS_SUFFIX VARCHAR(40),
        MAP_IMS_PREFIX VARCHAR(40),
        MAP_IMS_FIND VARCHAR(40),
        MAP_IMS_REPLACE VARCHAR(40),
        CREATED_BY PERSON,
        CREATED_DATE TIMESTAMP,
        MAP_IMS_DEFAULT VARCHAR(40),
CONSTRAINT RECRD_ID PRIMARY KEY (RECORD_ID));

/* Table: INSP_HIST, Owner: SYSDBA */
CREATE TABLE INSP_HIST (RECORD_ID RECORD_ID NOT NULL,
        SSN_ID SSN_ID NOT NULL,
        STATUS CODE_ONE,
        TYPE_DATE TIMESTAMP,
        TYPE_CODE TYPE_CODE,
        TYPE_HEADER_CODE TYPE_CODE,
        TYPE_LINE_CODE TYPE_CODE,
        DEVICE_ID DEVICE_ID,
        PERSON_ID PERSON,
        DESCRIPTION VARCHAR(100),
PRIMARY KEY (RECORD_ID));

/* Table: ISSN, Owner: SYSDBA */
CREATE TABLE ISSN (SSN_ID SSN_ID NOT NULL,
        ORIGINAL_SSN SSN_ID NOT NULL,
        WH_ID WH_ID,
        LOCN_ID LOCN_ID,
        PREV_LOCN_ID LOCN_ID,
        CURRENT_QTY QTY,
        PREV_QTY QTY,
        PREV_DATE PREV_DATE,
        ISSN_STATUS STATUS,
        STATUS_CODE STATUS_CODE,
        CREATE_DATE CREATE_DATE,
        USER_ID USER_ID,
        PROD_ID PRODUCT,
        INTO_DATE INTO_DATE,
        PREV_WH_ID WH_ID,
        PREV_PREV_LOCN_ID LOCN_ID,
        PREV_PREV_WH_ID WH_ID,
        AUDITED AUDITED,
        PICK_ORDER PICK_ORDER,
        KITTED CHAR(1),
        LABEL_DATE LABEL_DATE,
        ORIGINAL_QTY QTY,
        AUDIT_DATE AUDIT_DATE,
        COMPANY_ID COMPANY,
        DIVISION_ID DIVISION,
        SERIAL_NUMBER SERIAL_NUMBER,
        OTHER1 OTHER_CHAR,
        OTHER2 OTHER_CHAR,
        DESPATCHED_DATE TIMESTAMP,
        LAST_UPDATE_DATE LAST_UPDATE_DATE,
        PREV_PROD_ID PRODUCT,
        PREV_PREV_PROD_ID PRODUCT,
        PROD_ID_UPDATE TIMESTAMP,
        PREV_PROD_ID_UPDATE TIMESTAMP,
        PREV_PREV_PROD_ID_UPDATE TIMESTAMP,
        OTHER3 CODE_255,
        PACK_ID PACK_ID,
        DESPATCH_ID DESPATCH_ID,
        ISSN_PACKAGE_TYPE CODE_TWO,
        ISSN_PREV_PACKAGE_TYPE CODE_TWO,
        PREV_PICK_ORDER PICK_ORDER,
        PREV_PREV_PICK_ORDER PICK_ORDER,
        PREV_PACK_ID PACK_ID,
        PREV_PREV_PACK_ID PACK_ID,
        PREV_DESPATCH_ID DESPATCH_ID,
        PREV_PREV_DESPATCH_ID DESPATCH_ID,
        PICKED_QTY QTY,
        ISSN_DESCRIPTION DESCR,
        OTHER4 OTHER_CHAR,
        ORIGINAL_CREATE_DATE CREATE_DATE,
PRIMARY KEY (SSN_ID));

/* Table: ISSN_PUTAWAY, Owner: SYSDBA */
CREATE TABLE ISSN_PUTAWAY (SSN_ID SSN_ID NOT NULL,
        PUTAWAY_ID SSN_ID NOT NULL,
        CREATE_DATE CREATE_DATE,
        TRN_DATE TRN_DATE,
        DEVICE_ID DEVICE_ID,
        PERSON_ID PERSON);

/* Table: ITEM_CLASS, Owner: SYSDBA */
CREATE TABLE ITEM_CLASS (ITEM_CLASS_CODE CODE_ONE NOT NULL,
        DESCRIPTION DESCRIPTION,
PRIMARY KEY (ITEM_CLASS_CODE));

/* Table: KIT, Owner: SYSDBA */
CREATE TABLE KIT (KIT_ID VARCHAR(30) NOT NULL,
        DESCRIPTION DESCRIPTION,
        CREATED_BY PERSON,
        CREATED_DATE TIMESTAMP,
        UPDATE_ID VARCHAR(10),
        STATUS STATUS,
        KIT_LINE_NO INTEGER,
        TOTAL_LINES INTEGER,
PRIMARY KEY (KIT_ID));

/* Table: LABEL_LOCATION, Owner: SYSDBA */
CREATE TABLE LABEL_LOCATION (CODE CODE_ONE NOT NULL,
        DESCRIPTION DESCRIPTION,
PRIMARY KEY (CODE));

/* Table: LEGACY, Owner: SYSDBA */
CREATE TABLE LEGACY (LEGACY_ID LEGACY_ID NOT NULL,
        LEGACY_DESCRIPTION LEGACY_DESCRIPTION,
        SSN_TYPE SSN_TYPE,
        GENERIC GENERIC,
        BRAND BRAND,
        MODEL MODEL,
        SERIAL_NUMBER SERIAL_NUMBER,
        OTHER1 OTHER_CHAR,
        OTHER2 OTHER_CHAR,
        STATUS STATUS  DEFAULT 'F',
        PURCHASE_DATE PURCHASE_DATE,
        PURCHASE_PRICE PURCHASE_PRICE,
        COMMISSIONED_DATE COMMISSIONED_DATE,
        ACQUISITION_COST ACQUISITION_COST,
        COST_CENTER COST_CENTER,
        WH_ID WH_ID,
        OTHER6 OTHER_CHAR,
        OTHER7 OTHER_CHAR,
        OTHER8 OTHER_CHAR,
        OTHER9 OTHER_CHAR,
        OTHER10 OTHER_CHAR,
        GRN GRN,
        LOAD_NO ORDER_NO,
        LOCN_ID LOCN_ID,
        LEGACY_DESCRIPTION2 LEGACY_DESCRIPTION,
        OTHER3 OTHER_CHAR,
        OTHER4 OTHER_CHAR,
        OTHER5 OTHER_CHAR,
        OTHER11 OTHER_CHAR,
        OTHER12 OTHER_CHAR,
        OTHER13 OTHER_CHAR,
        OTHER14 OTHER_CHAR,
        OTHER15_DATE OTHER_DATE,
        OTHER16_DATE OTHER_DATE,
        OTHER17_QTY QTY,
        OTHER18_QTY QTY,
        OTHER19 OTHER_CHAR,
        OTHER20 OTHER_CHAR,
        DEPRECIATE_METHOD1 METHOD_CODE10,
        DEPRECIATE_METHOD2 METHOD_CODE10,
        DEPRECIATE_METHOD3 METHOD_CODE10,
        DEPRECIATED_VALUE1 DEPRECIATED_VALUE,
        DEPRECIATED_VALUE2 DEPRECIATED_VALUE,
        DEPRECIATED_VALUE3 DEPRECIATED_VALUE,
        ACCUM_DEPREC_VALUE1 DEPRECIATED_VALUE,
        ACCUM_DEPREC_VALUE2 DEPRECIATED_VALUE,
        ACCUM_DEPREC_VALUE3 DEPRECIATED_VALUE,
        DEPRECIATED_RATE1 DEPRECIATION_RATE,
        DEPRECIATED_RATE2 DEPRECIATION_RATE,
        DEPRECIATED_RATE3 DEPRECIATION_RATE,
        PERIOD_KEY PERIOD_KEY,
        PERIOD_NO PERIOD_NO,
        STATUS_CODE STATUS_CODE,
        PERIOD_YEAR PERIOD_YEAR,
        DEP_METHODS_METHOD1 VARCHAR(10),
        DEP_METHODS_METHOD2 VARCHAR(10),
        DEP_METHODS_METHOD3 VARCHAR(10),
PRIMARY KEY (LEGACY_ID));

/* Table: LEGACY_ADJUSTMENT, Owner: SYSDBA */
CREATE TABLE LEGACY_ADJUSTMENT (RECORD_ID INTEGER NOT NULL,
        LA_PROD_ID PRODUCT,
        LA_SSN_ID SSN_ID,
        LA_WH_ID WH_ID,
        LA_LOCN_ID LOCN_ID,
        LA_ADJUST_BY KIT_QTY,
        LA_UOM CODE_TWO,
        LA_UNIT_COST UNIT_PRICE,
        LA_TOTAL_VALUE STANDARD_COST,
        LA_TOTAL_ESTIMATE STANDARD_COST,
        LA_DESCRIPTION LONG_DESC,
        LA_HEADER_NOTES TRN_DATA,
        LA_LINE_NOTES TRN_DATA,
        LA_ACCOUNT_CODE DESCRIPTION,
        LA_ADJ_LOCATION DESCRIPTION,
        LA_ADJ_CLASS DESCRIPTION,
        LA_CUSTOMER DESCRIPTION,
        LA_DEPARTMENT DESCRIPTION,
        LA_EXTERNAL_ID DESCRIPTION,
        LA_INTERNAL_ID DESCRIPTION,
        LA_POSTING_PERIOD DESCRIPTION,
        LA_INVENTORY_LIST DESCRIPTION,
        LA_CREATE_DATE TIMESTAMP,
        LA_COMPANY_ID COMPANY,
        LA_STATUS DESCRIPTION,
        LA_LEGACY_UPDATED TIMESTAMP,
        LA_USER_ID USER_ID,
        LA_DEVICE_ID DEVICE_ID,
        STOCKTAKE_RECORD_ID INTEGER,
PRIMARY KEY (RECORD_ID));

/* Table: LOAN_CHARGE_TO, Owner: SYSDBA */
CREATE TABLE LOAN_CHARGE_TO (CODE CODE NOT NULL,
        DESCRIPTION DESCRIPTION,
        CHARGE_TO_TYPE CODE_TWO,
        CHARGE_TO_WHOM CHARGE_TO,
        STATUS STATUS,
PRIMARY KEY (CODE));

/* Table: LOAN_HISTORY, Owner: SYSDBA */
CREATE TABLE LOAN_HISTORY (LOAN_ORDER_NO INTEGER NOT NULL,
        LOAN_ORDER_LINE_NO INTEGER NOT NULL,
        SSN_ID SSN_ID NOT NULL,
        PERSON_ID PERSON,
        PROD_ID PRODUCT,
        LOAN_TYPE CODE_TWO,
        STATUS VARCHAR(2),
        LOAN_QTY QTY,
        LOAN_RETURNED_QTY QTY,
        LOAN_CHARGE_UOM CODE_TWO,
        LOAN_CHARGE_RATE CHARGE_RATE,
        LOAN_DATE TIMESTAMP,
        DUE_DATE TIMESTAMP,
        RETURN_DATE TIMESTAMP,
        LOAN_ACTUAL_CHARGE_UNITS LOAN_ACTUAL_CHARGE_UNITS,
        CHARGE_TO CHARGE_TO,
        COMMENTS COMMENTS,
        DEVICE_ID DEVICE_ID,
        OPERATOR PERSON,
        COMPANY_ID COMPANY,
PRIMARY KEY (LOAN_ORDER_NO, LOAN_ORDER_LINE_NO, SSN_ID));

/* Table: LOAN_ORDER, Owner: SYSDBA */
CREATE TABLE LOAN_ORDER (LOAN_ORDER_NO INTEGER NOT NULL,
        PERSON_ID PERSON,
        LOAN_ORDER_DATE LOAN_ORDER_DATE  DEFAULT 'NOW',
        STATUS STATUS,
        JOB_NO VARCHAR(20),
        CHARGE_TO CHARGE_TO,
        COMMENTS COMMENTS,
        USER_ID USER_ID,
        LOAN_TYPE CODE_TWO,
        RETURN_DATE DATETIME,
        PICK_ORDER PICK_ORDER,
        LOAN_DUE_DATE DATETIME,
        LOAN_PICK_DUE_DATE LOAN_DUE_RETURN,
PRIMARY KEY (LOAN_ORDER_NO));

/* Table: LOAN_ORDER_LINE, Owner: SYSDBA */
CREATE TABLE LOAN_ORDER_LINE (LOAN_ORDER_NO INTEGER NOT NULL,
        LOAN_ORDER_LINE_NO INTEGER NOT NULL,
        SSN_ID SSN_ID NOT NULL,
        STATUS STATUS  DEFAULT 'L',
        PROD_ID PRODUCT,
        LOAN_QTY QTY,
        LOAN_TYPE CODE_TWO,
        LOAN_CHARGE_UOM CODE_TWO,
        LOAN_CHARGE_RATE CHARGE_RATE,
        LOAN_DUE_DATE TIMESTAMP,
        LOAN_RETURN_DATE TIMESTAMP,
        CHARGE_TO CHARGE_TO,
        COMMENTS COMMENTS,
        LOAN_SSN_COST PURCHASE_PRICE,
PRIMARY KEY (LOAN_ORDER_NO, LOAN_ORDER_LINE_NO));

/* Table: LOAN_RATE, Owner: SYSDBA */
CREATE TABLE LOAN_RATE (RECORD_ID RECORD_ID NOT NULL,
        LR_COMPANY_ID COMPANY NOT NULL,
        LR_SSN_TYPE CODE NOT NULL,
        LR_APPLIED_TO CODE,
        LR_DAY PERCENT_F,
        LR_WEEK PERCENT_F,
        LR_MONTH PERCENT_F,
        LR_QUARTER PERCENT_F,
        LR_ANNUAL PERCENT_F,
        LR_REPLACEMENT PERCENT_F,
PRIMARY KEY (RECORD_ID));

/* Table: LOCATION, Owner: SYSDBA */
CREATE TABLE LOCATION (WH_ID WH_ID NOT NULL,
        LOCN_ID LOCN_ID NOT NULL,
        LOCN_NAME LOCN_NAME,
        LOCN_METRIC CODE_TWO,
        LOCN_HGHT HEIGHT,
        PARENT_LOCN_ID LOCN_ID,
        ZONE_C CODE_TWO,
        CC_C CC_C,
        TOG_C CODE_TWO,
        LOCN_STAT CODE_TWO,
        MOVE_STAT CODE_TWO,
        REPLENISH REPLENISH,
        PACK_T PACK_T,
        STORE_TYPE CODE_TWO,
        STORE_AREA CODE_TWO,
        STORE_METH CODE_TWO,
        PERM_LEVEL PERM_LEVEL,
        LABEL_DATE LABEL_DATE,
        LAST_AUDITED_DATE LAST_AUDITED_DATE,
        PROD_ID PRODUCT,
        INSTANCE_ID INSTANCE_ID,
        MAX_QTY QTY,
        MIN_QTY QTY,
        REORDER_QTY QTY,
        AISLE_SEQ CODE_TWO,
        BAY_SEQ CODE_TWO,
        SHELF_SEQ CODE_TWO,
        COMPARTMENT_SEQ CODE_TWO,
        LAST_UPDATE_DATE LAST_UPDATE_DATE,
        LAST_UPDATE_BY USER_ID,
        PUTAWAY_QTY INTEGER,
        LOCN_OWNER LOCN_ID,
        CURRENT_WH_ID WH_ID,
        MOVEABLE_LOCN VALUE_TF,
        SSN_TRACK SSN_TRACK,
        LOCN_SEQ LOCN_SEQ,
        TEMPERATURE_ZONE CODE_TWO,
        LOCN_TARE_WEIGHT NUMERIC(9, 3),
        LOCN_TARE_WEIGHT_UOM CODE_TWO,
        LOCN_INT_DIMENSION_X NUMERIC(9, 3),
        LOCN_INT_DIMENSION_Y NUMERIC(9, 3),
        LOCN_INT_DIMENSION_Z NUMERIC(9, 3),
        LOCN_DIMENSION_UOM CODE_TWO,
        LOCN_OUT_DIMENSION_X NUMERIC(9, 3),
        LOCN_OUT_DIMENSION_Y NUMERIC(9, 3),
        LOCN_OUT_DIMENSION_Z NUMERIC(9, 3),
        LOCN_TYPE CODE,
        LABEL_DIRECTION VALUE_TF,
        LABEL_SIDE VALUE_TF,
        MARK_DATE LAST_UPDATE_DATE,
        MARK_BY USER_ID,
PRIMARY KEY (WH_ID, LOCN_ID));

/* Table: LOCN_ADDRESS, Owner: SYSDBA */
CREATE TABLE LOCN_ADDRESS (LOCN_ID LOCN_ID NOT NULL,
        ADDRESS1 ADDRESS_LINE,
        ADDRESS2 ADDRESS_LINE,
        ADDRESS3 ADDRESS_LINE,
        ADDRESS4 ADDRESS_LINE,
        CONTACT CONTACT,
        PHONE_NO PHONE_NO,
PRIMARY KEY (LOCN_ID));

/* Table: LOCN_STATUS, Owner: SYSDBA */
CREATE TABLE LOCN_STATUS (CODE CODE_TWO NOT NULL,
        DESCRIPTION DESCRIPTION,
PRIMARY KEY (CODE));

/* Table: LOG, Owner: SYSDBA */
CREATE TABLE LOG (SEQ INTEGER,
        DESCRIPTION VARCHAR(1024),
        CREATE_DATE TIMESTAMP);

/* Table: METRICS, Owner: SYSDBA */
CREATE TABLE METRICS (CODE CODE_TWO NOT NULL,
        DESCRIPTION DESCRIPTION,
        DEPTH DEPTH,
        WIDTH WIDTH,
        HEIGHT HEIGHT,
        MAX_WEIGHT WEIGHT,
        AISLE_WIDT WIDTH,
        STORE_METH CODE_TWO,
PRIMARY KEY (CODE));

/* Table: MODEL, Owner: SYSDBA */
CREATE TABLE MODEL (CODE CODE NOT NULL,
        DESCRIPTION DESCRIPTION,
        LEGACY_CODE LEGACY_CODE,
PRIMARY KEY (CODE));

/* Table: MODULE, Owner: SYSDBA */
CREATE TABLE MODULE (MODULE_ID CHAR(2) NOT NULL,
        MODULE_SUB_TYPE CHAR(2) NOT NULL,
        DESCRIPTION DESCRIPTION,
        LICENSE_NO CODE,
        ENABLED VALUE_TF,
PRIMARY KEY (MODULE_ID, MODULE_SUB_TYPE));

/* Table: MOVE_STATUS, Owner: SYSDBA */
CREATE TABLE MOVE_STATUS (CODE CODE_TWO NOT NULL,
        DESCRIPTION DESCRIPTION,
CONSTRAINT MOVESTATUS_PX PRIMARY KEY (CODE));

/* Table: OBJECT_IMAGE, Owner: SYSDBA */
CREATE TABLE OBJECT_IMAGE (SSN_ID SSN_ID NOT NULL,
        IMAGE1 IMAGE,
        IMAGE2 IMAGE,
        IMAGE3 IMAGE,
        NOTES NOTES,
PRIMARY KEY (SSN_ID));

/* Table: OCCUPATION, Owner: SYSDBA */
CREATE TABLE OCCUPATION (OCCUPATION_ID VARCHAR(30) NOT NULL,
        DESCRIPTION DESCRIPTION,
        CREATED_BY PERSON,
        CREATED_DATE TIMESTAMP,
PRIMARY KEY (OCCUPATION_ID));

/* Table: OPTIONS, Owner: SYSDBA */
CREATE TABLE OPTIONS (GROUP_CODE VARCHAR(10) NOT NULL,
        CODE CODE NOT NULL,
        DESCRIPTION DESCRIPTION NOT NULL,
        COMMENTS DESCR,
        DESCRIPTION2 TRN_DATA,
PRIMARY KEY (GROUP_CODE, CODE));

/* Table: ORDER_GROUP, Owner: SYSDBA */
CREATE TABLE ORDER_GROUP (ORDER_GROUP_ID VARCHAR(10) NOT NULL,
        UPDATE_ID VARCHAR(10),
        CREATE_DATE CREATE_DATE,
        CREATED_BY PERSON,
        PICK_RETRIEVE_STATUS VALUE_TF,
        DESCRIPTION ALT_NAME,
        STATUS STATUS,
PRIMARY KEY (ORDER_GROUP_ID));

/* Table: ORDER_TYPE, Owner: SYSDBA */
CREATE TABLE ORDER_TYPE (ORDER_TYPE CODE_TWO NOT NULL,
        DESCRIPTION DESCRIPTION,
        OUTWARDS VALUE_TF,
PRIMARY KEY (ORDER_TYPE));

/* Table: PACK_ID, Owner: SYSDBA */
CREATE TABLE PACK_ID (PACK_ID PACK_ID NOT NULL,
        DESPATCH_ID DESPATCH_ID NOT NULL,
        CREATE_DATE CREATE_DATE,
        LABEL_PRINTED_DATE LABEL_DATE,
        DESPATCH_LABEL_NO DESPATCH_LABEL_NO,
        LAST_UPDATE_DATE LAST_UPDATE_DATE,
        PROD_ID PRODUCT,
        QTY QTY,
        SSN_ID SSN_ID,
        DIMENSION_X NUMERIC(9, 3),
        DIMENSION_Y NUMERIC(9, 3),
        DIMENSION_Z NUMERIC(9, 3),
        DIMENSION_UOM CODE_TWO,
        VOLUME VOLUME,
        VOLUME_UOM UOM,
        PACK_WEIGHT WEIGHT_DECIMAL3,
        PACK_WEIGHT_UOM CODE_TWO,
        PACK_TYPE CODE_ONE,
        PACK_SEQUENCE_NO CODE_6,
        PACK_LAST_SEQUENCE_INDICATOR CODE_TWO_VAR,
        PACK_SERIAL_NO CODE,
PRIMARY KEY (PACK_ID));

/* Table: PACK_TYPE, Owner: SYSDBA */
CREATE TABLE PACK_TYPE (CODE CODE_ONE NOT NULL,
        DESCRIPTION DESCRIPTION,
        COUNTRY COUNTRY,
        COMPANY_ID COMPANY,
        CREATE_DATE CREATE_DATE,
PRIMARY KEY (CODE));

/* Table: PALLETS, Owner: SYSDBA */
CREATE TABLE PALLETS (GRN GRN NOT NULL,
        PALLET_OWNER PALLET_OWNER NOT NULL,
        PALLET_QTY QTY,
PRIMARY KEY (GRN, PALLET_OWNER));

/* Table: PALLET_CFG, Owner: SYSDBA */
CREATE TABLE PALLET_CFG (PALLET_CFG_CODE CODE_TWO NOT NULL,
        PALLET_CFG_DESCRIPTION DESCRIPTION,
        TOTAL_CARTONS_LAYER INTEGER,
        TOTAL_LAYERS INTEGER,
        PATTERN_IMAGE IMAGE,
PRIMARY KEY (PALLET_CFG_CODE));

/* Table: PARAM, Owner: SYSDBA */
CREATE TABLE PARAM (DATA_ID DATA_ID NOT NULL,
        MAX_LENGTH MAX_LENGTH NOT NULL,
        DATA_TYPE DATA_TYPE NOT NULL,
        FIXED_LENGTH FIXED_LENGTH,
        SYMBOLOGY_PREFIX SYMBOLOGY_PREFIX,
        DATA_EXPRESSION DATA_EXPRESSION,
        GLOBAL_SEARCH VALUE_TF,
        MENU_NAME CODE,
        TABLE_NAME CODE,
        FIELD_NAME CODE,
        MENU_URL CODE_255,
PRIMARY KEY (DATA_ID));

/* Table: PAYMENT_METHODS, Owner: SYSDBA */
CREATE TABLE PAYMENT_METHODS (PAYMENT_METHOD VARCHAR(20));

/* Table: PERSON, Owner: SYSDBA */
CREATE TABLE PERSON (PERSON_ID PERSON NOT NULL,
        PERSON_TYPE CODE_TWO,
        ADDRESS_LINE2 ADDRESS_LINE,
        CITY CITY,
        STATE STATE,
        POST_CODE POST_CODE,
        COUNTRY COUNTRY,
        MOBILE_NO MOBILE_NO,
        EMAIL EMAIL,
        CONTACT_FIRST_NAME CONTACT_FIRST_NAME,
        CONTACT_LAST_NAME CONTACT_LAST_NAME,
        CREATE_DATE CREATE_DATE,
        STATUS STATUS,
        MAIL_ADDRESS1 ADDRESS_LINE,
        MAIL_ADDRESS2 ADDRESS_LINE,
        MAIL_CITY MAIL_CITY,
        MAIL_STATE MAIL_STATE,
        MAIL_POST_CODE MAIL_POST_CODE,
        MAIL_COUNTRY MAIL_COUNTRY,
        SECOND_CONTACT_FIRST_NAME SECOND_CONTACT_FIRST_NAME,
        SECOND_CONTACT_LAST_NAME SECOND_CONTACT_LAST_NAME,
        SECOND_MOBILE_NO SECOND_MOBILE_NO,
        SECOND_EMAIL SECOND_EMAIL,
        LAST_NAME LAST_NAME,
        SECOND_FAX_NO SECOND_FAX_NO,
        SECOND_PHONE_NO SECOND_PHONE_NO,
        FAX_NO FAX_NO,
        PHONE_NO PHONE_NO,
        TITLE VARCHAR(10),
        MAIL_PHONE PHONE_NO,
        CONTACT_ADDRESS1 ADDRESS_LINE,
        CONTACT_ADDRESS2 ADDRESS_LINE,
        CONTACT_CITY CITY,
        CONTACT_STATE STATE,
        CONTACT_POST_CODE POST_CODE,
        CONTACT_PHONE PHONE_NO,
        CREATE_BY PERSON,
        CONTACT_COUNTRY COUNTRY,
        FIRST_NAME VARCHAR(255),
        ADDRESS_LINE1 VARCHAR(100),
        ADDRESS_LINE3 ADDRESS_LINE,
        ADDRESS_LINE4 ADDRESS_LINE,
        AUST_POST_4STATE_ID VARCHAR(255),
        ADDRESS_LINE5 ADDRESS_LINE,
        WEB_SITE DESCR,
        COMPANY_ID COMPANY,
        SALE_AREA_CODE CODE_TWO,
        PERSON_DISCOUNT_PERCENT PERCENT_F default 0,
        PERSON_DISCOUNT_CODE CODE_TWO,
PRIMARY KEY (PERSON_ID));

/* Table: PERSON_ADDRESS, Owner: SYSDBA */
CREATE TABLE PERSON_ADDRESS (RECORD_ID RECORD_ID NOT NULL,
        PERSON_ID PERSON NOT NULL,
        ADDR_TYPE CODE_TWO NOT NULL,
        ADDR_LINE1 VARCHAR(100),
        ADDR_LINE2 ADDRESS_LINE,
        ADDR_SUBURB CITY,
        ADDR_CITY CITY,
        ADDR_STATE STATE,
        ADDR_POST_CODE POST_CODE,
        ADDR_COUNTRY COUNTRY,
        ADDR_POST_4STATE_ID VARCHAR(255),
        ADDR_MOBILE_NO MOBILE_NO,
        ADDR_PHONE_NO PHONE_NO,
        ADDR_FAX_NO FAX_NO,
        ADDR_EMAIL EMAIL,
        ADDR_TITLE VARCHAR(10),
        ADDR_FIRST_NAME ADDR_NAME,
        ADDR_LAST_NAME ADDR_NAME,
        ADDR_STATUS STATUS,
        ADDR_CREATED_DATE CREATE_DATE,
        ADDR_CREATED_BY PERSON,
        COMPANY_ID COMPANY,
PRIMARY KEY (RECORD_ID));

/* Table: PERSON_COMPANY, Owner: SYSDBA */
CREATE TABLE PERSON_COMPANY (RECORD_ID RECORD_ID NOT NULL,
        PERSON_ID PERSON NOT NULL,
        COMPANY_ID COMPANY NOT NULL,
        PC_STATUS STATUS,
        PC_CREATE_DATE CREATE_DATE,
        PC_CREATED_BY PERSON,
        PC_LAST_UPDATE_DATE CREATE_DATE,
        PC_LAST_UPDATE_BY PERSON,
PRIMARY KEY (RECORD_ID));

/* Table: PERSON_TYPE, Owner: SYSDBA */
CREATE TABLE PERSON_TYPE (CODE CODE NOT NULL,
        DESCRIPTION DESCRIPTION,
PRIMARY KEY (CODE));

/* Table: PICK_DESPATCH, Owner: SYSDBA */
CREATE TABLE PICK_DESPATCH (DESPATCH_ID DESPATCH_ID NOT NULL,
        AWB_CONSIGNMENT_NO AWB_CONSIGNMENT_NO,
        PICKD_CARRIER_ID DESPATCH_CARRIER,
        PICKD_SERVICE_TYPE SERVICE_TYPE,
        PICKD_CHARGE_TO CODE_ONE,
        SENDER_ACCOUNT CARRIER_ACCOUNT_NO,
        RECEIVER_ACCOUNT CARRIER_ACCOUNT_NO,
        PICKD_POST_CODE DESPATCH_POST_CODE,
        PICKD_SUBURB DESCRIPTION,
        PICKD_PALLET_QTY QTY,
        PICKD_CARTON_QTY QTY,
        PICKD_SATCHEL_QTY QTY,
        PICKD_WT_CALC WEIGHT,
        PICKD_WT_ACTUAL WEIGHT,
        PICKD_VOL_ACTUAL DESPATCHED_VOL,
        PICKD_PALLET_OWNER PALLET_OWNER,
        PICKD_ADDRESS_QTY QTY,
        PICKD_LABEL_START DESPATCH_LABEL_NO,
        PICKD_LABEL_TYPE CODE_ONE,
        PICKD_EXIT DESPATCH_FINISH,
        USER_ID USER_ID,
        DEVICE_ID DEVICE_ID,
        CREATE_DATE CREATE_DATE,
        DESPATCH_STATUS STATUS,
        LAST_UPDATE_DATE LAST_UPDATE_DATE,
        PACK_TYPE CODE_ONE,
        INVOICE_ID INVOICE_ID,
        INVOICE_NO INVOICE_NO,
        INVOICE_TYPE CODE_TWO,
        PICKD_SERVICE_CHARGE_TO PERSON,
        PICKD_SERVICE_RECORD_ID RECORD_ID,
        PICKD_MANIFEST_ID VARCHAR(24),
PRIMARY KEY (DESPATCH_ID));

/* Table: PICK_FORM, Owner: SYSDBA */
CREATE TABLE PICK_FORM (PICK_ORDER PICK_ORDER NOT NULL,
        SEQ INTEGER NOT NULL,
        DESCRIPTION CODE_255,
        CREATE_DATE CREATE_DATE,
PRIMARY KEY (PICK_ORDER, SEQ));

/* Table: PICK_INVOICE, Owner: SYSDBA */
CREATE TABLE PICK_INVOICE (INVOICE_ID INVOICE_ID NOT NULL,
        INVOICE_NO INVOICE_NO,
        INVOICE_TYPE CODE_TWO,
        INVOICE_STATUS STATUS,
        PICK_ORDER PICK_ORDER,
        LEGACY_LEDGER_ADMIN_FEE_CODE CODE,
        LEGACY_LEDGER_FREIGHT_CODE CODE,
        LEGACY_LEDGER_DEPOSIT_CODE CODE,
        INVOICE_EXPORTED_DATE TIMESTAMP,
        SUB_TOTAL_AMOUNT DOUBLE PRECISION default 0.00,
        SUB_TOTAL_TAX DOUBLE PRECISION,
        FREIGHT DOUBLE PRECISION default 0.00,
        FREIGHT_TAX_AMOUNT DOUBLE PRECISION,
        ADMIN_FEE_RATE DOUBLE PRECISION,
        ADMIN_FEE_AMOUNT DOUBLE PRECISION default 0.00,
        ADMIN_TAX_AMOUNT DOUBLE PRECISION,
        TAX_RATE DOUBLE PRECISION,
        TAX_AMOUNT DOUBLE PRECISION default 0.00,
        DUE_AMOUNT DOUBLE PRECISION default 0.00,
        AMOUNT_PAID DOUBLE PRECISION default 0.00,
        CREATE_DATE CREATE_DATE,
        CREATED_BY USER_ID,
        INV_TOTAL_AMOUNT DOUBLE PRECISION,
        LAST_UPDATE_DATE LAST_UPDATE_DATE,
        LAST_UPDATE_BY USER_ID,
        PRINTED_DATE LABEL_DATE,
        COMPANY_ID COMPANY,
        WH_ID WH_ID,
        PDF_IMAGE PDF_DESCRIPTION,
        SHIPPING_METHOD CARRIER_ACCOUNT_NO,
PRIMARY KEY (INVOICE_ID));

/* Table: PICK_INVOICE_LINE, Owner: SYSDBA */
CREATE TABLE PICK_INVOICE_LINE (INVLINE_LINE_ID INTEGER NOT NULL,
        INVLINE_INVOICE_NO INVOICE_NO,
        INVLINE_PICK_ORDER PICK_ORDER,
        INVLINE_PICK_LABEL_NO PICK_LABEL_NO,
        INVLINE_EXPORTED_DATE EXPORT_DATE,
        INVLINE_PICK_ID PICK_ID,
        INVLINE_PICK_TYPE STATUS,
        INVLINE_LINE_TYPE CHAR(1),
        INVLINE_QTY QTY,
        INVLINE_SALE_PRICE DOUBLE PRECISION,
        INVLINE_DISCOUNT DOUBLE PRECISION,
        INVLINE_LINE_TOTAL DOUBLE PRECISION,
        INVLINE_TAX_RATE DOUBLE PRECISION,
        INVLINE_UNIT_COST DOUBLE PRECISION,
        INVLINE_TOTAL_COST DOUBLE PRECISION,
        INVLINE_LEGACY_LEDGER_CODE CODE,
        INVLINE_CREATED_DATE CREATE_DATE,
        INVLINE_CREATED_BY USER_ID,
        INVLINE_UPDATE_DATE LAST_UPDATE_DATE,
        INVLINE_UPDATED_BY USER_ID,
        INVLINE_INVOICE_ID INVOICE_ID,
CONSTRAINT INVLINE_PRIMARY PRIMARY KEY (INVLINE_LINE_ID));

/* Table: PICK_ITEM, Owner: SYSDBA */
CREATE TABLE PICK_ITEM (PICK_LABEL_NO PICK_LABEL_NO NOT NULL,
        PICK_ORDER PICK_ORDER NOT NULL,
        PICK_ORDER_LINE_NO PICK_ORDER_LINE_NO,
        CONTACT_NAME CONTACT_NAME,
        PROD_ID PRODUCT,
        SSN_ID SSN_ID,
        WARRANTY_TERM WARRANTY_TERM,
        PICK_LABEL_DATE LABEL_DATE,
        SPECIAL_INSTRUCTIONS1 SPECIAL_INSTRUCTIONS1,
        SPECIAL_INSTRUCTIONS2 SPECIAL_INSTRUCTIONS2,
        SHIP_VIA SHIP_VIA,
        PICK_ORDER_QTY QTY,
        PICK_ALLOCATED_QTY QTY,
        PICKED_QTY QTY,
        PICK_LINE_DUE_DATE PICK_LINE_DUE_DATE,
        PICK_STARTED PICK_STARTED,
        DESPATCH_TS DESPATCH_TS,
        DESPATCH_LOCATION DESPATCH_LOCATION,
        CREATE_DATE CREATE_DATE,
        USER_ID USER_ID,
        DEVICE_ID DEVICE_ID,
        CHECKIN_START CHECKIN_START,
        CHECKIN_FINISH CHECKIN_FINISH,
        CHECKIN_USER_ID USER_ID,
        PICK_LINE_STATUS STATUS,
        PARTIAL_PICK_ALLOWED PARTIAL_PICK_ALLOWED,
        DESPATCH_PALLET_NO PALLET_NO,
        WH_ID WH_ID,
        PICK_LOCATION LOCN_ID,
        REASON DESCRIPTION,
        SALE_PRICE UNIT_PRICE,
        DISCOUNT DISCOUNT,
        SSN_CONFIRM CHAR(1),
        WIP_PRELOCN_ORDERING DESCRIPTION,
        WIP_POSTLOCN_ORDERING DESCRIPTION,
        ALLOW_SUBSTITUTE CODE_ONE,
        ORIGINAL_SSN_ID SSN_ID,
        RETURN_DATE DATETIME,
        PICK_RETRIEVE_STATUS VALUE_TF,
        DESPATCH_LOCATION_GROUP LOCN_ID,
        PICK_QTY_DIFFERENCE INTEGER,
        PICK_QTY_DIFFERENCE2 INTEGER,
        LAST_UPDATE_DATE LAST_UPDATE_DATE,
        OTHER1 OTHER_CHAR,
        OTHER2 OTHER_CHAR,
        OTHER3 OTHER_CHAR,
        OTHER4 OTHER_CHAR,
        OTHER5 OTHER_CHAR,
        OTHER6 OTHER_CHAR,
        OTHER7 OTHER_CHAR,
        OTHER8 OTHER_CHAR,
        OTHER9 OTHER_CHAR,
        LINE_TOTAL DOUBLE PRECISION,
        TAX_AMOUNT DOUBLE PRECISION,
        TAX_RATE TAX_RATE,
        BATCH_LINE INTEGER,
        OVER_SIZED VALUE_TF,
        OTHER_QTY1 QTY,
        OTHER_QTY2 QTY,
        SPECIAL_INSTRUCTIONS3 COMMENTS,
        ALT_DESPATCH_WH_ID WH_ID,
        ALT_DESPATCH_LOCN_ID LOCN_ID,
        PICK_LINE_PRIORITY PICK_LINE_PRIORITY,
        PICK_PICK_FINISH TIMESTAMP,
        PICK_LOCN_SEQ LOCN_SEQ,
        CANCEL_METHOD CODE_ONE,
        PI_LEGACY_ITEM_DESCR NOTES,
        PI_LEGACY_CLOSED VALUE_TF,
        PI_LEGACY_LINENO INTEGER,
        PI_LEGACY_WH_NAME DESCRIPTION,
        PI_LEGACY_FULFILLED_QTY QTY,
        PI_LEGACY_PACKED_QTY QTY,
        PI_LEGACY_PICKED_QTY QTY,
        PI_LEGACY_RATE VARCHAR(15),
        PI_LEGACY_PICK_UOM CODE_TWO,
        SO_REVISION_STATUS STATUS,
        PI_LEGACY_WH_ID VARCHAR(2),
        PI_LOAN_SSN_COST PURCHASE_PRICE,
        PICK_TYPE STATUS,
        PICK_ID VARCHAR(80),
        PI_LOAN_RATE PERCENT_F,
        EARLIEST_DATE DATETIME,
        ORIG_PROD_ID DESCR,
        ORIG_SSN_ID CODE_255,
        PREV_LINE_STATUS STATUS,
        PREV_PICK_ORDER_LINE_NO PICK_ORDER_LINE_NO,
        PREV_PREV_PICK_ORDER_LINE_NO PICK_ORDER_LINE_NO,
        PREV_PROD_ID PRODUCT,
        PREV_PREV_PROD_ID PRODUCT,
        PREV_SSN_ID SSN_ID,
        PREV_PREV_SSN_ID SSN_ID,
        LEGACY_LEDGER_SALE_CODE CODE,
        LEGACY_LEDGER_DEPOSIT_CODE CODE,
        LEGACY_LEDGER_PURCHASE_CODE CODE,
        EXPORTED_DESPATCH VALUE_TF,
        EXPORTED_DESPATCH_QTY QTY,
PRIMARY KEY (PICK_LABEL_NO));

/* Table: PICK_ITEM_CANCEL, Owner: SYSDBA */
CREATE TABLE PICK_ITEM_CANCEL (PICK_LABEL_NO PICK_LABEL_NO NOT NULL,
        PICK_ORDER PICK_ORDER NOT NULL,
        PICK_ORDER_LINE_NO PICK_ORDER_LINE_NO,
        CONTACT_NAME CONTACT_NAME,
        PROD_ID PRODUCT,
        SSN_ID SSN_ID,
        WARRANTY_TERM WARRANTY_TERM,
        PICK_LABEL_DATE LABEL_DATE,
        SPECIAL_INSTRUCTIONS1 SPECIAL_INSTRUCTIONS1,
        SPECIAL_INSTRUCTIONS2 SPECIAL_INSTRUCTIONS2,
        SHIP_VIA SHIP_VIA,
        PICK_ORDER_QTY QTY,
        PICK_ALLOCATED_QTY QTY,
        PICKED_QTY QTY,
        PICK_LINE_DUE_DATE PICK_LINE_DUE_DATE,
        PICK_STARTED PICK_STARTED,
        DESPATCH_TS DESPATCH_TS,
        DESPATCH_LOCATION DESPATCH_LOCATION,
        CREATE_DATE CREATE_DATE,
        USER_ID USER_ID,
        DEVICE_ID DEVICE_ID,
        CHECKIN_START CHECKIN_START,
        CHECKIN_FINISH CHECKIN_FINISH,
        CHECKIN_USER_ID USER_ID,
        PICK_LINE_STATUS STATUS,
        PARTIAL_PICK_ALLOWED PARTIAL_PICK_ALLOWED,
        DESPATCH_PALLET_NO PALLET_NO,
        WH_ID WH_ID,
        PICK_LOCATION LOCN_ID,
        SALE_PRICE UNIT_PRICE,
        DISCOUNT DOUBLE PRECISION,
        SSN_CONFIRM CHAR(1),
        REASON VARCHAR(255),
        LAST_UPDATE_DATE LAST_UPDATE_DATE,
        CANCEL_METHOD CHAR(1));

/* Table: PICK_ITEM_DETAIL, Owner: SYSDBA */
CREATE TABLE PICK_ITEM_DETAIL (PICK_DETAIL_ID PICK_DETAIL_ID NOT NULL,
        PICK_LABEL_NO PICK_LABEL_NO NOT NULL,
        SSN_ID SSN_ID NOT NULL,
        DESPATCH_ID DESPATCH_ID,
        PICK_DETAIL_STATUS STATUS,
        QTY_PICKED QTY,
        DESPATCH_LOCATION DESPATCH_LOCATION,
        PACK_ID PACK_ID,
        EAN_SSCC PACK_EAN_SSCC,
        USER_ID USER_ID,
        DEVICE_ID DEVICE_ID,
        CREATE_DATE CREATE_DATE,
        FROM_WH_ID WH_ID,
        FROM_LOCN_ID LOCN_ID,
        LAST_UPDATE_DATE LAST_UPDATE_DATE,
        PID_LEGACY_TRY INTEGER default 0,
        ORIGINAL_QTY_PICKED QTY,
        QTY_RECEIVED QTY,
        PICK_ORDER PICK_ORDER,
PRIMARY KEY (PICK_DETAIL_ID));

/* Table: PICK_ITEM_LINE_NO, Owner: SYSDBA */
CREATE TABLE PICK_ITEM_LINE_NO (PICK_ORDER PICK_ORDER NOT NULL,
        LAST_LINE_NO INTEGER,
        LAST_UPDATE_DATE LAST_UPDATE_DATE,
PRIMARY KEY (PICK_ORDER));

/* Table: PICK_ITEM_REVISED, Owner: SYSDBA */
CREATE TABLE PICK_ITEM_REVISED (PICK_LABEL_NO PICK_LABEL_NO NOT NULL,
        PICK_ORDER PICK_ORDER NOT NULL,
        PICK_ORDER_LINE_NO PICK_ORDER_LINE_NO,
        CONTACT_NAME CONTACT_NAME,
        PROD_ID PRODUCT,
        SSN_ID SSN_ID,
        WARRANTY_TERM WARRANTY_TERM,
        PICK_LABEL_DATE LABEL_DATE,
        SPECIAL_INSTRUCTIONS1 SPECIAL_INSTRUCTIONS1,
        SPECIAL_INSTRUCTIONS2 SPECIAL_INSTRUCTIONS2,
        SHIP_VIA SHIP_VIA,
        PICK_ORDER_QTY QTY,
        PICK_ALLOCATED_QTY QTY,
        PICKED_QTY QTY,
        PICK_LINE_DUE_DATE PICK_LINE_DUE_DATE,
        PICK_STARTED PICK_STARTED,
        DESPATCH_TS DESPATCH_TS,
        DESPATCH_LOCATION DESPATCH_LOCATION,
        CREATE_DATE CREATE_DATE,
        USER_ID USER_ID,
        DEVICE_ID DEVICE_ID,
        CHECKIN_START CHECKIN_START,
        CHECKIN_FINISH CHECKIN_FINISH,
        CHECKIN_USER_ID USER_ID,
        PICK_LINE_STATUS STATUS,
        PARTIAL_PICK_ALLOWED PARTIAL_PICK_ALLOWED,
        DESPATCH_PALLET_NO PALLET_NO,
        WH_ID WH_ID,
        PICK_LOCATION LOCN_ID,
        REASON DESCRIPTION,
        SALE_PRICE UNIT_PRICE,
        DISCOUNT DOUBLE PRECISION,
        SSN_CONFIRM CHAR(1),
        WIP_PRELOCN_ORDERING DESCRIPTION,
        WIP_POSTLOCN_ORDERING DESCRIPTION,
        ALLOW_SUBSTITUTE CODE_ONE,
        ORIGINAL_SSN_ID SSN_ID,
        RETURN_DATE DATETIME,
        PICK_RETRIEVE_STATUS VALUE_TF,
        DESPATCH_LOCATION_GROUP LOCN_ID,
        PICK_QTY_DIFFERENCE INTEGER,
PRIMARY KEY (PICK_LABEL_NO));

/* Table: PICK_LOCATION, Owner: SYSDBA */
CREATE TABLE PICK_LOCATION (RECORD_ID INTEGER NOT NULL,
        PICK_ORDER PICK_ORDER,
        WH_ID WH_ID,
        LOCN_ID LOCN_ID,
        PICK_LOCATION_STATUS STATUS,
        CREATED_DATE CREATE_DATE,
        CREATED_BY USER_ID,
        LAST_UPDATE_DATE LAST_UPDATE_DATE,
        LAST_UPDATED_BY USER_ID,
        DEVICE_ID DEVICE_ID,
PRIMARY KEY (RECORD_ID));

/* Table: PICK_LOCATIONS, Owner: SYSDBA */
CREATE TABLE PICK_LOCATIONS (PICK_LABEL_NO PICK_LABEL_NO NOT NULL,
        PROD_ID PRODUCT,
        SSN_ID SSN_ID,
        WH_ID WH_ID,
        LOCN_ID LOCN_ID,
        QTY_AVAILABLE QTY,
        ISSN_STATUS STATUS);

/* Table: PICK_MANIFEST, Owner: SYSDBA */
CREATE TABLE PICK_MANIFEST (MANIFEST_ID VARCHAR(24) NOT NULL,
        PICKM_DATE DESPATCH_FINISH,
        USER_ID USER_ID,
        DEVICE_ID DEVICE_ID,
        CREATE_DATE CREATE_DATE,
        LAST_UPDATE_DATE LAST_UPDATE_DATE,
        PICKM_STATUS STATUS,
CONSTRAINT MANIFEST_PRIMARY PRIMARY KEY (MANIFEST_ID));

/* Table: PICK_MODE, Owner: SYSDBA */
CREATE TABLE PICK_MODE (PICK_MODE_NO CODE_TWO NOT NULL,
        PICK_ORDER_TYPE CODE_TWO,
        DESCRIPTION DESCRIPTION,
        PROCEDURE_NAME DESCRIPTION,
        PICK_PARAM_TYPE VALUE_TF,
        PICK_PARAM_MODE VALUE_TF,
        PICK_PARAM_ORDNO VALUE_TF,
        PICK_PARAM_STATUS VALUE_TF,
        PICK_PARAM_PRIORITY VALUE_TF,
        PICK_PARAM_ID VALUE_TF,
        PICK_PARAM_GETALLBTNVISIBLE VALUE_TF,
        PICK_PARAM_ACCEPTBTNVISIBLE VALUE_TF,
        PICK_PARAM_DEVICEPC VALUE_TF,
        PICK_PARAM_USE_TROLLEY VALUE_TF,
        PICK_PARAM_SEE_ORDER_PRINT VALUE_TF,
        PICK_PARAM_AUTO_PICK VALUE_TF,
PRIMARY KEY (PICK_MODE_NO));

/* Table: PICK_ORDER, Owner: SYSDBA */
CREATE TABLE PICK_ORDER (PICK_ORDER PICK_ORDER NOT NULL,
        PICK_ORDER_TYPE CODE_TWO,
        PERSON_ID PERSON,
        CONTACT_NAME CONTACT_NAME,
        CUSTOMER_PO_WO CUSTOMER_PO_WO,
        COST_CENTER COST_CENTER,
        COMPANY_ID COMPANY,
        DIVISION_ID DIVISION,
        PICK_PRIORITY PICK_PRIORITY,
        DELIVERY_RUN_NO DELIVERY_RUN_NO,
        PICK_DUE_DATE PICK_DUE_DATE,
        SPECIAL_INSTRUCTIONS1 SPECIAL_INSTRUCTIONS1,
        SPECIAL_INSTRUCTIONS2 SPECIAL_INSTRUCTIONS2,
        INV_WITH_GOODS INV_WITH_GOODS,
        SHIP_VIA SHIP_VIA,
        DESPATCH_LOCATION DESPATCH_LOCATION,
        CREATE_DATE CREATE_DATE,
        CREATED_BY USER_ID,
        PICK_STARTED PICK_STARTED,
        PICK_STATUS STATUS,
        PARTIAL_PICK_ALLOWED PARTIAL_PICK_ALLOWED,
        SHIP_SERVICE SHIP_SERVICE,
        P_PERSON_TYPE CODE_TWO,
        P_FIRST_NAME FIRST_NAME,
        P_LAST_NAME LAST_NAME,
        P_ADDRESS_LINE2 ADDRESS_LINE,
        P_CITY CITY,
        P_STATE STATE,
        P_POST_CODE POST_CODE,
        P_COUNTRY COUNTRY,
        P_PHONE PHONE_NO,
        TERMS VARCHAR(20),
        PAYMENT_METHOD VARCHAR(20),
        SUB_TOTAL_AMOUNT DOUBLE PRECISION DEFAULT 0.00,
        FREIGHT DOUBLE PRECISION DEFAULT 0.00,
        AMOUNT_PAID DOUBLE PRECISION DEFAULT 0.00,
        TAX_RATE DOUBLE PRECISION,
        ADMIN_FEE_RATE DOUBLE PRECISION,
        P_PERSON_ID PERSON,
        P_SAME_AS_INVOICE_TO CHAR(1),
        ADMIN_FEE_AMOUNT DOUBLE PRECISION DEFAULT 0.00,
        TAX_AMOUNT DOUBLE PRECISION DEFAULT 0.00,
        DUE_AMOUNT DOUBLE PRECISION DEFAULT 0.00,
        APPROVED_DATE TIMESTAMP,
        APPROVED_BY PERSON,
        LAST_LINE_NO INTEGER,
        SUM_STD_AMOUNT DOUBLE PRECISION DEFAULT 0.00,
        SUM_SALE_AMOUNT DOUBLE PRECISION DEFAULT 0.00,
        IMPORTED CHAR(1),
        IMPORT_ERRORS INTEGER DEFAULT 0,
        APPROVED_DESP_DATE TIMESTAMP,
        APPROVED_DESP_BY PERSON,
        DEFAULT_SALE_PRICE PURCHASE_PRICE,
        WIP_ORDERING DESCRIPTION,
        PERMANENT_TRANSFER CODE_ONE,
        RETURN_DATE DATETIME,
        PRINTED_DATE TIMESTAMP,
        PRINTED_STATUS VALUE_TF,
        PICK_RETRIEVE_STATUS VALUE_TF,
        P_ADDRESS_LINE1 VARCHAR(100),
        P_TITLE VARCHAR(10),
        P_ADDRESS_LINE3 ADDRESS_LINE,
        P_ADDRESS_LINE4 ADDRESS_LINE,
        P_AUST_POST_4STATE_ID VARCHAR(255),
        SUPPLIER_LIST VALUE_TF,
        SPECIAL_INSTRUCTIONS VALUE_TF,
        WH_ID WH_ID,
        UPDATE_ID VARCHAR(10),
        ASSEMBLY_STARTED TIMESTAMP,
        LAST_UPDATE_DATE LAST_UPDATE_DATE,
        ORDER_CANCELLED TIMESTAMP,
        P_ADDRESS_LINE5 ADDRESS_LINE,
        OTHER1 OTHER_CHAR,
        OTHER2 OTHER_CHAR,
        OTHER3 OTHER_CHAR,
        OTHER4 OTHER_CHAR,
        OTHER5 OTHER_CHAR,
        OTHER6 OTHER_CHAR,
        OTHER7 OTHER_CHAR,
        OTHER8 OTHER_CHAR,
        OTHER9 OTHER_CHAR,
        FREIGHT_TAX_AMOUNT DOUBLE PRECISION,
        NET_WEIGHT DOUBLE PRECISION,
        PALLET_BASE PRODUCT,
        OVER_SIZED VALUE_TF,
        LABEL_PRINTED_DATE LABEL_DATE,
        OTHER_NUM1 STANDARD_COST,
        OTHER_NUM2 STANDARD_COST,
        REMARKS1 DESCR,
        REMARKS2 DESCR,
        REMARKS3 DESCR,
        REMARKS4 DESCR,
        REMARKS5 DESCR,
        REMARKS6 DESCR,
        FOOTER1 DESCR,
        FOOTER2 DESCR,
        FOOTER3 DESCR,
        FOOTER4 DESCR,
        FOOTER5 DESCR,
        OVER_SIZED_REASON CODE,
        ADDRESS_LABEL_DATE TIMESTAMP,
        PICK_ORDER_STARTED TIMESTAMP,
        EXPORT_CATEGORY CHAR(1),
        D_FIRST_NAME FIRST_NAME,
        D_LAST_NAME LAST_NAME,
        D_CITY CITY,
        D_STATE STATE,
        D_POST_CODE POST_CODE,
        D_COUNTRY LEGACY_COUNTRY,
        D_PHONE PHONE_NO,
        D_ADDRESS_LINE1 VARCHAR(100),
        D_ADDRESS_LINE2 ADDRESS_LINE,
        D_ADDRESS_LINE3 ADDRESS_LINE,
        D_ADDRESS_LINE4 ADDRESS_LINE,
        D_ADDRESS_LINE5 ADDRESS_LINE,
        D_TITLE VARCHAR(10),
        SUPPLIER_ID PERSON,
        S_PERSON_ID PERSON,
        S_PERSON_TYPE CODE_TWO,
        S_FIRST_NAME FIRST_NAME,
        S_LAST_NAME LAST_NAME,
        S_CITY CITY,
        S_STATE STATE,
        S_POST_CODE POST_CODE,
        S_COUNTRY COUNTRY,
        S_PHONE PHONE_NO,
        S_ADDRESS_LINE1 VARCHAR(100),
        S_ADDRESS_LINE2 ADDRESS_LINE,
        S_ADDRESS_LINE3 ADDRESS_LINE,
        S_ADDRESS_LINE4 ADDRESS_LINE,
        S_ADDRESS_LINE5 ADDRESS_LINE,
        S_TITLE VARCHAR(10),
        S_SAME_AS_SOLD_FROM CHAR(1),
        D_PERSON_ID PERSON,
        SO_LEGACY_CONSIGNMENT OTHER_CHAR,
        SO_LEGACY_PROJECT VARCHAR(50),
        SO_LEGACY_INTERNAL_ID VARCHAR(20),
        SO_LEGACY_LAST_MODIFIED LAST_UPDATE_DATE,
        SO_LEGACY_PICK_WH_ID CHAR(2),
        SO_LEGACY_PICK_WH_NAME VARCHAR(50),
        SO_LEGACY_MEMO VARCHAR(1024),
        SO_LEGACY_STATUS_ID VARCHAR(2),
        SO_LEGACY_STATUS VARCHAR(50),
        SHIP_VIA_NAME VARCHAR(50),
        SO_LEGACY_CREATE_DATE LAST_UPDATE_DATE,
        PO_MATERIAL_SAFETY_DATA VALUE_TF,
        EARLIEST_DATE DATETIME,
        D_WH_ID WH_ID,
        LEGACY_LEDGER_ADMIN_FEE_CODE CODE,
        LEGACY_LEDGER_FREIGHT_CODE CODE,
        LEGACY_LEDGER_DEPOSIT_CODE CODE,
        P_ADDR_RECORD_ID RECORD_ID,
        D_ADDR_RECORD_ID RECORD_ID,
        INVOICE_COUNT INTEGER,
        SALE_AREA_CODE CODE_TWO,
        VOLUME VOLUME,
        VOLUME_UOM UOM,
        DESPATCH_LOCATION_GROUP LOCN_ID,
        SHIPPING_METHOD CARRIER_ACCOUNT_NO,
        SUB_TOTAL_TAX DOUBLE PRECISION,
PRIMARY KEY (PICK_ORDER));

/* Table: PICK_ORDER_GROUP, Owner: SYSDBA */
CREATE TABLE PICK_ORDER_GROUP (ORDER_GROUP_ID VARCHAR(10) NOT NULL,
        PICK_ORDER PICK_ORDER NOT NULL,
        CREATE_DATE CREATE_DATE,
        CREATED_BY PERSON,
        STATUS STATUS,
PRIMARY KEY (ORDER_GROUP_ID, PICK_ORDER));

/* Table: PICK_ORDER_ITEM_TEMP, Owner: SYSDBA */
CREATE TABLE PICK_ORDER_ITEM_TEMP (H_PICK_ORDER PICK_ORDER NOT NULL,
        H_PICK_ORDER_TYPE CODE_TWO,
        H_PERSON_ID PERSON,
        H_CONTACT_NAME CONTACT_NAME,
        H_CUSTOMER_PO_WO CUSTOMER_PO_WO,
        H_COST_CENTER COST_CENTER,
        H_COMPANY_ID COMPANY,
        H_DIVISION_ID DIVISION,
        H_PICK_PRIORITY PICK_PRIORITY,
        H_DELIVERY_RUN_NO DELIVERY_RUN_NO,
        H_PICK_DUE_DATE PICK_DUE_DATE,
        H_SPECIAL_INSTRUCTIONS1 SPECIAL_INSTRUCTIONS1,
        H_SPECIAL_INSTRUCTIONS2 SPECIAL_INSTRUCTIONS2,
        H_INV_WITH_GOODS INV_WITH_GOODS,
        H_SHIP_VIA SHIP_VIA,
        H_DESPATCH_LOCATION DESPATCH_LOCATION,
        H_CREATE_DATE CREATE_DATE,
        H_CREATED_BY USER_ID,
        H_PICK_STARTED PICK_STARTED,
        H_PICK_STATUS STATUS,
        H_PARTIAL_PICK_ALLOWED PARTIAL_PICK_ALLOWED,
        L_PICK_ORDER PICK_ORDER,
        L_PICK_ORDER_LINE_NO PICK_ORDER_LINE_NO,
        L_CONTACT_NAME CONTACT_NAME,
        L_PROD_ID PRODUCT,
        L_SSN_ID SSN_ID,
        L_WARRANTY_TERM WARRANTY_TERM,
        L_PICK_LABEL_DATE LABEL_DATE,
        L_SPECIAL_INSTRUCTIONS1 SPECIAL_INSTRUCTIONS1,
        L_SPECIAL_INSTRUCTIONS2 SPECIAL_INSTRUCTIONS2,
        L_SHIP_VIA SHIP_VIA,
        L_PICK_ORDER_QTY QTY,
        L_PICK_ALLOCATED_QTY QTY,
        L_PICKED_QTY QTY,
        L_PICK_LINE_DUE_DATE PICK_LINE_DUE_DATE,
        L_PICK_STARTED PICK_STARTED,
        L_DESPATCH_TS DESPATCH_TS,
        L_DESPATCH_LOCATION DESPATCH_LOCATION,
        L_CREATE_DATE CREATE_DATE,
        L_USER_ID USER_ID,
        L_DEVICE_ID DEVICE_ID,
        L_CHECKIN_START CHECKIN_START,
        L_CHECKIN_FINISH CHECKIN_FINISH,
        L_CHECKIN_USER_ID USER_ID,
        L_PICK_LINE_STATUS STATUS,
        L_PARTIAL_PICK_ALLOWED PARTIAL_PICK_ALLOWED,
        P_PERSON_TYPE CODE_TWO,
        P_FIRST_NAME FIRST_NAME,
        P_LAST_NAME LAST_NAME,
        P_ADDRESS_LINE2 ADDRESS_LINE,
        P_CITY CITY,
        P_STATE STATE,
        P_POST_CODE POST_CODE,
        P_COUNTRY COUNTRY,
        L_SALE_PRICE UNIT_PRICE,
        L_ALLOW_SSN_SUBSTITUTE CODE_ONE,
        H_RETURN_DATE DATETIME,
        L_RETURN_DATE DATETIME,
        P_ADDRESS_LINE1 VARCHAR(100),
        P_ADDRESS_LINE3 ADDRESS_LINE,
        P_ADDRESS_LINE4 ADDRESS_LINE,
        P_ADDRESS_LINE5 ADDRESS_LINE,
        H_OTHER1 OTHER_CHAR,
        H_OTHER2 OTHER_CHAR,
        H_OTHER3 OTHER_CHAR,
        H_OTHER4 OTHER_CHAR,
        H_OTHER5 OTHER_CHAR,
        H_OTHER6 OTHER_CHAR,
        H_OTHER7 OTHER_CHAR,
        H_OTHER8 OTHER_CHAR,
        H_OTHER9 OTHER_CHAR,
        L_OTHER1 OTHER_CHAR,
        L_OTHER2 OTHER_CHAR,
        L_OTHER3 OTHER_CHAR,
        L_OTHER4 OTHER_CHAR,
        L_OTHER5 OTHER_CHAR,
        L_OTHER6 OTHER_CHAR,
        L_OTHER7 OTHER_CHAR,
        L_OTHER8 OTHER_CHAR,
        L_OTHER9 OTHER_CHAR,
        L_TAX_RATE DOUBLE PRECISION,
        L_TAX_AMOUNT NUMERIC(9, 2),
        H_FREIGHT NUMERIC(9, 2),
        H_TERMS VARCHAR(20),
        H_AMOUNT_PAID NUMERIC(9, 2),
        H_PAYMENT_METHOD VARCHAR(40),
        L_BATCH_LINE INTEGER,
        P_AUST_POST_4STATE_ID VARCHAR(255),
        H_OTHER_NUM1 STANDARD_COST,
        H_OTHER_NUM2 STANDARD_COST,
        L_OTHER_QTY1 QTY,
        L_OTHER_QTY2 QTY,
        L_SPECIAL_INSTRUCTIONS3 COMMENTS,
        H_REMARKS1 DESCR,
        H_REMARKS2 DESCR,
        H_REMARKS3 DESCR,
        H_REMARKS4 DESCR,
        H_REMARKS5 DESCR,
        H_REMARKS6 DESCR,
        H_FOOTER1 DESCR,
        H_FOOTER2 DESCR,
        H_FOOTER3 DESCR,
        H_FOOTER4 DESCR,
        H_FOOTER5 DESCR,
        P_NO_PERSON_UPD CHAR(1),
        H_WH_ID WH_ID,
        RECORD_ID INTEGER NOT NULL);

/* Table: PICK_QTYS, Owner: SYSDBA */
CREATE TABLE PICK_QTYS (PICK_LABEL_NO PICK_LABEL_NO NOT NULL,
        DESCRIPTION DESCRIPTION,
        PICK_ORDER PICK_ORDER,
        PICK_ORDER_QTY QTY,
        PROD_ID PRODUCT,
        SSN_ID SSN_ID,
        UOM CODE_TWO,
        PICK_LINE_STATUS STATUS,
        DESPATCH_LOCATION DESPATCH_LOCATION);

/* Table: PICK_QUEUE, Owner: SYSDBA */
CREATE TABLE PICK_QUEUE (CREATE_DATE CREATE_DATE NOT NULL,
        PICK_QUEUE_STATUS CODE_TWO NOT NULL,
        SEEN_DATE TIMESTAMP,
        USER_ID USER_ID,
        PICK_ORDER PICK_ORDER,
        DEVICE_ID DEVICE_ID);

/* Table: PICK_UP, Owner: SYSDBA */
CREATE TABLE PICK_UP (INVOICE_NUMBER INVOICE_NUMBER NOT NULL,
        SSN_ID SSN_ID NOT NULL,
PRIMARY KEY (INVOICE_NUMBER, SSN_ID));

/* Table: POSTCODE_DEPOT, Owner: SYSDBA */
CREATE TABLE POSTCODE_DEPOT (POST_CODE POST_CODE NOT NULL,
        LOCALITY SUBURB,
        STATE STATE,
        COMMENTS DESCRIPTION,
        DELIVERY_OFFICE DESCRIPTION,
        PRE_SORT_INDICATOR CODE_6,
        PARCEL_ZONE CODE_6,
        BSP_NUMBER CODE_6,
        BSP_NAME DESCRIPTION,
        CATEGORY DESCRIPTION,
        COUNTRY COUNTRY default 'AU',
        DESCRIPTION DESCRIPTION,
        DEPOT_01 DEPOT_ID,
        DEPOT_02 DEPOT_ID,
        DEPOT_03 DEPOT_ID,
        DEPOT_04 DEPOT_ID,
        DEPOT_05 DEPOT_ID,
        DEPOT_06 DEPOT_ID,
        DEPOT_07 DEPOT_ID,
        DEPOT_08 DEPOT_ID,
        DEPOT_09 DEPOT_ID,
        DEPOT_10 DEPOT_ID,
        RECORD_ID RECORD_ID NOT NULL,
PRIMARY KEY (RECORD_ID));

/* Table: PRINT_REQUESTS, Owner: SYSDBA */
CREATE TABLE PRINT_REQUESTS (MESSAGE_ID MESSAGE_ID NOT NULL,
        DEVICE_ID DEVICE_ID,
        PRN_TYPE CODE,
        REQUEST_STATUS STATUS,
        PRN_DATA CODE_32K,
        PRN_COPY QTY,
        BASE_FILE_NAME DESCR,
        PRN_DATE TRN_DATE,
        PERSON_ID PERSON,
        ERROR_TEXT ERROR_TEXTV4,
        FROM_DEVICE_ID DEVICE_ID,
        SEND_COPY QTY default 1,
PRIMARY KEY (MESSAGE_ID));

/* Table: PRINT_REQUESTS_ARCHIVE, Owner: SYSDBA */
CREATE TABLE PRINT_REQUESTS_ARCHIVE (MESSAGE_ID MESSAGE_ID,
        DEVICE_ID DEVICE_ID,
        PRN_TYPE CODE,
        PRN_COPY QTY,
        BASE_FILE_NAME DESCR,
        PRN_DATE TRN_DATE,
        PERSON_ID PERSON,
        REQUEST_STATUS STATUS,
        ERROR_TEXT ERROR_TEXTV4,
        PRN_DATA CODE_32K,
        SEND_COPY QTY default 1);

/* Table: PRINT_SELECTION, Owner: SYSDBA */
CREATE TABLE PRINT_SELECTION (FIELD_ID FIELD_ID NOT NULL,
        SSN_ID SSN_ID,
        ACCESSION ACCESSION,
        PRINTED PRINTED);

/* Table: PRIVILIGES, Owner: SYSDBA */
CREATE TABLE PRIVILIGES (CODE PRIVILIGE_CODE NOT NULL,
        DESCRIPTION DESCRIPTION,
CONSTRAINT PRIVILIGES_PX PRIMARY KEY (CODE));

/* Table: PRODUCT_CONDITION, Owner: SYSDBA */
CREATE TABLE PRODUCT_CONDITION (CODE CODE_ONE NOT NULL,
        DESCRIPTION DESCRIPTION NOT NULL,
        LAST_UPDATE_DATE LAST_UPDATE_DATE,
PRIMARY KEY (CODE, DESCRIPTION));

/* Table: PRODUCT_COND_STATUS, Owner: SYSDBA */
CREATE TABLE PRODUCT_COND_STATUS (SSN_ID SSN_ID NOT NULL,
        CODE CODE_ONE NOT NULL,
        DESCRIPTION DESCRIPTION NOT NULL,
        ORIGINAL_TEST VARCHAR(1) NOT NULL,
        LAST_UPDATE_DATE LAST_UPDATE_DATE,
PRIMARY KEY (SSN_ID, CODE, DESCRIPTION, ORIGINAL_TEST));

/* Table: PRODUCT_DESCRIPTION, Owner: SYSDBA */
CREATE TABLE PRODUCT_DESCRIPTION (TYPE_CODE TYPE_CODE NOT NULL,
        FIELD_CODE FIELD_CODE NOT NULL,
        DESCRIPTION DESCRIPTION NOT NULL,
        LEGACY_CODE LEGACY_CODE,
PRIMARY KEY (TYPE_CODE, FIELD_CODE, DESCRIPTION));

/* Table: PRODUCT_KIT, Owner: SYSDBA */
CREATE TABLE PRODUCT_KIT (KIT_ID PRODUCT NOT NULL,
        PROD_ID PRODUCT NOT NULL,
        CREATED_BY USER_ID,
        CREATE_DATE CREATE_DATE,
        STATUS STATUS,
        PROD_QTY KIT_QTY,
        KIT_LINE_NO INTEGER,
        TOTAL_LINES INTEGER,
PRIMARY KEY (KIT_ID, PROD_ID));

/* Table: PRODUCT_LAYOUT, Owner: SYSDBA */
CREATE TABLE PRODUCT_LAYOUT (CODE CODE NOT NULL,
        DESCRIPTION DESCRIPTION,
        SEQUENCE SEQUENCE_NO,
        LEGACY_LENGTH QTY,
PRIMARY KEY (CODE));

/* Table: PROD_COUNT, Owner: SYSDBA */
CREATE TABLE PROD_COUNT (PROD_ID PRODUCT NOT NULL,
        WH_ID WH_ID NOT NULL,
        LOCN_ID LOCN_ID NOT NULL,
        COUNT1_QTY QTY,
        COUNTED1_BY USER_ID,
        COUNTED1_DATE CREATE_DATE,
        COUNT2_QTY QTY,
        COUNTED2_BY USER_ID,
        COUNTED2_DATE CREATE_DATE,
        EXPORTED VALUE_TF,
PRIMARY KEY (WH_ID, LOCN_ID, PROD_ID));

/* Table: PROD_COUNT_HIST, Owner: SYSDBA */
CREATE TABLE PROD_COUNT_HIST (CREATE_DATE CREATE_DATE NOT NULL,
        PROD_ID PRODUCT NOT NULL,
        WH_ID WH_ID NOT NULL,
        LOCN_ID LOCN_ID NOT NULL,
        COUNT1_QTY QTY,
        COUNTED1_BY USER_ID,
        COUNTED1_DATE CREATE_DATE,
        COUNT2_QTY QTY,
        COUNTED2_BY USER_ID,
        COUNTED2_DATE CREATE_DATE,
        EXPORTED VALUE_TF);

/* Table: PROD_EAN, Owner: SYSDBA */
CREATE TABLE PROD_EAN (PROD_EAN PROD_EAN NOT NULL,
        PROD_EAN_EXTENSION PROD_EAN_EXTENSION NOT NULL,
        PROD_ID PRODUCT NOT NULL,
        GS1_GTIN8_100 IMAGE,
        GS1_GTIN13_80 IMAGE,
        GS1_GTIN13_100 IMAGE,
        GS1_GTIN13_OTHER IMAGE,
        GS1_CODE128 IMAGE,
        GS1_DATABAR IMAGE,
PRIMARY KEY (PROD_EAN, PROD_EAN_EXTENSION));

/* Table: PROD_PROFILE, Owner: SYSDBA */
CREATE TABLE PROD_PROFILE (PROD_ID PRODUCT NOT NULL,
        SHORT_DESC SHORT_DESC NOT NULL,
        LONG_DESC LONG_DESC,
        ALTERNATE_ID PRODUCT,
        PROD_TYPE CODE_TWO,
        STOCK STOCK,
        SPECIAL_INSTR SPECIAL_INSTR,
        PROD_IMAGE PROD_IMAGE,
        HOME_LOCN_ID LOCN_ID,
        SUPPLIER_NO1 SUPPLIER_NO,
        SUPPLIER_NO2 SUPPLIER_NO,
        SUPPLIER_NO3 SUPPLIER_NO,
        SUPPLIER_NO1_PROD SUPPLIER_NO_PROD,
        SUPPLIER_NO2_PROD SUPPLIER_NO_PROD,
        SUPPLIER_NO3_PROD SUPPLIER_NO_PROD,
        SUPPLIER_PREFER SUPPLIER_PREFER,
        UOM CODE_TWO,
        ISSUE_UOM CODE_TWO,
        ORDER_UOM CODE_TWO,
        ISSUE_PER_ORDER_UNIT ISSUE_PER_ORDER_UNIT,
        PALLET_CFG_C CODE_TWO,
        PERM_LEVEL PERM_LEVEL,
        SSN_TRACK SSN_TRACK,
        TOG_C CODE_TWO,
        DEFAULT_ISSUE_QTY QTY,
        BACK_ORDER_QTY QTY,
        RESERVED_QTY QTY,
        MAX_QTY QTY,
        MIN_QTY QTY,
        REORDER_QTY QTY,
        MAX_ISSUE_QTY QTY,
        STANDARD_COST STANDARD_COST,
        LAST_UPDATE_DATE LAST_UPDATE_DATE,
        LAST_UPDATE_BY USER_ID,
        SALE_PRICE UNIT_PRICE,
        PROD_RETRIEVE_STATUS VALUE_TF,
        COMPANY_ID COMPANY,
        ISSUE_PER_INNER_UNIT ISSUE_PER_ORDER_UNIT,
        ORDER_WEIGHT WEIGHT,
        NET_WEIGHT_UOM CODE_TWO,
        ORDER_WEIGHT_UOM CODE_TWO,
        ISSUE INTEGER,
        INNER_UOM CODE_TWO,
        INNER_WEIGHT_UOM CODE_TWO,
        PALLET_CFG_INNER CODE_TWO,
        PALLET_CFG_ALTERNATE CODE_TWO,
        NET_WEIGHT WEIGHT_DECIMAL,
        INNER_WEIGHT WEIGHT_DECIMAL,
        ALTERNATE_COMPANY_ID COMPANY,
        VOLUME VOLUME,
        UOM_SIZE VARCHAR(10),
        MAX_WEIGHT_UNDER PERCENT,
        MAX_WEIGHT_OVER PERCENT,
        DIMENSION_X NUMERIC(9, 3),
        DIMENSION_Y NUMERIC(9, 3),
        DIMENSION_Z NUMERIC(9, 3),
        DIMENSION_X_UOM CODE_TWO,
        DIMENSION_Y_UOM CODE_TWO,
        DIMENSION_Z_UOM CODE_TWO,
        EXPORT_CATEGORY CHAR(1),
        PICK_IMPORT CODE_ONE  default 'T',
        TEMPERATURE_ZONE CODE_TWO,
        TAX_APPLICABLE VALUE_TF,
        SSN_TYPE SSN_TYPE,
        PP_PACKAGE_TYPE CODE_TWO,
        PP_MATERIAL_SAFETY_DATA VALUE_TF,
        PP_MATERIAL_SAFETY_DATA_NO CODE,
        PP_HAZARD_STATUS HAZARD_STATUS,
        PP_HAZARD_WARNING HAZARD_WARNING,
        PP_HAZARD_IMAGE1 IMAGE_NO,
        PP_HAZARD_IMAGE2 IMAGE_NO,
        PP_HAZARD_IMAGE3 IMAGE_NO,
        VOLUME_UOM UOM,
        ORIENTATION CODE,
        PROD_TYPE_COMMENT CODE_255,
        HAZARD_TYPE CODE,
        ORDER_QTY QTY_F,
        MTHS_ONORDER QTY_F,
        SALE_PER_MTH QTY_F,
        LOCN_VISIT_PER_MTH QTY_F,
        PERCENT_HIT_MTH QTY_F,
        MIN_LOT_SIZE QTY_F,
        SALE_VOL_PER_MTH QTY_F,
        TURNOVER_PER_MTH QTY_F,
        STORE_TYPE CODE,
        PROD_LOCN_SEQ LOCN_SEQ,
        ALT_PROD_TYPE CODE,
        ALT_HOME_LOCN LOCN_ID,
        ALT_HOME_LOCN2 LOCN_ID,
        ALT_HOME_LOCN3 LOCN_ID,
        SIZE_TYPE CODE,
        PACK_WEIGHT WEIGHT_DECIMAL3,
        LEGACY_LEDGER_SALE_CODE CODE,
        LEGACY_LEDGER_DEPOSIT_CODE CODE,
        LEGACY_LEDGER_PURCHASE_CODE CODE,
        LEGACY_OTHER1 INTEGER,
        LEGACY_OTHER2 INTEGER,
        STANDARD_COST_UPDATED LAST_UPDATE_DATE,
        STANDARD_COST_UPDATED_BY USER_ID,
        PREV_STANDARD_COST_UPDATED LAST_UPDATE_DATE,
        PREV_STANDARD_COST STANDARD_COST,
        SALE_PRICE_UPDATED LAST_UPDATE_DATE,
        SALE_PRICE_UPDATED_BY USER_ID,
        PREV_SALE_PRICE_UPDATED LAST_UPDATE_DATE,
        PREV_SALE_PRICE UNIT_PRICE,
        DISCOUNT_CODE CODE_TWO,
        LEGACY_ID PRODUCT,
        STOCK_ON_HAND QTY,
        MIN_STOCK_DAYS QTY,
        MAX_STOCK_DAYS QTY,
        REORDER_STOCK_DAYS QTY,
        LEADTIME_NO1 QTY,
        LEADTIME_NO2 QTY,
        LEADTIME_NO3 QTY,
PRIMARY KEY (PROD_ID));

/* Table: PROD_SUPPLIER, Owner: SYSDBA */
CREATE TABLE PROD_SUPPLIER (SUPPLIER_ID SUPPLIER_NO NOT NULL,
        PROD_ID PRODUCT NOT NULL,
        SUPPLIER_PROD SUPPLIER_NO_PROD,
        LAST_UPDATE_DATE LAST_UPDATE_DATE,
        LAST_UPDATE_BY USER_ID,
PRIMARY KEY (PROD_ID, SUPPLIER_ID));

/* Table: PROD_TYPE, Owner: SYSDBA */
CREATE TABLE PROD_TYPE (CODE CODE_TWO NOT NULL,
        DESCRIPTION DESCRIPTION,
PRIMARY KEY (CODE));

/* Table: PROJECT, Owner: SYSDBA */
CREATE TABLE PROJECT (PROJECT_ID VARCHAR(10) NOT NULL,
        DESCRIPTION DESCRIPTION,
PRIMARY KEY (PROJECT_ID));

/* Table: PURCHASE_LINE_CANCEL, Owner: SYSDBA */
CREATE TABLE PURCHASE_LINE_CANCEL (PURCHASE_ORDER PURCHASE_ORDER,
        PERSON_ID PERSON,
        REQUISITION_NO REQUISITION_NO,
        PO_DATE PO_DATE,
        PO_REVISION_NO PO_REVISION_NO,
        COMPANY_ID COMPANY,
        DIVISION_ID DIVISION,
        PO_STATUS STATUS,
        COMMENTS COMMENTS,
        PO_PRINTED PO_PRINTED,
        USER_ID USER_ID,
        ORDER_TYPE CODE_TWO,
        PO_LEGACY_DATE PO_DATE,
        PO_CURRENCY VARCHAR(20),
        PO_DUE_DATE PO_DUE_DATE,
        PO_LEGACY_INTERNAL_ID VARCHAR(20),
        PO_RECEIVE_WH_ID VARCHAR(20),
        PO_LEGACY_MEMO VARCHAR(1024),
        PO_LEGACY_STATUS VARCHAR(50),
        PO_LEGACY_RECVD_DATE PO_RECEIVE_DATE,
        PO_SHIP_TO_ADDRESS3 ADDRESS_LINE,
        PO_SHIP_TO_ADDRESS4 ADDRESS_LINE,
        PO_SHIP_TO_ADDRESS5 ADDRESS_LINE,
        PO_CREATED_BY_NAME VARCHAR(40),
        PO_RECEIVE_WH_NAME VARCHAR(50),
        PO_LEGACY_STATUS_ID VARCHAR(2),
        PO_SHIP_TO_ATTENSION LEGACY_ADDRESS_LINE,
        PO_SHIP_TO_ADDRESSEE LEGACY_ADDRESS_LINE,
        PO_SHIP_TO_PHONE ADDRESS_LINE,
        PO_SHIP_TO_ADDRESS1 LEGACY_ADDRESS_LINE,
        PO_SHIP_TO_ADDRESS2 LEGACY_ADDRESS_LINE,
        PO_SHIP_TO_SUBURB ADDRESS_LINE,
        PO_SHIP_TO_STATE ADDRESS_LINE,
        PO_SHIP_TO_POSTCODE LEGACY_POST_CODE,
        PO_SHIP_TO_COUNTRY ADDRESS_LINE,
        PO_LEGACY_CONSIGNMENT VARCHAR(10),
        PO_LEGACY_CREATED_BY_NAME VARCHAR(40),
        PO_LEGACY_OWNER DESCRIPTION,
        PO_LEGACY_OWNER_ID CODE_TWO,
        PO_LEGACY_RECV_ID INTEGER,
        PO_RECEIVER USER_ID,
        EARLIEST_DATE DATETIME,
        COST_CENTER CODE,
        PO_LEGACY_RECVD_QTY QTY,
        SUPPLIED_BY_ID CODE,
        SUPPLIER_CONTACT DESCRIPTION,
        PO_SHIP_VIA SHIP_VIA,
        PO_SHIP_VIA_SERVICE SHIP_SERVICE,
        PO_SHIPPING_METHOD CARRIER_ACCOUNT_NO,
        PO_FREIGHT_COST NUMERIC(9, 2),
        PO_CUSTOM_FEES NUMERIC(9, 2),
        PO_STORAGE_FEES NUMERIC(9, 2),
        PO_INSURANCE NUMERIC(9, 2),
        PO_AMOUNT_PAID NUMERIC(9, 2),
        PO_CONTAINER_FEES NUMERIC(9, 2),
        PO_UNLOADING_FEES NUMERIC(9, 2),
        PO_ADMIN_FEES NUMERIC(9, 2),
        PO_OTHER_FEES NUMERIC(9, 2),
        PO_TAX_AMOUNT NUMERIC(9, 2),
        PO_TAX_RATE DOUBLE PRECISION,
        PO_AMOUNT_DUE NUMERIC(9, 2),
        PO_LINE_EXTERNAL_NOTES NOTES,
        PO_LINE PO_LINE,
        PROD_ID PRODUCT,
        PO_LINE_QTY QTY,
        UNIT_PRICE UNIT_PRICE,
        UOM_ORDER CODE_TWO,
        PO_LINE_DUE_DATE PO_LINE_DUE_DATE,
        PO_LINE_STATUS STATUS,
        GST_VALUE GST_VALUE,
        GST_RATE GST_RATE,
        GST_CODE GST_CODE,
        ORIGINAL_QTY QTY,
        PO_LINE_DESCRIPTION NOTES,
        PO_LINE_OPTIONS CODE_255,
        PO_LINE_QTY_F PO_LINE_QTY_F,
        PO_LINE_LOTNO_LIST NOTES,
        PO_LINE_STATUS_TF VALUE_TF,
        PO_LINE_CUSTOMER_ID PERSON,
        PO_LINE_CUSTOMER_NAME VARCHAR(40),
        LAST_UPDATE_DATE TIMESTAMP,
        PO_REVISION_STATUS STATUS,
        PO_LEGACY_LINE PO_LINE,
        PO_LINE_DISCOUNT DOUBLE PRECISION,
        PO_LINE_TOTAL NUMERIC(9, 2),
        LAST_UPDATE_BY USER_ID,
        SSN_ID SSN_ID,
        PSL_OTHER1 OTHER_CHAR,
        PSL_OTHER2 OTHER_CHAR,
        PSL_OTHER_DATE3 OTHER_DATE,
        PSL_OTHER_DATE4 OTHER_DATE,
        PSL_STATUS STATUS,
        DEVICE_ID DEVICE_ID,
        CREATE_DATE CREATE_DATE,
        PSL_ORDER_QTY QTY,
        PSL_RECEIVED_QTY QTY,
        REASON DESCR,
        CANCEL_METHOD VARCHAR(10));

/* Table: PURCHASE_LINE_DETAIL, Owner: SYSDBA */
CREATE TABLE PURCHASE_LINE_DETAIL (PURCHASE_DETAIL_ID PURCHASE_DETAIL_ID NOT NULL,
        PO_LINE PO_LINE NOT NULL,
        PURCHASE_ORDER PURCHASE_ORDER NOT NULL,
        SSN_ID SSN_ID NOT NULL,
        PURCHASE_DETAIL_STATUS STATUS,
        QTY_RECEIVED QTY,
        USER_ID USER_ID,
        DEVICE_ID DEVICE_ID,
        CREATE_DATE CREATE_DATE,
        LAST_UPDATE_DATE LAST_UPDATE_DATE,
        PLD_LEGACY_TRY INTEGER default 0,
PRIMARY KEY (PURCHASE_DETAIL_ID));

/* Table: PURCHASE_LINE_REVISED, Owner: SYSDBA */
CREATE TABLE PURCHASE_LINE_REVISED (PURCHASE_ORDER PURCHASE_ORDER NOT NULL,
        PO_LINE PO_LINE NOT NULL,
        REQUISITION_NO REQUISITION_NO,
        PROD_ID PRODUCT,
        PO_LINE_QTY QTY,
        UNIT_PRICE UNIT_PRICE,
        UOM_ORDER CODE_TWO,
        PO_LINE_DUE_DATE PO_LINE_DUE_DATE,
        PO_LINE_STATUS STATUS,
        COMMENTS COMMENTS,
        GST_VALUE GST_VALUE,
        GST_RATE GST_RATE,
        GST_CODE GST_CODE,
        ORIGINAL_QTY QTY,
        PO_LINE_DESCRIPTION NOTES,
        PO_LINE_OPTIONS CODE_255,
        PO_LINE_QTY_F PO_LINE_QTY_F,
        PO_LINE_LOTNO_LIST NOTES,
        PO_LINE_STATUS_TF VALUE_TF default 'T',
        PO_LINE_CUSTOMER_ID PERSON,
        PO_LINE_CUSTOMER_NAME VARCHAR(40),
        PO_CURRENCY VARCHAR(20),
        LAST_UPDATE_DATE TIMESTAMP,
        PO_LEGACY_RECV_ID INTEGER,
        PO_REVISION_STATUS STATUS);

/* Table: PURCHASE_ORDER, Owner: SYSDBA */
CREATE TABLE PURCHASE_ORDER (PURCHASE_ORDER PURCHASE_ORDER NOT NULL,
        PERSON_ID PERSON,
        REQUISITION_NO REQUISITION_NO,
        PO_DATE PO_DATE,
        PO_REVISION_NO PO_REVISION_NO,
        COMPANY_ID COMPANY,
        DIVISION_ID DIVISION,
        PO_STATUS STATUS,
        COMMENTS COMMENTS,
        PO_PRINTED PO_PRINTED,
        USER_ID USER_ID,
        ORDER_TYPE CODE_TWO,
        PO_LEGACY_DATE PO_DATE,
        PO_CURRENCY VARCHAR(20),
        PO_DUE_DATE PO_DUE_DATE,
        PO_LEGACY_INTERNAL_ID VARCHAR(20),
        PO_RECEIVE_WH_ID VARCHAR(20),
        PO_LEGACY_MEMO VARCHAR(1024),
        PO_LEGACY_STATUS VARCHAR(50),
        PO_LEGACY_RECVD_DATE PO_RECEIVE_DATE,
        PO_SHIP_TO_ADDRESS3 ADDRESS_LINE,
        PO_SHIP_TO_ADDRESS4 ADDRESS_LINE,
        PO_SHIP_TO_ADDRESS5 ADDRESS_LINE,
        PO_CREATED_BY_NAME VARCHAR(40),
        PO_RECEIVE_WH_NAME VARCHAR(50),
        PO_LEGACY_STATUS_ID VARCHAR(2),
        PO_SHIP_TO_ATTENSION LEGACY_ADDRESS_LINE,
        PO_SHIP_TO_ADDRESSEE LEGACY_ADDRESS_LINE,
        PO_SHIP_TO_PHONE ADDRESS_LINE,
        PO_SHIP_TO_SUBURB ADDRESS_LINE,
        PO_SHIP_TO_STATE ADDRESS_LINE,
        PO_SHIP_TO_POSTCODE LEGACY_POST_CODE,
        PO_SHIP_TO_COUNTRY ADDRESS_LINE,
        PO_LEGACY_CREATED_BY_NAME VARCHAR(40),
        PO_SHIP_TO_ADDRESS1 LEGACY_ADDRESS_LINE,
        PO_SHIP_TO_ADDRESS2 LEGACY_ADDRESS_LINE,
        PO_LEGACY_CONSIGNMENT VARCHAR(10),
        PO_LEGACY_OWNER DESCRIPTION,
        PO_LEGACY_OWNER_ID CODE_TWO,
        PO_LEGACY_RECV_ID INTEGER,
        PO_RECEIVER USER_ID,
        EARLIEST_DATE DATETIME,
        COST_CENTER CODE,
        PO_LEGACY_RECVD_QTY QTY,
        SUPPLIED_BY_ID CODE,
        SUPPLIER_CONTACT DESCRIPTION,
        PO_SHIP_VIA SHIP_VIA,
        PO_SHIP_VIA_SERVICE SHIP_SERVICE,
        PO_SHIPPING_METHOD CARRIER_ACCOUNT_NO,
        PO_FREIGHT_COST DOUBLE PRECISION,
        PO_CUSTOM_FEES DOUBLE PRECISION,
        PO_STORAGE_FEES DOUBLE PRECISION,
        PO_INSURANCE DOUBLE PRECISION,
        PO_AMOUNT_PAID DOUBLE PRECISION,
        PO_CONTAINER_FEES DOUBLE PRECISION,
        PO_UNLOADING_FEES DOUBLE PRECISION,
        PO_ADMIN_FEES DOUBLE PRECISION,
        PO_OTHER_FEES DOUBLE PRECISION,
        PO_TAX_AMOUNT DOUBLE PRECISION,
        PO_TAX_RATE DOUBLE PRECISION,
        PO_AMOUNT_DUE DOUBLE PRECISION,
        PO_LINE_EXTERNAL_NOTES NOTES,
        PO_CONTAINER_NO CONTAINER_NO,
        PO_VESSEL_NAME DESCR,
        PO_VESSEL_NO DESCR,
        LAST_UPDATE_DATE LAST_UPDATE_DATE,
        LAST_UPDATE_BY PERSON,
        PO_LEGACY_RECEIVE_WH_ID VARCHAR(20),
        PO_LEGACY_RECEIVE_WH_NAME VARCHAR(50),
        PO_VOYAGE_NO DESCR,
        PO_GRN GRN,
        PO_RECEIVE_LOCN_ID LOCN_ID,
        PO_SHIPPING_ACCOUNT FREIGHT_ACCOUNT_NO,
PRIMARY KEY (PURCHASE_ORDER));

/* Table: PURCHASE_ORDER_LINE, Owner: SYSDBA */
CREATE TABLE PURCHASE_ORDER_LINE (PURCHASE_ORDER PURCHASE_ORDER NOT NULL,
        PO_LINE PO_LINE NOT NULL,
        REQUISITION_NO REQUISITION_NO,
        PROD_ID PRODUCT,
        PO_LINE_QTY QTY,
        UNIT_PRICE UNIT_PRICE,
        UOM_ORDER CODE_TWO,
        PO_LINE_DUE_DATE PO_LINE_DUE_DATE,
        PO_LINE_STATUS STATUS,
        COMMENTS COMMENTS,
        GST_VALUE GST_VALUE,
        GST_RATE GST_RATE,
        GST_CODE GST_CODE,
        ORIGINAL_QTY QTY,
        PO_LINE_DESCRIPTION NOTES,
        PO_LINE_OPTIONS CODE_255,
        PO_LINE_QTY_F PO_LINE_QTY_F,
        PO_LINE_LOTNO_LIST NOTES,
        PO_LINE_STATUS_TF VALUE_TF default 'T',
        PO_LINE_CUSTOMER_ID PERSON,
        PO_LINE_CUSTOMER_NAME VARCHAR(40),
        PO_CURRENCY VARCHAR(20),
        LAST_UPDATE_DATE TIMESTAMP,
        PO_LEGACY_RECV_ID INTEGER,
        PO_REVISION_STATUS STATUS,
        PO_LEGACY_LINE PO_LINE,
        EARLIEST_DATE DATETIME,
        PO_LINE_EXTERNAL_NOTES NOTES,
        PO_LINE_DISCOUNT DOUBLE PRECISION,
        PO_LINE_TOTAL DOUBLE PRECISION,
        LAST_UPDATE_BY USER_ID,
PRIMARY KEY (PURCHASE_ORDER, PO_LINE));

/* Table: PURCHASE_ORDER_LINE_TEMP, Owner: SYSDBA */
CREATE TABLE PURCHASE_ORDER_LINE_TEMP (H_PURCHASE_ORDER PURCHASE_ORDER NOT NULL,
        H_PERSON_ID PERSON,
        H_REQUISITION_NO REQUISITION_NO,
        H_PO_DATE PO_DATE,
        H_PO_REVISION_NO PO_REVISION_NO,
        H_COMPANY_ID COMPANY,
        H_DIVISION_ID DIVISION,
        H_PO_STATUS STATUS,
        H_COMMENTS COMMENTS,
        H_PO_PRINTED PO_PRINTED,
        H_USER_ID USER_ID,
        L_PURCHASE_ORDER PURCHASE_ORDER NOT NULL,
        L_PO_LINE PO_LINE NOT NULL,
        L_REQUISITION_NO REQUISITION_NO,
        L_PROD_ID PRODUCT,
        L_PO_LINE_QTY QTY_DECIMAL,
        L_UNIT_PRICE UNIT_PRICE,
        L_UOM_ORDER CODE_TWO,
        L_PO_LINE_DUE_DATE PO_LINE_DUE_DATE,
        L_PO_LINE_STATUS STATUS,
        L_COMMENTS COMMENTS,
        L_GST_VALUE GST_VALUE,
        L_GST_RATE GST_RATE,
        L_GST_CODE GST_CODE,
        P_PERSON_TYPE CODE_TWO,
        P_FIRST_NAME FIRST_NAME,
        P_LAST_NAME LAST_NAME,
        P_ADDRESS_LINE2 ADDRESS_LINE,
        P_CITY CITY,
        P_STATE STATE,
        P_POST_CODE POST_CODE,
        P_COUNTRY COUNTRY,
        H_ORDER_TYPE CODE_TWO,
        P_ADDRESS_LINE1 VARCHAR(100),
        H_COST_CENTER CODE,
        H_PO_LEGACY_MEMO VARCHAR(1024),
        H_PO_LEGACY_RECEIVE_WH_NAME VARCHAR(50),
        H_PO_LEGACY_DATE PO_DATE,
        H_PO_DUE_DATE PO_DATE,
        PP_SHORT_DESC SHORT_DESC,
        H_PO_LEGACY_RECV_QTY QTY,
        H_PO_LEGACY_RECV_DATE PO_DATE,
        H_PO_RECEIVE_WH_ID WH_ID,
        RECORD_ID INTEGER NOT NULL);

/* Table: PURCHASE_SUB_LINE, Owner: SYSDBA */
CREATE TABLE PURCHASE_SUB_LINE (RECORD_ID PURCHASE_DETAIL_ID NOT NULL,
        PURCHASE_ORDER PURCHASE_ORDER NOT NULL,
        PO_LINE PO_LINE NOT NULL,
        PSL_OTHER1 OTHER_CHAR,
        PSL_OTHER2 OTHER_CHAR,
        PSL_OTHER_DATE3 OTHER_DATE,
        PSL_OTHER_DATE4 OTHER_DATE,
        PSL_STATUS STATUS,
        USER_ID USER_ID,
        DEVICE_ID DEVICE_ID,
        CREATE_DATE CREATE_DATE,
        LAST_UPDATE_DATE LAST_UPDATE_DATE,
        LAST_UPDATE_BY PERSON,
        PSL_ORDER_QTY QTY,
        PSL_RECEIVED_QTY QTY,
        SSN_ID SSN_ID,
PRIMARY KEY (RECORD_ID));

/* Table: QTY_EAN, Owner: SYSDBA */
CREATE TABLE QTY_EAN (CODE CODE NOT NULL,
        DESCRIPTION DESCRIPTION,
        QTY QTY);

/* Table: QUERY_LAYOUT, Owner: SYSDBA */
CREATE TABLE QUERY_LAYOUT (CODE CODE NOT NULL,
        LABEL DESCRIPTION,
        SEQUENCE SEQUENCE_NO,
        DESCRIPTION VARCHAR(255));

/* Table: REPORTS, Owner: SYSDBA */
CREATE TABLE REPORTS (REPORT_ID INTEGER NOT NULL,
        NAME VARCHAR(80) NOT NULL,
        DESCRIPTION BLOB SUB_TYPE TEXT SEGMENT SIZE 80 NOT NULL,
        QUERY BLOB SUB_TYPE TEXT SEGMENT SIZE 80 NOT NULL,
        COMPANY_ID COMPANY,
        CREATE_DATE CREATE_DATE,
        CREATED_BY VARCHAR(10),
        LAST_UPDATE_DATE LAST_UPDATE_DATE,
        LAST_UPDATE_BY USER_ID,
        REPORT_FREQUENCY CHAR(1),
        REPORT_OUTPUT_FORMAT CHAR(3),
        REPORT_HEADER CODE_255,
        REPORT_FOOTER CODE_255,
        REPORT_TYPE CODE_TWO,
        REPORT_ACTIVITY QTY,
        REPORT_URI CODE_255,
        REPORT_FORMAT CODE,
        REPORT_MENU_TYPE CODE_TWO,
PRIMARY KEY (REPORT_ID));

/* Table: REPORTS_DETAIL, Owner: SYSDBA */
CREATE TABLE REPORTS_DETAIL (REPORT_ID INTEGER NOT NULL,
        REPORT_DETAIL_ID INTEGER NOT NULL,
        SEQUENCE INTEGER,
        QUERY_FIELD VARCHAR(30),
        QUERY_PROMPT VARCHAR(80),
        QUERY_DB_FIELD VARCHAR(80),
        QUERY_PROMPT_TYPE QUERY_PROMPT_TYPE,
PRIMARY KEY (REPORT_DETAIL_ID));

/* Table: REPORTS_TYPE, Owner: SYSDBA */
CREATE TABLE REPORTS_TYPE (CODE CODE NOT NULL,
        DESCRIPTION DESCR,
        RT_NOTES NOTES,
        RT_USER_ID CODE,
        RT_PASS_WORD CODE,
        RT_URL CODE_128,
        RT_STATUS STATUS,
        LAST_UPDATE_DATE LAST_UPDATE_DATE,
        LAST_UPDATE_BY USER_ID,
PRIMARY KEY (CODE));

/* Table: REPORT_TEMP, Owner: SYSDBA */
CREATE TABLE REPORT_TEMP (SSN_ID SSN_ID NOT NULL,
        LAST_CHECK LAST_CHECK,
        NEXT_CHECK NEXT_CHECK,
PRIMARY KEY (SSN_ID));

/* Table: RESUME_TEST, Owner: SYSDBA */
CREATE TABLE RESUME_TEST (SSN_ID SSN_ID,
        DESCRIPTION DESCR);

/* Table: RETICULATION, Owner: SYSDBA */
CREATE TABLE RETICULATION (CODE CODE NOT NULL,
        DESCRIPTION DESCRIPTION,
PRIMARY KEY (CODE));

/* Table: RETURN_ORDER, Owner: SYSDBA */
CREATE TABLE RETURN_ORDER (RMA RMA NOT NULL,
        PERSON_ID PERSON,
        RMA_DATE RMA_DATE,
        COMPANY_ID COMPANY,
        DIVISION_ID DIVISION,
        RETURN_STATUS STATUS,
        COMMENTS COMMENTS,
        RETURN_ORDER_PRINTED RETURN_ORDER_PRINTED,
        USER_ID USER_ID,
PRIMARY KEY (RMA));

/* Table: RETURN_ORDER_LINE, Owner: SYSDBA */
CREATE TABLE RETURN_ORDER_LINE (RMA RMA NOT NULL,
        RMA_LINE RMA_LINE NOT NULL,
        PROD_ID PRODUCT,
        RMA_LINE_QTY QTY,
        RMA_UNIT_PRICE UNIT_PRICE,
        UOM_ORDER CODE_TWO,
        RMA_LINE_DUE_DATE RMA_LINE_DUE_DATE,
        RMA_LINE_STATUS STATUS,
        COMMENTS COMMENTS,
PRIMARY KEY (RMA, RMA_LINE));

/* Table: RUN_PROCEDURES, Owner: SYSDBA */
CREATE TABLE RUN_PROCEDURES (RUN_PROCEDURE FIELD,
        DESCRIPTION DESCRIPTION,
        FIELD_TYPE VARIABLE_STATUS,
        RUN_SQL NOTES,
        TRN_TYPE TRN_TYPE);

/* Table: SALE_ORDER, Owner: SYSDBA */
CREATE TABLE SALE_ORDER (SALE_ORDER_ID VARCHAR(10) NOT NULL,
        SALE_STATUS STATUS,
        CUSTOMER_ID PERSON NOT NULL,
        PURCHASE_ORDER PURCHASE_ORDER,
        SALE_DATE TIMESTAMP,
        SHIP_DATE TIMESTAMP,
        REQUIRED_DATE TIMESTAMP,
        SHIP_TO_CONTACT CONTACT_NAME,
        SHIP_TO_PHONE PHONE_NO,
        SHIP_TO_ADDRESS1 ADDRESS_LINE,
        SHIP_TO_ADDRESS2 ADDRESS_LINE,
        SHIP_TO_CITY CITY,
        SHIP_TO_STATE STATE,
        SHIP_TO_POST_CODE POST_CODE,
        SHIP_TO_COUNTRY COUNTRY,
        SALE_PERSON PERSON,
        TERMS VARCHAR(20),
        PAYMENT_METHOD VARCHAR(20),
        SHIP_VIA VARCHAR(20),
        TAX_RATE DOUBLE PRECISION,
        SUB_TOTAL_AMOUNT NUMERIC(9, 2) DEFAULT 0.00,
        FREIGHT NUMERIC(9, 2) DEFAULT 0.00,
        AMOUNT_PAID NUMERIC(9, 2) DEFAULT 0.00,
        PRINT_DATE TIMESTAMP,
        COMMENTS COMMENTS,
PRIMARY KEY (SALE_ORDER_ID));

/* Table: SALE_ORDER_LINE, Owner: SYSDBA */
CREATE TABLE SALE_ORDER_LINE (SALE_ORDER_ID VARCHAR(10) NOT NULL,
        SALE_ORDER_LINE_NO INTEGER NOT NULL,
        PROD_ID PRODUCT,
        SALE_PRICE NUMERIC(9, 2),
        QTY_ORDER INTEGER DEFAULT 1,
        DISCOUNT DOUBLE PRECISION,
PRIMARY KEY (SALE_ORDER_ID, SALE_ORDER_LINE_NO));

/* Table: SESSION, Owner: SYSDBA */
CREATE TABLE SESSION (DEVICE_ID DEVICE_ID NOT NULL,
        CODE CODE NOT NULL,
        DESCRIPTION VARCHAR(255),
        CREATE_DATE CREATE_DATE,
        EXPIRY_DATE TIMESTAMP,
PRIMARY KEY (DEVICE_ID, CODE));

/* Table: SHELFS, Owner: SYSDBA */
CREATE TABLE SHELFS (BAY_SEQ CODE_TWO NOT NULL,
        SHELF_SEQ CODE_TWO NOT NULL,
        NAME NAME,
PRIMARY KEY (BAY_SEQ, SHELF_SEQ));

/* Table: SKILL, Owner: SYSDBA */
CREATE TABLE SKILL (CODE VARCHAR(10) NOT NULL,
        DESCRIPTION VARCHAR(50),
        SKILL_TYPE CHAR(2),
        PUBLISH CHAR(1),
        CREATED_DATE TIMESTAMP,
        CREATED_BY PERSON,
        COMPULSORY_SKILL CHAR(1),
PRIMARY KEY (CODE));

/* Table: SKILL_PASS, Owner: SYSDBA */
CREATE TABLE SKILL_PASS (CODE CODE NOT NULL,
        DESCRIPTION DESCRIPTION);

/* Table: SSN, Owner: SYSDBA */
CREATE TABLE SSN (SSN_ID SSN_ID NOT NULL,
        WH_ID WH_ID,
        LOCN_ID LOCN_ID,
        PREV_LOCN_ID LOCN_ID,
        PARENT_LOCN_ID LOCN_ID,
        HOME_LOCN_ID LOCN_ID,
        SSN_DESCRIPTION SSN_DESCRIPTION,
        ALT_NAME ALT_NAME,
        SSN_TYPE SSN_TYPE,
        GENERIC GENERIC,
        BRAND BRAND,
        MODEL MODEL,
        COST_CENTER COST_CENTER,
        DEPARTMENT_ID DEPARTMENT,
        RETICULATION RETICULATION,
        PRODUCT EXTERNAL_PRODUCT,
        SERIAL_NUMBER SERIAL_NUMBER,
        COMPANY_ID COMPANY,
        DIVISION_ID DIVISION,
        PROD_ID PRODUCT,
        STORAGE_UOM CODE_TWO,
        NET_WEIGHT WEIGHT,
        ORIGINAL_QTY QTY,
        CURRENT_QTY QTY,
        USE_BY_DATE USE_BY_DATE,
        LOT_BATCH_NO SERIAL_NUMBER,
        LAST_UPDATE_DATE LAST_UPDATE_DATE,
        LAST_UPDATE_BY USER_ID,
        LAST_UPDATE_DEVICE_ID DEVICE_ID,
        CREATE_DATE CREATE_DATE,
        CREATED_BY USER_ID,
        STATUS_SSN STATUS,
        STATUS_SSN_DATE STATUS_SSN_DATE,
        STATUS_CODE STATUS_CODE,
        STATUS_CODE_DATE STATUS_CODE_DATE,
        PARENT_SSN_ID PARENT_SSN_ID,
        OLD_SSN_ID SSN_ID,
        PREV_WH_ID WH_ID,
        LEGACY_ID LEGACY_ID,
        AUDITED AUDITED,
        AUDIT_DATE AUDIT_DATE,
        AUDITED_QTY QTY,
        AUDITED_BY AUDITED_BY,
        AUDIT_RECOUNT_DATE AUDIT_RECOUNT_DATE,
        AUDIT_RECOUNT_QTY QTY,
        AUDIT_RECOUNT_BY AUDIT_RECOUNT_BY,
        SUPPLIER_ID SUPPLIER_ID,
        PURCHASE_DATE PURCHASE_DATE,
        PURCHASE_PRICE PURCHASE_PRICE,
        PURCHASE_QTY QTY,
        PO_RECEIVE_DATE PO_RECEIVE_DATE,
        PO_ORDER PO_ORDER,
        PO_LINE PO_LINE,
        GRN GRN,
        LICENCE_NUMBER LICENCE_NUMBER,
        SSN_GROUP SSN_GROUP,
        LABEL_LOCN LABEL_LOCN,
        LABEL_DATE LABEL_DATE,
        ACCESSION ACCESSION,
        INTO_DATE INTO_DATE,
        DT_PREV_INTO INTO_DATE,
        PREV_LOCN_DATE PREV_LOCN_DATE,
        PDF_DESCRIPTION PDF_DESCRIPTION,
        NOTES NOTES,
        OTHER1 OTHER_CHAR,
        OTHER2 OTHER_CHAR,
        OTHER3 OTHER_CHAR,
        OTHER4 OTHER_CHAR,
        OTHER5 OTHER_CHAR,
        OTHER6 OTHER_CHAR,
        OTHER7 OTHER_CHAR,
        OTHER8 OTHER_CHAR,
        OTHER9 OTHER_CHAR,
        OTHER10 OTHER_CHAR,
        OTHER11 OTHER_CHAR,
        OTHER12 OTHER_CHAR,
        OTHER13 OTHER_CHAR,
        OTHER14 OTHER_CHAR,
        OTHER15_DATE OTHER_DATE,
        OTHER16_DATE OTHER_DATE,
        OTHER17_QTY QTY,
        OTHER18_QTY QTY,
        OTHER19 OTHER_CHAR,
        OTHER20 OTHER_CHAR,
        COLLECTION_NAME COLLECTION_NAME,
        COLLECTION_TYPE COLLECTION_TYPE,
        FILE_NUMBER FILE_NUMBER,
        HAZARD_STATUS HAZARD_STATUS,
        HAZARD_WARNING HAZARD_WARNING,
        HAZARD_IMAGE1 IMAGE_NO,
        HAZARD_IMAGE2 IMAGE_NO,
        HAZARD_IMAGE3 IMAGE_NO,
        OBJECT_NAME OBJECT_NAME,
        OBJECT_NUMBER OBJECT_NUMBER,
        OBJECT_IMAGE1 IMAGE_NO,
        OBJECT_IMAGE2 IMAGE_NO,
        OBJECT_IMAGE3 IMAGE_NO,
        OBJECT_STATUS STATUS,
        LOAN_STATUS STATUS,
        LOAN_PERIOD_NO PERIOD_NO,
        LOAN_PERIOD LOAN_PERIOD,
        LOAN_SAFETY_CHECK LOAN_SAFETY_CHECK,
        LOAN_LAST_SAFETY_CHECK_DATE LOAN_LAST_SAFETY_CHECK_DATE,
        LOAN_SAFETY_PERIOD_NO PERIOD_NO,
        LOAN_SAFETY_PERIOD LOAN_SAFETY_PERIOD,
        LOAN_CALIBRATE_CHECK LOAN_CALIBRATE_CHECK,
        LOAN_LAST_CALIBRATE_CHECK_DATE LOAN_LAST_CALIBRATE_CHECK_DATE,
        LOAN_CALIBRATE_PERIOD_NO PERIOD_NO,
        LOAN_CALIBRATE_PERIOD LOAN_CALIBRATE_PERIOD,
        ACQUISITION_COST ACQUISITION_COST,
        LIFE_PERIODS1 PERIOD_NO,
        LIFE_PERIODS2 PERIOD_NO,
        LIFE_UNITS_USED LIFE_UNITS_USED,
        LIFE_UNITS LIFE_UNITS,
        LEASED LEASED,
        LEASE_EXPIRY_DATE LEASE_EXPIRY_DATE,
        LEASOR LEASOR,
        IP_ADDRESS IP_ADDRESS,
        WARRANTY_EXPIRY_DATE WARRANTY_EXPIRY_DATE,
        INSURED_VALUE INSURED_VALUE,
        VERSION VERSION,
        VERSION_DATE VERSION_DATE,
        FREEZE_VALUE1 FREEZE_VALUE,
        FREEZE_VALUE2 FREEZE_VALUE,
        FREEZE_VALUE3 FREEZE_VALUE,
        FREEZE_DATE FREEZE_DATE,
        DEPSTART_PERIOD1 PERIOD_KEY,
        DEPSTART_PERIOD2 PERIOD_KEY,
        DEPEND_PERIOD1 PERIOD_KEY,
        DEPEND_PERIOD2 PERIOD_KEY,
        DISPOSED DISPOSED,
        DISPOSAL_COST DISPOSAL_COST,
        DISPOSAL_PRICE DISPOSAL_PRICE,
        DISPOSAL_DATE DISPOSAL_DATE,
        DISPOSAL_NOTES DISPOSAL_NOTES,
        COMMISSIONED_DATE COMMISSIONED_DATE,
        GOV_TAX GOV_TAX,
        DEPRECIATE_DATE DEPRECIATE_DATE,
        DEPRECIATE DEPRECIATE,
        BOOK_VALUE1 BOOK_VALUE,
        BOOK_VALUE2 BOOK_VALUE,
        BOOK_VALUE3 BOOK_VALUE,
        DEPRECIATION_LIMIT DEPRECIATION_LIMIT,
        DEPRECIATED_VALUE1 DEPRECIATED_VALUE,
        DEPRECIATED_VALUE2 DEPRECIATED_VALUE,
        DEPRECIATED_VALUE3 DEPRECIATED_VALUE,
        TERMINATION_VALUE TERMINATION_VALUE,
        QUESTION_ID RECORD_ID,
        ANSWER_ID RECORD_ID,
        PRINTED_BY PRINTED_BY,
        NET_WEIGHT_UOM CODE_TWO,
        DEPRECIATE_METHOD1 METHOD_CODE10,
        DEPRECIATE_METHOD2 METHOD_CODE10,
        DEPRECIATE_METHOD3 METHOD_CODE10,
        SSN_SUB_TYPE CODE,
        SSN_TAX_APPLICABLE VALUE_TF,
        SSN_SALE_PRICE UNIT_PRICE,
        SSN_SALE_UOM CODE_TWO,
        SSN_ORIGINAL_QTY_F KIT_QTY,
        LOAN_SAFETY_TAG_COLOUR CODE,
        DIMENSION_X NUMERIC(9, 3),
        DIMENSION_Y NUMERIC(9, 3),
        DIMENSION_Z NUMERIC(9, 3),
        DIMENSION_X_UOM CODE_TWO,
        DIMENSION_Y_UOM CODE_TWO,
        DIMENSION_Z_UOM CODE_TWO,
        DIMENSION_UOM CODE_TWO,
        HIRE_RATE HIRE_RATE,
        HIRE_UOM CODE_TWO,
        LOAN_COST_BASE PRICE_DECIMAL,
        LOAN_SAFETY_PASS VALUE_TF default 'F',
        LOAN_CALIBRATE_PASS VALUE_TF default 'F',
        LEGACY_LEDGER_SALE_CODE CODE,
        LEGACY_LEDGER_DEPOSIT_CODE CODE,
        LEGACY_LEDGER_PURCHASE_CODE CODE,
PRIMARY KEY (SSN_ID));

/* Table: SSN_BATCH, Owner: SYSDBA */
CREATE TABLE SSN_BATCH (SSN_ID SSN_ID NOT NULL,
        LOT_BATCH_NO SERIAL_NUMBER NOT NULL,
        DEVICE_ID DEVICE_ID,
        PERSON_ID PERSON,
        CREATE_DATE CREATE_DATE,
PRIMARY KEY (SSN_ID, LOT_BATCH_NO));

/* Table: SSN_GROUP, Owner: SYSDBA */
CREATE TABLE SSN_GROUP (SSN_GROUP SSN_GROUP NOT NULL,
        DESCRIPTION DESCRIPTION,
        FIELD1 FIELD,
        FIELD2 FIELD,
        FIELD3 FIELD,
        FIELD4 FIELD,
        FIELD5 FIELD,
        FIELD6 FIELD,
        FIELD7 FIELD,
        FIELD8 FIELD,
        FIELD9 FIELD,
        FIELD10 FIELD,
        FIELD11 FIELD,
        FIELD12 FIELD,
        FIELD13 FIELD,
        FIELD14 FIELD,
        FIELD15 FIELD,
        FIELD16 FIELD,
        DD_OTHER1 TRUEFALSE,
        DD_OTHER2 TRUEFALSE,
        DD_OTHER3 TRUEFALSE,
        DD_OTHER4 TRUEFALSE,
        DD_OTHER5 TRUEFALSE,
        DD_OTHER6 TRUEFALSE,
        DD_OTHER7 TRUEFALSE,
        DD_OTHER8 TRUEFALSE,
        DD_OTHER9 TRUEFALSE,
        DD_OTHER10 TRUEFALSE,
        DD_OTHER11 TRUEFALSE,
        DD_OTHER12 TRUEFALSE,
        DD_OTHER13 TRUEFALSE,
        DD_OTHER14 TRUEFALSE,
        DD_OTHER15 TRUEFALSE,
        DD_OTHER16 TRUEFALSE,
        DD_OTHER17 TRUEFALSE,
        DD_OTHER18 TRUEFALSE,
        DD_OTHER19 TRUEFALSE,
        DD_OTHER20 TRUEFALSE,
        RM_OTHER1 TRUEFALSE,
        RM_OTHER2 TRUEFALSE,
        RM_OTHER3 TRUEFALSE,
        RM_OTHER4 TRUEFALSE,
        RM_OTHER5 TRUEFALSE,
        RM_OTHER6 TRUEFALSE,
        RM_OTHER7 TRUEFALSE,
        RM_OTHER8 TRUEFALSE,
        RM_OTHER9 TRUEFALSE,
        RM_OTHER10 TRUEFALSE,
        RM_OTHER11 TRUEFALSE,
        RM_OTHER12 TRUEFALSE,
        RM_OTHER13 TRUEFALSE,
        RM_OTHER14 TRUEFALSE,
        RM_OTHER15 TRUEFALSE,
        RM_OTHER16 TRUEFALSE,
        RM_OTHER17 TRUEFALSE,
        RM_OTHER18 TRUEFALSE,
        RM_OTHER19 TRUEFALSE,
        RM_OTHER20 TRUEFALSE,
        FIELD17 FIELD,
        FIELD18 FIELD,
        FIELD19 FIELD,
        FIELD20 FIELD,
        FIELD21 FIELD,
        FIELD22 FIELD,
        DD_OTHER21 TRUEFALSE,
        DD_OTHER22 TRUEFALSE,
        RM_OTHER21 TRUEFALSE,
        RM_OTHER22 TRUEFALSE,
        FIELD_SSN_TYPE FIELD,
        FIELD_GENERIC FIELD,
        FIELD_BRAND FIELD,
        FIELD_MODEL FIELD,
        FIELD_SUB_TYPE FIELD,
        FIELD23 FIELD,
        FIELD24 FIELD,
        FIELD25 FIELD,
        FIELD26 FIELD,
        FIELD27 FIELD,
        FIELD28 FIELD,
        FIELD29 FIELD,
        FIELD30 FIELD,
        DD_OTHER23 TRUEFALSE,
        DD_OTHER24 TRUEFALSE,
        DD_OTHER25 TRUEFALSE,
        DD_OTHER26 TRUEFALSE,
        DD_OTHER27 TRUEFALSE,
        DD_OTHER28 TRUEFALSE,
        DD_OTHER29 TRUEFALSE,
        DD_OTHER30 TRUEFALSE,
        RM_OTHER23 TRUEFALSE,
        RM_OTHER24 TRUEFALSE,
        RM_OTHER25 TRUEFALSE,
        RM_OTHER26 TRUEFALSE,
        RM_OTHER27 TRUEFALSE,
        RM_OTHER28 TRUEFALSE,
        RM_OTHER29 TRUEFALSE,
        RM_OTHER30 TRUEFALSE,
CONSTRAINT OBJECT_GROUP_PX PRIMARY KEY (SSN_GROUP));

/* Table: SSN_HIST, Owner: SYSDBA */
CREATE TABLE SSN_HIST (RECORD_ID RECORD_ID NOT NULL,
        WH_ID WH_ID,
        LOCN_ID LOCN_ID,
        SSN_ID SSN_ID NOT NULL,
        TRN_DATE TRN_DATE NOT NULL,
        TRN_TYPE TRN_TYPE NOT NULL,
        TRN_CODE TRN_CODE NOT NULL,
        ERROR_TEXT ERROR_TEXT,
        REFERENCE REFERENCE,
        QTY QTY,
        SUB_LOCN_ID LOCN_ID,
        DEVICE_ID DEVICE_ID,
        PERSON_ID PERSON,
PRIMARY KEY (RECORD_ID));

/* Table: SSN_ITEM_CLASS, Owner: SYSDBA */
CREATE TABLE SSN_ITEM_CLASS (SSN_ID SSN_ID NOT NULL,
        ITEM_CLASS_CODE CODE_ONE NOT NULL,
        CLASSIFICATION_DATE DATETIME,
        CLASSIFIED_BY PERSON);

/* Table: SSN_LEGACY, Owner: SYSDBA */
CREATE TABLE SSN_LEGACY (SSN_ID SSN_ID NOT NULL,
        LEGACY_ID LEGACY_ID NOT NULL,
PRIMARY KEY (SSN_ID, LEGACY_ID));

/* Table: SSN_MOVES, Owner: SYSDBA */
CREATE TABLE SSN_MOVES (SSN_ID SSN_ID NOT NULL,
        WH_ID WH_ID NOT NULL,
        LOCN_ID LOCN_ID NOT NULL,
        MOVE_PERIOD MOVE_PERIOD,
        MOVE_DATE MOVE_DATE NOT NULL,
        MOVE_QTY QTY,
        MOVE_DIRECTION MOVE_DIRECTION,
        MOVE_REFERENCE CODE_TWO,
        DATA_STATUS STATUS,
        DEVICE_ID DEVICE_ID,
        USER_ID USER_ID,
        DATA_SOURCE DATA_SOURCE,
        CREATED_BY USER_ID,
PRIMARY KEY (SSN_ID, WH_ID, LOCN_ID, MOVE_DATE));

/* Table: SSN_MOVES_REF, Owner: SYSDBA */
CREATE TABLE SSN_MOVES_REF (CODE CODE_TWO NOT NULL,
        DESCRIPTION DESCRIPTION,
PRIMARY KEY (CODE));

/* Table: SSN_PRODUCT, Owner: SYSDBA */
CREATE TABLE SSN_PRODUCT (CODE CODE NOT NULL,
        DESCRIPTION DESCRIPTION,
PRIMARY KEY (CODE));

/* Table: SSN_SERIAL, Owner: SYSDBA */
CREATE TABLE SSN_SERIAL (SSN_ID SSN_ID NOT NULL,
        SERIAL_NUMBER SERIAL_NUMBER NOT NULL,
        DEVICE_ID DEVICE_ID,
        PERSON_ID PERSON,
        CREATE_DATE CREATE_DATE,
PRIMARY KEY (SSN_ID, SERIAL_NUMBER));

/* Table: SSN_SUB_TYPE, Owner: SYSDBA */
CREATE TABLE SSN_SUB_TYPE (SSN_TYPE SSN_TYPE NOT NULL,
        GENERIC GENERIC NOT NULL,
        CODE CODE NOT NULL,
        DESCRIPTION DESCRIPTION,
PRIMARY KEY (SSN_TYPE, GENERIC, CODE));

/* Table: SSN_TEST, Owner: SYSDBA */
CREATE TABLE SSN_TEST (SSN_ID SSN_ID,
        STATUS_TEST STATUS,
        START_DATE TIMESTAMP,
        END_DATE TIMESTAMP,
        TEST_ID INTEGER NOT NULL,
        LAST_UPDATE_DATE LAST_UPDATE_DATE,
PRIMARY KEY (TEST_ID));

/* Table: SSN_TEST_RESULTS, Owner: SYSDBA */
CREATE TABLE SSN_TEST_RESULTS (SSN_ID SSN_ID,
        TIME_STAMP DATETIME,
        QUESTION QUESTION,
        RESPONSE SHORT_DESC,
        NOTES NOTES,
        SSN_TEST_ID RECORD_ID,
        DATE_RESPONSE DATETIME,
        FIELD_TYPE VARIABLE_STATUS,
        NUMBER_RESPONSE GENERAL_FLOAT,
        TEXT_RESPONSE FIELD,
        UPDATE_FIELD FIELD,
        REPAIR_REQUIRED FLAGS,
        RUN_PROCEDURE FIELD,
        INSPECT_CATEGORY VARCHAR(1),
        INSPECT_PASS_CRITERIA VARCHAR(6),
        ORIGINAL_TEST FLAGS,
        PROCESSED FLAGS 
DEFAULT 'O',
        USER_ID USER_ID,
        QUESTION_ID RECORD_ID,
        RESPONSE_ID RECORD_ID,
        TEST_ID INTEGER);

/* Table: SSN_TYPE, Owner: SYSDBA */
CREATE TABLE SSN_TYPE (CODE CODE NOT NULL,
        DESCRIPTION DESCRIPTION,
        FIELD1 FIELD,
        FIELD2 FIELD,
        FIELD3 FIELD,
        FIELD4 FIELD,
        FIELD5 FIELD,
        FIELD6 FIELD,
        FIELD7 FIELD,
        FIELD8 FIELD,
        FIELD9 FIELD,
        FIELD10 FIELD,
        FIELD11 FIELD,
        FIELD12 FIELD,
        FIELD13 FIELD,
        FIELD14 FIELD,
        FIELD15 FIELD,
        FIELD16 FIELD,
        LEGACY_CODE LEGACY_CODE,
        PUTAWAY_LOCATION LOCN_ID,
        FIELD_SSN_TYPE FIELD,
        FIELD_GENERIC FIELD,
        FIELD_BRAND FIELD,
        FIELD_MODEL FIELD,
        FIELD_SUB_TYPE FIELD,
        DISCOUNT_PERCENT PERCENT_F default 0,
        DISCOUNT_CODE CODE_TWO,
PRIMARY KEY (CODE));

/* Table: SSN_TYPE_COND, Owner: SYSDBA */
CREATE TABLE SSN_TYPE_COND (SSN_ID SSN_ID NOT NULL,
        STATUS CODE_ONE NOT NULL,
        TYPE_CODE TYPE_CODE NOT NULL,
        TYPE_HEADER_CODE TYPE_CODE NOT NULL,
        MANDATORY CHAR(1),
        TYPE_LINE_CODE TYPE_CODE,
        NOTES NOTES,
PRIMARY KEY (SSN_ID, STATUS, TYPE_CODE, TYPE_HEADER_CODE));

/* Table: STARTRACK_DEPOT, Owner: SYSDBA */
CREATE TABLE STARTRACK_DEPOT (POST_CODE POST_CODE NOT NULL,
        LOCATION SUBURB NOT NULL,
        DEPOT DEPOT,
PRIMARY KEY (POST_CODE, LOCATION));

/* Table: STATUS_DEFS, Owner: SYSDBA */
CREATE TABLE STATUS_DEFS (CODE CODE NOT NULL,
        DESCRIPTION DESCRIPTION,
PRIMARY KEY (CODE));

/* Table: STOCKTAKE, Owner: SYSDBA */
CREATE TABLE STOCKTAKE (RECORD_ID INTEGER NOT NULL,
        ST_SSN_ID SSN_ID,
        ST_WH_ID WH_ID,
        ST_LOCN_ID LOCN_ID,
        ST_COUNT KIT_QTY,
        ST_VARIANCE KIT_QTY,
        ST_AUDIT_DATE AUDIT_DATE,
        ST_AUDIT_BY AUDITED_BY,
        ST_DEVICE_ID DEVICE_ID,
        ST_STATUS STATUS,
        ST_ACTION STATUS,
        ST_APPLIED_DATE AUDIT_DATE,
        ST_APPLIED_BY AUDITED_BY,
        ST_APPLIED_DEVICE_ID DEVICE_ID,
        ST_COMPANY_ID COMPANY,
        ST_PROD_ID PRODUCT,
PRIMARY KEY (RECORD_ID));

/* Table: STORE_AREA, Owner: SYSDBA */
CREATE TABLE STORE_AREA (CODE CODE_TWO NOT NULL,
        DESCRIPTION DESCRIPTION,
PRIMARY KEY (CODE));

/* Table: STORE_METHOD, Owner: SYSDBA */
CREATE TABLE STORE_METHOD (CODE CODE_TWO NOT NULL,
        DESCRIPTION DESCRIPTION,
PRIMARY KEY (CODE));

/* Table: STORE_TYPE, Owner: SYSDBA */
CREATE TABLE STORE_TYPE (CODE CODE_TWO NOT NULL,
        DESCRIPTION DESCRIPTION,
PRIMARY KEY (CODE));

/* Table: SYS_ASCII, Owner: SYSDBA */
CREATE TABLE SYS_ASCII (RECORD_ID INTEGER NOT NULL,
        SA_NAME CODE NOT NULL,
        SA_HEX SMALLINT NOT NULL,
        LAST_UPDATE_DATE LAST_UPDATE_DATE,
        LAST_UPDATE_BY USER_ID,
PRIMARY KEY (RECORD_ID));

/* Table: SYS_EQUIP, Owner: SYSDBA */
CREATE TABLE SYS_EQUIP (DEVICE_ID DEVICE_ID NOT NULL,
        SSN_ID SSN_ID,
        OPERATING_ZONE CODE_TWO,
        CURRENT_PERSON CURRENT_PERSON,
        CURRENT_LOGGED_ON CURRENT_LOGGED_ON,
        CREATE_DATE CREATE_DATE,
        CREATED_BY USER_ID,
        LAST_UPDATE_DATE LAST_UPDATE_DATE,
        UPDATE_USER_ID USER_ID,
        WORKING_DIRECTORY DESCR,
        DEVICE_TYPE DEVICE_TYPE,
        EQUIPMENT_DESCRIPTION_CODE CODE,
        COMPUTER_NAME DESCRIPTION,
        PARAM_CLASS_ID CODE,
        IP_ADDRESS VARCHAR(40),
        LAST_PERSON CURRENT_PERSON,
        WH_ID WH_ID,
        COMPANY_ID COMPANY,
        LOCN_ID LOCN_ID,
        COMPUTER_QUEUE DESCRIPTION,
        COMPUTER_QUEUE_SERVER DESCRIPTION,
        SOCKET_ATTEMPTS INTEGER default 1,
        SOCKET_PAUSE INTEGER default 1,
        MAC_ADDRESS CODE,
        IP6_ADDRESS CODE_128,
        DEFAULT_LP_PRINTER CHAR(2),
        DEFAULT_PR_PRINTER CHAR(2),
PRIMARY KEY (DEVICE_ID));

/* Table: SYS_HH, Owner: SYSDBA */
CREATE TABLE SYS_HH (USER_TYPE CODE_TWO NOT NULL,
        FTP_USER VARCHAR(40),
        FTP_PASSWORD VARCHAR(40),
        FTP_EXPORT VARCHAR(40),
        FTP_IMPORT VARCHAR(40),
        ROOT_PATH VARCHAR(40),
        FTP_LOG VARCHAR(40),
        FTP_EMPLOYEE_EXPORT VARCHAR(40),
        USER_MODULES CODE,
        BATCH_MODULES VARCHAR(40),
        IP_ADDRESS VARCHAR(40));

/* Table: SYS_LABEL, Owner: SYSDBA */
CREATE TABLE SYS_LABEL (RECORD_ID INTEGER NOT NULL,
        SL_NAME CODE NOT NULL,
        SL_SEQUENCE SEQUENCE_NO,
        SL_LINE CODE_255,
        SL_IMAGE PDF_DESCRIPTION,
        SL_BRAND BRAND,
        SL_MODEL MODEL,
        SL_FIRMWARE GENERIC,
        SL_NOTES NOTES,
        LAST_UPDATE_DATE LAST_UPDATE_DATE,
        LAST_UPDATE_BY USER_ID,
PRIMARY KEY (RECORD_ID));

/* Table: SYS_LABEL_VAR, Owner: SYSDBA */
CREATE TABLE SYS_LABEL_VAR (RECORD_ID INTEGER NOT NULL,
        SLV_NAME DESCR,
        SLV_EXPRESSION CODE_255,
        SLV_DEFAULT CODE_255,
        SLV_SEQUENCE SEQUENCE_NO,
        SL_NAME CODE NOT NULL,
        LAST_UPDATE_DATE LAST_UPDATE_DATE,
        LAST_UPDATE_BY USER_ID,
        SLV_PICK CODE,
PRIMARY KEY (RECORD_ID));

/* Table: SYS_MENU, Owner: SYSDBA */
CREATE TABLE SYS_MENU (RECORD_ID INTEGER NOT NULL,
        SM_MENU_ID CODE,
        SM_SUBMENU_ID CODE,
        SM_SEQUENCE SEQUENCE_NO,
        SM_TITLE CODE,
        SM_MENU_TYPE CODE NOT NULL,
        SM_NOTES NOTES,
        SM_USER_CATEGORY CODE_TWO,
        SM_DEVICE_TYPE DEVICE_TYPE,
        SM_WH_ID WH_ID,
        SM_COMPANY_ID COMPANY,
        SM_MENU_STATUS STATUS,
        LAST_UPDATE_DATE LAST_UPDATE_DATE,
        LAST_UPDATE_BY USER_ID,
        SM_MENU_ACTION CODE_255,
        SM_NAME CODE_255,
        SM_MENU_IMAGE CODE_255,
        SM_MENU_METHOD CODE_TWO,
        SM_MENU_ALT CODE_255,
PRIMARY KEY (RECORD_ID));

/* Table: SYS_MOVES, Owner: SYSDBA */
CREATE TABLE SYS_MOVES (FROM_STATUS CODE_TWO NOT NULL,
        INTO_STATUS CODE_TWO NOT NULL,
        UPDATE_FLAG CHAR(1),
        MOVE_ALLOWED VALUE_FT,
        MOVE_QUESTION_ID RECORD_ID,
PRIMARY KEY (FROM_STATUS, INTO_STATUS));

/* Table: SYS_SCREEN, Owner: SYSDBA */
CREATE TABLE SYS_SCREEN (RECORD_ID INTEGER NOT NULL,
        SS_NAME CODE NOT NULL,
        SS_SEQUENCE SEQUENCE_NO,
        SS_NOTES NOTES,
        SS_TYPE CODE,
        LAST_UPDATE_DATE LAST_UPDATE_DATE,
        LAST_UPDATE_BY USER_ID,
        SS_MENU_ID CODE,
        COMPANY_ID COMPANY,
        WH_ID WH_ID,
PRIMARY KEY (RECORD_ID));

/* Table: SYS_SCREEN_ACTION, Owner: SYSDBA */
CREATE TABLE SYS_SCREEN_ACTION (RECORD_ID INTEGER NOT NULL,
        SSA_ACTION_NAME CODE,
        SSA_SEQUENCE SEQUENCE_NO,
        SSA_NOTES NOTES,
        SSA_ACTION_STATUS STATUS,
        SSA_ACTION_TYPE CODE,
        SS_NAME CODE NOT NULL,
        SSV_NAME DESCR,
        SSA_ACTION NOTES,
        LAST_UPDATE_DATE LAST_UPDATE_DATE,
        LAST_UPDATE_BY USER_ID,
        SSA_FUNCTION DESCR,
PRIMARY KEY (RECORD_ID));

/* Table: SYS_SCREEN_BUTTON, Owner: SYSDBA */
CREATE TABLE SYS_SCREEN_BUTTON (RECORD_ID INTEGER NOT NULL,
        SSB_BUTTON_NAME CODE,
        SSB_SEQUENCE SEQUENCE_NO,
        SSB_TITLE CODE,
        SSB_NOTES NOTES,
        SSB_ACTIVE_COLOUR CODE,
        SSB_INACTIVE_COLOUR CODE,
        SSB_TAB_STATUS STATUS,
        SS_NAME CODE NOT NULL,
        SSV_NAME DESCR,
        SSB_ACTION NOTES,
        SSB_IMAGE IMAGE,
        SSB_USER_TYPE CODE,
        SSB_DEVICE_TYPE DEVICE_TYPE,
        WH_ID WH_ID,
        COMPANY_ID COMPANY,
        LAST_UPDATE_DATE LAST_UPDATE_DATE,
        LAST_UPDATE_BY USER_ID,
        SSB_MINDER_EXECUTE CODE_255,
PRIMARY KEY (RECORD_ID));

/* Table: SYS_SCREEN_COLOUR, Owner: SYSDBA */
CREATE TABLE SYS_SCREEN_COLOUR (RECORD_ID INTEGER NOT NULL,
        SSC_COLOUR_TEST_NAME CODE,
        SSC_SEQUENCE SEQUENCE_NO,
        SSC_NOTES NOTES,
        SSC_STATUS STATUS,
        SSC_OPERATOR CODE,
        SSC_VALUE1 CODE,
        SSC_VALUE2 CODE,
        SSC_COLOUR_NAME CODE,
        SS_NAME CODE NOT NULL,
        LAST_UPDATE_DATE LAST_UPDATE_DATE,
        LAST_UPDATE_BY USER_ID,
        SSC_DATA_TYPE CODE,
        SSC_DATA_TEST_TYPE CODE,
PRIMARY KEY (RECORD_ID));

/* Table: SYS_SCREEN_ORDER, Owner: SYSDBA */
CREATE TABLE SYS_SCREEN_ORDER (RECORD_ID INTEGER NOT NULL,
        SSO_ORDER CODE_255,
        SSO_SEQUENCE SEQUENCE_NO,
        SSO_NOTES NOTES,
        SS_NAME CODE NOT NULL,
        SSO_USER_TYPE CODE,
        SSO_DEVICE_TYPE DEVICE_TYPE,
        SSO_ORDER_STATUS STATUS,
        WH_ID WH_ID,
        COMPANY_ID COMPANY,
        LAST_UPDATE_DATE LAST_UPDATE_DATE,
        LAST_UPDATE_BY USER_ID,
PRIMARY KEY (RECORD_ID));

/* Table: SYS_SCREEN_PROCEDURE, Owner: SYSDBA */
CREATE TABLE SYS_SCREEN_PROCEDURE (RECORD_ID INTEGER NOT NULL,
        SSP_NAME DESCR,
        SSP_SEQUENCE SEQUENCE_NO,
        SSP_EXPRESSION CODE_255,
        SSP_ALIAS CODE,
        SSP_NOTES NOTES,
        SSP_OTHER1 CODE,
        SSP_OTHER2 CODE,
        SSP_USER_TYPE CODE,
        SSP_DEVICE_TYPE DEVICE_TYPE,
        SSP_FIELD_TYPE STATUS,
        SSP_FIELD_STATUS STATUS,
        SS_NAME CODE NOT NULL,
        SST_TABLE CODE,
        LAST_UPDATE_DATE LAST_UPDATE_DATE,
        LAST_UPDATE_BY USER_ID,
PRIMARY KEY (RECORD_ID));

/* Table: SYS_SCREEN_TAB, Owner: SYSDBA */
CREATE TABLE SYS_SCREEN_TAB (RECORD_ID INTEGER NOT NULL,
        SST_TAB_NAME CODE,
        SST_SEQUENCE SEQUENCE_NO,
        SST_TITLE CODE,
        SST_NOTES NOTES,
        SST_ACTIVE_COLOUR CODE,
        SST_INACTIVE_COLOUR CODE,
        SST_USER_TYPE CODE,
        SST_DEVICE_TYPE DEVICE_TYPE,
        SST_TAB_STATUS STATUS,
        SS_NAME CODE NOT NULL,
        LAST_UPDATE_DATE LAST_UPDATE_DATE,
        LAST_UPDATE_BY USER_ID,
        WH_ID WH_ID,
        COMPANY_ID COMPANY,
        SSV_NAME DESCR,
        SST_FIELD_TYPE STATUS,
PRIMARY KEY (RECORD_ID));

/* Table: SYS_SCREEN_TABLE, Owner: SYSDBA */
CREATE TABLE SYS_SCREEN_TABLE (RECORD_ID INTEGER NOT NULL,
        SST_TABLE CODE,
        SST_SEQUENCE SEQUENCE_NO,
        SST_ALIAS CODE,
        SST_NOTES NOTES,
        SST_VIA CODE_255,
        SST_OTHER1 CODE,
        SS_NAME CODE NOT NULL,
        SST_JOIN CODE_255,
        SST_USER_TYPE CODE,
        SST_DEVICE_TYPE DEVICE_TYPE,
        SST_TABLE_STATUS STATUS,
        COMPANY_ID COMPANY,
        WH_ID WH_ID,
        LAST_UPDATE_DATE LAST_UPDATE_DATE,
        LAST_UPDATE_BY USER_ID,
        SST_PROCEDURE VALUE_TF,
PRIMARY KEY (RECORD_ID));

/* Table: SYS_SCREEN_VAR, Owner: SYSDBA */
CREATE TABLE SYS_SCREEN_VAR (RECORD_ID INTEGER NOT NULL,
        SSV_NAME DESCR,
        SSV_SEQUENCE SEQUENCE_NO,
        SSV_EXPRESSION CODE_255,
        SSV_ALIAS CODE,
        SSV_TITLE CODE,
        SSV_NOTES NOTES,
        SSV_OTHER1 CODE,
        SSV_INPUT_METHOD CODE_255,
        SSV_USER_TYPE CODE,
        SSV_DEVICE_TYPE DEVICE_TYPE,
        SSV_FIELD_TYPE STATUS,
        SSV_FIELD_STATUS STATUS,
        SS_NAME CODE NOT NULL,
        SSV_TABLE CODE,
        COMPANY_ID COMPANY,
        SSV_PRIMARY_ID VALUE_TF,
        WH_ID WH_ID,
        LAST_UPDATE_DATE LAST_UPDATE_DATE,
        LAST_UPDATE_BY USER_ID,
        SSV_TAB CODE,
        SSV_FIELD_WIDTH INTEGER,
        SSV_BUTTON CODE,
        SSV_DROPDOWN_DATA_FROM QUERY_FROM_TYPE,
        SSV_INPUT_METHOD_NEW CODE,
        SSV_ACTION CODE,
        SSV_COLOUR_TEST_NAME CODE,
        SSV_COLOUR_TEST_FIELD CODE,
        SSV_DROPDOWN_SQL TRN_DATA,
        SSV_DROPDOWN_DEFAULT TRN_DATA,
        SSV_INPUT_EXPRESSION CODE_255,
        SSV_HINT CODE_255,
PRIMARY KEY (RECORD_ID));

/* Table: SYS_USER, Owner: SYSDBA */
CREATE TABLE SYS_USER (USER_ID USER_ID NOT NULL,
        PERSON_ID PERSON,
        COMPANY_ID COMPANY,
        DIVISION_ID DIVISION,
        DEVICE_ID DEVICE_ID,
        LOC_PERM_LEVEL LOC_PERM_LEVEL,
        PROD_PERM_LEVEL PROD_PERM_LEVEL,
        TASK_PERM_LEVEL TASK_PERM_LEVEL,
        LOGIN_DATE LOGIN_DATE,
        PASS_WORD PASS_WORD,
        PASS_WORD_DATE PASS_WORD_DATE,
        PW_EXPIRY_DATE PW_EXPIRY_DATE,
        LAST_UPDATE_DATE LAST_UPDATE_DATE,
        UPDATE_USER_ID USER_ID,
        SYS_ADMIN SYS_ADMIN  DEFAULT 'F',
        ZONE_C CODE_TWO  DEFAULT 'AA',
        EDITABLE EDITABLE,
        USER_TYPE CODE_TWO,
        SALE_MANAGER CHAR(1),
        CREDIT_MANAGER CHAR(1),
        DEFAULT_WH_ID WH_ID,
        INVENTORY_OPERATOR INVENTORY_OPERATOR  DEFAULT 'T',
        PICK_SEQUENCE CHAR(2),
        PICK_DIRECTION CHAR(1),
        DEFAULT_ORDER_SOLD_FROM COMPANY,
        DEFAULT_ORDER_SOLD_TO COMPANY,
        STOCK_ADJUST VALUE_TF,
        STATUS_ADJUST_ISSN VALUE_TF,
        STATUS_ADJUST_PICK_ITEM VALUE_TF,
        STATUS_ADJUST_PICK_ORDER VALUE_TF,
        STATUS_ADJUST_PURCHASE_ORDER VALUE_TF,
        STATUS_ADJUST_PO_LINE VALUE_TF,
        USER_CATEGORY CODE_TWO,
        WHM_START_MENU CODE,
        MINDER_START_MENU CODE,
        WH_MANAGER VALUE_TF,
PRIMARY KEY (USER_ID));

/* Table: TASK_SCHEDULE, Owner: SYSDBA */
CREATE TABLE TASK_SCHEDULE (TASK_ID RECORD_ID,
        SHEDULED_ACTION_DATE DATETIME,
        ACTION_COMPLETED FLAGS,
        COMPLETION_DATE DATETIME,
        SSN_ID SSN_ID,
        ACTION_NOTES NOTES,
        ENTRY_DATE DATETIME);

/* Table: TERMS, Owner: SYSDBA */
CREATE TABLE TERMS (TERM VARCHAR(20));

/* Table: TEST_QUESTIONS, Owner: SYSDBA */
CREATE TABLE TEST_QUESTIONS (SSN_TYPE SSN_TYPE,
        SEQUENCE SEQUENCE_NO,
        QUESTION_ID RECORD_ID,
        QUESTION QUESTION,
        INSPECT_CATEGORY VARCHAR(1),
        ORIGINAL_QUESTION_ID INTEGER,
        QUESTION_TYPE CODE_TWO);

/* Table: TOG, Owner: SYSDBA */
CREATE TABLE TOG (CODE CODE_TWO NOT NULL,
        DESCRIPTION DESCRIPTION,
PRIMARY KEY (CODE));

/* Table: TRAINING_SKILL, Owner: SYSDBA */
CREATE TABLE TRAINING_SKILL (PERSON_ID PERSON NOT NULL,
        TRAINING_CODE CODE NOT NULL,
        TRAINING_DATE TRAINING_DATE NOT NULL,
        TRAINING_BY PERSON,
        TRAINING_AUTHORITY MDR_DESCRIPTION,
        TRAINING_PASS TRAINING_PASS,
        TRAINING_RESULT TRAINING_RESULT,
        TRAINING_CERT_PRINTED LABEL_DATE,
        TRAINING_LOCATION CODE,
        COMPULSORY_SKILL CHAR(1),
PRIMARY KEY (PERSON_ID, TRAINING_CODE, TRAINING_DATE));

/* Table: TRAINING_SKILL_CODES, Owner: SYSDBA */
CREATE TABLE TRAINING_SKILL_CODES (CODE CODE NOT NULL,
        SKILL_TYPE CODE_TWO,
        DESCRIPTION MDR_DESCRIPTION,
        PUBLISH CHAR(1),
        COMPULSORY_SKILL CHAR(1),
        CREATED_DATE TIMESTAMP,
        CREATED_BY PERSON,
PRIMARY KEY (CODE));

/* Table: TRANSACTIONS, Owner: SYSDBA */
CREATE TABLE TRANSACTIONS (RECORD_ID RECORD_ID NOT NULL,
        WH_ID WH_ID,
        LOCN_ID LOCN_ID,
        OBJECT OBJECT,
        TRN_TYPE TRN_TYPE,
        TRN_CODE TRN_CODE,
        TRN_DATE TRN_DATE,
        REFERENCE REFERENCE,
        QTY QTY,
        COMPLETE COMPLETE,
        ERROR_TEXT ERROR_TEXT,
        INSTANCE_ID INSTANCE_ID,
        EXPORTED EXPORTED,
        SUB_LOCN_ID LOCN_ID,
        INPUT_SOURCE INPUT_SOURCE,
        PERSON_ID PERSON,
        DEVICE_ID DEVICE_ID,
PRIMARY KEY (RECORD_ID));

/* Table: TRANSACTIONS4, Owner: SYSDBA */
CREATE TABLE TRANSACTIONS4 (RECORD_ID RECORD_ID NOT NULL,
        TRN_VERSION CODE_TWO  DEFAULT 'V4',
        TRN_TYPE TRN_TYPE,
        TRN_CLASS TRN_CODE,
        TRN_DATE TRN_DATE,
        TRN_DELIMITER CODE_ONE  DEFAULT '|',
        PERSON_ID PERSON,
        DEVICE_ID DEVICE_ID,
        MESSAGE_ID MESSAGE_ID,
        TRN_DATA TRN_DATA,
        COMPLETE COMPLETE,
        ERROR_TEXT ERROR_TEXTV4,
        INSTANCE_ID INSTANCE_ID,
        EXPORTED EXPORTED,
        INPUT_SOURCE INPUT_SOURCEV4,
PRIMARY KEY (RECORD_ID));

/* Table: TRANSACTIONS4_ARCHIVE, Owner: SYSDBA */
CREATE TABLE TRANSACTIONS4_ARCHIVE (TRN_VERSION CODE_TWO,
        TRN_TYPE TRN_TYPE,
        TRN_CLASS TRN_CODE,
        TRN_DATE TRN_DATE,
        TRN_DELIMITER CODE_ONE,
        PERSON_ID PERSON,
        DEVICE_ID DEVICE_ID,
        MESSAGE_ID MESSAGE_ID,
        TRN_DATA TRN_DATA,
        COMPLETE COMPLETE,
        ERROR_TEXT ERROR_TEXTV4,
        INSTANCE_ID INSTANCE_ID,
        EXPORTED EXPORTED,
        INPUT_SOURCE INPUT_SOURCEV4);

/* Table: TRANSACTIONS_ARCHIVE, Owner: SYSDBA */
CREATE TABLE TRANSACTIONS_ARCHIVE (WH_ID WH_ID,
        LOCN_ID LOCN_ID,
        OBJECT OBJECT,
        TRN_TYPE TRN_TYPE,
        TRN_CODE TRN_CODE,
        TRN_DATE TRN_DATE,
        REFERENCE REFERENCE,
        QTY QTY,
        ERROR_TEXT ERROR_TEXT,
        INSTANCE_ID INSTANCE_ID,
        EXPORTED EXPORTED,
        SUB_LOCN_ID LOCN_ID,
        INPUT_SOURCE INPUT_SOURCE,
        PERSON_ID PERSON,
        DEVICE_ID DEVICE_ID,
        COMPLETE COMPLETE);

/* Table: TRANSACTIONS_WORK, Owner: SYSDBA */
CREATE TABLE TRANSACTIONS_WORK (RECORD_ID RECORD_ID NOT NULL,
        WH_ID WH_ID,
        LOCN_ID LOCN_ID,
        OBJECT OBJECT,
        TRN_TYPE TRN_TYPE,
        TRN_CODE TRN_CODE,
        REFERENCE REFERENCE,
        QTY QTY,
        WH_ID2 WH_ID,
        LOCN_ID2 LOCN_ID,
        QTY2 QTY,
        DESCRIPTION DESCRIPTION,
        TRN_DATE TRN_DATE,
        INSTANCE_ID INSTANCE_ID,
        SUB_LOCN_ID LOCN_ID,
        INPUT_SOURCE INPUT_SOURCE,
        PERSON_ID PERSON,
        DEVICE_ID DEVICE_ID,
        COMPLETE COMPLETE,
        ERROR_TEXT ERROR_TEXT);

/* Table: TRANSACTION_TYPES, Owner: SYSDBA */
CREATE TABLE TRANSACTION_TYPES (SEQ INTEGER,
        TRN_TYPE TRN_TYPE,
        TRN_PREFIX CODE_TWO,
        DESCRIPTION DESCRIPTION,
        MAX_LENGTH MAX_LENGTH,
        COMPULSORY CODE_ONE,
        FAST_CHANGING CODE_ONE,
        NO_COMPULSORYS CODE_ONE,
        COPY_DATA CODE_ONE,
        REMOTE_UPDATE CODE_ONE,
        FIELD_NAME CODE,
        TABLE_NAME CODE,
        COMMENT CODE_255,
        SOAP_METHOD DESCR,
        SOAP_PROCEDURE DESCR);

/* Table: TRANSFER_REQUEST, Owner: SYSDBA */
CREATE TABLE TRANSFER_REQUEST (TRN_LINE_NO INTEGER NOT NULL,
        TRN_PRIORITY PICK_PRIORITY,
        DEVICE_ID DEVICE_ID,
        PROD_ID PRODUCT,
        QTY QTY,
        FROM_WH_ID WH_ID,
        FROM_LOCN_ID LOCN_ID,
        TO_WH_ID WH_ID,
        TO_LOCN_ID LOCN_ID,
        CREATE_DATE CREATE_DATE,
        TRN_STATUS STATUS,
        OTHER1 OTHER_CHAR,
        SEQ INTEGER,
PRIMARY KEY (TRN_LINE_NO));

/* Table: TRAN_ERROR, Owner: SYSDBA */
CREATE TABLE TRAN_ERROR (RECORD_ID RECORD_ID NOT NULL,
        WH_ID WH_ID,
        LOCN_ID LOCN_ID,
        OBJECT OBJECT,
        TRN_TYPE TRN_TYPE,
        TRN_CODE TRN_CODE,
        TRN_DATE TRN_DATE,
        REFERENCE REFERENCE,
        QTY QTY,
        COMPLETE COMPLETE,
        ERROR_TEXT ERROR_TEXT,
        INSTANCE_ID INSTANCE_ID,
        EXPORTED EXPORTED,
        SUB_LOCN_ID LOCN_ID,
        INPUT_SOURCE INPUT_SOURCE,
        PERSON_ID PERSON,
        DEVICE_ID DEVICE_ID,
PRIMARY KEY (RECORD_ID));

/* Table: TYPE_HEADER, Owner: SYSDBA */
CREATE TABLE TYPE_HEADER (TYPE_CODE TYPE_CODE NOT NULL,
        TYPE_HEADER_CODE TYPE_CODE NOT NULL,
        MANDATORY CHAR(1),
        NOTES NOTES,
PRIMARY KEY (TYPE_CODE, TYPE_HEADER_CODE));

/* Table: TYPE_LINE, Owner: SYSDBA */
CREATE TABLE TYPE_LINE (TYPE_CODE TYPE_CODE NOT NULL,
        TYPE_HEADER_CODE TYPE_CODE NOT NULL,
        TYPE_LINE_CODE TYPE_CODE NOT NULL,
        NOTES NOTES,
PRIMARY KEY (TYPE_CODE, TYPE_HEADER_CODE, TYPE_LINE_CODE));

/* Table: UDPATE_FIELDS, Owner: SYSDBA */
CREATE TABLE UDPATE_FIELDS (UPDATE_FIELD FIELD,
        DESCRIPTION DESCRIPTION,
        DB_TABLE FIELD,
        UPDATE_SQL NOTES,
        KEY_FIELD FIELD,
        FIELD_TYPE VARIABLE_STATUS);

/* Table: UOM, Owner: SYSDBA */
CREATE TABLE UOM (CODE CODE_TWO NOT NULL,
        DESCRIPTION DESCRIPTION,
        VOLUME VOLUME,
        UOM_TYPE CODE_TWO,
        TO_STANDARD_CONV NUMERIC(9, 3) default 1,
PRIMARY KEY (CODE));

/* Table: UOM_TYPE, Owner: SYSDBA */
CREATE TABLE UOM_TYPE (CODE CODE_TWO NOT NULL,
        DESCRIPTION DESCRIPTION,
        STANDARD_UOM CODE_TWO,
PRIMARY KEY (CODE));

/* Table: USER_ENV, Owner: SYSDBA */
CREATE TABLE USER_ENV (USER_ID USER_ID NOT NULL,
        PARAM_NAME DESCRIPTION NOT NULL,
        PARAM_VALUE NOTES,
        CREATE_DATE CREATE_DATE,
        CREATED_BY USER_ID,
PRIMARY KEY (USER_ID, PARAM_NAME));

/* Table: VALID_RESPONSES, Owner: SYSDBA */
CREATE TABLE VALID_RESPONSES (QUESTION_ID RECORD_ID,
        RESPONSE_ID RECORD_ID,
        VALID_RESPONSE SHORT_DESC,
        BRANCH_TO RECORD_ID,
        REQUIRE_ENTRY FLAGS,
        FIELD_TYPE VARIABLE_STATUS,
        HIGH_DATE_LIM DATETIME,
        HIGH_NUM_LIM LOWEST_LIMIT,
        LOW_DATE_LIM DATETIME,
        LOW_NUM_LIM LOWEST_LIMIT,
        MANDATORY_INPUT FLAGS,
        RUN_PROCEDURE FIELD,
        UPDATE_FIELD FIELD,
        VALID_SELECTION NOTES,
        INSPECT_CATEGORY VARCHAR(1),
        INSPECT_DESCRIPTION VARCHAR(25),
        INSPECT_PASS_CRITERIA VARCHAR(6));

/* Table: VARIANCE, Owner: SYSDBA */
CREATE TABLE VARIANCE (COMPANY_ID COMPANY NOT NULL,
        PROD_ID PRODUCT NOT NULL,
        RUN_DATE UPL_DATE NOT NULL,
        LEGACY_QTY QTY,
        AVAILABLE_QTY QTY,
        VARIANCE_STATUS STATUS,
        CREATE_DATE CREATE_DATE,
PRIMARY KEY (COMPANY_ID, PROD_ID, RUN_DATE));

/* Table: WAREHOUSE, Owner: SYSDBA */
CREATE TABLE WAREHOUSE (WH_ID WH_ID NOT NULL,
        DESCRIPTION DESCRIPTION,
        ADDRESS1 ADDRESS_LINE,
        ADDRESS2 ADDRESS_LINE,
        ADDRESS3 ADDRESS_LINE,
        ADDRESS4 ADDRESS_LINE,
        INSTANCE_ID INSTANCE_ID,
        COST_CENTER COST_CENTER,
        PERSON_ID PERSON,
        WH_LEGACY_WH_ID WH_VAR,
        WH_LEGACY_WH_NAME DESCRIPTION,
        WH_LEGACY_INTERNAL_ID VARCHAR(20),
        WAREHOUSE_TYPE CODE,
        DEFAULT_DESPATCH_PRINTER DEVICE_ID,
        DEFAULT_PICK_PRINTER CHAR(2),
        ALLOW_SOAP_GET_ORDER VALUE_TF,
        DEFAULT_RECEIVE_PRINTER DEVICE_ID,
        DEFAULT_LOCATION_PRINTER DEVICE_ID,
        DEFAULT_BORROWER_PRINTER DEVICE_ID,
        DEFAULT_DESPATCH_LOCATION LOCN_ID,
PRIMARY KEY (WH_ID));

/* Table: WARRANTY, Owner: SYSDBA */
CREATE TABLE WARRANTY (WARRANTY_CODE WARRANTY_TERM NOT NULL,
        DESCRIPTION DESCRIPTION,
        WARRANTY_DAYS INTEGER,
PRIMARY KEY (WARRANTY_CODE));

/* Table: WEB_REQUESTS, Owner: SYSDBA */
CREATE TABLE WEB_REQUESTS (MESSAGE_ID MESSAGE_ID NOT NULL,
        TRN_VERSION CODE_TWO  DEFAULT 'V4',
        TRN_TYPE TRN_TYPE,
        TRN_CLASS TRN_CODE,
        TRN_DATE TRN_DATE,
        PERSON_ID PERSON,
        DEVICE_ID DEVICE_ID,
        TRN_PRIORITY PICK_PRIORITY,
        TRN_REPLY_DATE TRN_DATE,
        REQUEST_STATUS STATUS,
        ERROR_TEXT ERROR_TEXTV4,
PRIMARY KEY (MESSAGE_ID));

/* Table: WEB_REQUESTS_ARCHIVE, Owner: SYSDBA */
CREATE TABLE WEB_REQUESTS_ARCHIVE (MESSAGE_ID MESSAGE_ID,
        TRN_VERSION CODE_TWO,
        TRN_TYPE TRN_TYPE,
        TRN_CLASS TRN_CODE,
        TRN_DATE TRN_DATE,
        PERSON_ID PERSON,
        DEVICE_ID DEVICE_ID,
        TRN_PRIORITY PICK_PRIORITY,
        TRN_REPLY_DATE TRN_DATE,
        REQUEST_STATUS STATUS,
        ERROR_TEXT ERROR_TEXTV4);

/* Table: WORK_FILE, Owner: SYSDBA */
CREATE TABLE WORK_FILE (SSN_ID SSN_ID NOT NULL,
        LOCN_ID LOCN_ID NOT NULL,
        ACCESSION ACCESSION,
        DESCR DESCR,
        WH_ID WH_ID,
        PREV_LOCN PREV_LOCN,
        INTO_DATE INTO_DATE,
        DT_PREV_INTO INTO_DATE,
        OBJECT_STAT OBJECT_STAT,
        LABEL_DATE LABEL_DATE,
        TRN_TYPE TRN_TYPE,
        REFERENCE REFERENCE,
        INITIALS INITIALS,
        PERSON_ID PERSON,
        DEVICE_ID DEVICE_ID,
        UPL_FILE_NAME UPL_FILE_NAME,
        UPL_DATE UPL_DATE,
        RECORDS RECORDS,
        AUDITED AUDITED,
        PRINTED_BY PRINTED_BY,
PRIMARY KEY (SSN_ID, LOCN_ID));

/* Table: WORK_PROD, Owner: SYSDBA */
CREATE TABLE WORK_PROD (PROD_ID PRODUCT NOT NULL,
        REMAINING_QTY QTY,
        COMPANY_ID COMPANY,
PRIMARY KEY (PROD_ID));

/* Table: XREF, Owner: SYSDBA */
CREATE TABLE XREF (NEW_CODE CODE NOT NULL,
        OLD_CODE CODE,
        DESCR NOTES,
        ACCESSION ACCESSION,
        SHORT_DESC SHORT_DESC,
PRIMARY KEY (NEW_CODE));

/* Table: ZONE, Owner: SYSDBA */
CREATE TABLE ZONE (CODE CODE_TWO NOT NULL,
        DESCRIPTION DESCRIPTION,
        DEFAULT_DEVICE_ID DEVICE_ID,
        COMPANY_ID COMPANY,
        ZONE_SEQ LOCN_SEQ,
PRIMARY KEY (CODE));

/*  Index definitions for all user tables */
CREATE INDEX AISLESINDEX1 ON AISLES (WH_ID, AISLE_SEQ);
CREATE INDEX BAYSINDEX1 ON BAYS (AISLE_SEQ, BAY_SEQ);
CREATE INDEX MAKECODE ON BRAND (CODE);
CREATE INDEX MAKEDESC ON BRAND (DESCRIPTION);
CREATE INDEX CARRIER_SERVICE_CS_TYPE_IDX ON CARRIER_SERVICE (CARRIER_ID, SERVICE_TYPE);
CREATE INDEX CHART_ACCOUNTS_CODE_IDX ON CHART_OF_ACCOUNTS (CODE);
CREATE INDEX CHART_ACCOUNTS_DESCRIPTION_IDX ON CHART_OF_ACCOUNTS (DESCRIPTION);
CREATE INDEX COMPARTMENTSINDEX1 ON COMPARTMENTS (SHELF_SEQ, COMPARTMENT_SEQ);
CREATE UNIQUE INDEX RECID ON CONTROL (RECORD_ID);
CREATE INDEX COSTCENTREDESC ON COST_CENTRE (DESCRIPTION);
CREATE UNIQUE INDEX COSTCENTREINDEX1 ON COST_CENTRE (CODE);
CREATE INDEX DCHEADER_IX ON DATA_COLLECTION (HEADER, ITEM_CODE);
CREATE INDEX MISCDATAINDEX1 ON DATA_COLLECT_HEADER (HEADER);
CREATE INDEX DEPARTMENT_IX ON DEPARTMENT (CODE);
CREATE INDEX DEPRECIATION_IDX ON DEPRECIATION (SSN_ID, PERIOD_KEY);
CREATE INDEX DEPMETHODS_IX ON DEP_METHODS (METHOD_CODE);
CREATE INDEX EMP_NAME_IDX ON EMPLOYEE (FIRST_NAME, LAST_NAME, INDUCTION_FORM_NO);
CREATE INDEX GENERICDESC ON GENERIC (DESCRIPTION);
CREATE INDEX GENERICSCODE ON GENERIC (CODE);
CREATE UNIQUE INDEX GENERIC_TYPE_GEN_IDX ON GENERIC (SSN_TYPE, CODE);
CREATE INDEX GRN_LOT_IDX ON GRN (LAST_LOT_NO);
CREATE INDEX GRN_ORDER_NO_IDX ON GRN (ORDER_NO);
CREATE INDEX GRN_UPDATE_DATE_IDX ON GRN (LAST_UPDATE_DATE);
CREATE INDEX GRN_CANCEL_IDX ON GRN_CANCEL (GRN);
CREATE INDEX GRN_CANCEL_UPDATE_IDX ON GRN_CANCEL (CANCEL_DATE);
CREATE INDEX GRN_ORDER_GRN_IDX ON GRN_ORDER (GRN);
CREATE INDEX GRN_ORDER_ORDER_IDX ON GRN_ORDER (ORDER_NO);
CREATE INDEX GRN_ORDER_CANCEL_GO_IDX ON GRN_ORDER_CANCEL (GRN, ORDER_NO);
CREATE INDEX GRN_ORDER_CANCEL_LABEL_IDX ON GRN_ORDER_CANCEL (GRN_LABEL_NO);
CREATE INDEX GRN_ORDER_CANCEL_UPDATE_IDX ON GRN_ORDER_CANCEL (LAST_UPDATE_DATE);
CREATE INDEX IMAGESINDEX1 ON IMAGES (IMAGE_NO);
CREATE DESCENDING INDEX ISSN_CREATE_DATE_IDX ON ISSN (CREATE_DATE, SSN_ID);
CREATE INDEX ISSN_LOC_SSN_IDX ON ISSN (WH_ID, LOCN_ID, SSN_ID);
CREATE INDEX ISSN_ORIGINAL_IDX ON ISSN (ORIGINAL_SSN);
CREATE INDEX ISSN_PICK_ORDER ON ISSN (PICK_ORDER);
CREATE INDEX ISSN_PRODUCT ON ISSN (PROD_ID, ISSN_STATUS);
CREATE INDEX ISSN_STATUS_LOC_IDX ON ISSN (ISSN_STATUS, WH_ID, LOCN_ID, SSN_ID);
CREATE INDEX ISSN_UPDATE_DATE_IDX ON ISSN (LAST_UPDATE_DATE);
CREATE INDEX ISSN_PUTAWAY_PUTAWAY ON ISSN_PUTAWAY (PUTAWAY_ID, SSN_ID, CREATE_DATE, DEVICE_ID);
CREATE INDEX ISSN_PUTAWAY_SSN ON ISSN_PUTAWAY (SSN_ID, PUTAWAY_ID, CREATE_DATE);
CREATE INDEX LOAN_RATE_COMPANY_IDX ON LOAN_RATE (LR_COMPANY_ID, LR_SSN_TYPE);
CREATE INDEX LOCATION_PROD_IDX ON LOCATION (PROD_ID);
CREATE INDEX LOCATION_SEQ_IDX ON LOCATION (LOCN_SEQ);
CREATE INDEX LOCATION_UPDATE_DATE_IDX ON LOCATION (LAST_UPDATE_DATE);
CREATE INDEX PARENTLOCN_ID ON LOCATION (WH_ID, PARENT_LOCN_ID);
CREATE INDEX WHS_ID_X ON LOCATION (LOCN_ID, WH_ID);
CREATE INDEX ZONE_IX ON LOCATION (ZONE_C, LOCN_ID);
CREATE UNIQUE INDEX L_ADDR_IX ON LOCN_ADDRESS (LOCN_ID);
CREATE UNIQUE INDEX LOCSTATKEY ON LOCN_STATUS (CODE);
CREATE UNIQUE INDEX METRICSINDEX1 ON METRICS (CODE);
CREATE INDEX MODELDESC ON MODEL (DESCRIPTION);
CREATE INDEX MODEL_IX ON MODEL (CODE);
CREATE UNIQUE INDEX MSKEY ON MOVE_STATUS (CODE);
CREATE INDEX PACK_ID_DESPATCH_IDX ON PACK_ID (DESPATCH_ID);
CREATE INDEX PACK_ID_LABEL_IDX ON PACK_ID (DESPATCH_LABEL_NO);
CREATE INDEX PACK_ID_UPDATE_IDX ON PACK_ID (LAST_UPDATE_DATE);
CREATE INDEX PERSONINDEX1 ON PERSON (PERSON_ID);
CREATE INDEX PERSON_COUNTRY_IDX ON PERSON (COUNTRY);
CREATE INDEX PERSON_STATE_IDX ON PERSON (STATE);
CREATE UNIQUE INDEX PERSON_COMPANY_PERSON_IDX ON PERSON_COMPANY (PERSON_ID, COMPANY_ID);
CREATE INDEX PICK_DESPATCH_CONNOTE_IDX ON PICK_DESPATCH (AWB_CONSIGNMENT_NO);
CREATE INDEX PICK_DESPATCH_INVOICE_IDX ON PICK_DESPATCH (INVOICE_ID);
CREATE INDEX PICK_DESPATCH_INVOICE_TYPE ON PICK_DESPATCH (INVOICE_TYPE);
CREATE INDEX PICK_DESPATCH_MANIFEST ON PICK_DESPATCH (PICKD_MANIFEST_ID);
CREATE INDEX PICK_DESPATCH_STATUS_IDX ON PICK_DESPATCH (DESPATCH_STATUS);
CREATE INDEX PICK_DESPATCH_UPDATE_IDX ON PICK_DESPATCH (LAST_UPDATE_DATE);
CREATE INDEX INVOICE_LINE_INV_ID_IDX ON PICK_INVOICE_LINE (INVLINE_INVOICE_ID);
CREATE INDEX INVOICE_LINE_INV_NO_IDX ON PICK_INVOICE_LINE (INVLINE_INVOICE_NO);
CREATE INDEX PICK_ITEM_DEVICE_IDX ON PICK_ITEM (DEVICE_ID, PICK_LINE_PRIORITY);
CREATE INDEX PICK_ITEM_DEV_PROD3_IDX ON PICK_ITEM (DEVICE_ID, PROD_ID, PICK_LINE_STATUS);
CREATE INDEX PICK_ITEM_DEV_PROD4_IDX ON PICK_ITEM (DEVICE_ID, PICK_LINE_STATUS);
CREATE INDEX PICK_ITEM_GROUP_IDX ON PICK_ITEM (DESPATCH_LOCATION_GROUP, PICK_LINE_STATUS);
CREATE INDEX PICK_ITEM_LEGACY_WH_IDX ON PICK_ITEM (PI_LEGACY_WH_NAME);
CREATE INDEX PICK_ITEM_ORDER_IDX ON PICK_ITEM (PICK_ORDER, PICK_ORDER_LINE_NO);
CREATE INDEX PICK_ITEM_PICK_ORDER_IDX ON PICK_ITEM (PICK_ORDER);
CREATE INDEX PICK_ITEM_PROD2_IDX ON PICK_ITEM (PROD_ID, DEVICE_ID, OVER_SIZED);
CREATE INDEX PICK_ITEM_PROD_IDX ON PICK_ITEM (PROD_ID);
CREATE INDEX PICK_ITEM_SSN_IDX ON PICK_ITEM (SSN_ID);
CREATE INDEX PICK_ITEM_STATUS_IDX ON PICK_ITEM (PICK_LINE_STATUS);
CREATE INDEX PICK_ITEM_UPDATE_IDX ON PICK_ITEM (LAST_UPDATE_DATE);
CREATE INDEX PICK_ITEM_CANCEL_PO_IDX ON PICK_ITEM_CANCEL (PICK_ORDER, PICK_LABEL_NO);
CREATE INDEX PICK_ITEM_CANCEL_UPDATE_IDX ON PICK_ITEM_CANCEL (LAST_UPDATE_DATE);
CREATE INDEX PICK_ITEM_DETAIL_DESPATCH_IDX ON PICK_ITEM_DETAIL (DESPATCH_ID);
CREATE INDEX PICK_ITEM_DETAIL_DESP_LOCN ON PICK_ITEM_DETAIL (DESPATCH_LOCATION, PICK_DETAIL_STATUS);
CREATE INDEX PICK_ITEM_DETAIL_DEVICE_IDX ON PICK_ITEM_DETAIL (DEVICE_ID);
CREATE INDEX PICK_ITEM_DETAIL_LABEL_IDX ON PICK_ITEM_DETAIL (PICK_LABEL_NO);
CREATE INDEX PICK_ITEM_DETAIL_ORDER_IDX ON PICK_ITEM_DETAIL (PICK_ORDER);
CREATE INDEX PICK_ITEM_DETAIL_SSN_IDX ON PICK_ITEM_DETAIL (SSN_ID);
CREATE INDEX PICK_ITEM_DETAIL_STATUS_IDX ON PICK_ITEM_DETAIL (PICK_DETAIL_STATUS);
CREATE INDEX PICK_ITEM_DETAIL_UPDATE_IDX ON PICK_ITEM_DETAIL (LAST_UPDATE_DATE);
CREATE INDEX PICK_ITEM_LINE_NO_DATE_IDX ON PICK_ITEM_LINE_NO (LAST_UPDATE_DATE);
CREATE INDEX PICK_ITEM_REVISED_PORDER_IDX ON PICK_ITEM_REVISED (PICK_ORDER);
CREATE INDEX PICK_ITEM_REVISED_PROD_IDX ON PICK_ITEM_REVISED (PROD_ID);
CREATE INDEX PICK_ITEM_REVISED_SSN_IDX ON PICK_ITEM_REVISED (SSN_ID);
CREATE INDEX PICK_LOCATION_LOCN_IDX ON PICK_LOCATION (PICK_ORDER, WH_ID, LOCN_ID);
CREATE INDEX PICK_ORDER_CREATED_IDX ON PICK_ORDER (CREATE_DATE);
CREATE INDEX PICK_ORDER_DESPATCH_IDX ON PICK_ORDER (DESPATCH_LOCATION);
CREATE INDEX PICK_ORDER_PERSON_IDX ON PICK_ORDER (PERSON_ID);
CREATE INDEX PICK_ORDER_PO_WO_IDX ON PICK_ORDER (CUSTOMER_PO_WO);
CREATE INDEX PICK_ORDER_SHIP_VIA_IDX ON PICK_ORDER (SHIP_VIA);
CREATE INDEX PICK_ORDER_STATUS_IDX ON PICK_ORDER (PICK_STATUS);
CREATE INDEX PICK_ORDER_UPDATE_IDX ON PICK_ORDER (LAST_UPDATE_DATE);
CREATE UNIQUE INDEX PICK_ORDER_ITEM_TEMP_IDX ON PICK_ORDER_ITEM_TEMP (RECORD_ID);
CREATE INDEX PICK_QUEUE_LABEL_IDX ON PICK_QUEUE (PICK_ORDER, PICK_QUEUE_STATUS);
CREATE INDEX PICK_QUEUE_STATUS_IDX ON PICK_QUEUE (PICK_QUEUE_STATUS, DEVICE_ID, CREATE_DATE);
CREATE INDEX POSTCODE_DEPOT_POST_CODE_ID ON POSTCODE_DEPOT (COUNTRY, POST_CODE);
CREATE INDEX PRINTSELECTION_IDX ON PRINT_SELECTION (FIELD_ID);
CREATE UNIQUE INDEX PRIVKEY ON PRIVILIGES (CODE);
CREATE INDEX PROD_COND_TRN_DATE_IDX ON PRODUCT_CONDITION (LAST_UPDATE_DATE);
CREATE INDEX PROD_COND_STATUS_UPD_DATE_IDX ON PRODUCT_COND_STATUS (LAST_UPDATE_DATE);
CREATE INDEX PRODUCT_KIT_IX_PROD ON PRODUCT_KIT (PROD_ID);
CREATE INDEX PROD_COUNT_HIST_IDX ON PROD_COUNT_HIST (CREATE_DATE, WH_ID, LOCN_ID, PROD_ID);
CREATE INDEX PROD_PROFILE_LONG_DESC_IDX ON PROD_PROFILE (SHORT_DESC);
CREATE INDEX PROD_PROFILE_PROD_TYPE_IDX ON PROD_PROFILE (PROD_TYPE);
CREATE INDEX PROD_PROFILE_SHORT_DESC_IDX ON PROD_PROFILE (SHORT_DESC);
CREATE INDEX PROD_PROFILE_SIZE_IDX ON PROD_PROFILE (SIZE_TYPE, TEMPERATURE_ZONE, PROD_ID);
CREATE INDEX PO_ITEM_DETAIL_DEVICE_IDX ON PURCHASE_LINE_DETAIL (DEVICE_ID);
CREATE INDEX PO_ITEM_DETAIL_PO_IDX ON PURCHASE_LINE_DETAIL (PURCHASE_ORDER, PO_LINE);
CREATE INDEX PO_ITEM_DETAIL_SSN_IDX ON PURCHASE_LINE_DETAIL (SSN_ID);
CREATE INDEX PO_ITEM_DETAIL_STATUS_IDX ON PURCHASE_LINE_DETAIL (PURCHASE_DETAIL_STATUS);
CREATE INDEX PO_ITEM_DETAIL_UPDATE_IDX ON PURCHASE_LINE_DETAIL (LAST_UPDATE_DATE);
CREATE INDEX POL_REVISED_IDX ON PURCHASE_LINE_REVISED (PURCHASE_ORDER, PO_LINE);
CREATE UNIQUE INDEX PURCHASEORDER_IX ON PURCHASE_ORDER (PURCHASE_ORDER);
CREATE UNIQUE INDEX PURCHASELINES_IX ON PURCHASE_ORDER_LINE (PURCHASE_ORDER, PO_LINE);
CREATE INDEX PURCHASE_ORDER_LINE_PROD ON PURCHASE_ORDER_LINE (PROD_ID, PO_LINE_STATUS);
CREATE UNIQUE INDEX PURCHASE_ORDER_LINE_TEMP_IDX ON PURCHASE_ORDER_LINE_TEMP (RECORD_ID);
CREATE INDEX PO_ITEM_SUB_DEVICE_IDX ON PURCHASE_SUB_LINE (DEVICE_ID);
CREATE INDEX PO_ITEM_SUB_PO_IDX ON PURCHASE_SUB_LINE (PURCHASE_ORDER, PO_LINE);
CREATE INDEX PO_ITEM_SUB_SSN_IDX ON PURCHASE_SUB_LINE (SSN_ID);
CREATE INDEX PO_ITEM_SUB_STATUS_IDX ON PURCHASE_SUB_LINE (PSL_STATUS);
CREATE INDEX PO_ITEM_SUB_UPDATE_IDX ON PURCHASE_SUB_LINE (LAST_UPDATE_DATE);
CREATE UNIQUE INDEX QLI$PROCEDURES_IDX1 ON QLI$PROCEDURES (QLI$PROCEDURE_NAME);
CREATE INDEX QUERY_LAYOUT_IDX ON QUERY_LAYOUT (CODE, SEQUENCE);
CREATE INDEX REPORTS_DETAIL_ID_IDX ON REPORTS_DETAIL (REPORT_ID);
CREATE INDEX REPORTS_TYPE_NAME_IDX ON REPORTS_TYPE (DESCRIPTION);
CREATE INDEX IDX_RESUME_TEST ON RESUME_TEST (SSN_ID);
CREATE INDEX SHELFSINDEX1 ON SHELFS (BAY_SEQ, SHELF_SEQ);
CREATE INDEX SSN_CREATE_DATE_IDX ON SSN (CREATE_DATE);
CREATE DESCENDING INDEX SSN_CREATE_DATE_REV_IDX ON SSN (CREATE_DATE, SSN_ID);
CREATE INDEX SSN_GRN_IDX ON SSN (GRN);
CREATE INDEX SSN_LOC_SSN_IDX ON SSN (LOCN_ID, SSN_ID);
CREATE INDEX SSN_PO_ORDER_IDX ON SSN (PO_ORDER, PO_LINE);
CREATE INDEX SSN_UPDATE_DATE_IDX ON SSN (LAST_UPDATE_DATE);
CREATE UNIQUE INDEX SSN_WHID_SSN_IDX ON SSN (WH_ID, SSN_ID);
CREATE INDEX OBJECTGROUP_IX1 ON SSN_GROUP (SSN_GROUP);
CREATE INDEX SSN_HIST_LOCATION_IDX ON SSN_HIST (WH_ID, LOCN_ID, TRN_DATE);
CREATE INDEX SSN_HIST_SSN_IDX ON SSN_HIST (SSN_ID, TRN_DATE);
CREATE INDEX SSN_HIST_TRN_DATE_IDX ON SSN_HIST (TRN_DATE);
CREATE INDEX SSN_ITEM_CLASS_SSN_IX ON SSN_ITEM_CLASS (SSN_ID, ITEM_CLASS_CODE);
CREATE INDEX IDX_TEST_2 ON SSN_TEST (SSN_ID);
CREATE INDEX SSN_TEST_UPDATE_DATE_IDX ON SSN_TEST (LAST_UPDATE_DATE);
CREATE UNIQUE INDEX IDX_SSN_TEST_RESULTS ON SSN_TEST_RESULTS (SSN_TEST_ID);
CREATE INDEX IDX_TEST_RESULT_2 ON SSN_TEST_RESULTS (SSN_ID, PROCESSED, INSPECT_CATEGORY, TEST_ID);
CREATE UNIQUE INDEX TYPECODE ON SSN_TYPE (CODE);
CREATE INDEX TYPEDESC ON SSN_TYPE (DESCRIPTION);
CREATE INDEX STOCKTAKE_LOCN_IDX ON STOCKTAKE (ST_WH_ID, ST_LOCN_ID, ST_STATUS, ST_AUDIT_DATE);
CREATE INDEX STOCKTAKE_SSN_IDX ON STOCKTAKE (ST_SSN_ID, ST_AUDIT_DATE);
CREATE UNIQUE INDEX SAKEY ON STORE_AREA (CODE);
CREATE UNIQUE INDEX SMKEY ON STORE_METHOD (CODE);
CREATE UNIQUE INDEX STKEY ON STORE_TYPE (CODE);
CREATE INDEX SYS_LABEL_NAME_IDX ON SYS_LABEL (SL_NAME, SL_SEQUENCE);
CREATE INDEX SYS_LABEL_VAR_NAME_IDX ON SYS_LABEL_VAR (SL_NAME, SLV_SEQUENCE, SLV_NAME);
CREATE INDEX SYS_MENU_ID_IDX ON SYS_MENU (SM_MENU_ID);
CREATE INDEX SYS_MENU_NAME_IDX ON SYS_MENU (SM_NAME);
CREATE INDEX SYS_SCREEN_NAME_IDX ON SYS_SCREEN (SS_NAME);
CREATE INDEX SYS_SCREEN_ACTION_NAME_IDX ON SYS_SCREEN_ACTION (SSA_ACTION_NAME);
CREATE INDEX SYS_SCREEN_ACTION_SSNAME_IDX ON SYS_SCREEN_ACTION (SS_NAME);
CREATE INDEX SYS_SCREEN_BUTTON_NAME_IDX ON SYS_SCREEN_BUTTON (SSB_BUTTON_NAME);
CREATE INDEX SYS_SCREEN_BUTTON_SSNAME_IDX ON SYS_SCREEN_BUTTON (SS_NAME);
CREATE INDEX SYS_SCREEN_COLOUR_NAME_IDX ON SYS_SCREEN_COLOUR (SSC_COLOUR_TEST_NAME);
CREATE INDEX SYS_SCREEN_COLOUR_SSNAME_IDX ON SYS_SCREEN_COLOUR (SS_NAME);
CREATE INDEX SYS_SCREEN_ORDER_NAME_IDX ON SYS_SCREEN_ORDER (SSO_ORDER);
CREATE INDEX SYS_SCREEN_ORDER_SSNAME_IDX ON SYS_SCREEN_ORDER (SS_NAME);
CREATE INDEX SYS_SCREEN_PROCEDURE_NAME_IDX ON SYS_SCREEN_PROCEDURE (SSP_NAME);
CREATE INDEX SYS_SCREEN_PROCEDURE_SSNAME_IDX ON SYS_SCREEN_PROCEDURE (SS_NAME, SST_TABLE);
CREATE INDEX SYS_SCREEN_TAB_NAME_IDX ON SYS_SCREEN_TAB (SST_TAB_NAME);
CREATE INDEX SYS_SCREEN_TAB_SSNAME_IDX ON SYS_SCREEN_TAB (SS_NAME);
CREATE INDEX SYS_SCREEN_TABLE_NAME_IDX ON SYS_SCREEN_TABLE (SST_TABLE);
CREATE INDEX SYS_SCREEN_TABLE_SSNAME_IDX ON SYS_SCREEN_TABLE (SS_NAME);
CREATE INDEX SYS_SCREEN_VAR_NAME_IDX ON SYS_SCREEN_VAR (SSV_NAME);
CREATE INDEX SYS_SCREEN_VAR_SSNAME_IDX ON SYS_SCREEN_VAR (SS_NAME);
CREATE UNIQUE INDEX USERS_X1 ON SYS_USER (USER_ID);
CREATE UNIQUE INDEX IDX_TEST_QUESTIONS ON TEST_QUESTIONS (QUESTION_ID);
CREATE INDEX TEST_QUESTIONS_ORIGINALINDEX ON TEST_QUESTIONS (ORIGINAL_QUESTION_ID);
CREATE UNIQUE INDEX TOGINDEX1 ON TOG (CODE);
CREATE INDEX TRANSACTIONS_JVX_IDX ON TRANSACTIONS (WH_ID, LOCN_ID, OBJECT, TRN_TYPE, TRN_CODE, TRN_DATE, PERSON_ID, DEVICE_ID);
CREATE INDEX TRAN_OBJ_LOC_IDX ON TRANSACTIONS (TRN_TYPE, OBJECT, LOCN_ID);
CREATE INDEX TRANSACTIONS4_MSG_IDX ON TRANSACTIONS4 (MESSAGE_ID);
CREATE INDEX TRANS4_ARCHIVE_DATE_CLASS_IDX ON TRANSACTIONS4_ARCHIVE (TRN_DATE, TRN_CLASS);
CREATE INDEX TRANSACTIONS4_ARCHIVE_MSG_IDX ON TRANSACTIONS4_ARCHIVE (MESSAGE_ID, TRN_DATE);
CREATE INDEX TRANS_ARCHIVE_DATE_IDX ON TRANSACTIONS_ARCHIVE (TRN_DATE, COMPLETE);
CREATE INDEX TRANS_ARCHIVE_TRN_DATE_IDX ON TRANSACTIONS_ARCHIVE (TRN_DATE, DEVICE_ID, TRN_TYPE, TRN_CODE);
CREATE INDEX TRANS_ARCHIVE_TRN_TYPE_IDX ON TRANSACTIONS_ARCHIVE (TRN_TYPE, TRN_CODE, OBJECT, TRN_DATE);
CREATE INDEX TRANSACTIONS_WORK_DESC ON TRANSACTIONS_WORK (RECORD_ID, DESCRIPTION, WH_ID, LOCN_ID, WH_ID2, LOCN_ID2);
CREATE INDEX TRANSACTIONS_WORK_LOCN2 ON TRANSACTIONS_WORK (RECORD_ID, OBJECT, WH_ID, LOCN_ID, WH_ID2, LOCN_ID2);
CREATE INDEX TRANSACTION_WORK_IDX1 ON TRANSACTIONS_WORK (RECORD_ID, WH_ID, LOCN_ID, OBJECT);
CREATE INDEX TRANSFER_REQUEST_DEVICE ON TRANSFER_REQUEST (DEVICE_ID, TRN_STATUS);
CREATE INDEX TRANSFER_REQUEST_PROCESS_IDX ON TRANSFER_REQUEST (TRN_PRIORITY, TRN_STATUS, TRN_LINE_NO);
CREATE INDEX TRANSFER_REQUEST_PROD_DEVICE ON TRANSFER_REQUEST (PROD_ID, DEVICE_ID);
CREATE INDEX TRANSFER_REQUEST_PROD_STATUS ON TRANSFER_REQUEST (PROD_ID, TRN_STATUS);
CREATE INDEX TRANSFER_REQUEST_SEQ_IDX ON TRANSFER_REQUEST (OTHER1, SEQ);
CREATE INDEX TRANSFER_REQUEST_STATUS ON TRANSFER_REQUEST (TRN_STATUS, TRN_PRIORITY);
CREATE INDEX TRANSFER_REQUEST_TOLOCN ON TRANSFER_REQUEST (TO_WH_ID, TO_LOCN_ID, PROD_ID, TRN_STATUS);
CREATE INDEX IDX_VALID_RESPONSES ON VALID_RESPONSES (QUESTION_ID);
CREATE UNIQUE INDEX IDX_VALID_RESPONSES_2 ON VALID_RESPONSES (RESPONSE_ID);
CREATE INDEX IDX_VALID_RESPONSES_3 ON VALID_RESPONSES (VALID_RESPONSE);
CREATE INDEX WAREHOUSEINDEX1 ON WAREHOUSE (WH_ID);
CREATE INDEX WEB_REQUESTS_STATUS_IDX ON WEB_REQUESTS (REQUEST_STATUS, TRN_PRIORITY);
CREATE INDEX WEB_REQUESTS_ARCHIVE_MSG_IDX ON WEB_REQUESTS_ARCHIVE (MESSAGE_ID, TRN_REPLY_DATE);
CREATE UNIQUE INDEX ZONEINDEX1 ON ZONE (CODE);
CREATE INDEX ZONE_COMPANY_IDX ON ZONE (COMPANY_ID);

/* View: PERSON_SUBTYPE, Owner: SYSDBA */
CREATE VIEW PERSON_SUBTYPE (PERSON_ID, PERSON_TYPE, FIRST_NAME) AS

SELECT person_id, person_type, first_name FROM person WHERE person_type in ('LE');

/* View: PICK_WIP_EXPORT, Owner: SYSDBA */
CREATE VIEW PICK_WIP_EXPORT (PROD_ID, DESCRIPTION, PICK_ORDER_QTY, PICKED_QTY, CATALOGUE, PICK_ORDER, PICK_LINE) AS

SELECT PI.PROD_ID, PI.OTHER2,PI.PICK_ORDER_QTY,PI.PICKED_QTY,PI.OTHER1,PI.PICK_ORDER, PI.OTHER3 FROM PICK_ITEM PI WHERE PI.PICK_LINE_STATUS IN ('AL','PG','PL','DS')  AND (PI.PICKED_QTY IS NULL OR (PI.PICKED_QTY <> PI.PICK_ORDER_QTY)) GROUP BY PI.PROD_ID,PI.PICK_ORDER, PI.OTHER2, PI.PICK_ORDER_QTY, PI.PICKED_QTY, PI.OTHER1,PI.OTHER3;

/* View: ONSITE_SAFETY_EXPIRY, Owner: SYSDBA */
CREATE VIEW ONSITE_SAFETY_EXPIRY (BARCODE, DESCRIPTION, WH, LOCATION_ID, INTO_DATE, LOCATION_NAME, SAFETY_CHECK, SAFETY_DATE, SAFETY_PERIOD, SAFETY_PER_NO, SAFETY_DAYS, SAFETY_EXPIRY_DATE, CALIBRATE_CHECK, CALIBRATE_DATE, CALIBRATE_PERIOD, CALIBRATE_PER_NO, CALIBRATE_DAYS, CALIBRATE_EXPIRY_DATE, SSN_TYPE, SAFETY_PASS, CALIBRATE_PASS) AS



SELECT 
     ISSN.SSN_ID AS BARCODE,
     TRIM(SSN.SSN_DESCRIPTION) AS DESCRIPTION,
     ISSN.WH_ID AS WH,
     ISSN.LOCN_ID AS LOCATION_ID,
     ISSN.INTO_DATE,
     REP_WH.DESCRIPTION AS LOCATION_NAME, 
     SSN.LOAN_SAFETY_CHECK AS SAFETY_CHECK,
     SSN.LOAN_LAST_SAFETY_CHECK_DATE AS SAFETY_DATE,
     SSN.LOAN_SAFETY_PERIOD AS SAFETY_PERIOD,
     SSN.LOAN_SAFETY_PERIOD_NO AS SAFETY_PER_NO,
     SSN.LOAN_SAFETY_PERIOD_NO * LSD.CODE AS SAFETY_DAYS, 
     CASE WHEN SSN.LOAN_SAFETY_PERIOD_NO IS NOT NULL AND SSN.LOAN_LAST_SAFETY_CHECK_DATE IS NOT NULL
     THEN MAKEDATE(MER_YEAR(SSN.LOAN_LAST_SAFETY_CHECK_DATE),MER_MONTH(SSN.LOAN_LAST_SAFETY_CHECK_DATE),MER_DAY(SSN.LOAN_LAST_SAFETY_CHECK_DATE) + SSN.LOAN_SAFETY_PERIOD_NO * LSD.CODE , 0, 0, 0) 
     ELSE NULL
     END  AS SAFETY_EXPIRY_DATE,
     SSN.LOAN_CALIBRATE_CHECK AS CALIBRATE_CHECK,
     SSN.LOAN_LAST_CALIBRATE_CHECK_DATE AS CALIBRATE_DATE,
     SSN.LOAN_CALIBRATE_PERIOD AS CALIBRATE_PERIOD,
     SSN.LOAN_CALIBRATE_PERIOD_NO AS CALIBRATE_PER_NO,
     SSN.LOAN_CALIBRATE_PERIOD_NO * LCD.CODE AS CALIBRATE_DAYS, 
     CASE WHEN SSN.LOAN_CALIBRATE_PERIOD_NO IS NOT NULL AND SSN.LOAN_LAST_CALIBRATE_CHECK_DATE IS NOT NULL
     THEN MAKEDATE(MER_YEAR(SSN.LOAN_LAST_CALIBRATE_CHECK_DATE),MER_MONTH(SSN.LOAN_LAST_CALIBRATE_CHECK_DATE),MER_DAY(SSN.LOAN_LAST_CALIBRATE_CHECK_DATE) + SSN.LOAN_CALIBRATE_PERIOD_NO * LCD.CODE , 0, 0, 0) 
     ELSE NULL
     END  AS CALIBRATE_EXPIRY_DATE,
     SSN.SSN_TYPE,
     SSN.LOAN_SAFETY_PASS AS SAFETY_PASS,
     SSN.LOAN_CALIBRATE_PASS AS CALIBRATE_PASS
FROM
     /* OPTIONS REP_WH
     JOIN ISSN ON REP_WH.GROUP_CODE = 'IRPT_WH_ID' AND REP_WH.CODE = ISSN.WH_ID  */
     WAREHOUSE REP_WH
     JOIN ISSN ON  REP_WH.WH_ID = ISSN.WH_ID 
     LEFT OUTER JOIN LOCATION ON ISSN.WH_ID = LOCATION.WH_ID AND ISSN.LOCN_ID = LOCATION.LOCN_ID
     LEFT OUTER JOIN SSN ON ISSN.ORIGINAL_SSN = SSN.SSN_ID
     LEFT OUTER JOIN OPTIONS LSD ON LSD.GROUP_CODE = 'LOAN_DAYS' AND SUBSTR(LSD.DESCRIPTION,1,1) = SSN.LOAN_SAFETY_PERIOD 
     LEFT OUTER JOIN OPTIONS LCD ON LCD.GROUP_CODE = 'LOAN_DAYS' AND SUBSTR(LCD.DESCRIPTION,1,1) = SSN.LOAN_CALIBRATE_PERIOD 
WHERE 
   ISSN.PROD_ID IS NULL
/*
SSN.LOAN_CALIBRATE_PERIOD IS NOT NULL OR
SSN.LOAN_SAFETY_PERIOD IS NOT NULL 
ORDER BY ISSN.WH_ID, ISSN.SSN_ID 
*/
ORDER BY ISSN.WH_ID, SSN.SSN_TYPE, ISSN.SSN_ID 
;

/*  Exceptions */
CREATE EXCEPTION NO_DELETE_SO 'Cannot Delete Sales Orders.';
COMMIT WORK;
SET AUTODDL OFF;
SET TERM ^ ;

/* Stored procedures */
CREATE PROCEDURE ADD_CHILD_KIT (WK_CHILD_PROD VARCHAR(30) CHARACTER SET NONE,
WK_CHILD_EXTENSION VARCHAR(6) CHARACTER SET NONE,
WK_STATUS VARCHAR(6) CHARACTER SET NONE,
WK_PROD_ID VARCHAR(30) CHARACTER SET NONE,
WK_CHILD_QTY INTEGER,
WK_PERSON VARCHAR(10) CHARACTER SET NONE,
WK_DATE TIMESTAMP)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE ADD_EMP_SKILL_DEFAULT (EMPLOYEE_ID VARCHAR(10) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE ADD_GRN (GRN VARCHAR(10) CHARACTER SET NONE,
GRN_TYPE CHAR(2) CHARACTER SET NONE,
TOTAL_QTY_PACKS INTEGER,
PACK_EAN_SSCC VARCHAR(18) CHARACTER SET NONE,
CARRIER VARCHAR(10) CHARACTER SET NONE,
VEHICLE_ID VARCHAR(8) CHARACTER SET NONE,
AWB_CONSIGNMENT_NO VARCHAR(20) CHARACTER SET NONE,
GRN_PALLET_QTY INTEGER,
DELIVERY_DOCKET VARCHAR(10) CHARACTER SET NONE,
PALLETS_YN CHAR(1) CHARACTER SET NONE,
CONTAINER_NO VARCHAR(20) CHARACTER SET NONE,
USER_ID VARCHAR(10) CHARACTER SET NONE,
DEVICE_ID CHAR(2) CHARACTER SET NONE,
GRN_DATE TIMESTAMP,
ORDER_NO VARCHAR(10) CHARACTER SET NONE,
ORDER_LINE_NO VARCHAR(4) CHARACTER SET NONE,
RETURN_ID VARCHAR(10) CHARACTER SET NONE,
COMMENTS VARCHAR(255) CHARACTER SET NONE,
SHIPPED_DATE TIMESTAMP)
RETURNS (GRN_ID VARCHAR(10) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE ADD_GROUP_DATA (TRN_TYPE VARCHAR(4) CHARACTER SET NONE,
TRN_DATE TIMESTAMP,
FIELD_VALUE VARCHAR(30) CHARACTER SET NONE,
TYPE_CODE VARCHAR(40) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE ADD_INSP_HIST (SSN_ID VARCHAR(20) CHARACTER SET NONE,
STATUS CHAR(1) CHARACTER SET NONE,
TYPE_DATE TIMESTAMP,
TYPE_CODE VARCHAR(40) CHARACTER SET NONE,
TYPE_HEADER_CODE VARCHAR(40) CHARACTER SET NONE,
TYPE_LINE_CODE VARCHAR(40) CHARACTER SET NONE,
DESCRIPTION VARCHAR(100) CHARACTER SET NONE,
PERSON_ID VARCHAR(10) CHARACTER SET NONE,
DEVICE_ID VARCHAR(2) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE ADD_ISSN (ORIGINAL_SSN VARCHAR(20) CHARACTER SET NONE,
WH_ID CHAR(2) CHARACTER SET NONE,
LOCN_ID VARCHAR(10) CHARACTER SET NONE,
PREV_LOCN_ID VARCHAR(10) CHARACTER SET NONE,
CURRENT_QTY INTEGER,
PREV_QTY INTEGER,
PREV_DATE TIMESTAMP,
ISSN_STATUS CHAR(2) CHARACTER SET NONE,
STATUS_CODE VARCHAR(10) CHARACTER SET NONE,
CREATE_DATE TIMESTAMP,
USER_ID VARCHAR(10) CHARACTER SET NONE,
PROD_ID VARCHAR(30) CHARACTER SET NONE,
NO_COPIES INTEGER)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE ADD_ISSN_FROM_SSN (SSN_ID VARCHAR(20) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE ADD_ISSN_LABEL (WK_LABEL_PRINTER CHAR(2) CHARACTER SET NONE,
WK_ISSN VARCHAR(20) CHARACTER SET NONE)
RETURNS (WK_LABEL_DATA VARCHAR(32000) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE ADD_LOAN_HIST (LOAN_ORDER_NO INTEGER,
LOAN_ORDER_LINE_NO INTEGER,
SSN_ID VARCHAR(20) CHARACTER SET NONE,
PERSON_ID VARCHAR(10) CHARACTER SET NONE,
LOAN_TYPE VARCHAR(2) CHARACTER SET NONE,
STATUS VARCHAR(2) CHARACTER SET NONE,
LOAN_DATE TIMESTAMP,
DUE_DATE TIMESTAMP,
RETURN_DATE TIMESTAMP,
DEVICE_ID VARCHAR(2) CHARACTER SET NONE,
OPERATOR VARCHAR(10) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE ADD_MASTER_DATA (TRN_TYPE VARCHAR(4) CHARACTER SET NONE,
TRN_DATE TIMESTAMP,
FIELD_VALUE VARCHAR(75) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE ADD_MESSAGE_V4 (MESSAGE_ID VARCHAR(10) CHARACTER SET NONE,
TRN_VERSION CHAR(2) CHARACTER SET NONE,
TRN_TYPE VARCHAR(4) CHARACTER SET NONE,
TRN_CLASS CHAR(1) CHARACTER SET NONE,
TRN_DATE TIMESTAMP,
PERSON_ID VARCHAR(10) CHARACTER SET NONE,
DEVICE_ID CHAR(2) CHARACTER SET NONE,
TRN_PRIORITY SMALLINT,
REQUEST_STATUS CHAR(2) CHARACTER SET NONE,
ERROR_TEXT VARCHAR(255) CHARACTER SET NONE,
TRN_REPLY_DATE TIMESTAMP)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE ADD_MODEL (CODE VARCHAR(40) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE ADD_NAMED_SSN_ISSN_GRNV (WH_ID VARCHAR(2) CHARACTER SET NONE,
LOCN_ID VARCHAR(10) CHARACTER SET NONE,
OBJECT VARCHAR(30) CHARACTER SET NONE,
TRANS_DATE TIMESTAMP,
QTY INTEGER,
GRN VARCHAR(10) CHARACTER SET NONE,
REFERENCE VARCHAR(40) CHARACTER SET NONE,
SOURCE VARCHAR(9) CHARACTER SET NONE,
RECORD_ID INTEGER,
TRN_CODE CHAR(1) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE ADD_OBJECT_LABEL (SSN_ID VARCHAR(20) CHARACTER SET NONE,
WH_ID VARCHAR(2) CHARACTER SET NONE,
GRN VARCHAR(15) CHARACTER SET NONE,
COMPANY_ID VARCHAR(20) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE ADD_ORDER_GROUP_PICK (WK_CAMPAIGN VARCHAR(10) CHARACTER SET NONE,
WK_ORDER VARCHAR(15) CHARACTER SET NONE,
WK_PERSON VARCHAR(10) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE ADD_PICK_ITEMS (WK_ORDER VARCHAR(15) CHARACTER SET NONE,
WK_ORDER_STATUS CHAR(1) CHARACTER SET NONE,
WK_STATUS VARCHAR(6) CHARACTER SET NONE,
WK_PROD1 VARCHAR(30) CHARACTER SET NONE,
WK_EXTENSION1 VARCHAR(6) CHARACTER SET NONE,
WK_LINE_NO1 VARCHAR(4) CHARACTER SET NONE,
WK_QTY1 INTEGER,
WK_TRN_DATE TIMESTAMP,
WK_PERSON_ID VARCHAR(10) CHARACTER SET NONE,
WK_SALE_PRICE NUMERIC(9, 4))
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE ADD_PICK_ITEM_LINE_NO (PICK_ORDER VARCHAR(10) CHARACTER SET NONE,
LAST_LINE_NO INTEGER)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE ADD_PICK_REVISED_ITEMS (WK_ORDER VARCHAR(15) CHARACTER SET NONE,
WK_ORDER_STATUS CHAR(1) CHARACTER SET NONE,
WK_STATUS VARCHAR(6) CHARACTER SET NONE,
WK_PROD1 VARCHAR(30) CHARACTER SET NONE,
WK_EXTENSION1 VARCHAR(6) CHARACTER SET NONE,
WK_LINE_NO1 VARCHAR(4) CHARACTER SET NONE,
WK_QTY1 INTEGER,
WK_TRN_DATE TIMESTAMP,
WK_PERSON_ID VARCHAR(10) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE ADD_PICK_SSN_DESPATCH_ITEMS (WK_ORDER VARCHAR(15) CHARACTER SET NONE,
WK_STATUS CHAR(2) CHARACTER SET NONE,
WK_SSN VARCHAR(20) CHARACTER SET NONE,
WK_LINE_NO1 VARCHAR(4) CHARACTER SET NONE,
WK_QTY1 INTEGER,
WK_DESPATCH_LOCATION VARCHAR(10) CHARACTER SET NONE,
WK_FROM_LOCATION VARCHAR(10) CHARACTER SET NONE,
WK_TRN_DATE TIMESTAMP,
WK_PERSON_ID VARCHAR(10) CHARACTER SET NONE,
WK_DESPATCH_ID INTEGER,
WK_DEVICE_ID CHAR(2) CHARACTER SET NONE)
RETURNS (PICK_LABEL VARCHAR(8) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE ADD_PICK_SSN_ITEMS (WK_ORDER VARCHAR(15) CHARACTER SET NONE,
WK_ORDER_STATUS CHAR(1) CHARACTER SET NONE,
WK_STATUS VARCHAR(6) CHARACTER SET NONE,
WK_SSN VARCHAR(200) CHARACTER SET NONE,
WK_LINE_NO1 VARCHAR(4) CHARACTER SET NONE,
WK_QTY1 INTEGER,
WK_TRN_DATE TIMESTAMP,
WK_PERSON_ID VARCHAR(10) CHARACTER SET NONE,
WK_SALE_PRICE NUMERIC(9, 4))
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE ADD_PRODUCT_LABEL (WK_LABEL_PRINTER CHAR(2) CHARACTER SET NONE,
WK_PROD_ID VARCHAR(30) CHARACTER SET NONE,
WK_PICK_LABEL_NO VARCHAR(10) CHARACTER SET NONE,
WK_ISSN VARCHAR(20) CHARACTER SET NONE,
WK_COPIES INTEGER)
RETURNS (WK_LABEL_DATA VARCHAR(32000) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE ADD_PROD_COND_STATUS (SSN_ID VARCHAR(20) CHARACTER SET NONE,
CODE VARCHAR(1) CHARACTER SET NONE,
DESCRIPTION VARCHAR(50) CHARACTER SET NONE,
ORIGINAL VARCHAR(1) CHARACTER SET NONE)
RETURNS (ADD_PROD CHAR(1) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE ADD_PROD_COND_STATUS_TEST (SSN_ID VARCHAR(20) CHARACTER SET NONE,
CODE VARCHAR(1) CHARACTER SET NONE,
DESCRIPTION VARCHAR(50) CHARACTER SET NONE,
ORIGINAL_TEST VARCHAR(1) CHARACTER SET NONE)
RETURNS (ADD_PROD CHAR(1) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE ADD_REPORT_TEMP (SSN_ID VARCHAR(20) CHARACTER SET NONE,
LAST_CHECK TIMESTAMP,
NEXT_CHECK TIMESTAMP)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE ADD_SSN_FROM_ISSN (SSN_ID VARCHAR(20) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE ADD_SSN_HIST (WH_ID CHAR(2) CHARACTER SET NONE,
LOCN_ID VARCHAR(10) CHARACTER SET NONE,
SSN_ID VARCHAR(20) CHARACTER SET NONE,
TRN_TYPE VARCHAR(4) CHARACTER SET NONE,
TRN_CODE CHAR(1) CHARACTER SET NONE,
TRN_DATE TIMESTAMP,
ERROR_TEXT VARCHAR(255) CHARACTER SET NONE,
REFERENCE VARCHAR(40) CHARACTER SET NONE,
QTY INTEGER,
PERSON_ID VARCHAR(10) CHARACTER SET NONE,
DEVICE_ID CHAR(2) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE ADD_SSN_ISSN_GRCI (WH_ID VARCHAR(2) CHARACTER SET NONE,
LOCN_ID VARCHAR(10) CHARACTER SET NONE,
OBJECT VARCHAR(30) CHARACTER SET NONE,
TRANS_DATE TIMESTAMP,
QTY INTEGER,
GRN VARCHAR(10) CHARACTER SET NONE,
REFERENCE VARCHAR(40) CHARACTER SET NONE,
SOURCE VARCHAR(9) CHARACTER SET NONE,
RECORD_ID INTEGER)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE ADD_SSN_ISSN_GRNV (WH_ID VARCHAR(2) CHARACTER SET NONE,
LOCN_ID VARCHAR(10) CHARACTER SET NONE,
OBJECT VARCHAR(30) CHARACTER SET NONE,
TRANS_DATE TIMESTAMP,
QTY INTEGER,
GRN VARCHAR(10) CHARACTER SET NONE,
REFERENCE VARCHAR(40) CHARACTER SET NONE,
SOURCE VARCHAR(9) CHARACTER SET NONE,
RECORD_ID INTEGER)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE ADD_SSN_ISSN_GRNV_WEIGHT (WH_ID VARCHAR(2) CHARACTER SET NONE,
LOCN_ID VARCHAR(10) CHARACTER SET NONE,
OBJECT VARCHAR(30) CHARACTER SET NONE,
TRANS_DATE TIMESTAMP,
QTY INTEGER,
GRN VARCHAR(10) CHARACTER SET NONE,
REFERENCE VARCHAR(40) CHARACTER SET NONE,
SOURCE VARCHAR(9) CHARACTER SET NONE,
RECORD_ID INTEGER)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE ADD_SSN_ISSN_LABEL (WH_ID VARCHAR(2) CHARACTER SET NONE,
PRINTED_BY VARCHAR(10) CHARACTER SET NONE,
LABEL_NO INTEGER,
SSN_LENGTH INTEGER)
RETURNS (ISSN VARCHAR(20) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE ADD_SSN_LEGACY (SSN_ID VARCHAR(20) CHARACTER SET NONE,
LEGACY_ID VARCHAR(20) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE ADD_SSN_TYPE_COND (SSN_ID VARCHAR(20) CHARACTER SET NONE,
STATUS CHAR(1) CHARACTER SET NONE,
TYPE_CODE VARCHAR(40) CHARACTER SET NONE,
PERSON_ID VARCHAR(10) CHARACTER SET NONE,
DEVICE_ID VARCHAR(2) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE ADD_TASK_SCHEDULE (SSNID VARCHAR(20) CHARACTER SET NONE,
ACTIONNOTES BLOB)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE ADD_TEST_RESULTS (SSN VARCHAR(20) CHARACTER SET NONE,
TESTTIME TIMESTAMP,
QUESTION VARCHAR(70) CHARACTER SET NONE,
RESPONSE VARCHAR(50) CHARACTER SET NONE,
NOTES BLOB,
TEXTRESPONSE VARCHAR(30) CHARACTER SET NONE,
NUMBERRESPONSE FLOAT,
DATERESPONSE TIMESTAMP,
UPDATEFIELD VARCHAR(30) CHARACTER SET NONE,
RUNPROCEDURE VARCHAR(30) CHARACTER SET NONE,
FIELDTYPE INTEGER,
CATEGORY VARCHAR(1) CHARACTER SET NONE,
PASS VARCHAR(6) CHARACTER SET NONE,
ORIGINAL VARCHAR(1) CHARACTER SET NONE,
USERID VARCHAR(10) CHARACTER SET NONE,
QUESTION_ID INTEGER,
RESPONSE_ID INTEGER)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE ADD_TRAN (WH_ID CHAR(2) CHARACTER SET NONE,
LOCN_ID VARCHAR(10) CHARACTER SET NONE,
OBJECT VARCHAR(30) CHARACTER SET NONE,
TRN_TYPE VARCHAR(4) CHARACTER SET NONE,
TRN_CODE CHAR(1) CHARACTER SET NONE,
TRN_DATE TIMESTAMP,
REFERENCE VARCHAR(255) CHARACTER SET NONE,
QTY INTEGER,
COMPLETE CHAR(1) CHARACTER SET NONE,
ERROR_TEXT VARCHAR(255) CHARACTER SET NONE,
INSTANCE_ID CHAR(10) CHARACTER SET NONE,
EXPORTED INTEGER,
SUB_LOCN_ID VARCHAR(10) CHARACTER SET NONE,
INPUT_SOURCE VARCHAR(10) CHARACTER SET NONE,
PERSON_ID VARCHAR(10) CHARACTER SET NONE,
DEVICE_ID CHAR(2) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE ADD_TRAN_ERROR (WH_ID CHAR(2) CHARACTER SET NONE,
LOCN_ID VARCHAR(10) CHARACTER SET NONE,
OBJECT VARCHAR(30) CHARACTER SET NONE,
TRN_TYPE VARCHAR(4) CHARACTER SET NONE,
TRN_CODE CHAR(1) CHARACTER SET NONE,
TRN_DATE TIMESTAMP,
REFERENCE VARCHAR(255) CHARACTER SET NONE,
QTY INTEGER,
COMPLETE CHAR(1) CHARACTER SET NONE,
ERROR_TEXT VARCHAR(255) CHARACTER SET NONE,
INSTANCE_ID CHAR(10) CHARACTER SET NONE,
EXPORTED INTEGER,
SUB_LOCN_ID VARCHAR(10) CHARACTER SET NONE,
INPUT_SOURCE VARCHAR(10) CHARACTER SET NONE,
PERSON_ID VARCHAR(10) CHARACTER SET NONE,
DEVICE_ID CHAR(2) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE ADD_TRAN_RESPONSE (WH_ID CHAR(2) CHARACTER SET NONE,
LOCN_ID VARCHAR(10) CHARACTER SET NONE,
OBJECT VARCHAR(30) CHARACTER SET NONE,
TRN_TYPE VARCHAR(4) CHARACTER SET NONE,
TRN_CODE CHAR(1) CHARACTER SET NONE,
TRN_DATE TIMESTAMP,
REFERENCE VARCHAR(255) CHARACTER SET NONE,
QTY INTEGER,
COMPLETE CHAR(1) CHARACTER SET NONE,
ERROR_TEXT VARCHAR(255) CHARACTER SET NONE,
INSTANCE_ID CHAR(10) CHARACTER SET NONE,
EXPORTED INTEGER,
SUB_LOCN_ID VARCHAR(10) CHARACTER SET NONE,
INPUT_SOURCE VARCHAR(10) CHARACTER SET NONE,
PERSON_ID VARCHAR(10) CHARACTER SET NONE,
DEVICE_ID CHAR(2) CHARACTER SET NONE)
RETURNS (RESPONSE_TEXT VARCHAR(255) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE ADD_TRAN_V4 (TRN_VERSION CHAR(2) CHARACTER SET NONE,
TRN_TYPE VARCHAR(4) CHARACTER SET NONE,
TRN_CLASS CHAR(1) CHARACTER SET NONE,
TRN_DATE TIMESTAMP,
TRN_DELIMITER CHAR(1) CHARACTER SET NONE,
PERSON_ID VARCHAR(10) CHARACTER SET NONE,
DEVICE_ID CHAR(2) CHARACTER SET NONE,
MESSAGE_ID VARCHAR(10) CHARACTER SET NONE,
TRN_DATA VARCHAR(1024) CHARACTER SET NONE,
COMPLETE CHAR(1) CHARACTER SET NONE,
ERROR_TEXT VARCHAR(255) CHARACTER SET NONE,
INSTANCE_ID CHAR(10) CHARACTER SET NONE,
EXPORTED INTEGER,
INPUT_SOURCE VARCHAR(512) CHARACTER SET NONE)
RETURNS (REC_ID INTEGER)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE ADD_UPDATE_STOCKTAKE (RECORD_ID VARCHAR(10) CHARACTER SET NONE,
ST_SSN_ID VARCHAR(20) CHARACTER SET NONE,
ST_WH_ID CHAR(2) CHARACTER SET NONE,
ST_LOCN_ID VARCHAR(10) CHARACTER SET NONE,
ST_COUNT DOUBLE PRECISION,
ST_VARIANCE DOUBLE PRECISION,
ST_AUDIT_DATE TIMESTAMP,
ST_AUDIT_BY VARCHAR(10) CHARACTER SET NONE,
ST_DEVICE_ID CHAR(2) CHARACTER SET NONE,
ST_STATUS CHAR(2) CHARACTER SET NONE,
ST_ACTION CHAR(2) CHARACTER SET NONE,
ST_APPLIED_DATE TIMESTAMP,
ST_APPLIED_BY VARCHAR(10) CHARACTER SET NONE,
ST_APPLIED_DEVICE_ID CHAR(2) CHARACTER SET NONE,
ST_COMPANY_ID VARCHAR(20) CHARACTER SET NONE)
RETURNS (NEW_RECORD_ID VARCHAR(10) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE APPROVE_SALES_ORDER (PICK_ORDER VARCHAR(10) CHARACTER SET NONE,
STATUS_SSN CHAR(2) CHARACTER SET NONE,
PICK_STATUS CHAR(2) CHARACTER SET NONE,
APPROVED_BY VARCHAR(10) CHARACTER SET NONE)
RETURNS (VALID_SO CHAR(1) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE AVAILABLE_PRODUCTS RETURNS (PROD_ID VARCHAR(30) CHARACTER SET NONE,
SHORT_DESC VARCHAR(50) CHARACTER SET NONE,
CURRENT_QTY INTEGER)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE CALC_CHECK_DIGIT_BDCS (IN_INPUT VARCHAR(255) CHARACTER SET NONE,
IN_INCLUDE_LAST CHAR(1) CHARACTER SET NONE)
RETURNS (OUT_DATA VARCHAR(255) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE CANCEL_SALE_LINE (PICK_LABEL VARCHAR(7) CHARACTER SET NONE,
REASON VARCHAR(255) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE CANCEL_SALE_ORDER (PICK_ORDER VARCHAR(15) CHARACTER SET NONE,
REASON VARCHAR(255) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE CHECK_EMPLOYEE_ID (EMPLOYEE_ID VARCHAR(10) CHARACTER SET NONE)
RETURNS (VALID_ID CHAR(1) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE CHECK_SALE_ORDER_LINES (PICK_ORDER VARCHAR(10) CHARACTER SET NONE)
RETURNS (VALID_SO CHAR(1) CHARACTER SET NONE,
INVALID_SSN VARCHAR(255) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE CHECK_SSN (SSN_ID VARCHAR(20) CHARACTER SET NONE)
RETURNS (VALID_ITEM CHAR(1) CHARACTER SET NONE,
LOAN_STATUS VARCHAR(1) CHARACTER SET NONE,
LOAN_PERIOD_NO INTEGER,
LOAN_PERIOD VARCHAR(1) CHARACTER SET NONE,
LOAN_SAFETY_CHECK VARCHAR(1) CHARACTER SET NONE,
LOAN_LAST_SAFETY_CHECK_DATE TIMESTAMP,
LOAN_SAFETY_PERIOD_NO INTEGER,
LOAN_SAFETY_PERIOD VARCHAR(1) CHARACTER SET NONE,
LOAN_CALIBRATE_CHECK VARCHAR(1) CHARACTER SET NONE,
LOAN_LAST_CALIBRATE_CHECK_DATE TIMESTAMP,
LOAN_CALIBRATE_PERIOD_NO INTEGER,
LOAN_CALIBRATE_PERIOD VARCHAR(1) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE CHECK_SSN_SALE_LINES (PICK_ORDER VARCHAR(10) CHARACTER SET NONE,
SSN_ID VARCHAR(20) CHARACTER SET NONE)
RETURNS (VALID_SSN CHAR(1) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE CHECK_STATUS_SSN_SALE_LINES (SSN_ID VARCHAR(20) CHARACTER SET NONE)
RETURNS (VALID_SSN CHAR(1) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE CHECK_TRANSACTION_ISIZ AS 
BEGIN EXIT; END ^
CREATE PROCEDURE CHECK_TYPE_HEADER (TYPE_CODE VARCHAR(40) CHARACTER SET NONE)
RETURNS (VALID_TYPE CHAR(1) CHARACTER SET NONE,
T_HEADER_CODE VARCHAR(40) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE COPY_QUESTIONS (WK_FROM_TYPE VARCHAR(40) CHARACTER SET NONE,
WK_TO_TYPE VARCHAR(40) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE CREATE_ISSN_FROM_SSN AS 
BEGIN EXIT; END ^
CREATE PROCEDURE CREATE_PICK_DETAIL_FROM_ISSN AS 
BEGIN EXIT; END ^
CREATE PROCEDURE CREATE_PROD_PROFILE AS 
BEGIN EXIT; END ^
CREATE PROCEDURE DELETE_ISSN (SSN_ID VARCHAR(20) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE DELETE_PROD_COND_STATUS (SSN_ID VARCHAR(20) CHARACTER SET NONE,
CODE VARCHAR(1) CHARACTER SET NONE,
ORIGINAL VARCHAR(1) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE DELETE_SALE_ORDER_LINE (PICK_LABEL VARCHAR(7) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE DELETE_SALE_ORDER_LINES (PICK_ORDER VARCHAR(10) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE DEL_REPORT_TEMP AS 
BEGIN EXIT; END ^
CREATE PROCEDURE DESPATCH_LOCN_LIST (LOCATION VARCHAR(10) CHARACTER SET NONE)
RETURNS (DESPATCH_LOCATION VARCHAR(10) CHARACTER SET NONE,
PICK_ORDER VARCHAR(15) CHARACTER SET NONE,
PERSON_ID VARCHAR(10) CHARACTER SET NONE,
PICK_STATUS CHAR(2) CHARACTER SET NONE,
CONTACT_NAME VARCHAR(50) CHARACTER SET NONE,
PICK_PRIORITY INTEGER,
PICK_DUE_DATE TIMESTAMP,
SHIP_VIA VARCHAR(10) CHARACTER SET NONE,
CREATED_BY VARCHAR(10) CHARACTER SET NONE,
PARTIAL_PICK_ALLOWED CHAR(1) CHARACTER SET NONE,
SPECIAL_INSTRUCTIONS1 VARCHAR(8196) CHARACTER SET NONE,
SPECIAL_INSTRUCTIONS2 VARCHAR(255) CHARACTER SET NONE,
CREATE_DATE TIMESTAMP,
CUSTOMER_PO_WO VARCHAR(20) CHARACTER SET NONE,
INV_WITH_GOODS CHAR(1) CHARACTER SET NONE,
PICK_ORDER_TYPE VARCHAR(2) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE EXPORT_CANCEL_ORDER (ORDER_ID VARCHAR(15) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE EXPORT_PUTAWAY (PUTAWAY_ID VARCHAR(10) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE FILECONCAT (SOURCEFILES VARCHAR(1024) CHARACTER SET NONE,
DESTFILE VARCHAR(255) CHARACTER SET NONE)
RETURNS (RES INTEGER)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE FILECREATE (FILENAME VARCHAR(255) CHARACTER SET NONE)
RETURNS (RES INTEGER)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE FILEDELETE (FILENAME VARCHAR(255) CHARACTER SET NONE)
RETURNS (RES INTEGER)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE FILERENAME (OLDFILENAME VARCHAR(255) CHARACTER SET NONE,
NEWFILENAME VARCHAR(255) CHARACTER SET NONE)
RETURNS (RES INTEGER)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE GET_ALPHA (WK_CODE VARCHAR(20) CHARACTER SET NONE)
RETURNS (WK_NEW_CODE VARCHAR(20) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE GET_ALPHA_NUMERIC (WK_CODE VARCHAR(20) CHARACTER SET NONE)
RETURNS (WK_NEW_CODE VARCHAR(20) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE GET_BARCODE_LENGTH RETURNS (BARCODE_LENGTH INTEGER)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE GET_CURRENT_PROD_STATUS AS 
BEGIN EXIT; END ^
CREATE PROCEDURE GET_DATA_REFERENCE_FIELD4 (REFERENCE VARCHAR(1024) CHARACTER SET NONE,
WK_DELIMITER CHAR(1) CHARACTER SET NONE)
RETURNS (WK_FIELD_LABEL VARCHAR(1024) CHARACTER SET NONE,
WK_FIELD_DATA VARCHAR(1024) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE GET_EMP_IMAGE_ID RETURNS (IMAGE_ID INTEGER)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE GET_EMP_NO RETURNS (EMPLOYEE_ID VARCHAR(10) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE GET_FORM_NO RETURNS (FORM_NO VARCHAR(8) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE GET_GLOBAL_CONDITION (OTHER_NO INTEGER,
RESULT CHAR(1) CHARACTER SET NONE)
RETURNS (DESCRIPTION VARCHAR(30) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE GET_HANDHELD_TRANSFERS (DEVICE_ID VARCHAR(2) CHARACTER SET NONE)
RETURNS (PICK_ORDER VARCHAR(30) CHARACTER SET NONE,
PROD_ID VARCHAR(30) CHARACTER SET NONE,
SHORT_DESC VARCHAR(50) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE GET_ISSN_REPLENISH AS 
BEGIN EXIT; END ^
CREATE PROCEDURE GET_LENGTH (DATA_ID VARCHAR(20) CHARACTER SET NONE)
RETURNS (MAX_LENGTH INTEGER)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE GET_LOAD_NO RETURNS (LOAD_ID VARCHAR(10) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE GET_LOAN_ID RETURNS (LOAN_ID INTEGER)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE GET_LOAN_LINE_ID (LOAN_ORDER_NO INTEGER)
RETURNS (LOAN_ORDER_LINE_NO INTEGER)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE GET_NEXT_MESSAGE RETURNS (MESSAGE_ID VARCHAR(10) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE GET_NEXT_PUTAWAY RETURNS (PUTAWAY_ID VARCHAR(10) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE GET_NEXT_SSN RETURNS (SSN_ID VARCHAR(20) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE GET_NUMERIC (WK_CODE VARCHAR(20) CHARACTER SET NONE)
RETURNS (WK_NEW_CODE VARCHAR(20) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE GET_OBJECT_ID RETURNS (UNIQUEID INTEGER)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE GET_PICK_INVOICE_NO RETURNS (PICK_INVOICE_NO VARCHAR(10) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE GET_PICK_LABEL_NO RETURNS (PICK_LABEL_NO VARCHAR(7) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE GET_PO_LINE_NO (PURCHASE_ORDER VARCHAR(10) CHARACTER SET NONE)
RETURNS (PO_LINE INTEGER)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE GET_PO_ORDER_NO (ORDER_TYPE CHAR(2) CHARACTER SET NONE)
RETURNS (ORDER_ID VARCHAR(10) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE GET_QTY_LABEL (REFERENCE VARCHAR(40) CHARACTER SET NONE)
RETURNS (QTY_LABEL INTEGER)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE GET_REFERENCE_FIELD (REFERENCE VARCHAR(256) CHARACTER SET NONE,
FIELD_NO INTEGER)
RETURNS (WK_FIELD_TEXT VARCHAR(256) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE GET_REFERENCE_FIELD4 (REFERENCE VARCHAR(1024) CHARACTER SET NONE,
FIELD_NO INTEGER,
WK_DELIMITER CHAR(1) CHARACTER SET NONE)
RETURNS (WK_FIELD_TEXT VARCHAR(1024) CHARACTER SET NONE,
WK_AT_END CHAR(1) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE GET_SALE_LINES_NO (PICK_ORDER VARCHAR(10) CHARACTER SET NONE)
RETURNS (PICK_ORDER_LINE_NO VARCHAR(4) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE GET_SALE_LINE_NO (SALE_ORDER_ID VARCHAR(10) CHARACTER SET NONE)
RETURNS (SALE_ORDER_LINE_NO INTEGER)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE GET_SALE_ORDER_NO (ORDER_PREFIX CHAR(1) CHARACTER SET NONE)
RETURNS (SALE_ORDER_ID VARCHAR(10) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE GET_TABLE_DATA (IN_TABLE VARCHAR(40) CHARACTER SET NONE,
IN_FIELD_DELIMITER CHAR(1) CHARACTER SET NONE,
IN_DATA_DELIMITER CHAR(1) CHARACTER SET NONE,
IN_WHERE VARCHAR(100) CHARACTER SET NONE)
RETURNS (OUT_DATA VARCHAR(32000) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE GET_TRANSACTION_ID RETURNS (TRANSID INTEGER)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE LOCATION_CALC_PRODUCT (WH_ID CHAR(2) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE LOCN_STATISTICS (IN_WH_ID CHAR(2) CHARACTER SET NONE,
IN_LOCN_ID VARCHAR(20) CHARACTER SET NONE,
IN_OVERALL_WEIGHT CHAR(1) CHARACTER SET NONE,
IN_TARE_WEIGHT CHAR(1) CHARACTER SET NONE,
IN_MOBILE_WEIGHT CHAR(1) CHARACTER SET NONE,
IN_SSN_WEIGHT CHAR(1) CHARACTER SET NONE,
IN_PROD_WEIGHT CHAR(1) CHARACTER SET NONE,
IN_ISSUES CHAR(1) CHARACTER SET NONE)
RETURNS (WK_WT_OVERALL NUMERIC(15, 3),
WK_WT_TARE NUMERIC(15, 3),
WK_WT_MOBILE NUMERIC(15, 3),
WK_WT_SSN NUMERIC(15, 3),
WK_WT_PROD NUMERIC(15, 3),
WK_ISSUE_PROD INTEGER)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE LOGIN_DEVICE (IP_ADDRESS VARCHAR(40) CHARACTER SET NONE,
COMPUTER_NAME VARCHAR(50) CHARACTER SET NONE,
USER_ID VARCHAR(10) CHARACTER SET NONE)
RETURNS (DEVICE_ID CHAR(2) CHARACTER SET NONE,
LG_STATUS INTEGER,
LG_MESSAGE VARCHAR(80) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE LOGOUT_DEVICE (DEVICE_ID CHAR(2) CHARACTER SET NONE)
RETURNS (LG_STATUS INTEGER,
LG_MESSAGE VARCHAR(50) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE MANIFEST_DATA (CONNOTE VARCHAR(20) CHARACTER SET NONE,
DO_CONSOLIDATION CHAR(1) CHARACTER SET NONE,
ORDER_TYPE CHAR(2) CHARACTER SET NONE)
RETURNS (PICK_ORDER VARCHAR(15) CHARACTER SET NONE,
WH_ID CHAR(2) CHARACTER SET NONE,
PICK_LOCATION VARCHAR(10) CHARACTER SET NONE,
AWB_CONSIGNMENT_NO VARCHAR(20) CHARACTER SET NONE,
PICKED_QTY INTEGER,
PICK_ORDER_QTY INTEGER,
PICKD_POST_CODE VARCHAR(10) CHARACTER SET NONE,
PICKD_SUBURB VARCHAR(50) CHARACTER SET NONE,
P_FIRST_NAME VARCHAR(50) CHARACTER SET NONE,
P_ADDRESS_LINE1 VARCHAR(100) CHARACTER SET NONE,
P_LAST_NAME VARCHAR(50) CHARACTER SET NONE,
P_ADDRESS_LINE2 VARCHAR(50) CHARACTER SET NONE,
P_CITY VARCHAR(25) CHARACTER SET NONE,
P_STATE VARCHAR(15) CHARACTER SET NONE,
P_POST_CODE VARCHAR(10) CHARACTER SET NONE,
P_COUNTRY VARCHAR(25) CHARACTER SET NONE,
P_PHONE VARCHAR(30) CHARACTER SET NONE,
SHIP_VIA VARCHAR(10) CHARACTER SET NONE,
CREATED_BY VARCHAR(10) CHARACTER SET NONE,
CREATE_DATE TIMESTAMP,
PICK_ORDER_TYPE CHAR(2) CHARACTER SET NONE,
PICK_ORDER_LINE_NO CHAR(4) CHARACTER SET NONE,
SSN_ID VARCHAR(20) CHARACTER SET NONE,
WARRANTY_TERM VARCHAR(50) CHARACTER SET NONE,
SPECIAL_INSTRUCTIONS1 VARCHAR(8196) CHARACTER SET NONE,
SPECIAL_INSTRUCTIONS2 VARCHAR(255) CHARACTER SET NONE,
INV_WITH_GOODS CHAR(1) CHARACTER SET NONE,
CUSTOMER_PO_WO VARCHAR(20) CHARACTER SET NONE,
PROD_ID VARCHAR(30) CHARACTER SET NONE,
SHORT_DESC VARCHAR(50) CHARACTER SET NONE,
SSN_DESCRIPTION VARCHAR(80) CHARACTER SET NONE,
LEGACY_ID VARCHAR(20) CHARACTER SET NONE,
CONTACT_NAME VARCHAR(50) CHARACTER SET NONE,
P_ADDRESS_LINE3 VARCHAR(50) CHARACTER SET NONE,
P_ADDRESS_LINE4 VARCHAR(50) CHARACTER SET NONE,
P_TITLE VARCHAR(10) CHARACTER SET NONE,
P_AUST_POST_4STATE_ID VARCHAR(255) CHARACTER SET NONE,
P_ADDRESS_LINE5 VARCHAR(50) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE MANIFEST_DELIVERY (IN_PICK_ORDER VARCHAR(15) CHARACTER SET NONE)
RETURNS (PO_PICK_ORDER VARCHAR(15) CHARACTER SET NONE,
PO_P_FIRST_NAME VARCHAR(50) CHARACTER SET NONE,
PO_P_LAST_NAME VARCHAR(50) CHARACTER SET NONE,
PO_P_ADDRESS_LINE1 VARCHAR(100) CHARACTER SET NONE,
PO_P_ADDRESS_LINE2 VARCHAR(50) CHARACTER SET NONE,
PO_P_ADDRESS_LINE3 VARCHAR(50) CHARACTER SET NONE,
PO_P_ADDRESS_LINE4 VARCHAR(50) CHARACTER SET NONE,
PO_P_ADDRESS_LINE5 VARCHAR(50) CHARACTER SET NONE,
PO_P_CITY VARCHAR(25) CHARACTER SET NONE,
PO_P_STATE VARCHAR(15) CHARACTER SET NONE,
PO_P_POST_CODE VARCHAR(10) CHARACTER SET NONE,
PO_P_COUNTRY VARCHAR(25) CHARACTER SET NONE,
PO_P_PHONE VARCHAR(30) CHARACTER SET NONE,
PO_P_TITLE VARCHAR(10) CHARACTER SET NONE,
PO_P_AUST_POST_4STATE_ID VARCHAR(255) CHARACTER SET NONE,
PO_PERSON_ID VARCHAR(10) CHARACTER SET NONE,
PO_TERMS VARCHAR(20) CHARACTER SET NONE,
PO_PAYMENT_METHOD VARCHAR(20) CHARACTER SET NONE,
PO_P_PERSON_TYPE VARCHAR(2) CHARACTER SET NONE,
PO_P_PERSON_ID VARCHAR(10) CHARACTER SET NONE,
PO_P_SAME_AS_INVOICE_TO CHAR(1) CHARACTER SET NONE,
PO_OTHER1 VARCHAR(50) CHARACTER SET NONE,
PO_OTHER2 VARCHAR(50) CHARACTER SET NONE,
PO_OTHER3 VARCHAR(50) CHARACTER SET NONE,
PO_OTHER4 VARCHAR(50) CHARACTER SET NONE,
PO_OTHER5 VARCHAR(50) CHARACTER SET NONE,
PO_D_FIRST_NAME VARCHAR(50) CHARACTER SET NONE,
PO_D_LAST_NAME VARCHAR(50) CHARACTER SET NONE,
PO_D_ADDRESS_LINE1 VARCHAR(100) CHARACTER SET NONE,
PO_D_ADDRESS_LINE2 VARCHAR(50) CHARACTER SET NONE,
PO_D_ADDRESS_LINE3 VARCHAR(50) CHARACTER SET NONE,
PO_D_ADDRESS_LINE4 VARCHAR(50) CHARACTER SET NONE,
PO_D_ADDRESS_LINE5 VARCHAR(50) CHARACTER SET NONE,
PO_D_CITY VARCHAR(25) CHARACTER SET NONE,
PO_D_STATE VARCHAR(15) CHARACTER SET NONE,
PO_D_POST_CODE VARCHAR(10) CHARACTER SET NONE,
PO_D_COUNTRY VARCHAR(35) CHARACTER SET NONE,
PO_D_PHONE VARCHAR(30) CHARACTER SET NONE,
PO_D_TITLE VARCHAR(10) CHARACTER SET NONE,
PO_D_PERSON_ID VARCHAR(10) CHARACTER SET NONE,
PO_S_PERSON_TYPE CHAR(2) CHARACTER SET NONE,
PO_S_FIRST_NAME VARCHAR(50) CHARACTER SET NONE,
PO_S_LAST_NAME VARCHAR(50) CHARACTER SET NONE,
PO_S_ADDRESS_LINE1 VARCHAR(100) CHARACTER SET NONE,
PO_S_ADDRESS_LINE2 VARCHAR(50) CHARACTER SET NONE,
PO_S_ADDRESS_LINE3 VARCHAR(50) CHARACTER SET NONE,
PO_S_ADDRESS_LINE4 VARCHAR(50) CHARACTER SET NONE,
PO_S_ADDRESS_LINE5 VARCHAR(50) CHARACTER SET NONE,
PO_S_CITY VARCHAR(25) CHARACTER SET NONE,
PO_S_STATE VARCHAR(15) CHARACTER SET NONE,
PO_S_POST_CODE VARCHAR(10) CHARACTER SET NONE,
PO_S_COUNTRY VARCHAR(35) CHARACTER SET NONE,
PO_S_PHONE VARCHAR(30) CHARACTER SET NONE,
PO_S_TITLE VARCHAR(10) CHARACTER SET NONE,
PO_S_PERSON_ID VARCHAR(10) CHARACTER SET NONE,
PO_SUPPLIER_ID VARCHAR(10) CHARACTER SET NONE,
PO_S_SAME_AS_SOLD_FROM CHAR(1) CHARACTER SET NONE,
PO_REMARKS1 VARCHAR(80) CHARACTER SET NONE,
PO_REMARKS2 VARCHAR(80) CHARACTER SET NONE,
PO_REMARKS3 VARCHAR(80) CHARACTER SET NONE,
PO_REMARKS4 VARCHAR(80) CHARACTER SET NONE,
PO_REMARKS5 VARCHAR(80) CHARACTER SET NONE,
PO_EXPORT_CATEGORY CHAR(1) CHARACTER SET NONE,
PO_PO_MATERIAL_SAFETY_DATA CHAR(1) CHARACTER SET NONE,
PO_SHIP_VIA VARCHAR(10) CHARACTER SET NONE,
PO_CREATED_BY VARCHAR(10) CHARACTER SET NONE,
PO_CREATE_DATE TIMESTAMP,
PO_PICK_ORDER_TYPE CHAR(2) CHARACTER SET NONE,
PO_SPECIAL_INSTRUCTIONS1 VARCHAR(8196) CHARACTER SET NONE,
PO_SPECIAL_INSTRUCTIONS2 VARCHAR(255) CHARACTER SET NONE,
PO_INV_WITH_GOODS CHAR(1) CHARACTER SET NONE,
PO_CUSTOMER_PO_WO VARCHAR(20) CHARACTER SET NONE,
PO_CONTACT_NAME VARCHAR(50) CHARACTER SET NONE,
PO_PICK_STATUS CHAR(2) CHARACTER SET NONE,
PO_EARLIEST_DATE TIMESTAMP,
PO_RETURN_DATE TIMESTAMP,
PO_PRINTED_DATE TIMESTAMP,
PO_PICK_DUE_DATE TIMESTAMP,
PO_DESPATCH_LOCATION VARCHAR(10) CHARACTER SET NONE,
PO_TOTAL_LOAN_DAYS INTEGER,
PO_D_WH_ID CHAR(2) CHARACTER SET NONE,
PO_WH_ID CHAR(2) CHARACTER SET NONE,
IS_SSN_ID VARCHAR(20) CHARACTER SET NONE,
IS_WH_ID CHAR(2) CHARACTER SET NONE,
IS_LOCN_ID VARCHAR(10) CHARACTER SET NONE,
IS_CURRENT_QTY INTEGER,
IS_ORIGINAL_SSN VARCHAR(20) CHARACTER SET NONE,
IS_PROD_ID VARCHAR(30) CHARACTER SET NONE,
SN_SSN_TYPE VARCHAR(40) CHARACTER SET NONE,
SN_SSN_DESCRIPTION VARCHAR(80) CHARACTER SET NONE,
SN_LEGACY_ID VARCHAR(20) CHARACTER SET NONE,
SN_NET_WEIGHT DOUBLE PRECISION,
SN_NET_WEIGHT_UOM CHAR(2) CHARACTER SET NONE,
SN_PURCHASE_PRICE DOUBLE PRECISION,
SN_LOAN_SAFETY_CHECK CHAR(1) CHARACTER SET NONE,
SN_LOAN_SAFETY_PASS CHAR(1) CHARACTER SET NONE,
SN_LOAN_LAST_SAFETY_CHECK_DATE TIMESTAMP,
SN_LOAN_SAFETY_PERIOD_NO INTEGER,
SN_LOAN_SAFETY_PERIOD CHAR(1) CHARACTER SET NONE,
SN_LOAN_CALIBRATE_CHECK CHAR(1) CHARACTER SET NONE,
SN_LOAN_CALIBRATE_PASS CHAR(1) CHARACTER SET NONE,
SN_LOAN_LAST_CALIBRATE_CHECK_DT TIMESTAMP,
SN_LOAN_CALIBRATE_PERIOD_NO INTEGER,
SN_LOAN_CALIBRATE_PERIOD CHAR(1) CHARACTER SET NONE,
ST_DESCRIPTION VARCHAR(50) CHARACTER SET NONE,
PROD_EXTENDED_PRICE DOUBLE PRECISION,
PP_SHORT_DESC VARCHAR(50) CHARACTER SET NONE,
PP_UOM CHAR(2) CHARACTER SET NONE,
PP_NET_WEIGHT DOUBLE PRECISION,
PP_NET_WEIGHT_UOM CHAR(2) CHARACTER SET NONE,
PP_PP_MATERIAL_SAFETY_DATA CHAR(1) CHARACTER SET NONE,
PP_PP_MATERIAL_SAFETY_DATA_NO VARCHAR(40) CHARACTER SET NONE,
PP_SALE_PRICE DOUBLE PRECISION)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE MANIFEST_ISSN (IN_WH_ID CHAR(2) CHARACTER SET NONE,
IN_COMPANY_ID VARCHAR(20) CHARACTER SET NONE,
IN_PROD_ID VARCHAR(30) CHARACTER SET NONE,
IN_START_DATE TIMESTAMP,
IN_END_DATE TIMESTAMP)
RETURNS (IS_PROD_ID VARCHAR(30) CHARACTER SET NONE,
IS_METHOD_NAME VARCHAR(15) CHARACTER SET NONE,
IS_QTY INTEGER,
IS_DATE TIMESTAMP)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE MANIFEST_ORDER (PICK_ORDER VARCHAR(15) CHARACTER SET NONE)
RETURNS (DESPATCH_ID VARCHAR(20) CHARACTER SET NONE,
AWB_CONSIGNMENT_NO VARCHAR(20) CHARACTER SET NONE,
USER_ID VARCHAR(10) CHARACTER SET NONE,
DESPATCH_STATUS CHAR(2) CHARACTER SET NONE,
ORDER_TYPE CHAR(2) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE NEXT_GRN_ID RETURNS (GRN VARCHAR(10) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE NEXT_GRN_ORDER_LABEL RETURNS (LABEL_NO VARCHAR(20) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE NEXT_PICK_LABEL RETURNS (LABEL_NO VARCHAR(7) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE NEXT_PICK_QUEUE_LABEL (DEVICE_ID CHAR(2) CHARACTER SET NONE)
RETURNS (PICK_ORDER VARCHAR(10) CHARACTER SET NONE,
PRODUCED_DATE TIMESTAMP,
ZONE_DEVICE_ID CHAR(2) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE NONULLP (L_VALOR VARCHAR(1024) CHARACTER SET NONE)
RETURNS (R_VALOR VARCHAR(1024) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE ORDER_ITEM_STATUS_UPDATE (PICK_LABEL_NUMBER VARCHAR(40) CHARACTER SET NONE,
STATUS_CODE CHAR(3) CHARACTER SET NONE)
RETURNS (ERRORTEXT VARCHAR(80) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE ORDER_STATUS_UPDATE (ORDER_NO VARCHAR(40) CHARACTER SET NONE,
STATUS_CODE CHAR(3) CHARACTER SET NONE)
RETURNS (ERRORTEXT VARCHAR(80) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE PC_ADD_PROD_COND_STATUS (RECORD_ID INTEGER,
WH_ID CHAR(2) CHARACTER SET NONE,
LOCN_ID VARCHAR(10) CHARACTER SET NONE,
OBJECT VARCHAR(30) CHARACTER SET NONE,
TRN_TYPE VARCHAR(4) CHARACTER SET NONE,
TRN_CODE CHAR(1) CHARACTER SET NONE,
TRN_DATE TIMESTAMP,
REFERENCE VARCHAR(40) CHARACTER SET NONE,
QTY INTEGER,
PERSON_ID VARCHAR(10) CHARACTER SET NONE,
DEVICE_ID CHAR(2) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE PC_AULO (RECORD_ID INTEGER,
WH_ID CHAR(2) CHARACTER SET NONE,
LOCN_ID VARCHAR(10) CHARACTER SET NONE,
TRN_DATE TIMESTAMP)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE PC_AUOB (RECORD_ID INTEGER,
WH_ID CHAR(2) CHARACTER SET NONE,
LOCN_ID VARCHAR(10) CHARACTER SET NONE,
OBJECT VARCHAR(30) CHARACTER SET NONE,
TRN_TYPE VARCHAR(4) CHARACTER SET NONE,
TRN_CODE CHAR(1) CHARACTER SET NONE,
TRN_DATE TIMESTAMP,
REFERENCE VARCHAR(40) CHARACTER SET NONE,
QTY INTEGER,
PERSON_ID VARCHAR(10) CHARACTER SET NONE,
DEVICE_ID CHAR(2) CHARACTER SET NONE,
INSTANCE_ID VARCHAR(10) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE PC_DELETE_ONE_PROD_COND_STATUS (RECORD_ID INTEGER,
WH_ID CHAR(2) CHARACTER SET NONE,
LOCN_ID VARCHAR(10) CHARACTER SET NONE,
OBJECT VARCHAR(30) CHARACTER SET NONE,
TRN_TYPE VARCHAR(4) CHARACTER SET NONE,
TRN_CODE CHAR(1) CHARACTER SET NONE,
TRN_DATE TIMESTAMP,
REFERENCE VARCHAR(40) CHARACTER SET NONE,
QTY INTEGER,
PERSON_ID VARCHAR(10) CHARACTER SET NONE,
DEVICE_ID CHAR(2) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE PC_DSDX (RECORD_ID INTEGER,
WH_ID CHAR(2) CHARACTER SET NONE,
LOCN_ID VARCHAR(10) CHARACTER SET NONE,
OBJECT VARCHAR(30) CHARACTER SET NONE,
TRN_TYPE VARCHAR(4) CHARACTER SET NONE,
TRN_CODE CHAR(1) CHARACTER SET NONE,
TRN_DATE TIMESTAMP,
REFERENCE VARCHAR(40) CHARACTER SET NONE,
QTY INTEGER,
PERSON_ID VARCHAR(10) CHARACTER SET NONE,
DEVICE_ID CHAR(2) CHARACTER SET NONE,
SUB_LOCN VARCHAR(10) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE PC_DSDX_LOCATION (WK_LOCN VARCHAR(10) CHARACTER SET NONE,
WK_END_TIME VARCHAR(30) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE PC_EXPORT_DESPATCH (WK_DESPATCH_ID INTEGER,
WK_PRINTER CHAR(2) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE PC_GROUP_COPY (OBJECT VARCHAR(30) CHARACTER SET NONE,
SSN_TYPE VARCHAR(40) CHARACTER SET NONE,
GENERIC VARCHAR(40) CHARACTER SET NONE,
BRAND VARCHAR(40) CHARACTER SET NONE,
MODEL VARCHAR(40) CHARACTER SET NONE,
PROD_ID VARCHAR(30) CHARACTER SET NONE,
SUPPLIER_ID VARCHAR(40) CHARACTER SET NONE,
OTHER6 VARCHAR(50) CHARACTER SET NONE,
OTHER7 VARCHAR(50) CHARACTER SET NONE,
OTHER8 VARCHAR(50) CHARACTER SET NONE,
OTHER9 VARCHAR(50) CHARACTER SET NONE,
OTHER10 VARCHAR(50) CHARACTER SET NONE,
DESCRIPTION VARCHAR(50) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE PC_INDUCTION_FORM (QTY INTEGER,
PERSON_ID VARCHAR(10) CHARACTER SET NONE)
RETURNS (RES INTEGER)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE PC_ISSN_TRANSFER (SSN_ID CHAR(20) CHARACTER SET NONE,
TO_WH_ID CHAR(2) CHARACTER SET NONE,
TO_LOCN_ID CHAR(10) CHARACTER SET NONE,
UPDATE_SSN CHAR(1) CHARACTER SET NONE,
STATUS CHAR(2) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE PC_LABEL (DEVICE_ID CHAR(2) CHARACTER SET NONE,
PRN_TYPE VARCHAR(40) CHARACTER SET NONE,
PRN_COPY INTEGER,
PRN_FILE_NAME VARCHAR(70) CHARACTER SET NONE,
PRN_DATA VARCHAR(32000) CHARACTER SET NONE,
PERSON_ID VARCHAR(10) CHARACTER SET NONE)
RETURNS (RES INTEGER,
ERROR_TEXT VARCHAR(1024) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE PC_LABEL_BARCODE (REFERENCE VARCHAR(40) CHARACTER SET NONE)
RETURNS (RES INTEGER)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE PC_LABEL_DESPATCH (WK_ORDER VARCHAR(15) CHARACTER SET NONE,
WK_PRINTER CHAR(2) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE PC_LABEL_GRN (DEVICE_ID CHAR(2) CHARACTER SET NONE,
PRN_COPY INTEGER,
GRN VARCHAR(10) CHARACTER SET NONE,
GRN_LABEL_NO VARCHAR(10) CHARACTER SET NONE,
PERSON_ID VARCHAR(10) CHARACTER SET NONE)
RETURNS (RES INTEGER,
ERROR_TEXT VARCHAR(1024) CHARACTER SET NONE,
DO_BARTENDER CHAR(1) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE PC_LABEL_ISSN (REFERENCE VARCHAR(40) CHARACTER SET NONE)
RETURNS (RES INTEGER)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE PC_LABEL_LATER (PRINT_DEVICE_ID CHAR(2) CHARACTER SET NONE,
PRN_TYPE VARCHAR(40) CHARACTER SET NONE,
PRN_COPY INTEGER,
PRN_FILE_NAME VARCHAR(70) CHARACTER SET NONE,
PRN_DATA VARCHAR(32000) CHARACTER SET NONE,
PERSON_ID VARCHAR(10) CHARACTER SET NONE,
DEVICE_ID CHAR(2) CHARACTER SET NONE)
RETURNS (RES INTEGER,
ERROR_TEXT VARCHAR(1024) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE PC_LABEL_LOAD (WH_ID VARCHAR(2) CHARACTER SET NONE,
REFERENCE VARCHAR(40) CHARACTER SET NONE,
LABEL_NO INTEGER)
RETURNS (RES INTEGER)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE PC_LABEL_LOCATION (REFERENCE VARCHAR(40) CHARACTER SET NONE)
RETURNS (RES INTEGER)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE PC_LABEL_LOC_ISSN (REFERENCE VARCHAR(40) CHARACTER SET NONE)
RETURNS (RES INTEGER)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE PC_LABEL_PICK (REFERENCE VARCHAR(40) CHARACTER SET NONE)
RETURNS (RES INTEGER)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE PC_LABEL_PRODUCT (REFERENCE VARCHAR(40) CHARACTER SET NONE)
RETURNS (RES INTEGER)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE PC_LABEL_SALE_ORDER (REFERENCE VARCHAR(40) CHARACTER SET NONE)
RETURNS (WK_RESULT INTEGER)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE PC_LABEL_SO_PRINT (WK_FILE_PATH2 VARCHAR(70) CHARACTER SET NONE,
WK_PRINTER_DEVICE CHAR(2) CHARACTER SET NONE,
WK_ORDER VARCHAR(40) CHARACTER SET NONE,
WK_PO_COMPANY_ID VARCHAR(20) CHARACTER SET NONE,
WK_PO_CUSTOMER_PO_WO VARCHAR(20) CHARACTER SET NONE,
WK_PO_PICK_DUE_DATE VARCHAR(10) CHARACTER SET NONE,
WK_PO_PERSON_ID VARCHAR(10) CHARACTER SET NONE,
WK_PO_CONTACT_NAME VARCHAR(50) CHARACTER SET NONE,
WK_PO_SPECIAL_INSTRUCTIONS1 VARCHAR(255) CHARACTER SET NONE,
WK_PO_SPECIAL_INSTRUCTIONS2 VARCHAR(255) CHARACTER SET NONE,
WK_PO_FREIGHT NUMERIC(9, 2),
WK_PO_PAYMENT_METHOD VARCHAR(20) CHARACTER SET NONE,
WK_PO_TERMS VARCHAR(20) CHARACTER SET NONE,
WK_PO_AMOUNT_PAID NUMERIC(9, 2),
WK_PO_SHIP_VIA VARCHAR(10) CHARACTER SET NONE,
WK_PO_OTHER1 VARCHAR(50) CHARACTER SET NONE,
WK_PO_OTHER2 VARCHAR(50) CHARACTER SET NONE,
WK_PO_OTHER3 VARCHAR(50) CHARACTER SET NONE,
WK_PO_OTHER4 VARCHAR(50) CHARACTER SET NONE,
WK_PO_OTHER5 VARCHAR(50) CHARACTER SET NONE,
WK_PO_OTHER6 VARCHAR(50) CHARACTER SET NONE,
WK_PO_OTHER7 VARCHAR(50) CHARACTER SET NONE,
WK_PO_OTHER8 VARCHAR(50) CHARACTER SET NONE,
WK_PO_OTHER9 VARCHAR(50) CHARACTER SET NONE,
WK_PO_P_FIRST_NAME VARCHAR(50) CHARACTER SET NONE,
WK_PO_P_ADDRESS_LINE1 VARCHAR(100) CHARACTER SET NONE,
WK_PO_P_ADDRESS_LINE2 VARCHAR(50) CHARACTER SET NONE,
WK_PO_P_ADDRESS_LINE3 VARCHAR(50) CHARACTER SET NONE,
WK_PO_P_ADDRESS_LINE4 VARCHAR(50) CHARACTER SET NONE,
WK_PO_P_ADDRESS_LINE5 VARCHAR(50) CHARACTER SET NONE,
WK_PO_P_POST_CODE VARCHAR(10) CHARACTER SET NONE,
WK_PO_P_COUNTRY VARCHAR(25) CHARACTER SET NONE,
WK_PO_OVER_SIZED VARCHAR(1) CHARACTER SET NONE,
WK_PO_NET_WEIGHT NUMERIC(9, 3),
WK_PO_TAX_AMOUNT NUMERIC(9, 2),
WK_PO_SUB_TOTAL_AMOUNT NUMERIC(9, 2),
WK_PO_FREIGHT_TAX_AMOUNT NUMERIC(9, 2),
WK_PO_PALLET_BASE VARCHAR(30) CHARACTER SET NONE,
WK_CONTINUE VARCHAR(10) CHARACTER SET NONE,
WK_PI_1_BAY SMALLINT,
WK_PI_1_SHELF SMALLINT,
WK_PI_1_COMPARTMENT SMALLINT,
WK_PI_1_SHELF_COMP VARCHAR(4) CHARACTER SET NONE,
WK_PI_1_PROD_ID VARCHAR(30) CHARACTER SET NONE,
WK_PI_1_PICK_ORDER_QTY INTEGER,
WK_PI_1_SALE_PRICE NUMERIC(9, 2),
WK_PI_1_TAX_AMOUNT NUMERIC(9, 2),
WK_PI_1_LINE_TOTAL NUMERIC(9, 2),
WK_PI_1_OTHER1 VARCHAR(50) CHARACTER SET NONE,
WK_PI_1_OTHER2 VARCHAR(50) CHARACTER SET NONE,
WK_PI_1_OTHER3 VARCHAR(50) CHARACTER SET NONE,
WK_PI_1_OTHER4 VARCHAR(50) CHARACTER SET NONE,
WK_PI_1_OTHER5 VARCHAR(50) CHARACTER SET NONE,
WK_PI_1_OTHER6 VARCHAR(50) CHARACTER SET NONE,
WK_PI_1_OTHER7 VARCHAR(50) CHARACTER SET NONE,
WK_PI_1_OTHER8 VARCHAR(50) CHARACTER SET NONE,
WK_PI_1_OTHER9 VARCHAR(50) CHARACTER SET NONE,
WK_PI_1_WH_ID VARCHAR(2) CHARACTER SET NONE,
WK_PI_1_PICK_LOCATION VARCHAR(10) CHARACTER SET NONE,
WK_PI_1_OVER_SIZED VARCHAR(1) CHARACTER SET NONE,
WK_PI_1_SPECIAL_INSTRUCTIONS1 VARCHAR(255) CHARACTER SET NONE,
WK_PI_1_SPECIAL_INSTRUCTIONS2 VARCHAR(255) CHARACTER SET NONE,
WK_PP_1_SHORT_DESC VARCHAR(50) CHARACTER SET NONE,
WK_PI_2_BAY SMALLINT,
WK_PI_2_SHELF SMALLINT,
WK_PI_2_COMPARTMENT SMALLINT,
WK_PI_2_SHELF_COMP VARCHAR(4) CHARACTER SET NONE,
WK_PI_2_PROD_ID VARCHAR(30) CHARACTER SET NONE,
WK_PI_2_PICK_ORDER_QTY INTEGER,
WK_PI_2_SALE_PRICE NUMERIC(9, 2),
WK_PI_2_TAX_AMOUNT NUMERIC(9, 2),
WK_PI_2_LINE_TOTAL NUMERIC(9, 2),
WK_PI_2_OTHER1 VARCHAR(50) CHARACTER SET NONE,
WK_PI_2_OTHER2 VARCHAR(50) CHARACTER SET NONE,
WK_PI_2_OTHER3 VARCHAR(50) CHARACTER SET NONE,
WK_PI_2_OTHER4 VARCHAR(50) CHARACTER SET NONE,
WK_PI_2_OTHER5 VARCHAR(50) CHARACTER SET NONE,
WK_PI_2_OTHER6 VARCHAR(50) CHARACTER SET NONE,
WK_PI_2_OTHER7 VARCHAR(50) CHARACTER SET NONE,
WK_PI_2_OTHER8 VARCHAR(50) CHARACTER SET NONE,
WK_PI_2_OTHER9 VARCHAR(50) CHARACTER SET NONE,
WK_PI_2_WH_ID VARCHAR(2) CHARACTER SET NONE,
WK_PI_2_PICK_LOCATION VARCHAR(10) CHARACTER SET NONE,
WK_PI_2_OVER_SIZED VARCHAR(1) CHARACTER SET NONE,
WK_PI_2_SPECIAL_INSTRUCTIONS1 VARCHAR(255) CHARACTER SET NONE,
WK_PI_2_SPECIAL_INSTRUCTIONS2 VARCHAR(255) CHARACTER SET NONE,
WK_PP_2_SHORT_DESC VARCHAR(50) CHARACTER SET NONE,
WK_PI_3_BAY SMALLINT,
WK_PI_3_SHELF SMALLINT,
WK_PI_3_COMPARTMENT SMALLINT,
WK_PI_3_SHELF_COMP VARCHAR(4) CHARACTER SET NONE,
WK_PI_3_PROD_ID VARCHAR(30) CHARACTER SET NONE,
WK_PI_3_PICK_ORDER_QTY INTEGER,
WK_PI_3_SALE_PRICE NUMERIC(9, 2),
WK_PI_3_TAX_AMOUNT NUMERIC(9, 2),
WK_PI_3_LINE_TOTAL NUMERIC(9, 2),
WK_PI_3_OTHER1 VARCHAR(50) CHARACTER SET NONE,
WK_PI_3_OTHER2 VARCHAR(50) CHARACTER SET NONE,
WK_PI_3_OTHER3 VARCHAR(50) CHARACTER SET NONE,
WK_PI_3_OTHER4 VARCHAR(50) CHARACTER SET NONE,
WK_PI_3_OTHER5 VARCHAR(50) CHARACTER SET NONE,
WK_PI_3_OTHER6 VARCHAR(50) CHARACTER SET NONE,
WK_PI_3_OTHER7 VARCHAR(50) CHARACTER SET NONE,
WK_PI_3_OTHER8 VARCHAR(50) CHARACTER SET NONE,
WK_PI_3_OTHER9 VARCHAR(50) CHARACTER SET NONE,
WK_PI_3_WH_ID VARCHAR(2) CHARACTER SET NONE,
WK_PI_3_PICK_LOCATION VARCHAR(10) CHARACTER SET NONE,
WK_PI_3_OVER_SIZED VARCHAR(1) CHARACTER SET NONE,
WK_PI_3_SPECIAL_INSTRUCTIONS1 VARCHAR(255) CHARACTER SET NONE,
WK_PI_3_SPECIAL_INSTRUCTIONS2 VARCHAR(255) CHARACTER SET NONE,
WK_PP_3_SHORT_DESC VARCHAR(50) CHARACTER SET NONE,
WK_PI_4_BAY SMALLINT,
WK_PI_4_SHELF SMALLINT,
WK_PI_4_COMPARTMENT SMALLINT,
WK_PI_4_SHELF_COMP VARCHAR(4) CHARACTER SET NONE,
WK_PI_4_PROD_ID VARCHAR(30) CHARACTER SET NONE,
WK_PI_4_PICK_ORDER_QTY INTEGER,
WK_PI_4_SALE_PRICE NUMERIC(9, 2),
WK_PI_4_TAX_AMOUNT NUMERIC(9, 2),
WK_PI_4_LINE_TOTAL NUMERIC(9, 2),
WK_PI_4_OTHER1 VARCHAR(50) CHARACTER SET NONE,
WK_PI_4_OTHER2 VARCHAR(50) CHARACTER SET NONE,
WK_PI_4_OTHER3 VARCHAR(50) CHARACTER SET NONE,
WK_PI_4_OTHER4 VARCHAR(50) CHARACTER SET NONE,
WK_PI_4_OTHER5 VARCHAR(50) CHARACTER SET NONE,
WK_PI_4_OTHER6 VARCHAR(50) CHARACTER SET NONE,
WK_PI_4_OTHER7 VARCHAR(50) CHARACTER SET NONE,
WK_PI_4_OTHER8 VARCHAR(50) CHARACTER SET NONE,
WK_PI_4_OTHER9 VARCHAR(50) CHARACTER SET NONE,
WK_PI_4_WH_ID VARCHAR(2) CHARACTER SET NONE,
WK_PI_4_PICK_LOCATION VARCHAR(10) CHARACTER SET NONE,
WK_PI_4_OVER_SIZED VARCHAR(1) CHARACTER SET NONE,
WK_PI_4_SPECIAL_INSTRUCTIONS1 VARCHAR(255) CHARACTER SET NONE,
WK_PI_4_SPECIAL_INSTRUCTIONS2 VARCHAR(255) CHARACTER SET NONE,
WK_PP_4_SHORT_DESC VARCHAR(50) CHARACTER SET NONE,
WK_PI_5_BAY SMALLINT,
WK_PI_5_SHELF SMALLINT,
WK_PI_5_COMPARTMENT SMALLINT,
WK_PI_5_SHELF_COMP VARCHAR(4) CHARACTER SET NONE,
WK_PI_5_PROD_ID VARCHAR(30) CHARACTER SET NONE,
WK_PI_5_PICK_ORDER_QTY INTEGER,
WK_PI_5_SALE_PRICE NUMERIC(9, 2),
WK_PI_5_TAX_AMOUNT NUMERIC(9, 2),
WK_PI_5_LINE_TOTAL NUMERIC(9, 2),
WK_PI_5_OTHER1 VARCHAR(50) CHARACTER SET NONE,
WK_PI_5_OTHER2 VARCHAR(50) CHARACTER SET NONE,
WK_PI_5_OTHER3 VARCHAR(50) CHARACTER SET NONE,
WK_PI_5_OTHER4 VARCHAR(50) CHARACTER SET NONE,
WK_PI_5_OTHER5 VARCHAR(50) CHARACTER SET NONE,
WK_PI_5_OTHER6 VARCHAR(50) CHARACTER SET NONE,
WK_PI_5_OTHER7 VARCHAR(50) CHARACTER SET NONE,
WK_PI_5_OTHER8 VARCHAR(50) CHARACTER SET NONE,
WK_PI_5_OTHER9 VARCHAR(50) CHARACTER SET NONE,
WK_PI_5_WH_ID VARCHAR(2) CHARACTER SET NONE,
WK_PI_5_PICK_LOCATION VARCHAR(10) CHARACTER SET NONE,
WK_PI_5_OVER_SIZED VARCHAR(1) CHARACTER SET NONE,
WK_PI_5_SPECIAL_INSTRUCTIONS1 VARCHAR(255) CHARACTER SET NONE,
WK_PI_5_SPECIAL_INSTRUCTIONS2 VARCHAR(255) CHARACTER SET NONE,
WK_PP_5_SHORT_DESC VARCHAR(50) CHARACTER SET NONE,
WK_PI_6_BAY SMALLINT,
WK_PI_6_SHELF SMALLINT,
WK_PI_6_COMPARTMENT SMALLINT,
WK_PI_6_SHELF_COMP VARCHAR(4) CHARACTER SET NONE,
WK_PI_6_PROD_ID VARCHAR(30) CHARACTER SET NONE,
WK_PI_6_PICK_ORDER_QTY INTEGER,
WK_PI_6_SALE_PRICE NUMERIC(9, 2),
WK_PI_6_TAX_AMOUNT NUMERIC(9, 2),
WK_PI_6_LINE_TOTAL NUMERIC(9, 2),
WK_PI_6_OTHER1 VARCHAR(50) CHARACTER SET NONE,
WK_PI_6_OTHER2 VARCHAR(50) CHARACTER SET NONE,
WK_PI_6_OTHER3 VARCHAR(50) CHARACTER SET NONE,
WK_PI_6_OTHER4 VARCHAR(50) CHARACTER SET NONE,
WK_PI_6_OTHER5 VARCHAR(50) CHARACTER SET NONE,
WK_PI_6_OTHER6 VARCHAR(50) CHARACTER SET NONE,
WK_PI_6_OTHER7 VARCHAR(50) CHARACTER SET NONE,
WK_PI_6_OTHER8 VARCHAR(50) CHARACTER SET NONE,
WK_PI_6_OTHER9 VARCHAR(50) CHARACTER SET NONE,
WK_PI_6_WH_ID VARCHAR(2) CHARACTER SET NONE,
WK_PI_6_PICK_LOCATION VARCHAR(10) CHARACTER SET NONE,
WK_PI_6_OVER_SIZED VARCHAR(1) CHARACTER SET NONE,
WK_PI_6_SPECIAL_INSTRUCTIONS1 VARCHAR(255) CHARACTER SET NONE,
WK_PI_6_SPECIAL_INSTRUCTIONS2 VARCHAR(255) CHARACTER SET NONE,
WK_PP_6_SHORT_DESC VARCHAR(50) CHARACTER SET NONE,
WK_PI_7_BAY SMALLINT,
WK_PI_7_SHELF SMALLINT,
WK_PI_7_COMPARTMENT SMALLINT,
WK_PI_7_SHELF_COMP VARCHAR(4) CHARACTER SET NONE,
WK_PI_7_PROD_ID VARCHAR(30) CHARACTER SET NONE,
WK_PI_7_PICK_ORDER_QTY INTEGER,
WK_PI_7_SALE_PRICE NUMERIC(9, 2),
WK_PI_7_TAX_AMOUNT NUMERIC(9, 2),
WK_PI_7_LINE_TOTAL NUMERIC(9, 2),
WK_PI_7_OTHER1 VARCHAR(50) CHARACTER SET NONE,
WK_PI_7_OTHER2 VARCHAR(50) CHARACTER SET NONE,
WK_PI_7_OTHER3 VARCHAR(50) CHARACTER SET NONE,
WK_PI_7_OTHER4 VARCHAR(50) CHARACTER SET NONE,
WK_PI_7_OTHER5 VARCHAR(50) CHARACTER SET NONE,
WK_PI_7_OTHER6 VARCHAR(50) CHARACTER SET NONE,
WK_PI_7_OTHER7 VARCHAR(50) CHARACTER SET NONE,
WK_PI_7_OTHER8 VARCHAR(50) CHARACTER SET NONE,
WK_PI_7_OTHER9 VARCHAR(50) CHARACTER SET NONE,
WK_PI_7_WH_ID VARCHAR(2) CHARACTER SET NONE,
WK_PI_7_PICK_LOCATION VARCHAR(10) CHARACTER SET NONE,
WK_PI_7_OVER_SIZED VARCHAR(1) CHARACTER SET NONE,
WK_PI_7_SPECIAL_INSTRUCTIONS1 VARCHAR(255) CHARACTER SET NONE,
WK_PI_7_SPECIAL_INSTRUCTIONS2 VARCHAR(255) CHARACTER SET NONE,
WK_PP_7_SHORT_DESC VARCHAR(50) CHARACTER SET NONE,
WK_PI_8_BAY SMALLINT,
WK_PI_8_SHELF SMALLINT,
WK_PI_8_COMPARTMENT SMALLINT,
WK_PI_8_SHELF_COMP VARCHAR(4) CHARACTER SET NONE,
WK_PI_8_PROD_ID VARCHAR(30) CHARACTER SET NONE,
WK_PI_8_PICK_ORDER_QTY INTEGER,
WK_PI_8_SALE_PRICE NUMERIC(9, 2),
WK_PI_8_TAX_AMOUNT NUMERIC(9, 2),
WK_PI_8_LINE_TOTAL NUMERIC(9, 2),
WK_PI_8_OTHER1 VARCHAR(50) CHARACTER SET NONE,
WK_PI_8_OTHER2 VARCHAR(50) CHARACTER SET NONE,
WK_PI_8_OTHER3 VARCHAR(50) CHARACTER SET NONE,
WK_PI_8_OTHER4 VARCHAR(50) CHARACTER SET NONE,
WK_PI_8_OTHER5 VARCHAR(50) CHARACTER SET NONE,
WK_PI_8_OTHER6 VARCHAR(50) CHARACTER SET NONE,
WK_PI_8_OTHER7 VARCHAR(50) CHARACTER SET NONE,
WK_PI_8_OTHER8 VARCHAR(50) CHARACTER SET NONE,
WK_PI_8_OTHER9 VARCHAR(50) CHARACTER SET NONE,
WK_PI_8_WH_ID VARCHAR(2) CHARACTER SET NONE,
WK_PI_8_PICK_LOCATION VARCHAR(10) CHARACTER SET NONE,
WK_PI_8_OVER_SIZED VARCHAR(1) CHARACTER SET NONE,
WK_PI_8_SPECIAL_INSTRUCTIONS1 VARCHAR(255) CHARACTER SET NONE,
WK_PI_8_SPECIAL_INSTRUCTIONS2 VARCHAR(255) CHARACTER SET NONE,
WK_PP_8_SHORT_DESC VARCHAR(50) CHARACTER SET NONE,
WK_PI_9_BAY SMALLINT,
WK_PI_9_SHELF SMALLINT,
WK_PI_9_COMPARTMENT SMALLINT,
WK_PI_9_SHELF_COMP VARCHAR(4) CHARACTER SET NONE,
WK_PI_9_PROD_ID VARCHAR(30) CHARACTER SET NONE,
WK_PI_9_PICK_ORDER_QTY INTEGER,
WK_PI_9_SALE_PRICE NUMERIC(9, 2),
WK_PI_9_TAX_AMOUNT NUMERIC(9, 2),
WK_PI_9_LINE_TOTAL NUMERIC(9, 2),
WK_PI_9_OTHER1 VARCHAR(50) CHARACTER SET NONE,
WK_PI_9_OTHER2 VARCHAR(50) CHARACTER SET NONE,
WK_PI_9_OTHER3 VARCHAR(50) CHARACTER SET NONE,
WK_PI_9_OTHER4 VARCHAR(50) CHARACTER SET NONE,
WK_PI_9_OTHER5 VARCHAR(50) CHARACTER SET NONE,
WK_PI_9_OTHER6 VARCHAR(50) CHARACTER SET NONE,
WK_PI_9_OTHER7 VARCHAR(50) CHARACTER SET NONE,
WK_PI_9_OTHER8 VARCHAR(50) CHARACTER SET NONE,
WK_PI_9_OTHER9 VARCHAR(50) CHARACTER SET NONE,
WK_PI_9_WH_ID VARCHAR(2) CHARACTER SET NONE,
WK_PI_9_PICK_LOCATION VARCHAR(10) CHARACTER SET NONE,
WK_PI_9_OVER_SIZED VARCHAR(1) CHARACTER SET NONE,
WK_PI_9_SPECIAL_INSTRUCTIONS1 VARCHAR(255) CHARACTER SET NONE,
WK_PI_9_SPECIAL_INSTRUCTIONS2 VARCHAR(255) CHARACTER SET NONE,
WK_PP_9_SHORT_DESC VARCHAR(50) CHARACTER SET NONE,
WK_PI_10_BAY SMALLINT,
WK_PI_10_SHELF SMALLINT,
WK_PI_10_COMPARTMENT SMALLINT,
WK_PI_10_SHELF_COMP VARCHAR(4) CHARACTER SET NONE,
WK_PI_10_PROD_ID VARCHAR(30) CHARACTER SET NONE,
WK_PI_10_PICK_ORDER_QTY INTEGER,
WK_PI_10_SALE_PRICE NUMERIC(9, 2),
WK_PI_10_TAX_AMOUNT NUMERIC(9, 2),
WK_PI_10_LINE_TOTAL NUMERIC(9, 2),
WK_PI_10_OTHER1 VARCHAR(50) CHARACTER SET NONE,
WK_PI_10_OTHER2 VARCHAR(50) CHARACTER SET NONE,
WK_PI_10_OTHER3 VARCHAR(50) CHARACTER SET NONE,
WK_PI_10_OTHER4 VARCHAR(50) CHARACTER SET NONE,
WK_PI_10_OTHER5 VARCHAR(50) CHARACTER SET NONE,
WK_PI_10_OTHER6 VARCHAR(50) CHARACTER SET NONE,
WK_PI_10_OTHER7 VARCHAR(50) CHARACTER SET NONE,
WK_PI_10_OTHER8 VARCHAR(50) CHARACTER SET NONE,
WK_PI_10_OTHER9 VARCHAR(50) CHARACTER SET NONE,
WK_PI_10_WH_ID VARCHAR(2) CHARACTER SET NONE,
WK_PI_10_PICK_LOCATION VARCHAR(10) CHARACTER SET NONE,
WK_PI_10_OVER_SIZED VARCHAR(1) CHARACTER SET NONE,
WK_PI_10_SPECIAL_INSTRUCTIONS1 VARCHAR(255) CHARACTER SET NONE,
WK_PI_10_SPECIAL_INSTRUCTIONS2 VARCHAR(255) CHARACTER SET NONE,
WK_PP_10_SHORT_DESC VARCHAR(50) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE PC_LABEL_SO_PRINT_LINE (WK_FILE_PATH2 VARCHAR(70) CHARACTER SET NONE,
WK_PI_1_BAY VARCHAR(20) CHARACTER SET NONE,
WK_PI_1_SHELF VARCHAR(20) CHARACTER SET NONE,
WK_PI_1_COMPARTMENT VARCHAR(20) CHARACTER SET NONE,
WK_PI_1_SHELF_COMP VARCHAR(20) CHARACTER SET NONE,
WK_PI_1_PROD_ID VARCHAR(30) CHARACTER SET NONE,
WK_PI_1_PICK_ORDER_QTY VARCHAR(20) CHARACTER SET NONE,
WK_PI_1_SALE_PRICE VARCHAR(20) CHARACTER SET NONE,
WK_PI_1_TAX_AMOUNT VARCHAR(20) CHARACTER SET NONE,
WK_PI_1_LINE_TOTAL VARCHAR(20) CHARACTER SET NONE,
WK_PI_1_OTHER1 VARCHAR(50) CHARACTER SET NONE,
WK_PI_1_OTHER2 VARCHAR(50) CHARACTER SET NONE,
WK_PI_1_OTHER3 VARCHAR(50) CHARACTER SET NONE,
WK_PI_1_OTHER4 VARCHAR(50) CHARACTER SET NONE,
WK_PI_1_OTHER5 VARCHAR(50) CHARACTER SET NONE,
WK_PI_1_OTHER6 VARCHAR(50) CHARACTER SET NONE,
WK_PI_1_OTHER7 VARCHAR(50) CHARACTER SET NONE,
WK_PI_1_OTHER8 VARCHAR(50) CHARACTER SET NONE,
WK_PI_1_OTHER9 VARCHAR(50) CHARACTER SET NONE,
WK_PI_1_WH_ID VARCHAR(20) CHARACTER SET NONE,
WK_PI_1_PICK_LOCATION VARCHAR(20) CHARACTER SET NONE,
WK_PI_1_OVER_SIZED VARCHAR(20) CHARACTER SET NONE,
WK_PI_1_SPECIAL_INSTRUCTIONS1 VARCHAR(255) CHARACTER SET NONE,
WK_PI_1_SPECIAL_INSTRUCTIONS2 VARCHAR(255) CHARACTER SET NONE,
WK_PP_1_SHORT_DESC VARCHAR(50) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE PC_LABEL_SPLIT (WH_ID VARCHAR(2) CHARACTER SET NONE,
PRINTED_BY VARCHAR(10) CHARACTER SET NONE,
LABEL_NO INTEGER,
PASSED_SSN_LENGTH INTEGER,
PRINTER_NAME VARCHAR(2) CHARACTER SET NONE)
RETURNS (ISSN VARCHAR(20) CHARACTER SET NONE,
RES INTEGER)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE PC_NILT_NILS (RECORD_ID INTEGER,
WH_ID CHAR(2) CHARACTER SET NONE,
LOCN_ID VARCHAR(10) CHARACTER SET NONE,
OBJECT VARCHAR(30) CHARACTER SET NONE,
TRN_TYPE VARCHAR(4) CHARACTER SET NONE,
TRN_CODE CHAR(1) CHARACTER SET NONE,
TRN_DATE TIMESTAMP,
REFERENCE VARCHAR(40) CHARACTER SET NONE,
QTY INTEGER,
PERSON_ID VARCHAR(10) CHARACTER SET NONE,
DEVICE_ID CHAR(2) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE PC_NIXX (RECORD_ID INTEGER,
WH_ID CHAR(2) CHARACTER SET NONE,
LOCN_ID VARCHAR(10) CHARACTER SET NONE,
OBJECT VARCHAR(30) CHARACTER SET NONE,
TRN_TYPE VARCHAR(4) CHARACTER SET NONE,
TRN_CODE CHAR(1) CHARACTER SET NONE,
TRN_DATE TIMESTAMP,
REFERENCE VARCHAR(40) CHARACTER SET NONE,
QTY INTEGER,
PERSON_ID VARCHAR(10) CHARACTER SET NONE,
DEVICE_ID CHAR(2) CHARACTER SET NONE,
INSTANCE_ID VARCHAR(10) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE PC_NIXX_P (RECORD_ID INTEGER,
WH_ID CHAR(2) CHARACTER SET NONE,
LOCN_ID VARCHAR(10) CHARACTER SET NONE,
OBJECT VARCHAR(30) CHARACTER SET NONE,
TRN_TYPE VARCHAR(4) CHARACTER SET NONE,
TRN_CODE CHAR(1) CHARACTER SET NONE,
TRN_DATE TIMESTAMP,
REFERENCE VARCHAR(40) CHARACTER SET NONE,
QTY INTEGER,
PERSON_ID VARCHAR(10) CHARACTER SET NONE,
DEVICE_ID CHAR(2) CHARACTER SET NONE,
INSTANCE_ID VARCHAR(10) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE PC_QANS (RECORD_ID INTEGER,
WH_ID CHAR(2) CHARACTER SET NONE,
LOCN_ID VARCHAR(10) CHARACTER SET NONE,
OBJECT VARCHAR(30) CHARACTER SET NONE,
TRN_TYPE VARCHAR(4) CHARACTER SET NONE,
TRN_CODE CHAR(1) CHARACTER SET NONE,
TRN_DATE TIMESTAMP,
REFERENCE VARCHAR(40) CHARACTER SET NONE,
QTY INTEGER,
PERSON_ID VARCHAR(10) CHARACTER SET NONE,
DEVICE_ID CHAR(2) CHARACTER SET NONE,
SUB_LOCN VARCHAR(10) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE PC_QANX (RECORD_ID INTEGER,
WH_ID CHAR(2) CHARACTER SET NONE,
LOCN_ID VARCHAR(10) CHARACTER SET NONE,
OBJECT VARCHAR(30) CHARACTER SET NONE,
TRN_TYPE VARCHAR(4) CHARACTER SET NONE,
TRN_CODE CHAR(1) CHARACTER SET NONE,
TRN_DATE TIMESTAMP,
REFERENCE VARCHAR(40) CHARACTER SET NONE,
QTY INTEGER,
PERSON_ID VARCHAR(10) CHARACTER SET NONE,
DEVICE_ID CHAR(2) CHARACTER SET NONE,
SUB_LOCN VARCHAR(10) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE PC_QTY_TROL_TRIL_P (RECORD_ID INTEGER,
WH_ID CHAR(2) CHARACTER SET NONE,
LOCN_ID VARCHAR(10) CHARACTER SET NONE,
PREV_LOCN_ID VARCHAR(10) CHARACTER SET NONE,
PROD_ID VARCHAR(30) CHARACTER SET NONE,
TRN_TYPE VARCHAR(4) CHARACTER SET NONE,
REFERENCE VARCHAR(40) CHARACTER SET NONE,
QTY INTEGER,
PERSON_ID VARCHAR(10) CHARACTER SET NONE,
DEVICE_ID CHAR(2) CHARACTER SET NONE,
TRN_CODE CHAR(1) CHARACTER SET NONE,
TRN_DATE TIMESTAMP,
HIST_DESC VARCHAR(70) CHARACTER SET NONE)
RETURNS (PROCESS_OK CHAR(1) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE PC_STAV (RECORD_ID INTEGER,
WH_ID CHAR(2) CHARACTER SET NONE,
LOCN_ID VARCHAR(10) CHARACTER SET NONE,
OBJECT VARCHAR(30) CHARACTER SET NONE,
TRN_TYPE VARCHAR(4) CHARACTER SET NONE,
TRN_CODE CHAR(1) CHARACTER SET NONE,
TRN_DATE TIMESTAMP,
REFERENCE VARCHAR(40) CHARACTER SET NONE,
QTY INTEGER,
SUB_LOCN_ID VARCHAR(10) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE PC_STIS (RECORD_ID INTEGER,
WH_ID CHAR(2) CHARACTER SET NONE,
LOCN_ID VARCHAR(10) CHARACTER SET NONE,
OBJECT VARCHAR(30) CHARACTER SET NONE,
TRN_TYPE VARCHAR(4) CHARACTER SET NONE,
TRN_CODE CHAR(1) CHARACTER SET NONE,
TRN_DATE TIMESTAMP,
REFERENCE VARCHAR(40) CHARACTER SET NONE,
ISSN_QTY INTEGER)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE PC_STLO (RECORD_ID INTEGER,
WH_ID CHAR(2) CHARACTER SET NONE,
LOCN_ID VARCHAR(10) CHARACTER SET NONE,
DEVICE VARCHAR(10) CHARACTER SET NONE,
TRN_DATE TIMESTAMP)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE PC_STLX (RECORD_ID INTEGER,
WH_ID CHAR(2) CHARACTER SET NONE,
LOCN_ID VARCHAR(10) CHARACTER SET NONE,
DEVICE VARCHAR(10) CHARACTER SET NONE,
TRN_DATE TIMESTAMP)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE PC_STOB (RECORD_ID INTEGER,
WH_ID CHAR(2) CHARACTER SET NONE,
LOCN_ID VARCHAR(10) CHARACTER SET NONE,
OBJECT VARCHAR(30) CHARACTER SET NONE,
TRN_TYPE VARCHAR(4) CHARACTER SET NONE,
TRN_CODE CHAR(1) CHARACTER SET NONE,
TRN_DATE TIMESTAMP,
REFERENCE VARCHAR(40) CHARACTER SET NONE,
QTY INTEGER,
PERSON_ID VARCHAR(10) CHARACTER SET NONE,
DEVICE_ID CHAR(2) CHARACTER SET NONE,
INSTANCE_ID VARCHAR(10) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE PC_STRC (RECORD_ID INTEGER,
WH_ID CHAR(2) CHARACTER SET NONE,
LOCN_ID VARCHAR(10) CHARACTER SET NONE,
OBJECT VARCHAR(30) CHARACTER SET NONE,
TRN_TYPE VARCHAR(4) CHARACTER SET NONE,
TRN_CODE CHAR(1) CHARACTER SET NONE,
TRN_DATE TIMESTAMP,
REFERENCE VARCHAR(40) CHARACTER SET NONE,
QTY INTEGER,
PERSON_ID VARCHAR(10) CHARACTER SET NONE,
DEVICE_ID CHAR(2) CHARACTER SET NONE,
INSTANCE_ID VARCHAR(10) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE PC_STUA (RECORD_ID INTEGER,
WH_ID CHAR(2) CHARACTER SET NONE,
LOCN_ID VARCHAR(10) CHARACTER SET NONE,
OBJECT VARCHAR(30) CHARACTER SET NONE,
TRN_TYPE VARCHAR(4) CHARACTER SET NONE,
TRN_CODE CHAR(1) CHARACTER SET NONE,
TRN_DATE TIMESTAMP,
REFERENCE VARCHAR(40) CHARACTER SET NONE,
QTY INTEGER,
SUB_LOCN_ID VARCHAR(10) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE PC_TRIS (RECORD_ID INTEGER,
WH_ID CHAR(2) CHARACTER SET NONE,
LOCN_ID VARCHAR(10) CHARACTER SET NONE,
OBJECT VARCHAR(30) CHARACTER SET NONE,
TRN_TYPE VARCHAR(4) CHARACTER SET NONE,
TRN_CODE CHAR(1) CHARACTER SET NONE,
TRN_DATE TIMESTAMP,
REFERENCE VARCHAR(40) CHARACTER SET NONE,
QTY INTEGER,
SUB_LOCN_ID VARCHAR(10) CHARACTER SET NONE,
PERSON_ID VARCHAR(10) CHARACTER SET NONE,
DEVICE_ID CHAR(2) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE PC_TRLO_TRLI (RECORD_ID INTEGER,
WH_ID CHAR(2) CHARACTER SET NONE,
LOCN_ID VARCHAR(10) CHARACTER SET NONE,
OBJECT VARCHAR(30) CHARACTER SET NONE,
TRN_TYPE VARCHAR(4) CHARACTER SET NONE,
TRN_CODE CHAR(1) CHARACTER SET NONE,
TRN_DATE TIMESTAMP,
REFERENCE VARCHAR(40) CHARACTER SET NONE,
QTY INTEGER,
PERSON_ID VARCHAR(10) CHARACTER SET NONE,
DEVICE_ID CHAR(2) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE PC_TRMI (RECORD_ID INTEGER,
WH_ID CHAR(2) CHARACTER SET NONE,
LOCN_ID VARCHAR(10) CHARACTER SET NONE,
SUBLOCN_ID VARCHAR(10) CHARACTER SET NONE,
OBJECT VARCHAR(30) CHARACTER SET NONE,
TRN_TYPE VARCHAR(4) CHARACTER SET NONE,
TRN_CODE CHAR(1) CHARACTER SET NONE,
TRN_DATE TIMESTAMP,
REFERENCE VARCHAR(40) CHARACTER SET NONE,
QTY INTEGER,
PERSON_ID VARCHAR(8) CHARACTER SET NONE,
DEVICE_ID CHAR(2) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE PC_TROL_TRIL (RECORD_ID INTEGER,
WH_ID CHAR(2) CHARACTER SET NONE,
LOCN_ID VARCHAR(10) CHARACTER SET NONE,
OBJECT VARCHAR(30) CHARACTER SET NONE,
TRN_TYPE VARCHAR(4) CHARACTER SET NONE,
TRN_CODE CHAR(1) CHARACTER SET NONE,
TRN_DATE TIMESTAMP,
REFERENCE VARCHAR(40) CHARACTER SET NONE,
QTY INTEGER,
PERSON_ID VARCHAR(10) CHARACTER SET NONE,
DEVICE_ID CHAR(2) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE PC_TRSS (RECORD_ID INTEGER,
WH_ID CHAR(2) CHARACTER SET NONE,
LOCN_ID VARCHAR(10) CHARACTER SET NONE,
OBJECT VARCHAR(30) CHARACTER SET NONE,
TRN_TYPE VARCHAR(4) CHARACTER SET NONE,
TRN_CODE CHAR(1) CHARACTER SET NONE,
TRN_DATE TIMESTAMP,
REFERENCE VARCHAR(40) CHARACTER SET NONE,
QTY INTEGER,
PERSON_ID VARCHAR(10) CHARACTER SET NONE,
DEVICE_ID CHAR(2) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE PC_UGXX (RECORD_ID INTEGER,
WH_ID CHAR(2) CHARACTER SET NONE,
LOCN_ID VARCHAR(10) CHARACTER SET NONE,
OBJECT VARCHAR(30) CHARACTER SET NONE,
TRN_TYPE VARCHAR(4) CHARACTER SET NONE,
TRN_CODE CHAR(1) CHARACTER SET NONE,
TRN_DATE TIMESTAMP,
REFERENCE VARCHAR(40) CHARACTER SET NONE,
QTY INTEGER,
PERSON_ID VARCHAR(10) CHARACTER SET NONE,
DEVICE_ID CHAR(2) CHARACTER SET NONE,
INSTANCE_ID VARCHAR(10) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE PC_UIXX (RECORD_ID INTEGER,
WH_ID CHAR(2) CHARACTER SET NONE,
LOCN_ID VARCHAR(10) CHARACTER SET NONE,
OBJECT VARCHAR(30) CHARACTER SET NONE,
TRN_TYPE VARCHAR(4) CHARACTER SET NONE,
TRN_CODE CHAR(1) CHARACTER SET NONE,
TRN_DATE TIMESTAMP,
REFERENCE VARCHAR(40) CHARACTER SET NONE,
QTY INTEGER,
PERSON_ID VARCHAR(10) CHARACTER SET NONE,
DEVICE_ID CHAR(2) CHARACTER SET NONE,
INSTANCE_ID VARCHAR(10) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE PC_WMAR (RECORD_ID INTEGER,
WH_ID CHAR(2) CHARACTER SET NONE,
LOCN_ID VARCHAR(10) CHARACTER SET NONE,
OBJECT VARCHAR(30) CHARACTER SET NONE,
TRN_TYPE VARCHAR(4) CHARACTER SET NONE,
TRN_CODE CHAR(1) CHARACTER SET NONE,
TRN_DATE TIMESTAMP,
REFERENCE VARCHAR(40) CHARACTER SET NONE,
QTY INTEGER,
PERSON_ID VARCHAR(10) CHARACTER SET NONE,
DEVICE_ID CHAR(2) CHARACTER SET NONE,
SUBLOCN_ID VARCHAR(10) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE PICK_ITEM_PROD_SEQ (WK_WH_ID CHAR(2) CHARACTER SET NONE,
WK_COMPANY VARCHAR(20) CHARACTER SET NONE,
WK_PROD_ID VARCHAR(30) CHARACTER SET NONE,
WK_SSN_ID VARCHAR(20) CHARACTER SET NONE)
RETURNS (WK_SEQ VARCHAR(30) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE PICK_MODE_P1 (WK_ORDER_TYPES VARCHAR(255) CHARACTER SET NONE,
WK_ORDER_MODES VARCHAR(255) CHARACTER SET NONE,
WK_ORDERS VARCHAR(255) CHARACTER SET NONE,
WK_ORDER_STATUSES VARCHAR(255) CHARACTER SET NONE,
WK_ORDER_PRIORITYS VARCHAR(255) CHARACTER SET NONE,
WK_PARAM_IDS VARCHAR(255) CHARACTER SET NONE)
RETURNS (WK_ORDER VARCHAR(15) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE PICK_MODE_P2 (WK_ORDER_TYPES VARCHAR(255) CHARACTER SET NONE,
WK_ORDER_MODES VARCHAR(255) CHARACTER SET NONE,
WK_ORDERS VARCHAR(255) CHARACTER SET NONE,
WK_ORDER_STATUSES VARCHAR(255) CHARACTER SET NONE,
WK_ORDER_PRIORITYS VARCHAR(255) CHARACTER SET NONE,
WK_PARAM_IDS VARCHAR(255) CHARACTER SET NONE)
RETURNS (WK_ORDER VARCHAR(15) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE PICK_MODE_P3 (WK_ORDER_TYPES VARCHAR(255) CHARACTER SET NONE,
WK_ORDER_MODES VARCHAR(255) CHARACTER SET NONE,
WK_ORDERS VARCHAR(255) CHARACTER SET NONE,
WK_ORDER_STATUSES VARCHAR(255) CHARACTER SET NONE,
WK_ORDER_PRIORITYS VARCHAR(255) CHARACTER SET NONE,
WK_PARAM_IDS VARCHAR(255) CHARACTER SET NONE)
RETURNS (WK_ORDER VARCHAR(15) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE PICK_MODE_P4 (WK_ORDER_TYPES VARCHAR(255) CHARACTER SET NONE,
WK_ORDER_MODES VARCHAR(255) CHARACTER SET NONE,
WK_ORDERS VARCHAR(255) CHARACTER SET NONE,
WK_ORDER_STATUSES VARCHAR(255) CHARACTER SET NONE,
WK_ORDER_PRIORITYS VARCHAR(255) CHARACTER SET NONE,
WK_PARAM_IDS VARCHAR(255) CHARACTER SET NONE)
RETURNS (WK_ORDER VARCHAR(15) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE PICK_MODE_P5 (WK_ORDER_TYPES VARCHAR(255) CHARACTER SET NONE,
WK_ORDER_MODES VARCHAR(255) CHARACTER SET NONE,
WK_ORDERS VARCHAR(255) CHARACTER SET NONE,
WK_ORDER_STATUSES VARCHAR(255) CHARACTER SET NONE,
WK_ORDER_PRIORITYS VARCHAR(255) CHARACTER SET NONE,
WK_PARAM_IDS VARCHAR(255) CHARACTER SET NONE)
RETURNS (WK_ORDER VARCHAR(15) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE PICK_MODE_P8 (WK_ORDER_TYPES VARCHAR(255) CHARACTER SET NONE,
WK_ORDER_MODES VARCHAR(255) CHARACTER SET NONE,
WK_ORDERS VARCHAR(255) CHARACTER SET NONE,
WK_ORDER_STATUSES VARCHAR(255) CHARACTER SET NONE,
WK_ORDER_PRIORITYS VARCHAR(255) CHARACTER SET NONE,
WK_PARAM_IDS VARCHAR(255) CHARACTER SET NONE)
RETURNS (WK_ORDER VARCHAR(15) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE PICK_MODE_P9 (WK_ORDER_TYPES VARCHAR(255) CHARACTER SET NONE,
WK_ORDER_MODES VARCHAR(255) CHARACTER SET NONE,
WK_ORDERS VARCHAR(255) CHARACTER SET NONE,
WK_ORDER_STATUSES VARCHAR(255) CHARACTER SET NONE,
WK_ORDER_PRIORITYS VARCHAR(255) CHARACTER SET NONE,
WK_PARAM_IDS VARCHAR(255) CHARACTER SET NONE)
RETURNS (WK_ORDER VARCHAR(15) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE PICK_PERSON_TEMP AS 
BEGIN EXIT; END ^
CREATE PROCEDURE PINPOINT_PICKS_ONDEVICE (IN_STATUS VARCHAR(2) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE PRN_REQUEST_ARCHIVE AS 
BEGIN EXIT; END ^
CREATE PROCEDURE PRN_REQUEST_CP_STOP AS 
BEGIN EXIT; END ^
CREATE PROCEDURE PRN_REQUEST_NP_STOP AS 
BEGIN EXIT; END ^
CREATE PROCEDURE PROCESS_TEST_RESULTS (CATEGORY VARCHAR(1) CHARACTER SET NONE,
SSNID VARCHAR(20) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE PRODUCT_COMPANY_GRN_STOCK (PROD_ID VARCHAR(30) CHARACTER SET NONE,
COMPANY_IDS VARCHAR(1100) CHARACTER SET NONE,
USER_ID VARCHAR(10) CHARACTER SET NONE)
RETURNS (WH_ID CHAR(2) CHARACTER SET NONE,
COMPANY_ID VARCHAR(20) CHARACTER SET NONE,
SUPPLIER_ID VARCHAR(10) CHARACTER SET NONE,
SSN_TYPE VARCHAR(40) CHARACTER SET NONE,
GENERIC VARCHAR(40) CHARACTER SET NONE,
BRAND VARCHAR(40) CHARACTER SET NONE,
RECEIVE_DATE TIMESTAMP,
AVAILABLE_QTY INTEGER)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE PRODUCT_COMPANY_STOCK (PROD_ID VARCHAR(30) CHARACTER SET NONE,
COMPANY_ID VARCHAR(20) CHARACTER SET NONE)
RETURNS (AVAILABLE_QTY INTEGER,
RESERVED_QTY INTEGER,
ONSITE_QTY INTEGER,
UNPICKED_ORDER_QTY INTEGER,
BACK_ORDER_QTY INTEGER,
CANCELLED_ORDER_QTY INTEGER,
TEST_QTY INTEGER)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE PRODUCT_COMPANY_WH_GRN_STOCK (PROD_ID VARCHAR(30) CHARACTER SET NONE,
COMPANY_IDS VARCHAR(1100) CHARACTER SET NONE,
WH_IDS VARCHAR(300) CHARACTER SET NONE,
USER_ID VARCHAR(10) CHARACTER SET NONE)
RETURNS (WH_ID CHAR(2) CHARACTER SET NONE,
COMPANY_ID VARCHAR(20) CHARACTER SET NONE,
SUPPLIER_ID VARCHAR(10) CHARACTER SET NONE,
SSN_TYPE VARCHAR(40) CHARACTER SET NONE,
GENERIC VARCHAR(40) CHARACTER SET NONE,
BRAND VARCHAR(40) CHARACTER SET NONE,
RECEIVE_DATE TIMESTAMP,
AVAILABLE_QTY INTEGER,
SSN_ID VARCHAR(20) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE PRODUCT_COMPANY_WH_STOCK_STATUS (IN_PROD_ID VARCHAR(50) CHARACTER SET NONE,
COMPANY_ID VARCHAR(1100) CHARACTER SET NONE,
WH_ID VARCHAR(300) CHARACTER SET NONE,
USER_ID VARCHAR(10) CHARACTER SET NONE)
RETURNS (AVAILABLE_QTY INTEGER,
RESERVED_QTY INTEGER,
ONSITE_QTY INTEGER,
UNPICKED_ORDER_QTY INTEGER,
BACK_ORDER_QTY INTEGER,
CANCELLED_ORDER_QTY INTEGER,
PO_ON_ORDER_QTY INTEGER,
TEST_QTY INTEGER,
AVAILABLE1_QTY INTEGER,
AVAILABLE1_SSN VARCHAR(20) CHARACTER SET NONE,
AVAILABLE2_QTY INTEGER,
AVAILABLE2_SSN VARCHAR(20) CHARACTER SET NONE,
AVAILABLE3_QTY INTEGER,
AVAILABLE3_SSN VARCHAR(20) CHARACTER SET NONE,
PO_ON_ORDER1_NO VARCHAR(10) CHARACTER SET NONE,
PO_ON_ORDER1_QTY INTEGER,
PO_ON_ORDER1_DUE_DATE TIMESTAMP,
PROD_ID VARCHAR(30) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE PRODUCT_MOVEMENT_AGE RETURNS (PROD_ID VARCHAR(30) CHARACTER SET NONE,
SHORT_DESC VARCHAR(50) CHARACTER SET NONE,
SSN_ID VARCHAR(20) CHARACTER SET NONE,
LAST_MOVEMENT_DATE TIMESTAMP,
CURRENT_QTY INTEGER)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE PRODUCT_QTYS RETURNS (PROD_ID VARCHAR(30) CHARACTER SET NONE,
ALTERNATE_ID VARCHAR(30) CHARACTER SET NONE,
PICKFACE_QTY INTEGER,
LOCN_ID VARCHAR(10) CHARACTER SET NONE,
AVAILABLE_QTY INTEGER,
VARIANCE_QTY_1 INTEGER,
COMPANY_ID_1 VARCHAR(20) CHARACTER SET NONE,
VARIANCE_QTY_2 INTEGER,
COMPANY_ID_2 VARCHAR(20) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE PRODUCT_STOCK_STATUS (PROD_ID VARCHAR(30) CHARACTER SET NONE)
RETURNS (AVAILABLE_QTY INTEGER,
RESERVED_QTY INTEGER,
ONSITE_QTY INTEGER,
UNPICKED_ORDER_QTY INTEGER,
BACK_ORDER_QTY INTEGER,
CANCELLED_ORDER_QTY INTEGER,
TEST_QTY INTEGER)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE REPLENISH_LOCN RETURNS (PROD_ID VARCHAR(30) CHARACTER SET NONE,
TO_WH_ID CHAR(2) CHARACTER SET NONE,
TO_LOCN_ID VARCHAR(10) CHARACTER SET NONE,
TRN_PRIORITY SMALLINT,
REQUIRED_QTY INTEGER,
CURRENT_QTY INTEGER,
WH_QTY INTEGER,
UNPICKED_ORDER_QTY INTEGER)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE RERUN_TRANSACTION_ISIZ AS 
BEGIN EXIT; END ^
CREATE PROCEDURE RPT_ARCHIVE_DATA (THISWHID VARCHAR(2) CHARACTER SET NONE)
RETURNS (WH_ID VARCHAR(2) CHARACTER SET NONE,
LOCN_ID VARCHAR(10) CHARACTER SET NONE,
PROD_ID VARCHAR(30) CHARACTER SET NONE,
CURRENT_QTY VARCHAR(10) CHARACTER SET NONE,
SHORT_DESC VARCHAR(50) CHARACTER SET NONE,
MOVE_STAT VARCHAR(2) CHARACTER SET NONE,
NAME VARCHAR(50) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE RPT_BUSINESS_MONTHLY_1_DATA (THISCOMPANY VARCHAR(20) CHARACTER SET NONE,
THISSTART TIMESTAMP,
THISEND TIMESTAMP)
RETURNS (PROD_ID VARCHAR(30) CHARACTER SET NONE,
SHORT_DESC VARCHAR(50) CHARACTER SET NONE,
THISCOMPANY_ID VARCHAR(20) CHARACTER SET NONE,
CURRENT_QTY INTEGER)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE RPT_BUSINESS_MONTHLY_2_DATA (THISCOMPANY VARCHAR(20) CHARACTER SET NONE,
THISSTART TIMESTAMP,
THISEND TIMESTAMP)
RETURNS (WH_ID1 VARCHAR(30) CHARACTER SET NONE,
LOCN_ID1 VARCHAR(30) CHARACTER SET NONE,
LOC_QTY_1 INTEGER,
WH_ID2 VARCHAR(30) CHARACTER SET NONE,
LOCN_ID2 VARCHAR(30) CHARACTER SET NONE,
LOC_QTY_2 INTEGER,
PROD_ID VARCHAR(30) CHARACTER SET NONE,
DESCRIPTION VARCHAR(50) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE RPT_BUSINESS_MONTHLY_3_DATA (THISCOMPANY VARCHAR(20) CHARACTER SET NONE,
THISSTART TIMESTAMP,
THISEND TIMESTAMP)
RETURNS (PROD_ID VARCHAR(30) CHARACTER SET NONE,
SHORT_DESC VARCHAR(50) CHARACTER SET NONE,
QTY INTEGER,
COMPANY_ID VARCHAR(30) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE RPT_CANCELLED_DATA (THISPICK_ORDER VARCHAR(50) CHARACTER SET NONE)
RETURNS (PICK_ORDER VARCHAR(50) CHARACTER SET NONE,
SHORT_DESC VARCHAR(50) CHARACTER SET NONE,
PROD_ID VARCHAR(50) CHARACTER SET NONE,
PICK_LABEL_NO VARCHAR(50) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE RPT_CANCEL_ORDER_DATA (THISPICK_LABEL_NO VARCHAR(50) CHARACTER SET NONE)
RETURNS (FROM_LOCN_ID VARCHAR(50) CHARACTER SET NONE,
QTYSUM INTEGER,
FROM_WH_ID VARCHAR(50) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE RPT_DAILY_1_A_DATA (THISSTART TIMESTAMP,
THISEND TIMESTAMP)
RETURNS (THISCOUNT INTEGER)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE RPT_DAILY_1_B_DATA (THISSTART TIMESTAMP,
THISEND TIMESTAMP)
RETURNS (THISCOUNT INTEGER)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE RPT_DAILY_2_A_DATA (THISSTART TIMESTAMP,
THISEND TIMESTAMP)
RETURNS (QTYTOTAL INTEGER,
PROD_ID VARCHAR(50) CHARACTER SET NONE,
SHORT_DESC VARCHAR(50) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE RPT_DAILY_2_B_DATA (THISSTART TIMESTAMP,
THISEND TIMESTAMP)
RETURNS (QTYTOTAL INTEGER,
PROD_ID VARCHAR(50) CHARACTER SET NONE,
SHORT_DESC VARCHAR(50) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE RPT_DAILY_3_DATA (THISSTART TIMESTAMP,
THISEND TIMESTAMP)
RETURNS (THISCOUNT INTEGER)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE RPT_DAILY_4_A_DATA (THISSTART TIMESTAMP,
THISEND TIMESTAMP)
RETURNS (QTYTOTAL INTEGER,
PROD_ID VARCHAR(50) CHARACTER SET NONE,
SHORT_DESC VARCHAR(50) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE RPT_DAILY_4_B_DATA (THISSTART TIMESTAMP,
THISEND TIMESTAMP)
RETURNS (QTYTOTAL INTEGER,
PROD_ID VARCHAR(50) CHARACTER SET NONE,
SHORT_DESC VARCHAR(50) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE RPT_DAILY_4_DATA (THISSTART TIMESTAMP,
THISEND TIMESTAMP)
RETURNS (THISCOUNT INTEGER)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE RPT_DAILY_5_DATA (THISSTART TIMESTAMP,
THISEND TIMESTAMP)
RETURNS (THISCOUNT INTEGER)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE RPT_DAILY_6_DATA (THISSTART TIMESTAMP,
THISEND TIMESTAMP)
RETURNS (THISCOUNT INTEGER)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE RPT_PRODUCT_LEVELS_DATA (THISWHID VARCHAR(4) CHARACTER SET NONE)
RETURNS (LOCN_ID VARCHAR(50) CHARACTER SET NONE,
PROD_ID VARCHAR(50) CHARACTER SET NONE,
CURRENT_QTY INTEGER,
SHORT_DES VARCHAR(50) CHARACTER SET NONE,
THISSTATUS VARCHAR(40) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE RPT_PRODUCT_RECEIPT_DATA (THISPROD_ID VARCHAR(30) CHARACTER SET NONE,
THISMODE INTEGER,
THISSTART TIMESTAMP,
THISEND TIMESTAMP)
RETURNS (PROD VARCHAR(30) CHARACTER SET NONE,
QTY INTEGER,
TRN_DATE TIMESTAMP,
THISGRN VARCHAR(30) CHARACTER SET NONE,
LOCN_ID VARCHAR(30) CHARACTER SET NONE,
SHORT_DESC VARCHAR(50) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE RPT_PRODUCT_RECEIPT_GRN_DATA (THISPROD_LIST VARCHAR(1240) CHARACTER SET NONE,
THISSTART TIMESTAMP,
THISEND TIMESTAMP)
RETURNS (PROD VARCHAR(30) CHARACTER SET NONE,
QTY INTEGER,
TRN_DATE TIMESTAMP,
THISGRN VARCHAR(30) CHARACTER SET NONE,
LOCN_ID VARCHAR(30) CHARACTER SET NONE,
SHORT_DESC VARCHAR(50) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE RPT_PRODUCT_RECEIPT_PROD_DATA (THISPROD_LIST VARCHAR(1240) CHARACTER SET NONE,
THISSTART TIMESTAMP,
THISEND TIMESTAMP)
RETURNS (PROD VARCHAR(30) CHARACTER SET NONE,
QTY INTEGER,
TRN_DATE TIMESTAMP,
THISGRN VARCHAR(30) CHARACTER SET NONE,
LOCN_ID VARCHAR(30) CHARACTER SET NONE,
SHORT_DESC VARCHAR(50) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE RPT_SAFETY_CALIBRATION_EXPIRY (WK_DAYS INTEGER)
RETURNS (SN_SSN_TYPE VARCHAR(40) CHARACTER SET NONE,
SN_SSN_ID VARCHAR(20) CHARACTER SET NONE,
SN_WH_ID CHAR(2) CHARACTER SET NONE,
SN_LOCN_ID VARCHAR(10) CHARACTER SET NONE,
SN_SSN_DESCRIPTION VARCHAR(80) CHARACTER SET NONE,
SN_LAST_CALIBRATE_CHECK_DATE TIMESTAMP,
SN_CALIBRATE_PERIOD CHAR(1) CHARACTER SET NONE,
SN_CALIBRATE_PERIOD_NO INTEGER,
WK_CALIBRATE_DAYS_SINCE_CHECK INTEGER,
WK_CALIBRATE_EXPIRY_DATE TIMESTAMP,
SN_CALIBRATE_CHECK CHAR(1) CHARACTER SET NONE,
WK_CALIBRATE_DAYS_TO_CHECK INTEGER,
WK_CALIBRATE_PERIOD_DAY INTEGER,
WK_CALIBRATE_PERIOD_DAYS INTEGER,
SN_LAST_SAFETY_CHECK_DATE TIMESTAMP,
SN_SAFETY_PERIOD CHAR(1) CHARACTER SET NONE,
SN_SAFETY_PERIOD_NO INTEGER,
WK_SAFETY_DAYS_SINCE_CHECK INTEGER,
WK_SAFETY_EXPIRY_DATE TIMESTAMP,
SN_SAFETY_CHECK CHAR(1) CHARACTER SET NONE,
WK_SAFETY_DAYS_TO_CHECK INTEGER,
WK_SAFETY_PERIOD_DAY INTEGER,
WK_SAFETY_PERIOD_DAYS INTEGER,
WK_TEST_DATE TIMESTAMP,
WK_DAYS_USED INTEGER)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE SEND_PICKABLE_STOCK (PROD_ID VARCHAR(30) CHARACTER SET NONE,
USER_ID VARCHAR(10) CHARACTER SET NONE,
DEVICE_ID CHAR(2) CHARACTER SET NONE,
TRN_DATE TIMESTAMP)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE SEND_USER_EVENT (EVENT_NAME VARCHAR(127) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE SO_PICK_LOCATIONS (PICK_ORDER VARCHAR(15) CHARACTER SET NONE)
RETURNS (WH_ID CHAR(2) CHARACTER SET NONE,
LOCN_ID VARCHAR(10) CHARACTER SET NONE,
WH_ID2 CHAR(2) CHARACTER SET NONE,
LOCN_ID2 VARCHAR(10) CHARACTER SET NONE,
DESCRIPTION VARCHAR(80) CHARACTER SET NONE,
PICK_ORDER2 VARCHAR(15) CHARACTER SET NONE,
PICK_LABEL_NO VARCHAR(7) CHARACTER SET NONE,
SSN_ID VARCHAR(20) CHARACTER SET NONE,
PROD_ID VARCHAR(30) CHARACTER SET NONE,
PICK_ORDER_QTY INTEGER,
PICK_ALLOCATED_QTY INTEGER,
PICKED_QTY INTEGER,
PICK_LINE_DUE_DATE TIMESTAMP,
PICK_ORDER_LINE_NO CHAR(4) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE SO_PICK_LOCATIONS_ORDERSLIST (ORDER_LIST VARCHAR(32760) CHARACTER SET NONE)
RETURNS (WH_ID CHAR(2) CHARACTER SET NONE,
LOCN_ID VARCHAR(10) CHARACTER SET NONE,
WH_ID2 CHAR(2) CHARACTER SET NONE,
LOCN_ID2 VARCHAR(10) CHARACTER SET NONE,
DESCRIPTION VARCHAR(80) CHARACTER SET NONE,
SSN_ID VARCHAR(20) CHARACTER SET NONE,
PROD_ID VARCHAR(30) CHARACTER SET NONE,
PICK_ORDER_QTY INTEGER,
PICK_ALLOCATED_QTY INTEGER,
PICKED_QTY INTEGER)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE TRAN4_ARCHIVE AS 
BEGIN EXIT; END ^
CREATE PROCEDURE TRAN_ARCHIVE AS 
BEGIN EXIT; END ^
CREATE PROCEDURE UPDATE_GRN (OBJECT VARCHAR(30) CHARACTER SET NONE,
TRN_TYPE VARCHAR(4) CHARACTER SET NONE,
QTY INTEGER,
REFERENCE VARCHAR(40) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE UPDATE_ISSN (OBJECT VARCHAR(30) CHARACTER SET NONE,
TRN_TYPE VARCHAR(4) CHARACTER SET NONE,
TRN_CODE CHAR(1) CHARACTER SET NONE,
FIELD_VALUE VARCHAR(40) CHARACTER SET NONE,
TRN_DATE TIMESTAMP,
PERSON_ID VARCHAR(10) CHARACTER SET NONE,
QTY INTEGER)
RETURNS (ISSN_RESPONSE_TEXT VARCHAR(255) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE UPDATE_LEGACY_PRODUCT AS 
BEGIN EXIT; END ^
CREATE PROCEDURE UPDATE_SALE_ORDER_STATUS (PICK_ORDER VARCHAR(10) CHARACTER SET NONE,
STATUS_SSN CHAR(2) CHARACTER SET NONE,
PICK_STATUS CHAR(2) CHARACTER SET NONE,
APPROVED_BY VARCHAR(10) CHARACTER SET NONE)
RETURNS (VALID_SO CHAR(1) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE UPDATE_SSN (OBJECT VARCHAR(30) CHARACTER SET NONE,
TRN_TYPE VARCHAR(4) CHARACTER SET NONE,
FIELD_VALUE VARCHAR(40) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE UPDATE_SSN_DESC AS 
BEGIN EXIT; END ^
CREATE PROCEDURE UPDATE_SSN_ISSN_LOCN AS 
BEGIN EXIT; END ^
CREATE PROCEDURE UPDATE_SSN_LOAN_STATUS (SSN_ID VARCHAR(20) CHARACTER SET NONE,
LOAN_STATUS VARCHAR(2) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE UPDATE_SSN_PRODUCT_COND_STATUS (SSN_ID VARCHAR(20) CHARACTER SET NONE,
CODE VARCHAR(1) CHARACTER SET NONE,
ORIGINAL VARCHAR(1) CHARACTER SET NONE,
NOFAULT CHAR(1) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE UPDATE_SSN_QTY_TROL (OBJECT VARCHAR(30) CHARACTER SET NONE,
QTY INTEGER)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE UPDATE_SSN_STATUS (SSN_ID VARCHAR(20) CHARACTER SET NONE,
STATUS_SSN VARCHAR(2) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE UPDATE_SSN_TRIL_A (OBJECT VARCHAR(30) CHARACTER SET NONE,
WH_ID CHAR(2) CHARACTER SET NONE,
LOCN_ID VARCHAR(10) CHARACTER SET NONE,
TRN_DATE TIMESTAMP,
QTY INTEGER,
TRN_CODE CHAR(1) CHARACTER SET NONE,
SUB_LOCN_ID VARCHAR(10) CHARACTER SET NONE,
DEVICE_ID CHAR(2) CHARACTER SET NONE,
PERSON_ID VARCHAR(10) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE UPDATE_SSN_TROL_A (OBJECT VARCHAR(30) CHARACTER SET NONE,
WH_ID CHAR(2) CHARACTER SET NONE,
LOCN_ID VARCHAR(10) CHARACTER SET NONE,
TRN_DATE TIMESTAMP,
DEVICE_ID CHAR(2) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE UPDATE_SSN_TROL_A10 (OBJECT VARCHAR(30) CHARACTER SET NONE,
WH_ID CHAR(2) CHARACTER SET NONE,
LOCN_ID VARCHAR(10) CHARACTER SET NONE,
TRN_DATE TIMESTAMP,
DEVICE_ID VARCHAR(10) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE UPDATE_TRAN (RECORD_ID INTEGER,
COMPLETE CHAR(1) CHARACTER SET NONE,
ERROR_TEXT VARCHAR(255) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE UPDATE_TRAN4 (RECORD_ID INTEGER,
COMPLETE CHAR(1) CHARACTER SET NONE,
ERROR_TEXT VARCHAR(255) CHARACTER SET NONE)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE WEB_REQUEST4_ARCHIVE AS 
BEGIN EXIT; END ^
CREATE PROCEDURE WORKTEST AS 
BEGIN EXIT; END ^

ALTER PROCEDURE ADD_CHILD_KIT (WK_CHILD_PROD VARCHAR(30) CHARACTER SET NONE,
WK_CHILD_EXTENSION VARCHAR(6) CHARACTER SET NONE,
WK_STATUS VARCHAR(6) CHARACTER SET NONE,
WK_PROD_ID VARCHAR(30) CHARACTER SET NONE,
WK_CHILD_QTY INTEGER,
WK_PERSON VARCHAR(10) CHARACTER SET NONE,
WK_DATE TIMESTAMP)
AS 
DECLARE VARIABLE WK_CHILD_PROD_ID VARCHAR(30);
DECLARE VARIABLE WK_FOUND INTEGER;
DECLARE VARIABLE WK_RES INTEGER;
BEGIN
   WK_CHILD_PROD_ID = WK_CHILD_PROD || WK_CHILD_EXTENSION;
   /* does product exist */
   IF (LEN(WK_CHILD_PROD) > 0) THEN
   BEGIN
      
      WK_FOUND = 0;
      SELECT 1 FROM PROD_PROFILE
      WHERE PROD_ID = :WK_CHILD_PROD_ID
      INTO :WK_FOUND;
      IF (WK_FOUND = 0) THEN
      BEGIN
         /* no prod profile - so create a dummy */
         INSERT INTO PROD_PROFILE(PROD_ID, SHORT_DESC, PROD_RETRIEVE_STATUS )
         VALUES (:WK_CHILD_PROD_ID, :WK_CHILD_PROD_ID, :WK_STATUS);
      END
      ELSE
      BEGIN
         UPDATE PROD_PROFILE 
         SET PROD_RETRIEVE_STATUS = :WK_STATUS
         WHERE PROD_ID = :WK_CHILD_PROD_ID;
      END
      WK_FOUND = 0;
      SELECT 1 FROM PROD_EAN
      WHERE PROD_EAN = :WK_CHILD_PROD AND 
            PROD_EAN_EXTENSION = :WK_CHILD_EXTENSION
      INTO :WK_FOUND;
      IF (WK_FOUND = 0) THEN
      BEGIN
         /* no prod ean - so create one */
         INSERT INTO PROD_EAN(PROD_ID, PROD_EAN, PROD_EAN_EXTENSION)
         VALUES (:WK_CHILD_PROD_ID, :WK_CHILD_PROD, :WK_CHILD_EXTENSION);
      END
      /* check product kit */
      WK_FOUND = 0;
      SELECT 1 
      FROM PRODUCT_KIT
      WHERE KIT_ID = :WK_PROD_ID
      AND   PROD_ID = :WK_CHILD_PROD_ID
      INTO :WK_FOUND ;
      IF (WK_FOUND = 0) THEN
      BEGIN
         /* no kit - so create a dummy */
         INSERT INTO PRODUCT_KIT(KIT_ID, PROD_ID, CREATED_BY, CREATE_DATE, PROD_QTY , STATUS)
         VALUES (:WK_PROD_ID, :WK_CHILD_PROD_ID, :WK_PERSON, :WK_DATE, :WK_CHILD_QTY, 'OK');
      END
      ELSE
      BEGIN
         UPDATE PRODUCT_KIT SET STATUS = 'OK'
         WHERE KIT_ID = :WK_PROD_ID
         AND   PROD_ID = :WK_CHILD_PROD_ID;
      END
   END
END ^

ALTER PROCEDURE ADD_EMP_SKILL_DEFAULT (EMPLOYEE_ID VARCHAR(10) CHARACTER SET NONE)
AS 
            

DECLARE VARIABLE sCode VARCHAR(10);

BEGIN    
    
    /* Get the compulsory skills */
    FOR 
      SELECT CODE 
      FROM SKILL
      WHERE COMPULSORY_SKILL = 'T'
      INTO :sCode
    DO
    BEGIN  
      /* Insert compulsory skills into table Employee Skill */
      INSERT INTO EMPLOYEE_SKILL (EMPLOYEE_ID, SKILL_CODE, 
         TRAINING_PASS, COMPULSORY_SKILL, TRAINING_DATE)
      VALUES (:EMPLOYEE_ID, :sCode, 'T', 'T', "TODAY");
              
    END                     
END ^

ALTER PROCEDURE ADD_GRN (GRN VARCHAR(10) CHARACTER SET NONE,
GRN_TYPE CHAR(2) CHARACTER SET NONE,
TOTAL_QTY_PACKS INTEGER,
PACK_EAN_SSCC VARCHAR(18) CHARACTER SET NONE,
CARRIER VARCHAR(10) CHARACTER SET NONE,
VEHICLE_ID VARCHAR(8) CHARACTER SET NONE,
AWB_CONSIGNMENT_NO VARCHAR(20) CHARACTER SET NONE,
GRN_PALLET_QTY INTEGER,
DELIVERY_DOCKET VARCHAR(10) CHARACTER SET NONE,
PALLETS_YN CHAR(1) CHARACTER SET NONE,
CONTAINER_NO VARCHAR(20) CHARACTER SET NONE,
USER_ID VARCHAR(10) CHARACTER SET NONE,
DEVICE_ID CHAR(2) CHARACTER SET NONE,
GRN_DATE TIMESTAMP,
ORDER_NO VARCHAR(10) CHARACTER SET NONE,
ORDER_LINE_NO VARCHAR(4) CHARACTER SET NONE,
RETURN_ID VARCHAR(10) CHARACTER SET NONE,
COMMENTS VARCHAR(255) CHARACTER SET NONE,
SHIPPED_DATE TIMESTAMP)
RETURNS (GRN_ID VARCHAR(10) CHARACTER SET NONE)
AS 
DECLARE VARIABLE REC_ID VARCHAR(10);
DECLARE VARIABLE WK_GENERATE_SSN_METHOD VARCHAR(40);
DECLARE VARIABLE WK_PO_GRN VARCHAR(20);
DECLARE VARIABLE WK_PO_PFX VARCHAR(20);
DECLARE VARIABLE WK_PO_PFX_LEN INTEGER;
DECLARE VARIABLE WK_PO_GRN_LEN INTEGER;
DECLARE VARIABLE WK_FOUND INTEGER;
DECLARE VARIABLE WK_FILENAME  VARCHAR(80);
DECLARE VARIABLE WK_RESULT INTEGER;
DECLARE VARIABLE WK_OWNER_GRN VARCHAR(10);
DECLARE VARIABLE WK_LEN_GRN_ID INTEGER;
DECLARE VARIABLE WK_DO_MORE CHAR(1);
  
BEGIN  
  
     /* Add ISSN record */                                                                      
   SELECT GENERATE_SSN_METHOD FROM CONTROL INTO :WK_GENERATE_SSN_METHOD;
   WK_FILENAME = '/tmp/add.grn.log';
   WK_DO_MORE = 'T';

   IF (WK_DO_MORE = 'T') THEN
   BEGIN
      IF ((WK_GENERATE_SSN_METHOD = 'CMP=2|GRN=6|LINE=2|SFX=2' ) AND 
          (GRN_TYPE = 'PO' OR GRN_TYPE = 'WO' OR GRN_TYPE = 'TR' OR GRN_TYPE = 'RA') ) THEN
      BEGIN
           WK_RESULT = FILE_WRITELN(WK_FILENAME, 'CMP=2 GRN=6 Line=2 SFX = 2'); 
           WK_RESULT = FILE_WRITELN(WK_FILENAME, 'order no'); 
           WK_RESULT = FILE_WRITELN(WK_FILENAME, :ORDER_NO); 
           WK_RESULT = FILE_WRITELN(WK_FILENAME, 'order line no'); 
           WK_RESULT = FILE_WRITELN(WK_FILENAME, :ORDER_LINE_NO); 
         WK_DO_MORE = 'F';
         /* get grn to use from purchase order */
         IF (ORDER_NO IS NULL) THEN
         BEGIN
            ORDER_NO = '';
         END
         SELECT PO_LEGACY_CONSIGNMENT
         FROM PURCHASE_ORDER
         WHERE PURCHASE_ORDER = :ORDER_NO
         INTO :WK_PO_GRN;
         IF (WK_PO_GRN IS NULL) THEN
         BEGIN
            WK_PO_GRN  = '';
         END
           WK_RESULT = FILE_WRITELN(WK_FILENAME, 'po grn '); 
           WK_RESULT = FILE_WRITELN(WK_FILENAME, :WK_PO_GRN); 
   
         SELECT SYMBOLOGY_PREFIX
         FROM PARAM
         WHERE DATA_ID = 'LEGACYGRN'
         INTO :WK_PO_PFX;
           WK_RESULT = FILE_WRITELN(WK_FILENAME, 'po pfx '); 
           WK_RESULT = FILE_WRITELN(WK_FILENAME, :WK_PO_PFX); 
         IF (POS(:WK_PO_GRN, :WK_PO_PFX, 0, 1) = 0) THEN
         BEGIN
           WK_RESULT = FILE_WRITELN(WK_FILENAME, 'found prefix '); 
            WK_PO_PFX_LEN = STRLEN(WK_PO_PFX) + 1;
            WK_PO_GRN_LEN = STRLEN(WK_PO_GRN);
            REC_ID = SUBSTR(WK_PO_GRN, WK_PO_PFX_LEN, WK_PO_GRN_LEN);
         END
         ELSE
         BEGIN
           WK_RESULT = FILE_WRITELN(WK_FILENAME, 'did not find prefix '); 
            REC_ID = WK_PO_GRN;
         END
         IF (REC_ID = '') THEN
         BEGIN
            SELECT GRN 
            FROM NEXT_GRN_ID
            INTO :REC_ID ;
         END
         WK_LEN_GRN_ID = STRLEN(REC_ID);
         WK_OWNER_GRN = REC_ID;
         IF (WK_LEN_GRN_ID < 6) THEN
         BEGIN
            WHILE (WK_LEN_GRN_ID < 6) DO
            BEGIN
               WK_OWNER_GRN = '0' || WK_OWNER_GRN;
               WK_LEN_GRN_ID = WK_LEN_GRN_ID + 1;
            END
            REC_ID = WK_OWNER_GRN;
         END
         
      END
   END

   IF (WK_DO_MORE = 'T') THEN
   BEGIN
      IF ((WK_GENERATE_SSN_METHOD = 'CMP=2|GRN=6|LINE=2|SFX=2' ) AND 
          (GRN_TYPE = 'IP' ) ) THEN
      BEGIN
           WK_RESULT = FILE_WRITELN(WK_FILENAME, 'CMP=2 GRN=6 Line=2 SFX = 2'); 
           WK_RESULT = FILE_WRITELN(WK_FILENAME, 'order no'); 
           WK_RESULT = FILE_WRITELN(WK_FILENAME, :ORDER_NO); 
           WK_RESULT = FILE_WRITELN(WK_FILENAME, 'order line no'); 
           WK_RESULT = FILE_WRITELN(WK_FILENAME, :ORDER_LINE_NO); 
         WK_DO_MORE = 'F';
         /* get grn to use from purchase order */
         IF (ORDER_NO IS NULL) THEN
         BEGIN
            ORDER_NO = '';
         END
         SELECT PO_LEGACY_CONSIGNMENT
         FROM PURCHASE_ORDER
         WHERE PURCHASE_ORDER = :ORDER_NO
         INTO :WK_PO_GRN;
         IF (WK_PO_GRN IS NULL) THEN
         BEGIN
            WK_PO_GRN  = '';
         END
           WK_RESULT = FILE_WRITELN(WK_FILENAME, 'po grn '); 
           WK_RESULT = FILE_WRITELN(WK_FILENAME, :WK_PO_GRN); 
   
         IF (STRLEN(WK_PO_GRN) > 6) THEN
         BEGIN

           WK_RESULT = FILE_WRITELN(WK_FILENAME, 'len of consignment bigger than 6 '); 
            WK_PO_GRN_LEN = STRLEN(WK_PO_GRN);
            WK_PO_PFX_LEN = WK_PO_GRN_LEN - 5;
            REC_ID = SUBSTR(WK_PO_GRN, WK_PO_PFX_LEN, WK_PO_GRN_LEN);
         END
         ELSE
         BEGIN
           WK_RESULT = FILE_WRITELN(WK_FILENAME, 'len of consignment less than 6'); 
            REC_ID = WK_PO_GRN;
         END
         IF (REC_ID = '') THEN
         BEGIN
            SELECT GRN 
            FROM NEXT_GRN_ID
            INTO :REC_ID ;
         END
         WK_LEN_GRN_ID = STRLEN(REC_ID);
         WK_OWNER_GRN = REC_ID;
         IF (WK_LEN_GRN_ID < 6) THEN
         BEGIN
            WHILE (WK_LEN_GRN_ID < 6) DO
            BEGIN
               WK_OWNER_GRN = '0' || WK_OWNER_GRN;
               WK_LEN_GRN_ID = WK_LEN_GRN_ID + 1;
            END
            REC_ID = WK_OWNER_GRN;
         END
         
      END
   END
   IF (WK_DO_MORE = 'T') THEN
   BEGIN
     /* the else for all */
     /* REC_ID = CAST(GEN_ID(GRN, 1) AS VARCHAR(10)); */
     WK_DO_MORE = 'F';

     SELECT GRN 
     FROM NEXT_GRN_ID
     INTO :REC_ID ;
   END

     GRN_ID = REC_ID;
    
     /* check that grn dont exist */
     WK_FOUND = 0;
     SELECT 1
     FROM GRN
     WHERE GRN = :REC_ID
     INTO :WK_FOUND;
     IF (WK_FOUND IS NULL) THEN
     BEGIN
        WK_FOUND = 0;
        WK_RESULT = FILE_WRITELN(WK_FILENAME, 'found = 0 '); 
     END

     IF (WK_FOUND = 1) THEN
     BEGIN
        WK_RESULT = FILE_WRITELN(WK_FILENAME, 'found = 1 '); 
        UPDATE GRN   
        SET  GRN_TYPE =  :GRN_TYPE, 
             TOTAL_QTY_PACKS = :TOTAL_QTY_PACKS, 
             PACK_EAN_SSCC = :PACK_EAN_SSCC,
             CARRIER = :CARRIER, 
             VEHICLE_ID = :VEHICLE_ID, 
             AWB_CONSIGNMENT_NO = :AWB_CONSIGNMENT_NO,
             GRN_PALLET_QTY = :GRN_PALLET_QTY, 
             DELIVERY_DOCKET = :DELIVERY_DOCKET, 
             PALLETS_YN = :PALLETS_YN, 
             CONTAINER_NO = :CONTAINER_NO, 
             USER_ID = :USER_ID,
             DEVICE_ID = :DEVICE_ID, 
             GRN_DATE = 'NOW', 
             ORDER_NO = :ORDER_NO, 
             ORDER_LINE_NO = :ORDER_LINE_NO, 
             RETURN_ID = :RETURN_ID, 
             COMMENTS = :COMMENTS, 
             SHIPPED_DATE = :SHIPPED_DATE
        WHERE GRN = :REC_ID;
     END
     ELSE
     BEGIN
        WK_RESULT = FILE_WRITELN(WK_FILENAME, 'found = 0 2 '); 
        INSERT INTO GRN   
          (GRN, GRN_TYPE, TOTAL_QTY_PACKS, PACK_EAN_SSCC, CARRIER, VEHICLE_ID, AWB_CONSIGNMENT_NO,
           GRN_PALLET_QTY, DELIVERY_DOCKET, PALLETS_YN, CONTAINER_NO, USER_ID,
           DEVICE_ID, GRN_DATE, ORDER_NO, ORDER_LINE_NO, RETURN_ID, COMMENTS, SHIPPED_DATE, LAST_LINE_NO, LAST_PALLET_NO)
  
     VALUES (:REC_ID, :GRN_TYPE, :TOTAL_QTY_PACKS, :PACK_EAN_SSCC,:CARRIER, :VEHICLE_ID, :AWB_CONSIGNMENT_NO,
           :GRN_PALLET_QTY, :DELIVERY_DOCKET, :PALLETS_YN, :CONTAINER_NO, :USER_ID,
           :DEVICE_ID, 'NOW', :ORDER_NO, :ORDER_LINE_NO, :RETURN_ID, :COMMENTS, :SHIPPED_DATE,0,0);
     END
              
END ^

ALTER PROCEDURE ADD_GROUP_DATA (TRN_TYPE VARCHAR(4) CHARACTER SET NONE,
TRN_DATE TIMESTAMP,
FIELD_VALUE VARCHAR(30) CHARACTER SET NONE,
TYPE_CODE VARCHAR(40) CHARACTER SET NONE)
AS 
 
 
 
  

DECLARE VARIABLE REC_EXIST INTEGER; 
DECLARE VARIABLE strDESC VARCHAR(50);

BEGIN

   REC_EXIST = 0;
   /* strDESC = "Created during audit " || :TRN_DATE; */
   strDESC = FIELD_VALUE;
   IF (:TRN_TYPE = 'NIO6') THEN
   BEGIN   /* Product Description */                           
     SELECT 1 
     FROM PRODUCT_DESCRIPTION
     WHERE TYPE_CODE = :TYPE_CODE   
       AND FIELD_CODE = '1'
       AND DESCRIPTION = :FIELD_VALUE   
     INTO :REC_EXIST;
            
     IF (REC_EXIST = 0) THEN
     BEGIN
         INSERT INTO PRODUCT_DESCRIPTION (TYPE_CODE, FIELD_CODE, DESCRIPTION)
         VALUES (:TYPE_CODE, '1', :FIELD_VALUE); 
     END
   END   
   ELSE IF (:TRN_TYPE = 'NIO7') THEN
   BEGIN   /* Product Description */                           
     SELECT 1 
     FROM PRODUCT_DESCRIPTION
     WHERE TYPE_CODE = :TYPE_CODE   
       AND FIELD_CODE = '2'
       AND DESCRIPTION = :FIELD_VALUE   
     INTO :REC_EXIST;
            
     IF (REC_EXIST = 0) THEN
     BEGIN
         INSERT INTO PRODUCT_DESCRIPTION (TYPE_CODE, FIELD_CODE, DESCRIPTION)
         VALUES (:TYPE_CODE, '2', :FIELD_VALUE); 
     END
   END   
   ELSE IF (:TRN_TYPE = 'NIO8') THEN
   BEGIN   /* Product Description */                           
     SELECT 1 
     FROM PRODUCT_DESCRIPTION
     WHERE TYPE_CODE = :TYPE_CODE   
       AND FIELD_CODE = '3'
       AND DESCRIPTION = :FIELD_VALUE   
     INTO :REC_EXIST;
            
     IF (REC_EXIST = 0) THEN
     BEGIN
         INSERT INTO PRODUCT_DESCRIPTION (TYPE_CODE, FIELD_CODE, DESCRIPTION)
         VALUES (:TYPE_CODE, '3', :FIELD_VALUE); 
     END
   END   
   ELSE IF (:TRN_TYPE = 'NIO9') THEN
   BEGIN   /* Product Description */                           
     SELECT 1 
     FROM PRODUCT_DESCRIPTION
     WHERE TYPE_CODE = :TYPE_CODE   
       AND FIELD_CODE = '4'
       AND DESCRIPTION = :FIELD_VALUE   
     INTO :REC_EXIST;
            
     IF (REC_EXIST = 0) THEN
     BEGIN
         INSERT INTO PRODUCT_DESCRIPTION (TYPE_CODE, FIELD_CODE, DESCRIPTION)
         VALUES (:TYPE_CODE, '4', :FIELD_VALUE); 
     END
   END   
   ELSE IF (:TRN_TYPE = 'NIOA') THEN
   BEGIN   /* Product Description */                           
     SELECT 1 
     FROM PRODUCT_DESCRIPTION
     WHERE TYPE_CODE = :TYPE_CODE   
       AND FIELD_CODE = '5'
       AND DESCRIPTION = :FIELD_VALUE   
     INTO :REC_EXIST;
            
     IF (REC_EXIST = 0) THEN
     BEGIN
         INSERT INTO PRODUCT_DESCRIPTION (TYPE_CODE, FIELD_CODE, DESCRIPTION)
         VALUES (:TYPE_CODE, '5', :FIELD_VALUE); 
     END
   END   
 
END ^

ALTER PROCEDURE ADD_INSP_HIST (SSN_ID VARCHAR(20) CHARACTER SET NONE,
STATUS CHAR(1) CHARACTER SET NONE,
TYPE_DATE TIMESTAMP,
TYPE_CODE VARCHAR(40) CHARACTER SET NONE,
TYPE_HEADER_CODE VARCHAR(40) CHARACTER SET NONE,
TYPE_LINE_CODE VARCHAR(40) CHARACTER SET NONE,
DESCRIPTION VARCHAR(100) CHARACTER SET NONE,
PERSON_ID VARCHAR(10) CHARACTER SET NONE,
DEVICE_ID VARCHAR(2) CHARACTER SET NONE)
AS 
 
   
  DECLARE VARIABLE REC_ID INTEGER;
BEGIN
   /* Add inspection history */                                                                      
   REC_ID = GEN_ID(INSP_HIST_RECORD_ID, 1);  
   INSERT INTO INSP_HIST   
        (RECORD_ID, SSN_ID, STATUS, TYPE_DATE, TYPE_CODE, 
         TYPE_HEADER_CODE, TYPE_LINE_CODE, DESCRIPTION, DEVICE_ID, PERSON_ID)
   VALUES (:REC_ID, :SSN_ID, :STATUS, :TYPE_DATE, :TYPE_CODE, 
         :TYPE_HEADER_CODE, :TYPE_LINE_CODE, :DESCRIPTION, :DEVICE_ID, :PERSON_ID);

END ^

ALTER PROCEDURE ADD_ISSN (ORIGINAL_SSN VARCHAR(20) CHARACTER SET NONE,
WH_ID CHAR(2) CHARACTER SET NONE,
LOCN_ID VARCHAR(10) CHARACTER SET NONE,
PREV_LOCN_ID VARCHAR(10) CHARACTER SET NONE,
CURRENT_QTY INTEGER,
PREV_QTY INTEGER,
PREV_DATE TIMESTAMP,
ISSN_STATUS CHAR(2) CHARACTER SET NONE,
STATUS_CODE VARCHAR(10) CHARACTER SET NONE,
CREATE_DATE TIMESTAMP,
USER_ID VARCHAR(10) CHARACTER SET NONE,
PROD_ID VARCHAR(30) CHARACTER SET NONE,
NO_COPIES INTEGER)
AS 
 
 

  DECLARE VARIABLE REC_ID INTEGER;
  DECLARE VARIABLE WK_START INTEGER;
  DECLARE VARIABLE WK_ISSN_VALUE VARCHAR(20);
  DECLARE VARIABLE SSN_LENGTH INTEGER;
  DECLARE VARIABLE WK_COMPANY VARCHAR(20);

BEGIN
   /* Add ISSN record */                                                                      
   REC_ID = GEN_ID(ISSN_SSN_ID, NO_COPIES);
  
   WK_START = REC_ID - NO_COPIES ;

   /* Get length for Barcode */   
   EXECUTE PROCEDURE GET_BARCODE_LENGTH RETURNING_VALUES SSN_LENGTH;
   WK_COMPANY = '';
   SELECT COMPANY_ID 
   FROM ISSN
   WHERE SSN_ID = :ORIGINAL_SSN
   INTO :WK_COMPANY;
   IF (WK_COMPANY IS NULL) THEN
   BEGIN
      WK_COMPANY = '';
   END
   IF (WK_COMPANY = '') THEN
   BEGIN
      SELECT COMPANY_ID 
      FROM PROD_PROFILE
      WHERE PROD_ID = :PROD_ID
      INTO :WK_COMPANY;
   END
   IF (WK_COMPANY IS NULL) THEN
   BEGIN
      WK_COMPANY = '';
   END
   IF (WK_COMPANY = '') THEN
   BEGIN
      SELECT COMPANY_ID
      FROM CONTROL
      INTO :WK_COMPANY;
   END

   WHILE (WK_START < REC_ID) DO
   BEGIN
      WK_ISSN_VALUE =  WK_START;
      WHILE (STRLEN(WK_ISSN_VALUE) < SSN_LENGTH) DO
      BEGIN
         WK_ISSN_VALUE = '0' || WK_ISSN_VALUE;
      END
      INSERT INTO ISSN   
        (SSN_ID, ORIGINAL_SSN, WH_ID, LOCN_ID, PREV_LOCN_ID, CURRENT_QTY, PREV_QTY,
         PREV_DATE, ISSN_STATUS, STATUS_CODE, CREATE_DATE, USER_ID, PROD_ID, ORIGINAL_QTY, COMPANY_ID)

   VALUES (:WK_ISSN_VALUE, :ORIGINAL_SSN, :WH_ID, :LOCN_ID,:PREV_LOCN_ID, :CURRENT_QTY, :PREV_QTY,
           :PREV_DATE, :ISSN_STATUS, :STATUS_CODE, :CREATE_DATE, :USER_ID, :PROD_ID , :CURRENT_QTY , :WK_COMPANY);
      WK_START = WK_START + 1;
   END

END ^

ALTER PROCEDURE ADD_ISSN_FROM_SSN (SSN_ID VARCHAR(20) CHARACTER SET NONE)
AS 
DECLARE VARIABLE WK_STATUS VARCHAR(2);
  DECLARE VARIABLE WK_WH_ID VARCHAR(2);
  DECLARE VARIABLE WK_LOCN_ID VARCHAR(10);
  DECLARE VARIABLE WK_PROD VARCHAR(30);
  DECLARE VARIABLE WK_SSN VARCHAR(20);
  DECLARE VARIABLE WK_SSN_QTY INTEGER;
  DECLARE VARIABLE WK_FOUND   INTEGER;
  DECLARE VARIABLE WK_COMPANY VARCHAR(20);
  DECLARE VARIABLE WK_SERIAL VARCHAR(30);
  DECLARE VARIABLE WK_STATUS_CODE VARCHAR(10);
     
BEGIN
   /* Update ISSN table */   
         
   WK_SSN = '';
   IF (SSN_ID = '') THEN
   BEGIN
      FOR SELECT 
          SSN_ID, WH_ID, LOCN_ID, PROD_ID, STATUS_SSN, CURRENT_QTY, COMPANY_ID, SERIAL_NUMBER, STATUS_CODE
          FROM SSN 
          INTO :WK_SSN, :WK_WH_ID, :WK_LOCN_ID, :WK_PROD, :WK_STATUS, :WK_SSN_QTY, :WK_COMPANY, :WK_SERIAL, :WK_STATUS_CODE
      DO
      BEGIN
         IF ( :WK_PROD IS NULL) THEN
         BEGIN
             WK_FOUND = 0;
             SELECT COUNT(*) FROM ISSN WHERE SSN_ID = :WK_SSN INTO :WK_FOUND;
             IF (WK_FOUND = 0) THEN
             BEGIN
                 INSERT INTO ISSN 
                     (SSN_ID, ORIGINAL_SSN, WH_ID, LOCN_ID, PROD_ID, ISSN_STATUS,CURRENT_QTY, COMPANY_ID, SERIAL_NUMBER, STATUS_CODE)
                     VALUES (:WK_SSN, :WK_SSN, :WK_WH_ID, :WK_LOCN_ID, :WK_PROD, :WK_STATUS, :WK_SSN_QTY, :WK_COMPANY, :WK_SERIAL, :WK_STATUS_CODE );
             END
         END
      END
   END
   ELSE
   BEGIN
      SELECT 
          SSN_ID, WH_ID, LOCN_ID, PROD_ID, STATUS_SSN, CURRENT_QTY, COMPANY_ID, SERIAL_NUMBER, STATUS_CODE
          FROM SSN 
          WHERE SSN_ID = :SSN_ID
          INTO :WK_SSN, :WK_WH_ID, :WK_LOCN_ID, :WK_PROD, :WK_STATUS, :WK_SSN_QTY, :WK_COMPANY, :WK_SERIAL, :WK_STATUS_CODE;
      /* IF (WK_SSN <> '') THEN */
      IF (WK_SSN <> '' AND ( :WK_PROD IS NULL)) THEN
      BEGIN
          WK_FOUND = 0;
          SELECT COUNT(*) FROM ISSN WHERE SSN_ID = :WK_SSN INTO :WK_FOUND;
          IF (WK_FOUND = 0) THEN
          BEGIN
              INSERT INTO ISSN 
                  (SSN_ID, ORIGINAL_SSN, WH_ID, LOCN_ID, PROD_ID, ISSN_STATUS,CURRENT_QTY, COMPANY_ID, SERIAL_NUMBER, STATUS_CODE)
                  VALUES (:WK_SSN, :WK_SSN, :WK_WH_ID, :WK_LOCN_ID, :WK_PROD, :WK_STATUS, :WK_SSN_QTY, :WK_COMPANY, :WK_SERIAL, :WK_STATUS_CODE );
          END
      END
   END
END ^

ALTER PROCEDURE ADD_ISSN_LABEL (WK_LABEL_PRINTER CHAR(2) CHARACTER SET NONE,
WK_ISSN VARCHAR(20) CHARACTER SET NONE)
RETURNS (WK_LABEL_DATA VARCHAR(32000) CHARACTER SET NONE)
AS 
DECLARE VARIABLE WK_DEFAULT_SSN_STATUS CHAR(2);
DECLARE VARIABLE WK_DEFAULT_PROD_STATUS CHAR(2);
DECLARE VARIABLE WK_LABEL_TYPE CHAR(1);
DECLARE VARIABLE WK_LABEL_USE_EXTERNAL CHAR(1);
DECLARE VARIABLE WK_LABEL_FIELD_WRAPPER CHAR(1);
DECLARE VARIABLE WK_BUFFER VARCHAR(40);
DECLARE VARIABLE WK_LABEL_PART VARCHAR(32000);
DECLARE VARIABLE WK_LABEL_PREFIX VARCHAR(32000);
DECLARE VARIABLE WK_WHERE VARCHAR(100);

DECLARE VARIABLE WK_ISSN_PROD VARCHAR(30);
DECLARE VARIABLE WK_ISSN_ORIGINAL_SSN VARCHAR(20);
DECLARE VARIABLE WK_SSN_GRN VARCHAR(10);
DECLARE VARIABLE WK_RESULT INTEGER; 
DECLARE VARIABLE WK_ERROR_TEXT VARCHAR(1024);
BEGIN 

   SELECT PROD_ID, 
      ORIGINAL_SSN
   FROM ISSN
   WHERE SSN_ID=:WK_ISSN
   INTO :WK_ISSN_PROD,
      :WK_ISSN_ORIGINAL_SSN;
   IF (WK_ISSN_PROD IS NULL) THEN
   BEGIN
      WK_ISSN_PROD = '';
   END
   IF (WK_ISSN_ORIGINAL_SSN IS NULL) THEN
   BEGIN
      WK_ISSN_ORIGINAL_SSN = '';
   END
   SELECT GRN 
   FROM SSN
   WHERE SSN_ID=:WK_ISSN_ORIGINAL_SSN
   INTO :WK_SSN_GRN;
   IF (WK_SSN_GRN IS NULL) THEN
   BEGIN
      WK_SSN_GRN = '';
   END
   
   SELECT NEW_SSN_STATUS, 
          NEW_PROD_STATUS, 
          GENERATE_LABEL_TEXT, 
          EXTERNAL_SCRIPT_4_LABEL,
          LABEL_FIELD_WRAPPER 
   FROM CONTROL
   INTO :WK_DEFAULT_SSN_STATUS, 
        :WK_DEFAULT_PROD_STATUS, 
        :WK_LABEL_TYPE, 
        :WK_LABEL_USE_EXTERNAL,
        :WK_LABEL_FIELD_WRAPPER;
   IF (WK_LABEL_TYPE IS NULL) THEN
   BEGIN
      WK_LABEL_TYPE = 'F';
   END
   IF (WK_LABEL_TYPE = '') THEN
   BEGIN
      WK_LABEL_TYPE = 'F';
   END
   IF (WK_LABEL_USE_EXTERNAL IS NULL) THEN
   BEGIN
      WK_LABEL_USE_EXTERNAL = 'F';
   END
   IF (WK_LABEL_USE_EXTERNAL = '') THEN
   BEGIN
      WK_LABEL_USE_EXTERNAL = 'F';
   END
   IF (WK_LABEL_FIELD_WRAPPER IS NULL) THEN
   BEGIN
      WK_LABEL_FIELD_WRAPPER = '%';
   END
   IF (WK_LABEL_PRINTER IS NULL) THEN
   BEGIN
      WK_LABEL_PRINTER = 'PA';
   END
   IF (WK_LABEL_PREFIX IS NULL) THEN
   BEGIN
      WK_LABEL_PREFIX  = '';
   END
   /* now must print a label */
   WK_RESULT = 0;
   IF (WK_LABEL_USE_EXTERNAL = 'F') THEN
   BEGIN
      IF (WK_LABEL_TYPE = 'F') THEN
      BEGIN
         /* use pc_label for label creation */
         WK_RESULT = 0;
         WK_LABEL_DATA = '';
         WK_LABEL_PART = '';
         WK_LABEL_DATA = WK_LABEL_DATA || :WK_LABEL_PREFIX;
         WK_WHERE = " WHERE SSN_ID='" || WK_ISSN || "'";
         EXECUTE PROCEDURE GET_TABLE_DATA ('ISSN', WK_LABEL_FIELD_WRAPPER, '|', :WK_WHERE)
         RETURNING_VALUES :WK_LABEL_PART;
         IF (WK_LABEL_PART IS NULL) THEN
         BEGIN
            WK_LABEL_PART = '';
         END
         WK_LABEL_DATA = WK_LABEL_DATA || :WK_LABEL_PART;
         WK_WHERE = " WHERE SSN_ID='" || WK_ISSN_ORIGINAL_SSN || "'";
         EXECUTE PROCEDURE GET_TABLE_DATA ('SSN', WK_LABEL_FIELD_WRAPPER, '|', :WK_WHERE)
         RETURNING_VALUES :WK_LABEL_PART;
         IF (WK_LABEL_PART IS NULL) THEN
         BEGIN
            WK_LABEL_PART = '';
         END
         WK_LABEL_DATA = WK_LABEL_DATA || :WK_LABEL_PART;
         WK_WHERE = " WHERE PROD_ID='" || WK_ISSN_PROD  || "'";
         EXECUTE PROCEDURE GET_TABLE_DATA ('PROD_PROFILE', WK_LABEL_FIELD_WRAPPER, '|', :WK_WHERE)
         RETURNING_VALUES :WK_LABEL_PART;
         IF (WK_LABEL_PART IS NULL) THEN
         BEGIN
            WK_LABEL_PART = '';
         END
         WK_LABEL_DATA = WK_LABEL_DATA || :WK_LABEL_PART;
         WK_WHERE = " WHERE GRN='" || WK_SSN_GRN  || "'";
         EXECUTE PROCEDURE GET_TABLE_DATA ('GRN', WK_LABEL_FIELD_WRAPPER, '|', :WK_WHERE)
         RETURNING_VALUES :WK_LABEL_PART;
         IF (WK_LABEL_PART IS NULL) THEN
         BEGIN
            WK_LABEL_PART = '';
         END
         WK_LABEL_DATA = WK_LABEL_DATA || :WK_LABEL_PART;
/*
         EXECUTE  PROCEDURE PC_LABEL (:WK_LABEL_PRINTER ,
                  'ISSN' , 
                  :WK_COPIES ,
                  NULL ,
                  :WK_LABEL_DATA ,
                  :WK_USER )
         RETURNING_VALUES :WK_RESULT ,
                           :WK_ERROR_TEXT ;
*/
      END
      ELSE
      BEGIN
         /* use bartender for printing */
         IF (WK_ISSN_PROD IS NOT NULL) THEN
         BEGIN
            /* use pc_label_product for label creation */
            WK_BUFFER = WK_LABEL_PRINTER  || WK_ISSN;
            /* EXECUTE PROCEDURE PC_LABEL_PRODUCT WK_BUFFER RETURNING_VALUES :WK_RESULT; */
            WK_LABEL_DATA = WK_BUFFER;
         END
         ELSE
         BEGIN
            /* use pc_label_issn for label creation */
            WK_BUFFER = WK_LABEL_PRINTER  || WK_ISSN;
            /* EXECUTE PROCEDURE PC_LABEL_ISSN WK_BUFFER RETURNING_VALUES :WK_RESULT; */
            WK_LABEL_DATA = WK_BUFFER;
         END
      END
   END
   ELSE
   BEGIN
      IF (WK_LABEL_TYPE = 'F') THEN
      BEGIN
         /* use error text to pass back data for label creation */
      END
      ELSE
      BEGIN
         WK_BUFFER = WK_LABEL_PRINTER  || WK_ISSN;
         /* use bartender for printing */
         WK_LABEL_DATA = WK_BUFFER;
      END
   END
   SUSPEND;
END ^

ALTER PROCEDURE ADD_LOAN_HIST (LOAN_ORDER_NO INTEGER,
LOAN_ORDER_LINE_NO INTEGER,
SSN_ID VARCHAR(20) CHARACTER SET NONE,
PERSON_ID VARCHAR(10) CHARACTER SET NONE,
LOAN_TYPE VARCHAR(2) CHARACTER SET NONE,
STATUS VARCHAR(2) CHARACTER SET NONE,
LOAN_DATE TIMESTAMP,
DUE_DATE TIMESTAMP,
RETURN_DATE TIMESTAMP,
DEVICE_ID VARCHAR(2) CHARACTER SET NONE,
OPERATOR VARCHAR(10) CHARACTER SET NONE)
AS 
         
BEGIN       
    INSERT INTO LOAN_HISTORY   
       (LOAN_ORDER_NO, LOAN_ORDER_LINE_NO, SSN_ID, PERSON_ID, LOAN_TYPE, STATUS, 
        LOAN_DATE, DUE_DATE, RETURN_DATE, DEVICE_ID, OPERATOR)
    VALUES (:LOAN_ORDER_NO, :LOAN_ORDER_LINE_NO, :SSN_ID, :PERSON_ID, :LOAN_TYPE, :STATUS, 
        :LOAN_DATE, :DUE_DATE, :RETURN_DATE, :DEVICE_ID, :OPERATOR);             
  
END ^

ALTER PROCEDURE ADD_MASTER_DATA (TRN_TYPE VARCHAR(4) CHARACTER SET NONE,
TRN_DATE TIMESTAMP,
FIELD_VALUE VARCHAR(75) CHARACTER SET NONE)
AS 
 
 

DECLARE VARIABLE REC_EXIST INTEGER; 
DECLARE VARIABLE strDESC VARCHAR(50);
DECLARE VARIABLE WK_DODROP VARCHAR(6);
DECLARE VARIABLE WK_CODE VARCHAR(40);
DECLARE VARIABLE WK_CODE2 VARCHAR(40);
DECLARE VARIABLE WK_CODE3 VARCHAR(40);
DECLARE VARIABLE WK_CODE4 VARCHAR(40);
DECLARE VARIABLE WK_SSN VARCHAR(40);

BEGIN

   REC_EXIST = 0;
   /* strDESC = "Created during audit " || :TRN_DATE; */
   strDESC = FIELD_VALUE;
   /* Check if record exists */ 
   IF (:TRN_TYPE = 'NITP') THEN
   BEGIN   /* SSN Type Table */
     SELECT 1 
     FROM SSN_TYPE
     WHERE CODE = :FIELD_VALUE   
     INTO :REC_EXIST;
   
     IF (REC_EXIST = 0) THEN
     BEGIN
       INSERT INTO SSN_TYPE (CODE, DESCRIPTION)
       VALUES (:FIELD_VALUE, :strDESC); 
     END
   END
   ELSE IF (:TRN_TYPE = 'NIOB') THEN
   BEGIN   /* Generic Table */                           
     /* must split the field_value into an ssn and the code */
     EXECUTE PROCEDURE GET_REFERENCE_FIELD :FIELD_VALUE, 1  RETURNING_VALUES :WK_SSN ; 
     EXECUTE PROCEDURE GET_REFERENCE_FIELD :FIELD_VALUE, 2  RETURNING_VALUES :WK_CODE ; 
     /* and for that ssn use its ssn_type in the generic */
     SELECT SSN_TYPE 
     FROM SSN 
     WHERE SSN_ID = :WK_SSN
     INTO :WK_CODE2;
     IF (WK_CODE2 IS NULL) THEN
     BEGIN
        WK_CODE2 = '';
     END
     SELECT 1 
     FROM GENERIC
     WHERE SSN_TYPE = :WK_CODE2   
     AND CODE = :WK_CODE   
     INTO :REC_EXIST;
   
     IF (REC_EXIST = 0) THEN
     BEGIN
       INSERT INTO GENERIC (CODE, DESCRIPTION, SSN_TYPE)
       VALUES (:WK_CODE, :WK_CODE, :WK_CODE2); 
     END
   END
   ELSE IF (:TRN_TYPE = 'NIBC') THEN
   BEGIN   /* Brand Table */                           
     SELECT 1 
     FROM BRAND
     WHERE CODE = :FIELD_VALUE   
     INTO :REC_EXIST;
      
     IF (REC_EXIST = 0) THEN
     BEGIN
        INSERT INTO BRAND (CODE, DESCRIPTION)
        VALUES (:FIELD_VALUE, :strDESC); 
     END
   END
   ELSE IF (:TRN_TYPE = 'NIMO') THEN
   BEGIN   /* Model Table */                           
     SELECT 1 
     FROM MODEL
     WHERE CODE = :FIELD_VALUE   
     INTO :REC_EXIST;
         
     IF (REC_EXIST = 0) THEN
     BEGIN
        INSERT INTO MODEL (CODE, DESCRIPTION)
        VALUES (:FIELD_VALUE, :strDESC); 
     END
   END
   ELSE IF (:TRN_TYPE = 'NICC') THEN
   BEGIN   /* Cost Center Table */                           
     SELECT 1 
     FROM COST_CENTRE
     WHERE CODE = :FIELD_VALUE   
     INTO :REC_EXIST;
            
     IF (REC_EXIST = 0) THEN
     BEGIN
         INSERT INTO COST_CENTRE (CODE, DESCRIPTION)
         VALUES (:FIELD_VALUE, :strDESC); 
     END
   END
   ELSE IF (:TRN_TYPE = 'NILG') THEN
   BEGIN   /* Legacy Table */                           
     SELECT 1 
     FROM LEGACY
     WHERE LEGACY_ID = :FIELD_VALUE   
     INTO :REC_EXIST;
            
     IF (REC_EXIST = 0) THEN
     BEGIN
         INSERT INTO LEGACY (LEGACY_ID, LEGACY_DESCRIPTION)
         VALUES (:FIELD_VALUE, :strDESC); 
     END
   END   
   ELSE IF (:TRN_TYPE = 'NIO6') THEN
   BEGIN   /* Product Description */                           
     SELECT 1 
     FROM PRODUCT_DESCRIPTION
     WHERE TYPE_CODE = :FIELD_VALUE   
       AND FIELD_CODE = '1'
     INTO :REC_EXIST;
            
     IF (REC_EXIST = 0) THEN
     BEGIN
         INSERT INTO PRODUCT_DESCRIPTION (TYPE_CODE, FIELD_CODE, DESCRIPTION)
         VALUES (:FIELD_VALUE, '1', :strDESC); 
     END
   END   
   ELSE IF (:TRN_TYPE = 'NIO7') THEN
   BEGIN   /* Product Description */                           
     SELECT 1 
     FROM PRODUCT_DESCRIPTION
     WHERE TYPE_CODE = :FIELD_VALUE   
       AND FIELD_CODE = '2'
     INTO :REC_EXIST;
            
     IF (REC_EXIST = 0) THEN
     BEGIN
         INSERT INTO PRODUCT_DESCRIPTION (TYPE_CODE, FIELD_CODE, DESCRIPTION)
         VALUES (:FIELD_VALUE, '2', :strDESC); 
     END
   END   
   ELSE IF (:TRN_TYPE = 'NIO8') THEN
   BEGIN   /* Product Description */                           
     SELECT 1 
     FROM PRODUCT_DESCRIPTION
     WHERE TYPE_CODE = :FIELD_VALUE   
       AND FIELD_CODE = '3'
     INTO :REC_EXIST;
            
     IF (REC_EXIST = 0) THEN
     BEGIN
         INSERT INTO PRODUCT_DESCRIPTION (TYPE_CODE, FIELD_CODE, DESCRIPTION)
         VALUES (:FIELD_VALUE, '3', :strDESC); 
     END
   END   
   ELSE IF (:TRN_TYPE = 'NIO9') THEN
   BEGIN   /* Product Description */                           
     SELECT 1 
     FROM PRODUCT_DESCRIPTION
     WHERE TYPE_CODE = :FIELD_VALUE   
       AND FIELD_CODE = '4'
     INTO :REC_EXIST;
            
     IF (REC_EXIST = 0) THEN
     BEGIN
         INSERT INTO PRODUCT_DESCRIPTION (TYPE_CODE, FIELD_CODE, DESCRIPTION)
         VALUES (:FIELD_VALUE, '4', :strDESC); 
     END
   END   
   ELSE IF (:TRN_TYPE = 'NIOA') THEN
   BEGIN   /* Product Description */                           
     SELECT 1 
     FROM PRODUCT_DESCRIPTION
     WHERE TYPE_CODE = :FIELD_VALUE   
       AND FIELD_CODE = '5'
     INTO :REC_EXIST;
            
     IF (REC_EXIST = 0) THEN
     BEGIN
         INSERT INTO PRODUCT_DESCRIPTION (TYPE_CODE, FIELD_CODE, DESCRIPTION)
         VALUES (:FIELD_VALUE, '5', :strDESC); 
     END
   END   
   ELSE IF (:TRN_TYPE = 'NI11') THEN
   BEGIN   /* Other 11 - global_condition */
     SELECT DD_OTHER11 FROM SSN_GROUP WHERE SSN_GROUP = 'DEFAULT'
     INTO :WK_DODROP;
     
     IF (WK_DODROP = 'TRUE') THEN
     BEGIN
        REC_EXIST = 0;
        SELECT 1 
        FROM GLOBAL_CONDITIONS   
        WHERE OTHER_NO = 11
          AND DESCRIPTION = :FIELD_VALUE
        INTO :REC_EXIST;
            
        IF (REC_EXIST = 0) THEN
        BEGIN
            INSERT INTO GLOBAL_CONDITIONS (OTHER_NO, DESCRIPTION, RESULT)
            VALUES (11, :FIELD_VALUE, 'O' ); 
        END
     END
   END   
   ELSE IF (:TRN_TYPE = 'NI12') THEN
   BEGIN   /* Other 12 - global_condition */
     SELECT DD_OTHER12 FROM SSN_GROUP WHERE SSN_GROUP = 'DEFAULT'
     INTO :WK_DODROP;
     IF (WK_DODROP = 'TRUE') THEN
     BEGIN
        REC_EXIST = 0;
        SELECT 1 
        FROM GLOBAL_CONDITIONS   
        WHERE OTHER_NO = 12
          AND DESCRIPTION = :FIELD_VALUE
        INTO :REC_EXIST;
            
        IF (REC_EXIST = 0) THEN
        BEGIN
            INSERT INTO GLOBAL_CONDITIONS (OTHER_NO, DESCRIPTION, RESULT)
            VALUES (12, :FIELD_VALUE, 'O' ); 
        END
     END
   END   
   ELSE IF (:TRN_TYPE = 'NI13') THEN
   BEGIN   /* Other 13 - global_condition */
     SELECT DD_OTHER13 FROM SSN_GROUP WHERE SSN_GROUP = 'DEFAULT'
     INTO :WK_DODROP;
     IF (WK_DODROP = 'TRUE') THEN
     BEGIN
        REC_EXIST = 0;
        SELECT 1 
        FROM GLOBAL_CONDITIONS   
        WHERE OTHER_NO = 13
          AND DESCRIPTION = :FIELD_VALUE
        INTO :REC_EXIST;
            
        IF (REC_EXIST = 0) THEN
        BEGIN
            INSERT INTO GLOBAL_CONDITIONS (OTHER_NO, DESCRIPTION, RESULT)
            VALUES (13, :FIELD_VALUE, 'O' ); 
        END
     END
   END   
   ELSE IF (:TRN_TYPE = 'NI14') THEN
   BEGIN   /* Other 14 - global_condition */
     SELECT DD_OTHER14 FROM SSN_GROUP WHERE SSN_GROUP = 'DEFAULT'
     INTO :WK_DODROP;
     IF (WK_DODROP = 'TRUE') THEN
     BEGIN
        REC_EXIST = 0;
        SELECT 1 
        FROM GLOBAL_CONDITIONS   
        WHERE OTHER_NO = 14
          AND DESCRIPTION = :FIELD_VALUE
        INTO :REC_EXIST;
            
        IF (REC_EXIST = 0) THEN
        BEGIN
            INSERT INTO GLOBAL_CONDITIONS (OTHER_NO, DESCRIPTION, RESULT)
            VALUES (14, :FIELD_VALUE, 'O' ); 
        END
     END
   END   
   ELSE IF (:TRN_TYPE = 'NI19') THEN
   BEGIN   /* Other 19 - global_condition */
     SELECT DD_OTHER19 FROM SSN_GROUP WHERE SSN_GROUP = 'DEFAULT'
     INTO :WK_DODROP;
     IF (WK_DODROP = 'TRUE') THEN
     BEGIN
        REC_EXIST = 0;
        SELECT 1 
        FROM GLOBAL_CONDITIONS   
        WHERE OTHER_NO = 19
          AND DESCRIPTION = :FIELD_VALUE
        INTO :REC_EXIST;
            
        IF (REC_EXIST = 0) THEN
        BEGIN
            INSERT INTO GLOBAL_CONDITIONS (OTHER_NO, DESCRIPTION, RESULT)
            VALUES (19, :FIELD_VALUE, 'O' ); 
        END
     END
   END   
   ELSE IF (:TRN_TYPE = 'NI20') THEN
   BEGIN   /* Other 20 - global_condition */
     SELECT DD_OTHER20 FROM SSN_GROUP WHERE SSN_GROUP = 'DEFAULT'
     INTO :WK_DODROP;
     IF (WK_DODROP = 'TRUE') THEN
     BEGIN
        REC_EXIST = 0;
        SELECT 1 
        FROM GLOBAL_CONDITIONS   
        WHERE OTHER_NO = 20
          AND DESCRIPTION = :FIELD_VALUE
        INTO :REC_EXIST;
            
        IF (REC_EXIST = 0) THEN
        BEGIN
            INSERT INTO GLOBAL_CONDITIONS (OTHER_NO, DESCRIPTION, RESULT)
            VALUES (20, :FIELD_VALUE, 'O' ); 
        END
     END
   END   
   ELSE IF (:TRN_TYPE = 'NISU') THEN
   BEGIN   /* Supplier */
     SELECT 1 
     FROM PERSON
     WHERE PERSON_ID = :FIELD_VALUE   
     INTO :REC_EXIST;
   
     IF (REC_EXIST = 0) THEN
     BEGIN
       INSERT INTO PERSON (PERSON_ID, PERSON_TYPE, FIRST_NAME)
       VALUES (:FIELD_VALUE, 'CS', :strDESC); 
     END
   END   
   ELSE IF (:TRN_TYPE = 'NIPD') THEN
   BEGIN   /* Assets Product */
     SELECT 1 
     FROM SSN_PRODUCT
     WHERE CODE = :FIELD_VALUE   
     INTO :REC_EXIST;
   
     IF (REC_EXIST = 0) THEN
     BEGIN
       INSERT INTO SSN_PRODUCT (CODE, DESCRIPTION)
       VALUES (:FIELD_VALUE, :strDESC); 
     END
   END   
   ELSE IF (:TRN_TYPE = 'NID3') THEN
   BEGIN   /* Assets Sub Type */
     /* must split the field_value into an ssn and the code */
     EXECUTE PROCEDURE GET_REFERENCE_FIELD :FIELD_VALUE, 1  RETURNING_VALUES :WK_SSN ; 
     EXECUTE PROCEDURE GET_REFERENCE_FIELD :FIELD_VALUE, 2  RETURNING_VALUES :WK_CODE ; 
     /* and for that ssn use its ssn_type and generic in the sub type */
     SELECT SSN_TYPE ,GENERIC
     FROM SSN 
     WHERE SSN_ID = :WK_SSN
     INTO :WK_CODE3, :WK_CODE4;
     IF (WK_CODE2 IS NULL) THEN
     BEGIN
        WK_CODE2 = '';
     END
     IF (WK_CODE3 IS NULL) THEN
     BEGIN
        WK_CODE3 = '';
     END
     IF (WK_CODE4 IS NULL) THEN
     BEGIN
        WK_CODE4 = '';
     END
     REC_EXIST = 0;
     SELECT 1
     FROM SSN_SUB_TYPE
     WHERE SSN_TYPE = :WK_CODE3
     AND GENERIC = :WK_CODE4
     AND CODE = :WK_CODE2
     INTO :REC_EXIST;
     IF (REC_EXIST = 0) THEN
     BEGIN
        INSERT INTO SSN_SUB_TYPE (SSN_TYPE, GENERIC, CODE, DESCRIPTION)
           VALUES (:WK_CODE3, :WK_CODE4, :WK_CODE2, :WK_CODE2);
     END
   END   
 
END ^

ALTER PROCEDURE ADD_MESSAGE_V4 (MESSAGE_ID VARCHAR(10) CHARACTER SET NONE,
TRN_VERSION CHAR(2) CHARACTER SET NONE,
TRN_TYPE VARCHAR(4) CHARACTER SET NONE,
TRN_CLASS CHAR(1) CHARACTER SET NONE,
TRN_DATE TIMESTAMP,
PERSON_ID VARCHAR(10) CHARACTER SET NONE,
DEVICE_ID CHAR(2) CHARACTER SET NONE,
TRN_PRIORITY SMALLINT,
REQUEST_STATUS CHAR(2) CHARACTER SET NONE,
ERROR_TEXT VARCHAR(255) CHARACTER SET NONE,
TRN_REPLY_DATE TIMESTAMP)
AS 
 
 
 
DECLARE VARIABLE WK_FOUND INTEGER;
DECLARE VARIABLE WK_EVENT VARCHAR(40);
DECLARE VARIABLE WK_LOG VARCHAR(280);
BEGIN
  WK_FOUND = 0; 
  /* insert new record */
  SELECT 1 FROM WEB_REQUESTS 
  WHERE MESSAGE_ID = :MESSAGE_ID
  INTO :WK_FOUND;
  IF (WK_FOUND = 0) THEN
  BEGIN
     WK_LOG = 'INSERT INTO WEB REQUEST ' || :MESSAGE_ID || ' STATUS ' || :REQUEST_STATUS || ' TYPE ' || :TRN_TYPE || ' CLASS ' || :TRN_CLASS;
     INSERT INTO LOG(DESCRIPTION) VALUES(:WK_LOG);
     INSERT INTO WEB_REQUESTS    
           (MESSAGE_ID, TRN_VERSION, TRN_TYPE, TRN_CLASS, TRN_DATE, TRN_PRIORITY, REQUEST_STATUS, ERROR_TEXT, PERSON_ID, DEVICE_ID)
     VALUES (:MESSAGE_ID, :TRN_VERSION, :TRN_TYPE, :TRN_CLASS, :TRN_DATE, :TRN_PRIORITY, :REQUEST_STATUS, :ERROR_TEXT, :PERSON_ID, :DEVICE_ID);
  END
  ELSE
  BEGIN
     WK_LOG = 'UPDATE WEB REQUEST ' || :MESSAGE_ID || ' STATUS ' || :REQUEST_STATUS || ' TYPE ' || :TRN_TYPE || ' CLASS ' || :TRN_CLASS;
     INSERT INTO LOG(DESCRIPTION) VALUES(:WK_LOG);
     UPDATE WEB_REQUESTS 
        SET PERSON_ID = :PERSON_ID,
            DEVICE_ID = :DEVICE_ID,
            TRN_PRIORITY = :TRN_PRIORITY,
            TRN_REPLY_DATE = :TRN_REPLY_DATE,
            REQUEST_STATUS = :REQUEST_STATUS,
            ERROR_TEXT = :ERROR_TEXT
        WHERE MESSAGE_ID = :MESSAGE_ID;

  END
  IF (REQUEST_STATUS = 'WS') THEN
  BEGIN
     POST_EVENT 'MESSAGE_READY_TOGO'; 
  END
  ELSE
  BEGIN
     IF (REQUEST_STATUS = 'SS') THEN
     BEGIN
        /* request sent can archive transactions */
        UPDATE TRANSACTIONS4 SET COMPLETE = 'T' WHERE MESSAGE_ID = :MESSAGE_ID;
        EXECUTE PROCEDURE TRAN4_ARCHIVE;
     END
     ELSE
     BEGIN
        IF ((REQUEST_STATUS = 'SR') OR (SUBSTR(REQUEST_STATUS,1,1) = 'E')) THEN
        BEGIN
           /* request response so can archive request */
           WK_EVENT = 'MESSAGE_ID_' || :MESSAGE_ID;
           POST_EVENT WK_EVENT;
           EXECUTE PROCEDURE WEB_REQUEST4_ARCHIVE; 
        END
     END
  END
END ^

ALTER PROCEDURE ADD_MODEL (CODE VARCHAR(40) CHARACTER SET NONE)
AS 
    
 
  
DECLARE VARIABLE REC_EXIST INTEGER; 

BEGIN

   REC_EXIST = 0;
      
   /* Check record exists */                        
   SELECT 1 
   FROM MODEL
   WHERE CODE = :CODE   
   INTO :REC_EXIST;
         
   IF (REC_EXIST = 0) THEN
   BEGIN
      INSERT INTO MODEL (CODE, DESCRIPTION)
      VALUES (:CODE, :CODE); 
   END      
   
END ^

ALTER PROCEDURE ADD_NAMED_SSN_ISSN_GRNV (WH_ID VARCHAR(2) CHARACTER SET NONE,
LOCN_ID VARCHAR(10) CHARACTER SET NONE,
OBJECT VARCHAR(30) CHARACTER SET NONE,
TRANS_DATE TIMESTAMP,
QTY INTEGER,
GRN VARCHAR(10) CHARACTER SET NONE,
REFERENCE VARCHAR(40) CHARACTER SET NONE,
SOURCE VARCHAR(9) CHARACTER SET NONE,
RECORD_ID INTEGER,
TRN_CODE CHAR(1) CHARACTER SET NONE)
AS 
 
 
 
DECLARE VARIABLE WK_SSN VARCHAR(40);
DECLARE VARIABLE WK_ISSN VARCHAR(40);
DECLARE VARIABLE WK_KITTED VARCHAR(40);
DECLARE VARIABLE SSN_LENGTH INTEGER;

DECLARE VARIABLE WK_LOADNO VARCHAR(10);
DECLARE VARIABLE WK_LOAD_LINE_NO VARCHAR(10);
DECLARE VARIABLE WK_DATE VARCHAR(20);
DECLARE VARIABLE WK_TIME VARCHAR(10);
DECLARE VARIABLE WK_PROD_DESC VARCHAR(50);
DECLARE VARIABLE WK_A_PROD INTEGER;
DECLARE VARIABLE WK_PROD_EXISTS INTEGER;

DECLARE VARIABLE WK_SUPPLIER VARCHAR(10);
DECLARE VARIABLE WK_OWNER VARCHAR(10);
DECLARE VARIABLE WK_STATUS CHAR(2);
DECLARE VARIABLE WK_ERROR VARCHAR(70);

BEGIN 

/*
   WK_SSN = ALLTRIM(SUBSTR(REFERENCE, 1, 20));
   WK_ISSN = ALLTRIM(SUBSTR(REFERENCE, 21, 40));
*/
   WK_ERROR = '';
   EXECUTE PROCEDURE GET_REFERENCE_FIELD :REFERENCE, 1  RETURNING_VALUES :WK_SSN ; 
   EXECUTE PROCEDURE GET_REFERENCE_FIELD :REFERENCE, 2  RETURNING_VALUES :WK_ISSN ; 
   EXECUTE PROCEDURE GET_REFERENCE_FIELD :REFERENCE, 3  RETURNING_VALUES :WK_KITTED ; 
   WK_SSN = ALLTRIM(WK_SSN);
   WK_ISSN = ALLTRIM(WK_ISSN);
   WK_KITTED = ALLTRIM(WK_KITTED);

   /* Get the STatus to use for the inserts */
   SELECT NEW_SSN_STATUS FROM CONTROL
   INTO :WK_STATUS;

   /* Get length for Barcode */   
   EXECUTE PROCEDURE GET_BARCODE_LENGTH RETURNING_VALUES SSN_LENGTH;
   IF (LEN(WK_SSN) > SSN_LENGTH) THEN
   BEGIN
      EXECUTE PROCEDURE UPDATE_TRAN (:RECORD_ID, 'F', 'SSN Length tooo Long');
      EXIT;
   END
   IF (LEN(WK_SSN) > SSN_LENGTH) THEN
   BEGIN
      EXECUTE PROCEDURE UPDATE_TRAN (:RECORD_ID, 'F', 'ISSN Length tooo Long');
      EXIT;
   END
   IF (WK_SSN = WK_ISSN) THEN
   BEGIN
      /* object is supplier, company, division */
      WK_A_PROD = 0;
      WK_SUPPLIER = SUBSTR(OBJECT,1,10);
      WK_OWNER = SUBSTR(OBJECT,11,20);
      SELECT ORDER_NO, ORDER_LINE_NO
      FROM GRN
      WHERE GRN = :GRN
      INTO :WK_LOADNO, :WK_LOAD_LINE_NO;
      UPDATE GRN 
      SET RETURN_ID = :WK_SUPPLIER
      WHERE GRN = :GRN;
      /* Insert data into SSN table */   
      INSERT INTO SSN (SSN_ID, WH_ID, LOCN_ID, GRN, STATUS_SSN, ORIGINAL_QTY,
                CURRENT_QTY, PO_ORDER, PO_RECEIVE_DATE, PO_LINE, SUPPLIER_ID, COMPANY_ID)
      VALUES (:WK_SSN, :WH_ID, :LOCN_ID, :GRN, 'PA', :QTY, :QTY, :WK_LOADNO, 'NOW', :WK_LOAD_LINE_NO, :WK_SUPPLIER, :WK_OWNER);     
      INSERT INTO ISSN (SSN_ID, ORIGINAL_SSN, WH_ID, LOCN_ID, CURRENT_QTY,ISSN_STATUS, KITTED, COMPANY_ID)
      VALUES (:WK_ISSN, :WK_SSN, :WH_ID, :LOCN_ID, :QTY, :WK_STATUS, :WK_KITTED, :WK_OWNER); 
      WHEN SQLCODE -803
      DO
      BEGIN
         /* ISSN/SSN Already Exists */
         IF (LEN(WK_ERROR) < 53) THEN
         BEGIN
           WK_ERROR = WK_ERROR || 'SSN Already Exists';
         END
      END
   END
   ELSE
   BEGIN
      /* object is product */
      WK_A_PROD = 1;
      WK_PROD_EXISTS = 0;
      SELECT 1, SHORT_DESC FROM PROD_PROFILE
         WHERE PROD_ID = :OBJECT
         INTO :WK_PROD_EXISTS, :WK_PROD_DESC;
      IF (WK_PROD_EXISTS = 0) THEN
      BEGIN
          /* Insert into prod_profile */
          INSERT INTO PROD_PROFILE (PROD_ID, SHORT_DESC, LAST_UPDATE_DATE)
              VALUES (:OBJECT, :OBJECT, 'NOW');
      END
      SELECT COMPANY_ID FROM SSN WHERE SSN_ID = :WK_SSN INTO :WK_OWNER;
      INSERT INTO ISSN (SSN_ID, ORIGINAL_SSN, WH_ID, LOCN_ID, CURRENT_QTY,ISSN_STATUS, PROD_ID, KITTED, COMPANY_ID)
      VALUES (:WK_ISSN, :WK_SSN, :WH_ID, :LOCN_ID, :QTY, :WK_STATUS, :OBJECT, :WK_KITTED, :WK_OWNER); 
      UPDATE SSN SET CURRENT_QTY = CURRENT_QTY + :QTY, ORIGINAL_QTY = ORIGINAL_QTY + :QTY WHERE SSN_ID = :WK_SSN ; 
      WHEN SQLCODE -803
      DO
      BEGIN
         /* ISSN Already Exists */
         IF (LEN(WK_ERROR) < 52 ) THEN
         BEGIN
            WK_ERROR = WK_ERROR || 'ISSN Already Exists';
         END
      END
   END
    /* Update transactions table */        
   IF (WK_ERROR = '') THEN
   BEGIN
      EXECUTE PROCEDURE UPDATE_TRAN (:RECORD_ID, 'T', 'Processed successfully');
   END
   ELSE
   BEGIN
      EXECUTE PROCEDURE UPDATE_TRAN (:RECORD_ID, 'F', :WK_ERROR);
   END
END ^

ALTER PROCEDURE ADD_OBJECT_LABEL (SSN_ID VARCHAR(20) CHARACTER SET NONE,
WH_ID VARCHAR(2) CHARACTER SET NONE,
GRN VARCHAR(15) CHARACTER SET NONE,
COMPANY_ID VARCHAR(20) CHARACTER SET NONE)
AS 
 
     

DECLARE VARIABLE REC_EXIST INTEGER;

BEGIN
    
    REC_EXIST = 0;
    
    SELECT 1 
      FROM SSN
      WHERE SSN_ID = :SSN_ID   
    INTO :REC_EXIST;
      
    IF (REC_EXIST = 0) THEN
    BEGIN  
      INSERT INTO SSN (SSN_ID, WH_ID, LOCN_ID, STATUS_CODE, STATUS_CODE_DATE,
                             GRN, LABEL_DATE, COMPANY_ID)
      VALUES (:SSN_ID, :WH_ID, '00000000', 'RECEIVED', 'NOW', :GRN, 'NOW', :COMPANY_ID);     

      INSERT INTO ISSN (SSN_ID, ORIGINAL_SSN, WH_ID, LOCN_ID, STATUS_CODE, CREATE_DATE, CURRENT_QTY, COMPANY_ID)
      VALUES (:SSN_ID, :SSN_ID, :WH_ID, '00000000', 'RECEIVED', 'NOW', 1, :COMPANY_ID);     
    END
             
END ^

ALTER PROCEDURE ADD_ORDER_GROUP_PICK (WK_CAMPAIGN VARCHAR(10) CHARACTER SET NONE,
WK_ORDER VARCHAR(15) CHARACTER SET NONE,
WK_PERSON VARCHAR(10) CHARACTER SET NONE)
AS 
 
 
DECLARE VARIABLE WK_FOUND INTEGER;
BEGIN
   WK_FOUND = 0;
   SELECT 1  FROM PICK_ORDER_GROUP
   WHERE ORDER_GROUP_ID = :WK_CAMPAIGN  
   AND   PICK_ORDER = :WK_ORDER
  INTO :WK_FOUND ;
   IF (WK_FOUND = 0) THEN
   BEGIN
      INSERT INTO PICK_ORDER_GROUP(ORDER_GROUP_ID, PICK_ORDER, CREATE_DATE, CREATED_BY, STATUS)
      VALUES (:WK_CAMPAIGN, :WK_ORDER, 'NOW', :WK_PERSON, 'OK');
   END
   ELSE
   BEGIN
      UPDATE PICK_ORDER_GROUP SET STATUS = 'OK'
      WHERE ORDER_GROUP_ID = :WK_CAMPAIGN
      AND   PICK_ORDER = :WK_ORDER;
   END
END ^

ALTER PROCEDURE ADD_PICK_ITEMS (WK_ORDER VARCHAR(15) CHARACTER SET NONE,
WK_ORDER_STATUS CHAR(1) CHARACTER SET NONE,
WK_STATUS VARCHAR(6) CHARACTER SET NONE,
WK_PROD1 VARCHAR(30) CHARACTER SET NONE,
WK_EXTENSION1 VARCHAR(6) CHARACTER SET NONE,
WK_LINE_NO1 VARCHAR(4) CHARACTER SET NONE,
WK_QTY1 INTEGER,
WK_TRN_DATE TIMESTAMP,
WK_PERSON_ID VARCHAR(10) CHARACTER SET NONE,
WK_SALE_PRICE NUMERIC(9, 4))
AS 
DECLARE VARIABLE WK_FOUND INTEGER;
DECLARE VARIABLE WK_PICK_LABEL VARCHAR(8);
DECLARE VARIABLE WK_L_PICK_LINE_NO VARCHAR(4);
DECLARE VARIABLE WK_PROD_ID VARCHAR(30);
DECLARE VARIABLE WK_PROD_TYPE CHAR(2);
DECLARE VARIABLE WK_LINE_STATUS CHAR(2);
DECLARE VARIABLE WK_PROD_SALE_PRICE DECIMAL(9,4);
DECLARE VARIABLE WK_PICK_RETURN_DATE TIMESTAMP;
DECLARE VARIABLE WK_PICK_DUE_DATE TIMESTAMP;
DECLARE VARIABLE WK_ORDER_TYPE CHAR(2);
DECLARE VARIABLE WK_PI_SALE_PRICE DECIMAL(9,4);
DECLARE VARIABLE WK_PI_RETURN_DATE TIMESTAMP;
DECLARE VARIABLE WK_PI_DUE_DATE TIMESTAMP;
DECLARE VARIABLE WK_PI_LINE_TOTAL DECIMAL(9,4);
DECLARE VARIABLE WK_LOG_FILENAME VARCHAR(80) ;
DECLARE VARIABLE WK_LOG_RESULT   INTEGER;
DECLARE VARIABLE WK_PI_LABEL   VARCHAR(10);
DECLARE VARIABLE WK_PI_STATUS  CHAR(2);
DECLARE VARIABLE WK_PI_LINENO  VARCHAR(10);
DECLARE VARIABLE WK_LINE_LEN   INTEGER;
DECLARE VARIABLE WK_DEFAULT_UOM  CHAR(2);
DECLARE VARIABLE WK_DEFAULT_STATUS  CHAR(2);
DECLARE VARIABLE WK_DEFAULT_PROD_STATUS CHAR(2);
BEGIN
   /* do line stuff */
   WK_PROD_ID = WK_PROD1 || WK_EXTENSION1;
   WK_LOG_FILENAME = '/tmp/addpickprod.log';
   WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, 'start add pick prod items');
   WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, 'order: ' || :WK_ORDER );
   WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, 'prod1: ' || :WK_PROD1);
   WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, 'prod: ' || :WK_PROD_ID);
   WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, 'qty: ' || :WK_QTY1);
   WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, 'line: ' || :WK_LINE_NO1);
   WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, 'order status: ' || :WK_ORDER_STATUS);
   WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, 'retieve status: ' || :WK_STATUS);
   WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, 'line: ' || :WK_LINE_NO1 || ':');
   IF (WK_LINE_NO1 IS NOT NULL) THEN
   BEGIN
      WK_LINE_NO1 = ALLTRIM(WK_LINE_NO1);
   END
   WK_LINE_LEN = STRLEN(WK_LINE_NO1);
   WHILE (WK_LINE_LEN < 4)
   DO
   BEGIN
      WK_LINE_NO1 = WK_LINE_NO1 || ' ';
      WK_LINE_LEN = WK_LINE_LEN + 1;
   END
   /* does product exist */
   WK_FOUND = 0;
   SELECT 1  
   FROM PROD_PROFILE
   WHERE PROD_ID = :WK_PROD_ID
   INTO :WK_FOUND;
   IF (WK_FOUND = 0) THEN
   BEGIN
      /* no prod profile - so create a dummy */
      /*
      INSERT INTO PROD_PROFILE(PROD_ID, SHORT_DESC)
      VALUES (:WK_PROD_ID, :WK_PROD_ID);
      */
      WK_DEFAULT_UOM = '';
      SELECT STANDARD_UOM FROM UOM_TYPE
      WHERE CODE = 'UT'
      INTO :WK_DEFAULT_UOM;
      INSERT INTO PROD_PROFILE(PROD_ID, SHORT_DESC, UOM, ORDER_UOM, ISSUE_UOM)
      VALUES (:WK_PROD_ID, :WK_PROD_ID, :WK_DEFAULT_UOM, :WK_DEFAULT_UOM, :WK_DEFAULT_UOM);
   END
   WK_FOUND = 0;
   SELECT 1 FROM PROD_EAN
   WHERE PROD_EAN = :WK_PROD1 AND 
         PROD_EAN_EXTENSION = :WK_EXTENSION1
   INTO :WK_FOUND;
   IF (WK_FOUND = 0) THEN
   BEGIN
      /* no prod ean - so create one */
      INSERT INTO PROD_EAN(PROD_ID, PROD_EAN, PROD_EAN_EXTENSION)
      VALUES (:WK_PROD_ID, :WK_PROD1, :WK_EXTENSION1);
   END
   WK_PROD_TYPE = '';
   WK_PROD_SALE_PRICE = 0;
   SELECT PROD_TYPE , SALE_PRICE 
   FROM PROD_PROFILE
   WHERE PROD_ID = :WK_PROD_ID
   INTO :WK_PROD_TYPE, :WK_PROD_SALE_PRICE;
   IF (WK_PROD_TYPE IS NULL) THEN
   BEGIN
      WK_PROD_TYPE = '';
   END
   IF (WK_SALE_PRICE IS NOT NULL) THEN
   BEGIN
      IF (WK_SALE_PRICE > 0) THEN
      BEGIN
         WK_PROD_SALE_PRICE = WK_SALE_PRICE;
      END
   END
   /* now check for default pick line status for this prod type */
   /* get controls status to use
   WK_DEFAULT_PROD_STATUS = 'OP';
   SELECT CONTROL.PICK_IMPORT_PROD_STATUS
   FROM CONTROL
   INTO :WK_DEFAULT_PROD_STATUS;
   /* WK_LINE_STATUS = 'OP'; */
   WK_LINE_STATUS = WK_DEFAULT_PROD_STATUS ;
   SELECT DESCRIPTION  
   FROM OPTIONS
   WHERE GROUP_CODE = 'ProdTYPKST' AND CODE = :WK_PROD_TYPE
   INTO :WK_LINE_STATUS;
   IF (WK_LINE_STATUS IS NULL) THEN
   BEGIN
      /* WK_LINE_STATUS = 'OP'; */
      WK_LINE_STATUS = WK_DEFAULT_PROD_STATUS ;
   END
   /* does line for product exist in order */
   /* WK_STATUS = 'T'; */
   IF (WK_STATUS = 'T') THEN
   BEGIN
      WK_FOUND = 0;
      SELECT 1, RETURN_DATE, PICK_DUE_DATE, PICK_ORDER_TYPE 
      FROM PICK_ORDER
      WHERE PICK_ORDER = :WK_ORDER
      INTO :WK_FOUND, :WK_PICK_RETURN_DATE, :WK_PICK_DUE_DATE, :WK_ORDER_TYPE;
      WK_FOUND = 0;
      IF (WK_LINE_NO1 IS NULL OR WK_LINE_NO1 = '') THEN
      BEGIN
         /*  AND (PICK_LINE_STATUS IN ('UC','CF','OP','UP') */
         SELECT 1, PICK_LABEL_NO FROM PICK_ITEM
         WHERE PICK_ORDER = :WK_ORDER
           AND PROD_ID = :WK_PROD_ID
           AND (PICK_LINE_STATUS IN ('UC','CF','OP','UP','WP')
           OR PICK_LINE_STATUS IS NULL)
         INTO :WK_FOUND, :WK_PICK_LABEL;
      END
      ELSE
      BEGIN
         /*  AND (PICK_LINE_STATUS IN ('UC','CF','OP','UP') */
   WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, 'order: ' || :WK_ORDER );
   WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, 'prod: ' || :WK_PROD_ID);
   WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, 'line: ' || :WK_LINE_NO1 || ':');
         SELECT 1, PICK_LABEL_NO FROM PICK_ITEM
         WHERE PICK_ORDER = :WK_ORDER
           AND PROD_ID = :WK_PROD_ID
           AND PICK_ORDER_LINE_NO = :WK_LINE_NO1
           AND (PICK_LINE_STATUS IN ('UC','CF','OP','UP','WP')
           OR PICK_LINE_STATUS IS NULL)
         INTO :WK_FOUND, :WK_PICK_LABEL;
         FOR SELECT PICK_LABEL_NO,PICK_LINE_STATUS,PICK_ORDER_LINE_NO 
         FROM PICK_ITEM
         WHERE PICK_ORDER = :WK_ORDER
           AND PROD_ID = :WK_PROD_ID
           AND PICK_ORDER_LINE_NO = :WK_LINE_NO1
         INTO :WK_PI_LABEL, :WK_PI_STATUS, :WK_PI_LINENO
         DO
         BEGIN
   WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, 'got a line ');
   WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, 'label:' || :WK_PI_LABEL);
   WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, 'status:' || :WK_PI_STATUS);
   WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, 'line:' || :WK_PI_LINENO || ':');
         END
         FOR SELECT PICK_LABEL_NO,PICK_LINE_STATUS,PICK_ORDER_LINE_NO 
         FROM PICK_ITEM
         WHERE PICK_ORDER = :WK_ORDER
           AND PROD_ID = :WK_PROD_ID
         INTO :WK_PI_LABEL, :WK_PI_STATUS, :WK_PI_LINENO
         DO
         BEGIN
   WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, 'got a line ');
   WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, 'label:' || :WK_PI_LABEL);
   WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, 'status:' || :WK_PI_STATUS);
   WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, 'line:' || :WK_PI_LINENO || ':');
         END
   WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, 'past reading lines ');
      END
   WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, 'found: ' || :WK_FOUND);
   WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, 'label: ' || :WK_PICK_LABEL);
      IF (WK_FOUND = 0) THEN
      BEGIN
         /* no line - so create one */
         /* calc the next label and line no */
         WK_PICK_LABEL = '';
         SELECT LABEL_NO FROM NEXT_PICK_LABEL
         INTO :WK_PICK_LABEL;
         IF ((WK_LINE_NO1 > '') AND (WK_LINE_NO1 <> '0')) THEN
         BEGIN
            WK_L_PICK_LINE_NO = WK_LINE_NO1;
         END
         ELSE
         BEGIN
            SELECT PICK_ORDER_LINE_NO 
            FROM GET_SALE_LINES_NO(:WK_ORDER) 
            INTO :WK_L_PICK_LINE_NO;
         END
         WK_PI_LINE_TOTAL = WK_PROD_SALE_PRICE * WK_QTY1; 
         WK_PI_SALE_PRICE = WK_PROD_SALE_PRICE ;
         WK_PI_DUE_DATE = NULL;
         WK_PI_RETURN_DATE = NULL ;
          
         INSERT INTO PICK_ITEM(
            PICK_ORDER, 
            PICK_LABEL_NO,
            PICK_ORDER_LINE_NO,
            PICK_LINE_STATUS, 
            PICK_ORDER_QTY, 
            PROD_ID,
            PICK_RETRIEVE_STATUS,
            CREATE_DATE,
            USER_ID,
            SSN_CONFIRM,
            SALE_PRICE,
            PICK_LINE_DUE_DATE,
            RETURN_DATE,
            LINE_TOTAL)
         VALUES (
            :WK_ORDER, 
            :WK_PICK_LABEL,
            :WK_L_PICK_LINE_NO,
            :WK_LINE_STATUS, /* 'OP', */ 
            :WK_QTY1,
            :WK_PROD_ID,
            :WK_STATUS,
            :WK_TRN_DATE,
            :WK_PERSON_ID,
            'I',
            :WK_PI_SALE_PRICE,
            :WK_PI_DUE_DATE,
            :WK_PI_RETURN_DATE,
            :WK_PI_LINE_TOTAL );
      END
      ELSE
      BEGIN
         UPDATE PICK_ITEM 
         SET PICK_ORDER_QTY = :WK_QTY1,
            PICK_RETRIEVE_STATUS = :WK_STATUS,
            CREATE_DATE = :WK_TRN_DATE,
            PICK_LINE_STATUS = :WK_LINE_STATUS, /* 'OP', */ 
            USER_ID = :WK_PERSON_ID
         WHERE PICK_LABEL_NO = :WK_PICK_LABEL;
      END
   END
   ELSE
   BEGIN
      /* status is false */
      IF (WK_PROD_ID = 'NOPROD') THEN
      BEGIN
         /* whole order is false*/
         UPDATE PICK_ITEM 
         SET PICK_RETRIEVE_STATUS = :WK_STATUS,
            CREATE_DATE = :WK_TRN_DATE,
            USER_ID = :WK_PERSON_ID
         WHERE PICK_ORDER = :WK_ORDER;
      END
      ELSE
      BEGIN
         /* the line is false*/
         /*  AND (PICK_LINE_STATUS IN ('UC','CF','OP','UP') */
         WK_FOUND = 0;
         SELECT 1, PICK_LABEL_NO FROM PICK_ITEM
         WHERE PICK_ORDER = :WK_ORDER
           AND PROD_ID = :WK_PROD_ID
           AND (PICK_LINE_STATUS IN ('UC','CF','OP','UP','WP')
           OR PICK_LINE_STATUS IS NULL)
         INTO :WK_FOUND, :WK_PICK_LABEL;
         IF (WK_FOUND = 1) THEN
         BEGIN
            UPDATE PICK_ITEM 
            SET PICK_RETRIEVE_STATUS = :WK_STATUS,
               CREATE_DATE = :WK_TRN_DATE,
               USER_ID = :WK_PERSON_ID
            WHERE PICK_LABEL_NO = :WK_PICK_LABEL;
         END
      END
   END
   /* if the status changed to true must recalc the orders retrieve status */
   IF ((WK_STATUS = 'T') AND (WK_ORDER_STATUS = 'F')) THEN
   BEGIN
      /*  AND (PICK_LINE_STATUS IN ('UC','CF','OP','UP') */
      WK_FOUND = 0;
      SELECT FIRST 1 1
      FROM PICK_ITEM 
      WHERE PICK_ORDER = :WK_ORDER
        AND (PICK_LINE_STATUS IN ('UC','CF','OP','UP','WP')
        OR PICK_LINE_STATUS IS NULL)
        AND (PICK_RETRIEVE_STATUS = 'F'
        OR PICK_RETRIEVE_STATUS IS NULL)
      INTO :WK_FOUND;
      IF (WK_FOUND = 0) THEN
      BEGIN
         /* have no more failures */
         /* get controls status to use
         WK_DEFAULT_STATUS = 'DA';
         SELECT CONTROL.DEFAULT_PICK_ORDER_STATUS
         FROM CONTROL
         INTO :WK_DEFAULT_STATUS;
         /*
         UPDATE PICK_ORDER
         SET PICK_STATUS='DA',
             PICK_RETRIEVE_STATUS = :WK_STATUS
         WHERE PICK_ORDER = :WK_ORDER;
         */
         UPDATE PICK_ORDER
         SET PICK_STATUS=:WK_DEFAULT_STATUS,
             PICK_RETRIEVE_STATUS = :WK_STATUS
         WHERE PICK_ORDER = :WK_ORDER;
      END
   END
   WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, 'end   add pick prod items');
END ^

ALTER PROCEDURE ADD_PICK_ITEM_LINE_NO (PICK_ORDER VARCHAR(10) CHARACTER SET NONE,
LAST_LINE_NO INTEGER)
AS 
       
BEGIN
  INSERT INTO PICK_ITEM_LINE_NO VALUES (:PICK_ORDER, :LAST_LINE_NO);
END ^

ALTER PROCEDURE ADD_PICK_REVISED_ITEMS (WK_ORDER VARCHAR(15) CHARACTER SET NONE,
WK_ORDER_STATUS CHAR(1) CHARACTER SET NONE,
WK_STATUS VARCHAR(6) CHARACTER SET NONE,
WK_PROD1 VARCHAR(30) CHARACTER SET NONE,
WK_EXTENSION1 VARCHAR(6) CHARACTER SET NONE,
WK_LINE_NO1 VARCHAR(4) CHARACTER SET NONE,
WK_QTY1 INTEGER,
WK_TRN_DATE TIMESTAMP,
WK_PERSON_ID VARCHAR(10) CHARACTER SET NONE)
AS 
 

DECLARE VARIABLE WK_FOUND INTEGER;
DECLARE VARIABLE WK_PICK_LABEL VARCHAR(8);
DECLARE VARIABLE WK_PICK_LABEL2 VARCHAR(8);
DECLARE VARIABLE WK_L_PICK_LINE_NO VARCHAR(4);
DECLARE VARIABLE WK_LINE_NO2 VARCHAR(4) ;
DECLARE VARIABLE WK_PROD_ID VARCHAR(30);
BEGIN
/*====================================================================*/
   /* do line stuff */
   WK_PROD_ID = WK_PROD1 || WK_EXTENSION1;
   /* does product exist */
   WK_FOUND = 0;
/*
   INSERT INTO LOG(DESCRIPTION) VALUES( 'in add pick lines');
   INSERT INTO LOG(DESCRIPTION) VALUES( :WK_PROD_ID);
   INSERT INTO LOG(DESCRIPTION) VALUES( :WK_STATUS);
*/
   SELECT 1 FROM PROD_PROFILE
   WHERE PROD_ID = :WK_PROD_ID
   INTO :WK_FOUND;
   IF (WK_FOUND = 0) THEN
   BEGIN
      /* no prod profile - so create a dummy */
      INSERT INTO PROD_PROFILE(PROD_ID, SHORT_DESC)
      VALUES (:WK_PROD_ID, :WK_PROD_ID);
   END
   WK_FOUND = 0;
   SELECT 1 FROM PROD_EAN
   WHERE PROD_EAN = :WK_PROD1 AND 
         PROD_EAN_EXTENSION = :WK_EXTENSION1
   INTO :WK_FOUND;
   IF (WK_FOUND = 0) THEN
   BEGIN
      /* no prod ean - so create one */
      INSERT INTO PROD_EAN(PROD_ID, PROD_EAN, PROD_EAN_EXTENSION)
      VALUES (:WK_PROD_ID, :WK_PROD1, :WK_EXTENSION1);
   END
   /* does line for product exist in order */
   WK_PICK_LABEL2 = NULL;
   WK_LINE_NO2 = NULL;
   /* WK_STATUS = 'T'; */
   IF (WK_STATUS = 'T') THEN
   BEGIN
      WK_FOUND = 0;
      SELECT FIRST 1 1, PICK_LABEL_NO, PICK_ORDER_LINE_NO 
      FROM PICK_ITEM
      WHERE PICK_ORDER = :WK_ORDER
        AND PROD_ID = :WK_PROD_ID
      INTO :WK_FOUND, :WK_PICK_LABEL2, :WK_LINE_NO2;
      IF (WK_FOUND = 0) THEN
      BEGIN
         WK_PICK_LABEL2 = NULL;
         /* not in pick item */
      END

      WK_FOUND = 0;
      SELECT FIRST 1 1, PICK_LABEL_NO FROM PICK_ITEM_REVISED
      WHERE PICK_ORDER = :WK_ORDER
        AND PROD_ID = :WK_PROD_ID
      INTO :WK_FOUND, :WK_PICK_LABEL;
      IF (WK_FOUND = 0) THEN
      BEGIN
         /* not in pick item revised */
         IF (WK_PICK_LABEL2 IS NULL) THEN
         BEGIN
            /* no line - so create one */
            /* calc the next label and line no */
            WK_PICK_LABEL = '';
            SELECT LABEL_NO FROM NEXT_PICK_LABEL
            INTO :WK_PICK_LABEL;
            IF ((WK_LINE_NO1 > '') AND (WK_LINE_NO1 <> '0')) THEN
            BEGIN
               WK_L_PICK_LINE_NO = WK_LINE_NO1;
            END
            ELSE
            BEGIN
               SELECT PICK_ORDER_LINE_NO 
               FROM GET_SALE_LINES_NO(:WK_ORDER) 
               INTO :WK_L_PICK_LINE_NO;
            END
         END
         ELSE
         BEGIN
            WK_PICK_LABEL = WK_PICK_LABEL2;
            WK_L_PICK_LINE_NO = WK_LINE_NO2;
         END
          
/*
         INSERT INTO LOG(DESCRIPTION) VALUES( 'insert to pick_item');
*/
         INSERT INTO PICK_ITEM_REVISED(
            PICK_ORDER, 
            PICK_LABEL_NO,
            PICK_ORDER_LINE_NO,
            PICK_LINE_STATUS, 
            PICK_ORDER_QTY, 
            PROD_ID,
            PICK_RETRIEVE_STATUS,
            CREATE_DATE,
            USER_ID,
            SSN_CONFIRM)
         VALUES (
            :WK_ORDER, 
            :WK_PICK_LABEL,
            :WK_L_PICK_LINE_NO,
            'OP',
            :WK_QTY1,
            :WK_PROD_ID,
            :WK_STATUS,
            :WK_TRN_DATE,
            :WK_PERSON_ID,
            'I' );
      END
      ELSE
      BEGIN
/*
         INSERT INTO LOG(DESCRIPTION) VALUES( 'update pick_item');
*/
         UPDATE PICK_ITEM_REVISED 
         SET PICK_ORDER_QTY = :WK_QTY1,
            PICK_RETRIEVE_STATUS = :WK_STATUS,
            CREATE_DATE = :WK_TRN_DATE,
            USER_ID = :WK_PERSON_ID
         WHERE PICK_LABEL_NO = :WK_PICK_LABEL;
      END
   END
/*
   INSERT INTO LOG(DESCRIPTION) VALUES( 'end add pick line');
*/
END ^

ALTER PROCEDURE ADD_PICK_SSN_DESPATCH_ITEMS (WK_ORDER VARCHAR(15) CHARACTER SET NONE,
WK_STATUS CHAR(2) CHARACTER SET NONE,
WK_SSN VARCHAR(20) CHARACTER SET NONE,
WK_LINE_NO1 VARCHAR(4) CHARACTER SET NONE,
WK_QTY1 INTEGER,
WK_DESPATCH_LOCATION VARCHAR(10) CHARACTER SET NONE,
WK_FROM_LOCATION VARCHAR(10) CHARACTER SET NONE,
WK_TRN_DATE TIMESTAMP,
WK_PERSON_ID VARCHAR(10) CHARACTER SET NONE,
WK_DESPATCH_ID INTEGER,
WK_DEVICE_ID CHAR(2) CHARACTER SET NONE)
RETURNS (PICK_LABEL VARCHAR(8) CHARACTER SET NONE)
AS 
DECLARE VARIABLE WK_FOUND INTEGER;
DECLARE VARIABLE WK_PICK_LABEL VARCHAR(8);
DECLARE VARIABLE WK_L_PICK_LINE_NO VARCHAR(4);
DECLARE VARIABLE WK_PICK_DETAIL_ID INTEGER;
DECLARE VARIABLE WK_FROM_WH_ID CHAR(2);
DECLARE VARIABLE WK_FROM_LOCN_ID VARCHAR(10);
BEGIN
/*====================================================================*/
   /* do line stuff */
   WK_FOUND = 0;
   WK_FROM_WH_ID = '';
   WK_FROM_LOCN_ID = '';
   WK_FROM_WH_ID = SUBSTR(WK_FROM_LOCATION,1,2);
   WK_FROM_LOCN_ID = SUBSTR(WK_FROM_LOCATION,3,10);
   /* does line for ssn exist in order */
   BEGIN
      WK_FOUND = 0;
      SELECT FIRST 1  1, PICK_LABEL_NO 
      FROM PICK_ITEM
      WHERE PICK_ORDER = :WK_ORDER
        AND SSN_ID = :WK_SSN
        AND PICK_LINE_STATUS = :WK_STATUS 
      INTO :WK_FOUND, :WK_PICK_LABEL;
      IF (WK_FOUND = 0) THEN
      BEGIN
         /* no line - so create one */
         /* calc the next label and line no */
         WK_PICK_LABEL = '';
         SELECT LABEL_NO FROM NEXT_PICK_LABEL
         INTO :WK_PICK_LABEL;
         IF ((WK_LINE_NO1 > '') AND (WK_LINE_NO1 <> '0')) THEN
         BEGIN
            WK_L_PICK_LINE_NO = WK_LINE_NO1;
         END
         ELSE
         BEGIN
            SELECT PICK_ORDER_LINE_NO 
            FROM GET_SALE_LINES_NO(:WK_ORDER) 
            INTO :WK_L_PICK_LINE_NO;
         END
         INSERT INTO PICK_ITEM(
            PICK_ORDER, 
            PICK_LABEL_NO,
            PICK_ORDER_LINE_NO,
            PICK_LINE_STATUS, 
            PICK_ORDER_QTY, 
            SSN_ID,
            CREATE_DATE,
            USER_ID,
            SSN_CONFIRM,
            DESPATCH_LOCATION,
            PICKED_QTY)
         VALUES (
            :WK_ORDER, 
            :WK_PICK_LABEL,
            :WK_L_PICK_LINE_NO,
            :WK_STATUS,
            :WK_QTY1,
            :WK_SSN,
            :WK_TRN_DATE,
            :WK_PERSON_ID,
            'I',
            :WK_DESPATCH_LOCATION ,
            :WK_QTY1 );
      END
      ELSE
      BEGIN
         UPDATE PICK_ITEM 
         SET PICK_ORDER_QTY = :WK_QTY1,
             PICKED_QTY = :WK_QTY1,
            PICK_LINE_STATUS = :WK_STATUS,
            CREATE_DATE = :WK_TRN_DATE,
            USER_ID = :WK_PERSON_ID
         WHERE PICK_LABEL_NO = :WK_PICK_LABEL;
      END
      PICK_LABEL = WK_PICK_LABEL;
   END
/*
    ok have pick item
    need pick_item_detail as well
*/
   BEGIN
      WK_FOUND = 0;
      SELECT FIRST 1  1, PICK_DETAIL_ID 
      FROM PICK_ITEM_DETAIL
      WHERE PICK_LABEL_NO = :WK_PICK_LABEL
        AND SSN_ID = :WK_SSN
      INTO :WK_FOUND, :WK_PICK_DETAIL_ID;
      IF (WK_FOUND = 0) THEN
      BEGIN
         /* no line - so create one */
         INSERT INTO PICK_ITEM_DETAIL 
             (PICK_LABEL_NO, 
              SSN_ID, 
              PICK_DETAIL_STATUS, 
              DESPATCH_LOCATION,
              QTY_PICKED,
              USER_ID, 
              CREATE_DATE,
              FROM_WH_ID,
              FROM_LOCN_ID,
              DESPATCH_ID,
              DEVICE_ID)
         VALUES (:WK_PICK_LABEL, 
              :WK_SSN,
              :WK_STATUS,
              :WK_DESPATCH_LOCATION ,
              :WK_QTY1,
              :WK_PERSON_ID,
              :WK_TRN_DATE,
              :WK_FROM_WH_ID,
              :WK_FROM_LOCN_ID,
              :WK_DESPATCH_ID,
              :WK_DEVICE_ID);
      END
      ELSE
      BEGIN
         UPDATE PICK_ITEM_DETAIL 
         SET QTY_PICKED = :WK_QTY1,
            PICK_DETAIL_STATUS = :WK_STATUS,
            CREATE_DATE = :WK_TRN_DATE,
            USER_ID = :WK_PERSON_ID,
            DESPATCH_LOCATION = :WK_DESPATCH_LOCATION,
            FROM_WH_ID = :WK_FROM_WH_ID,
            FROM_LOCN_ID = :WK_FROM_LOCN_ID,
            DESPATCH_ID = :WK_DESPATCH_ID,
            DEVICE_ID = :WK_DEVICE_ID
         WHERE PICK_DETAIL_ID = :WK_PICK_DETAIL_ID;
      END
   END
END ^

ALTER PROCEDURE ADD_PICK_SSN_ITEMS (WK_ORDER VARCHAR(15) CHARACTER SET NONE,
WK_ORDER_STATUS CHAR(1) CHARACTER SET NONE,
WK_STATUS VARCHAR(6) CHARACTER SET NONE,
WK_SSN VARCHAR(200) CHARACTER SET NONE,
WK_LINE_NO1 VARCHAR(4) CHARACTER SET NONE,
WK_QTY1 INTEGER,
WK_TRN_DATE TIMESTAMP,
WK_PERSON_ID VARCHAR(10) CHARACTER SET NONE,
WK_SALE_PRICE NUMERIC(9, 4))
AS 
DECLARE VARIABLE WK_FOUND INTEGER;
DECLARE VARIABLE WK_PICK_LABEL VARCHAR(8);
DECLARE VARIABLE WK_L_PICK_LINE_NO VARCHAR(4);
DECLARE VARIABLE WK_SSN_SALE_PRICE DECIMAL(9,4);
DECLARE VARIABLE WK_SSN_COST_BASE  DECIMAL(9,4);
DECLARE VARIABLE WK_SSN_TYPE VARCHAR(40);
DECLARE VARIABLE WK_SSN_COMPANY VARCHAR(20);
DECLARE VARIABLE WK_ISSN_COMPANY VARCHAR(20);
DECLARE VARIABLE WK_PICK_RETURN_DATE TIMESTAMP;
DECLARE VARIABLE WK_PICK_DUE_DATE TIMESTAMP;
DECLARE VARIABLE WK_ORDER_TYPE CHAR(2);
DECLARE VARIABLE WK_PI_SALE_PRICE DECIMAL(9,4);
DECLARE VARIABLE WK_PI_RETURN_DATE TIMESTAMP;
DECLARE VARIABLE WK_PI_DUE_DATE TIMESTAMP;
DECLARE VARIABLE WK_PI_LINE_TOTAL DECIMAL(9,4);
DECLARE VARIABLE WK_PI_LOAN_RATE  DECIMAL(9,4);
DECLARE VARIABLE WK_PERIOD_DAY INTEGER;
DECLARE VARIABLE WK_PERIOD_WEEK INTEGER;
DECLARE VARIABLE WK_PERIOD_MONTH INTEGER;
DECLARE VARIABLE WK_PERIOD_QUARTER INTEGER;
DECLARE VARIABLE WK_PERIOD_YEAR INTEGER;
DECLARE VARIABLE WK_PERIOD_LENGTH VARCHAR(20);
DECLARE VARIABLE WK_PERIOD_NAME VARCHAR(50);
DECLARE VARIABLE WK_TOTAL_DAYS INTEGER;
DECLARE VARIABLE WK_LR_DAY NUMERIC(6,4);
DECLARE VARIABLE WK_LR_WEEK NUMERIC(6,4);
DECLARE VARIABLE WK_LR_MONTH NUMERIC(6,4);
DECLARE VARIABLE WK_LR_QUARTER NUMERIC(6,4);
DECLARE VARIABLE WK_LR_YEAR NUMERIC(6,4);
DECLARE VARIABLE WK_LR_RATE NUMERIC(6,4);
DECLARE VARIABLE WK_ISSN_PROD VARCHAR(30);
DECLARE VARIABLE WK_SSN_PROD VARCHAR(30);
DECLARE VARIABLE WK_PROD_ID VARCHAR(30);
DECLARE VARIABLE WK_PROD_SALE_PRICE NUMERIC(9,4);
DECLARE VARIABLE WK_FIELD_NO INTEGER;
DECLARE VARIABLE WK_FIELD_ENDED CHAR(1);
DECLARE VARIABLE WK_FIELD_ENDED2 CHAR(1);
DECLARE VARIABLE WK_PART_SSN VARCHAR(40);
DECLARE VARIABLE WK_WORK_SSN VARCHAR(30);
DECLARE VARIABLE WK_WORK_QTY VARCHAR(30);
DECLARE VARIABLE WK_WORK_QTY2 VARCHAR(30);
DECLARE VARIABLE WK_LOG_FILENAME VARCHAR(80) ;
DECLARE VARIABLE WK_LOG_RESULT   INTEGER;
BEGIN
   /* do line stuff */
   /* split up wk_ssn seperated by ' '
               with trailing (qty)
   WK_SSN = '111111(23) 22(2) 333(4) 4(3)';
   */
   WK_LOG_FILENAME = '/tmp/addpickssn.log';
   WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, 'start add pick ssn items');
   WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, 'ssn: ' || :WK_SSN);
   WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, 'qty: ' || :WK_QTY1);
   WK_FIELD_NO = 0;
   WK_FIELD_ENDED = 'F';
   WHILE (WK_FIELD_ENDED = 'F') DO
   BEGIN
      WK_FIELD_NO = WK_FIELD_NO + 1;
   WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, 'field no: ' || :WK_FIELD_NO);
      EXECUTE PROCEDURE GET_REFERENCE_FIELD4 (:WK_SSN, :WK_FIELD_NO, ' ') RETURNING_VALUES :WK_PART_SSN, :WK_FIELD_ENDED;
   WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, 'part: ' || :WK_PART_SSN || ' end:' || WK_FIELD_ENDED);
      IF (WK_FIELD_ENDED = 'F') THEN
      BEGIN
         WK_WORK_SSN = '';
         WK_WORK_QTY = '';
         SELECT WK_FIELD_LABEL, WK_FIELD_DATA 
         FROM GET_DATA_REFERENCE_FIELD4 (:WK_PART_SSN, '(')
         INTO :WK_WORK_SSN, :WK_WORK_QTY;
   WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, 'work_ssn: ' || :WK_WORK_SSN || ' work_qty:' || WK_WORK_QTY);
         EXECUTE PROCEDURE GET_REFERENCE_FIELD4 (:WK_WORK_QTY, 1, ')') RETURNING_VALUES :WK_WORK_QTY2, :WK_FIELD_ENDED2;
   WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, 'work_qty2: ' || :WK_WORK_QTY2 || ' ended:' || WK_FIELD_ENDED2);
         IF (WK_FIELD_ENDED2 = 'F') THEN
         BEGIN
            WK_WORK_QTY = WK_WORK_QTY2;
         END
         IF (WK_WORK_QTY = '') THEN
         BEGIN
            WK_WORK_QTY = WK_QTY1;
         END
   WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, 'work_qty to use: ' || :WK_WORK_QTY );
         /* ok now use the wk_work_ssn and wk_work_qty */

         WK_FOUND = 0;
         /* does line for product exist in order */
         /* WK_STATUS = 'T'; */
         IF (WK_STATUS = 'T') THEN
         BEGIN
            WK_FOUND = 0;
            SELECT 1, RETURN_DATE, PICK_DUE_DATE, PICK_ORDER_TYPE 
            FROM PICK_ORDER
            WHERE PICK_ORDER = :WK_ORDER
            INTO :WK_FOUND, :WK_PICK_RETURN_DATE, :WK_PICK_DUE_DATE, :WK_ORDER_TYPE;
            WK_FOUND = 0;
            /*  AND SSN_ID = :WK_SSN */
            IF (WK_LINE_NO1 IS NULL OR WK_LINE_NO1 = '' OR WK_LINE_NO1 = '0') THEN
            BEGIN
               /*  AND (PICK_LINE_STATUS IN ('UC','CF','OP','UP') */
               SELECT 1, PICK_LABEL_NO FROM PICK_ITEM
               WHERE PICK_ORDER = :WK_ORDER
                    AND SSN_ID = :WK_WORK_SSN
                 AND (PICK_LINE_STATUS IN ('UC','CF','OP','UP','WP')
                 OR PICK_LINE_STATUS IS NULL)
               INTO :WK_FOUND, :WK_PICK_LABEL;
            END
            ELSE
            BEGIN
               /*  AND (PICK_LINE_STATUS IN ('UC','CF','OP','UP') */
               SELECT 1, PICK_LABEL_NO FROM PICK_ITEM
               WHERE PICK_ORDER = :WK_ORDER
                    AND SSN_ID = :WK_WORK_SSN
                 AND (PICK_LINE_STATUS IN ('UC','CF','OP','UP','WP')
                 OR PICK_LINE_STATUS IS NULL)
                 AND PICK_ORDER_LINE_NO = :WK_LINE_NO1
               INTO :WK_FOUND, :WK_PICK_LABEL;
            END
            IF (WK_FOUND = 0) THEN
            BEGIN
               WK_SSN_SALE_PRICE = 0;
               WK_SSN_COST_BASE = 0;
               WK_SSN_TYPE = '';
               WK_SSN_COMPANY = '';
               WK_ISSN_COMPANY = '';
               WK_SSN_PROD = '';
               WK_ISSN_PROD = '';
               WK_PROD_SALE_PRICE = 0;
               WK_PROD_ID = '';
               /* WHERE SSN_ID = :WK_SSN */
               SELECT SSN_SALE_PRICE , PROD_ID 
               FROM SSN 
               WHERE SSN_ID = :WK_WORK_SSN
               INTO :WK_SSN_SALE_PRICE, :WK_SSN_PROD ;
               IF (WK_SSN_SALE_PRICE IS NULL) THEN
               BEGIN
                  /* WHERE ISSN.SSN_ID = :WK_SSN */
                  SELECT SSN.SSN_SALE_PRICE  
                  FROM ISSN 
                  JOIN  SSN ON SSN.SSN_ID = ISSN.ORIGINAL_SSN
                  WHERE ISSN.SSN_ID = :WK_WORK_SSN
                  INTO :WK_SSN_SALE_PRICE ;
               END
               /* what about products */
               /* WHERE SSN_ID = :WK_SSN */
               SELECT PROD_ID
               FROM ISSN
               WHERE SSN_ID = :WK_WORK_SSN
               INTO :WK_ISSN_PROD;
               WK_PROD_ID = WK_ISSN_PROD;
               IF (WK_SSN_PROD IS NOT NULL) THEN
               BEGIN
                  WK_PROD_ID = WK_SSN_PROD;
               END
               IF (WK_PROD_ID IS NOT NULL) THEN
               BEGIN
                  SELECT  SALE_PRICE 
                  FROM PROD_PROFILE
                  WHERE PROD_ID = :WK_PROD_ID
                  INTO  :WK_PROD_SALE_PRICE;
                  IF (WK_PROD_SALE_PRICE IS NOT NULL) THEN
                  BEGIN
                     WK_SSN_SALE_PRICE = WK_PROD_SALE_PRICE;
                  END
               END
               IF (WK_SALE_PRICE IS NOT NULL) THEN
               BEGIN
                  IF (WK_SALE_PRICE > 0) THEN
                  BEGIN
                     WK_PROD_SALE_PRICE = WK_SALE_PRICE;
                     WK_SSN_SALE_PRICE = WK_PROD_SALE_PRICE;
                  END
              END
      
               /* no line - so create one */
               /* calc the next label and line no */
               WK_PICK_LABEL = '';
               SELECT LABEL_NO FROM NEXT_PICK_LABEL
               INTO :WK_PICK_LABEL;
               IF ((WK_LINE_NO1 > '') AND (WK_LINE_NO1 <> '0')) THEN
               BEGIN
                  WK_L_PICK_LINE_NO = WK_LINE_NO1;
               END
               ELSE
               BEGIN
                  SELECT PICK_ORDER_LINE_NO 
                  FROM GET_SALE_LINES_NO(:WK_ORDER) 
                  INTO :WK_L_PICK_LINE_NO;
               END
                
               IF (WK_ORDER_TYPE = 'TO' OR WK_ORDER_TYPE = 'LO') THEN
               BEGIN
                  /* WHERE SSN_ID = :WK_SSN */
                  SELECT LOAN_COST_BASE, SSN_TYPE, COMPANY_ID
                  FROM SSN 
                  WHERE SSN_ID = :WK_WORK_SSN
                  INTO :WK_SSN_COST_BASE, :WK_SSN_TYPE, :WK_SSN_COMPANY;
                  /* WHERE SSN_ID = :WK_SSN */
                  SELECT COMPANY_ID
                  FROM ISSN 
                  WHERE SSN_ID = :WK_WORK_SSN
                  INTO :WK_ISSN_COMPANY;
                  /* need loan rate for company and ssn type */
                  /* if none then use ssn_type default */
                  WK_FOUND = 0;
                  SELECT 1, LR_DAY, LR_WEEK, LR_MONTH, LR_QUARTER, LR_ANNUAL
                  FROM LOAN_RATE 
                  WHERE LR_COMPANY_ID = :WK_ISSN_COMPANY
                    AND LR_SSN_TYPE = :WK_SSN_TYPE
                  INTO :WK_FOUND, :WK_LR_DAY, :WK_LR_WEEK, :WK_LR_MONTH, :WK_LR_QUARTER, :WK_LR_YEAR;
                  IF (WK_FOUND = 0) THEN
                  BEGIN
                     SELECT 1, LR_DAY, LR_WEEK, LR_MONTH, LR_QUARTER, LR_ANNUAL
                     FROM LOAN_RATE 
                     WHERE LR_COMPANY_ID = :WK_ISSN_COMPANY
                       AND LR_SSN_TYPE = 'DEFAULT'
                     INTO :WK_FOUND, :WK_LR_DAY, :WK_LR_WEEK, :WK_LR_MONTH, :WK_LR_QUARTER, :WK_LR_YEAR;
                  END
                  IF (WK_FOUND = 0) THEN
                  BEGIN
                     WK_LR_DAY = 1;
                     WK_LR_WEEK = 1;
                     WK_LR_MONTH = 1;
                     WK_LR_QUARTER = 1;
                     WK_LR_YEAR = 1;
                  END
                  /* need to get the period lengths */
                  WK_PERIOD_DAY = 1;
                  WK_PERIOD_WEEK = 7;
                  WK_PERIOD_MONTH = 30;
                  WK_PERIOD_QUARTER = 90;
                  WK_PERIOD_YEAR = 365;
                  FOR SELECT CODE, DESCRIPTION
                      FROM OPTIONS
                      WHERE GROUP_CODE='LOAN_DAYS'
                      INTO :WK_PERIOD_LENGTH, WK_PERIOD_NAME
                  DO
                  BEGIN
                     IF (WK_PERIOD_NAME = 'Days') THEN
                     BEGIN
                        WK_PERIOD_DAY = WK_PERIOD_LENGTH;
                     END
                     IF (WK_PERIOD_NAME = 'Weeks') THEN
                     BEGIN
                        WK_PERIOD_WEEK = WK_PERIOD_LENGTH;
                     END
                     IF (WK_PERIOD_NAME = 'Months') THEN
                     BEGIN
                        WK_PERIOD_MONTH = WK_PERIOD_LENGTH;
                     END
                     IF (WK_PERIOD_NAME = 'Quarters') THEN
                     BEGIN
                        WK_PERIOD_QUARTER = WK_PERIOD_LENGTH;
                     END
                     IF (WK_PERIOD_NAME = 'Years') THEN
                     BEGIN
                        WK_PERIOD_YEAR = WK_PERIOD_LENGTH;
                     END
                  END
                  /* need wk_days as diff between wk_return_date
                     and trn_date */
                  IF (WK_PICK_DUE_DATE IS NULL) THEN
                  BEGIN
                     WK_PICK_DUE_DATE = CAST('NOW' AS TIMESTAMP);
                  END
                  IF (WK_PICK_RETURN_DATE IS NULL) THEN
                  BEGIN
                     WK_PICK_RETURN_DATE = CAST('NOW' AS TIMESTAMP);
                  END
                  WK_TOTAL_DAYS = DIFFDATE(WK_PICK_DUE_DATE, WK_PICK_RETURN_DATE, 4);
                  IF (WK_TOTAL_DAYS = 0) THEN
                  BEGIN
                     WK_TOTAL_DAYS = 1;
                  END
                  /* must use the max time period rate for period */
                  IF (WK_TOTAL_DAYS >= WK_PERIOD_YEAR) THEN
                  BEGIN
                     WK_LR_RATE = WK_LR_YEAR;
                  END
                  ELSE
                  BEGIN
                     IF (WK_TOTAL_DAYS >= WK_PERIOD_QUARTER) THEN
                     BEGIN
                        WK_LR_RATE = WK_LR_QUARTER;
                     END
                     ELSE
                     BEGIN
                        IF (WK_TOTAL_DAYS >= WK_PERIOD_MONTH) THEN
                        BEGIN
                           WK_LR_RATE = WK_LR_MONTH;
                        END
                        ELSE
                        BEGIN
                           IF (WK_TOTAL_DAYS >= WK_PERIOD_WEEK) THEN
                           BEGIN
                              WK_LR_RATE = WK_LR_WEEK;
                           END
                           ELSE
                           BEGIN
                              WK_LR_RATE = WK_LR_DAY;
                           END
                        END
                     END
                  END
      
                  /* WK_PI_LINE_TOTAL = WK_LR_RATE * WK_TOTAL_DAYS * WK_SSN_COST_BASE * WK_QTY1;  */
                  WK_PI_LINE_TOTAL = WK_LR_RATE * WK_TOTAL_DAYS * WK_SSN_COST_BASE * WK_WORK_QTY; 
                  WK_PI_SALE_PRICE = WK_SSN_COST_BASE ;
                  WK_PI_LOAN_RATE = WK_LR_RATE;
                  WK_PI_DUE_DATE = WK_PICK_DUE_DATE;
                  WK_PI_RETURN_DATE = WK_PICK_RETURN_DATE ;
               END
               ELSE
               BEGIN
                  /* WK_PI_LINE_TOTAL = WK_SSN_SALE_PRICE * WK_QTY1; */
                  WK_PI_LINE_TOTAL = WK_SSN_SALE_PRICE * WK_WORK_QTY; 
                  WK_PI_SALE_PRICE = WK_SSN_SALE_PRICE ;
                  WK_PI_DUE_DATE = NULL;
                  WK_PI_RETURN_DATE = NULL ;
                  WK_PI_LOAN_RATE = NULL ;
               END
      
               /*   :WK_SSN, */
               /*   :WK_QTY1, */
               INSERT INTO PICK_ITEM(
                  PICK_ORDER, 
                  PICK_LABEL_NO,
                  PICK_ORDER_LINE_NO,
                  PICK_LINE_STATUS, 
                  PICK_ORDER_QTY, 
                  SSN_ID,
                  PICK_RETRIEVE_STATUS,
                  CREATE_DATE,
                  USER_ID,
                  SSN_CONFIRM,
                  SALE_PRICE,
                  PICK_LINE_DUE_DATE,
                  RETURN_DATE,
                  LINE_TOTAL,
                  PI_LOAN_RATE)
               VALUES (
                  :WK_ORDER, 
                  :WK_PICK_LABEL,
                  :WK_L_PICK_LINE_NO,
                  'UC',
                  :WK_WORK_QTY,
                  :WK_WORK_SSN,
                  :WK_STATUS,
                  :WK_TRN_DATE,
                  :WK_PERSON_ID,
                  'I',
                  :WK_PI_SALE_PRICE,
                  :WK_PI_DUE_DATE,
                  :WK_PI_RETURN_DATE,
                  :WK_PI_LINE_TOTAL,
                  :WK_PI_LOAN_RATE );
            END
            ELSE
            BEGIN
               /* for a TO order recalc sale price and dates */
               WK_SSN_SALE_PRICE = 0;
               WK_SSN_COST_BASE = 0;
               WK_SSN_TYPE = '';
               WK_SSN_COMPANY = '';
               WK_ISSN_COMPANY = '';
      
               IF (WK_ORDER_TYPE = 'TO' OR WK_ORDER_TYPE = 'LO') THEN
               BEGIN
                  /* WHERE SSN_ID = :WK_SSN */
                  SELECT LOAN_COST_BASE, SSN_TYPE, COMPANY_ID
                  FROM SSN 
                  WHERE SSN_ID = :WK_WORK_SSN
                  INTO :WK_SSN_COST_BASE, :WK_SSN_TYPE, :WK_SSN_COMPANY;
                  /* WHERE SSN_ID = :WK_SSN */
                  SELECT COMPANY_ID
                  FROM ISSN 
                  WHERE SSN_ID = :WK_WORK_SSN
                  INTO :WK_ISSN_COMPANY;
                  /* need loan rate for company and ssn type */
                  /* if none then use ssn_type default */
                  WK_FOUND = 0;
                  SELECT 1, LR_DAY, LR_WEEK, LR_MONTH, LR_QUARTER, LR_ANNUAL
                  FROM LOAN_RATE 
                  WHERE LR_COMPANY_ID = :WK_ISSN_COMPANY
                    AND LR_SSN_TYPE = :WK_SSN_TYPE
                  INTO :WK_FOUND, :WK_LR_DAY, :WK_LR_WEEK, :WK_LR_MONTH, :WK_LR_QUARTER, :WK_LR_YEAR;
                  IF (WK_FOUND = 0) THEN
                  BEGIN
                     SELECT 1, LR_DAY, LR_WEEK, LR_MONTH, LR_QUARTER, LR_ANNUAL
                     FROM LOAN_RATE 
                     WHERE LR_COMPANY_ID = :WK_ISSN_COMPANY
                       AND LR_SSN_TYPE = 'DEFAULT'
                     INTO :WK_FOUND, :WK_LR_DAY, :WK_LR_WEEK, :WK_LR_MONTH, :WK_LR_QUARTER, :WK_LR_YEAR;
                  END
                  IF (WK_FOUND = 0) THEN
                  BEGIN
                     WK_LR_DAY = 1;
                     WK_LR_WEEK = 1;
                     WK_LR_MONTH = 1;
                     WK_LR_QUARTER = 1;
                     WK_LR_YEAR = 1;
                  END
                  /* need to get the period lengths */
                  WK_PERIOD_DAY = 1;
                  WK_PERIOD_WEEK = 7;
                  WK_PERIOD_MONTH = 30;
                  WK_PERIOD_QUARTER = 90;
                  WK_PERIOD_YEAR = 365;
                  FOR SELECT CODE, DESCRIPTION
                      FROM OPTIONS
                      WHERE GROUP_CODE='LOAN_DAYS'
                      INTO :WK_PERIOD_LENGTH, WK_PERIOD_NAME
                  DO
                  BEGIN
                     IF (WK_PERIOD_NAME = 'Days') THEN
                     BEGIN
                        WK_PERIOD_DAY = WK_PERIOD_LENGTH;
                     END
                     IF (WK_PERIOD_NAME = 'Weeks') THEN
                     BEGIN
                        WK_PERIOD_WEEK = WK_PERIOD_LENGTH;
                     END
                     IF (WK_PERIOD_NAME = 'Months') THEN
                     BEGIN
                        WK_PERIOD_MONTH = WK_PERIOD_LENGTH;
                     END
                     IF (WK_PERIOD_NAME = 'Quarters') THEN
                     BEGIN
                        WK_PERIOD_QUARTER = WK_PERIOD_LENGTH;
                     END
                     IF (WK_PERIOD_NAME = 'Years') THEN
                     BEGIN
                        WK_PERIOD_YEAR = WK_PERIOD_LENGTH;
                     END
                  END
                  /* need wk_days as diff between wk_return_date
                     and trn_date */
                  IF (WK_PICK_DUE_DATE IS NULL) THEN
                  BEGIN
                     WK_PICK_DUE_DATE = CAST('NOW' AS TIMESTAMP);
                  END
                  IF (WK_PICK_RETURN_DATE IS NULL) THEN
                  BEGIN
                     WK_PICK_RETURN_DATE = CAST('NOW' AS TIMESTAMP);
                  END
                  WK_TOTAL_DAYS = DIFFDATE(WK_PICK_DUE_DATE, WK_PICK_RETURN_DATE, 4);
                  IF (WK_TOTAL_DAYS = 0) THEN
                  BEGIN
                     WK_TOTAL_DAYS = 1;
                  END
                  /* must use the max time period rate for period */
                  IF (WK_TOTAL_DAYS >= WK_PERIOD_YEAR) THEN
                  BEGIN
                     WK_LR_RATE = WK_LR_YEAR;
                  END
                  ELSE
                  BEGIN
                     IF (WK_TOTAL_DAYS >= WK_PERIOD_QUARTER) THEN
                     BEGIN
                        WK_LR_RATE = WK_LR_QUARTER;
                     END
                     ELSE
                     BEGIN
                        IF (WK_TOTAL_DAYS >= WK_PERIOD_MONTH) THEN
                        BEGIN
                           WK_LR_RATE = WK_LR_MONTH;
                        END
                        ELSE
                        BEGIN
                           IF (WK_TOTAL_DAYS >= WK_PERIOD_WEEK) THEN
                           BEGIN
                              WK_LR_RATE = WK_LR_WEEK;
                           END
                           ELSE
                           BEGIN
                              WK_LR_RATE = WK_LR_DAY;
                           END
                        END
                     END
                  END
      
                  /* WK_PI_LINE_TOTAL = WK_LR_RATE * WK_TOTAL_DAYS * WK_SSN_COST_BASE * WK_QTY1;  */
                  WK_PI_LINE_TOTAL = WK_LR_RATE * WK_TOTAL_DAYS * WK_SSN_COST_BASE * WK_WORK_QTY; 
                  WK_PI_SALE_PRICE =  WK_SSN_COST_BASE ;
                  WK_PI_LOAN_RATE = WK_LR_RATE;
                  WK_PI_DUE_DATE = WK_PICK_DUE_DATE;
                  WK_PI_RETURN_DATE = WK_PICK_RETURN_DATE ;
                  /* SET PICK_ORDER_QTY = :WK_QTY1, */
                  UPDATE PICK_ITEM 
                  SET PICK_ORDER_QTY = :WK_WORK_QTY,
                     PICK_RETRIEVE_STATUS = :WK_STATUS,
                     CREATE_DATE = :WK_TRN_DATE,
                     USER_ID = :WK_PERSON_ID,
                     SALE_PRICE = :WK_PI_SALE_PRICE,
                     PICK_LINE_DUE_DATE = :WK_PI_DUE_DATE,
                     RETURN_DATE = :WK_PI_RETURN_DATE,
                     LINE_TOTAL = :WK_PI_LINE_TOTAL,
                     PI_LOAN_RATE = :WK_PI_LOAN_RATE
                  WHERE PICK_LABEL_NO = :WK_PICK_LABEL;
               END
               ELSE
               BEGIN
                  /* SET PICK_ORDER_QTY = :WK_QTY1, */
                  UPDATE PICK_ITEM 
                  SET PICK_ORDER_QTY = :WK_WORK_QTY,
                     PICK_RETRIEVE_STATUS = :WK_STATUS,
                     CREATE_DATE = :WK_TRN_DATE,
                     USER_ID = :WK_PERSON_ID
                  WHERE PICK_LABEL_NO = :WK_PICK_LABEL;
               END
            END
         END
         ELSE
         BEGIN
            /* status is false */
            /* IF (WK_SSN = 'NOPROD') THEN */
            IF (WK_WORK_SSN = 'NOPROD') THEN
            BEGIN
               /* whole order is false*/
               UPDATE PICK_ITEM 
               SET PICK_RETRIEVE_STATUS = :WK_STATUS,
                  CREATE_DATE = :WK_TRN_DATE,
                  USER_ID = :WK_PERSON_ID
               WHERE PICK_ORDER = :WK_ORDER;
            END
            ELSE
            BEGIN
               /* the line is false*/
               /*  AND (PICK_LINE_STATUS IN ('UC','CF','OP','UP') */
               WK_FOUND = 0;
               /*  AND SSN_ID = :WK_SSN */
               SELECT 1, PICK_LABEL_NO FROM PICK_ITEM
               WHERE PICK_ORDER = :WK_ORDER
                 AND SSN_ID = :WK_WORK_SSN
                 AND (PICK_LINE_STATUS IN ('UC','CF','OP','UP','WP')
                 OR PICK_LINE_STATUS IS NULL)
               INTO :WK_FOUND, :WK_PICK_LABEL;
               IF (WK_FOUND = 1) THEN
               BEGIN
                  UPDATE PICK_ITEM 
                  SET PICK_RETRIEVE_STATUS = :WK_STATUS,
                     CREATE_DATE = :WK_TRN_DATE,
                     USER_ID = :WK_PERSON_ID
                  WHERE PICK_LABEL_NO = :WK_PICK_LABEL;
               END
            END
         END
         /* if the status changed to true must recalc the orders retrieve status */
         IF ((WK_STATUS = 'T') AND (WK_ORDER_STATUS = 'F')) THEN
         BEGIN
            /*  AND (PICK_LINE_STATUS IN ('UC','CF','OP','UP') */
            WK_FOUND = 0;
            SELECT FIRST 1 1
            FROM PICK_ITEM 
            WHERE PICK_ORDER = :WK_ORDER
              AND (PICK_LINE_STATUS IN ('UC','CF','OP','UP','WP')
              OR PICK_LINE_STATUS IS NULL)
              AND (PICK_RETRIEVE_STATUS = 'F'
              OR PICK_RETRIEVE_STATUS IS NULL)
            INTO :WK_FOUND;
            IF (WK_FOUND = 0) THEN
            BEGIN
               /* have no more failures */
      /*
               UPDATE PICK_ORDER
               SET PICK_STATUS='DA',
                   PICK_RETRIEVE_STATUS = :WK_STATUS
               WHERE PICK_ORDER = :WK_ORDER;
      */
            END
         END
      END
   END
   WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, 'end add pick ssn items');
END ^

ALTER PROCEDURE ADD_PRODUCT_LABEL (WK_LABEL_PRINTER CHAR(2) CHARACTER SET NONE,
WK_PROD_ID VARCHAR(30) CHARACTER SET NONE,
WK_PICK_LABEL_NO VARCHAR(10) CHARACTER SET NONE,
WK_ISSN VARCHAR(20) CHARACTER SET NONE,
WK_COPIES INTEGER)
RETURNS (WK_LABEL_DATA VARCHAR(32000) CHARACTER SET NONE)
AS 
DECLARE VARIABLE WK_DEFAULT_SSN_STATUS CHAR(2);
DECLARE VARIABLE WK_DEFAULT_PROD_STATUS CHAR(2);
DECLARE VARIABLE WK_LABEL_TYPE CHAR(1);
DECLARE VARIABLE WK_LABEL_USE_EXTERNAL CHAR(1);
DECLARE VARIABLE WK_LABEL_FIELD_WRAPPER CHAR(1);
DECLARE VARIABLE WK_BUFFER VARCHAR(40);
DECLARE VARIABLE WK_LABEL_PART VARCHAR(32000);
DECLARE VARIABLE WK_LABEL_PREFIX VARCHAR(32000);
DECLARE VARIABLE WK_WHERE VARCHAR(100);

DECLARE VARIABLE WK_PROD_PROD VARCHAR(30);
DECLARE VARIABLE WK_PROD_PICK_LABEL VARCHAR(10);
DECLARE VARIABLE WK_RESULT INTEGER; 
DECLARE VARIABLE WK_ERROR_TEXT VARCHAR(1024);
BEGIN 

   IF (WK_PROD_ID IS NULL) THEN
   BEGIN
      WK_PROD_PROD = '';
   END
   ELSE
   BEGIN
      WK_PROD_PROD = WK_PROD_ID;
   END
   IF (WK_PICK_LABEL_NO IS NULL) THEN
   BEGIN
      WK_PROD_PICK_LABEL = '';
   END
   ELSE
   BEGIN
      WK_PROD_PICK_LABEL = WK_PICK_LABEL_NO ;
   END
   
   SELECT NEW_SSN_STATUS, 
          NEW_PROD_STATUS, 
          GENERATE_LABEL_TEXT, 
          EXTERNAL_SCRIPT_4_LABEL,
          LABEL_FIELD_WRAPPER 
   FROM CONTROL
   INTO :WK_DEFAULT_SSN_STATUS, 
        :WK_DEFAULT_PROD_STATUS, 
        :WK_LABEL_TYPE, 
        :WK_LABEL_USE_EXTERNAL,
        :WK_LABEL_FIELD_WRAPPER;
   IF (WK_LABEL_TYPE IS NULL) THEN
   BEGIN
      WK_LABEL_TYPE = 'F';
   END
   IF (WK_LABEL_TYPE = '') THEN
   BEGIN
      WK_LABEL_TYPE = 'F';
   END
   IF (WK_LABEL_USE_EXTERNAL IS NULL) THEN
   BEGIN
      WK_LABEL_USE_EXTERNAL = 'F';
   END
   IF (WK_LABEL_USE_EXTERNAL = '') THEN
   BEGIN
      WK_LABEL_USE_EXTERNAL = 'F';
   END
   IF (WK_LABEL_FIELD_WRAPPER IS NULL) THEN
   BEGIN
      WK_LABEL_FIELD_WRAPPER = '%';
   END
   IF (WK_LABEL_PRINTER IS NULL) THEN
   BEGIN
      WK_LABEL_PRINTER = 'PA';
   END
   IF (WK_LABEL_PREFIX IS NULL) THEN
   BEGIN
      WK_LABEL_PREFIX  = '';
   END
   /* now must print a label */
   WK_RESULT = 0;
   IF (WK_LABEL_USE_EXTERNAL = 'F') THEN
   BEGIN
      IF (WK_LABEL_TYPE = 'F') THEN
      BEGIN
         /* use pc_label for label creation */
         WK_RESULT = 0;
         WK_LABEL_DATA = '';
         WK_LABEL_PART = '';
         WK_LABEL_DATA = WK_LABEL_DATA || :WK_LABEL_PREFIX;
         WK_WHERE = " WHERE PROD_ID='" || WK_PROD_PROD  || "'";
         EXECUTE PROCEDURE GET_TABLE_DATA ('PROD_PROFILE', WK_LABEL_FIELD_WRAPPER, '|', :WK_WHERE)
         RETURNING_VALUES :WK_LABEL_PART;
         IF (WK_LABEL_PART IS NULL) THEN
         BEGIN
            WK_LABEL_PART = '';
         END
         WK_LABEL_DATA = WK_LABEL_DATA || :WK_LABEL_PART;
         WK_WHERE = " WHERE PICK_LABEL_NO='" || WK_PROD_PICK_LABEL   || "'";
         EXECUTE PROCEDURE GET_TABLE_DATA ('PICK_ITEM', WK_LABEL_FIELD_WRAPPER, '|', :WK_WHERE)
         RETURNING_VALUES :WK_LABEL_PART;
         IF (WK_LABEL_PART IS NULL) THEN
         BEGIN
            WK_LABEL_PART = '';
         END
         WK_LABEL_DATA = WK_LABEL_DATA || :WK_LABEL_PART;
         WK_WHERE = " WHERE PROD_ID='" || WK_PROD_PROD   || "'";
         EXECUTE PROCEDURE GET_TABLE_DATA ('PROD_EAN', WK_LABEL_FIELD_WRAPPER, '|', :WK_WHERE)
         RETURNING_VALUES :WK_LABEL_PART;
         IF (WK_LABEL_PART IS NULL) THEN
         BEGIN
            WK_LABEL_PART = '';
         END
         WK_LABEL_DATA = WK_LABEL_DATA || :WK_LABEL_PART;
/*
         EXECUTE  PROCEDURE PC_LABEL (:WK_LABEL_PRINTER ,
                  'PRODUCT' , 
                  :WK_COPIES ,
                  NULL ,
                  :WK_LABEL_DATA ,
                  :WK_USER )
         RETURNING_VALUES :WK_RESULT ,
                           :WK_ERROR_TEXT ;
*/
      END
      ELSE
      BEGIN
         /* use bartender for printing */
         IF (WK_ISSN IS NOT NULL) THEN
         BEGIN
            /* use pc_label_product for label creation */
            WK_BUFFER = WK_LABEL_PRINTER  || WK_ISSN;
            /* EXECUTE PROCEDURE PC_LABEL_PRODUCT WK_BUFFER RETURNING_VALUES :WK_RESULT; */
            WK_LABEL_DATA = WK_BUFFER;
         END
         ELSE
         BEGIN
            /* use pc_label_product for label creation */
            WK_BUFFER = WK_LABEL_PRINTER  || WK_PROD_PROD;
            /* EXECUTE PROCEDURE PC_LABEL_ISSN WK_BUFFER RETURNING_VALUES :WK_RESULT; */
            WK_LABEL_DATA = WK_BUFFER;
         END
      END
   END
   ELSE
   BEGIN
      IF (WK_LABEL_TYPE = 'F') THEN
      BEGIN
         /* use error text to pass back data for label creation */
      END
      ELSE
      BEGIN
         WK_BUFFER = WK_LABEL_PRINTER  || WK_PROD_ID;
         /* use bartender for printing */
         WK_LABEL_DATA = WK_BUFFER;
      END
   END
   SUSPEND;
END ^

ALTER PROCEDURE ADD_PROD_COND_STATUS (SSN_ID VARCHAR(20) CHARACTER SET NONE,
CODE VARCHAR(1) CHARACTER SET NONE,
DESCRIPTION VARCHAR(50) CHARACTER SET NONE,
ORIGINAL VARCHAR(1) CHARACTER SET NONE)
RETURNS (ADD_PROD CHAR(1) CHARACTER SET NONE)
AS 
 

  DECLARE VARIABLE REC_EXIST INTEGER;
  DECLARE VARIABLE MASTER_REC_EXIST INTEGER;
  DECLARE VARIABLE WK_GLOBAL VARCHAR(30);
BEGIN
  REC_EXIST = 0;
  MASTER_REC_EXIST = 0;
  ADD_PROD = 'F';

  /* Check if master record exists */
  SELECT 1
  FROM PRODUCT_CONDITION
  WHERE CODE = :CODE
  AND DESCRIPTION = :DESCRIPTION
  INTO :MASTER_REC_EXIST;

  /* if master record not exists then insert */
  IF (MASTER_REC_EXIST = 0) THEN
  BEGIN
    INSERT INTO PRODUCT_CONDITION
         ( CODE, DESCRIPTION)
    VALUES (:CODE, :DESCRIPTION);
  END
  /* Check if record exists */
  SELECT 1
  FROM PRODUCT_COND_STATUS
  WHERE SSN_ID = :SSN_ID
  AND CODE = :CODE
  AND DESCRIPTION = :DESCRIPTION
  AND ORIGINAL_TEST = :ORIGINAL
  INTO :REC_EXIST;

  /* if record not exists then insert */
  IF (REC_EXIST = 0) THEN
  BEGIN
    ADD_PROD = 'T';

    INSERT INTO PRODUCT_COND_STATUS
         (SSN_ID, CODE, DESCRIPTION, ORIGINAL_TEST)
    VALUES (:SSN_ID, :CODE, :DESCRIPTION, :ORIGINAL);
  END

  IF (:ORIGINAL = 'S') THEN
  BEGIN
     IF (:CODE = 'A') THEN
     BEGIN
        EXECUTE PROCEDURE GET_GLOBAL_CONDITION 1, 'F' RETURNING_VALUES :WK_GLOBAL;
        UPDATE SSN
        SET OTHER1 = :WK_GLOBAL
        WHERE SSN_ID = :SSN_ID;
     END
     ELSE IF (:CODE = 'B') THEN
     BEGIN
        EXECUTE PROCEDURE GET_GLOBAL_CONDITION 2, 'F' RETURNING_VALUES :WK_GLOBAL;
        UPDATE SSN
        SET OTHER2 = :WK_GLOBAL
        WHERE SSN_ID = :SSN_ID;
     END
     ELSE IF (:CODE = 'C') THEN
     BEGIN
        EXECUTE PROCEDURE GET_GLOBAL_CONDITION 3, 'F' RETURNING_VALUES :WK_GLOBAL;
        UPDATE SSN
        SET OTHER3 = :WK_GLOBAL
        WHERE SSN_ID = :SSN_ID;
     END
     ELSE IF (:CODE = 'D') THEN
     BEGIN
        EXECUTE PROCEDURE GET_GLOBAL_CONDITION 4, 'F' RETURNING_VALUES :WK_GLOBAL;
        UPDATE SSN
        SET OTHER4 = :WK_GLOBAL
        WHERE SSN_ID = :SSN_ID;
     END
     ELSE IF (:CODE = 'E') THEN
     BEGIN
        EXECUTE PROCEDURE GET_GLOBAL_CONDITION 5, 'F' RETURNING_VALUES :WK_GLOBAL;
        UPDATE SSN
        SET OTHER5 = :WK_GLOBAL
        WHERE SSN_ID = :SSN_ID;
     END
  END
END ^

ALTER PROCEDURE ADD_PROD_COND_STATUS_TEST (SSN_ID VARCHAR(20) CHARACTER SET NONE,
CODE VARCHAR(1) CHARACTER SET NONE,
DESCRIPTION VARCHAR(50) CHARACTER SET NONE,
ORIGINAL_TEST VARCHAR(1) CHARACTER SET NONE)
RETURNS (ADD_PROD CHAR(1) CHARACTER SET NONE)
AS 
 
 
 
  DECLARE VARIABLE REC_EXIST INTEGER; 
  DECLARE VARIABLE MASTER_REC_EXIST INTEGER; 
BEGIN
  REC_EXIST = 0;
  MASTER_REC_EXIST = 0;
  ADD_PROD = 'F'; 
  
  /* Check if master record exists */
  SELECT 1
  FROM PRODUCT_CONDITION
  WHERE CODE = :CODE
  AND DESCRIPTION = :DESCRIPTION  
  INTO :MASTER_REC_EXIST;  

  /* if master record not exists then insert */
  IF (MASTER_REC_EXIST = 0) THEN
  BEGIN
    INSERT INTO PRODUCT_CONDITION   
         ( CODE, DESCRIPTION)
    VALUES (:CODE, :DESCRIPTION);             
  END
  /* Check if record exists */
  SELECT 1
  FROM PRODUCT_COND_STATUS
  WHERE SSN_ID = :SSN_ID
  AND CODE = :CODE
  AND DESCRIPTION = :DESCRIPTION  
  AND ORIGINAL_TEST = :ORIGINAL_TEST
  INTO :REC_EXIST;  

  /* if record not exists then insert */
  IF (REC_EXIST = 0) THEN
  BEGIN
    ADD_PROD = 'T';
 
    INSERT INTO PRODUCT_COND_STATUS   
         (SSN_ID, CODE, DESCRIPTION, ORIGINAL_TEST)
    VALUES (:SSN_ID, :CODE, :DESCRIPTION, :ORIGINAL_TEST);             
  END
END ^

ALTER PROCEDURE ADD_REPORT_TEMP (SSN_ID VARCHAR(20) CHARACTER SET NONE,
LAST_CHECK TIMESTAMP,
NEXT_CHECK TIMESTAMP)
AS 
  
BEGIN    
    INSERT INTO REPORT_TEMP (SSN_ID, LAST_CHECK, NEXT_CHECK)
     VALUES (:SSN_ID, :LAST_CHECK, :NEXT_CHECK); 
END ^

ALTER PROCEDURE ADD_SSN_FROM_ISSN (SSN_ID VARCHAR(20) CHARACTER SET NONE)
AS 
DECLARE VARIABLE WK_STATUS VARCHAR(2);
  DECLARE VARIABLE WK_WH_ID VARCHAR(2);
  DECLARE VARIABLE WK_LOCN_ID VARCHAR(10);
  DECLARE VARIABLE WK_PROD VARCHAR(30);
  DECLARE VARIABLE WK_SSN VARCHAR(20);
  DECLARE VARIABLE WK_SSN_QTY INTEGER;
  DECLARE VARIABLE WK_FOUND   INTEGER;
  DECLARE VARIABLE WK_COMPANY VARCHAR(20);
  DECLARE VARIABLE WK_SERIAL VARCHAR(30);
  DECLARE VARIABLE WK_STATUS_CODE VARCHAR(10);
     
BEGIN
   /* Update ISSN table */   
         
   WK_SSN = '';
   IF (SSN_ID = '') THEN
   BEGIN
      FOR SELECT 
          ORIGINAL_SSN, WH_ID, LOCN_ID, PROD_ID, ISSN_STATUS, CURRENT_QTY, COMPANY_ID, SERIAL_NUMBER, STATUS_CODE 
          FROM ISSN 
          INTO :WK_SSN, :WK_WH_ID, :WK_LOCN_ID, :WK_PROD, :WK_STATUS, :WK_SSN_QTY, :WK_COMPANY, :WK_SERIAL, :WK_STATUS_CODE
      DO
      BEGIN
         IF ( :WK_PROD IS NULL) THEN
         BEGIN
             WK_FOUND = 0;
             SELECT COUNT(*) FROM SSN WHERE SSN_ID = :WK_SSN INTO :WK_FOUND;
             IF (WK_FOUND = 0) THEN
             BEGIN
                 INSERT INTO SSN 
                     (SSN_ID, WH_ID, LOCN_ID, PROD_ID, STATUS_SSN,CURRENT_QTY, COMPANY_ID, SERIAL_NUMBER, STATUS_CODE)
                     VALUES (:WK_SSN, :WK_WH_ID, :WK_LOCN_ID, :WK_PROD, :WK_STATUS, :WK_SSN_QTY, :WK_COMPANY, :WK_SERIAL, :WK_STATUS_CODE );
             END
         END
      END
   END
   ELSE
   BEGIN
      SELECT 
          ORIGINAL_SSN, WH_ID, LOCN_ID, PROD_ID, ISSN_STATUS, CURRENT_QTY, COMPANY_ID, SERIAL_NUMBER, STATUS_CODE
          FROM ISSN 
          WHERE SSN_ID = :SSN_ID
          INTO :WK_SSN, :WK_WH_ID, :WK_LOCN_ID, :WK_PROD, :WK_STATUS, :WK_SSN_QTY, :WK_COMPANY, :WK_SERIAL, :WK_STATUS_CODE;
      /* IF (WK_SSN <> '') THEN */
      IF (WK_SSN <> '' AND ( :WK_PROD IS NULL)) THEN
      BEGIN
          WK_FOUND = 0;
          SELECT COUNT(*) FROM ISSN WHERE SSN_ID = :WK_SSN INTO :WK_FOUND;
          IF (WK_FOUND = 0) THEN
          BEGIN
              INSERT INTO SSN 
                  (SSN_ID, WH_ID, LOCN_ID, PROD_ID, STATUS_SSN,CURRENT_QTY, COMPANY_ID, SERIAL_NUMBER, STATUS_CODE)
                  VALUES (:WK_SSN, :WK_WH_ID, :WK_LOCN_ID, :WK_PROD, :WK_STATUS, :WK_SSN_QTY, :WK_COMPANY, :WK_SERIAL, :WK_STATUS_CODE );
          END
      END
   END
END ^

ALTER PROCEDURE ADD_SSN_HIST (WH_ID CHAR(2) CHARACTER SET NONE,
LOCN_ID VARCHAR(10) CHARACTER SET NONE,
SSN_ID VARCHAR(20) CHARACTER SET NONE,
TRN_TYPE VARCHAR(4) CHARACTER SET NONE,
TRN_CODE CHAR(1) CHARACTER SET NONE,
TRN_DATE TIMESTAMP,
ERROR_TEXT VARCHAR(255) CHARACTER SET NONE,
REFERENCE VARCHAR(40) CHARACTER SET NONE,
QTY INTEGER,
PERSON_ID VARCHAR(10) CHARACTER SET NONE,
DEVICE_ID CHAR(2) CHARACTER SET NONE)
AS 
DECLARE VARIABLE REC_NO INTEGER;
BEGIN
   REC_NO = GEN_ID(SSN_HIST_RECORD_ID, 1);  
   INSERT INTO SSN_HIST   
        (RECORD_ID, WH_ID, LOCN_ID, SSN_ID, TRN_TYPE, TRN_CODE, TRN_DATE, 
         REFERENCE, QTY, ERROR_TEXT, PERSON_ID, DEVICE_ID)
   VALUES (:REC_NO, :WH_ID, :LOCN_ID,:SSN_ID, :TRN_TYPE, :TRN_CODE, :TRN_DATE, 
         :REFERENCE, :QTY, :ERROR_TEXT, :PERSON_ID, :DEVICE_ID);

   SUSPEND;
END ^

ALTER PROCEDURE ADD_SSN_ISSN_GRCI (WH_ID VARCHAR(2) CHARACTER SET NONE,
LOCN_ID VARCHAR(10) CHARACTER SET NONE,
OBJECT VARCHAR(30) CHARACTER SET NONE,
TRANS_DATE TIMESTAMP,
QTY INTEGER,
GRN VARCHAR(10) CHARACTER SET NONE,
REFERENCE VARCHAR(40) CHARACTER SET NONE,
SOURCE VARCHAR(9) CHARACTER SET NONE,
RECORD_ID INTEGER)
AS 
DECLARE VARIABLE SSN_ID INTEGER;
DECLARE VARIABLE P_SSN_ID INTEGER;
DECLARE VARIABLE W_SSN_ID VARCHAR(20);
DECLARE VARIABLE I_SSN_ID VARCHAR(20);
DECLARE VARIABLE LEN_SSN_ID INTEGER;
DECLARE VARIABLE I_LEN_SSN_ID INTEGER;
DECLARE VARIABLE SSN_LENGTH INTEGER;
DECLARE VARIABLE LABEL_NO INTEGER;
DECLARE VARIABLE WK_LABEL_CURQTY INTEGER;
DECLARE VARIABLE WK_SSN_CURQTY INTEGER;
DECLARE VARIABLE WK_LABELQTY1 VARCHAR(10);
DECLARE VARIABLE WK_LABELQTY2 VARCHAR(10);
DECLARE VARIABLE WK_SSNQTY1 VARCHAR(10);
DECLARE VARIABLE WK_SSNQTY2 VARCHAR(10);
DECLARE VARIABLE WK_GRN_TYPE CHAR(2);
DECLARE VARIABLE WK_PRINTER CHAR(2);
DECLARE VARIABLE WK_DIRECTORY VARCHAR(75);
DECLARE VARIABLE WK_FILENAME VARCHAR(255);
DECLARE VARIABLE WK_LABEL_LINE VARCHAR(250);
DECLARE VARIABLE WK_LOADNO VARCHAR(10);
DECLARE VARIABLE WK_LOAD_LINE_NO VARCHAR(10);
DECLARE VARIABLE WK_RESULT INTEGER;
DECLARE VARIABLE WK_DATE VARCHAR(20);
DECLARE VARIABLE WK_TIME VARCHAR(10);
DECLARE VARIABLE WK_PROD_DESC VARCHAR(50);
DECLARE VARIABLE WK_A_PROD INTEGER;
DECLARE VARIABLE WK_A_PO INTEGER;
DECLARE VARIABLE WK_PROD_EXISTS INTEGER;
DECLARE VARIABLE WK_REF_LEN INTEGER;
DECLARE VARIABLE WK_REF2_LAST INTEGER;
DECLARE VARIABLE WK_OLD_METHOD CHAR(1);
DECLARE VARIABLE WK_PRINTER_2 VARCHAR(5);
DECLARE VARIABLE WK_REF VARCHAR(40);
DECLARE VARIABLE WK_SUPPLIER VARCHAR(10);
DECLARE VARIABLE WK_OWNER VARCHAR(10);
DECLARE VARIABLE WK_OWNER_PFX VARCHAR(10);
DECLARE VARIABLE WK_STATUS CHAR(2);
DECLARE VARIABLE WK_PROD_STATUS CHAR(2);
DECLARE VARIABLE WK_HAVE_FILE_1 INTEGER;
DECLARE VARIABLE WK_HAVE_FILE_2 INTEGER;
DECLARE VARIABLE WK_FILENAME2 VARCHAR(255);
DECLARE VARIABLE W_PRODUCT_SSN_ID VARCHAR(20);
DECLARE VARIABLE WK_PO_FOUND INTEGER;
DECLARE VARIABLE WK_PO_QTY INTEGER;
DECLARE VARIABLE WK_PO_ORIG_QTY INTEGER;
DECLARE VARIABLE WK_PO_NEW_QTY INTEGER;
DECLARE VARIABLE WK_PO_STATUS CHAR(2);
DECLARE VARIABLE WK_USER VARCHAR(10);
DECLARE VARIABLE WK_PROD_TYPE CHAR(2);
DECLARE VARIABLE LABEL_NO2 INTEGER;
DECLARE VARIABLE WK_LABEL_CURQTY2 INTEGER;
DECLARE VARIABLE WK_DEVICE_ID CHAR(2);
DECLARE VARIABLE WK_TRN_TYPE CHAR(4);
DECLARE VARIABLE WK_TRN_CODE CHAR(1);
DECLARE VARIABLE WK_REASON VARCHAR(70);
DECLARE VARIABLE WK_PUTLOCN_1 VARCHAR(10);
DECLARE VARIABLE WK_PUTLOCN_2 VARCHAR(10);
DECLARE VARIABLE WK_WEIGHT_X VARCHAR(10);
DECLARE VARIABLE WK_WEIGHT_UOM VARCHAR(10);
DECLARE VARIABLE WK_ALTPROD VARCHAR(30);
DECLARE VARIABLE WK_STD_PALLET_CFG VARCHAR(2);
DECLARE VARIABLE WK_NON_PALLET_CFG VARCHAR(2);
DECLARE VARIABLE WK_ISSUE_UOM VARCHAR(2);
DECLARE VARIABLE WK_INSTR VARCHAR(50);
DECLARE VARIABLE WK_INNER_UNITS INTEGER;
DECLARE VARIABLE WK_ORDER_UNITS INTEGER;
DECLARE VARIABLE WK_TOT_INNER INTEGER;
DECLARE VARIABLE WK_TOT_OUTER INTEGER;
DECLARE VARIABLE WK_STD_PALLET_DESC VARCHAR(50);
DECLARE VARIABLE WK_STD_PALLET_CARTONS INTEGER;
DECLARE VARIABLE WK_STD_PALLET_LAYERS INTEGER;
DECLARE VARIABLE WK_NON_PALLET_DESC VARCHAR(50);
DECLARE VARIABLE WK_LAST_LINE_NO INTEGER;
DECLARE VARIABLE WK_LAST_PALLET_NO INTEGER;
DECLARE VARIABLE I_PALLET_NO INTEGER;
DECLARE VARIABLE WK_TEMPERATURE_ZONE VARCHAR(2);
DECLARE VARIABLE WK_GENERATE_SSN_METHOD VARCHAR(25);
DECLARE VARIABLE P_LAST_LINE_NO VARCHAR(2);
DECLARE VARIABLE P_LAST_PALLET_NO VARCHAR(3);
DECLARE VARIABLE WK_GENERATE_LABEL_TEXT CHAR(1);
DECLARE VARIABLE WK_COUNT_SSN INTEGER; 
DECLARE VARIABLE WK_RESPONSE_TXT VARCHAR(255);
DECLARE VARIABLE WK_RESPONSE_TXT1 VARCHAR(255);
DECLARE VARIABLE WK_RESPONSE_TXT2 VARCHAR(255);
DECLARE VARIABLE WK_RESPONSE_FINAL VARCHAR(255);
DECLARE VARIABLE WK_1ST_ISSN VARCHAR(20);
DECLARE VARIABLE WK_GRN_OWNER VARCHAR(10); 
DECLARE VARIABLE WK_CMP_FROM VARCHAR(40); 
DECLARE VARIABLE WK_SSN_TYPE VARCHAR(40); 
DECLARE VARIABLE WK_OWNER_GRN VARCHAR(10); 
DECLARE VARIABLE WK_GRN_LOT VARCHAR(30); 
DECLARE VARIABLE WK_LAST_LOT_PALLET_NO INTEGER;
DECLARE VARIABLE WK_LOG_FILENAME VARCHAR(255);
DECLARE VARIABLE WK_SAVED_ISSN VARCHAR(20); 
DECLARE VARIABLE WK_SAVED_QTY1 VARCHAR(20); 
DECLARE VARIABLE WK_SAVED_QTY2 VARCHAR(20); 
BEGIN 
   WK_COUNT_SSN = 0;
   WK_HAVE_FILE_1 = 0;
   WK_HAVE_FILE_2 = 0;
   WK_REF = ALLTRIM(REFERENCE);
   REFERENCE = WK_REF;
   WK_REF_LEN = STRLEN(REFERENCE);
   WK_REF2_LAST = WK_REF_LEN;
   WK_OLD_METHOD = 'Y';
   WK_RESPONSE_TXT = '';
      WK_RESPONSE_TXT1 = '';
   WK_RESPONSE_TXT2 = '';
   WK_RESPONSE_FINAL = '';
   WK_1ST_ISSN = '';
   WK_SAVED_ISSN = '';
   WK_SAVED_QTY1 = '';
   WK_SAVED_QTY2 = '';
   WK_LOG_FILENAME = '/tmp/grnv.log';
   SELECT PERSON_ID, DEVICE_ID, TRN_TYPE, TRN_CODE 
   FROM TRANSACTIONS 
   WHERE RECORD_ID = :RECORD_ID
   INTO :WK_USER, :WK_DEVICE_ID, :WK_TRN_TYPE, :WK_TRN_CODE;
   SELECT GENERATE_LABEL_TEXT FROM CONTROL INTO :WK_GENERATE_LABEL_TEXT;
   IF (WK_GENERATE_LABEL_TEXT IS NULL) THEN
   BEGIN
        WK_GENERATE_LABEL_TEXT = 'F';
   END
   /* do a loop until char is '|' or have the new method
      if char <'0' or > '9' then have the new method */
   WHILE ((SUBSTR(REFERENCE,WK_REF2_LAST,WK_REF2_LAST) <> '|') AND
          (WK_OLD_METHOD = 'Y')) DO
   BEGIN
      IF (SUBSTR(REFERENCE,WK_REF2_LAST,WK_REF2_LAST) < '0' OR
          SUBSTR(REFERENCE,WK_REF2_LAST,WK_REF2_LAST) > '9') THEN
      BEGIN      
         WK_OLD_METHOD = 'N';
      END
      WK_REF2_LAST = WK_REF2_LAST - 1;
   END
   /* Get the STatus to use for the inserts */
   /* SELECT NEW_SSN_STATUS, NEW_PROD_STATUS FROM CONTROL
   INTO :WK_STATUS, :WK_PROD_STATUS; */
   WK_STATUS = 'IN';
   WK_PROD_STATUS = 'IN';
   /* Get length for Barcode */   
   EXECUTE PROCEDURE GET_BARCODE_LENGTH RETURNING_VALUES SSN_LENGTH;
   EXECUTE PROCEDURE GET_REFERENCE_FIELD :REFERENCE, 2  RETURNING_VALUES :WK_LOADNO ; 
   EXECUTE PROCEDURE GET_REFERENCE_FIELD :REFERENCE, 3  RETURNING_VALUES :WK_LOAD_LINE_NO ; 
   EXECUTE PROCEDURE GET_REFERENCE_FIELD :REFERENCE, 4  RETURNING_VALUES :WK_SSNQTY1 ; 
   EXECUTE PROCEDURE GET_REFERENCE_FIELD :REFERENCE, 5  RETURNING_VALUES :WK_LABELQTY1 ; 
   EXECUTE PROCEDURE GET_REFERENCE_FIELD :REFERENCE, 6  RETURNING_VALUES :WK_SSNQTY2 ; 
   EXECUTE PROCEDURE GET_REFERENCE_FIELD :REFERENCE, 7  RETURNING_VALUES :WK_LABELQTY2 ; 
   LABEL_NO = CAST(WK_SSNQTY1 AS INTEGER);
   WK_LABEL_CURQTY = CAST(WK_LABELQTY1 AS INTEGER);
   /* find type of grn PO LD or */
   WK_GRN_TYPE = substr(REFERENCE, 1, 2);
   LABEL_NO2 = CAST(WK_SSNQTY2 AS INTEGER);
   WK_LABEL_CURQTY2 = CAST(WK_LABELQTY2 AS INTEGER);
   IF ((LABEL_NO <= 0) AND (LABEL_NO2 <= 0)) THEN
   BEGIN
      /* no labels so stop */
      EXECUTE PROCEDURE UPDATE_TRAN (:RECORD_ID, 'F', 'No Labels to Print/Create');
      EXIT;
   END
   /* 10/02/09 if 1st group is empty swap the 2 groups  */
   IF (LABEL_NO <= 0) THEN 
   BEGIN
      WK_SAVED_QTY1 = WK_SSNQTY1;
      WK_SAVED_QTY2 = WK_LABELQTY1;
      WK_SSNQTY1 = WK_SSNQTY2;
      WK_LABELQTY1 = WK_LABELQTY2;
      WK_SSNQTY2 = WK_SAVED_QTY1;
      WK_LABELQTY2 = WK_SAVED_QTY2;
      LABEL_NO = CAST(WK_SSNQTY1 AS INTEGER);
      WK_LABEL_CURQTY = CAST(WK_LABELQTY1 AS INTEGER);
   END 
   /* THE SSN GENERATION METHOD IS BASED ON THE CONTROL TABLE FIELD. */
   SELECT GENERATE_SSN_METHOD FROM CONTROL INTO :WK_GENERATE_SSN_METHOD;
   IF ((WK_GENERATE_SSN_METHOD IS NULL) OR ((WK_GENERATE_SSN_METHOD <> '|GRN=4|LINE=2|SUFFIX=2,3|') AND 
    (WK_GENERATE_SSN_METHOD <> 'CMP=2|GRN=6|LINE=2|SFX=2' ))) THEN
   BEGIN
      SSN_ID = GEN_ID(ISSN_SSN_ID, :LABEL_NO);
      P_SSN_ID = SSN_ID - :LABEL_NO;
      LEN_SSN_ID = STRLEN(P_SSN_ID);
      W_SSN_ID = '';
         /* Padding leading with 0 */
      WHILE (LEN_SSN_ID < :SSN_LENGTH) DO
      BEGIN
          W_SSN_ID = W_SSN_ID || '0';
          LEN_SSN_ID = LEN_SSN_ID + 1;
       END
       W_SSN_ID = W_SSN_ID || P_SSN_ID;
   END
   IF (WK_GENERATE_SSN_METHOD = '|GRN=4|LINE=2|SUFFIX=2,3|' ) THEN
   BEGIN
        SELECT LAST_LINE_NO, LAST_PALLET_NO, LAST_LOT_NO FROM GRN WHERE GRN = :GRN INTO :WK_LAST_LINE_NO, :WK_LAST_PALLET_NO, :WK_GRN_LOT;
        IF (:WK_LAST_LINE_NO IS NULL) THEN
        BEGIN
               /* i AM UNSURE ABOUT THIS AS LINE NUMBER ACCORDING TO ME SHOULD NOT BE INCREMENTED.S */
              WK_LAST_LINE_NO = 0;
        END
        IF (WK_LOAD_LINE_NO = '') THEN
        BEGIN
             WK_LAST_LINE_NO = WK_LAST_LINE_NO + 1;
             UPDATE GRN SET LAST_LINE_NO = :WK_LAST_LINE_NO WHERE GRN = :GRN;
        END
        ELSE
        BEGIN
             WK_LAST_LINE_NO = WK_LOAD_LINE_NO;
        END
        IF (:WK_GRN_LOT IS NULL) THEN
        BEGIN
              WK_GRN_LOT = '';
        END
        IF (WK_LAST_LINE_NO < 10) THEN
        BEGIN
             P_LAST_LINE_NO = '0' || WK_LAST_LINE_NO;
        END
        ELSE
        BEGIN
             P_LAST_LINE_NO = WK_LAST_LINE_NO;
        END
        IF (WK_LAST_PALLET_NO IS NULL) THEN
        BEGIN
             WK_LAST_PALLET_NO = 0;
        END
        IF (WK_LAST_PALLET_NO < 10) THEN
        BEGIN
             P_LAST_PALLET_NO = '0' || WK_LAST_PALLET_NO;
        END
        ELSE
        BEGIN
             P_LAST_PALLET_NO = WK_LAST_PALLET_NO;
        END
        UPDATE GRN SET LAST_PALLET_NO = :WK_LAST_PALLET_NO WHERE GRN = :GRN;
        IF (STRLEN(WK_GRN_LOT) > 0) THEN
        BEGIN
           WK_OWNER_GRN = SUBSTR(WK_GRN_LOT, 1, 4);
           P_LAST_LINE_NO = SUBSTR(WK_GRN_LOT, 5, 6);
        END
        /* tHE FIRST TIME THE LAST_PALLET_NO IS ALWAYS 0 */
        W_SSN_ID = GRN || P_LAST_LINE_NO || '00';
   END /* if ssn method is |GRN=4|LINE=2|SUFFIX=2,3| */
   IF (WK_GENERATE_SSN_METHOD = 'CMP=2|GRN=6|LINE=2|SFX=2' ) THEN
   BEGIN
        SELECT LAST_LINE_NO, LAST_PALLET_NO, LAST_LOT_NO FROM GRN WHERE GRN = :GRN INTO :WK_LAST_LINE_NO, :WK_LAST_PALLET_NO, :WK_GRN_LOT;
        IF (:WK_LAST_LINE_NO IS NULL) THEN
        BEGIN
               /* i AM UNSURE ABOUT THIS AS LINE NUMBER ACCORDING TO ME SHOULD NOT BE INCREMENTED.S */
              WK_LAST_LINE_NO = 0;
        END
        IF (WK_LOAD_LINE_NO = '') THEN
        BEGIN
             WK_LAST_LINE_NO = WK_LAST_LINE_NO + 1;
             UPDATE GRN SET LAST_LINE_NO = :WK_LAST_LINE_NO WHERE GRN = :GRN;
        END
        ELSE
        BEGIN
        /* THE LAST LINE NUMBER HAS BEEN PASSED FROM THE FRONT END SCREEN. NO UPDATE TO GRN REQUIRED. */
             WK_LAST_LINE_NO = WK_LOAD_LINE_NO;
        END
        IF (WK_GRN_LOT IS NULL) THEN
        BEGIN
           WK_GRN_LOT = '';
        END
        IF (WK_LAST_LINE_NO < 10) THEN
        BEGIN
             P_LAST_LINE_NO = '0' || WK_LAST_LINE_NO;
        END
        ELSE
        BEGIN
             P_LAST_LINE_NO = WK_LAST_LINE_NO;
        END
        IF (WK_LAST_PALLET_NO IS NULL) THEN
        BEGIN
             WK_LAST_PALLET_NO = 0;
        END
        IF (WK_LAST_PALLET_NO < 10) THEN
        BEGIN
             P_LAST_PALLET_NO = '0' || WK_LAST_PALLET_NO;
        END
        ELSE
        BEGIN
             P_LAST_PALLET_NO = WK_LAST_PALLET_NO;
        END
        UPDATE GRN SET LAST_PALLET_NO = :WK_LAST_PALLET_NO WHERE GRN = :GRN;
        WK_OWNER = '';
        WK_OWNER_PFX = '';
        IF ((WK_GRN_TYPE = 'PO') OR
            (WK_GRN_TYPE = 'RA') OR  
            (WK_GRN_TYPE = 'TR') OR
            (WK_GRN_TYPE = 'WO')) THEN
        BEGIN
           SELECT COMPANY_ID, PO_LEGACY_OWNER_ID 
           FROM PURCHASE_ORDER 
           WHERE PURCHASE_ORDER = :WK_LOADNO
           INTO :WK_OWNER, :WK_OWNER_PFX;
           IF (WK_OWNER_PFX IS NULL) THEN
           BEGIN
              WK_OWNER_PFX = '';
           END
        END
        IF (WK_OWNER IS NULL OR WK_OWNER = '') THEN
        BEGIN
           SELECT OWNER_ID 
           FROM GRN 
           WHERE GRN = :GRN
           INTO :WK_OWNER;
        END
        IF (WK_OWNER_PFX = '') THEN
        BEGIN
           SELECT COMPANY_ID_PREFIX 
           FROM COMPANY 
           WHERE COMPANY_ID = :WK_OWNER 
           INTO :WK_OWNER_PFX;
           IF (WK_OWNER_PFX IS NULL) THEN
           BEGIN
              WK_OWNER_PFX = '';
           END
        END
        LEN_SSN_ID = STRLEN(WK_OWNER_PFX);
      	WHILE (LEN_SSN_ID < 2) DO
        BEGIN
           WK_OWNER_PFX = '0' || WK_OWNER_PFX;
           LEN_SSN_ID = LEN_SSN_ID + 1;
        END
        LEN_SSN_ID = STRLEN(GRN);
        WK_OWNER_GRN = GRN;
      	WHILE (LEN_SSN_ID < 6) DO
        BEGIN
           WK_OWNER_GRN = '0' || WK_OWNER_GRN;
           LEN_SSN_ID = LEN_SSN_ID + 1;
        END
        IF (STRLEN(WK_GRN_LOT) > 0) THEN
        BEGIN
           WK_OWNER_PFX = SUBSTR(WK_GRN_LOT, 1, 2);
           WK_OWNER_GRN = SUBSTR(WK_GRN_LOT, 3, 8);
           P_LAST_LINE_NO = SUBSTR(WK_GRN_LOT, 9, 10);
        END
        W_SSN_ID = WK_OWNER_PFX || WK_OWNER_GRN || P_LAST_LINE_NO || '00';
   END /* if ssn method is 'CMP=2|GRN=6|LINE=2|SFX=2' */
   
   IF (WK_OLD_METHOD = 'Y') THEN
   BEGIN
      WK_PRINTER = 'P' || SUBSTR(SOURCE,5,5);
   END
   ELSE
   BEGIN
      EXECUTE PROCEDURE GET_REFERENCE_FIELD :REFERENCE, 8  RETURNING_VALUES :WK_PRINTER_2 ; 
      IF (STRLEN(WK_PRINTER_2) > 1) THEN
      BEGIN
         WK_PRINTER = WK_PRINTER_2;
      END
      ELSE
      BEGIN
         WK_PRINTER = 'P' || WK_PRINTER_2;
      END
      IF (WK_GRN_TYPE = 'LD') THEN
      BEGIN
         IF (WK_TRN_CODE = 'P') THEN
         BEGIN
            WK_SUPPLIER = '';
            SELECT RETURN_ID
            FROM GRN
            WHERE GRN = :GRN
            INTO :WK_SUPPLIER;
            IF (WK_SUPPLIER IS NULL) THEN
            BEGIN
               WK_SUPPLIER = SUBSTR(OBJECT,1,10);
            END
         END
         ELSE
         BEGIN
            WK_SUPPLIER = SUBSTR(OBJECT,1,10);
         END
         WK_OWNER = SUBSTR(OBJECT,11,20);
         UPDATE GRN 
         SET RETURN_ID = :WK_SUPPLIER
         WHERE GRN = :GRN;
      END
   END
   WK_A_PROD = 0;
   WK_A_PO = 0;
   IF ((WK_GRN_TYPE = 'PO') OR
       (WK_GRN_TYPE = 'RA') OR  
       (WK_GRN_TYPE = 'TR') OR
       (WK_GRN_TYPE = 'WO')) THEN
   BEGIN
       IF (OBJECT <> '') THEN
       BEGIN
           WK_A_PROD = 1;
           WK_PROD_EXISTS = 0;
           WK_A_PO = 1;
           SELECT 1, 
              SHORT_DESC ,
              HOME_LOCN_ID,
              ALTERNATE_ID,
              PALLET_CFG_INNER,
              PALLET_CFG_ALTERNATE,
              ISSUE_UOM,
              ISSUE_PER_ORDER_UNIT,
              ISSUE_PER_INNER_UNIT,
              SPECIAL_INSTR,
              TEMPERATURE_ZONE,
              SSN_TYPE,
              PROD_TYPE
              FROM PROD_PROFILE
              WHERE PROD_ID = :OBJECT
              INTO :WK_PROD_EXISTS, 
              :WK_PROD_DESC,
              :WK_PUTLOCN_1,
              :WK_ALTPROD,
              :WK_STD_PALLET_CFG,
              :WK_NON_PALLET_CFG,
              :WK_ISSUE_UOM,
              :WK_ORDER_UNITS,
              :WK_INNER_UNITS,
              :WK_INSTR,
              :WK_TEMPERATURE_ZONE,
              :WK_SSN_TYPE,
              :WK_PROD_TYPE;
           IF (WK_PROD_EXISTS = 0) THEN
           BEGIN
               /* Insert into prod_profile */
               INSERT INTO PROD_PROFILE (PROD_ID, SHORT_DESC, LAST_UPDATE_DATE)
                   VALUES (:OBJECT, :OBJECT, 'NOW');
               WK_PROD_DESC = OBJECT;
           END
           IF (WK_PUTLOCN_1 IS NULL) THEN
           BEGIN
              WK_PUTLOCN_1 = '';
           END
           SELECT FIRST 1 WH_ID || LOCN_ID
           FROM LOCATION
           WHERE PROD_ID = :OBJECT
           AND :WK_PUTLOCN_1 <> (WH_ID || LOCN_ID)
           INTO :WK_PUTLOCN_2;
           IF (WK_PUTLOCN_2 IS NULL) THEN
           BEGIN
              WK_PUTLOCN_2 = '';
           END
           IF (WK_PUTLOCN_1 = '' AND WK_PUTLOCN_2 <> '') THEN
           BEGIN
              SELECT FIRST 1 WH_ID || LOCN_ID
              FROM LOCATION
              WHERE PROD_ID = :OBJECT
              AND :WK_PUTLOCN_2 <> (WH_ID || LOCN_ID)
              INTO :WK_PUTLOCN_1;
              IF (WK_PUTLOCN_1 IS NULL) THEN
              BEGIN
                 WK_PUTLOCN_1 = '';
              END
           END
           WK_WEIGHT_X = '';
           WK_WEIGHT_UOM = '';
           IF (WK_ALTPROD IS NULL) THEN
           BEGIN
              WK_ALTPROD = '';
           END
           IF (WK_STD_PALLET_CFG IS NULL) THEN
           BEGIN
              WK_STD_PALLET_CFG = '';
           END
           IF (WK_NON_PALLET_CFG IS NULL) THEN
           BEGIN
              WK_NON_PALLET_CFG = '';
           END
           IF (WK_ISSUE_UOM IS NULL) THEN
           BEGIN
              WK_ISSUE_UOM = '';
           END
           IF (WK_INNER_UNITS IS NULL) THEN
           BEGIN
              WK_INNER_UNITS = 1;
           END
           IF (WK_ORDER_UNITS IS NULL) THEN
           BEGIN
              WK_ORDER_UNITS = 1;
           END
           IF (WK_INSTR IS NULL) THEN
           BEGIN
              WK_INSTR = '';
           END
           IF (WK_TEMPERATURE_ZONE IS NULL) THEN
           BEGIN
                WK_TEMPERATURE_ZONE = '';
           END
           SELECT 
              PALLET_CFG_DESCRIPTION,
              TOTAL_CARTONS_LAYER,
              TOTAL_LAYERS
           FROM PALLET_CFG
           WHERE PALLET_CFG_CODE = :WK_STD_PALLET_CFG
           INTO :WK_STD_PALLET_DESC, :WK_STD_PALLET_CARTONS, :WK_STD_PALLET_LAYERS;
           SELECT 
              PALLET_CFG_DESCRIPTION
           FROM PALLET_CFG
           WHERE PALLET_CFG_CODE = :WK_NON_PALLET_CFG
           INTO :WK_NON_PALLET_DESC ;
           IF (WK_STD_PALLET_DESC IS NULL) THEN
           BEGIN
              WK_STD_PALLET_DESC = WK_STD_PALLET_CFG;
           END
           IF (WK_STD_PALLET_CARTONS IS NULL) THEN
           BEGIN
              WK_STD_PALLET_CARTONS = 1;
           END
           IF (WK_STD_PALLET_LAYERS IS NULL) THEN
           BEGIN
              WK_STD_PALLET_LAYERS = 1;
           END
           IF (WK_NON_PALLET_DESC IS NULL) THEN
           BEGIN
              WK_NON_PALLET_DESC = WK_NON_PALLET_CFG;
           END
           WK_TOT_INNER = WK_ORDER_UNITS / WK_INNER_UNITS;
           WK_TOT_OUTER = WK_STD_PALLET_LAYERS * WK_STD_PALLET_CARTONS;
           WK_SSN_CURQTY = LABEL_NO  * WK_LABEL_CURQTY ;
           SELECT COMPANY_ID 
           FROM PURCHASE_ORDER 
           WHERE PURCHASE_ORDER = :WK_LOADNO
           INTO :WK_OWNER;
           IF (WK_OWNER IS NULL) THEN
           BEGIN
              SELECT COMPANY_ID FROM CONTROL INTO :WK_OWNER; 
           END
          /* Insert data into SSN table */   
          SELECT COUNT(*) AS CNT FROM SSN WHERE SSN_ID = :W_SSN_ID INTO :WK_COUNT_SSN;
          IF (WK_COUNT_SSN = 0) THEN
          BEGIN
             IF (WK_SSN_TYPE IS NULL) THEN
             BEGIN
                    INSERT INTO SSN (SSN_ID, WH_ID, LOCN_ID, GRN, STATUS_SSN, LABEL_DATE, ORIGINAL_QTY,
                    CURRENT_QTY, PURCHASE_DATE, PO_ORDER, PO_RECEIVE_DATE, PROD_ID, SSN_DESCRIPTION, PO_LINE, COMPANY_ID, SSN_TYPE, CREATE_DATE, CREATED_BY)
                    VALUES (:W_SSN_ID, :WH_ID, :LOCN_ID, :GRN, :WK_PROD_STATUS, 'NOW', :WK_SSN_CURQTY, :WK_SSN_CURQTY, 'NOW',:WK_LOADNO, 'NOW', :OBJECT,:WK_PROD_DESC,:WK_LOAD_LINE_NO, :WK_OWNER, :WK_PROD_TYPE, :TRANS_DATE, :WK_USER);
             END
             ELSE
             BEGIN
                    INSERT INTO SSN (SSN_ID, WH_ID, LOCN_ID, GRN, STATUS_SSN, LABEL_DATE, ORIGINAL_QTY,
                    CURRENT_QTY, PURCHASE_DATE, PO_ORDER, PO_RECEIVE_DATE, PROD_ID, SSN_DESCRIPTION, PO_LINE, COMPANY_ID, SSN_TYPE, CREATE_DATE, CREATED_BY)
                    VALUES (:W_SSN_ID, :WH_ID, :LOCN_ID, :GRN, :WK_PROD_STATUS, 'NOW', :WK_SSN_CURQTY, :WK_SSN_CURQTY, 'NOW',:WK_LOADNO, 'NOW', :OBJECT,:WK_PROD_DESC,:WK_LOAD_LINE_NO, :WK_OWNER, :WK_SSN_TYPE, :TRANS_DATE, :WK_USER);
             END
          END
          ELSE
          BEGIN
               UPDATE SSN SET ORIGINAL_QTY = ORIGINAL_QTY + :WK_SSN_CURQTY, CURRENT_QTY = CURRENT_QTY + :WK_SSN_CURQTY
               WHERE SSN_ID = :W_SSN_ID;
          END
          W_PRODUCT_SSN_ID = W_SSN_ID;
          WK_REASON = 'Received ' || :WK_SSN_CURQTY || ' by User ' || :WK_USER || ' SSN ' || :W_SSN_ID ;
          EXECUTE PROCEDURE ADD_SSN_HIST(:WH_ID, :LOCN_ID, :W_SSN_ID, 
                          :WK_TRN_TYPE, :WK_TRN_CODE, :TRANS_DATE,
                          :WK_REASON, '' , :WK_SSN_CURQTY, :WK_USER, :WK_DEVICE_ID); 
          UPDATE GRN 
          SET ORDER_NO = :WK_LOADNO,
              ORDER_LINE_NO = :WK_LOAD_LINE_NO
          WHERE GRN = :GRN;
          /* update the po outstanding qty and status */
          WK_PO_FOUND = 0;
          SELECT 1 , PO_LINE_QTY, ORIGINAL_QTY 
          FROM PURCHASE_ORDER_LINE
          WHERE PURCHASE_ORDER = :WK_LOADNO
          AND   PO_LINE = :WK_LOAD_LINE_NO
          INTO :WK_PO_FOUND, :WK_PO_QTY, :WK_PO_ORIG_QTY ;
          IF (WK_PO_FOUND = 1) THEN
          BEGIN
             WK_PO_STATUS = 'OP';
             WK_PO_NEW_QTY = WK_PO_QTY - WK_SSN_CURQTY; 
             IF (WK_PO_NEW_QTY = 0) THEN
             BEGIN
                WK_PO_STATUS = 'CL';
             END
             ELSE
             BEGIN
                IF (WK_PO_NEW_QTY < 0) THEN
                BEGIN
                   WK_PO_STATUS = 'OS';
                END
             END
             IF (WK_PO_ORIG_QTY IS NULL) THEN
             BEGIN
                UPDATE PURCHASE_ORDER_LINE
                SET ORIGINAL_QTY = :WK_PO_QTY,
                    PO_LINE_QTY = :WK_PO_NEW_QTY,
                    PO_LINE_STATUS = :WK_PO_STATUS
                WHERE PURCHASE_ORDER = :WK_LOADNO
                AND   PO_LINE = :WK_LOAD_LINE_NO;
             END
             ELSE
             BEGIN
                UPDATE PURCHASE_ORDER_LINE
                SET PO_LINE_QTY = :WK_PO_NEW_QTY,
                    PO_LINE_STATUS = :WK_PO_STATUS
                WHERE PURCHASE_ORDER = :WK_LOADNO
                AND   PO_LINE = :WK_LOAD_LINE_NO;
             END
          END
      END
   END
             
   /* IF (WK_GRN_TYPE = 'LP') THEN */
   IF (WK_GRN_TYPE = 'IP') THEN
   BEGIN
       IF (OBJECT <> '') THEN
       BEGIN
           WK_A_PROD = 1;
           WK_GRN_OWNER = '';
           SELECT OWNER_ID 
           FROM GRN 
           WHERE GRN = :GRN
           INTO :WK_GRN_OWNER;
           WK_CMP_FROM = '';
           SELECT DESCRIPTION
           FROM OPTIONS
           WHERE GROUP_CODE = 'CMP'
           AND CODE = 'GRNV'
           INTO :WK_CMP_FROM;
           IF (WK_CMP_FROM IS NULL) THEN
           BEGIN
              WK_CMP_FROM = 'PROD';
           END
           WK_PROD_EXISTS = 0;
           SELECT 1, 
              PROD_TYPE, 
              COMPANY_ID, 
              SHORT_DESC ,
              HOME_LOCN_ID,
              ALTERNATE_ID,
              PALLET_CFG_INNER,
              PALLET_CFG_ALTERNATE,
              ISSUE_UOM,
              ISSUE_PER_ORDER_UNIT,
              ISSUE_PER_INNER_UNIT,
              SPECIAL_INSTR,
              TEMPERATURE_ZONE,
              SSN_TYPE
              FROM PROD_PROFILE
              WHERE PROD_ID = :OBJECT
              INTO :WK_PROD_EXISTS, :WK_PROD_TYPE, :WK_OWNER,
              :WK_PROD_DESC,
              :WK_PUTLOCN_1,
              :WK_ALTPROD,
              :WK_STD_PALLET_CFG,
              :WK_NON_PALLET_CFG,
              :WK_ISSUE_UOM,
              :WK_ORDER_UNITS,
              :WK_INNER_UNITS,
              :WK_INSTR,
              :WK_TEMPERATURE_ZONE,
              :WK_SSN_TYPE;
           IF (WK_PROD_EXISTS = 0) THEN
           BEGIN
               /* Insert into prod_profile */
               INSERT INTO PROD_PROFILE (PROD_ID, SHORT_DESC, LAST_UPDATE_DATE)
                   VALUES (:OBJECT, :OBJECT, 'NOW');
               WK_PROD_DESC = OBJECT;
           END
           IF (WK_PUTLOCN_1 IS NULL) THEN
           BEGIN
              WK_PUTLOCN_1 = '';
           END
           SELECT FIRST 1 WH_ID || LOCN_ID
           FROM LOCATION
           WHERE PROD_ID = :OBJECT
           AND :WK_PUTLOCN_1 <> (WH_ID || LOCN_ID)
           INTO :WK_PUTLOCN_2;
           IF (WK_PUTLOCN_2 IS NULL) THEN
           BEGIN
              WK_PUTLOCN_2 = '';
           END
           IF (WK_PUTLOCN_1 = '' AND WK_PUTLOCN_2 <> '') THEN
           BEGIN
              SELECT FIRST 1 WH_ID || LOCN_ID
              FROM LOCATION
              WHERE PROD_ID = :OBJECT
              AND :WK_PUTLOCN_2 <> (WH_ID || LOCN_ID)
              INTO :WK_PUTLOCN_1;
              IF (WK_PUTLOCN_1 IS NULL) THEN
              BEGIN
                 WK_PUTLOCN_1 = '';
              END
           END
           IF (WK_ALTPROD IS NULL) THEN
           BEGIN
              WK_ALTPROD = '';
           END
           WK_WEIGHT_X = '';
           WK_WEIGHT_UOM = '';
           IF (WK_STD_PALLET_CFG IS NULL) THEN
           BEGIN
              WK_STD_PALLET_CFG = '';
           END
           IF (WK_NON_PALLET_CFG IS NULL) THEN
           BEGIN
              WK_NON_PALLET_CFG = '';
           END
           IF (WK_ISSUE_UOM IS NULL) THEN
           BEGIN
              WK_ISSUE_UOM = '';
           END
           IF (WK_INNER_UNITS IS NULL) THEN
           BEGIN
              WK_INNER_UNITS = 1;
           END
           IF (WK_ORDER_UNITS IS NULL) THEN
           BEGIN
              WK_ORDER_UNITS = 1;
           END
           IF (WK_INSTR IS NULL) THEN
           BEGIN
              WK_INSTR = '';
           END
           IF (WK_TEMPERATURE_ZONE IS NULL) THEN
           BEGIN
                WK_TEMPERATURE_ZONE = '';
           END
           SELECT 
              PALLET_CFG_DESCRIPTION,
              TOTAL_CARTONS_LAYER,
              TOTAL_LAYERS
           FROM PALLET_CFG
           WHERE PALLET_CFG_CODE = :WK_STD_PALLET_CFG
           INTO :WK_STD_PALLET_DESC, :WK_STD_PALLET_CARTONS, :WK_STD_PALLET_LAYERS;
           SELECT 
              PALLET_CFG_DESCRIPTION
           FROM PALLET_CFG
           WHERE PALLET_CFG_CODE = :WK_NON_PALLET_CFG
           INTO :WK_NON_PALLET_DESC ;
           IF (WK_STD_PALLET_DESC IS NULL) THEN
           BEGIN
              WK_STD_PALLET_DESC = WK_STD_PALLET_CFG;
           END
           IF (WK_STD_PALLET_CARTONS IS NULL) THEN
           BEGIN
              WK_STD_PALLET_CARTONS = 1;
           END
           IF (WK_STD_PALLET_LAYERS IS NULL) THEN
           BEGIN
              WK_STD_PALLET_LAYERS = 1;
           END
           IF (WK_NON_PALLET_DESC IS NULL) THEN
           BEGIN
              WK_NON_PALLET_DESC = WK_NON_PALLET_CFG;
           END
           WK_TOT_INNER = WK_ORDER_UNITS / WK_INNER_UNITS;
           WK_TOT_OUTER = WK_STD_PALLET_LAYERS * WK_STD_PALLET_CARTONS;
           WK_SSN_CURQTY = LABEL_NO  * WK_LABEL_CURQTY ;
           /* calc loadno, supplier and default company */
           IF (WK_TRN_CODE = 'P') THEN
           BEGIN
              WK_SUPPLIER = '';
              SELECT RETURN_ID
              FROM GRN
              WHERE GRN = :GRN
              INTO :WK_SUPPLIER;
              IF (WK_SUPPLIER IS NULL) THEN
              BEGIN
                 WK_SUPPLIER = WK_LOADNO;
              END
           END
           ELSE
           BEGIN
              WK_SUPPLIER = WK_LOADNO;
           END
           IF (WK_CMP_FROM = 'GRN') THEN
           BEGIN
              WK_OWNER = WK_GRN_OWNER;
           END
           IF (WK_OWNER IS NULL) THEN
           BEGIN
              SELECT COMPANY_ID FROM CONTROL INTO :WK_OWNER; 
           END
           SELECT ORDER_NO FROM GRN WHERE GRN = :GRN INTO :WK_LOADNO;
           UPDATE GRN 
           SET RETURN_ID = :WK_SUPPLIER
           WHERE GRN = :GRN;
          /* Insert data into SSN table */   
          SELECT COUNT(*) AS CNT FROM SSN WHERE SSN_ID = :W_SSN_ID INTO :WK_COUNT_SSN;
          IF (WK_COUNT_SSN = 0) THEN
          BEGIN
             IF (WK_SSN_TYPE IS NULL) THEN
             BEGIN
                    INSERT INTO SSN (SSN_ID, WH_ID, LOCN_ID, GRN, STATUS_SSN, LABEL_DATE, ORIGINAL_QTY,
                    CURRENT_QTY, PO_ORDER, PO_RECEIVE_DATE, PROD_ID, SSN_DESCRIPTION, PO_LINE, SUPPLIER_ID, COMPANY_ID, SSN_TYPE, CREATE_DATE, CREATED_BY)
                    VALUES (:W_SSN_ID, :WH_ID, :LOCN_ID, :GRN, :WK_PROD_STATUS, 'NOW', :WK_SSN_CURQTY, :WK_SSN_CURQTY, :WK_LOADNO, 'NOW', :OBJECT,:WK_PROD_DESC,:WK_LOAD_LINE_NO, :WK_SUPPLIER, :WK_OWNER, :WK_PROD_TYPE, :TRANS_DATE, :WK_USER);
             END
             ELSE
             BEGIN
                    INSERT INTO SSN (SSN_ID, WH_ID, LOCN_ID, GRN, STATUS_SSN, LABEL_DATE, ORIGINAL_QTY,
                    CURRENT_QTY, PO_ORDER, PO_RECEIVE_DATE, PROD_ID, SSN_DESCRIPTION, PO_LINE, SUPPLIER_ID, COMPANY_ID, SSN_TYPE, CREATE_DATE, CREATED_BY)
                    VALUES (:W_SSN_ID, :WH_ID, :LOCN_ID, :GRN, :WK_PROD_STATUS, 'NOW', :WK_SSN_CURQTY, :WK_SSN_CURQTY, :WK_LOADNO, 'NOW', :OBJECT,:WK_PROD_DESC,:WK_LOAD_LINE_NO, :WK_SUPPLIER, :WK_OWNER, :WK_SSN_TYPE, :TRANS_DATE, :WK_USER);
             END
          END
          ELSE
          BEGIN
               UPDATE SSN SET ORIGINAL_QTY = ORIGINAL_QTY + :WK_SSN_CURQTY, CURRENT_QTY = CURRENT_QTY + :WK_SSN_CURQTY
               WHERE SSN_ID = :W_SSN_ID;
          END
          W_PRODUCT_SSN_ID = W_SSN_ID;
          WK_REASON = 'Received ' || :WK_SSN_CURQTY || ' by User ' || :WK_USER || ' SSN ' || :W_SSN_ID ;
          EXECUTE PROCEDURE ADD_SSN_HIST(:WH_ID, :LOCN_ID, :W_SSN_ID, 
                          :WK_TRN_TYPE, :WK_TRN_CODE, :TRANS_DATE,
                          :WK_REASON, '' , :WK_SSN_CURQTY, :WK_USER, :WK_DEVICE_ID); 
      END
   END
             
   /* Insert data into ISSN table */
   IF ((WK_GENERATE_SSN_METHOD IS NULL) OR ((WK_GENERATE_SSN_METHOD <> '|GRN=4|LINE=2|SUFFIX=2,3|') AND 
    (WK_GENERATE_SSN_METHOD <> 'CMP=2|GRN=6|LINE=2|SFX=2' ))) THEN
   BEGIN
        WHILE (P_SSN_ID < SSN_ID) DO
        BEGIN
          I_SSN_ID = '';
          I_LEN_SSN_ID = STRLEN(P_SSN_ID);
      
          WHILE (I_LEN_SSN_ID < :SSN_LENGTH) DO
          BEGIN
           I_SSN_ID = I_SSN_ID || '0';
           I_LEN_SSN_ID = I_LEN_SSN_ID + 1;
          END
          I_SSN_ID = I_SSN_ID || P_SSN_ID;
          /* 170707 1st issn */
          IF (WK_1ST_ISSN = '') THEN
          BEGIN
             WK_1ST_ISSN = I_SSN_ID;
          END
          IF (WK_A_PROD = 0) THEN
          BEGIN
         /* Insert data into SSN table */   
          INSERT INTO SSN (SSN_ID, WH_ID, LOCN_ID, GRN, STATUS_SSN, LABEL_DATE, ORIGINAL_QTY,
                    CURRENT_QTY, PO_ORDER, PO_RECEIVE_DATE, PO_LINE, SUPPLIER_ID, COMPANY_ID, CREATE_DATE, CREATED_BY)
          VALUES (:I_SSN_ID, :WH_ID, :LOCN_ID, :GRN, :WK_STATUS, 'NOW', :WK_LABEL_CURQTY, :WK_LABEL_CURQTY, :WK_LOADNO, 'NOW',:WK_LOAD_LINE_NO,:WK_SUPPLIER, :WK_OWNER, :TRANS_DATE, :WK_USER);
          INSERT INTO ISSN (SSN_ID, ORIGINAL_SSN, WH_ID, LOCN_ID, CURRENT_QTY,ISSN_STATUS, LABEL_DATE, COMPANY_ID, ORIGINAL_QTY, CREATE_DATE, USER_ID, INTO_DATE)
          VALUES (:I_SSN_ID, :I_SSN_ID, :WH_ID, :LOCN_ID, :WK_LABEL_CURQTY, :WK_STATUS, :TRANS_DATE, :WK_OWNER, :WK_LABEL_CURQTY, :TRANS_DATE, :WK_USER, :TRANS_DATE);
         END
         IF (WK_A_PROD = 1) THEN
         BEGIN
           INSERT INTO ISSN (SSN_ID, ORIGINAL_SSN, WH_ID, LOCN_ID, CURRENT_QTY,ISSN_STATUS, PROD_ID, LABEL_DATE, COMPANY_ID, ORIGINAL_QTY, CREATE_DATE,USER_ID, INTO_DATE)
           VALUES (:I_SSN_ID, :W_SSN_ID, :WH_ID, :LOCN_ID, :WK_LABEL_CURQTY, :WK_PROD_STATUS, :OBJECT, 'NOW', :WK_OWNER, :WK_LABEL_CURQTY, :TRANS_DATE, :WK_USER, :TRANS_DATE );
         END
      
         P_SSN_ID = P_SSN_ID + 1;
    END /* THIS IS WHERE GENERATION OF ISSN AND SSN ENDS WHEN P_SSN_ID < SSN_ID */
   END /* IF NOT OF TYPE |GRN=4|LINE=2|SUFFIX=2,3| */
   
   IF (WK_GENERATE_SSN_METHOD = '|GRN=4|LINE=2|SUFFIX=2,3|' ) THEN
   BEGIN
        I_PALLET_NO = 0;
        WHILE (I_PALLET_NO < LABEL_NO) DO
        BEGIN
           SELECT LAST_PALLET_NO FROM GRN WHERE GRN = :GRN INTO :WK_LAST_PALLET_NO;
           WK_LAST_PALLET_NO = WK_LAST_PALLET_NO + 1;
           UPDATE GRN SET LAST_PALLET_NO = :WK_LAST_PALLET_NO WHERE GRN = :GRN;
           IF (WK_LAST_PALLET_NO < 10) THEN
           BEGIN
              P_LAST_PALLET_NO = '0' || WK_LAST_PALLET_NO;
           END
           ELSE
           BEGIN
             P_LAST_PALLET_NO = WK_LAST_PALLET_NO;
           END
          I_SSN_ID = GRN || P_LAST_LINE_NO || P_LAST_PALLET_NO;
          IF (WK_1ST_ISSN = '') THEN
          BEGIN
             WK_1ST_ISSN = I_SSN_ID;
          END
          IF (WK_A_PROD = 0) THEN /* IF LD */
          BEGIN
         /* Insert data into SSN table */
          INSERT INTO SSN (SSN_ID, WH_ID, LOCN_ID, GRN, STATUS_SSN, LABEL_DATE, ORIGINAL_QTY,
                    CURRENT_QTY, PO_ORDER, PO_RECEIVE_DATE, PO_LINE, SUPPLIER_ID, COMPANY_ID, CREATE_DATE, CREATED_BY)
          VALUES (:I_SSN_ID, :WH_ID, :LOCN_ID, :GRN, :WK_STATUS, 'NOW', :WK_LABEL_CURQTY, :WK_LABEL_CURQTY, :WK_LOADNO, 'NOW',:WK_LOAD_LINE_NO,:WK_SUPPLIER, :WK_OWNER, :TRANS_DATE, :WK_USER);
          INSERT INTO ISSN (SSN_ID, ORIGINAL_SSN, WH_ID, LOCN_ID, CURRENT_QTY,ISSN_STATUS, LABEL_DATE, COMPANY_ID, ORIGINAL_QTY, CREATE_DATE, USER_ID, INTO_DATE)
          VALUES (:I_SSN_ID, :I_SSN_ID, :WH_ID, :LOCN_ID, :WK_LABEL_CURQTY, :WK_STATUS, :TRANS_DATE, :WK_OWNER, :WK_LABEL_CURQTY, :TRANS_DATE, :WK_USER, :TRANS_DATE);
         END
         IF (WK_A_PROD = 1) THEN /* IF <> LD */
         BEGIN
           INSERT INTO ISSN (SSN_ID, ORIGINAL_SSN, WH_ID, LOCN_ID, CURRENT_QTY,ISSN_STATUS, PROD_ID, LABEL_DATE, COMPANY_ID, ORIGINAL_QTY, CREATE_DATE,USER_ID, INTO_DATE)
           VALUES (:I_SSN_ID, :W_SSN_ID, :WH_ID, :LOCN_ID, :WK_LABEL_CURQTY, :WK_PROD_STATUS, :OBJECT, 'NOW', :WK_OWNER, :WK_LABEL_CURQTY, :TRANS_DATE, :WK_USER, :TRANS_DATE );
         END
         I_PALLET_NO = I_PALLET_NO + 1;
        END /* WHILE I_PALLETNO < LABEL_NO */
   END /* if ssn method is |GRN=4|LINE=2|SUFFIX=2,3| */
   IF (WK_GENERATE_SSN_METHOD = 'CMP=2|GRN=6|LINE=2|SFX=2' ) THEN
   BEGIN
        I_PALLET_NO = 0;
        WHILE (I_PALLET_NO < LABEL_NO) DO
        BEGIN
           /* DURING UPDATES THIS UPDATE WILL BE WITHIN A SESSION. THERE IS A MINOR CHANCE OF TWO PALLETS HAVING THE SAME NUMBER AS THIS CHANGE CANNOT BE COMMITTED IN A TRIGGER */
           SELECT LAST_PALLET_NO FROM GRN WHERE GRN = :GRN INTO :WK_LAST_PALLET_NO;
           IF (STRLEN(WK_GRN_LOT) > 0) THEN
           BEGIN
              WK_LAST_LOT_PALLET_NO = 0;
              /* SELECT MAX(LAST_PALLET_NO) FROM GRN WHERE LAST_LOT_NO = :WK_GRN_LOT INTO :WK_LAST_LOT_PALLET_NO; */
              SELECT MAX(LAST_PALLET_NO) FROM GRN WHERE LAST_LOT_NO STARTING SUBSTR(:WK_GRN_LOT,1,8) INTO :WK_LAST_LOT_PALLET_NO;
              IF (WK_LAST_LOT_PALLET_NO IS NULL) THEN
              BEGIN
                 WK_LAST_LOT_PALLET_NO = WK_LAST_PALLET_NO;
              END
              IF (WK_LAST_LOT_PALLET_NO > WK_LAST_PALLET_NO) THEN
              BEGIN
                 WK_LAST_PALLET_NO = WK_LAST_LOT_PALLET_NO;
              END
           END
           WK_LAST_PALLET_NO = WK_LAST_PALLET_NO + 1;
           UPDATE GRN SET LAST_PALLET_NO = :WK_LAST_PALLET_NO WHERE GRN = :GRN;
           IF (WK_LAST_PALLET_NO < 10) THEN
           BEGIN
              P_LAST_PALLET_NO = '0' || WK_LAST_PALLET_NO;
           END
           ELSE
           BEGIN
             P_LAST_PALLET_NO = WK_LAST_PALLET_NO;
           END
        /* tHE FIRST TIME THE LAST_PALLET_NO IS ALWAYS 0 */
          I_SSN_ID = WK_OWNER_PFX || WK_OWNER_GRN || P_LAST_LINE_NO || P_LAST_PALLET_NO;
          IF (WK_1ST_ISSN = '') THEN
          BEGIN
             WK_1ST_ISSN = I_SSN_ID;
          END
          IF (WK_A_PROD = 0) THEN /* IF LD */
          BEGIN
         /* Insert data into SSN table */
          INSERT INTO SSN (SSN_ID, WH_ID, LOCN_ID, GRN, STATUS_SSN, LABEL_DATE, ORIGINAL_QTY,
                    CURRENT_QTY, PO_ORDER, PO_RECEIVE_DATE, PO_LINE, SUPPLIER_ID, COMPANY_ID, CREATE_DATE, CREATED_BY)
          VALUES (:I_SSN_ID, :WH_ID, :LOCN_ID, :GRN, :WK_STATUS, 'NOW', :WK_LABEL_CURQTY, :WK_LABEL_CURQTY, :WK_LOADNO, 'NOW',:WK_LOAD_LINE_NO,:WK_SUPPLIER, :WK_OWNER, :TRANS_DATE, :WK_USER);
          INSERT INTO ISSN (SSN_ID, ORIGINAL_SSN, WH_ID, LOCN_ID, CURRENT_QTY,ISSN_STATUS, LABEL_DATE, COMPANY_ID, ORIGINAL_QTY, CREATE_DATE, USER_ID, INTO_DATE)
          VALUES (:I_SSN_ID, :I_SSN_ID, :WH_ID, :LOCN_ID, :WK_LABEL_CURQTY, :WK_STATUS, :TRANS_DATE, :WK_OWNER, :WK_LABEL_CURQTY, :TRANS_DATE, :WK_USER, :TRANS_DATE);
         END
         IF (WK_A_PROD = 1) THEN /* IF <> LD */
         BEGIN
           INSERT INTO ISSN (SSN_ID, ORIGINAL_SSN, WH_ID, LOCN_ID, CURRENT_QTY,ISSN_STATUS, PROD_ID, LABEL_DATE, COMPANY_ID, ORIGINAL_QTY, CREATE_DATE,USER_ID, INTO_DATE)
           VALUES (:I_SSN_ID, :W_SSN_ID, :WH_ID, :LOCN_ID, :WK_LABEL_CURQTY, :WK_PROD_STATUS, :OBJECT, 'NOW', :WK_OWNER, :WK_LABEL_CURQTY, :TRANS_DATE, :WK_USER, :TRANS_DATE );
         END
         I_PALLET_NO = I_PALLET_NO + 1;
        END /* WHILE I_PALLETNO < LABEL_NO */
   END /* if ssn method is 'CMP=2|GRN=6|LINE=2|SFX=2' */
   WK_RESPONSE_TXT = WK_RESPONSE_TXT || :WK_1ST_ISSN || '|' || :WK_SSNQTY1 || '|' || :WK_LABELQTY1 || '|';   
   WK_RESPONSE_TXT1 = :WK_1ST_ISSN || '|' || :WK_SSNQTY1 || '|' || :WK_LABELQTY1 ;
   WK_SAVED_ISSN = WK_1ST_ISSN;
IF (WK_GENERATE_LABEL_TEXT = 'T') THEN
BEGIN
   /* need the directory for this label set */
   SELECT WORKING_DIRECTORY FROM SYS_EQUIP 
       WHERE DEVICE_ID = :WK_PRINTER
       INTO :WK_DIRECTORY;
   IF (WK_A_PROD = 0) THEN
   BEGIN
      WK_FILENAME = WK_DIRECTORY || 'LOAD.1xt';
      WK_LABEL_LINE = '"' || W_SSN_ID || '","' ||
          WK_LOADNO || '","' ||
          LABEL_NO || '"';
      WK_HAVE_FILE_1 = 1;
      WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE);
      IF (WK_RESULT <> 0) THEN
      BEGIN
         WK_FILENAME = WK_DIRECTORY || 'LOAD.2xt';
         WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE);
         WK_HAVE_FILE_1 = -1;
      END
      
   END
   IF (WK_A_PROD = 1) THEN
   BEGIN
      /* must get products desc  */
      WK_DATE = MER_DAY(TRANS_DATE) || '/' || MER_MONTH(TRANS_DATE) || '/' || SUBSTR(CAST(MER_YEAR(TRANS_DATE) AS CHAR(4)) , 3,4);
      WK_TIME = MER_HOUR(TRANS_DATE) || ':' || MER_MINUTE(TRANS_DATE) ;
      WK_DATE = WK_DATE || ' ' || WK_TIME;
      WK_FILENAME = WK_DIRECTORY || 'Product.1xt';
      WK_HAVE_FILE_1 = 1;
      IF (WK_A_PO = 0) THEN
      BEGIN
         WK_LABEL_LINE = '"' || W_SSN_ID || '","' || 
             WK_LABELQTY1 || '","' || 
             OBJECT || '","' || 
             WK_PROD_DESC || '","' || 
             WK_DATE || '","' || 
             WK_SSNQTY1 || '","' || 
             WK_WEIGHT_X || '","' ||
             WK_WEIGHT_UOM || '","' ||
             WK_PUTLOCN_1 || '","' ||
             WK_PUTLOCN_2 || '","' ||
             WK_LOADNO || '","' ||
             GRN || '","' ||
             W_PRODUCT_SSN_ID || '","' ||
             WK_ALTPROD || '","' ||
             WK_STD_PALLET_DESC || '","' ||
             WK_NON_PALLET_DESC || '","' ||
             WK_ISSUE_UOM || '","' ||
             WK_TOT_INNER || '","' ||
             WK_TOT_OUTER || '","' ||
             WK_INSTR || '","' ||
             WK_PRINTER  || '","' ||
             WK_TEMPERATURE_ZONE || '"'  ;
      END
      ELSE
      BEGIN
         WK_LABEL_LINE = '"' || W_SSN_ID || '","' || 
             WK_LABELQTY1 || '","' || 
             OBJECT || '","' || 
             WK_PROD_DESC || '","' || 
             WK_DATE || '","' || 
             WK_SSNQTY1 || '","' ||
             WK_WEIGHT_X || '","' ||
             WK_WEIGHT_UOM || '","' ||
             WK_PUTLOCN_1 || '","' ||
             WK_PUTLOCN_2 || '","' ||
             WK_LOADNO || '","' ||
             GRN || '","' ||
             W_PRODUCT_SSN_ID || '","' ||
             WK_ALTPROD || '","' ||
             WK_STD_PALLET_DESC || '","' ||
             WK_NON_PALLET_DESC || '","' ||
             WK_ISSUE_UOM || '","' ||
              WK_TOT_INNER || '","' ||
             WK_TOT_OUTER || '","' ||
             WK_INSTR || '","' ||
             WK_PRINTER || '","' ||
             WK_TEMPERATURE_ZONE || '"' ;
      END
      WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE);
      IF (WK_RESULT <> 0) THEN
      BEGIN
         WK_FILENAME = WK_DIRECTORY || 'Product.2xt';
         WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE);
         WK_HAVE_FILE_1 = -1;
      END
   END
END /* LABEL TEXT FILES ONLY IF GENERATE_LABEL_TEXT = 'T' */
   /* EXECUTE PROCEDURE GET_REFERENCE_FIELD :REFERENCE, 6  RETURNING_VALUES :WK_SSNQTY2 ;  */
   /* EXECUTE PROCEDURE GET_REFERENCE_FIELD :REFERENCE, 7  RETURNING_VALUES :WK_LABELQTY2 ; */
   LABEL_NO = CAST(WK_SSNQTY2 AS INTEGER);
   WK_LABEL_CURQTY = CAST(WK_LABELQTY2 AS INTEGER);
   WK_1ST_ISSN = '';
   IF ((LABEL_NO * WK_LABEL_CURQTY) > 0) THEN
   BEGIN
   IF ((WK_GENERATE_SSN_METHOD IS NULL) OR ((WK_GENERATE_SSN_METHOD <> '|GRN=4|LINE=2|SUFFIX=2,3|') AND 
    (WK_GENERATE_SSN_METHOD <> 'CMP=2|GRN=6|LINE=2|SFX=2' ))) THEN
   BEGIN
      SSN_ID = GEN_ID(ISSN_SSN_ID, :LABEL_NO);
      P_SSN_ID = SSN_ID - :LABEL_NO;
      LEN_SSN_ID = STRLEN(P_SSN_ID);     
            
      W_SSN_ID = '';
      /* Padding leading with 0 */
      WHILE (LEN_SSN_ID < :SSN_LENGTH) DO
      BEGIN
         W_SSN_ID = W_SSN_ID || '0';      
         LEN_SSN_ID = LEN_SSN_ID + 1;
      END
      W_SSN_ID = W_SSN_ID || P_SSN_ID;
   END
   
   IF (WK_GENERATE_SSN_METHOD = '|GRN=4|LINE=2|SUFFIX=2,3|' ) THEN
   BEGIN
        SELECT LAST_LINE_NO, LAST_PALLET_NO FROM GRN WHERE GRN = :GRN INTO :WK_LAST_LINE_NO, :WK_LAST_PALLET_NO;
        IF (:WK_LAST_LINE_NO IS NULL) THEN
        BEGIN
               /* i AM UNSURE ABOUT THIS AS LINE NUMBER ACCORDING TO ME SHOULD NOT BE INCREMENTED.S */
              WK_LAST_LINE_NO = 0;
        END
        IF (WK_LOAD_LINE_NO = '') THEN
        BEGIN
             WK_LAST_LINE_NO = WK_LAST_LINE_NO; /* no increment of the line no */
             UPDATE GRN SET LAST_LINE_NO = :WK_LAST_LINE_NO WHERE GRN = :GRN;
        END
        ELSE
        BEGIN
             WK_LAST_LINE_NO = WK_LOAD_LINE_NO;
        END
        IF (WK_LAST_LINE_NO < 10) THEN
        BEGIN
             P_LAST_LINE_NO = '0' || WK_LAST_LINE_NO;
        END
        ELSE
        BEGIN
             P_LAST_LINE_NO = WK_LAST_LINE_NO;
        END
        IF (WK_LAST_PALLET_NO IS NULL) THEN
        BEGIN
             WK_LAST_PALLET_NO = 0;
        END
        IF (WK_LAST_PALLET_NO < 10) THEN
        BEGIN
             P_LAST_PALLET_NO = '0' || WK_LAST_PALLET_NO;
        END
        ELSE
        BEGIN
             P_LAST_PALLET_NO = WK_LAST_PALLET_NO;
        END
        UPDATE GRN SET LAST_PALLET_NO = :WK_LAST_PALLET_NO WHERE GRN = :GRN;
        /* tHE FIRST TIME THE LAST_PALLET_NO IS ALWAYS 0 */
        W_SSN_ID = GRN || P_LAST_LINE_NO || '00';
   END /* if ssn method is |GRN=4|LINE=2|SUFFIX=2,3| */
   IF (WK_GENERATE_SSN_METHOD = 'CMP=2|GRN=6|LINE=2|SFX=2' ) THEN
   BEGIN
        SELECT LAST_LINE_NO, LAST_PALLET_NO, LAST_LOT_NO FROM GRN WHERE GRN = :GRN INTO :WK_LAST_LINE_NO, :WK_LAST_PALLET_NO, :WK_GRN_LOT;
        IF (:WK_LAST_LINE_NO IS NULL) THEN
        BEGIN
              WK_LAST_LINE_NO = 0;
        END
        IF (WK_LOAD_LINE_NO = '') THEN
        BEGIN
             WK_LAST_LINE_NO = WK_LAST_LINE_NO; /* no increment of the line no */
             UPDATE GRN SET LAST_LINE_NO = :WK_LAST_LINE_NO WHERE GRN = :GRN;
        END
        ELSE
        BEGIN
        /* THE LAST LINE NUMBER HAS BEEN PASSED FROM THE FRONT END SCREEN. NO UPDATE TO GRN REQUIRED. */
             WK_LAST_LINE_NO = WK_LOAD_LINE_NO;
        END
        IF (WK_LAST_LINE_NO < 10) THEN
        BEGIN
             P_LAST_LINE_NO = '0' || WK_LAST_LINE_NO;
        END
        ELSE
        BEGIN
             P_LAST_LINE_NO = WK_LAST_LINE_NO;
        END
        IF (WK_LAST_PALLET_NO IS NULL) THEN
        BEGIN
             WK_LAST_PALLET_NO = 0;
        END
        IF (WK_LAST_PALLET_NO < 10) THEN
        BEGIN
             P_LAST_PALLET_NO = '0' || WK_LAST_PALLET_NO;
        END
        ELSE
        BEGIN
             P_LAST_PALLET_NO = WK_LAST_PALLET_NO;
        END
        IF (:WK_GRN_LOT IS NULL) THEN
        BEGIN
              WK_GRN_LOT = '';
        END
        UPDATE GRN SET LAST_PALLET_NO = :WK_LAST_PALLET_NO WHERE GRN = :GRN;
        /* tHE FIRST TIME THE LAST_PALLET_NO IS ALWAYS 0 */
        IF (STRLEN(WK_GRN_LOT) > 0) THEN
        BEGIN
           WK_OWNER_PFX = SUBSTR(WK_GRN_LOT, 1, 2);
           WK_OWNER_GRN = SUBSTR(WK_GRN_LOT, 3, 8);
           P_LAST_LINE_NO = SUBSTR(WK_GRN_LOT, 9, 10);
        END
        W_SSN_ID = WK_OWNER_PFX || WK_OWNER_GRN || P_LAST_LINE_NO || '00';
   END /* if ssn method is 'CMP=2|GRN=6|LINE=2|SFX=2' */
      IF (WK_A_PROD = 1) THEN
      BEGIN
           WK_SSN_CURQTY = LABEL_NO  * WK_LABEL_CURQTY ;
          /* Insert data into SSN table */   
            UPDATE SSN SET CURRENT_QTY = CURRENT_QTY + :WK_SSN_CURQTY, ORIGINAL_QTY = ORIGINAL_QTY + :WK_SSN_CURQTY WHERE SSN_ID = :W_PRODUCT_SSN_ID ; 
            WK_REASON = 'Received ' || :WK_SSN_CURQTY || ' by User ' || :WK_USER || ' SSN ' || :W_PRODUCT_SSN_ID ;
            EXECUTE PROCEDURE ADD_SSN_HIST(:WH_ID, :LOCN_ID, :W_PRODUCT_SSN_ID, 
                          :WK_TRN_TYPE, :WK_TRN_CODE, :TRANS_DATE,
                          :WK_REASON, '' , :WK_SSN_CURQTY, :WK_USER, :WK_DEVICE_ID); 
         IF ((WK_GRN_TYPE = 'PO') OR
             (WK_GRN_TYPE = 'RA') OR  
             (WK_GRN_TYPE = 'TR') OR
             (WK_GRN_TYPE = 'WO')) THEN
         BEGIN
          /* update the po outstanding qty and status */
          WK_PO_QTY = WK_PO_NEW_QTY;
          IF (WK_PO_FOUND = 1) THEN
          BEGIN
             WK_PO_NEW_QTY = WK_PO_QTY - WK_SSN_CURQTY; 
             IF (WK_PO_NEW_QTY = 0) THEN
             BEGIN
                WK_PO_STATUS = 'CL';
             END
             ELSE
             BEGIN
                IF (WK_PO_NEW_QTY < 0) THEN
                BEGIN
                   WK_PO_STATUS = 'OS';
                END
             END
             UPDATE PURCHASE_ORDER_LINE
             SET PO_LINE_QTY = :WK_PO_NEW_QTY,
                 PO_LINE_STATUS = :WK_PO_STATUS
             WHERE PURCHASE_ORDER = :WK_LOADNO
             AND   PO_LINE = :WK_LOAD_LINE_NO;
          END
         END
      END
      
      /* Insert data into ISSN table */
   IF ((WK_GENERATE_SSN_METHOD IS NULL) OR ((WK_GENERATE_SSN_METHOD <> '|GRN=4|LINE=2|SUFFIX=2,3|') AND 
    (WK_GENERATE_SSN_METHOD <> 'CMP=2|GRN=6|LINE=2|SFX=2' ))) THEN
   BEGIN
      WHILE (P_SSN_ID < SSN_ID) DO
      BEGIN
         I_SSN_ID = '';
         I_LEN_SSN_ID = STRLEN(P_SSN_ID);
         
         /* Padding leading with 0 */
         WHILE (I_LEN_SSN_ID < :SSN_LENGTH) DO
         BEGIN
          I_SSN_ID = I_SSN_ID || '0';
          I_LEN_SSN_ID = I_LEN_SSN_ID + 1;
         END
         I_SSN_ID = I_SSN_ID || P_SSN_ID;
         IF (WK_1ST_ISSN = '') THEN
         BEGIN
            WK_1ST_ISSN = I_SSN_ID;
         END
         
         IF (WK_A_PROD = 0) THEN
         BEGIN
            /* Insert data into SSN table */   
            INSERT INTO SSN (SSN_ID, WH_ID, LOCN_ID, GRN, STATUS_SSN, LABEL_DATE, ORIGINAL_QTY,
                    CURRENT_QTY, PO_ORDER, PO_RECEIVE_DATE, PO_LINE, SUPPLIER_ID, COMPANY_ID, CREATE_DATE, CREATED_BY)
            VALUES (:I_SSN_ID, :WH_ID, :LOCN_ID, :GRN, :WK_STATUS, 'NOW', :WK_LABEL_CURQTY, :WK_LABEL_CURQTY, :WK_LOADNO, 'NOW', :WK_LOAD_LINE_NO, :WK_SUPPLIER, :WK_OWNER, :TRANS_DATE, :WK_USER);     
            INSERT INTO ISSN (SSN_ID, ORIGINAL_SSN, WH_ID, LOCN_ID, CURRENT_QTY, ISSN_STATUS, LABEL_DATE, COMPANY_ID, ORIGINAL_QTY, CREATE_DATE, USER_ID, INTO_DATE)
            VALUES (:I_SSN_ID, :I_SSN_ID, :WH_ID, :LOCN_ID, :WK_LABEL_CURQTY, :WK_STATUS, 'NOW', :WK_OWNER, :WK_LABEL_CURQTY, :TRANS_DATE, :WK_USER, :TRANS_DATE); 
         END
         IF (WK_A_PROD = 1) THEN
         BEGIN
            INSERT INTO ISSN (SSN_ID, ORIGINAL_SSN, WH_ID, LOCN_ID, CURRENT_QTY, ISSN_STATUS, PROD_ID, LABEL_DATE, COMPANY_ID, ORIGINAL_QTY, CREATE_DATE, USER_ID, INTO_DATE)
            VALUES (:I_SSN_ID, :W_PRODUCT_SSN_ID, :WH_ID, :LOCN_ID, :WK_LABEL_CURQTY, :WK_PROD_STATUS, :OBJECT, 'NOW', :WK_OWNER, :WK_LABEL_CURQTY, :TRANS_DATE, :WK_USER, :TRANS_DATE); 
         END
      
         P_SSN_ID = P_SSN_ID + 1;
         END
      END /* IF SSN_METHOD */
   IF (WK_GENERATE_SSN_METHOD = '|GRN=4|LINE=2|SUFFIX=2,3|' ) THEN
   BEGIN
        I_PALLET_NO = 0;
        WHILE (I_PALLET_NO < LABEL_NO) DO
        BEGIN
           SELECT LAST_PALLET_NO FROM GRN WHERE GRN = :GRN INTO :WK_LAST_PALLET_NO;
           WK_LAST_PALLET_NO = WK_LAST_PALLET_NO + 1;
           UPDATE GRN SET LAST_PALLET_NO = :WK_LAST_PALLET_NO WHERE GRN = :GRN;
           IF (WK_LAST_PALLET_NO < 10) THEN
           BEGIN
              P_LAST_PALLET_NO = '0' || WK_LAST_PALLET_NO;
           END
           ELSE
           BEGIN
             P_LAST_PALLET_NO = WK_LAST_PALLET_NO;
           END
        /* tHE FIRST TIME THE LAST_PALLET_NO IS ALWAYS 0 */
          I_SSN_ID = GRN || P_LAST_LINE_NO || P_LAST_PALLET_NO;
          IF (WK_1ST_ISSN = '') THEN
          BEGIN
             WK_1ST_ISSN = I_SSN_ID;
          END
         IF (WK_A_PROD = 0) THEN
         BEGIN
            /* Insert data into SSN table */
            INSERT INTO SSN (SSN_ID, WH_ID, LOCN_ID, GRN, STATUS_SSN, LABEL_DATE, ORIGINAL_QTY,
                    CURRENT_QTY, PO_ORDER, PO_RECEIVE_DATE, PO_LINE, SUPPLIER_ID, COMPANY_ID, CREATE_DATE, CREATED_BY)
            VALUES (:I_SSN_ID, :WH_ID, :LOCN_ID, :GRN, :WK_STATUS, 'NOW', :WK_LABEL_CURQTY, :WK_LABEL_CURQTY, :WK_LOADNO, 'NOW', :WK_LOAD_LINE_NO, :WK_SUPPLIER, :WK_OWNER, :TRANS_DATE, :WK_USER);
            INSERT INTO ISSN (SSN_ID, ORIGINAL_SSN, WH_ID, LOCN_ID, CURRENT_QTY, ISSN_STATUS, LABEL_DATE, COMPANY_ID, ORIGINAL_QTY, CREATE_DATE, USER_ID, INTO_DATE)
            VALUES (:I_SSN_ID, :I_SSN_ID, :WH_ID, :LOCN_ID, :WK_LABEL_CURQTY, :WK_STATUS, 'NOW', :WK_OWNER, :WK_LABEL_CURQTY, :TRANS_DATE, :WK_USER, :TRANS_DATE);
         END
         IF (WK_A_PROD = 1) THEN
         BEGIN
            INSERT INTO ISSN (SSN_ID, ORIGINAL_SSN, WH_ID, LOCN_ID, CURRENT_QTY, ISSN_STATUS, PROD_ID, LABEL_DATE, COMPANY_ID, ORIGINAL_QTY, CREATE_DATE, USER_ID, INTO_DATE)
            VALUES (:I_SSN_ID, :W_PRODUCT_SSN_ID, :WH_ID, :LOCN_ID, :WK_LABEL_CURQTY, :WK_PROD_STATUS, :OBJECT, 'NOW', :WK_OWNER, :WK_LABEL_CURQTY, :TRANS_DATE, :WK_USER, :TRANS_DATE);
         END
         I_PALLET_NO = I_PALLET_NO + 1;
        END /* WHILE I_PALLETNO < LABEL_NO */
   END /* if ssn method is |GRN=4|LINE=2|SUFFIX=2,3| */
   IF (WK_GENERATE_SSN_METHOD = 'CMP=2|GRN=6|LINE=2|SFX=2' ) THEN
   BEGIN
        I_PALLET_NO = 0;
        WHILE (I_PALLET_NO < LABEL_NO) DO
        BEGIN
           /* DURING UPDATES THIS UPDATE WILL BE WITHIN A SESSION. THERE IS A MINOR CHANCE OF TWO PALLETS HAVING THE SAME NUMBER AS THIS CHANGE CANNOT BE COMMITTED IN A TRIGGER */
           SELECT LAST_PALLET_NO FROM GRN WHERE GRN = :GRN INTO :WK_LAST_PALLET_NO;
           IF (STRLEN(WK_GRN_LOT) > 0) THEN
           BEGIN
              WK_LAST_LOT_PALLET_NO = 0;
              /* SELECT MAX(LAST_PALLET_NO) FROM GRN WHERE LAST_LOT_NO = :WK_GRN_LOT INTO :WK_LAST_LOT_PALLET_NO; */
              SELECT MAX(LAST_PALLET_NO) FROM GRN WHERE LAST_LOT_NO STARTING SUBSTR(:WK_GRN_LOT,1,8) INTO :WK_LAST_LOT_PALLET_NO;
              IF (WK_LAST_LOT_PALLET_NO IS NULL) THEN
              BEGIN
                 WK_LAST_LOT_PALLET_NO = WK_LAST_PALLET_NO;
              END
              IF (WK_LAST_LOT_PALLET_NO > WK_LAST_PALLET_NO) THEN
              BEGIN
                 WK_LAST_PALLET_NO = WK_LAST_LOT_PALLET_NO;
              END
           END
           WK_LAST_PALLET_NO = WK_LAST_PALLET_NO + 1;
           UPDATE GRN SET LAST_PALLET_NO = :WK_LAST_PALLET_NO WHERE GRN = :GRN;
           IF (WK_LAST_PALLET_NO < 10) THEN
           BEGIN
              P_LAST_PALLET_NO = '0' || WK_LAST_PALLET_NO;
           END
           ELSE
           BEGIN
             P_LAST_PALLET_NO = WK_LAST_PALLET_NO;
           END
        /* tHE FIRST TIME THE LAST_PALLET_NO IS ALWAYS 0 */
          I_SSN_ID = WK_OWNER_PFX || WK_OWNER_GRN || P_LAST_LINE_NO || P_LAST_PALLET_NO;
          /* 170707 1st issn */
          IF (WK_1ST_ISSN = '') THEN
          BEGIN
             WK_1ST_ISSN = I_SSN_ID;
          END
         IF (WK_A_PROD = 0) THEN
         BEGIN
            /* Insert data into SSN table */
            INSERT INTO SSN (SSN_ID, WH_ID, LOCN_ID, GRN, STATUS_SSN, LABEL_DATE, ORIGINAL_QTY,
                    CURRENT_QTY, PO_ORDER, PO_RECEIVE_DATE, PO_LINE, SUPPLIER_ID, COMPANY_ID, CREATE_DATE, CREATED_BY)
            VALUES (:I_SSN_ID, :WH_ID, :LOCN_ID, :GRN, :WK_STATUS, 'NOW', :WK_LABEL_CURQTY, :WK_LABEL_CURQTY, :WK_LOADNO, 'NOW', :WK_LOAD_LINE_NO, :WK_SUPPLIER, :WK_OWNER, :TRANS_DATE, :WK_USER);
            INSERT INTO ISSN (SSN_ID, ORIGINAL_SSN, WH_ID, LOCN_ID, CURRENT_QTY, ISSN_STATUS, LABEL_DATE, COMPANY_ID, ORIGINAL_QTY, CREATE_DATE, USER_ID, INTO_DATE)
            VALUES (:I_SSN_ID, :I_SSN_ID, :WH_ID, :LOCN_ID, :WK_LABEL_CURQTY, :WK_STATUS, 'NOW', :WK_OWNER, :WK_LABEL_CURQTY, :TRANS_DATE, :WK_USER, :TRANS_DATE);
         END
         IF (WK_A_PROD = 1) THEN
         BEGIN
            INSERT INTO ISSN (SSN_ID, ORIGINAL_SSN, WH_ID, LOCN_ID, CURRENT_QTY, ISSN_STATUS, PROD_ID, LABEL_DATE, COMPANY_ID, ORIGINAL_QTY, CREATE_DATE, USER_ID, INTO_DATE)
            VALUES (:I_SSN_ID, :W_PRODUCT_SSN_ID, :WH_ID, :LOCN_ID, :WK_LABEL_CURQTY, :WK_PROD_STATUS, :OBJECT, 'NOW', :WK_OWNER, :WK_LABEL_CURQTY, :TRANS_DATE, :WK_USER, :TRANS_DATE);
         END
         I_PALLET_NO = I_PALLET_NO + 1;
        END /* WHILE I_PALLETNO < LABEL_NO */
   END /* if ssn method is 'CMP=2|GRN=6|LINE=2|SFX=2' */
   IF (WK_A_PROD = 1) THEN
   BEGIN
      UPDATE PICK_ITEM SET PICK_LINE_STATUS = 'OP'
      WHERE PICK_ITEM.PROD_ID = :OBJECT
      AND PICK_ITEM.PICK_LINE_STATUS = 'AS'
      AND EXISTS ( SELECT PICK_ORDER.PICK_ORDER FROM PICK_ORDER
         WHERE PICK_ORDER.PICK_ORDER = PICK_ITEM.PICK_ORDER
           AND PICK_ORDER.COMPANY_ID = :WK_OWNER
           AND PICK_ORDER.WH_ID = :WH_ID 
           AND PICK_STATUS IN ('DA','OP','UC') );
   END
   WK_RESPONSE_TXT = :WK_RESPONSE_TXT || :WK_1ST_ISSN || '|' || :WK_SSNQTY2 || '|' || :WK_LABELQTY2 || '|' || :WK_PRINTER || '|' ;   
   WK_RESPONSE_TXT2 = '|' || :WK_1ST_ISSN || '|' || :WK_SSNQTY2 || '|' || :WK_LABELQTY2 ;
      /* append the file name to the directory*/
   IF (WK_GENERATE_LABEL_TEXT = 'T') THEN
   BEGIN
      IF (WK_A_PROD = 0) THEN
      BEGIN
         WK_FILENAME = WK_DIRECTORY || 'LOAD2.1xt';
         WK_LABEL_LINE = '"' || W_SSN_ID || '","' ||
             WK_LOADNO || '","' ||
             LABEL_NO || '"';
         WK_HAVE_FILE_2 = 1;
         WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE);
         IF (WK_RESULT <> 0) THEN
         BEGIN
            WK_FILENAME = WK_DIRECTORY || 'LOAD2.2xt';
            WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE);
            WK_HAVE_FILE_2 = -1;
         END
      END
      IF (WK_A_PROD = 1) THEN
      BEGIN
         WK_FILENAME = WK_DIRECTORY || 'Product2.1xt';
         IF (WK_A_PO = 0) THEN
         BEGIN
            WK_LABEL_LINE = '"' || W_SSN_ID || '","' || 
                WK_LABELQTY2 || '","' || 
                OBJECT || '","' || 
                WK_PROD_DESC || '","' || 
                WK_DATE || '","' || 
                WK_SSNQTY2 || '","' || 
                WK_WEIGHT_X || '","' ||
                WK_WEIGHT_UOM || '","' ||
                WK_PUTLOCN_1 || '","' ||
                WK_PUTLOCN_2 || '","' ||
                WK_LOADNO || '","' ||
                GRN || '","' ||
                W_PRODUCT_SSN_ID || '","' ||
                WK_ALTPROD || '","' ||
                WK_STD_PALLET_DESC || '","' ||
                WK_NON_PALLET_DESC || '","' ||
                WK_ISSUE_UOM || '","' ||
                WK_TOT_INNER || '","' ||
                WK_TOT_OUTER || '","' ||
                WK_INSTR || '","' ||
                WK_PRINTER  || '","' ||
             WK_TEMPERATURE_ZONE || '"' ;
         END
         ELSE
         BEGIN
            WK_LABEL_LINE = '"' || W_SSN_ID || '","' || 
                WK_LABELQTY2 || '","' || 
                OBJECT || '","' || 
                WK_PROD_DESC || '","' || 
                WK_DATE || '","' || 
                WK_SSNQTY2 || '","'  ||
                WK_WEIGHT_X || '","' ||
                WK_WEIGHT_UOM || '","' ||
                WK_PUTLOCN_1 || '","' ||
                WK_PUTLOCN_2 || '","' ||
                WK_LOADNO || '","' ||
                GRN || '","' ||
                W_PRODUCT_SSN_ID || '","' ||
                WK_ALTPROD || '","' ||
                WK_STD_PALLET_DESC || '","' ||
                WK_NON_PALLET_DESC || '","' ||
                WK_ISSUE_UOM || '","' ||
                WK_TOT_INNER || '","' ||
                WK_TOT_OUTER || '","' ||
                WK_INSTR || '","' ||
                WK_PRINTER || '","' ||
             WK_TEMPERATURE_ZONE || '"' ;
         END
         WK_HAVE_FILE_2 = 1;
         WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE);
         IF (WK_RESULT <> 0) THEN
         BEGIN
            WK_FILENAME = WK_DIRECTORY || 'Product2.2xt';
            WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE);
            WK_HAVE_FILE_2 = -1;
         END
      END
   END /* generate is T */
END /* IF do 2nd set  */
   IF (WK_A_PROD = 0) THEN
   BEGIN
      IF (WK_HAVE_FILE_1 = 1) THEN
      BEGIN
         /* rename load.1xt to load.txt */
         WK_FILENAME = WK_DIRECTORY || 'LOAD.1xt';
         WK_FILENAME2 = WK_DIRECTORY || 'LOAD.txt';
         WK_RESULT = FILE_RENAME(WK_FILENAME, WK_FILENAME2);
      END
      IF (WK_HAVE_FILE_1 = -1) THEN
      BEGIN
         /* rename load.2xt to load.txt */
         WK_FILENAME = WK_DIRECTORY || 'LOAD.2xt';
         WK_FILENAME2 = WK_DIRECTORY || 'LOAD.txt';
         WK_RESULT = FILE_RENAME(WK_FILENAME, WK_FILENAME2);
      END
      IF (WK_HAVE_FILE_2 = 1) THEN
      BEGIN
         /* rename load2.1xt to load2.txt */
         WK_FILENAME = WK_DIRECTORY || 'LOAD2.1xt';
         WK_FILENAME2 = WK_DIRECTORY || 'LOAD2.txt';
         WK_RESULT = FILE_RENAME(WK_FILENAME, WK_FILENAME2);
      END
      IF (WK_HAVE_FILE_2 = -1) THEN
      BEGIN
         /* rename load2.2xt to load2.txt */
         WK_FILENAME = WK_DIRECTORY || 'LOAD2.2xt';
         WK_FILENAME2 = WK_DIRECTORY || 'LOAD2.txt';
         WK_RESULT = FILE_RENAME(WK_FILENAME, WK_FILENAME2);
      END
   END
   IF (WK_A_PROD = 1) THEN
   BEGIN
      IF (WK_HAVE_FILE_1 = 1) THEN
      BEGIN
         /* rename product.1xt to product.txt */
         WK_FILENAME = WK_DIRECTORY || 'Product.1xt';
         WK_FILENAME2 = WK_DIRECTORY || 'Product.txt';
         WK_RESULT = FILE_RENAME(WK_FILENAME, WK_FILENAME2);
      END
      IF (WK_HAVE_FILE_1 = -1) THEN
      BEGIN
         /* rename product.2xt to product.txt */
         WK_FILENAME = WK_DIRECTORY || 'Product.2xt';
         WK_FILENAME2 = WK_DIRECTORY || 'Product.txt';
         WK_RESULT = FILE_RENAME(WK_FILENAME, WK_FILENAME2);
      END
      IF (WK_HAVE_FILE_2 = 1) THEN
      BEGIN
         /* rename product2.1xt to product2.txt */
         WK_FILENAME = WK_DIRECTORY || 'Product2.1xt';
         WK_FILENAME2 = WK_DIRECTORY || 'Product2.txt';
         WK_RESULT = FILE_RENAME(WK_FILENAME, WK_FILENAME2);
      END
      IF (WK_HAVE_FILE_2 = -1) THEN
      BEGIN
         /* rename product2.2xt to product2.txt */
         WK_FILENAME = WK_DIRECTORY || 'Product2.2xt';
         WK_FILENAME2 = WK_DIRECTORY || 'Product2.txt';
         WK_RESULT = FILE_RENAME(WK_FILENAME, WK_FILENAME2);
      END
   END
    /* Update transactions table */        
   IF (WK_GENERATE_LABEL_TEXT = 'T') THEN
   BEGIN
      IF (WK_TRN_CODE = 'P') THEN
    BEGIN
/*
         IF (WK_RESPONSE_TXT2 = '') THEN
         BEGIN
           WK_RESPONSE_TXT2 = '|||';
         END
       WK_RESPONSE_FINAL = :WK_RESPONSE_TXT1 || :WK_RESPONSE_TXT2 || '|' || :WK_PRINTER;
       WK_RESPONSE_FINAL = :WK_RESPONSE_FINAL || '|' || 'Processed successfully';
       EXECUTE PROCEDURE UPDATE_TRAN (:RECORD_ID, 'T', :WK_RESPONSE_FINAL);
*/
     EXECUTE PROCEDURE UPDATE_TRAN (:RECORD_ID, 'T', 'Processed successfully'); 
    /*   WK_RESPONSE_TXT = :WK_RESPONSE_TXT || 'Processed successfully'; */
    /* EXECUTE PROCEDURE UPDATE_TRAN (:RECORD_ID, 'T', :WK_RESPONSE_TXT); */
    END
    ELSE
    BEGIN
       EXECUTE PROCEDURE UPDATE_TRAN (:RECORD_ID, 'T', 'Processed successfully');
    END
   END
   IF (WK_GENERATE_LABEL_TEXT = 'F') THEN
   BEGIN
      IF (WK_TRN_CODE = 'P') THEN
    BEGIN
         IF (WK_RESPONSE_TXT2 = '') THEN
         BEGIN
           WK_RESPONSE_TXT2 = '|||';
         END
       /* IF (WK_SAVED_ISSN = '') THEN
       BEGIN
          -* no 1st group - use 2nd start issn *-
          WK_RESPONSE_FINAL = :WK_1ST_ISSN || :WK_RESPONSE_TXT1;
          WK_RESPONSE_TXT1 = WK_RESPONSE_FINAL;
       END */
       WK_RESPONSE_FINAL = :WK_RESPONSE_TXT1 || :WK_RESPONSE_TXT2 || '|' || :WK_PRINTER;
       WK_RESPONSE_FINAL = :WK_RESPONSE_FINAL || '|' || 'Processed successfully';
       EXECUTE PROCEDURE UPDATE_TRAN (:RECORD_ID, 'T', :WK_RESPONSE_FINAL);
    END
    ELSE
    BEGIN
       EXECUTE PROCEDURE UPDATE_TRAN (:RECORD_ID, 'T', 'Processed successfully');
    END
   END
END ^

ALTER PROCEDURE ADD_SSN_ISSN_GRNV (WH_ID VARCHAR(2) CHARACTER SET NONE,
LOCN_ID VARCHAR(10) CHARACTER SET NONE,
OBJECT VARCHAR(30) CHARACTER SET NONE,
TRANS_DATE TIMESTAMP,
QTY INTEGER,
GRN VARCHAR(10) CHARACTER SET NONE,
REFERENCE VARCHAR(40) CHARACTER SET NONE,
SOURCE VARCHAR(9) CHARACTER SET NONE,
RECORD_ID INTEGER)
AS 
DECLARE VARIABLE SSN_ID INTEGER;
DECLARE VARIABLE P_SSN_ID INTEGER;
DECLARE VARIABLE W_SSN_ID VARCHAR(20);
DECLARE VARIABLE I_SSN_ID VARCHAR(20);
DECLARE VARIABLE LEN_SSN_ID INTEGER;
DECLARE VARIABLE I_LEN_SSN_ID INTEGER;
DECLARE VARIABLE SSN_LENGTH INTEGER;
DECLARE VARIABLE LABEL_NO INTEGER;
DECLARE VARIABLE WK_LABEL_CURQTY INTEGER;
DECLARE VARIABLE WK_SSN_CURQTY INTEGER;
DECLARE VARIABLE WK_LABELQTY1 VARCHAR(10);
DECLARE VARIABLE WK_LABELQTY2 VARCHAR(10);
DECLARE VARIABLE WK_SSNQTY1 VARCHAR(10);
DECLARE VARIABLE WK_SSNQTY2 VARCHAR(10);
DECLARE VARIABLE WK_GRN_TYPE CHAR(2);
DECLARE VARIABLE WK_PRINTER CHAR(2);
DECLARE VARIABLE WK_DIRECTORY VARCHAR(75);
DECLARE VARIABLE WK_FILENAME VARCHAR(255);
DECLARE VARIABLE WK_LABEL_LINE VARCHAR(250);
DECLARE VARIABLE WK_LOADNO VARCHAR(10);
DECLARE VARIABLE WK_LOAD_LINE_NO VARCHAR(10);
DECLARE VARIABLE WK_RESULT INTEGER;
DECLARE VARIABLE WK_DATE VARCHAR(20);
DECLARE VARIABLE WK_TIME VARCHAR(10);
DECLARE VARIABLE WK_PROD_DESC VARCHAR(50);
DECLARE VARIABLE WK_A_PROD INTEGER;
DECLARE VARIABLE WK_A_PO INTEGER;
DECLARE VARIABLE WK_PROD_EXISTS INTEGER;
DECLARE VARIABLE WK_REF_LEN INTEGER;
DECLARE VARIABLE WK_REF2_LAST INTEGER;
DECLARE VARIABLE WK_OLD_METHOD CHAR(1);
DECLARE VARIABLE WK_PRINTER_2 VARCHAR(5);
DECLARE VARIABLE WK_REF VARCHAR(40);
DECLARE VARIABLE WK_SUPPLIER VARCHAR(10);
DECLARE VARIABLE WK_OWNER VARCHAR(10);
DECLARE VARIABLE WK_OWNER_PFX VARCHAR(10);
DECLARE VARIABLE WK_STATUS CHAR(2);
DECLARE VARIABLE WK_PROD_STATUS CHAR(2);
DECLARE VARIABLE WK_HAVE_FILE_1 INTEGER;
DECLARE VARIABLE WK_HAVE_FILE_2 INTEGER;
DECLARE VARIABLE WK_FILENAME2 VARCHAR(255);
DECLARE VARIABLE W_PRODUCT_SSN_ID VARCHAR(20);
DECLARE VARIABLE WK_PO_FOUND INTEGER;
DECLARE VARIABLE WK_PO_QTY INTEGER;
DECLARE VARIABLE WK_PO_ORIG_QTY INTEGER;
DECLARE VARIABLE WK_PO_NEW_QTY INTEGER;
DECLARE VARIABLE WK_PO_STATUS CHAR(2);
DECLARE VARIABLE WK_USER VARCHAR(10);
DECLARE VARIABLE WK_PROD_TYPE CHAR(2);
DECLARE VARIABLE LABEL_NO2 INTEGER;
DECLARE VARIABLE WK_LABEL_CURQTY2 INTEGER;
DECLARE VARIABLE WK_DEVICE_ID CHAR(2);
DECLARE VARIABLE WK_TRN_TYPE CHAR(4);
DECLARE VARIABLE WK_TRN_CODE CHAR(1);
DECLARE VARIABLE WK_REASON VARCHAR(70);
DECLARE VARIABLE WK_PUTLOCN_1 VARCHAR(10);
DECLARE VARIABLE WK_PUTLOCN_2 VARCHAR(10);
DECLARE VARIABLE WK_WEIGHT_X VARCHAR(10);
DECLARE VARIABLE WK_WEIGHT_UOM VARCHAR(10);
DECLARE VARIABLE WK_ALTPROD VARCHAR(30);
DECLARE VARIABLE WK_STD_PALLET_CFG VARCHAR(2);
DECLARE VARIABLE WK_NON_PALLET_CFG VARCHAR(2);
DECLARE VARIABLE WK_ISSUE_UOM VARCHAR(2);
DECLARE VARIABLE WK_INSTR VARCHAR(50);
DECLARE VARIABLE WK_INNER_UNITS INTEGER;
DECLARE VARIABLE WK_ORDER_UNITS INTEGER;
DECLARE VARIABLE WK_TOT_INNER INTEGER;
DECLARE VARIABLE WK_TOT_OUTER INTEGER;
DECLARE VARIABLE WK_STD_PALLET_DESC VARCHAR(50);
DECLARE VARIABLE WK_STD_PALLET_CARTONS INTEGER;
DECLARE VARIABLE WK_STD_PALLET_LAYERS INTEGER;
DECLARE VARIABLE WK_NON_PALLET_DESC VARCHAR(50);
DECLARE VARIABLE WK_LAST_LINE_NO INTEGER;
DECLARE VARIABLE WK_LAST_PALLET_NO INTEGER;
DECLARE VARIABLE I_PALLET_NO INTEGER;
DECLARE VARIABLE WK_TEMPERATURE_ZONE VARCHAR(2);
DECLARE VARIABLE WK_GENERATE_SSN_METHOD VARCHAR(25);
DECLARE VARIABLE P_LAST_LINE_NO VARCHAR(2);
DECLARE VARIABLE P_LAST_PALLET_NO VARCHAR(3);
DECLARE VARIABLE WK_GENERATE_LABEL_TEXT CHAR(1);
DECLARE VARIABLE WK_COUNT_SSN INTEGER; 
DECLARE VARIABLE WK_RESPONSE_TXT VARCHAR(255);
DECLARE VARIABLE WK_RESPONSE_TXT1 VARCHAR(255);
DECLARE VARIABLE WK_RESPONSE_TXT2 VARCHAR(255);
DECLARE VARIABLE WK_RESPONSE_FINAL VARCHAR(255);
DECLARE VARIABLE WK_1ST_ISSN VARCHAR(20);
DECLARE VARIABLE WK_GRN_OWNER VARCHAR(10); 
DECLARE VARIABLE WK_CMP_FROM VARCHAR(40); 
DECLARE VARIABLE WK_SSN_TYPE VARCHAR(40); 
DECLARE VARIABLE WK_OWNER_GRN VARCHAR(10); 
DECLARE VARIABLE WK_GRN_LOT VARCHAR(30); 
DECLARE VARIABLE WK_LAST_LOT_PALLET_NO INTEGER;
DECLARE VARIABLE WK_LOG_FILENAME VARCHAR(255);
DECLARE VARIABLE WK_LOG_RESULT INTEGER;
DECLARE VARIABLE WK_SAVED_ISSN VARCHAR(20); 
DECLARE VARIABLE WK_SAVED_QTY1 VARCHAR(20); 
DECLARE VARIABLE WK_SAVED_QTY2 VARCHAR(20); 
DECLARE VARIABLE WK_PO_PRICE   DOUBLE PRECISION;
DECLARE VARIABLE WK_ADJ_PRICE  DOUBLE PRECISION;
BEGIN 
   WK_COUNT_SSN = 0;
   WK_HAVE_FILE_1 = 0;
   WK_HAVE_FILE_2 = 0;
   WK_REF = ALLTRIM(REFERENCE);
   REFERENCE = WK_REF;
   WK_REF_LEN = STRLEN(REFERENCE);
   WK_REF2_LAST = WK_REF_LEN;
   WK_OLD_METHOD = 'Y';
   WK_RESPONSE_TXT = '';
      WK_RESPONSE_TXT1 = '';
   WK_RESPONSE_TXT2 = '';
   WK_RESPONSE_FINAL = '';
   WK_1ST_ISSN = '';
   WK_SAVED_ISSN = '';
   WK_SAVED_QTY1 = '';
   WK_SAVED_QTY2 = '';
   WK_LOG_FILENAME = '/tmp/grnv.log';
   SELECT PERSON_ID, DEVICE_ID, TRN_TYPE, TRN_CODE 
   FROM TRANSACTIONS 
   WHERE RECORD_ID = :RECORD_ID
   INTO :WK_USER, :WK_DEVICE_ID, :WK_TRN_TYPE, :WK_TRN_CODE;

   WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, wk_user || wk_device_id || wk_trn_type || wk_trn_code);
   SELECT GENERATE_LABEL_TEXT FROM CONTROL INTO :WK_GENERATE_LABEL_TEXT;
   IF (WK_GENERATE_LABEL_TEXT IS NULL) THEN
   BEGIN
        WK_GENERATE_LABEL_TEXT = 'F';
   END
   /* do a loop until char is '|' or have the new method
      if char <'0' or > '9' then have the new method */
   WHILE ((SUBSTR(REFERENCE,WK_REF2_LAST,WK_REF2_LAST) <> '|') AND
          (WK_OLD_METHOD = 'Y')) DO
   BEGIN
      IF (SUBSTR(REFERENCE,WK_REF2_LAST,WK_REF2_LAST) < '0' OR
          SUBSTR(REFERENCE,WK_REF2_LAST,WK_REF2_LAST) > '9') THEN
      BEGIN      
         WK_OLD_METHOD = 'N';
      END
      WK_REF2_LAST = WK_REF2_LAST - 1;
   END
   /* Get the STatus to use for the inserts */
   SELECT NEW_SSN_STATUS, NEW_PROD_STATUS FROM CONTROL
   INTO :WK_STATUS, :WK_PROD_STATUS;
   /* Get length for Barcode */   
   EXECUTE PROCEDURE GET_BARCODE_LENGTH RETURNING_VALUES SSN_LENGTH;
   EXECUTE PROCEDURE GET_REFERENCE_FIELD :REFERENCE, 2  RETURNING_VALUES :WK_LOADNO ; 
   EXECUTE PROCEDURE GET_REFERENCE_FIELD :REFERENCE, 3  RETURNING_VALUES :WK_LOAD_LINE_NO ; 
   EXECUTE PROCEDURE GET_REFERENCE_FIELD :REFERENCE, 4  RETURNING_VALUES :WK_SSNQTY1 ; 
   EXECUTE PROCEDURE GET_REFERENCE_FIELD :REFERENCE, 5  RETURNING_VALUES :WK_LABELQTY1 ; 
   EXECUTE PROCEDURE GET_REFERENCE_FIELD :REFERENCE, 6  RETURNING_VALUES :WK_SSNQTY2 ; 
   EXECUTE PROCEDURE GET_REFERENCE_FIELD :REFERENCE, 7  RETURNING_VALUES :WK_LABELQTY2 ; 
   IF (WK_SSNQTY1 = '') THEN
   BEGIN
      WK_SSNQTY1 = '0';
   END
   IF (WK_LABELQTY1 = '') THEN
   BEGIN
      WK_LABELQTY1 = '0';
   END
   IF (WK_SSNQTY2 = '') THEN
   BEGIN
      WK_SSNQTY2 = '0';
   END
   IF (WK_LABELQTY2 = '') THEN
   BEGIN
      WK_LABELQTY2 = '0';
   END
   LABEL_NO = CAST(WK_SSNQTY1 AS INTEGER);
   WK_LABEL_CURQTY = CAST(WK_LABELQTY1 AS INTEGER);
   /* find type of grn PO LD or */
   WK_GRN_TYPE = SUBSTR(REFERENCE, 1, 2);
   LABEL_NO2 = CAST(WK_SSNQTY2 AS INTEGER);
   WK_LABEL_CURQTY2 = CAST(WK_LABELQTY2 AS INTEGER);
   IF ((LABEL_NO <= 0) AND (LABEL_NO2 <= 0)) THEN
   BEGIN
      /* no labels so stop */
      EXECUTE PROCEDURE UPDATE_TRAN (:RECORD_ID, 'F', 'No Labels to Print/Create');
      EXIT;
   END
   /* 10/02/09 if 1st group is empty swap the 2 groups  */
   IF (LABEL_NO <= 0) THEN 
   BEGIN
      WK_SAVED_QTY1 = WK_SSNQTY1;
      WK_SAVED_QTY2 = WK_LABELQTY1;
      WK_SSNQTY1 = WK_SSNQTY2;
      WK_LABELQTY1 = WK_LABELQTY2;
      WK_SSNQTY2 = WK_SAVED_QTY1;
      WK_LABELQTY2 = WK_SAVED_QTY2;
      LABEL_NO = CAST(WK_SSNQTY1 AS INTEGER);
      WK_LABEL_CURQTY = CAST(WK_LABELQTY1 AS INTEGER);
   END 
   IF (WK_GRN_TYPE = 'IP') THEN
   BEGIN
      WK_STATUS = 'IN';
      WK_PROD_STATUS = 'IN';
      /* get the grn used */
      SELECT PO_GRN
      FROM PURCHASE_ORDER 
      WHERE PURCHASE_ORDER = :WK_LOADNO
      INTO :GRN;
   END
   /* THE SSN GENERATION METHOD IS BASED ON THE CONTROL TABLE FIELD. */
   SELECT GENERATE_SSN_METHOD FROM CONTROL INTO :WK_GENERATE_SSN_METHOD;
   IF ((WK_GENERATE_SSN_METHOD IS NULL) OR ((WK_GENERATE_SSN_METHOD <> '|GRN=4|LINE=2|SUFFIX=2,3|') AND 
    (WK_GENERATE_SSN_METHOD <> 'CMP=2|GRN=6|LINE=2|SFX=2' ))) THEN
   BEGIN
      SSN_ID = GEN_ID(ISSN_SSN_ID, :LABEL_NO);
      P_SSN_ID = SSN_ID - :LABEL_NO;
      LEN_SSN_ID = STRLEN(P_SSN_ID);
      W_SSN_ID = '';
         /* Padding leading with 0 */
      WHILE (LEN_SSN_ID < :SSN_LENGTH) DO
      BEGIN
          W_SSN_ID = W_SSN_ID || '0';
          LEN_SSN_ID = LEN_SSN_ID + 1;
       END
       W_SSN_ID = W_SSN_ID || P_SSN_ID;
   END
   WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, 'before next ssn');
   IF (WK_GENERATE_SSN_METHOD = '|GRN=4|LINE=2|SUFFIX=2,3|' ) THEN
   BEGIN
        SELECT LAST_LINE_NO, LAST_PALLET_NO, LAST_LOT_NO FROM GRN WHERE GRN = :GRN INTO :WK_LAST_LINE_NO, :WK_LAST_PALLET_NO, :WK_GRN_LOT;
        IF (:WK_LAST_LINE_NO IS NULL) THEN
        BEGIN
               /* i AM UNSURE ABOUT THIS AS LINE NUMBER ACCORDING TO ME SHOULD NOT BE INCREMENTED.S */
              WK_LAST_LINE_NO = 0;
        END
        IF (WK_LOAD_LINE_NO = '') THEN
        BEGIN
             WK_LAST_LINE_NO = WK_LAST_LINE_NO + 1;
             UPDATE GRN SET LAST_LINE_NO = :WK_LAST_LINE_NO WHERE GRN = :GRN;
        END
        ELSE
        BEGIN
             WK_LAST_LINE_NO = WK_LOAD_LINE_NO;
        END
        IF (:WK_GRN_LOT IS NULL) THEN
        BEGIN
              WK_GRN_LOT = '';
        END
        IF (WK_LAST_LINE_NO < 10) THEN
        BEGIN
             P_LAST_LINE_NO = '0' || WK_LAST_LINE_NO;
        END
        ELSE
        BEGIN
             P_LAST_LINE_NO = WK_LAST_LINE_NO;
        END
        IF (WK_LAST_PALLET_NO IS NULL) THEN
        BEGIN
             WK_LAST_PALLET_NO = 0;
        END
        IF (WK_LAST_PALLET_NO < 10) THEN
        BEGIN
             P_LAST_PALLET_NO = '0' || WK_LAST_PALLET_NO;
        END
        ELSE
        BEGIN
             P_LAST_PALLET_NO = WK_LAST_PALLET_NO;
        END
        UPDATE GRN SET LAST_PALLET_NO = :WK_LAST_PALLET_NO WHERE GRN = :GRN;
        IF (STRLEN(WK_GRN_LOT) > 0) THEN
        BEGIN
           WK_OWNER_GRN = SUBSTR(WK_GRN_LOT, 1, 4);
           P_LAST_LINE_NO = SUBSTR(WK_GRN_LOT, 5, 6);
        END
        /* tHE FIRST TIME THE LAST_PALLET_NO IS ALWAYS 0 */
        W_SSN_ID = GRN || P_LAST_LINE_NO || '00';
   END /* if ssn method is |GRN=4|LINE=2|SUFFIX=2,3| */
   IF (WK_GENERATE_SSN_METHOD = 'CMP=2|GRN=6|LINE=2|SFX=2' ) THEN
   BEGIN
        SELECT LAST_LINE_NO, LAST_PALLET_NO, LAST_LOT_NO FROM GRN WHERE GRN = :GRN INTO :WK_LAST_LINE_NO, :WK_LAST_PALLET_NO, :WK_GRN_LOT;
        IF (:WK_LAST_LINE_NO IS NULL) THEN
        BEGIN
               /* i AM UNSURE ABOUT THIS AS LINE NUMBER ACCORDING TO ME SHOULD NOT BE INCREMENTED.S */
              WK_LAST_LINE_NO = 0;
        END
        IF (WK_LOAD_LINE_NO = '') THEN
        BEGIN
             WK_LAST_LINE_NO = WK_LAST_LINE_NO + 1;
             UPDATE GRN SET LAST_LINE_NO = :WK_LAST_LINE_NO WHERE GRN = :GRN;
        END
        ELSE
        BEGIN
        /* THE LAST LINE NUMBER HAS BEEN PASSED FROM THE FRONT END SCREEN. NO UPDATE TO GRN REQUIRED. */
             WK_LAST_LINE_NO = WK_LOAD_LINE_NO;
        END
        IF (WK_GRN_LOT IS NULL) THEN
        BEGIN
           WK_GRN_LOT = '';
        END
        IF (WK_LAST_LINE_NO < 10) THEN
        BEGIN
             P_LAST_LINE_NO = '0' || WK_LAST_LINE_NO;
        END
        ELSE
        BEGIN
             P_LAST_LINE_NO = WK_LAST_LINE_NO;
        END
        IF (WK_LAST_PALLET_NO IS NULL) THEN
        BEGIN
             WK_LAST_PALLET_NO = 0;
        END
        IF (WK_LAST_PALLET_NO < 10) THEN
        BEGIN
             P_LAST_PALLET_NO = '0' || WK_LAST_PALLET_NO;
        END
        ELSE
        BEGIN
             P_LAST_PALLET_NO = WK_LAST_PALLET_NO;
        END
        UPDATE GRN SET LAST_PALLET_NO = :WK_LAST_PALLET_NO WHERE GRN = :GRN;
        WK_OWNER = '';
        WK_OWNER_PFX = '';
        IF ((WK_GRN_TYPE = 'PO') OR
            (WK_GRN_TYPE = 'RA') OR  
            (WK_GRN_TYPE = 'TR') OR
            (WK_GRN_TYPE = 'IP') OR
            (WK_GRN_TYPE = 'WO')) THEN
        BEGIN
           SELECT COMPANY_ID, PO_LEGACY_OWNER_ID 
           FROM PURCHASE_ORDER 
           WHERE PURCHASE_ORDER = :WK_LOADNO
           INTO :WK_OWNER, :WK_OWNER_PFX;
           IF (WK_OWNER_PFX IS NULL) THEN
           BEGIN
              WK_OWNER_PFX = '';
           END
        END
        IF (WK_OWNER IS NULL OR WK_OWNER = '') THEN
        BEGIN
           SELECT OWNER_ID 
           FROM GRN 
           WHERE GRN = :GRN
           INTO :WK_OWNER;
        END
        IF (WK_OWNER_PFX = '') THEN
        BEGIN
           SELECT COMPANY_ID_PREFIX 
           FROM COMPANY 
           WHERE COMPANY_ID = :WK_OWNER 
           INTO :WK_OWNER_PFX;
           IF (WK_OWNER_PFX IS NULL) THEN
           BEGIN
              WK_OWNER_PFX = '';
           END
        END
        LEN_SSN_ID = STRLEN(WK_OWNER_PFX);
      	WHILE (LEN_SSN_ID < 2) DO
        BEGIN
           WK_OWNER_PFX = '0' || WK_OWNER_PFX;
           LEN_SSN_ID = LEN_SSN_ID + 1;
        END
        LEN_SSN_ID = STRLEN(GRN);
        WK_OWNER_GRN = GRN;
      	WHILE (LEN_SSN_ID < 6) DO
        BEGIN
           WK_OWNER_GRN = '0' || WK_OWNER_GRN;
           LEN_SSN_ID = LEN_SSN_ID + 1;
        END
        IF (STRLEN(WK_GRN_LOT) > 0) THEN
        BEGIN
           WK_OWNER_PFX = SUBSTR(WK_GRN_LOT, 1, 2);
           WK_OWNER_GRN = SUBSTR(WK_GRN_LOT, 3, 8);
           P_LAST_LINE_NO = SUBSTR(WK_GRN_LOT, 9, 10);
        END
        W_SSN_ID = WK_OWNER_PFX || WK_OWNER_GRN || P_LAST_LINE_NO || '00';
   END /* if ssn method is 'CMP=2|GRN=6|LINE=2|SFX=2' */
   
   WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, 'after  next ssn');
   IF (WK_OLD_METHOD = 'Y') THEN
   BEGIN
      WK_PRINTER = 'P' || SUBSTR(SOURCE,5,5);
   END
   ELSE
   BEGIN
      EXECUTE PROCEDURE GET_REFERENCE_FIELD :REFERENCE, 8  RETURNING_VALUES :WK_PRINTER_2 ; 
      IF (STRLEN(WK_PRINTER_2) > 1) THEN
      BEGIN
         WK_PRINTER = WK_PRINTER_2;
      END
      ELSE
      BEGIN
         WK_PRINTER = 'P' || WK_PRINTER_2;
      END
      IF (WK_GRN_TYPE = 'LD') THEN
      BEGIN
         IF (WK_TRN_CODE = 'P') THEN
         BEGIN
            WK_SUPPLIER = '';
            SELECT RETURN_ID
            FROM GRN
            WHERE GRN = :GRN
            INTO :WK_SUPPLIER;
            IF (WK_SUPPLIER IS NULL) THEN
            BEGIN
               WK_SUPPLIER = SUBSTR(OBJECT,1,10);
            END
         END
         ELSE
         BEGIN
            WK_SUPPLIER = SUBSTR(OBJECT,1,10);
         END
         WK_OWNER = SUBSTR(OBJECT,11,20);
         UPDATE GRN 
         SET RETURN_ID = :WK_SUPPLIER
         WHERE GRN = :GRN;
      END
   END
   WK_A_PROD = 0;
   WK_A_PO = 0;

   IF ((WK_GRN_TYPE = 'PO') OR
       (WK_GRN_TYPE = 'RA') OR  
       (WK_GRN_TYPE = 'TR') OR
       (WK_GRN_TYPE = 'IP') OR
       (WK_GRN_TYPE = 'WO')) THEN
   BEGIN
       IF (OBJECT <> '') THEN
       BEGIN
           WK_A_PROD = 1;
           WK_PROD_EXISTS = 0;
           WK_A_PO = 1;
           SELECT 1, 
              SHORT_DESC ,
              HOME_LOCN_ID,
              ALTERNATE_ID,
              PALLET_CFG_INNER,
              PALLET_CFG_ALTERNATE,
              ISSUE_UOM,
              ISSUE_PER_ORDER_UNIT,
              ISSUE_PER_INNER_UNIT,
              SPECIAL_INSTR,
              TEMPERATURE_ZONE,
              SSN_TYPE,
              PROD_TYPE
              FROM PROD_PROFILE
              WHERE PROD_ID = :OBJECT
              INTO :WK_PROD_EXISTS, 
              :WK_PROD_DESC,
              :WK_PUTLOCN_1,
              :WK_ALTPROD,
              :WK_STD_PALLET_CFG,
              :WK_NON_PALLET_CFG,
              :WK_ISSUE_UOM,
              :WK_ORDER_UNITS,
              :WK_INNER_UNITS,
              :WK_INSTR,
              :WK_TEMPERATURE_ZONE,
              :WK_SSN_TYPE,
              :WK_PROD_TYPE;
           IF (WK_PROD_EXISTS = 0) THEN
           BEGIN
               /* Insert into prod_profile */
               INSERT INTO PROD_PROFILE (PROD_ID, SHORT_DESC, LAST_UPDATE_DATE)
                   VALUES (:OBJECT, :OBJECT, 'NOW');
               WK_PROD_DESC = OBJECT;
           END
           IF (WK_PUTLOCN_1 IS NULL) THEN
           BEGIN
              WK_PUTLOCN_1 = '';
           END
           SELECT FIRST 1 WH_ID || LOCN_ID
           FROM LOCATION
           WHERE PROD_ID = :OBJECT
           AND :WK_PUTLOCN_1 <> (WH_ID || LOCN_ID)
           INTO :WK_PUTLOCN_2;
           IF (WK_PUTLOCN_2 IS NULL) THEN
           BEGIN
              WK_PUTLOCN_2 = '';
           END
           IF (WK_PUTLOCN_1 = '' AND WK_PUTLOCN_2 <> '') THEN
           BEGIN
              SELECT FIRST 1 WH_ID || LOCN_ID
              FROM LOCATION
              WHERE PROD_ID = :OBJECT
              AND :WK_PUTLOCN_2 <> (WH_ID || LOCN_ID)
              INTO :WK_PUTLOCN_1;
              IF (WK_PUTLOCN_1 IS NULL) THEN
              BEGIN
                 WK_PUTLOCN_1 = '';
              END
           END
           WK_WEIGHT_X = '';
           WK_WEIGHT_UOM = '';
           IF (WK_ALTPROD IS NULL) THEN
           BEGIN
              WK_ALTPROD = '';
           END
           IF (WK_STD_PALLET_CFG IS NULL) THEN
           BEGIN
              WK_STD_PALLET_CFG = '';
           END
           IF (WK_NON_PALLET_CFG IS NULL) THEN
           BEGIN
              WK_NON_PALLET_CFG = '';
           END
           IF (WK_ISSUE_UOM IS NULL) THEN
           BEGIN
              WK_ISSUE_UOM = '';
           END
           IF (WK_INNER_UNITS IS NULL) THEN
           BEGIN
              WK_INNER_UNITS = 1;
           END
           IF (WK_ORDER_UNITS IS NULL) THEN
           BEGIN
              WK_ORDER_UNITS = 1;
           END
           IF (WK_INSTR IS NULL) THEN
           BEGIN
              WK_INSTR = '';
           END
           IF (WK_TEMPERATURE_ZONE IS NULL) THEN
           BEGIN
                WK_TEMPERATURE_ZONE = '';
           END
           SELECT 
              PALLET_CFG_DESCRIPTION,
              TOTAL_CARTONS_LAYER,
              TOTAL_LAYERS
           FROM PALLET_CFG
           WHERE PALLET_CFG_CODE = :WK_STD_PALLET_CFG
           INTO :WK_STD_PALLET_DESC, :WK_STD_PALLET_CARTONS, :WK_STD_PALLET_LAYERS;
           SELECT 
              PALLET_CFG_DESCRIPTION
           FROM PALLET_CFG
           WHERE PALLET_CFG_CODE = :WK_NON_PALLET_CFG
           INTO :WK_NON_PALLET_DESC ;
           IF (WK_STD_PALLET_DESC IS NULL) THEN
           BEGIN
              WK_STD_PALLET_DESC = WK_STD_PALLET_CFG;
           END
           IF (WK_STD_PALLET_CARTONS IS NULL) THEN
           BEGIN
              WK_STD_PALLET_CARTONS = 1;
           END
           IF (WK_STD_PALLET_LAYERS IS NULL) THEN
           BEGIN
              WK_STD_PALLET_LAYERS = 1;
           END
           IF (WK_NON_PALLET_DESC IS NULL) THEN
           BEGIN
              WK_NON_PALLET_DESC = WK_NON_PALLET_CFG;
           END
           WK_TOT_INNER = WK_ORDER_UNITS / WK_INNER_UNITS;
           WK_TOT_OUTER = WK_STD_PALLET_LAYERS * WK_STD_PALLET_CARTONS;
           WK_SSN_CURQTY = LABEL_NO  * WK_LABEL_CURQTY ;
           SELECT COMPANY_ID 
           FROM PURCHASE_ORDER 
           WHERE PURCHASE_ORDER = :WK_LOADNO
           INTO :WK_OWNER;
           IF (WK_OWNER IS NULL) THEN
           BEGIN
              SELECT COMPANY_ID FROM CONTROL INTO :WK_OWNER; 
           END
           WK_PO_PRICE = 0;
           SELECT FIRST 1 UNIT_PRICE
           FROM PURCHASE_ORDER_LINE
           WHERE PURCHASE_ORDER = :WK_LOADNO
           AND   PO_LINE = :WK_LOAD_LINE_NO
           INTO :WK_PO_PRICE;
           IF (WK_PO_PRICE IS NULL) THEN
           BEGIN
              WK_PO_PRICE = 0;
           END
           WK_ADJ_PRICE = WK_PO_PRICE * WK_SSN_CURQTY;
          /* Insert data into SSN table */   
          SELECT COUNT(*) AS CNT FROM SSN WHERE SSN_ID = :W_SSN_ID INTO :WK_COUNT_SSN;
          IF (WK_COUNT_SSN = 0) THEN
          BEGIN
             IF (WK_SSN_TYPE IS NULL) THEN
             BEGIN
                    INSERT INTO SSN (SSN_ID, WH_ID, LOCN_ID, GRN, STATUS_SSN, LABEL_DATE, ORIGINAL_QTY,
                    CURRENT_QTY, PURCHASE_DATE, PO_ORDER, PO_RECEIVE_DATE, PROD_ID, SSN_DESCRIPTION, PO_LINE, COMPANY_ID, SSN_TYPE, CREATE_DATE, CREATED_BY, PURCHASE_PRICE)
                    VALUES (:W_SSN_ID, :WH_ID, :LOCN_ID, :GRN, :WK_PROD_STATUS, 'NOW', :WK_SSN_CURQTY, :WK_SSN_CURQTY, 'NOW',:WK_LOADNO, 'NOW', :OBJECT,:WK_PROD_DESC,:WK_LOAD_LINE_NO, :WK_OWNER, :WK_PROD_TYPE, :TRANS_DATE, :WK_USER, :WK_ADJ_PRICE);
             END
             ELSE
             BEGIN
                    INSERT INTO SSN (SSN_ID, WH_ID, LOCN_ID, GRN, STATUS_SSN, LABEL_DATE, ORIGINAL_QTY,
                    CURRENT_QTY, PURCHASE_DATE, PO_ORDER, PO_RECEIVE_DATE, PROD_ID, SSN_DESCRIPTION, PO_LINE, COMPANY_ID, SSN_TYPE, CREATE_DATE, CREATED_BY, PURCHASE_PRICE)
                    VALUES (:W_SSN_ID, :WH_ID, :LOCN_ID, :GRN, :WK_PROD_STATUS, 'NOW', :WK_SSN_CURQTY, :WK_SSN_CURQTY, 'NOW',:WK_LOADNO, 'NOW', :OBJECT,:WK_PROD_DESC,:WK_LOAD_LINE_NO, :WK_OWNER, :WK_SSN_TYPE, :TRANS_DATE, :WK_USER, :WK_ADJ_PRICE);
             END
          END
          ELSE
          BEGIN
               UPDATE SSN SET ORIGINAL_QTY = ORIGINAL_QTY + :WK_SSN_CURQTY, CURRENT_QTY = CURRENT_QTY + :WK_SSN_CURQTY, PURCHASE_PRICE = PURCHASE_PRICE + :WK_ADJ_PRICE
               WHERE SSN_ID = :W_SSN_ID;
          END
          W_PRODUCT_SSN_ID = W_SSN_ID;
          WK_REASON = 'Received ' || :WK_SSN_CURQTY || ' by User ' || :WK_USER || ' SSN ' || :W_SSN_ID ;
          EXECUTE PROCEDURE ADD_SSN_HIST(:WH_ID, :LOCN_ID, :W_SSN_ID, 
                          :WK_TRN_TYPE, :WK_TRN_CODE, :TRANS_DATE,
                          :WK_REASON, '' , :WK_SSN_CURQTY, :WK_USER, :WK_DEVICE_ID); 
          UPDATE GRN 
          SET ORDER_NO = :WK_LOADNO,
              ORDER_LINE_NO = :WK_LOAD_LINE_NO
          WHERE GRN = :GRN;
          /* update the po outstanding qty and status */
          WK_PO_FOUND = 0;
          SELECT 1 , PO_LINE_QTY, ORIGINAL_QTY 
          FROM PURCHASE_ORDER_LINE
          WHERE PURCHASE_ORDER = :WK_LOADNO
          AND   PO_LINE = :WK_LOAD_LINE_NO
          INTO :WK_PO_FOUND, :WK_PO_QTY, :WK_PO_ORIG_QTY ;
          IF (WK_PO_FOUND = 1) THEN
          BEGIN
             WK_PO_STATUS = 'OP';
             WK_PO_NEW_QTY = WK_PO_QTY - WK_SSN_CURQTY; 
             IF (WK_PO_NEW_QTY = 0) THEN
             BEGIN
                IF (WK_GRN_TYPE = 'IP') THEN
                BEGIN
                   WK_PO_STATUS = 'IN';
                END
                ELSE
                BEGIN
                   WK_PO_STATUS = 'CL';
                END
             END
             ELSE
             BEGIN
                IF (WK_PO_NEW_QTY < 0) THEN
                BEGIN
                   WK_PO_STATUS = 'OS';
                END
             END
             IF (WK_PO_ORIG_QTY IS NULL) THEN
             BEGIN
                UPDATE PURCHASE_ORDER_LINE
                SET ORIGINAL_QTY = :WK_PO_QTY,
                    PO_LINE_QTY = :WK_PO_NEW_QTY,
                    PO_LINE_STATUS = :WK_PO_STATUS
                WHERE PURCHASE_ORDER = :WK_LOADNO
                AND   PO_LINE = :WK_LOAD_LINE_NO;
             END
             ELSE
             BEGIN
                UPDATE PURCHASE_ORDER_LINE
                SET PO_LINE_QTY = :WK_PO_NEW_QTY,
                    PO_LINE_STATUS = :WK_PO_STATUS
                WHERE PURCHASE_ORDER = :WK_LOADNO
                AND   PO_LINE = :WK_LOAD_LINE_NO;
             END
          END
      END
   END
             
   /* IF ((WK_GRN_TYPE = 'LP') OR 
       (WK_GRN_TYPE = 'IP')) THEN */
   IF (WK_GRN_TYPE = 'LP') THEN 
   BEGIN
       IF (OBJECT <> '') THEN
       BEGIN
           WK_A_PROD = 1;
           WK_GRN_OWNER = '';
           SELECT OWNER_ID 
           FROM GRN 
           WHERE GRN = :GRN
           INTO :WK_GRN_OWNER;
           WK_CMP_FROM = '';
           SELECT DESCRIPTION
           FROM OPTIONS
           WHERE GROUP_CODE = 'CMP'
           AND CODE = 'GRNV'
           INTO :WK_CMP_FROM;
           IF (WK_CMP_FROM IS NULL) THEN
           BEGIN
              WK_CMP_FROM = 'PROD';
           END
           WK_PROD_EXISTS = 0;
           SELECT 1, 
              PROD_TYPE, 
              COMPANY_ID, 
              SHORT_DESC ,
              HOME_LOCN_ID,
              ALTERNATE_ID,
              PALLET_CFG_INNER,
              PALLET_CFG_ALTERNATE,
              ISSUE_UOM,
              ISSUE_PER_ORDER_UNIT,
              ISSUE_PER_INNER_UNIT,
              SPECIAL_INSTR,
              TEMPERATURE_ZONE,
              SSN_TYPE
              FROM PROD_PROFILE
              WHERE PROD_ID = :OBJECT
              INTO :WK_PROD_EXISTS, :WK_PROD_TYPE, :WK_OWNER,
              :WK_PROD_DESC,
              :WK_PUTLOCN_1,
              :WK_ALTPROD,
              :WK_STD_PALLET_CFG,
              :WK_NON_PALLET_CFG,
              :WK_ISSUE_UOM,
              :WK_ORDER_UNITS,
              :WK_INNER_UNITS,
              :WK_INSTR,
              :WK_TEMPERATURE_ZONE,
              :WK_SSN_TYPE;
           IF (WK_PROD_EXISTS = 0) THEN
           BEGIN
               /* Insert into prod_profile */
               INSERT INTO PROD_PROFILE (PROD_ID, SHORT_DESC, LAST_UPDATE_DATE)
                   VALUES (:OBJECT, :OBJECT, 'NOW');
               WK_PROD_DESC = OBJECT;
           END
           IF (WK_PUTLOCN_1 IS NULL) THEN
           BEGIN
              WK_PUTLOCN_1 = '';
           END
           SELECT FIRST 1 WH_ID || LOCN_ID
           FROM LOCATION
           WHERE PROD_ID = :OBJECT
           AND :WK_PUTLOCN_1 <> (WH_ID || LOCN_ID)
           INTO :WK_PUTLOCN_2;
           IF (WK_PUTLOCN_2 IS NULL) THEN
           BEGIN
              WK_PUTLOCN_2 = '';
           END
           IF (WK_PUTLOCN_1 = '' AND WK_PUTLOCN_2 <> '') THEN
           BEGIN
              SELECT FIRST 1 WH_ID || LOCN_ID
              FROM LOCATION
              WHERE PROD_ID = :OBJECT
              AND :WK_PUTLOCN_2 <> (WH_ID || LOCN_ID)
              INTO :WK_PUTLOCN_1;
              IF (WK_PUTLOCN_1 IS NULL) THEN
              BEGIN
                 WK_PUTLOCN_1 = '';
              END
           END
           IF (WK_ALTPROD IS NULL) THEN
           BEGIN
              WK_ALTPROD = '';
           END
           WK_WEIGHT_X = '';
           WK_WEIGHT_UOM = '';
           IF (WK_STD_PALLET_CFG IS NULL) THEN
           BEGIN
              WK_STD_PALLET_CFG = '';
           END
           IF (WK_NON_PALLET_CFG IS NULL) THEN
           BEGIN
              WK_NON_PALLET_CFG = '';
           END
           IF (WK_ISSUE_UOM IS NULL) THEN
           BEGIN
              WK_ISSUE_UOM = '';
           END
           IF (WK_INNER_UNITS IS NULL) THEN
           BEGIN
              WK_INNER_UNITS = 1;
           END
           IF (WK_ORDER_UNITS IS NULL) THEN
           BEGIN
              WK_ORDER_UNITS = 1;
           END
           IF (WK_INSTR IS NULL) THEN
           BEGIN
              WK_INSTR = '';
           END
           IF (WK_TEMPERATURE_ZONE IS NULL) THEN
           BEGIN
                WK_TEMPERATURE_ZONE = '';
           END
           SELECT 
              PALLET_CFG_DESCRIPTION,
              TOTAL_CARTONS_LAYER,
              TOTAL_LAYERS
           FROM PALLET_CFG
           WHERE PALLET_CFG_CODE = :WK_STD_PALLET_CFG
           INTO :WK_STD_PALLET_DESC, :WK_STD_PALLET_CARTONS, :WK_STD_PALLET_LAYERS;
           SELECT 
              PALLET_CFG_DESCRIPTION
           FROM PALLET_CFG
           WHERE PALLET_CFG_CODE = :WK_NON_PALLET_CFG
           INTO :WK_NON_PALLET_DESC ;
           IF (WK_STD_PALLET_DESC IS NULL) THEN
           BEGIN
              WK_STD_PALLET_DESC = WK_STD_PALLET_CFG;
           END
           IF (WK_STD_PALLET_CARTONS IS NULL) THEN
           BEGIN
              WK_STD_PALLET_CARTONS = 1;
           END
           IF (WK_STD_PALLET_LAYERS IS NULL) THEN
           BEGIN
              WK_STD_PALLET_LAYERS = 1;
           END
           IF (WK_NON_PALLET_DESC IS NULL) THEN
           BEGIN
              WK_NON_PALLET_DESC = WK_NON_PALLET_CFG;
           END
           WK_TOT_INNER = WK_ORDER_UNITS / WK_INNER_UNITS;
           WK_TOT_OUTER = WK_STD_PALLET_LAYERS * WK_STD_PALLET_CARTONS;
           WK_SSN_CURQTY = LABEL_NO  * WK_LABEL_CURQTY ;
           /* calc loadno, supplier and default company */
           IF (WK_TRN_CODE = 'P') THEN
           BEGIN
              WK_SUPPLIER = '';
              SELECT RETURN_ID
              FROM GRN
              WHERE GRN = :GRN
              INTO :WK_SUPPLIER;
              IF (WK_SUPPLIER IS NULL) THEN
              BEGIN
                 WK_SUPPLIER = WK_LOADNO;
              END
           END
           ELSE
           BEGIN
              WK_SUPPLIER = WK_LOADNO;
           END
           IF (WK_CMP_FROM = 'GRN') THEN
           BEGIN
              WK_OWNER = WK_GRN_OWNER;
           END
           IF (WK_OWNER IS NULL) THEN
           BEGIN
              SELECT COMPANY_ID FROM CONTROL INTO :WK_OWNER; 
           END
           SELECT ORDER_NO FROM GRN WHERE GRN = :GRN INTO :WK_LOADNO;
           UPDATE GRN 
           SET RETURN_ID = :WK_SUPPLIER
           WHERE GRN = :GRN;
          /* Insert data into SSN table */   
          SELECT COUNT(*) AS CNT FROM SSN WHERE SSN_ID = :W_SSN_ID INTO :WK_COUNT_SSN;
          IF (WK_COUNT_SSN = 0) THEN
          BEGIN
             IF (WK_SSN_TYPE IS NULL) THEN
             BEGIN
                    INSERT INTO SSN (SSN_ID, WH_ID, LOCN_ID, GRN, STATUS_SSN, LABEL_DATE, ORIGINAL_QTY,
                    CURRENT_QTY, PO_ORDER, PO_RECEIVE_DATE, PROD_ID, SSN_DESCRIPTION, PO_LINE, SUPPLIER_ID, COMPANY_ID, SSN_TYPE, CREATE_DATE, CREATED_BY)
                    VALUES (:W_SSN_ID, :WH_ID, :LOCN_ID, :GRN, :WK_PROD_STATUS, 'NOW', :WK_SSN_CURQTY, :WK_SSN_CURQTY, :WK_LOADNO, 'NOW', :OBJECT,:WK_PROD_DESC,:WK_LOAD_LINE_NO, :WK_SUPPLIER, :WK_OWNER, :WK_PROD_TYPE, :TRANS_DATE, :WK_USER);
             END
             ELSE
             BEGIN
                    INSERT INTO SSN (SSN_ID, WH_ID, LOCN_ID, GRN, STATUS_SSN, LABEL_DATE, ORIGINAL_QTY,
                    CURRENT_QTY, PO_ORDER, PO_RECEIVE_DATE, PROD_ID, SSN_DESCRIPTION, PO_LINE, SUPPLIER_ID, COMPANY_ID, SSN_TYPE, CREATE_DATE, CREATED_BY)
                    VALUES (:W_SSN_ID, :WH_ID, :LOCN_ID, :GRN, :WK_PROD_STATUS, 'NOW', :WK_SSN_CURQTY, :WK_SSN_CURQTY, :WK_LOADNO, 'NOW', :OBJECT,:WK_PROD_DESC,:WK_LOAD_LINE_NO, :WK_SUPPLIER, :WK_OWNER, :WK_SSN_TYPE, :TRANS_DATE, :WK_USER);
             END
          END
          ELSE
          BEGIN
               UPDATE SSN SET ORIGINAL_QTY = ORIGINAL_QTY + :WK_SSN_CURQTY, CURRENT_QTY = CURRENT_QTY + :WK_SSN_CURQTY
               WHERE SSN_ID = :W_SSN_ID;
          END
          W_PRODUCT_SSN_ID = W_SSN_ID;
          WK_REASON = 'Received ' || :WK_SSN_CURQTY || ' by User ' || :WK_USER || ' SSN ' || :W_SSN_ID ;
          EXECUTE PROCEDURE ADD_SSN_HIST(:WH_ID, :LOCN_ID, :W_SSN_ID, 
                          :WK_TRN_TYPE, :WK_TRN_CODE, :TRANS_DATE,
                          :WK_REASON, '' , :WK_SSN_CURQTY, :WK_USER, :WK_DEVICE_ID); 
      END
   END
             
   /* Insert data into ISSN table */
   IF ((WK_GENERATE_SSN_METHOD IS NULL) OR ((WK_GENERATE_SSN_METHOD <> '|GRN=4|LINE=2|SUFFIX=2,3|') AND 
    (WK_GENERATE_SSN_METHOD <> 'CMP=2|GRN=6|LINE=2|SFX=2' ))) THEN
   BEGIN
        WHILE (P_SSN_ID < SSN_ID) DO
        BEGIN
          I_SSN_ID = '';
          I_LEN_SSN_ID = STRLEN(P_SSN_ID);
      
          WHILE (I_LEN_SSN_ID < :SSN_LENGTH) DO
          BEGIN
           I_SSN_ID = I_SSN_ID || '0';
           I_LEN_SSN_ID = I_LEN_SSN_ID + 1;
          END
          I_SSN_ID = I_SSN_ID || P_SSN_ID;
          /* 170707 1st issn */
          IF (WK_1ST_ISSN = '') THEN
          BEGIN
             WK_1ST_ISSN = I_SSN_ID;
          END
          IF (WK_A_PROD = 0) THEN
          BEGIN
         /* Insert data into SSN table */   
          INSERT INTO SSN (SSN_ID, WH_ID, LOCN_ID, GRN, STATUS_SSN, LABEL_DATE, ORIGINAL_QTY,
                    CURRENT_QTY, PO_ORDER, PO_RECEIVE_DATE, PO_LINE, SUPPLIER_ID, COMPANY_ID, CREATE_DATE, CREATED_BY)
          VALUES (:I_SSN_ID, :WH_ID, :LOCN_ID, :GRN, :WK_STATUS, 'NOW', :WK_LABEL_CURQTY, :WK_LABEL_CURQTY, :WK_LOADNO, 'NOW',:WK_LOAD_LINE_NO,:WK_SUPPLIER, :WK_OWNER, :TRANS_DATE, :WK_USER);
          INSERT INTO ISSN (SSN_ID, ORIGINAL_SSN, WH_ID, LOCN_ID, CURRENT_QTY,ISSN_STATUS, LABEL_DATE, COMPANY_ID, ORIGINAL_QTY, CREATE_DATE, USER_ID, INTO_DATE)
          VALUES (:I_SSN_ID, :I_SSN_ID, :WH_ID, :LOCN_ID, :WK_LABEL_CURQTY, :WK_STATUS, :TRANS_DATE, :WK_OWNER, :WK_LABEL_CURQTY, :TRANS_DATE, :WK_USER, :TRANS_DATE);
         END
         IF (WK_A_PROD = 1) THEN
         BEGIN
           INSERT INTO ISSN (SSN_ID, ORIGINAL_SSN, WH_ID, LOCN_ID, CURRENT_QTY,ISSN_STATUS, PROD_ID, LABEL_DATE, COMPANY_ID, ORIGINAL_QTY, CREATE_DATE,USER_ID, INTO_DATE)
           VALUES (:I_SSN_ID, :W_SSN_ID, :WH_ID, :LOCN_ID, :WK_LABEL_CURQTY, :WK_PROD_STATUS, :OBJECT, 'NOW', :WK_OWNER, :WK_LABEL_CURQTY, :TRANS_DATE, :WK_USER, :TRANS_DATE );
         END
      
         P_SSN_ID = P_SSN_ID + 1;
    END /* THIS IS WHERE GENERATION OF ISSN AND SSN ENDS WHEN P_SSN_ID < SSN_ID */
   END /* IF NOT OF TYPE |GRN=4|LINE=2|SUFFIX=2,3| */
   
   IF (WK_GENERATE_SSN_METHOD = '|GRN=4|LINE=2|SUFFIX=2,3|' ) THEN
   BEGIN
        I_PALLET_NO = 0;
        WHILE (I_PALLET_NO < LABEL_NO) DO
        BEGIN
           SELECT LAST_PALLET_NO FROM GRN WHERE GRN = :GRN INTO :WK_LAST_PALLET_NO;
           WK_LAST_PALLET_NO = WK_LAST_PALLET_NO + 1;
           UPDATE GRN SET LAST_PALLET_NO = :WK_LAST_PALLET_NO WHERE GRN = :GRN;
           IF (WK_LAST_PALLET_NO < 10) THEN
           BEGIN
              P_LAST_PALLET_NO = '0' || WK_LAST_PALLET_NO;
           END
           ELSE
           BEGIN
             P_LAST_PALLET_NO = WK_LAST_PALLET_NO;
           END
          I_SSN_ID = GRN || P_LAST_LINE_NO || P_LAST_PALLET_NO;
          IF (WK_1ST_ISSN = '') THEN
          BEGIN
             WK_1ST_ISSN = I_SSN_ID;
          END
          IF (WK_A_PROD = 0) THEN /* IF LD */
          BEGIN
         /* Insert data into SSN table */
          INSERT INTO SSN (SSN_ID, WH_ID, LOCN_ID, GRN, STATUS_SSN, LABEL_DATE, ORIGINAL_QTY,
                    CURRENT_QTY, PO_ORDER, PO_RECEIVE_DATE, PO_LINE, SUPPLIER_ID, COMPANY_ID, CREATE_DATE, CREATED_BY)
          VALUES (:I_SSN_ID, :WH_ID, :LOCN_ID, :GRN, :WK_STATUS, 'NOW', :WK_LABEL_CURQTY, :WK_LABEL_CURQTY, :WK_LOADNO, 'NOW',:WK_LOAD_LINE_NO,:WK_SUPPLIER, :WK_OWNER, :TRANS_DATE, :WK_USER);
          INSERT INTO ISSN (SSN_ID, ORIGINAL_SSN, WH_ID, LOCN_ID, CURRENT_QTY,ISSN_STATUS, LABEL_DATE, COMPANY_ID, ORIGINAL_QTY, CREATE_DATE, USER_ID, INTO_DATE)
          VALUES (:I_SSN_ID, :I_SSN_ID, :WH_ID, :LOCN_ID, :WK_LABEL_CURQTY, :WK_STATUS, :TRANS_DATE, :WK_OWNER, :WK_LABEL_CURQTY, :TRANS_DATE, :WK_USER, :TRANS_DATE);
         END
         IF (WK_A_PROD = 1) THEN /* IF <> LD */
         BEGIN
           INSERT INTO ISSN (SSN_ID, ORIGINAL_SSN, WH_ID, LOCN_ID, CURRENT_QTY,ISSN_STATUS, PROD_ID, LABEL_DATE, COMPANY_ID, ORIGINAL_QTY, CREATE_DATE,USER_ID, INTO_DATE)
           VALUES (:I_SSN_ID, :W_SSN_ID, :WH_ID, :LOCN_ID, :WK_LABEL_CURQTY, :WK_PROD_STATUS, :OBJECT, 'NOW', :WK_OWNER, :WK_LABEL_CURQTY, :TRANS_DATE, :WK_USER, :TRANS_DATE );
         END
         I_PALLET_NO = I_PALLET_NO + 1;
        END /* WHILE I_PALLETNO < LABEL_NO */
   END /* if ssn method is |GRN=4|LINE=2|SUFFIX=2,3| */
   IF (WK_GENERATE_SSN_METHOD = 'CMP=2|GRN=6|LINE=2|SFX=2' ) THEN
   BEGIN
        I_PALLET_NO = 0;
        WHILE (I_PALLET_NO < LABEL_NO) DO
        BEGIN
           /* DURING UPDATES THIS UPDATE WILL BE WITHIN A SESSION. THERE IS A MINOR CHANCE OF TWO PALLETS HAVING THE SAME NUMBER AS THIS CHANGE CANNOT BE COMMITTED IN A TRIGGER */
           SELECT LAST_PALLET_NO FROM GRN WHERE GRN = :GRN INTO :WK_LAST_PALLET_NO;
           IF (STRLEN(WK_GRN_LOT) > 0) THEN
           BEGIN
              WK_LAST_LOT_PALLET_NO = 0;
              /* SELECT MAX(LAST_PALLET_NO) FROM GRN WHERE LAST_LOT_NO = :WK_GRN_LOT INTO :WK_LAST_LOT_PALLET_NO; */
              SELECT MAX(LAST_PALLET_NO) FROM GRN WHERE LAST_LOT_NO STARTING SUBSTR(:WK_GRN_LOT,1,8) INTO :WK_LAST_LOT_PALLET_NO;
              IF (WK_LAST_LOT_PALLET_NO IS NULL) THEN
              BEGIN
                 WK_LAST_LOT_PALLET_NO = WK_LAST_PALLET_NO;
              END
              IF (WK_LAST_LOT_PALLET_NO > WK_LAST_PALLET_NO) THEN
              BEGIN
                 WK_LAST_PALLET_NO = WK_LAST_LOT_PALLET_NO;
              END
           END
           WK_LAST_PALLET_NO = WK_LAST_PALLET_NO + 1;
           UPDATE GRN SET LAST_PALLET_NO = :WK_LAST_PALLET_NO WHERE GRN = :GRN;
           IF (WK_LAST_PALLET_NO < 10) THEN
           BEGIN
              P_LAST_PALLET_NO = '0' || WK_LAST_PALLET_NO;
           END
           ELSE
           BEGIN
             P_LAST_PALLET_NO = WK_LAST_PALLET_NO;
           END
        /* tHE FIRST TIME THE LAST_PALLET_NO IS ALWAYS 0 */
          I_SSN_ID = WK_OWNER_PFX || WK_OWNER_GRN || P_LAST_LINE_NO || P_LAST_PALLET_NO;
          IF (WK_1ST_ISSN = '') THEN
          BEGIN
             WK_1ST_ISSN = I_SSN_ID;
          END
          IF (WK_A_PROD = 0) THEN /* IF LD */
          BEGIN
         /* Insert data into SSN table */
          INSERT INTO SSN (SSN_ID, WH_ID, LOCN_ID, GRN, STATUS_SSN, LABEL_DATE, ORIGINAL_QTY,
                    CURRENT_QTY, PO_ORDER, PO_RECEIVE_DATE, PO_LINE, SUPPLIER_ID, COMPANY_ID, CREATE_DATE, CREATED_BY)
          VALUES (:I_SSN_ID, :WH_ID, :LOCN_ID, :GRN, :WK_STATUS, 'NOW', :WK_LABEL_CURQTY, :WK_LABEL_CURQTY, :WK_LOADNO, 'NOW',:WK_LOAD_LINE_NO,:WK_SUPPLIER, :WK_OWNER, :TRANS_DATE, :WK_USER);
          INSERT INTO ISSN (SSN_ID, ORIGINAL_SSN, WH_ID, LOCN_ID, CURRENT_QTY,ISSN_STATUS, LABEL_DATE, COMPANY_ID, ORIGINAL_QTY, CREATE_DATE, USER_ID, INTO_DATE)
          VALUES (:I_SSN_ID, :I_SSN_ID, :WH_ID, :LOCN_ID, :WK_LABEL_CURQTY, :WK_STATUS, :TRANS_DATE, :WK_OWNER, :WK_LABEL_CURQTY, :TRANS_DATE, :WK_USER, :TRANS_DATE);
         END
         IF (WK_A_PROD = 1) THEN /* IF <> LD */
         BEGIN
           INSERT INTO ISSN (SSN_ID, ORIGINAL_SSN, WH_ID, LOCN_ID, CURRENT_QTY,ISSN_STATUS, PROD_ID, LABEL_DATE, COMPANY_ID, ORIGINAL_QTY, CREATE_DATE,USER_ID, INTO_DATE)
           VALUES (:I_SSN_ID, :W_SSN_ID, :WH_ID, :LOCN_ID, :WK_LABEL_CURQTY, :WK_PROD_STATUS, :OBJECT, 'NOW', :WK_OWNER, :WK_LABEL_CURQTY, :TRANS_DATE, :WK_USER, :TRANS_DATE );
         END
         I_PALLET_NO = I_PALLET_NO + 1;
        END /* WHILE I_PALLETNO < LABEL_NO */
   END /* if ssn method is 'CMP=2|GRN=6|LINE=2|SFX=2' */
   WK_RESPONSE_TXT = WK_RESPONSE_TXT || :WK_1ST_ISSN || '|' || :WK_SSNQTY1 || '|' || :WK_LABELQTY1 || '|';   
   WK_RESPONSE_TXT1 = :WK_1ST_ISSN || '|' || :WK_SSNQTY1 || '|' || :WK_LABELQTY1 ;
   WK_SAVED_ISSN = WK_1ST_ISSN;
   IF (WK_A_PROD = 1) THEN
   BEGIN
      UPDATE PICK_ITEM SET PICK_LINE_STATUS = 'OP'
      WHERE PICK_ITEM.PROD_ID = :OBJECT
      AND PICK_ITEM.PICK_LINE_STATUS = 'AS'
      AND EXISTS ( SELECT PICK_ORDER.PICK_ORDER FROM PICK_ORDER
         WHERE PICK_ORDER.PICK_ORDER = PICK_ITEM.PICK_ORDER
           AND PICK_ORDER.COMPANY_ID = :WK_OWNER
           AND PICK_ORDER.WH_ID = :WH_ID 
           AND PICK_STATUS IN ('DA','OP','UC','CF') );
   END
   IF (WK_A_PROD = 1) THEN
   BEGIN
      UPDATE PICK_ITEM SET PICK_LINE_STATUS = 'OP'
      WHERE PICK_ITEM.SSN_ID = :W_PRODUCT_SSN_ID
      AND PICK_ITEM.PICK_LINE_STATUS = 'AS'
      AND EXISTS ( SELECT PICK_ORDER.PICK_ORDER FROM PICK_ORDER
         WHERE PICK_ORDER.PICK_ORDER = PICK_ITEM.PICK_ORDER
           AND PICK_ORDER.COMPANY_ID = :WK_OWNER
           AND PICK_ORDER.WH_ID = :WH_ID 
           AND PICK_STATUS IN ('DA','OP','UC','CF') );
   END
IF (WK_GENERATE_LABEL_TEXT = 'T') THEN
BEGIN
   /* need the directory for this label set */
   SELECT WORKING_DIRECTORY FROM SYS_EQUIP 
       WHERE DEVICE_ID = :WK_PRINTER
       INTO :WK_DIRECTORY;
   IF (WK_A_PROD = 0) THEN
   BEGIN
      WK_FILENAME = WK_DIRECTORY || 'LOAD.1xt';
      WK_LABEL_LINE = '"' || W_SSN_ID || '","' ||
          WK_LOADNO || '","' ||
          LABEL_NO || '"';
      WK_HAVE_FILE_1 = 1;
      WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE);
      IF (WK_RESULT <> 0) THEN
      BEGIN
         WK_FILENAME = WK_DIRECTORY || 'LOAD.2xt';
         WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE);
         WK_HAVE_FILE_1 = -1;
      END
      
   END
   IF (WK_A_PROD = 1) THEN
   BEGIN
      /* must get products desc  */
      WK_DATE = MER_DAY(TRANS_DATE) || '/' || MER_MONTH(TRANS_DATE) || '/' || SUBSTR(CAST(MER_YEAR(TRANS_DATE) AS CHAR(4)) , 3,4);
      WK_TIME = MER_HOUR(TRANS_DATE) || ':' || MER_MINUTE(TRANS_DATE) ;
      WK_DATE = WK_DATE || ' ' || WK_TIME;
      WK_FILENAME = WK_DIRECTORY || 'Product.1xt';
      WK_HAVE_FILE_1 = 1;
      IF (WK_A_PO = 0) THEN
      BEGIN
         WK_LABEL_LINE = '"' || W_SSN_ID || '","' || 
             WK_LABELQTY1 || '","' || 
             OBJECT || '","' || 
             WK_PROD_DESC || '","' || 
             WK_DATE || '","' || 
             WK_SSNQTY1 || '","' || 
             WK_WEIGHT_X || '","' ||
             WK_WEIGHT_UOM || '","' ||
             WK_PUTLOCN_1 || '","' ||
             WK_PUTLOCN_2 || '","' ||
             WK_LOADNO || '","' ||
             GRN || '","' ||
             W_PRODUCT_SSN_ID || '","' ||
             WK_ALTPROD || '","' ||
             WK_STD_PALLET_DESC || '","' ||
             WK_NON_PALLET_DESC || '","' ||
             WK_ISSUE_UOM || '","' ||
             WK_TOT_INNER || '","' ||
             WK_TOT_OUTER || '","' ||
             WK_INSTR || '","' ||
             WK_PRINTER  || '","' ||
             WK_TEMPERATURE_ZONE || '"'  ;
      END
      ELSE
      BEGIN
         WK_LABEL_LINE = '"' || W_SSN_ID || '","' || 
             WK_LABELQTY1 || '","' || 
             OBJECT || '","' || 
             WK_PROD_DESC || '","' || 
             WK_DATE || '","' || 
             WK_SSNQTY1 || '","' ||
             WK_WEIGHT_X || '","' ||
             WK_WEIGHT_UOM || '","' ||
             WK_PUTLOCN_1 || '","' ||
             WK_PUTLOCN_2 || '","' ||
             WK_LOADNO || '","' ||
             GRN || '","' ||
             W_PRODUCT_SSN_ID || '","' ||
             WK_ALTPROD || '","' ||
             WK_STD_PALLET_DESC || '","' ||
             WK_NON_PALLET_DESC || '","' ||
             WK_ISSUE_UOM || '","' ||
              WK_TOT_INNER || '","' ||
             WK_TOT_OUTER || '","' ||
             WK_INSTR || '","' ||
             WK_PRINTER || '","' ||
             WK_TEMPERATURE_ZONE || '"' ;
      END
      WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE);
      IF (WK_RESULT <> 0) THEN
      BEGIN
         WK_FILENAME = WK_DIRECTORY || 'Product.2xt';
         WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE);
         WK_HAVE_FILE_1 = -1;
      END
   END
END /* LABEL TEXT FILES ONLY IF GENERATE_LABEL_TEXT = 'T' */
   /* EXECUTE PROCEDURE GET_REFERENCE_FIELD :REFERENCE, 6  RETURNING_VALUES :WK_SSNQTY2 ;  */
   /* EXECUTE PROCEDURE GET_REFERENCE_FIELD :REFERENCE, 7  RETURNING_VALUES :WK_LABELQTY2 ; */
   LABEL_NO = CAST(WK_SSNQTY2 AS INTEGER);
   WK_LABEL_CURQTY = CAST(WK_LABELQTY2 AS INTEGER);
   WK_1ST_ISSN = '';
   IF ((LABEL_NO * WK_LABEL_CURQTY) > 0) THEN
   BEGIN
   IF ((WK_GENERATE_SSN_METHOD IS NULL) OR ((WK_GENERATE_SSN_METHOD <> '|GRN=4|LINE=2|SUFFIX=2,3|') AND 
    (WK_GENERATE_SSN_METHOD <> 'CMP=2|GRN=6|LINE=2|SFX=2' ))) THEN
   BEGIN
      SSN_ID = GEN_ID(ISSN_SSN_ID, :LABEL_NO);
      P_SSN_ID = SSN_ID - :LABEL_NO;
      LEN_SSN_ID = STRLEN(P_SSN_ID);     
            
      W_SSN_ID = '';
      /* Padding leading with 0 */
      WHILE (LEN_SSN_ID < :SSN_LENGTH) DO
      BEGIN
         W_SSN_ID = W_SSN_ID || '0';      
         LEN_SSN_ID = LEN_SSN_ID + 1;
      END
      W_SSN_ID = W_SSN_ID || P_SSN_ID;
   END
   
   IF (WK_GENERATE_SSN_METHOD = '|GRN=4|LINE=2|SUFFIX=2,3|' ) THEN
   BEGIN
        SELECT LAST_LINE_NO, LAST_PALLET_NO FROM GRN WHERE GRN = :GRN INTO :WK_LAST_LINE_NO, :WK_LAST_PALLET_NO;
        IF (:WK_LAST_LINE_NO IS NULL) THEN
        BEGIN
               /* i AM UNSURE ABOUT THIS AS LINE NUMBER ACCORDING TO ME SHOULD NOT BE INCREMENTED.S */
              WK_LAST_LINE_NO = 0;
        END
        IF (WK_LOAD_LINE_NO = '') THEN
        BEGIN
             WK_LAST_LINE_NO = WK_LAST_LINE_NO; /* no increment of the line no */
             UPDATE GRN SET LAST_LINE_NO = :WK_LAST_LINE_NO WHERE GRN = :GRN;
        END
        ELSE
        BEGIN
             WK_LAST_LINE_NO = WK_LOAD_LINE_NO;
        END
        IF (WK_LAST_LINE_NO < 10) THEN
        BEGIN
             P_LAST_LINE_NO = '0' || WK_LAST_LINE_NO;
        END
        ELSE
        BEGIN
             P_LAST_LINE_NO = WK_LAST_LINE_NO;
        END
        IF (WK_LAST_PALLET_NO IS NULL) THEN
        BEGIN
             WK_LAST_PALLET_NO = 0;
        END
        IF (WK_LAST_PALLET_NO < 10) THEN
        BEGIN
             P_LAST_PALLET_NO = '0' || WK_LAST_PALLET_NO;
        END
        ELSE
        BEGIN
             P_LAST_PALLET_NO = WK_LAST_PALLET_NO;
        END
        UPDATE GRN SET LAST_PALLET_NO = :WK_LAST_PALLET_NO WHERE GRN = :GRN;
        /* tHE FIRST TIME THE LAST_PALLET_NO IS ALWAYS 0 */
        W_SSN_ID = GRN || P_LAST_LINE_NO || '00';
   END /* if ssn method is |GRN=4|LINE=2|SUFFIX=2,3| */
   IF (WK_GENERATE_SSN_METHOD = 'CMP=2|GRN=6|LINE=2|SFX=2' ) THEN
   BEGIN
        SELECT LAST_LINE_NO, LAST_PALLET_NO, LAST_LOT_NO FROM GRN WHERE GRN = :GRN INTO :WK_LAST_LINE_NO, :WK_LAST_PALLET_NO, :WK_GRN_LOT;
        IF (:WK_LAST_LINE_NO IS NULL) THEN
        BEGIN
              WK_LAST_LINE_NO = 0;
        END
        IF (WK_LOAD_LINE_NO = '') THEN
        BEGIN
             WK_LAST_LINE_NO = WK_LAST_LINE_NO; /* no increment of the line no */
             UPDATE GRN SET LAST_LINE_NO = :WK_LAST_LINE_NO WHERE GRN = :GRN;
        END
        ELSE
        BEGIN
        /* THE LAST LINE NUMBER HAS BEEN PASSED FROM THE FRONT END SCREEN. NO UPDATE TO GRN REQUIRED. */
             WK_LAST_LINE_NO = WK_LOAD_LINE_NO;
        END
        IF (WK_LAST_LINE_NO < 10) THEN
        BEGIN
             P_LAST_LINE_NO = '0' || WK_LAST_LINE_NO;
        END
        ELSE
        BEGIN
             P_LAST_LINE_NO = WK_LAST_LINE_NO;
        END
        IF (WK_LAST_PALLET_NO IS NULL) THEN
        BEGIN
             WK_LAST_PALLET_NO = 0;
        END
        IF (WK_LAST_PALLET_NO < 10) THEN
        BEGIN
             P_LAST_PALLET_NO = '0' || WK_LAST_PALLET_NO;
        END
        ELSE
        BEGIN
             P_LAST_PALLET_NO = WK_LAST_PALLET_NO;
        END
        IF (:WK_GRN_LOT IS NULL) THEN
        BEGIN
              WK_GRN_LOT = '';
        END
        UPDATE GRN SET LAST_PALLET_NO = :WK_LAST_PALLET_NO WHERE GRN = :GRN;
        /* tHE FIRST TIME THE LAST_PALLET_NO IS ALWAYS 0 */
        IF (STRLEN(WK_GRN_LOT) > 0) THEN
        BEGIN
           WK_OWNER_PFX = SUBSTR(WK_GRN_LOT, 1, 2);
           WK_OWNER_GRN = SUBSTR(WK_GRN_LOT, 3, 8);
           P_LAST_LINE_NO = SUBSTR(WK_GRN_LOT, 9, 10);
        END
        W_SSN_ID = WK_OWNER_PFX || WK_OWNER_GRN || P_LAST_LINE_NO || '00';
   END /* if ssn method is 'CMP=2|GRN=6|LINE=2|SFX=2' */
      IF (WK_A_PROD = 1) THEN
      BEGIN
           WK_SSN_CURQTY = LABEL_NO  * WK_LABEL_CURQTY ;
          /* Insert data into SSN table */   
            UPDATE SSN SET CURRENT_QTY = CURRENT_QTY + :WK_SSN_CURQTY, ORIGINAL_QTY = ORIGINAL_QTY + :WK_SSN_CURQTY WHERE SSN_ID = :W_PRODUCT_SSN_ID ; 
            WK_REASON = 'Received ' || :WK_SSN_CURQTY || ' by User ' || :WK_USER || ' SSN ' || :W_PRODUCT_SSN_ID ;
            EXECUTE PROCEDURE ADD_SSN_HIST(:WH_ID, :LOCN_ID, :W_PRODUCT_SSN_ID, 
                          :WK_TRN_TYPE, :WK_TRN_CODE, :TRANS_DATE,
                          :WK_REASON, '' , :WK_SSN_CURQTY, :WK_USER, :WK_DEVICE_ID); 
         IF ((WK_GRN_TYPE = 'PO') OR
             (WK_GRN_TYPE = 'RA') OR  
             (WK_GRN_TYPE = 'TR') OR
             (WK_GRN_TYPE = 'IP') OR
             (WK_GRN_TYPE = 'WO')) THEN
         BEGIN
          /* update the po outstanding qty and status */
          WK_PO_QTY = WK_PO_NEW_QTY;
          IF (WK_PO_FOUND = 1) THEN
          BEGIN
             WK_PO_NEW_QTY = WK_PO_QTY - WK_SSN_CURQTY; 
             IF (WK_PO_NEW_QTY = 0) THEN
             BEGIN
                IF (WK_GRN_TYPE = 'IP') THEN
                BEGIN
                   WK_PO_STATUS = 'IN';
                END
                ELSE
                BEGIN
                   WK_PO_STATUS = 'CL';
                END
             END
             ELSE
             BEGIN
                IF (WK_PO_NEW_QTY < 0) THEN
                BEGIN
                   WK_PO_STATUS = 'OS';
                END
             END
             UPDATE PURCHASE_ORDER_LINE
             SET PO_LINE_QTY = :WK_PO_NEW_QTY,
                 PO_LINE_STATUS = :WK_PO_STATUS
             WHERE PURCHASE_ORDER = :WK_LOADNO
             AND   PO_LINE = :WK_LOAD_LINE_NO;
          END
         END
      END
      
      /* Insert data into ISSN table */
   IF ((WK_GENERATE_SSN_METHOD IS NULL) OR ((WK_GENERATE_SSN_METHOD <> '|GRN=4|LINE=2|SUFFIX=2,3|') AND 
    (WK_GENERATE_SSN_METHOD <> 'CMP=2|GRN=6|LINE=2|SFX=2' ))) THEN
   BEGIN
      WHILE (P_SSN_ID < SSN_ID) DO
      BEGIN
         I_SSN_ID = '';
         I_LEN_SSN_ID = STRLEN(P_SSN_ID);
         
         /* Padding leading with 0 */
         WHILE (I_LEN_SSN_ID < :SSN_LENGTH) DO
         BEGIN
          I_SSN_ID = I_SSN_ID || '0';
          I_LEN_SSN_ID = I_LEN_SSN_ID + 1;
         END
         I_SSN_ID = I_SSN_ID || P_SSN_ID;
         IF (WK_1ST_ISSN = '') THEN
         BEGIN
            WK_1ST_ISSN = I_SSN_ID;
         END
         
         IF (WK_A_PROD = 0) THEN
         BEGIN
            /* Insert data into SSN table */   
            INSERT INTO SSN (SSN_ID, WH_ID, LOCN_ID, GRN, STATUS_SSN, LABEL_DATE, ORIGINAL_QTY,
                    CURRENT_QTY, PO_ORDER, PO_RECEIVE_DATE, PO_LINE, SUPPLIER_ID, COMPANY_ID, CREATE_DATE, CREATED_BY)
            VALUES (:I_SSN_ID, :WH_ID, :LOCN_ID, :GRN, :WK_STATUS, 'NOW', :WK_LABEL_CURQTY, :WK_LABEL_CURQTY, :WK_LOADNO, 'NOW', :WK_LOAD_LINE_NO, :WK_SUPPLIER, :WK_OWNER, :TRANS_DATE, :WK_USER);     
            INSERT INTO ISSN (SSN_ID, ORIGINAL_SSN, WH_ID, LOCN_ID, CURRENT_QTY, ISSN_STATUS, LABEL_DATE, COMPANY_ID, ORIGINAL_QTY, CREATE_DATE, USER_ID, INTO_DATE)
            VALUES (:I_SSN_ID, :I_SSN_ID, :WH_ID, :LOCN_ID, :WK_LABEL_CURQTY, :WK_STATUS, 'NOW', :WK_OWNER, :WK_LABEL_CURQTY, :TRANS_DATE, :WK_USER, :TRANS_DATE); 
         END
         IF (WK_A_PROD = 1) THEN
         BEGIN
            INSERT INTO ISSN (SSN_ID, ORIGINAL_SSN, WH_ID, LOCN_ID, CURRENT_QTY, ISSN_STATUS, PROD_ID, LABEL_DATE, COMPANY_ID, ORIGINAL_QTY, CREATE_DATE, USER_ID, INTO_DATE)
            VALUES (:I_SSN_ID, :W_PRODUCT_SSN_ID, :WH_ID, :LOCN_ID, :WK_LABEL_CURQTY, :WK_PROD_STATUS, :OBJECT, 'NOW', :WK_OWNER, :WK_LABEL_CURQTY, :TRANS_DATE, :WK_USER, :TRANS_DATE); 
         END
      
         P_SSN_ID = P_SSN_ID + 1;
         END
      END /* IF SSN_METHOD */
   IF (WK_GENERATE_SSN_METHOD = '|GRN=4|LINE=2|SUFFIX=2,3|' ) THEN
   BEGIN
        I_PALLET_NO = 0;
        WHILE (I_PALLET_NO < LABEL_NO) DO
        BEGIN
           SELECT LAST_PALLET_NO FROM GRN WHERE GRN = :GRN INTO :WK_LAST_PALLET_NO;
           WK_LAST_PALLET_NO = WK_LAST_PALLET_NO + 1;
           UPDATE GRN SET LAST_PALLET_NO = :WK_LAST_PALLET_NO WHERE GRN = :GRN;
           IF (WK_LAST_PALLET_NO < 10) THEN
           BEGIN
              P_LAST_PALLET_NO = '0' || WK_LAST_PALLET_NO;
           END
           ELSE
           BEGIN
             P_LAST_PALLET_NO = WK_LAST_PALLET_NO;
           END
        /* tHE FIRST TIME THE LAST_PALLET_NO IS ALWAYS 0 */
          I_SSN_ID = GRN || P_LAST_LINE_NO || P_LAST_PALLET_NO;
          IF (WK_1ST_ISSN = '') THEN
          BEGIN
             WK_1ST_ISSN = I_SSN_ID;
          END
         IF (WK_A_PROD = 0) THEN
         BEGIN
            /* Insert data into SSN table */
            INSERT INTO SSN (SSN_ID, WH_ID, LOCN_ID, GRN, STATUS_SSN, LABEL_DATE, ORIGINAL_QTY,
                    CURRENT_QTY, PO_ORDER, PO_RECEIVE_DATE, PO_LINE, SUPPLIER_ID, COMPANY_ID, CREATE_DATE, CREATED_BY)
            VALUES (:I_SSN_ID, :WH_ID, :LOCN_ID, :GRN, :WK_STATUS, 'NOW', :WK_LABEL_CURQTY, :WK_LABEL_CURQTY, :WK_LOADNO, 'NOW', :WK_LOAD_LINE_NO, :WK_SUPPLIER, :WK_OWNER, :TRANS_DATE, :WK_USER);
            INSERT INTO ISSN (SSN_ID, ORIGINAL_SSN, WH_ID, LOCN_ID, CURRENT_QTY, ISSN_STATUS, LABEL_DATE, COMPANY_ID, ORIGINAL_QTY, CREATE_DATE, USER_ID, INTO_DATE)
            VALUES (:I_SSN_ID, :I_SSN_ID, :WH_ID, :LOCN_ID, :WK_LABEL_CURQTY, :WK_STATUS, 'NOW', :WK_OWNER, :WK_LABEL_CURQTY, :TRANS_DATE, :WK_USER, :TRANS_DATE);
         END
         IF (WK_A_PROD = 1) THEN
         BEGIN
            INSERT INTO ISSN (SSN_ID, ORIGINAL_SSN, WH_ID, LOCN_ID, CURRENT_QTY, ISSN_STATUS, PROD_ID, LABEL_DATE, COMPANY_ID, ORIGINAL_QTY, CREATE_DATE, USER_ID, INTO_DATE)
            VALUES (:I_SSN_ID, :W_PRODUCT_SSN_ID, :WH_ID, :LOCN_ID, :WK_LABEL_CURQTY, :WK_PROD_STATUS, :OBJECT, 'NOW', :WK_OWNER, :WK_LABEL_CURQTY, :TRANS_DATE, :WK_USER, :TRANS_DATE);
         END
         I_PALLET_NO = I_PALLET_NO + 1;
        END /* WHILE I_PALLETNO < LABEL_NO */
   END /* if ssn method is |GRN=4|LINE=2|SUFFIX=2,3| */
   IF (WK_GENERATE_SSN_METHOD = 'CMP=2|GRN=6|LINE=2|SFX=2' ) THEN
   BEGIN
        I_PALLET_NO = 0;
        WHILE (I_PALLET_NO < LABEL_NO) DO
        BEGIN
           /* DURING UPDATES THIS UPDATE WILL BE WITHIN A SESSION. THERE IS A MINOR CHANCE OF TWO PALLETS HAVING THE SAME NUMBER AS THIS CHANGE CANNOT BE COMMITTED IN A TRIGGER */
           SELECT LAST_PALLET_NO FROM GRN WHERE GRN = :GRN INTO :WK_LAST_PALLET_NO;
           IF (STRLEN(WK_GRN_LOT) > 0) THEN
           BEGIN
              WK_LAST_LOT_PALLET_NO = 0;
              /* SELECT MAX(LAST_PALLET_NO) FROM GRN WHERE LAST_LOT_NO = :WK_GRN_LOT INTO :WK_LAST_LOT_PALLET_NO; */
              SELECT MAX(LAST_PALLET_NO) FROM GRN WHERE LAST_LOT_NO STARTING SUBSTR(:WK_GRN_LOT,1,8) INTO :WK_LAST_LOT_PALLET_NO;
              IF (WK_LAST_LOT_PALLET_NO IS NULL) THEN
              BEGIN
                 WK_LAST_LOT_PALLET_NO = WK_LAST_PALLET_NO;
              END
              IF (WK_LAST_LOT_PALLET_NO > WK_LAST_PALLET_NO) THEN
              BEGIN
                 WK_LAST_PALLET_NO = WK_LAST_LOT_PALLET_NO;
              END
           END
           WK_LAST_PALLET_NO = WK_LAST_PALLET_NO + 1;
           UPDATE GRN SET LAST_PALLET_NO = :WK_LAST_PALLET_NO WHERE GRN = :GRN;
           IF (WK_LAST_PALLET_NO < 10) THEN
           BEGIN
              P_LAST_PALLET_NO = '0' || WK_LAST_PALLET_NO;
           END
           ELSE
           BEGIN
             P_LAST_PALLET_NO = WK_LAST_PALLET_NO;
           END
        /* tHE FIRST TIME THE LAST_PALLET_NO IS ALWAYS 0 */
          I_SSN_ID = WK_OWNER_PFX || WK_OWNER_GRN || P_LAST_LINE_NO || P_LAST_PALLET_NO;
          /* 170707 1st issn */
          IF (WK_1ST_ISSN = '') THEN
          BEGIN
             WK_1ST_ISSN = I_SSN_ID;
          END
         IF (WK_A_PROD = 0) THEN
         BEGIN
            /* Insert data into SSN table */
            INSERT INTO SSN (SSN_ID, WH_ID, LOCN_ID, GRN, STATUS_SSN, LABEL_DATE, ORIGINAL_QTY,
                    CURRENT_QTY, PO_ORDER, PO_RECEIVE_DATE, PO_LINE, SUPPLIER_ID, COMPANY_ID, CREATE_DATE, CREATED_BY)
            VALUES (:I_SSN_ID, :WH_ID, :LOCN_ID, :GRN, :WK_STATUS, 'NOW', :WK_LABEL_CURQTY, :WK_LABEL_CURQTY, :WK_LOADNO, 'NOW', :WK_LOAD_LINE_NO, :WK_SUPPLIER, :WK_OWNER, :TRANS_DATE, :WK_USER);
            INSERT INTO ISSN (SSN_ID, ORIGINAL_SSN, WH_ID, LOCN_ID, CURRENT_QTY, ISSN_STATUS, LABEL_DATE, COMPANY_ID, ORIGINAL_QTY, CREATE_DATE, USER_ID, INTO_DATE)
            VALUES (:I_SSN_ID, :I_SSN_ID, :WH_ID, :LOCN_ID, :WK_LABEL_CURQTY, :WK_STATUS, 'NOW', :WK_OWNER, :WK_LABEL_CURQTY, :TRANS_DATE, :WK_USER, :TRANS_DATE);
         END
         IF (WK_A_PROD = 1) THEN
         BEGIN
            INSERT INTO ISSN (SSN_ID, ORIGINAL_SSN, WH_ID, LOCN_ID, CURRENT_QTY, ISSN_STATUS, PROD_ID, LABEL_DATE, COMPANY_ID, ORIGINAL_QTY, CREATE_DATE, USER_ID, INTO_DATE)
            VALUES (:I_SSN_ID, :W_PRODUCT_SSN_ID, :WH_ID, :LOCN_ID, :WK_LABEL_CURQTY, :WK_PROD_STATUS, :OBJECT, 'NOW', :WK_OWNER, :WK_LABEL_CURQTY, :TRANS_DATE, :WK_USER, :TRANS_DATE);
         END
         I_PALLET_NO = I_PALLET_NO + 1;
        END /* WHILE I_PALLETNO < LABEL_NO */
   END /* if ssn method is 'CMP=2|GRN=6|LINE=2|SFX=2' */
   IF (WK_A_PROD = 1) THEN
   BEGIN
      UPDATE PICK_ITEM SET PICK_LINE_STATUS = 'OP'
      WHERE PICK_ITEM.PROD_ID = :OBJECT
      AND PICK_ITEM.PICK_LINE_STATUS = 'AS'
      AND EXISTS ( SELECT PICK_ORDER.PICK_ORDER FROM PICK_ORDER
         WHERE PICK_ORDER.PICK_ORDER = PICK_ITEM.PICK_ORDER
           AND PICK_ORDER.COMPANY_ID = :WK_OWNER
           AND PICK_ORDER.WH_ID = :WH_ID 
           AND PICK_STATUS IN ('DA','OP','UC','CF') );
   END
   IF (WK_A_PROD = 1) THEN
   BEGIN
      UPDATE PICK_ITEM SET PICK_LINE_STATUS = 'OP'
      WHERE PICK_ITEM.SSN_ID = :W_PRODUCT_SSN_ID
      AND PICK_ITEM.PICK_LINE_STATUS = 'AS'
      AND EXISTS ( SELECT PICK_ORDER.PICK_ORDER FROM PICK_ORDER
         WHERE PICK_ORDER.PICK_ORDER = PICK_ITEM.PICK_ORDER
           AND PICK_ORDER.COMPANY_ID = :WK_OWNER
           AND PICK_ORDER.WH_ID = :WH_ID 
           AND PICK_STATUS IN ('DA','OP','UC','CF') );
   END
   WK_RESPONSE_TXT = :WK_RESPONSE_TXT || :WK_1ST_ISSN || '|' || :WK_SSNQTY2 || '|' || :WK_LABELQTY2 || '|' || :WK_PRINTER || '|' ;   
   WK_RESPONSE_TXT2 = '|' || :WK_1ST_ISSN || '|' || :WK_SSNQTY2 || '|' || :WK_LABELQTY2 ;
      /* append the file name to the directory*/
   IF (WK_GENERATE_LABEL_TEXT = 'T') THEN
   BEGIN
      IF (WK_A_PROD = 0) THEN
      BEGIN
         WK_FILENAME = WK_DIRECTORY || 'LOAD2.1xt';
         WK_LABEL_LINE = '"' || W_SSN_ID || '","' ||
             WK_LOADNO || '","' ||
             LABEL_NO || '"';
         WK_HAVE_FILE_2 = 1;
         WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE);
         IF (WK_RESULT <> 0) THEN
         BEGIN
            WK_FILENAME = WK_DIRECTORY || 'LOAD2.2xt';
            WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE);
            WK_HAVE_FILE_2 = -1;
         END
      END
      IF (WK_A_PROD = 1) THEN
      BEGIN
         WK_FILENAME = WK_DIRECTORY || 'Product2.1xt';
         IF (WK_A_PO = 0) THEN
         BEGIN
            WK_LABEL_LINE = '"' || W_SSN_ID || '","' || 
                WK_LABELQTY2 || '","' || 
                OBJECT || '","' || 
                WK_PROD_DESC || '","' || 
                WK_DATE || '","' || 
                WK_SSNQTY2 || '","' || 
                WK_WEIGHT_X || '","' ||
                WK_WEIGHT_UOM || '","' ||
                WK_PUTLOCN_1 || '","' ||
                WK_PUTLOCN_2 || '","' ||
                WK_LOADNO || '","' ||
                GRN || '","' ||
                W_PRODUCT_SSN_ID || '","' ||
                WK_ALTPROD || '","' ||
                WK_STD_PALLET_DESC || '","' ||
                WK_NON_PALLET_DESC || '","' ||
                WK_ISSUE_UOM || '","' ||
                WK_TOT_INNER || '","' ||
                WK_TOT_OUTER || '","' ||
                WK_INSTR || '","' ||
                WK_PRINTER  || '","' ||
             WK_TEMPERATURE_ZONE || '"' ;
         END
         ELSE
         BEGIN
            WK_LABEL_LINE = '"' || W_SSN_ID || '","' || 
                WK_LABELQTY2 || '","' || 
                OBJECT || '","' || 
                WK_PROD_DESC || '","' || 
                WK_DATE || '","' || 
                WK_SSNQTY2 || '","'  ||
                WK_WEIGHT_X || '","' ||
                WK_WEIGHT_UOM || '","' ||
                WK_PUTLOCN_1 || '","' ||
                WK_PUTLOCN_2 || '","' ||
                WK_LOADNO || '","' ||
                GRN || '","' ||
                W_PRODUCT_SSN_ID || '","' ||
                WK_ALTPROD || '","' ||
                WK_STD_PALLET_DESC || '","' ||
                WK_NON_PALLET_DESC || '","' ||
                WK_ISSUE_UOM || '","' ||
                WK_TOT_INNER || '","' ||
                WK_TOT_OUTER || '","' ||
                WK_INSTR || '","' ||
                WK_PRINTER || '","' ||
             WK_TEMPERATURE_ZONE || '"' ;
         END
         WK_HAVE_FILE_2 = 1;
         WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE);
         IF (WK_RESULT <> 0) THEN
         BEGIN
            WK_FILENAME = WK_DIRECTORY || 'Product2.2xt';
            WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE);
            WK_HAVE_FILE_2 = -1;
         END
      END
   END /* generate is T */
END /* IF do 2nd set  */
   IF (WK_A_PROD = 0) THEN
   BEGIN
      IF (WK_HAVE_FILE_1 = 1) THEN
      BEGIN
         /* rename load.1xt to load.txt */
         WK_FILENAME = WK_DIRECTORY || 'LOAD.1xt';
         WK_FILENAME2 = WK_DIRECTORY || 'LOAD.txt';
         WK_RESULT = FILE_RENAME(WK_FILENAME, WK_FILENAME2);
      END
      IF (WK_HAVE_FILE_1 = -1) THEN
      BEGIN
         /* rename load.2xt to load.txt */
         WK_FILENAME = WK_DIRECTORY || 'LOAD.2xt';
         WK_FILENAME2 = WK_DIRECTORY || 'LOAD.txt';
         WK_RESULT = FILE_RENAME(WK_FILENAME, WK_FILENAME2);
      END
      IF (WK_HAVE_FILE_2 = 1) THEN
      BEGIN
         /* rename load2.1xt to load2.txt */
         WK_FILENAME = WK_DIRECTORY || 'LOAD2.1xt';
         WK_FILENAME2 = WK_DIRECTORY || 'LOAD2.txt';
         WK_RESULT = FILE_RENAME(WK_FILENAME, WK_FILENAME2);
      END
      IF (WK_HAVE_FILE_2 = -1) THEN
      BEGIN
         /* rename load2.2xt to load2.txt */
         WK_FILENAME = WK_DIRECTORY || 'LOAD2.2xt';
         WK_FILENAME2 = WK_DIRECTORY || 'LOAD2.txt';
         WK_RESULT = FILE_RENAME(WK_FILENAME, WK_FILENAME2);
      END
   END
   IF (WK_A_PROD = 1) THEN
   BEGIN
      IF (WK_HAVE_FILE_1 = 1) THEN
      BEGIN
         /* rename product.1xt to product.txt */
         WK_FILENAME = WK_DIRECTORY || 'Product.1xt';
         WK_FILENAME2 = WK_DIRECTORY || 'Product.txt';
         WK_RESULT = FILE_RENAME(WK_FILENAME, WK_FILENAME2);
      END
      IF (WK_HAVE_FILE_1 = -1) THEN
      BEGIN
         /* rename product.2xt to product.txt */
         WK_FILENAME = WK_DIRECTORY || 'Product.2xt';
         WK_FILENAME2 = WK_DIRECTORY || 'Product.txt';
         WK_RESULT = FILE_RENAME(WK_FILENAME, WK_FILENAME2);
      END
      IF (WK_HAVE_FILE_2 = 1) THEN
      BEGIN
         /* rename product2.1xt to product2.txt */
         WK_FILENAME = WK_DIRECTORY || 'Product2.1xt';
         WK_FILENAME2 = WK_DIRECTORY || 'Product2.txt';
         WK_RESULT = FILE_RENAME(WK_FILENAME, WK_FILENAME2);
      END
      IF (WK_HAVE_FILE_2 = -1) THEN
      BEGIN
         /* rename product2.2xt to product2.txt */
         WK_FILENAME = WK_DIRECTORY || 'Product2.2xt';
         WK_FILENAME2 = WK_DIRECTORY || 'Product2.txt';
         WK_RESULT = FILE_RENAME(WK_FILENAME, WK_FILENAME2);
      END
   END
    /* Update transactions table */        
   IF (WK_GENERATE_LABEL_TEXT = 'T') THEN
   BEGIN
      IF (WK_TRN_CODE = 'P') THEN
    BEGIN
/*
         IF (WK_RESPONSE_TXT2 = '') THEN
         BEGIN
           WK_RESPONSE_TXT2 = '|||';
         END
       WK_RESPONSE_FINAL = :WK_RESPONSE_TXT1 || :WK_RESPONSE_TXT2 || '|' || :WK_PRINTER;
       WK_RESPONSE_FINAL = :WK_RESPONSE_FINAL || '|' || 'Processed successfully';
       EXECUTE PROCEDURE UPDATE_TRAN (:RECORD_ID, 'T', :WK_RESPONSE_FINAL);
*/
     EXECUTE PROCEDURE UPDATE_TRAN (:RECORD_ID, 'T', 'Processed successfully'); 
    /*   WK_RESPONSE_TXT = :WK_RESPONSE_TXT || 'Processed successfully'; */
    /* EXECUTE PROCEDURE UPDATE_TRAN (:RECORD_ID, 'T', :WK_RESPONSE_TXT); */
    END
    ELSE
    BEGIN
       EXECUTE PROCEDURE UPDATE_TRAN (:RECORD_ID, 'T', 'Processed successfully');
    END
   END
   IF (WK_GENERATE_LABEL_TEXT = 'F') THEN
   BEGIN
         IF (WK_RESPONSE_TXT2 = '') THEN
         BEGIN
           WK_RESPONSE_TXT2 = '|||';
         END
       WK_RESPONSE_FINAL = :WK_RESPONSE_TXT1 || :WK_RESPONSE_TXT2 || '|' || :WK_PRINTER;
       WK_RESPONSE_FINAL = :WK_RESPONSE_FINAL || '|' || 'Processed successfully';
       EXECUTE PROCEDURE UPDATE_TRAN (:RECORD_ID, 'T', :WK_RESPONSE_FINAL);
   END
END ^

ALTER PROCEDURE ADD_SSN_ISSN_GRNV_WEIGHT (WH_ID VARCHAR(2) CHARACTER SET NONE,
LOCN_ID VARCHAR(10) CHARACTER SET NONE,
OBJECT VARCHAR(30) CHARACTER SET NONE,
TRANS_DATE TIMESTAMP,
QTY INTEGER,
GRN VARCHAR(10) CHARACTER SET NONE,
REFERENCE VARCHAR(40) CHARACTER SET NONE,
SOURCE VARCHAR(9) CHARACTER SET NONE,
RECORD_ID INTEGER)
AS 
 
 
 
 
 
DECLARE VARIABLE SSN_ID INTEGER;
DECLARE VARIABLE P_SSN_ID INTEGER;
DECLARE VARIABLE W_SSN_ID VARCHAR(20);
DECLARE VARIABLE I_SSN_ID VARCHAR(20);
DECLARE VARIABLE LEN_SSN_ID INTEGER;
DECLARE VARIABLE I_LEN_SSN_ID INTEGER;
DECLARE VARIABLE SSN_LENGTH INTEGER;
DECLARE VARIABLE LABEL_NO INTEGER;
DECLARE VARIABLE WK_LABEL_CURQTY INTEGER;
DECLARE VARIABLE WK_SSN_CURQTY INTEGER;
DECLARE VARIABLE WK_LABELQTY1 VARCHAR(10);
DECLARE VARIABLE WK_LABELQTY2 VARCHAR(10);
DECLARE VARIABLE WK_SSNQTY1 VARCHAR(10);
DECLARE VARIABLE WK_SSNQTY2 VARCHAR(10);

DECLARE VARIABLE WK_GRN_TYPE CHAR(2);
DECLARE VARIABLE WK_PRINTER CHAR(2);
DECLARE VARIABLE WK_DIRECTORY VARCHAR(75);
DECLARE VARIABLE WK_FILENAME VARCHAR(255);
DECLARE VARIABLE WK_LABEL_LINE VARCHAR(250);
DECLARE VARIABLE WK_LOADNO VARCHAR(10);
DECLARE VARIABLE WK_LOAD_LINE_NO VARCHAR(10);
DECLARE VARIABLE WK_RESULT INTEGER;
DECLARE VARIABLE WK_DATE VARCHAR(20);
DECLARE VARIABLE WK_TIME VARCHAR(10);
DECLARE VARIABLE WK_PROD_DESC VARCHAR(50);
DECLARE VARIABLE WK_A_PROD INTEGER;
DECLARE VARIABLE WK_A_PO INTEGER;
DECLARE VARIABLE WK_PROD_EXISTS INTEGER;

DECLARE VARIABLE WK_REF_LEN INTEGER;
DECLARE VARIABLE WK_REF2_LAST INTEGER;
DECLARE VARIABLE WK_OLD_METHOD CHAR(1);
DECLARE VARIABLE WK_PRINTER_2 VARCHAR(5);
DECLARE VARIABLE WK_REF VARCHAR(40);
DECLARE VARIABLE WK_SUPPLIER VARCHAR(10);
DECLARE VARIABLE WK_OWNER VARCHAR(10);
DECLARE VARIABLE WK_STATUS CHAR(2);
DECLARE VARIABLE WK_PROD_STATUS CHAR(2);
DECLARE VARIABLE WK_HAVE_FILE_1 INTEGER;
DECLARE VARIABLE WK_FILENAME2 VARCHAR(255);
DECLARE VARIABLE W_PRODUCT_SSN_ID VARCHAR(20);

DECLARE VARIABLE WK_PO_FOUND INTEGER;
DECLARE VARIABLE WK_PO_QTY INTEGER;
DECLARE VARIABLE WK_PO_ORIG_QTY INTEGER;
DECLARE VARIABLE WK_PO_NEW_QTY INTEGER;
DECLARE VARIABLE WK_PO_STATUS CHAR(2);
DECLARE VARIABLE WK_USER VARCHAR(10);
DECLARE VARIABLE WK_PROD_TYPE CHAR(2);

DECLARE VARIABLE WK_WEIGHT INTEGER;
DECLARE VARIABLE WK_WEIGHT_X VARCHAR(10);
DECLARE VARIABLE WK_WEIGHT_UOM CHAR(2);
DECLARE VARIABLE WK_DEVICE_ID CHAR(2);
DECLARE VARIABLE WK_TRN_TYPE CHAR(4);
DECLARE VARIABLE WK_TRN_CODE CHAR(1);
DECLARE VARIABLE WK_REASON VARCHAR(70);
DECLARE VARIABLE WK_PUTLOCN_1 VARCHAR(10);
DECLARE VARIABLE WK_PUTLOCN_2 VARCHAR(10);
DECLARE VARIABLE WK_ALTPROD VARCHAR(30);
DECLARE VARIABLE WK_STD_PALLET_CFG VARCHAR(2);
DECLARE VARIABLE WK_NON_PALLET_CFG VARCHAR(2);
DECLARE VARIABLE WK_ISSUE_UOM VARCHAR(2);
DECLARE VARIABLE WK_INNER_UNITS INTEGER;
DECLARE VARIABLE WK_ORDER_UNITS INTEGER;
DECLARE VARIABLE WK_TOT_INNER INTEGER;
DECLARE VARIABLE WK_TOT_OUTER INTEGER;
DECLARE VARIABLE WK_INSTR VARCHAR(50);
DECLARE VARIABLE WK_STD_PALLET_DESC VARCHAR(50);
DECLARE VARIABLE WK_STD_PALLET_CARTONS INTEGER;
DECLARE VARIABLE WK_STD_PALLET_LAYERS INTEGER;
DECLARE VARIABLE WK_NON_PALLET_DESC VARCHAR(50);
BEGIN 

   WK_HAVE_FILE_1 = 0;
   WK_REF = ALLTRIM(REFERENCE);
   REFERENCE = WK_REF;
   WK_REF_LEN = STRLEN(REFERENCE);
   WK_REF2_LAST = WK_REF_LEN;
   WK_OLD_METHOD = 'N';

   SELECT PERSON_ID, DEVICE_ID, TRN_TYPE, TRN_CODE 
   FROM TRANSACTIONS 
   WHERE RECORD_ID = :RECORD_ID
   INTO :WK_USER, :WK_DEVICE_ID, :WK_TRN_TYPE, :WK_TRN_CODE;
   /* Get the STatus to use for the inserts */
   SELECT NEW_SSN_STATUS, NEW_PROD_STATUS FROM CONTROL
   INTO :WK_STATUS, :WK_PROD_STATUS;
   /*
   for this transaction the object field
   holds the owner (10) , company (10) as in GRNV G
   location holds the create location (as in GRNV G)
   sub location holds the grn (as in GRNV G)
   reference holds
      grn type (2) |
      order no (10) |
      line no (4) |
      qty labels (3) |
      qty per label (5) |
      weight (6) |
      weight uom (2) |
      2nd letter of printer device
   Qty holds the qty of labels in this transaction
   /* Get length for Barcode */   
   EXECUTE PROCEDURE GET_BARCODE_LENGTH RETURNING_VALUES SSN_LENGTH;
   /* Read Reference field to get Label No 
   EXECUTE PROCEDURE GET_QTY_LABEL :REFERENCE  RETURNING_VALUES LABEL_NO;
*/
   EXECUTE PROCEDURE GET_REFERENCE_FIELD :REFERENCE, 2  RETURNING_VALUES :WK_LOADNO ; 
   EXECUTE PROCEDURE GET_REFERENCE_FIELD :REFERENCE, 3  RETURNING_VALUES :WK_LOAD_LINE_NO ; 
   EXECUTE PROCEDURE GET_REFERENCE_FIELD :REFERENCE, 4  RETURNING_VALUES :WK_SSNQTY1 ; 
   EXECUTE PROCEDURE GET_REFERENCE_FIELD :REFERENCE, 5  RETURNING_VALUES :WK_LABELQTY1 ; 
   LABEL_NO = CAST(WK_SSNQTY1 AS INTEGER);
   WK_LABEL_CURQTY = CAST(WK_LABELQTY1 AS INTEGER);
   
   EXECUTE PROCEDURE GET_REFERENCE_FIELD :REFERENCE, 6  RETURNING_VALUES :WK_WEIGHT_X ; 
   EXECUTE PROCEDURE GET_REFERENCE_FIELD :REFERENCE, 7  RETURNING_VALUES :WK_WEIGHT_UOM; 
   WK_WEIGHT = CAST(WK_WEIGHT_X AS INTEGER);

   IF (LABEL_NO <= 0) THEN
   BEGIN
      /* no labels so stop */
      EXECUTE PROCEDURE UPDATE_TRAN (:RECORD_ID, 'F', 'No Labels to Print/Create');
      EXIT;
   END

   /* find type of grn PO LD or */
   WK_GRN_TYPE = substr(REFERENCE, 1, 2);

   SSN_ID = GEN_ID(ISSN_SSN_ID, :LABEL_NO);
   P_SSN_ID = SSN_ID - :LABEL_NO;
   LEN_SSN_ID = STRLEN(P_SSN_ID);     
         
   W_SSN_ID = '';
   /* Padding leading with 0 */
   WHILE (LEN_SSN_ID < :SSN_LENGTH) DO
   BEGIN
      W_SSN_ID = W_SSN_ID || '0';      
      LEN_SSN_ID = LEN_SSN_ID + 1;
   END
   W_SSN_ID = W_SSN_ID || P_SSN_ID;
   
   EXECUTE PROCEDURE GET_REFERENCE_FIELD :REFERENCE, 8  RETURNING_VALUES :WK_PRINTER_2 ; 
   IF (STRLEN(WK_PRINTER_2) > 1) THEN
   BEGIN
      WK_PRINTER = WK_PRINTER_2;
   END
   ELSE
   BEGIN
      WK_PRINTER = 'P' || WK_PRINTER_2;
   END
   IF (WK_GRN_TYPE = 'LD') THEN
   BEGIN
      /* EXECUTE PROCEDURE GET_REFERENCE_FIELD :OBJECT, 1  RETURNING_VALUES :WK_SUPPLIER ;  */
      WK_SUPPLIER = SUBSTR(OBJECT,1,10);
      WK_OWNER = SUBSTR(OBJECT,11,20);
      UPDATE GRN 
      SET RETURN_ID = :WK_SUPPLIER
      WHERE GRN = :GRN;
   END
   WK_A_PROD = 0;
   WK_A_PO = 0;
   IF ((WK_GRN_TYPE = 'PO') OR
       (WK_GRN_TYPE = 'RA') OR  
       (WK_GRN_TYPE = 'TR') OR
       (WK_GRN_TYPE = 'WO')) THEN
   BEGIN
       IF (OBJECT <> '') THEN
       BEGIN
           WK_A_PROD = 1;
           WK_A_PO = 1;
           WK_PROD_EXISTS = 0;
           SELECT 1, 
              SHORT_DESC,
              HOME_LOCN_ID ,
              ALTERNATE_ID,
              PALLET_CFG_INNER,
              PALLET_CFG_ALTERNATE,
              ISSUE_UOM,
              ISSUE_PER_ORDER_UNIT,
              ISSUE_PER_INNER_UNIT,
              SPECIAL_INSTR
              FROM PROD_PROFILE
              WHERE PROD_ID = :OBJECT
              INTO :WK_PROD_EXISTS, 
              :WK_PROD_DESC,
              :WK_PUTLOCN_1,
              :WK_ALTPROD,
              :WK_STD_PALLET_CFG,
              :WK_NON_PALLET_CFG,
              :WK_ISSUE_UOM,
              :WK_ORDER_UNITS,
              :WK_INNER_UNITS,
              :WK_INSTR;
           IF (WK_PROD_EXISTS = 0) THEN
           BEGIN
               /* Insert into prod_profile */
               INSERT INTO PROD_PROFILE (PROD_ID, SHORT_DESC, LAST_UPDATE_DATE)
                   VALUES (:OBJECT, :OBJECT, 'NOW');
               WK_PROD_DESC = OBJECT;
           END
           IF (WK_PUTLOCN_1 IS NULL) THEN
           BEGIN
              WK_PUTLOCN_1 = '';
           END
           SELECT FIRST 1 WH_ID || LOCN_ID
           FROM LOCATION
           WHERE PROD_ID = :OBJECT
           AND :WK_PUTLOCN_1 <> (WH_ID || LOCN_ID)
           INTO :WK_PUTLOCN_2;
           IF (WK_PUTLOCN_2 IS NULL) THEN
           BEGIN
              WK_PUTLOCN_2 = '';
           END
           IF (WK_PUTLOCN_1 = '' AND WK_PUTLOCN_2 <> '') THEN
           BEGIN
              SELECT FIRST 1 WH_ID || LOCN_ID
              FROM LOCATION
              WHERE PROD_ID = :OBJECT
              AND :WK_PUTLOCN_2 <> (WH_ID || LOCN_ID)
              INTO :WK_PUTLOCN_1;
              IF (WK_PUTLOCN_1 IS NULL) THEN
              BEGIN
                 WK_PUTLOCN_1 = '';
              END
           END
           IF (WK_ALTPROD IS NULL) THEN
           BEGIN
              WK_ALTPROD = '';
           END
           IF (WK_STD_PALLET_CFG IS NULL) THEN
           BEGIN
              WK_STD_PALLET_CFG = '';
           END
           IF (WK_NON_PALLET_CFG IS NULL) THEN
           BEGIN
              WK_NON_PALLET_CFG = '';
           END
           IF (WK_ISSUE_UOM IS NULL) THEN
           BEGIN
              WK_ISSUE_UOM = '';
           END
           IF (WK_INSTR IS NULL) THEN
           BEGIN
              WK_INSTR = '';
           END
           IF (WK_INNER_UNITS IS NULL) THEN
           BEGIN
              WK_INNER_UNITS = 1;
           END
           IF (WK_ORDER_UNITS IS NULL) THEN
           BEGIN
              WK_ORDER_UNITS = 1;
           END
           SELECT 
              PALLET_CFG_DESCRIPTION,
              TOTAL_CARTONS_LAYER,
              TOTAL_LAYERS
           FROM PALLET_CFG
           WHERE PALLET_CFG_CODE = :WK_STD_PALLET_CFG
           INTO :WK_STD_PALLET_DESC, :WK_STD_PALLET_CARTONS, :WK_STD_PALLET_LAYERS;
           SELECT 
              PALLET_CFG_DESCRIPTION
           FROM PALLET_CFG
           WHERE PALLET_CFG_CODE = :WK_NON_PALLET_CFG
           INTO :WK_NON_PALLET_DESC ;
           IF (WK_STD_PALLET_DESC IS NULL) THEN
           BEGIN
              WK_STD_PALLET_DESC = WK_STD_PALLET_CFG;
           END
           IF (WK_STD_PALLET_CARTONS IS NULL) THEN
           BEGIN
              WK_STD_PALLET_CARTONS = 1;
           END
           IF (WK_STD_PALLET_LAYERS IS NULL) THEN
           BEGIN
              WK_STD_PALLET_LAYERS = 1;
           END
           IF (WK_NON_PALLET_DESC IS NULL) THEN
           BEGIN
              WK_NON_PALLET_DESC = WK_NON_PALLET_CFG;
           END
           WK_TOT_INNER = WK_ORDER_UNITS / WK_INNER_UNITS;
           WK_TOT_OUTER = WK_STD_PALLET_LAYERS * WK_STD_PALLET_CARTONS;
           WK_SSN_CURQTY = LABEL_NO  * WK_LABEL_CURQTY ;
           SELECT COMPANY_ID 
           FROM PURCHASE_ORDER 
           WHERE PURCHASE_ORDER = :WK_LOADNO
           INTO :WK_OWNER;
           IF (WK_OWNER IS NULL) THEN
           BEGIN
              SELECT COMPANY_ID FROM CONTROL INTO :WK_OWNER; 
           END
          /* Insert data into SSN table */   
          INSERT INTO SSN (SSN_ID, WH_ID, LOCN_ID, GRN, STATUS_SSN, LABEL_DATE, ORIGINAL_QTY,
                    CURRENT_QTY, PURCHASE_DATE, PO_ORDER, PO_RECEIVE_DATE, PROD_ID, SSN_DESCRIPTION, PO_LINE, COMPANY_ID, NET_WEIGHT, NET_WEIGHT_UOM)
          VALUES (:W_SSN_ID, :WH_ID, :LOCN_ID, :GRN, :WK_PROD_STATUS, 'NOW', :WK_SSN_CURQTY, :WK_SSN_CURQTY, 'NOW',:WK_LOADNO, 'NOW', :OBJECT,:WK_PROD_DESC,:WK_LOAD_LINE_NO, :WK_OWNER, :WK_WEIGHT, :WK_WEIGHT_UOM);     
          W_PRODUCT_SSN_ID = W_SSN_ID;
          WK_REASON = 'Received ' || :WK_SSN_CURQTY || ' by User ' || :WK_USER || ' SSN ' || :W_PRODUCT_SSN_ID ;
          EXECUTE PROCEDURE ADD_SSN_HIST(:WH_ID, :LOCN_ID, :W_PRODUCT_SSN_ID, 
                          :WK_TRN_TYPE, :WK_TRN_CODE, :TRANS_DATE,
                          :WK_REASON, '' , :WK_SSN_CURQTY, :WK_USER, :WK_DEVICE_ID); 
          UPDATE GRN 
          SET ORDER_NO = :WK_LOADNO,
              ORDER_LINE_NO = :WK_LOAD_LINE_NO
          WHERE GRN = :GRN;
          /* update the po outstanding qty and status */
          WK_PO_FOUND = 0;
          SELECT 1 , PO_LINE_QTY, ORIGINAL_QTY 
          FROM PURCHASE_ORDER_LINE
          WHERE PURCHASE_ORDER = :WK_LOADNO
          AND   PO_LINE = :WK_LOAD_LINE_NO
          INTO :WK_PO_FOUND, :WK_PO_QTY, :WK_PO_ORIG_QTY ;
          IF (WK_PO_FOUND = 1) THEN
          BEGIN
             WK_PO_STATUS = 'OP';
             WK_PO_NEW_QTY = WK_PO_QTY - WK_SSN_CURQTY; 
             IF (WK_PO_NEW_QTY = 0) THEN
             BEGIN
                WK_PO_STATUS = 'CL';
             END
             ELSE
             BEGIN
                IF (WK_PO_NEW_QTY < 0) THEN
                BEGIN
                   WK_PO_STATUS = 'OS';
                END
             END

             IF (WK_PO_ORIG_QTY IS NULL) THEN
             BEGIN
                UPDATE PURCHASE_ORDER_LINE
                SET ORIGINAL_QTY = :WK_PO_QTY,
                    PO_LINE_QTY = :WK_PO_NEW_QTY,
                    PO_LINE_STATUS = :WK_PO_STATUS
                WHERE PURCHASE_ORDER = :WK_LOADNO
                AND   PO_LINE = :WK_LOAD_LINE_NO;
             END
             ELSE
             BEGIN
                UPDATE PURCHASE_ORDER_LINE
                SET PO_LINE_QTY = :WK_PO_NEW_QTY,
                    PO_LINE_STATUS = :WK_PO_STATUS
                WHERE PURCHASE_ORDER = :WK_LOADNO
                AND   PO_LINE = :WK_LOAD_LINE_NO;
             END
          END
      END
   END
             
   IF (WK_GRN_TYPE = 'LP') THEN
   BEGIN
       IF (OBJECT <> '') THEN
       BEGIN
           WK_A_PROD = 1;
           WK_PROD_EXISTS = 0;
           SELECT 1, 
              PROD_TYPE,
              COMPANY_ID,
              SHORT_DESC,
              HOME_LOCN_ID ,
              ALTERNATE_ID,
              PALLET_CFG_INNER,
              PALLET_CFG_ALTERNATE,
              ISSUE_UOM,
              ISSUE_PER_ORDER_UNIT,
              ISSUE_PER_INNER_UNIT,
              SPECIAL_INSTR
              FROM PROD_PROFILE
              WHERE PROD_ID = :OBJECT
              INTO :WK_PROD_EXISTS, 
              :WK_PROD_TYPE,
              :WK_OWNER,
              :WK_PROD_DESC,
              :WK_PUTLOCN_1,
              :WK_ALTPROD,
              :WK_STD_PALLET_CFG,
              :WK_NON_PALLET_CFG,
              :WK_ISSUE_UOM,
              :WK_ORDER_UNITS,
              :WK_INNER_UNITS,
              :WK_INSTR;
           IF (WK_PROD_EXISTS = 0) THEN
           BEGIN
               /* Insert into prod_profile */
               INSERT INTO PROD_PROFILE (PROD_ID, SHORT_DESC, LAST_UPDATE_DATE)
                   VALUES (:OBJECT, :OBJECT, 'NOW');
               WK_PROD_DESC = OBJECT;
           END
           IF (WK_PUTLOCN_1 IS NULL) THEN
           BEGIN
              WK_PUTLOCN_1 = '';
           END
           SELECT FIRST 1 WH_ID || LOCN_ID
           FROM LOCATION
           WHERE PROD_ID = :OBJECT
           AND :WK_PUTLOCN_1 <> (WH_ID || LOCN_ID)
           INTO :WK_PUTLOCN_2;
           IF (WK_PUTLOCN_2 IS NULL) THEN
           BEGIN
              WK_PUTLOCN_2 = '';
           END
           IF (WK_PUTLOCN_1 = '' AND WK_PUTLOCN_2 <> '') THEN
           BEGIN
              SELECT FIRST 1 WH_ID || LOCN_ID
              FROM LOCATION
              WHERE PROD_ID = :OBJECT
              AND :WK_PUTLOCN_2 <> (WH_ID || LOCN_ID)
              INTO :WK_PUTLOCN_1;
              IF (WK_PUTLOCN_1 IS NULL) THEN
              BEGIN
                 WK_PUTLOCN_1 = '';
              END
           END
           IF (WK_ALTPROD IS NULL) THEN
           BEGIN
              WK_ALTPROD = '';
           END
           IF (WK_STD_PALLET_CFG IS NULL) THEN
           BEGIN
              WK_STD_PALLET_CFG = '';
           END
           IF (WK_NON_PALLET_CFG IS NULL) THEN
           BEGIN
              WK_NON_PALLET_CFG = '';
           END
           IF (WK_ISSUE_UOM IS NULL) THEN
           BEGIN
              WK_ISSUE_UOM = '';
           END
           IF (WK_INSTR IS NULL) THEN
           BEGIN
              WK_INSTR = '';
           END
           IF (WK_INNER_UNITS IS NULL) THEN
           BEGIN
              WK_INNER_UNITS = 1;
           END
           IF (WK_ORDER_UNITS IS NULL) THEN
           BEGIN
              WK_ORDER_UNITS = 1;
           END
           SELECT 
              PALLET_CFG_DESCRIPTION,
              TOTAL_CARTONS_LAYER,
              TOTAL_LAYERS
           FROM PALLET_CFG
           WHERE PALLET_CFG_CODE = :WK_STD_PALLET_CFG
           INTO :WK_STD_PALLET_DESC, :WK_STD_PALLET_CARTONS, :WK_STD_PALLET_LAYERS;
           SELECT 
              PALLET_CFG_DESCRIPTION
           FROM PALLET_CFG
           WHERE PALLET_CFG_CODE = :WK_NON_PALLET_CFG
           INTO :WK_NON_PALLET_DESC ;
           IF (WK_STD_PALLET_DESC IS NULL) THEN
           BEGIN
              WK_STD_PALLET_DESC = WK_STD_PALLET_CFG;
           END
           IF (WK_STD_PALLET_CARTONS IS NULL) THEN
           BEGIN
              WK_STD_PALLET_CARTONS = 1;
           END
           IF (WK_STD_PALLET_LAYERS IS NULL) THEN
           BEGIN
              WK_STD_PALLET_LAYERS = 1;
           END
           IF (WK_NON_PALLET_DESC IS NULL) THEN
           BEGIN
              WK_NON_PALLET_DESC = WK_NON_PALLET_CFG;
           END
           WK_TOT_INNER = WK_ORDER_UNITS / WK_INNER_UNITS;
           WK_TOT_OUTER = WK_STD_PALLET_LAYERS * WK_STD_PALLET_CARTONS;
           WK_SSN_CURQTY = LABEL_NO  * WK_LABEL_CURQTY ;
           /* calc loadno, supplier and default company */
           WK_SUPPLIER = WK_LOADNO;
           IF (WK_OWNER IS NULL) THEN
           BEGIN
              SELECT COMPANY_ID FROM CONTROL INTO :WK_OWNER; 
           END
           SELECT ORDER_NO FROM GRN WHERE GRN = :GRN INTO :WK_LOADNO;
           UPDATE GRN 
           SET RETURN_ID = :WK_SUPPLIER
           WHERE GRN = :GRN;
          /* Insert data into SSN table */   
          INSERT INTO SSN (SSN_ID, WH_ID, LOCN_ID, GRN, STATUS_SSN, LABEL_DATE, ORIGINAL_QTY,
                    CURRENT_QTY, PO_ORDER, PO_RECEIVE_DATE, PROD_ID, SSN_DESCRIPTION, PO_LINE, SUPPLIER_ID, COMPANY_ID, SSN_TYPE, NET_WEIGHT, NET_WEIGHT_UOM)
          VALUES (:W_SSN_ID, :WH_ID, :LOCN_ID, :GRN, :WK_PROD_STATUS, 'NOW', :WK_SSN_CURQTY, :WK_SSN_CURQTY, :WK_LOADNO, 'NOW', :OBJECT,:WK_PROD_DESC,:WK_LOAD_LINE_NO, :WK_SUPPLIER, :WK_OWNER, :WK_PROD_TYPE, :WK_WEIGHT, :WK_WEIGHT_UOM);     
          W_PRODUCT_SSN_ID = W_SSN_ID;
          WK_REASON = 'Received ' || :WK_SSN_CURQTY || ' by User ' || :WK_USER || ' SSN ' || :W_PRODUCT_SSN_ID ;
          EXECUTE PROCEDURE ADD_SSN_HIST(:WH_ID, :LOCN_ID, :W_PRODUCT_SSN_ID, 
                          :WK_TRN_TYPE, :WK_TRN_CODE, :TRANS_DATE,
                          :WK_REASON, '' , :WK_SSN_CURQTY, :WK_USER, :WK_DEVICE_ID); 
      END
   END
             
   
   /* Insert data into ISSN table */
   WHILE (P_SSN_ID < SSN_ID) DO
   BEGIN
      I_SSN_ID = '';
      I_LEN_SSN_ID = STRLEN(P_SSN_ID);
      
      /* Padding leading with 0 */
      WHILE (I_LEN_SSN_ID < :SSN_LENGTH) DO
      BEGIN
       I_SSN_ID = I_SSN_ID || '0';
       I_LEN_SSN_ID = I_LEN_SSN_ID + 1;
      END
      I_SSN_ID = I_SSN_ID || P_SSN_ID;
      
      IF (WK_A_PROD = 0) THEN
      BEGIN
         /* Insert data into SSN table */   
/*
         VALUES (:I_SSN_ID, :WH_ID, :LOCN_ID, :GRN, 'TS', 'NOW', :WK_LABEL_CURQTY, :WK_LABEL_CURQTY, :WK_LOADNO, 'NOW',:WK_LOAD_LINE_NO,:OBJECT);     
         VALUES (:I_SSN_ID, :I_SSN_ID, :WH_ID, :LOCN_ID, :WK_LABEL_CURQTY, 'TS'); 
*/
         INSERT INTO SSN (SSN_ID, WH_ID, LOCN_ID, GRN, STATUS_SSN, LABEL_DATE, ORIGINAL_QTY,
                    CURRENT_QTY, PO_ORDER, PO_RECEIVE_DATE, PO_LINE, SUPPLIER_ID, COMPANY_ID, NET_WEIGHT, NET_WEIGHT_UOM)
         VALUES (:I_SSN_ID, :WH_ID, :LOCN_ID, :GRN, :WK_STATUS, 'NOW', :WK_LABEL_CURQTY, :WK_LABEL_CURQTY, :WK_LOADNO, 'NOW',:WK_LOAD_LINE_NO,:WK_SUPPLIER, :WK_OWNER, :WK_WEIGHT, :WK_WEIGHT_UOM);     
         INSERT INTO ISSN (SSN_ID, ORIGINAL_SSN, WH_ID, LOCN_ID, CURRENT_QTY,ISSN_STATUS, LABEL_DATE, COMPANY_ID, ORIGINAL_QTY, CREATE_DATE, USER_ID, INTO_DATE)
         VALUES (:I_SSN_ID, :I_SSN_ID, :WH_ID, :LOCN_ID, :WK_LABEL_CURQTY, :WK_STATUS, :TRANS_DATE, :WK_OWNER, :WK_LABEL_CURQTY, :TRANS_DATE, :WK_USER, :TRANS_DATE); 
      END
      IF (WK_A_PROD = 1) THEN
      BEGIN
         INSERT INTO ISSN (SSN_ID, ORIGINAL_SSN, WH_ID, LOCN_ID, CURRENT_QTY,ISSN_STATUS, PROD_ID, LABEL_DATE, COMPANY_ID, ORIGINAL_QTY, CREATE_DATE,USER_ID, INTO_DATE)
         VALUES (:I_SSN_ID, :W_SSN_ID, :WH_ID, :LOCN_ID, :WK_LABEL_CURQTY, :WK_PROD_STATUS, :OBJECT, 'NOW', :WK_OWNER, :WK_LABEL_CURQTY, :TRANS_DATE, :WK_USER, :TRANS_DATE ); 
      END
      
      P_SSN_ID = P_SSN_ID + 1;
   END

   /* need the directory for this label set */
   SELECT WORKING_DIRECTORY FROM SYS_EQUIP 
       WHERE DEVICE_ID = :WK_PRINTER
       INTO :WK_DIRECTORY;
/*
   insert into log(description) values('printer for grnv ' || :WK_PRINTER );
   insert into log(description) values('dir for grnv ' || :WK_PRINTER || :WK_DIRECTORY);
*/
   /* append the file name to the directory*/
   IF (WK_A_PROD = 0) THEN
   BEGIN
      WK_FILENAME = WK_DIRECTORY || 'LOAD.1xt';
      WK_LABEL_LINE = '"' || W_SSN_ID || '","' ||
          WK_LOADNO || '","' ||
          LABEL_NO || '","' ||
          WK_WEIGHT_X  || '","' ||
          WK_WEIGHT_UOM  || '"';
      WK_HAVE_FILE_1 = 1;
      WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE);
      IF (WK_RESULT <> 0) THEN
      BEGIN
         WK_FILENAME = WK_DIRECTORY || 'LOAD.2xt';
         WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE);
         WK_HAVE_FILE_1 = -1;
      END
      
   END
   IF (WK_A_PROD = 1) THEN
   BEGIN
      /* must get products desc  */
      WK_DATE = MER_DAY(TRANS_DATE) || '/' || MER_MONTH(TRANS_DATE) || '/' || SUBSTR(CAST(MER_YEAR(TRANS_DATE) AS CHAR(4)) , 3,4);
      WK_TIME = MER_HOUR(TRANS_DATE) || ':' || MER_MINUTE(TRANS_DATE) ;
      WK_DATE = WK_DATE || ' ' || WK_TIME;
      WK_FILENAME = WK_DIRECTORY || 'Product.1xt';
      WK_HAVE_FILE_1 = 1;
/*
      WK_LABEL_LINE = DQUOTEDSTR(W_SSN_ID) || ',' ||
          DQUOTEDSTR(WK_LABEL_CURQTY ) || ',' ||
          DQUOTEDSTR(OBJECT) || ',' ||
          DQUOTEDSTR(WK_PROD_DESC) || ',' ||
          DQUOTEDSTR(WK_DATE);
*/
      IF (WK_A_PO = 0) THEN
      BEGIN
/*
         WK_LABEL_LINE = '"' || W_SSN_ID || '","' || 
             WK_LABELQTY1 || '","' || 
             OBJECT || '","' || 
             WK_PROD_DESC || '","' || 
             WK_DATE || '","' || 
             WK_SSNQTY1 || '","' ||
             WK_WEIGHT_X  || '","' ||
             WK_WEIGHT_UOM  || '"';
*/
         WK_LABEL_LINE = '"' || W_SSN_ID || '","' || 
             WK_LABELQTY1 || '","' || 
             OBJECT || '","' || 
             WK_PROD_DESC || '","' || 
             WK_DATE || '","' || 
             WK_SSNQTY1 || '","' ||
             WK_WEIGHT_X  || '","' ||
             WK_WEIGHT_UOM  || '","' ||
             WK_PUTLOCN_1  || '","' ||
             WK_PUTLOCN_2  || '","' ||
             WK_LOADNO  || '","' ||
             GRN  || '","' ||
             W_PRODUCT_SSN_ID  || '","' ||
             WK_ALTPROD  || '","' ||
             WK_STD_PALLET_DESC  || '","' ||
             WK_NON_PALLET_DESC  || '","' ||
             WK_ISSUE_UOM  || '","' ||
             WK_TOT_INNER  || '","' ||
             WK_TOT_OUTER  || '","' ||
             WK_INSTR  || '","' ||
             WK_PRINTER || '"' ; 
      END
      ELSE
      BEGIN
         WK_LABEL_LINE = '"' || W_SSN_ID || '","' || 
             WK_LABELQTY1 || '","' || 
             OBJECT || '","' || 
             WK_PROD_DESC || '","' || 
             WK_DATE || '","' || 
             WK_SSNQTY1 || '","' ||
             WK_WEIGHT_X  || '","' ||
             WK_WEIGHT_UOM  || '","' ||
             WK_PUTLOCN_1  || '","' ||
             WK_PUTLOCN_2  || '","' ||
             WK_LOADNO  || '","' ||
             GRN  || '","' ||
             W_PRODUCT_SSN_ID  || '","' ||
             WK_ALTPROD  || '","' ||
             WK_STD_PALLET_DESC  || '","' ||
             WK_NON_PALLET_DESC  || '","' ||
             WK_ISSUE_UOM  || '","' ||
             WK_TOT_INNER  || '","' ||
             WK_TOT_OUTER  || '","' ||
             WK_INSTR  || '","' ||
             WK_PRINTER || '"' ; 
      END
      WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE);
      IF (WK_RESULT <> 0) THEN
      BEGIN
         WK_FILENAME = WK_DIRECTORY || 'Product.2xt';
         WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE);
         WK_HAVE_FILE_1 = -1;
      END
   END
   IF (WK_A_PROD = 0) THEN
   BEGIN
      IF (WK_HAVE_FILE_1 = 1) THEN
      BEGIN
         /* rename load.1xt to load.txt */
         WK_FILENAME = WK_DIRECTORY || 'LOAD.1xt';
         WK_FILENAME2 = WK_DIRECTORY || 'LOAD.txt';
         WK_RESULT = FILE_RENAME(WK_FILENAME, WK_FILENAME2);
      END
      IF (WK_HAVE_FILE_1 = -1) THEN
      BEGIN
         /* rename load.2xt to load.txt */
         WK_FILENAME = WK_DIRECTORY || 'LOAD.2xt';
         WK_FILENAME2 = WK_DIRECTORY || 'LOAD.txt';
         WK_RESULT = FILE_RENAME(WK_FILENAME, WK_FILENAME2);
      END
   END
   IF (WK_A_PROD = 1) THEN
   BEGIN
      IF (WK_HAVE_FILE_1 = 1) THEN
      BEGIN
         /* rename product.1xt to product.txt */
         WK_FILENAME = WK_DIRECTORY || 'Product.1xt';
         WK_FILENAME2 = WK_DIRECTORY || 'Product.txt';
         WK_RESULT = FILE_RENAME(WK_FILENAME, WK_FILENAME2);
      END
      IF (WK_HAVE_FILE_1 = -1) THEN
      BEGIN
         /* rename product.2xt to product.txt */
         WK_FILENAME = WK_DIRECTORY || 'Product.2xt';
         WK_FILENAME2 = WK_DIRECTORY || 'Product.txt';
         WK_RESULT = FILE_RENAME(WK_FILENAME, WK_FILENAME2);
      END
   END
    /* Update transactions table */        
    EXECUTE PROCEDURE UPDATE_TRAN (:RECORD_ID, 'T', 'Processed successfully');
END ^

ALTER PROCEDURE ADD_SSN_ISSN_LABEL (WH_ID VARCHAR(2) CHARACTER SET NONE,
PRINTED_BY VARCHAR(10) CHARACTER SET NONE,
LABEL_NO INTEGER,
SSN_LENGTH INTEGER)
RETURNS (ISSN VARCHAR(20) CHARACTER SET NONE)
AS 
 
        

DECLARE VARIABLE SSN_ID INTEGER;
DECLARE VARIABLE P_SSN_ID INTEGER;
DECLARE VARIABLE W_SSN_ID VARCHAR(20);
DECLARE VARIABLE I_SSN_ID VARCHAR(20);
DECLARE VARIABLE LEN_SSN_ID INTEGER;
DECLARE VARIABLE I_LEN_SSN_ID INTEGER;
DECLARE VARIABLE WK_NEW_LOCN_ID VARCHAR(10);


BEGIN          
   SSN_ID = GEN_ID(ISSN_SSN_ID, :LABEL_NO);
   P_SSN_ID = SSN_ID - :LABEL_NO;
   LEN_SSN_ID = STRLEN(P_SSN_ID);     
   SELECT NEW_LABEL_LOCN_ID FROM CONTROL INTO :WK_NEW_LOCN_ID;
         
   W_SSN_ID = '';
   /* Padding leading with 0 */
   WHILE (LEN_SSN_ID < :SSN_LENGTH) DO
   BEGIN
      W_SSN_ID = W_SSN_ID || '0';      
      LEN_SSN_ID = LEN_SSN_ID + 1;
   END
   W_SSN_ID = W_SSN_ID || P_SSN_ID;
   
   /* Insert data into SSN table */   
   INSERT INTO SSN (SSN_ID, WH_ID, LOCN_ID, STATUS_SSN, LABEL_DATE, PRINTED_BY)
   VALUES (:W_SSN_ID, :WH_ID, :WK_NEW_LOCN_ID, 'LB', 'NOW', :PRINTED_BY);     
   
   /* Return ISSN value to the caller */
   ISSN = W_SSN_ID;
        
   
   /* Insert data into ISSN table */
   WHILE (P_SSN_ID < SSN_ID) DO
   BEGIN
      I_SSN_ID = '';
      I_LEN_SSN_ID = STRLEN(P_SSN_ID);
      
      /* Padding leading with 0 */
      WHILE (I_LEN_SSN_ID < :SSN_LENGTH) DO
      BEGIN
       I_SSN_ID = I_SSN_ID || '0';
       I_LEN_SSN_ID = I_LEN_SSN_ID + 1;
      END
      I_SSN_ID = I_SSN_ID || P_SSN_ID;
      
      INSERT INTO ISSN (SSN_ID, ORIGINAL_SSN, WH_ID, LOCN_ID)
      VALUES (:I_SSN_ID, :W_SSN_ID, :WH_ID, :WK_NEW_LOCN_ID); 
      
      P_SSN_ID = P_SSN_ID + 1;
   END
                
END ^

ALTER PROCEDURE ADD_SSN_LEGACY (SSN_ID VARCHAR(20) CHARACTER SET NONE,
LEGACY_ID VARCHAR(20) CHARACTER SET NONE)
AS 
   
      
  DECLARE VARIABLE REC_EXIST INTEGER; 
BEGIN
  REC_EXIST = 0; 
  
  /* Check if record exists */
  SELECT 1
  FROM SSN_LEGACY
  WHERE SSN_ID = :SSN_ID
  AND LEGACY_ID = :LEGACY_ID  
  INTO :REC_EXIST;  

  /* if record exists then no insert */
  IF (REC_EXIST = 0) THEN
  BEGIN 
    INSERT INTO SSN_LEGACY (SSN_ID, LEGACY_ID)
    VALUES (:SSN_ID, :LEGACY_ID);             
  END
END ^

ALTER PROCEDURE ADD_SSN_TYPE_COND (SSN_ID VARCHAR(20) CHARACTER SET NONE,
STATUS CHAR(1) CHARACTER SET NONE,
TYPE_CODE VARCHAR(40) CHARACTER SET NONE,
PERSON_ID VARCHAR(10) CHARACTER SET NONE,
DEVICE_ID VARCHAR(2) CHARACTER SET NONE)
AS 
 
    

DECLARE VARIABLE REC_EXIST INTEGER; 
DECLARE VARIABLE sTypeCode VARCHAR(40);
DECLARE VARIABLE sTypeHeaderCode VARCHAR(40);
DECLARE VARIABLE sTypeLineCode VARCHAR(40);
DECLARE VARIABLE sMandatory CHAR(1);
DECLARE VARIABLE sDesc VARCHAR(100);

BEGIN
   IF (:STATUS = 'A') THEN
   BEGIN
      FOR 
         SELECT TYPE_CODE, TYPE_HEADER_CODE, MANDATORY 
         FROM TYPE_HEADER
         WHERE TYPE_CODE = :TYPE_CODE         
         INTO sTypeCode, :sTypeHeaderCode, :sMandatory
      DO
      BEGIN 
         REC_EXIST = 0;
         sDesc = 'Record check first arrival ' || :sTypeHeaderCode || ' created';                 
         
         SELECT 1
         FROM SSN_TYPE_COND
         WHERE SSN_ID = :SSN_ID
         AND STATUS = :STATUS
         AND TYPE_CODE = :TYPE_CODE
         AND TYPE_HEADER_CODE = :sTypeHeaderCode
         INTO :REC_EXIST;
         
         IF (REC_EXIST = 0) THEN
         BEGIN      
           INSERT INTO SSN_TYPE_COND (SSN_ID, STATUS, TYPE_CODE, TYPE_HEADER_CODE, MANDATORY)
           VALUES (:SSN_ID, :STATUS, :TYPE_CODE, :sTypeHeaderCode, :sMandatory);
           
           /* Add inspection history for status 'A' */                                                                                     
    EXECUTE PROCEDURE ADD_INSP_HIST(:SSN_ID, :STATUS, 'NOW', :TYPE_CODE,
                                          :sTypeHeaderCode, '', :sDesc, :PERSON_ID, :DEVICE_ID);
                      
         END
      END                           
   END
   ELSE IF (:STATUS = 'B') THEN
   BEGIN
      FOR 
         SELECT TYPE_HEADER_CODE, MANDATORY, TYPE_LINE_CODE 
         FROM SSN_TYPE_COND
         WHERE SSN_ID = :SSN_ID
         AND STATUS = 'A'
         AND TYPE_CODE = :TYPE_CODE         
         INTO :sTypeHeaderCode, :sMandatory, :sTypeLineCode
      DO
      BEGIN
         REC_EXIST = 0;
  sDesc = 'Record asset condition ' || :sTypeHeaderCode || ' created';                 
           
  SELECT 1
  FROM SSN_TYPE_COND
  WHERE SSN_ID = :SSN_ID
  AND STATUS = :STATUS
  AND TYPE_CODE = :TYPE_CODE
  AND TYPE_HEADER_CODE = :sTypeHeaderCode  
  INTO :REC_EXIST;
           
  IF (REC_EXIST = 0) THEN
  BEGIN      
     INSERT INTO SSN_TYPE_COND (SSN_ID, STATUS, TYPE_CODE, TYPE_HEADER_CODE, 
                                MANDATORY, TYPE_LINE_CODE)
     VALUES (:SSN_ID, :STATUS, :TYPE_CODE, :sTypeHeaderCode, :sMandatory, :sTypeLineCode);
             
     /* Add inspection history for status 'B' */                                                                                     
     EXECUTE PROCEDURE ADD_INSP_HIST(:SSN_ID, :STATUS, 'NOW', :TYPE_CODE,
                 :sTypeHeaderCode, :sTypeLineCode, :sDesc, :PERSON_ID, :DEVICE_ID);
                        
         END
      END      
   END
END ^

ALTER PROCEDURE ADD_TASK_SCHEDULE (SSNID VARCHAR(20) CHARACTER SET NONE,
ACTIONNOTES BLOB)
AS 

BEGIN

   INSERT INTO task_schedule
        (ACTION_COMPLETED, SSN_ID, ACTION_NOTES, ENTRY_DATE)

   VALUES ('N', :SSNID, :ACTIONNOTES, 'NOW');

  SUSPEND;
END ^

ALTER PROCEDURE ADD_TEST_RESULTS (SSN VARCHAR(20) CHARACTER SET NONE,
TESTTIME TIMESTAMP,
QUESTION VARCHAR(70) CHARACTER SET NONE,
RESPONSE VARCHAR(50) CHARACTER SET NONE,
NOTES BLOB,
TEXTRESPONSE VARCHAR(30) CHARACTER SET NONE,
NUMBERRESPONSE FLOAT,
DATERESPONSE TIMESTAMP,
UPDATEFIELD VARCHAR(30) CHARACTER SET NONE,
RUNPROCEDURE VARCHAR(30) CHARACTER SET NONE,
FIELDTYPE INTEGER,
CATEGORY VARCHAR(1) CHARACTER SET NONE,
PASS VARCHAR(6) CHARACTER SET NONE,
ORIGINAL VARCHAR(1) CHARACTER SET NONE,
USERID VARCHAR(10) CHARACTER SET NONE,
QUESTION_ID INTEGER,
RESPONSE_ID INTEGER)
AS 

BEGIN
   INSERT INTO ssn_test_results
        (SSN_ID, TIME_STAMP, question, RESPONSE, NOTES, NUMBER_RESPONSE,
         DATE_RESPONSE, FIELD_TYPE, TEXT_RESPONSE, UPDATE_FIELD, RUN_PROCEDURE,
         INSPECT_CATEGORY, INSPECT_PASS_CRITERIA, ORIGINAL_TEST, USER_ID,
         Question_ID, Response_ID)

   VALUES (:SSN, :TESTTIME, :QUESTION, :RESPONSE,:NOTES, :NUMBERRESPONSE,
          :DATERESPONSE, :FIELDTYPE, :TEXTRESPONSE, :UPDATEFIELD, :RUNPROCEDURE,
          :CATEGORY, :PASS, :ORIGINAL, :USERID, :QUESTION_ID, :RESPONSE_ID );
END ^

ALTER PROCEDURE ADD_TRAN (WH_ID CHAR(2) CHARACTER SET NONE,
LOCN_ID VARCHAR(10) CHARACTER SET NONE,
OBJECT VARCHAR(30) CHARACTER SET NONE,
TRN_TYPE VARCHAR(4) CHARACTER SET NONE,
TRN_CODE CHAR(1) CHARACTER SET NONE,
TRN_DATE TIMESTAMP,
REFERENCE VARCHAR(255) CHARACTER SET NONE,
QTY INTEGER,
COMPLETE CHAR(1) CHARACTER SET NONE,
ERROR_TEXT VARCHAR(255) CHARACTER SET NONE,
INSTANCE_ID CHAR(10) CHARACTER SET NONE,
EXPORTED INTEGER,
SUB_LOCN_ID VARCHAR(10) CHARACTER SET NONE,
INPUT_SOURCE VARCHAR(10) CHARACTER SET NONE,
PERSON_ID VARCHAR(10) CHARACTER SET NONE,
DEVICE_ID CHAR(2) CHARACTER SET NONE)
AS 
DECLARE VARIABLE REC_EXIST INTEGER; 
  DECLARE VARIABLE REC_ID INTEGER;   
BEGIN
  REC_EXIST = 0;   

  /* Check if record exists */
  /*
  SELECT COUNT(OBJECT)
  FROM TRANSACTIONS
  WHERE WH_ID = :WH_ID
  AND LOCN_ID = :LOCN_ID
  AND OBJECT = :OBJECT
  AND TRN_TYPE = :TRN_TYPE 
  AND TRN_CODE = :TRN_CODE 
  AND TRN_DATE = :TRN_DATE 
  AND PERSON_ID = :PERSON_ID
  AND DEVICE_ID = :DEVICE_ID
  AND COMPLETE = 'F' 
  INTO :REC_EXIST;  
  */
  
  /* record is not exists, then insert new record */
  IF (REC_EXIST = 0) THEN
  BEGIN  
    REC_ID = GEN_ID(TRANSACTION_ID, 1);    
    INSERT INTO TRANSACTIONS   
           (RECORD_ID, WH_ID, LOCN_ID, OBJECT, TRN_TYPE, TRN_CODE, TRN_DATE, REFERENCE, QTY, COMPLETE, ERROR_TEXT, INSTANCE_ID, EXPORTED, SUB_LOCN_ID, INPUT_SOURCE, PERSON_ID, DEVICE_ID)
    VALUES (:REC_ID, :WH_ID, :LOCN_ID, :OBJECT, :TRN_TYPE, :TRN_CODE, :TRN_DATE, :REFERENCE, :QTY, :COMPLETE, :ERROR_TEXT, :INSTANCE_ID, :EXPORTED, :SUB_LOCN_ID, :INPUT_SOURCE, :PERSON_ID, :DEVICE_ID);
  END
  ELSE
  BEGIN
    UPDATE TRANSACTIONS
      SET 
           REFERENCE = :REFERENCE, 
  QTY = :QTY, 
           ERROR_TEXT = :ERROR_TEXT, 
  INSTANCE_ID = :INSTANCE_ID, 
           EXPORTED = :EXPORTED, 
  SUB_LOCN_ID = :SUB_LOCN_ID, 
           INPUT_SOURCE = :INPUT_SOURCE  
  WHERE WH_ID = :WH_ID
  AND LOCN_ID = :LOCN_ID
  AND OBJECT = :OBJECT
  AND TRN_TYPE = :TRN_TYPE 
  AND TRN_CODE = :TRN_CODE 
  AND TRN_DATE = :TRN_DATE 
  AND PERSON_ID = :PERSON_ID
  AND DEVICE_ID = :DEVICE_ID
  AND COMPLETE = 'F';
  END
END ^

ALTER PROCEDURE ADD_TRAN_ERROR (WH_ID CHAR(2) CHARACTER SET NONE,
LOCN_ID VARCHAR(10) CHARACTER SET NONE,
OBJECT VARCHAR(30) CHARACTER SET NONE,
TRN_TYPE VARCHAR(4) CHARACTER SET NONE,
TRN_CODE CHAR(1) CHARACTER SET NONE,
TRN_DATE TIMESTAMP,
REFERENCE VARCHAR(255) CHARACTER SET NONE,
QTY INTEGER,
COMPLETE CHAR(1) CHARACTER SET NONE,
ERROR_TEXT VARCHAR(255) CHARACTER SET NONE,
INSTANCE_ID CHAR(10) CHARACTER SET NONE,
EXPORTED INTEGER,
SUB_LOCN_ID VARCHAR(10) CHARACTER SET NONE,
INPUT_SOURCE VARCHAR(10) CHARACTER SET NONE,
PERSON_ID VARCHAR(10) CHARACTER SET NONE,
DEVICE_ID CHAR(2) CHARACTER SET NONE)
AS 
DECLARE VARIABLE REC_ID INTEGER; 
BEGIN
  REC_ID = GEN_ID(TRANSACTION_ID, 1); 
    
  INSERT INTO TRAN_ERROR   
         (RECORD_ID, WH_ID, LOCN_ID, OBJECT, TRN_TYPE, TRN_CODE, TRN_DATE, REFERENCE, QTY, COMPLETE, ERROR_TEXT, INSTANCE_ID, EXPORTED, SUB_LOCN_ID, INPUT_SOURCE, PERSON_ID, DEVICE_ID)
  VALUES (:REC_ID, :WH_ID, :LOCN_ID, :OBJECT, :TRN_TYPE, :TRN_CODE, :TRN_DATE, :REFERENCE, :QTY, :COMPLETE, :ERROR_TEXT, :INSTANCE_ID, :EXPORTED, :SUB_LOCN_ID, :INPUT_SOURCE, :PERSON_ID, :DEVICE_ID);
  
END ^

ALTER PROCEDURE ADD_TRAN_RESPONSE (WH_ID CHAR(2) CHARACTER SET NONE,
LOCN_ID VARCHAR(10) CHARACTER SET NONE,
OBJECT VARCHAR(30) CHARACTER SET NONE,
TRN_TYPE VARCHAR(4) CHARACTER SET NONE,
TRN_CODE CHAR(1) CHARACTER SET NONE,
TRN_DATE TIMESTAMP,
REFERENCE VARCHAR(255) CHARACTER SET NONE,
QTY INTEGER,
COMPLETE CHAR(1) CHARACTER SET NONE,
ERROR_TEXT VARCHAR(255) CHARACTER SET NONE,
INSTANCE_ID CHAR(10) CHARACTER SET NONE,
EXPORTED INTEGER,
SUB_LOCN_ID VARCHAR(10) CHARACTER SET NONE,
INPUT_SOURCE VARCHAR(10) CHARACTER SET NONE,
PERSON_ID VARCHAR(10) CHARACTER SET NONE,
DEVICE_ID CHAR(2) CHARACTER SET NONE)
RETURNS (RESPONSE_TEXT VARCHAR(255) CHARACTER SET NONE)
AS 
DECLARE VARIABLE REC_EXIST INTEGER; 
DECLARE VARIABLE REC_ID INTEGER;   
DECLARE VARIABLE WK_RESPONSE_TEXT VARCHAR(256);   
DECLARE VARIABLE WK_FILENAME VARCHAR(80);   
BEGIN
  REC_EXIST = 0;   
  WK_FILENAME = '/tmp/addtranresp.log';

  /* record is not exists, then insert new record */
  BEGIN  
    REC_ID = GEN_ID(TRANSACTION_ID, 1);    
    DELETE FROM TRANSACTIONS_WORK WHERE RECORD_ID = :REC_ID;
    WK_RESPONSE_TEXT = '';
    INSERT INTO TRANSACTIONS   
           (RECORD_ID, WH_ID, LOCN_ID, OBJECT, TRN_TYPE, TRN_CODE, TRN_DATE, REFERENCE, QTY, COMPLETE, ERROR_TEXT, INSTANCE_ID, EXPORTED, SUB_LOCN_ID, INPUT_SOURCE, PERSON_ID, DEVICE_ID)
    VALUES (:REC_ID, :WH_ID, :LOCN_ID, :OBJECT, :TRN_TYPE, :TRN_CODE, :TRN_DATE, :REFERENCE, :QTY, :COMPLETE, :ERROR_TEXT, :INSTANCE_ID, :EXPORTED, :SUB_LOCN_ID, :INPUT_SOURCE, :PERSON_ID, :DEVICE_ID);
    REC_EXIST = 0;
    SELECT COUNT(*)
    FROM TRANSACTIONS 
    WHERE RECORD_ID = :REC_ID
    INTO :REC_EXIST;
    IF (REC_EXIST IS NULL) THEN
    BEGIN
       REC_EXIST = 0;
    END
    IF (REC_EXIST > 0) THEN
    BEGIN
       SELECT ERROR_TEXT 
       FROM TRANSACTIONS 
       WHERE RECORD_ID = :REC_ID
       INTO :WK_RESPONSE_TEXT;
       RESPONSE_TEXT = WK_RESPONSE_TEXT;
       SUSPEND;
    END
    IF (REC_EXIST = 0) THEN
    BEGIN
       FOR SELECT ERROR_TEXT 
       FROM TRANSACTIONS_WORK 
       WHERE RECORD_ID = :REC_ID
       AND WH_ID = 'XX'
       AND LOCN_ID = 'TRANSACT'
       INTO :WK_RESPONSE_TEXT
       DO
       BEGIN
          RESPONSE_TEXT = WK_RESPONSE_TEXT;
          SUSPEND;
       END
    END
    EXECUTE PROCEDURE TRAN_ARCHIVE;
  END
END ^

ALTER PROCEDURE ADD_TRAN_V4 (TRN_VERSION CHAR(2) CHARACTER SET NONE,
TRN_TYPE VARCHAR(4) CHARACTER SET NONE,
TRN_CLASS CHAR(1) CHARACTER SET NONE,
TRN_DATE TIMESTAMP,
TRN_DELIMITER CHAR(1) CHARACTER SET NONE,
PERSON_ID VARCHAR(10) CHARACTER SET NONE,
DEVICE_ID CHAR(2) CHARACTER SET NONE,
MESSAGE_ID VARCHAR(10) CHARACTER SET NONE,
TRN_DATA VARCHAR(1024) CHARACTER SET NONE,
COMPLETE CHAR(1) CHARACTER SET NONE,
ERROR_TEXT VARCHAR(255) CHARACTER SET NONE,
INSTANCE_ID CHAR(10) CHARACTER SET NONE,
EXPORTED INTEGER,
INPUT_SOURCE VARCHAR(512) CHARACTER SET NONE)
RETURNS (REC_ID INTEGER)
AS 
 
 
DECLARE VARIABLE WK_LOG VARCHAR(2048);
        
BEGIN
  
  /* insert new record */
    REC_ID = GEN_ID(TRANSACTION_ID, 1);    
    WK_LOG = 'INSERT INTO TRANSACTIONS4 RECORD ' || :REC_ID || ' TYPE ' || :TRN_TYPE || ' DATA ' || :TRN_DATA || ' ERROR ' || :ERROR_TEXT;
    INSERT INTO LOG(DESCRIPTION) VALUES (:WK_LOG);
    INSERT INTO TRANSACTIONS4   
           (RECORD_ID, TRN_VERSION, TRN_DELIMITER, MESSAGE_ID, TRN_TYPE, TRN_CLASS, TRN_DATE, TRN_DATA, COMPLETE, ERROR_TEXT, INSTANCE_ID, EXPORTED, INPUT_SOURCE, PERSON_ID, DEVICE_ID)
    VALUES (:REC_ID, :TRN_VERSION, :TRN_DELIMITER, :MESSAGE_ID, :TRN_TYPE, :TRN_CLASS, :TRN_DATE, :TRN_DATA, :COMPLETE, :ERROR_TEXT, :INSTANCE_ID, :EXPORTED, :INPUT_SOURCE, :PERSON_ID, :DEVICE_ID);
    SUSPEND;
END ^

ALTER PROCEDURE ADD_UPDATE_STOCKTAKE (RECORD_ID VARCHAR(10) CHARACTER SET NONE,
ST_SSN_ID VARCHAR(20) CHARACTER SET NONE,
ST_WH_ID CHAR(2) CHARACTER SET NONE,
ST_LOCN_ID VARCHAR(10) CHARACTER SET NONE,
ST_COUNT DOUBLE PRECISION,
ST_VARIANCE DOUBLE PRECISION,
ST_AUDIT_DATE TIMESTAMP,
ST_AUDIT_BY VARCHAR(10) CHARACTER SET NONE,
ST_DEVICE_ID CHAR(2) CHARACTER SET NONE,
ST_STATUS CHAR(2) CHARACTER SET NONE,
ST_ACTION CHAR(2) CHARACTER SET NONE,
ST_APPLIED_DATE TIMESTAMP,
ST_APPLIED_BY VARCHAR(10) CHARACTER SET NONE,
ST_APPLIED_DEVICE_ID CHAR(2) CHARACTER SET NONE,
ST_COMPANY_ID VARCHAR(20) CHARACTER SET NONE)
RETURNS (NEW_RECORD_ID VARCHAR(10) CHARACTER SET NONE)
AS 
DECLARE VARIABLE REC_ID VARCHAR(10);

BEGIN

    IF ((RECORD_ID IS NULL) OR (RECORD_ID = 0)) THEN
    BEGIN
       REC_ID = GEN_ID(STOCKTAKE_ID_GEN,1);
       INSERT INTO STOCKTAKE
       (RECORD_ID, ST_SSN_ID, ST_WH_ID, ST_LOCN_ID, ST_COUNT, ST_VARIANCE, ST_AUDIT_DATE, ST_AUDIT_BY, ST_DEVICE_ID, ST_STATUS, ST_ACTION, ST_APPLIED_DATE, ST_APPLIED_BY, ST_APPLIED_DEVICE_ID, ST_COMPANY_ID)
       VALUES
       (:REC_ID, :ST_SSN_ID, :ST_WH_ID, :ST_LOCN_ID, :ST_COUNT, :ST_VARIANCE, :ST_AUDIT_DATE, :ST_AUDIT_BY, :ST_DEVICE_ID, :ST_STATUS, :ST_ACTION, :ST_APPLIED_DATE, :ST_APPLIED_BY, :ST_APPLIED_DEVICE_ID, :ST_COMPANY_ID);
        NEW_RECORD_ID = REC_ID;
    END
    ELSE
    BEGIN
       UPDATE STOCKTAKE
       SET
       ST_SSN_ID = :ST_SSN_ID,
       ST_WH_ID = :ST_WH_ID,
       ST_LOCN_ID = :ST_LOCN_ID,
       ST_COUNT = :ST_COUNT,
       ST_VARIANCE = :ST_VARIANCE,
       ST_AUDIT_DATE = :ST_AUDIT_DATE,
       ST_AUDIT_BY = :ST_AUDIT_BY,
       ST_DEVICE_ID = :ST_DEVICE_ID,
       ST_STATUS = :ST_STATUS,
       ST_ACTION = :ST_ACTION,
       ST_APPLIED_DATE = :ST_APPLIED_DATE,
       ST_APPLIED_BY = :ST_APPLIED_BY,
       ST_APPLIED_DEVICE_ID = :ST_APPLIED_DEVICE_ID,
       ST_COMPANY_ID = :ST_COMPANY_ID
       WHERE RECORD_ID = :RECORD_ID;
       NEW_RECORD_ID = RECORD_ID;
    END
    SUSPEND;

END ^

ALTER PROCEDURE APPROVE_SALES_ORDER (PICK_ORDER VARCHAR(10) CHARACTER SET NONE,
STATUS_SSN CHAR(2) CHARACTER SET NONE,
PICK_STATUS CHAR(2) CHARACTER SET NONE,
APPROVED_BY VARCHAR(10) CHARACTER SET NONE)
RETURNS (VALID_SO CHAR(1) CHARACTER SET NONE)
AS 
DECLARE VARIABLE SSSN VARCHAR(20);
DECLARE VARIABLE SPROD_ID VARCHAR(30);
DECLARE VARIABLE ICOUNT INTEGER;
DECLARE VARIABLE SWH CHAR(2);
DECLARE VARIABLE SLOCN VARCHAR(10);
DECLARE VARIABLE SPICKLABELNO VARCHAR(7);
DECLARE VARIABLE IMPORTSTATUS VARCHAR(40);
DECLARE VARIABLE RESERVEDSTATUS VARCHAR(40);
DECLARE VARIABLE WK_FOUND INTEGER;
DECLARE VARIABLE WK_SSNID VARCHAR(20);
DECLARE VARIABLE WK_LOG_FILENAME VARCHAR(255);
DECLARE VARIABLE WK_LOG_RESULT INTEGER;
DECLARE VARIABLE WK_NOCONFIRM CHAR(1);
DECLARE VARIABLE WK_HAVE_A_LINE CHAR(1);
BEGIN
    ICOUNT = 0;
    VALID_SO = 'T';    
    WK_NOCONFIRM = 'F';    
    WK_LOG_FILENAME = '/tmp/approve.log';
    
    WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, 'start approve ');
    WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, 'order:' || PICK_ORDER || ' STATUS_SSN:' || STATUS_SSN || ' PICK_STATUS:' || PICK_STATUS || ' Approved by:' || APPROVED_BY);
    /* CHECK SALE ORDER LINES FIRST */
    SELECT COUNT(*)
    FROM PICK_ITEM
    WHERE PICK_ORDER = :PICK_ORDER               
    INTO :ICOUNT;
    
    IF (:ICOUNT = 0) THEN
    BEGIN
        VALID_SO = 'L';
        SUSPEND;
        EXIT;
    END
    /* GET VALID STATUSES */
    SELECT CONTROL.PICK_IMPORT_SSN_STATUS,CONTROL.PICK_RESERVED_SSN_STATUS,CONFIRM_WITH_NO_PROD
    FROM CONTROL
    INTO :IMPORTSTATUS, :RESERVEDSTATUS, :WK_NOCONFIRM;
    IF (WK_NOCONFIRM IS NULL) THEN
    BEGIN
       WK_NOCONFIRM = 'F';
    END

    /* check for any confirmed lines */
    FOR 
      SELECT PICK_LABEL_NO, SSN_ID, PROD_ID
      FROM PICK_ITEM
      WHERE PICK_ORDER = :PICK_ORDER
      AND ((PICK_ITEM.PICK_LINE_STATUS = 'CF'))

      INTO :SPICKLABELNO, :SSSN, :SPROD_ID
    DO
    BEGIN
      IF (:SSSN IS NOT NULL) THEN
      BEGIN
              WK_FOUND = 0;
              /* CHECK TO FIND AN ISSN THAT CAN BE RESERVED */
              /* WHERE ISSN.ORIGINAL_SSN = :SSSN */
              SELECT FIRST 1 1, SSN_ID, WH_ID, LOCN_ID FROM ISSN
              WHERE ISSN.SSN_ID = :SSSN
              INTO :WK_FOUND, :WK_SSNID, :SWH, :SLOCN;
              IF (WK_FOUND = 1) THEN
              BEGIN
                 /* UPDATE ISSN STATUS*/
                 
                 IF (:PICK_STATUS = 'OP') THEN
                 BEGIN
                   /* UPDATE WH, LOCATION IN PICK ITEM */
                   UPDATE PICK_ITEM
                   SET WH_ID = :SWH,
                       PICK_LOCATION = :SLOCN,
                       PICK_LINE_STATUS = :PICK_STATUS,
                       PICK_ITEM.REASON = ''
                   WHERE PICK_LABEL_NO = :SPICKLABELNO;
                 END
              END
              ELSE 
              BEGIN
                 WK_FOUND = 0;
                 /* CHECK TO FIND AN ISSN THAT CAN BE RESERVED */
                 /* WHERE ISSN.ORIGINAL_SSN = :SSSN */
                 SELECT FIRST 1 1, SSN_ID, WH_ID, LOCN_ID FROM ISSN
                 WHERE ISSN.ORIGINAL_SSN = :SSSN
                 INTO :WK_FOUND, :WK_SSNID, :SWH, :SLOCN;
                 IF (WK_FOUND = 1) THEN
                 BEGIN
                    /* UPDATE ISSN STATUS*/
                    
                    IF (:PICK_STATUS = 'OP') THEN
                    BEGIN
                      /* UPDATE WH, LOCATION IN PICK ITEM */
                      UPDATE PICK_ITEM
                      SET WH_ID = :SWH,
                          PICK_LOCATION = :SLOCN,
                          PICK_LINE_STATUS = :PICK_STATUS,
                          PICK_ITEM.REASON = ''
                      WHERE PICK_LABEL_NO = :SPICKLABELNO;
                    END
                 END
                 ELSE 
                 BEGIN
                    IF (WK_NOCONFIRM = 'F') THEN
                    BEGIN
                       VALID_SO = 'C';
                       UPDATE PICK_ITEM
                       SET PICK_ITEM.REASON = 'NO ITEM FOUND TO APPROVE'
                       WHERE PICK_LABEL_NO = :SPICKLABELNO;
                    END
                    ELSE
                    BEGIN
                       IF (:PICK_STATUS = 'OP') THEN
                       BEGIN
                         /* UPDATE WH, LOCATION IN PICK ITEM */
                          UPDATE PICK_ITEM
                         SET PICK_LINE_STATUS = :PICK_STATUS,
                             PICK_ITEM.REASON = ''
                         WHERE PICK_LABEL_NO = :SPICKLABELNO;
                       END
                    END
                 END
              END
      END
      ELSE 
      BEGIN
              WK_FOUND = 0;
              IF (WK_NOCONFIRM = 'F') THEN
              BEGIN
                 /* CHECK TO FIND AN ISSN THAT CAN BE RESERVED */
                 SELECT FIRST 1 1, SSN_ID, WH_ID, LOCN_ID FROM ISSN
                 WHERE ISSN.PROD_ID = :SPROD_ID
                 AND (POS(:IMPORTSTATUS,ISSN.ISSN_STATUS,0,1) > -1)
                 INTO :WK_FOUND, :WK_SSNID, :SWH, :SLOCN;
                 IF (WK_FOUND = 1) THEN
                 BEGIN
                    IF (:PICK_STATUS = 'OP') THEN
                    BEGIN
                      /* UPDATE WH, LOCATION IN PICK ITEM */
                      UPDATE PICK_ITEM
                      SET WH_ID = :SWH,
                          PICK_LOCATION = :SLOCN,
                          PICK_LINE_STATUS = :PICK_STATUS,
                          PICK_ITEM.REASON = ''
                      WHERE PICK_LABEL_NO = :SPICKLABELNO;
                    END
                 END
                 ELSE 
                 BEGIN
                   VALID_SO = 'F';
                   UPDATE PICK_ITEM
                   SET PICK_ITEM.REASON = 'NO ITEM FOUND TO RESERVE'
                   WHERE PICK_LABEL_NO = :SPICKLABELNO;
                 END
              END
              ELSE
              BEGIN
                 IF (:PICK_STATUS = 'OP') THEN
                 BEGIN
                   /* UPDATE WH, LOCATION IN PICK ITEM */
                   UPDATE PICK_ITEM
                   SET PICK_LINE_STATUS = :PICK_STATUS,
                       PICK_ITEM.REASON = ''
                   WHERE PICK_LABEL_NO = :SPICKLABELNO;
                 END
              END
      END
    END

    /* check for any unconfirmed lines */
    FOR 
      SELECT PICK_LABEL_NO, SSN_ID, PROD_ID
      FROM PICK_ITEM
      WHERE PICK_ORDER = :PICK_ORDER
      AND ((PICK_ITEM.PICK_LINE_STATUS = 'UC') OR (PICK_ITEM.PICK_LINE_STATUS IS NULL))

      INTO :SPICKLABELNO, :SSSN, :SPROD_ID
    DO
    BEGIN
      IF (:SSSN IS NOT NULL) THEN
      BEGIN
              WK_FOUND = 0;
              /* CHECK TO FIND AN ISSN THAT CAN BE RESERVED */
              /* WHERE ISSN.ORIGINAL_SSN = :SSSN */
              VALID_SO = 'U';
              /* UPDATE PICK_ITEM
              SET PICK_ITEM.REASON = 'CANNOT APPROVE - ITEM NEEDS CONFIRM'
              WHERE PICK_LABEL_NO = :SPICKLABELNO; */
      END
      ELSE 
      BEGIN
              WK_FOUND = 0;
              VALID_SO = 'U';
              /* UPDATE PICK_ITEM
              SET PICK_ITEM.REASON = 'CANNOT APPROVE - ITEM NEEDS CONFIRM'
              WHERE PICK_LABEL_NO = :SPICKLABELNO; */
      END
    END
    
    /* check for any open lines */
    /*
    WK_HAVE_A_LINE = 'N';
    FOR 
      SELECT PICK_LABEL_NO, SSN_ID, PROD_ID
      FROM PICK_ITEM
      WHERE PICK_ORDER = :PICK_ORDER
      AND ((PICK_ITEM.PICK_LINE_STATUS = 'OP') )

      INTO :SPICKLABELNO, :SSSN, :SPROD_ID
    DO
    BEGIN
      WK_HAVE_A_LINE = 'T';
    END
    IF (VALID_SO = 'T') THEN
    BEGIN
       IF (WK_HAVE_A_LINE = 'N') THEN
       BEGIN
          VALID_SO = 'N';
       END
    END
    */
    
    /* UPDATE PICK ORDER STATUS */
    IF (VALID_SO = 'T') THEN
    BEGIN
            IF (:PICK_STATUS = 'OP') THEN
            BEGIN
              UPDATE PICK_ORDER
              SET PICK_STATUS = :PICK_STATUS,
                  APPROVED_DATE = 'NOW',
                  APPROVED_BY = :APPROVED_BY
              WHERE PICK_ORDER = :PICK_ORDER;
            END
            ELSE
            BEGIN
               IF (:PICK_STATUS = 'DA') THEN
               BEGIN
                 UPDATE PICK_ORDER
                 SET PICK_STATUS = :PICK_STATUS,
                     APPROVED_DESP_DATE = 'NOW',
                     APPROVED_DESP_BY = :APPROVED_BY
                 WHERE PICK_ORDER = :PICK_ORDER;
               END
               ELSE
               BEGIN
                 UPDATE PICK_ORDER
                 SET PICK_STATUS = :PICK_STATUS
                 WHERE PICK_ORDER = :PICK_ORDER;
               END
            END
    END
    WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, 'end approve ' || VALID_SO);
    SUSPEND;
END ^

ALTER PROCEDURE AVAILABLE_PRODUCTS RETURNS (PROD_ID VARCHAR(30) CHARACTER SET NONE,
SHORT_DESC VARCHAR(50) CHARACTER SET NONE,
CURRENT_QTY INTEGER)
AS 
 

DECLARE VARIABLE IMPORTSTATUS VARCHAR(40);
BEGIN
   /*
    RETURNS ALL PRODUCTS THAT ARE AVAILABLE FOR PICKING
   */
   SELECT CONTROL.PICK_IMPORT_SSN_STATUS
   FROM CONTROL
   INTO :IMPORTSTATUS;
   
   FOR SELECT ISSN.PROD_ID,
                   PROD_PROFILE.SHORT_DESC,
                   SUM( ISSN.CURRENT_QTY ) AS SUM_OF_CURRENT_QTY
           FROM PROD_PROFILE
              LEFT OUTER JOIN ISSN ON (ISSN.PROD_ID = PROD_PROFILE.PROD_ID)
           WHERE
                 (POS(:IMPORTSTATUS,ISSN.ISSN_STATUS,0,1) > -1)
           GROUP BY ISSN.PROD_ID, PROD_PROFILE.SHORT_DESC
        INTO :PROD_ID, :SHORT_DESC, :CURRENT_QTY
   DO BEGIN
     SUSPEND;
   END
END ^

ALTER PROCEDURE CALC_CHECK_DIGIT_BDCS (IN_INPUT VARCHAR(255) CHARACTER SET NONE,
IN_INCLUDE_LAST CHAR(1) CHARACTER SET NONE)
RETURNS (OUT_DATA VARCHAR(255) CHARACTER SET NONE)
AS 
DECLARE VARIABLE WK_LEN_INPUT INTEGER;
DECLARE VARIABLE WK_INPUT VARCHAR(255);
DECLARE VARIABLE WK_ODD_SUM   INTEGER;
DECLARE VARIABLE WK_EVEN_SUM  INTEGER;
DECLARE VARIABLE WK_SUM  INTEGER;
DECLARE VARIABLE WK_CHECK_DIGIT INTEGER;
DECLARE VARIABLE WK_IDX         INTEGER;
DECLARE VARIABLE WK_LOG_FILENAME VARCHAR(80);
DECLARE VARIABLE WK_RESULT      INTEGER;
DECLARE VARIABLE WK_LOG_BUFFER   VARCHAR(200);
DECLARE VARIABLE WK_DUMMY  INTEGER;
BEGIN 
   WK_LOG_FILENAME = '/tmp/chkdgt.log';
   /* if include last is 'F' then the last char should be the check digit - so exclude it from calc */
   /* IN_INCLUDE_LAST = 'F'; */
   WK_LOG_BUFFER =  'in ' || :in_input;
   IF (IN_INCLUDE_LAST = 'F') THEN
   BEGIN
      WK_LEN_INPUT = STRLEN(IN_INPUT) - 1;
      WK_INPUT = SUBSTR(IN_INPUT, 1, WK_LEN_INPUT );
   END   
   ELSE
   BEGIN
      WK_LEN_INPUT = STRLEN(IN_INPUT);
      WK_INPUT = IN_INPUT;
   END   
   WK_LOG_BUFFER =  'wkin ' || :wk_input;
   WK_LOG_BUFFER =  'wkinlen ' || :wk_len_input;

   WK_ODD_SUM = 0;
   WK_EVEN_SUM = 0;

   /* WK_IDX = 2; */
   WK_IDX = WK_LEN_INPUT - 1;
   /* WHILE (WK_IDX <= WK_LEN_INPUT) DO */
   WHILE (WK_IDX > 0) DO
   BEGIN
      IF (SUBSTR(WK_INPUT, WK_IDX, WK_IDX) > '0' AND SUBSTR(WK_INPUT, WK_IDX, WK_IDX) <= '9') THEN
      BEGIN
         WK_LOG_BUFFER =  'even char  ' || substr(wk_input, wk_idx, wk_idx);
         WK_EVEN_SUM = WK_EVEN_SUM + SUBSTR(WK_INPUT, WK_IDX, WK_IDX);
      END
      ELSE
      BEGIN
         IF (SUBSTR(WK_INPUT, WK_IDX, WK_IDX) = '0') THEN
         BEGIN
            WK_LOG_BUFFER =  'even char zero  ' || substr(wk_input, wk_idx, wk_idx);
            WK_DUMMY = 0;
         END
         ELSE
         BEGIN
            WK_LOG_BUFFER =  'even char ascii  ' || substr(wk_input, wk_idx, wk_idx);
            WK_LOG_BUFFER =  'asc ' || ascii(substr(wk_input, wk_idx, wk_idx));
            WK_LOG_BUFFER =  'mod ' || mod(ascii(substr(wk_input, wk_idx, wk_idx)), 10);
            WK_EVEN_SUM  = WK_EVEN_SUM +  MOD(ASCII(SUBSTR(WK_INPUT, WK_IDX, WK_IDX)), 10);
         END
      END
      /* WK_IDX = WK_IDX + 2; */
      WK_IDX = WK_IDX - 2;
   END
   WK_LOG_BUFFER =  'even ' || :wk_even_sum;
   /* WK_IDX = 1; */
   WK_IDX = WK_LEN_INPUT;
   /* WHILE (WK_IDX <= WK_LEN_INPUT) DO */
   WHILE (WK_IDX > 0) DO
   BEGIN
      IF (SUBSTR(WK_INPUT, WK_IDX, WK_IDX) > '0' AND SUBSTR(WK_INPUT, WK_IDX, WK_IDX) <= '9') THEN
      BEGIN
         WK_LOG_BUFFER =  'odd char  ' || substr(wk_input, wk_idx, wk_idx);
         WK_ODD_SUM = WK_ODD_SUM + SUBSTR(WK_INPUT, WK_IDX, WK_IDX);
      END
      ELSE
      BEGIN
         IF (SUBSTR(WK_INPUT, WK_IDX, WK_IDX) = '0') THEN
         BEGIN
            WK_LOG_BUFFER =  'odd char zero  ' || substr(wk_input, wk_idx, wk_idx);
            WK_DUMMY = 0;
         END
         ELSE
         BEGIN
            WK_LOG_BUFFER =  'odd char ascii  ' || substr(wk_input, wk_idx, wk_idx);
            WK_LOG_BUFFER =  'asc ' || ascii(substr(wk_input, wk_idx, wk_idx));
            WK_LOG_BUFFER =  'mod ' || mod(ascii(substr(wk_input, wk_idx, wk_idx)), 10);
            WK_ODD_SUM  = WK_ODD_SUM +  MOD(ASCII(SUBSTR(WK_INPUT, WK_IDX, WK_IDX)), 10);
         END
      END
      /* WK_IDX = WK_IDX + 2; */
      WK_IDX = WK_IDX - 2;
   END
   WK_LOG_BUFFER =  'odd ' || :wk_odd_sum;
   WK_SUM   = (WK_ODD_SUM * 3) + WK_EVEN_SUM;
   WK_LOG_BUFFER =  'sum ' || :wk_sum;
   WK_CHECK_DIGIT =  MOD(10 - MOD(WK_SUM, 10),10);
   WK_LOG_BUFFER =  'chkdgt ' || :wk_check_digit;
   OUT_DATA = WK_INPUT || WK_CHECK_DIGIT;
   WK_LOG_BUFFER =  'out ' || :out_data ;
   SUSPEND;
END ^

ALTER PROCEDURE CANCEL_SALE_LINE (PICK_LABEL VARCHAR(7) CHARACTER SET NONE,
REASON VARCHAR(255) CHARACTER SET NONE)
AS 
DECLARE VARIABLE sSSN VARCHAR(20);
DECLARE VARIABLE WK_LABEL VARCHAR(7);
DECLARE VARIABLE WK_STATUS CHAR(2);
DECLARE VARIABLE WK_DOIT CHAR(2);
DECLARE VARIABLE WK_SSN VARCHAR(20);
DECLARE VARIABLE WK_PROD VARCHAR(30);
DECLARE VARIABLE WK_PICK_ORDER VARCHAR(15);
DECLARE VARIABLE WK_PICK_ORDER_LINE_NO CHAR(4);
DECLARE VARIABLE WK_CONTACT_NAME VARCHAR(50);
DECLARE VARIABLE WK_WARRANTY_TERM VARCHAR(50);
DECLARE VARIABLE WK_PICK_LABEL_DATE TIMESTAMP;
DECLARE VARIABLE WK_SPECIAL_INSTRUCTIONS1 VARCHAR(8196);
DECLARE VARIABLE WK_SPECIAL_INSTRUCTIONS2 VARCHAR(255);
DECLARE VARIABLE WK_SHIP_VIA VARCHAR(10);
DECLARE VARIABLE WK_PICK_ORDER_QTY INTEGER;
DECLARE VARIABLE WK_PICK_ALLOCATED_QTY INTEGER;
DECLARE VARIABLE WK_PICKED_QTY INTEGER;
DECLARE VARIABLE WK_PICK_LINE_DUE_DATE TIMESTAMP;
DECLARE VARIABLE WK_PICK_STARTED TIMESTAMP;
DECLARE VARIABLE WK_DESPATCH_TS TIMESTAMP;
DECLARE VARIABLE WK_DESPATCH_LOCATION VARCHAR(10);
DECLARE VARIABLE WK_CREATE_DATE TIMESTAMP;
DECLARE VARIABLE WK_USER_ID VARCHAR(10);
DECLARE VARIABLE WK_DEVICE_ID CHAR(2);
DECLARE VARIABLE WK_CHECKIN_START TIMESTAMP;
DECLARE VARIABLE WK_CHECKIN_FINISH TIMESTAMP;
DECLARE VARIABLE WK_CHECKIN_USER_ID VARCHAR(10);
DECLARE VARIABLE WK_PARTIAL_PICK_ALLOWED CHAR(1);
DECLARE VARIABLE WK_DESPATCH_PALLET_NO VARCHAR(7);
DECLARE VARIABLE WK_WH_ID CHAR(2);
DECLARE VARIABLE WK_PICK_LOCATION VARCHAR(10);
DECLARE VARIABLE WK_SALE_PRICE NUMERIC(9,3);
DECLARE VARIABLE WK_DISCOUNT DOUBLE PRECISION;
DECLARE VARIABLE WK_SSN_CONFIRM  CHAR(1);
DECLARE VARIABLE WK_DO_UNPICK  CHAR(1);
DECLARE VARIABLE WK_DO_UASL  CHAR(1);

BEGIN
    /* Update Pick Order status */
    SELECT SEND_UASL_V4, ALLOW_UNPICK_IN_PICK_CANCEL
    FROM CONTROL 
    INTO :WK_DO_UASL,
         :WK_DO_UNPICK;
        
    /* Update Pick Item Status */
    FOR SELECT PICK_LABEL_NO, 
        PICK_LINE_STATUS, 
        SSN_ID, 
        PROD_ID,
        PICK_ORDER ,
        PICK_ORDER_LINE_NO ,
        CONTACT_NAME ,
        WARRANTY_TERM ,
        PICK_LABEL_DATE ,
        SPECIAL_INSTRUCTIONS1 ,
        SPECIAL_INSTRUCTIONS2 ,
        SHIP_VIA ,
        PICK_ORDER_QTY ,
        PICK_ALLOCATED_QTY ,
        PICKED_QTY ,
        PICK_LINE_DUE_DATE ,
        PICK_STARTED ,
        DESPATCH_TS ,
        DESPATCH_LOCATION ,
        CREATE_DATE ,
        USER_ID ,
        DEVICE_ID ,
        CHECKIN_START ,
        CHECKIN_FINISH ,
        CHECKIN_USER_ID ,
        PARTIAL_PICK_ALLOWED ,
        DESPATCH_PALLET_NO ,
        WH_ID ,
        PICK_LOCATION ,
        SALE_PRICE ,
        DISCOUNT ,
        SSN_CONFIRM 
       FROM PICK_ITEM 
       WHERE PICK_LABEL_NO = :PICK_LABEL
       INTO :WK_LABEL, 
       :WK_STATUS, 
       :WK_SSN, 
       :WK_PROD,
       :WK_PICK_ORDER ,
       :WK_PICK_ORDER_LINE_NO ,
       :WK_CONTACT_NAME ,
       :WK_WARRANTY_TERM ,
       :WK_PICK_LABEL_DATE ,
       :WK_SPECIAL_INSTRUCTIONS1 ,
       :WK_SPECIAL_INSTRUCTIONS2 ,
       :WK_SHIP_VIA ,
       :WK_PICK_ORDER_QTY ,
       :WK_PICK_ALLOCATED_QTY ,
       :WK_PICKED_QTY ,
       :WK_PICK_LINE_DUE_DATE ,
       :WK_PICK_STARTED ,
       :WK_DESPATCH_TS ,
       :WK_DESPATCH_LOCATION ,
       :WK_CREATE_DATE ,
       :WK_USER_ID ,
       :WK_DEVICE_ID ,
       :WK_CHECKIN_START ,
       :WK_CHECKIN_FINISH ,
       :WK_CHECKIN_USER_ID ,
       :WK_PARTIAL_PICK_ALLOWED ,
       :WK_DESPATCH_PALLET_NO ,
       :WK_WH_ID ,
       :WK_PICK_LOCATION ,
       :WK_SALE_PRICE ,
       :WK_DISCOUNT ,
       :WK_SSN_CONFIRM 
    DO
    BEGIN
       WK_DOIT = 'N';
       /* UPDATE PICK_ITEM SET REASON = :REASON
       WHERE PICK_LABEL_NO = :WK_LABEL; */ 
       INSERT INTO PICK_ITEM_CANCEL(
        PICK_LABEL_NO ,
        PICK_ORDER ,
        PICK_ORDER_LINE_NO ,
        CONTACT_NAME ,
        PROD_ID ,
        SSN_ID ,
        WARRANTY_TERM ,
        PICK_LABEL_DATE ,
        SPECIAL_INSTRUCTIONS1 ,
        SPECIAL_INSTRUCTIONS2 ,
        SHIP_VIA ,
        PICK_ORDER_QTY ,
        PICK_ALLOCATED_QTY ,
        PICKED_QTY ,
        PICK_LINE_DUE_DATE ,
        PICK_STARTED ,
        DESPATCH_TS ,
        DESPATCH_LOCATION ,
        CREATE_DATE ,
        USER_ID ,
        DEVICE_ID ,
        CHECKIN_START ,
        CHECKIN_FINISH ,
        CHECKIN_USER_ID ,
        PICK_LINE_STATUS ,
        PARTIAL_PICK_ALLOWED ,
        DESPATCH_PALLET_NO ,
        WH_ID ,
        PICK_LOCATION ,
        REASON ,
        SALE_PRICE ,
        DISCOUNT ,
        SSN_CONFIRM,
        CANCEL_METHOD )
   VALUES (
        :WK_LABEL ,
        :WK_PICK_ORDER ,
        :WK_PICK_ORDER_LINE_NO ,
        :WK_CONTACT_NAME ,
        :WK_PROD ,
        :WK_SSN ,
        :WK_WARRANTY_TERM ,
        :WK_PICK_LABEL_DATE ,
        :WK_SPECIAL_INSTRUCTIONS1 ,
        :WK_SPECIAL_INSTRUCTIONS2 ,
        :WK_SHIP_VIA ,
        :WK_PICK_ORDER_QTY ,
        :WK_PICK_ALLOCATED_QTY ,
        :WK_PICKED_QTY ,
        :WK_PICK_LINE_DUE_DATE ,
        :WK_PICK_STARTED ,
        :WK_DESPATCH_TS ,
        :WK_DESPATCH_LOCATION ,
        :WK_CREATE_DATE ,
        :WK_USER_ID ,
        :WK_DEVICE_ID ,
        :WK_CHECKIN_START ,
        :WK_CHECKIN_FINISH ,
        :WK_CHECKIN_USER_ID ,
        :WK_STATUS ,
        :WK_PARTIAL_PICK_ALLOWED ,
        :WK_DESPATCH_PALLET_NO ,
        :WK_WH_ID ,
        :WK_PICK_LOCATION ,
        :REASON ,
        :WK_SALE_PRICE ,
        :WK_DISCOUNT ,
        :WK_SSN_CONFIRM,
        'L' );

       IF (WK_STATUS IS NULL) THEN
       BEGIN
          WK_DOIT = 'UC';
       END
       IF (WK_STATUS = 'UC') THEN
       BEGIN
          WK_DOIT = 'UC';
       END
       IF (WK_STATUS = 'CF') THEN
       BEGIN
          WK_DOIT = 'CF';
       END
       IF (WK_STATUS = 'OP') THEN
       BEGIN
          WK_DOIT = 'CF';
       END
       IF (WK_STATUS = 'UP') THEN
       BEGIN
          WK_DOIT = 'CF';
       END
       IF (WK_STATUS = 'AL') THEN
       BEGIN
          WK_DOIT = 'PL';
       END
       IF (WK_STATUS = 'PG') THEN
       BEGIN
          WK_DOIT = 'PL';
       END
       IF (WK_STATUS = 'PL') THEN
       BEGIN
          WK_DOIT = 'PL';
       END
       IF (WK_STATUS = 'DS') THEN
       BEGIN
          WK_DOIT = 'PL';
       END
       IF (WK_DOIT = 'UC') THEN
       BEGIN
          /* Unconfirmed line so can just cancel the line - no change to issn */
          UPDATE  PICK_ITEM SET CANCEL_METHOD = 'L'
          WHERE PICK_LABEL_NO = :WK_LABEL;
          DELETE FROM PICK_ITEM
          WHERE PICK_LABEL_NO = :WK_LABEL;
           /* send to remote the available qty of the prod */
           IF (WK_DO_UASL = 'T') THEN
           BEGIN
              EXECUTE PROCEDURE SEND_PICKABLE_STOCK (:WK_PROD,
                 'BDCS',
                 'XX',
                 'NOW');
           END
       END
       IF (WK_DOIT = 'CF') THEN
       BEGIN
          /* Confirmed line so cancel the line and change status of issn*/
          IF (WK_SSN IS NOT NULL) THEN
          BEGIN
             UPDATE ISSN SET ISSN_STATUS = 'PA', PICK_ORDER = NULL
             WHERE ORIGINAL_SSN = :WK_SSN
               AND PICK_ORDER = :WK_LABEL;
          END
          UPDATE  PICK_ITEM SET CANCEL_METHOD = 'L'
          WHERE PICK_LABEL_NO = :WK_LABEL;
          DELETE FROM PICK_ITEM
          WHERE PICK_LABEL_NO = :WK_LABEL;
           /* send to remote the available qty of the prod */
           IF (WK_DO_UASL = 'T') THEN
           BEGIN
              EXECUTE PROCEDURE SEND_PICKABLE_STOCK (:WK_PROD,
                 'BDCS',
                 'XX',
                 'NOW');
           END
       END
       IF (WK_DOIT = 'PL') THEN
       BEGIN
          IF (WK_DO_UNPICK = 'T') THEN
          BEGIN
             UPDATE PICK_ITEM 
             SET DEVICE_ID = 'XC'
             WHERE PICK_LABEL_NO = :WK_LABEL;
             UPDATE PICK_ITEM_DETAIL
             SET DEVICE_ID = 'XC'
             WHERE PICK_LABEL_NO = :WK_LABEL
             AND DEVICE_ID <> 'XX' 
             AND DEVICE_ID = UPPER(DEVICE_ID);

             EXECUTE PROCEDURE ADD_TRAN(
                'XC',
                '',
                '',
                'PKCN',
                'C',
                'NOW',
                '',
                0,
                'F',
                '',
                'MASTER',
                0,
                :WK_LABEL,
                'SSSSSSSSS',
                'BDCS',
                'XC');
          END
       END
    END
END ^

ALTER PROCEDURE CANCEL_SALE_ORDER (PICK_ORDER VARCHAR(15) CHARACTER SET NONE,
REASON VARCHAR(255) CHARACTER SET NONE)
AS 
DECLARE VARIABLE sSSN VARCHAR(20);
DECLARE VARIABLE WK_LABEL VARCHAR(7);
DECLARE VARIABLE WK_STATUS CHAR(2);
DECLARE VARIABLE WK_DOIT CHAR(2);
DECLARE VARIABLE WK_SSN VARCHAR(20);
DECLARE VARIABLE WK_PROD VARCHAR(30);
DECLARE VARIABLE WK_PICK_ORDER VARCHAR(15);
DECLARE VARIABLE WK_PICK_ORDER_LINE_NO CHAR(4);
DECLARE VARIABLE WK_CONTACT_NAME VARCHAR(50);
DECLARE VARIABLE WK_WARRANTY_TERM VARCHAR(50);
DECLARE VARIABLE WK_PICK_LABEL_DATE TIMESTAMP;
DECLARE VARIABLE WK_SPECIAL_INSTRUCTIONS1 VARCHAR(8196);
DECLARE VARIABLE WK_SPECIAL_INSTRUCTIONS2 VARCHAR(255);
DECLARE VARIABLE WK_SHIP_VIA VARCHAR(10);
DECLARE VARIABLE WK_PICK_ORDER_QTY INTEGER;
DECLARE VARIABLE WK_PICK_ALLOCATED_QTY INTEGER;
DECLARE VARIABLE WK_PICKED_QTY INTEGER;
DECLARE VARIABLE WK_PICK_LINE_DUE_DATE TIMESTAMP;
DECLARE VARIABLE WK_PICK_STARTED TIMESTAMP;
DECLARE VARIABLE WK_DESPATCH_TS TIMESTAMP;
DECLARE VARIABLE WK_DESPATCH_LOCATION VARCHAR(10);
DECLARE VARIABLE WK_CREATE_DATE TIMESTAMP;
DECLARE VARIABLE WK_USER_ID VARCHAR(10);
DECLARE VARIABLE WK_DEVICE_ID CHAR(2);
DECLARE VARIABLE WK_CHECKIN_START TIMESTAMP;
DECLARE VARIABLE WK_CHECKIN_FINISH TIMESTAMP;
DECLARE VARIABLE WK_CHECKIN_USER_ID VARCHAR(10);
DECLARE VARIABLE WK_PARTIAL_PICK_ALLOWED CHAR(1);
DECLARE VARIABLE WK_DESPATCH_PALLET_NO VARCHAR(7);
DECLARE VARIABLE WK_WH_ID CHAR(2);
DECLARE VARIABLE WK_PICK_LOCATION VARCHAR(10);
DECLARE VARIABLE WK_SALE_PRICE NUMERIC(9,3);
DECLARE VARIABLE WK_DISCOUNT DOUBLE PRECISION;
DECLARE VARIABLE WK_SSN_CONFIRM  CHAR(1);
DECLARE VARIABLE WK_DO_UNPICK  CHAR(1);
DECLARE VARIABLE WK_DO_UASL  CHAR(1);
DECLARE VARIABLE WK_DO_UCIS CHAR(1);
DECLARE VARIABLE WK_DO_CANCEL_FILE CHAR(1);
DECLARE VARIABLE WK_GM_MESSAGE VARCHAR(10);
DECLARE VARIABLE WK_T4_DELIM CHAR(1);
DECLARE VARIABLE WK_T4_TRAN_DATA VARCHAR(1024);
DECLARE VARIABLE WK_T4_SOURCE VARCHAR(512);
DECLARE VARIABLE WK_NEW_RECORD INTEGER;
DECLARE VARIABLE WK_CN_PRIORITY SMALLINT;

BEGIN
    /* Update Pick Order status */
    WK_CN_PRIORITY = 0;
    SELECT SEND_UASL_V4, 
           ALLOW_UNPICK_IN_PICK_CANCEL,
           SEND_UCIS_V4,
           DEFAULT_PICK_PRIORITY,
           SEND_SO_CANCEL
    FROM CONTROL 
    INTO :WK_DO_UASL,
         :WK_DO_UNPICK,
         :WK_DO_UCIS,
         :WK_CN_PRIORITY,
         :WK_DO_CANCEL_FILE;
    UPDATE PICK_ORDER
    SET PICK_STATUS = 'CN',
        ORDER_CANCELLED = 'NOW'
    WHERE PICK_ORDER = :PICK_ORDER;
    IF (WK_DO_CANCEL_FILE = 'T') THEN
    BEGIN
       EXECUTE PROCEDURE EXPORT_CANCEL_ORDER (:PICK_ORDER);
    END
        
    /* update control set allow_unpick_in_pick_cancel = 'F'; */
    /* Update Pick Item Status */
    FOR SELECT PICK_LABEL_NO, 
        PICK_LINE_STATUS, 
        SSN_ID, 
        PROD_ID,
        PICK_ORDER ,
        PICK_ORDER_LINE_NO ,
        CONTACT_NAME ,
        WARRANTY_TERM ,
        PICK_LABEL_DATE ,
        SPECIAL_INSTRUCTIONS1 ,
        SPECIAL_INSTRUCTIONS2 ,
        SHIP_VIA ,
        PICK_ORDER_QTY ,
        PICK_ALLOCATED_QTY ,
        PICKED_QTY ,
        PICK_LINE_DUE_DATE ,
        PICK_STARTED ,
        DESPATCH_TS ,
        DESPATCH_LOCATION ,
        CREATE_DATE ,
        USER_ID ,
        DEVICE_ID ,
        CHECKIN_START ,
        CHECKIN_FINISH ,
        CHECKIN_USER_ID ,
        PARTIAL_PICK_ALLOWED ,
        DESPATCH_PALLET_NO ,
        WH_ID ,
        PICK_LOCATION ,
        SALE_PRICE ,
        DISCOUNT ,
        SSN_CONFIRM 
       FROM PICK_ITEM 
       WHERE PICK_ORDER = :PICK_ORDER
       INTO :WK_LABEL, 
       :WK_STATUS, 
       :WK_SSN, 
       :WK_PROD,
       :WK_PICK_ORDER ,
       :WK_PICK_ORDER_LINE_NO ,
       :WK_CONTACT_NAME ,
       :WK_WARRANTY_TERM ,
       :WK_PICK_LABEL_DATE ,
       :WK_SPECIAL_INSTRUCTIONS1 ,
       :WK_SPECIAL_INSTRUCTIONS2 ,
       :WK_SHIP_VIA ,
       :WK_PICK_ORDER_QTY ,
       :WK_PICK_ALLOCATED_QTY ,
       :WK_PICKED_QTY ,
       :WK_PICK_LINE_DUE_DATE ,
       :WK_PICK_STARTED ,
       :WK_DESPATCH_TS ,
       :WK_DESPATCH_LOCATION ,
       :WK_CREATE_DATE ,
       :WK_USER_ID ,
       :WK_DEVICE_ID ,
       :WK_CHECKIN_START ,
       :WK_CHECKIN_FINISH ,
       :WK_CHECKIN_USER_ID ,
       :WK_PARTIAL_PICK_ALLOWED ,
       :WK_DESPATCH_PALLET_NO ,
       :WK_WH_ID ,
       :WK_PICK_LOCATION ,
       :WK_SALE_PRICE ,
       :WK_DISCOUNT ,
       :WK_SSN_CONFIRM 
    DO
    BEGIN
       WK_DOIT = 'N';
       /* UPDATE PICK_ITEM SET REASON = :REASON
       WHERE PICK_LABEL_NO = :WK_LABEL; */
       INSERT INTO PICK_ITEM_CANCEL(
        PICK_LABEL_NO ,
        PICK_ORDER ,
        PICK_ORDER_LINE_NO ,
        CONTACT_NAME ,
        PROD_ID ,
        SSN_ID ,
        WARRANTY_TERM ,
        PICK_LABEL_DATE ,
        SPECIAL_INSTRUCTIONS1 ,
        SPECIAL_INSTRUCTIONS2 ,
        SHIP_VIA ,
        PICK_ORDER_QTY ,
        PICK_ALLOCATED_QTY ,
        PICKED_QTY ,
        PICK_LINE_DUE_DATE ,
        PICK_STARTED ,
        DESPATCH_TS ,
        DESPATCH_LOCATION ,
        CREATE_DATE ,
        USER_ID ,
        DEVICE_ID ,
        CHECKIN_START ,
        CHECKIN_FINISH ,
        CHECKIN_USER_ID ,
        PICK_LINE_STATUS ,
        PARTIAL_PICK_ALLOWED ,
        DESPATCH_PALLET_NO ,
        WH_ID ,
        PICK_LOCATION ,
        REASON ,
        SALE_PRICE ,
        DISCOUNT ,
        SSN_CONFIRM,
        CANCEL_METHOD )
   VALUES (
        :WK_LABEL ,
        :WK_PICK_ORDER ,
        :WK_PICK_ORDER_LINE_NO ,
        :WK_CONTACT_NAME ,
        :WK_PROD ,
        :WK_SSN ,
        :WK_WARRANTY_TERM ,
        :WK_PICK_LABEL_DATE ,
        :WK_SPECIAL_INSTRUCTIONS1 ,
        :WK_SPECIAL_INSTRUCTIONS2 ,
        :WK_SHIP_VIA ,
        :WK_PICK_ORDER_QTY ,
        :WK_PICK_ALLOCATED_QTY ,
        :WK_PICKED_QTY ,
        :WK_PICK_LINE_DUE_DATE ,
        :WK_PICK_STARTED ,
        :WK_DESPATCH_TS ,
        :WK_DESPATCH_LOCATION ,
        :WK_CREATE_DATE ,
        :WK_USER_ID ,
        :WK_DEVICE_ID ,
        :WK_CHECKIN_START ,
        :WK_CHECKIN_FINISH ,
        :WK_CHECKIN_USER_ID ,
        :WK_STATUS ,
        :WK_PARTIAL_PICK_ALLOWED ,
        :WK_DESPATCH_PALLET_NO ,
        :WK_WH_ID ,
        :WK_PICK_LOCATION ,
        :REASON ,
        :WK_SALE_PRICE ,
        :WK_DISCOUNT ,
        :WK_SSN_CONFIRM,
        'O' );

       IF (WK_STATUS IS NULL) THEN
       BEGIN
          WK_DOIT = 'UC';
       END
       IF (WK_STATUS = 'UC') THEN
       BEGIN
          WK_DOIT = 'UC';
       END
       IF (WK_STATUS = 'CF') THEN
       BEGIN
          WK_DOIT = 'CF';
       END
       IF (WK_STATUS = 'OP') THEN
       BEGIN
          WK_DOIT = 'CF';
       END
       IF (WK_STATUS = 'UP') THEN
       BEGIN
          WK_DOIT = 'CF';
       END
       IF (WK_STATUS = 'HD') THEN
       BEGIN
          WK_DOIT = 'UC';
       END
       IF (WK_STATUS = 'AL') THEN
       BEGIN
          WK_DOIT = 'PL';
       END
       IF (WK_STATUS = 'PG') THEN
       BEGIN
          WK_DOIT = 'PL';
       END
       IF (WK_STATUS = 'PL') THEN
       BEGIN
          WK_DOIT = 'PL';
       END
       IF (WK_STATUS = 'DS') THEN
       BEGIN
          WK_DOIT = 'DS';
       END
       IF (WK_DOIT = 'UC') THEN
       BEGIN
          /* Unconfirmed line so can just cancel the line - no change to issn */
          UPDATE  PICK_ITEM SET CANCEL_METHOD = 'O'
          WHERE PICK_LABEL_NO = :WK_LABEL;
          DELETE FROM PICK_ITEM
          WHERE PICK_LABEL_NO = :WK_LABEL;
           /* send to remote the available qty of the prod */
           IF (WK_DO_UASL = 'T') THEN
           BEGIN
              EXECUTE PROCEDURE SEND_PICKABLE_STOCK (:WK_PROD,
                 'BDCS',
                 'XX',
                 'NOW');
           END
       END
       IF (WK_DOIT = 'CF') THEN
       BEGIN
          /* Confirmed line so cancel the line and change status of issn*/
          IF (WK_SSN IS NOT NULL) THEN
          BEGIN
             UPDATE ISSN SET ISSN_STATUS = 'PA', PICK_ORDER = NULL
             WHERE ORIGINAL_SSN = :WK_SSN
               AND PICK_ORDER = :WK_LABEL;
          END
          UPDATE  PICK_ITEM SET CANCEL_METHOD = 'O'
          WHERE PICK_LABEL_NO = :WK_LABEL;
          DELETE FROM PICK_ITEM
          WHERE PICK_LABEL_NO = :WK_LABEL;
           /* send to remote the available qty of the prod */
           IF (WK_DO_UASL = 'T') THEN
           BEGIN
              EXECUTE PROCEDURE SEND_PICKABLE_STOCK (:WK_PROD,
                 'BDCS',
                 'XX',
                 'NOW');
           END
       END
       IF (WK_DOIT = 'PL') THEN
       BEGIN
          IF (WK_DO_UNPICK = 'T') THEN
          BEGIN
             UPDATE PICK_ITEM 
             SET DEVICE_ID = 'XC'
             WHERE PICK_LABEL_NO = :WK_LABEL;
             UPDATE PICK_ITEM_DETAIL
             SET DEVICE_ID = 'XC'
             WHERE PICK_LABEL_NO = :WK_LABEL
             AND DEVICE_ID <> 'XX' 
             AND DEVICE_ID = UPPER(DEVICE_ID);

             EXECUTE PROCEDURE ADD_TRAN(
                'XC',
                '',
                '',
                'PKCN',
                'C',
                'NOW',
                '',
                0,
                'F',
                '',
                'MASTER',
                0,
                :WK_LABEL,
                'SSSSSSSSS',
                'BDCS',
                'XC');
          END
       END
    END
    IF (WK_DO_UCIS = 'T') THEN
    BEGIN
       /* now send of trans to update remote status */
       WK_GM_MESSAGE = '';
       SELECT MESSAGE_ID 
       FROM GET_NEXT_MESSAGE 
       INTO :WK_GM_MESSAGE;
       WK_T4_DELIM = '|';
       WK_T4_SOURCE = 'SSSSSS' ;
       BEGIN
          WK_T4_TRAN_DATA = 'BDCS' || WK_T4_DELIM ;
          WK_T4_TRAN_DATA = WK_T4_TRAN_DATA || 'XX' || WK_T4_DELIM ;
          WK_T4_TRAN_DATA = WK_T4_TRAN_DATA || WK_GM_MESSAGE || WK_T4_DELIM ;
          WK_T4_TRAN_DATA = WK_T4_TRAN_DATA || '<ContactInstanceID>' || PICK_ORDER || WK_T4_DELIM ;
          WK_T4_TRAN_DATA = WK_T4_TRAN_DATA || '<ContactInstanceStatusCode>CN' || WK_T4_DELIM ;
          WK_T4_TRAN_DATA = WK_T4_TRAN_DATA || '<UpdateDateTime>' || MER_YEAR('NOW') || '-' || LPAD(MER_MONTH('NOW'),'0',2) || '-' || LPAD(MER_DAY('NOW'),'0',2) || 'T' || LPAD(MER_HOUR('NOW'),'0',2) || ':' || LPAD(MER_MINUTE('NOW'),'0',2) || ':' || LPAD(SEC('NOW'),'0',2) || WK_T4_DELIM ;
          SELECT REC_ID FROM ADD_TRAN_V4 ( 'V4', 'UCIS','S',
             'NOW',
             :WK_T4_DELIM,
             'BDCS',
             'XX',
             :WK_GM_MESSAGE,
             :WK_T4_TRAN_DATA,
             'F','','MASTER',0,
             :WK_T4_SOURCE)
          INTO :WK_NEW_RECORD;
       END
       EXECUTE PROCEDURE ADD_MESSAGE_V4 ( 
          :WK_GM_MESSAGE,
         'V4', 'UCIS','S',
          'NOW',
          'BDCS',
          'XX',
          :WK_CN_PRIORITY,
          'WS','',NULL);
    END 
END ^

ALTER PROCEDURE CHECK_EMPLOYEE_ID (EMPLOYEE_ID VARCHAR(10) CHARACTER SET NONE)
RETURNS (VALID_ID CHAR(1) CHARACTER SET NONE)
AS 
      

DECLARE VARIABLE iCount INTEGER;

BEGIN
    iCount = 0;
    VALID_ID = 'F';    
    
    /* Check Employee ID */
    SELECT COUNT(*)
    FROM EMPLOYEE
    WHERE EMPLOYEE_ID = :EMPLOYEE_ID   
    INTO :iCount;
    
    IF (:iCount > 0) THEN
    BEGIN
       VALID_ID = 'T';
       EXIT;
    END         
   
END ^

ALTER PROCEDURE CHECK_SALE_ORDER_LINES (PICK_ORDER VARCHAR(10) CHARACTER SET NONE)
RETURNS (VALID_SO CHAR(1) CHARACTER SET NONE,
INVALID_SSN VARCHAR(255) CHARACTER SET NONE)
AS 
 
      


DECLARE VARIABLE sSSN VARCHAR(20);
DECLARE VARIABLE sStatusSSN CHAR(2);
DECLARE VARIABLE ERRCOUNT INTEGER;

BEGIN
   VALID_SO = 'T';
   INVALID_SSN = '';
   ERRCOUNT = 0;
      FOR 
         SELECT SSN_ID 
         FROM PICK_ITEM
         WHERE PICK_ORDER = :PICK_ORDER               
         INTO :sSSN
      DO
      BEGIN                     
         IF (LEN(:sSSN) <> 0) THEN
         BEGIN
           SELECT STATUS_SSN
           FROM SSN         
           WHERE SSN_ID = :sSSN         
           INTO :sStatusSSN;
         
           IF (:sStatusSSN <> 'PA' AND :sStatusSSN <> 'ST' AND :sStatusSSN <> 'TS') THEN
           BEGIN      
             VALID_SO = 'F';
             IF (ERRCOUNT <= 7) THEN 
             BEGIN /* limit error to 7 SSNs because we get an overflow */
               INVALID_SSN = :INVALID_SSN || ALLTRIM(:sSSN) || ', ';
               ERRCOUNT = ERRCOUNT + 1;
             END
           END
         END
      END  
      
      IF (LEN(INVALID_SSN) <> 0) THEN
      BEGIN
         INVALID_SSN = SUBSTR(INVALID_SSN, 1, LEN(INVALID_SSN)-2);
      END   
   
END ^

ALTER PROCEDURE CHECK_SSN (SSN_ID VARCHAR(20) CHARACTER SET NONE)
RETURNS (VALID_ITEM CHAR(1) CHARACTER SET NONE,
LOAN_STATUS VARCHAR(1) CHARACTER SET NONE,
LOAN_PERIOD_NO INTEGER,
LOAN_PERIOD VARCHAR(1) CHARACTER SET NONE,
LOAN_SAFETY_CHECK VARCHAR(1) CHARACTER SET NONE,
LOAN_LAST_SAFETY_CHECK_DATE TIMESTAMP,
LOAN_SAFETY_PERIOD_NO INTEGER,
LOAN_SAFETY_PERIOD VARCHAR(1) CHARACTER SET NONE,
LOAN_CALIBRATE_CHECK VARCHAR(1) CHARACTER SET NONE,
LOAN_LAST_CALIBRATE_CHECK_DATE TIMESTAMP,
LOAN_CALIBRATE_PERIOD_NO INTEGER,
LOAN_CALIBRATE_PERIOD VARCHAR(1) CHARACTER SET NONE)
AS 
   
   DECLARE VARIABLE BARCODE VARCHAR(20);    
BEGIN     
    VALID_ITEM = 'F';
    BARCODE = '';

    SELECT SSN_ID, LOAN_STATUS, 
      LOAN_PERIOD_NO, LOAN_PERIOD,
      LOAN_SAFETY_CHECK, LOAN_LAST_SAFETY_CHECK_DATE, 
      LOAN_SAFETY_PERIOD_NO, LOAN_SAFETY_PERIOD,
      LOAN_CALIBRATE_CHECK, LOAN_LAST_CALIBRATE_CHECK_DATE,
      LOAN_CALIBRATE_PERIOD_NO, LOAN_CALIBRATE_PERIOD   
    FROM SSN   
    WHERE SSN_ID = :SSN_ID    
    INTO :BARCODE, :LOAN_STATUS,
      :LOAN_PERIOD_NO, :LOAN_PERIOD,
      :LOAN_SAFETY_CHECK, :LOAN_LAST_SAFETY_CHECK_DATE, 
      :LOAN_SAFETY_PERIOD_NO, :LOAN_SAFETY_PERIOD,
      :LOAN_CALIBRATE_CHECK, :LOAN_LAST_CALIBRATE_CHECK_DATE,
      :LOAN_CALIBRATE_PERIOD_NO, :LOAN_CALIBRATE_PERIOD ;

    IF (BARCODE <> '') THEN
    BEGIN
       VALID_ITEM = 'T';
    END   
END ^

ALTER PROCEDURE CHECK_SSN_SALE_LINES (PICK_ORDER VARCHAR(10) CHARACTER SET NONE,
SSN_ID VARCHAR(20) CHARACTER SET NONE)
RETURNS (VALID_SSN CHAR(1) CHARACTER SET NONE)
AS 
     

DECLARE VARIABLE iCount INTEGER;

BEGIN
    iCount = 0;
    VALID_SSN = 'T';    
    
    /* Check SSN in Sale Order Lines */
    SELECT COUNT(*)
    FROM PICK_ITEM
    WHERE PICK_ORDER = :PICK_ORDER               
    AND SSN_ID = :SSN_ID
    INTO :iCount;
    
    IF (:iCount > 0) THEN
    BEGIN
       VALID_SSN = 'F';
       EXIT;
    END         
   
END ^

ALTER PROCEDURE CHECK_STATUS_SSN_SALE_LINES (SSN_ID VARCHAR(20) CHARACTER SET NONE)
RETURNS (VALID_SSN CHAR(1) CHARACTER SET NONE)
AS 
      
DECLARE VARIABLE iCount INTEGER;
BEGIN
    iCount = 0;
    VALID_SSN = 'F';    
    
    /* Check Status SSN in SSN */     
    SELECT COUNT(*)
    FROM SSN
    WHERE SSN_ID = :SSN_ID
    AND (STATUS_SSN = 'PA' OR STATUS_SSN = 'ST' 
         OR STATUS_SSN = 'TS')
    INTO :iCount;
    
    IF (:iCount > 0) THEN
    BEGIN
       VALID_SSN = 'T';
       EXIT;
    END         
   
END ^

ALTER PROCEDURE CHECK_TRANSACTION_ISIZ AS 

DECLARE VARIABLE WK_ORDER VARCHAR(10);
DECLARE VARIABLE WK_LABEL VARCHAR(10);
DECLARE VARIABLE WK_COUNT INTEGER;
DECLARE VARIABLE WK_RES INTEGER;
BEGIN
   FOR SELECT 
   PICK_LABEL_NO, PICK_ORDER 
   FROM PICK_ITEM
   INTO :WK_LABEL, :WK_ORDER
   DO
   BEGIN
     WK_COUNT = 0;
     FOR SELECT 1 
     FROM PICK_ITEM_DETAIL
     WHERE PICK_ITEM_DETAIL.PICK_LABEL_NO = :WK_LABEL
     INTO :WK_COUNT
     DO
     BEGIN
           WK_COUNT = 2;
     END
     IF (WK_COUNT = 0) THEN
     BEGIN
            WK_RES = FILE_WRITELN('LABEL.TXT',WK_LABEL); 
            WK_RES = FILE_WRITELN('LABEL.TXT',CHR(10)); 
            WK_RES = FILE_WRITELN('ORDER.TXT',WK_ORDER); 
            WK_RES = FILE_WRITELN('ORDER.TXT',CHR(10)); 
     END
   END
END ^

ALTER PROCEDURE CHECK_TYPE_HEADER (TYPE_CODE VARCHAR(40) CHARACTER SET NONE)
RETURNS (VALID_TYPE CHAR(1) CHARACTER SET NONE,
T_HEADER_CODE VARCHAR(40) CHARACTER SET NONE)
AS 
    

DECLARE VARIABLE REC_EXIST INTEGER; 
DECLARE VARIABLE sTypeCode VARCHAR(40);
DECLARE VARIABLE sTypeHeaderCode VARCHAR(40);


BEGIN
   VALID_TYPE = 'T';
      FOR 
         SELECT TYPE_CODE, TYPE_HEADER_CODE 
         FROM TYPE_HEADER
         WHERE TYPE_CODE = :TYPE_CODE       
         AND MANDATORY = 'T'
         INTO sTypeCode, :sTypeHeaderCode
      DO
      BEGIN   
         REC_EXIST = 0;
         
         SELECT COUNT(TYPE_LINE_CODE)
         FROM TYPE_LINE         
         WHERE TYPE_CODE = :sTypeCode
         AND TYPE_HEADER_CODE = :sTypeHeaderCode
         AND TYPE_LINE_CODE <> ''
         INTO :REC_EXIST;
         
         IF (REC_EXIST = 0) THEN
         BEGIN      
           VALID_TYPE = 'F';
           T_HEADER_CODE = :sTypeHeaderCode;
    EXIT;                       
         END
      END                              
   
END ^

ALTER PROCEDURE COPY_QUESTIONS (WK_FROM_TYPE VARCHAR(40) CHARACTER SET NONE,
WK_TO_TYPE VARCHAR(40) CHARACTER SET NONE)
AS 
 
                                                       
  DECLARE VARIABLE WK_QUESTION VARCHAR(70);
  DECLARE VARIABLE WK_SEQUENCE INTEGER;
  DECLARE VARIABLE WK_QUESTION_ID INTEGER;
  DECLARE VARIABLE WK_NEW_QUESTION_ID INTEGER;
  DECLARE VARIABLE WK_INSPECT_CATEGORY VARCHAR(1);
     
  DECLARE VARIABLE WK_VALID_RESPONSE VARCHAR(50);
  DECLARE VARIABLE WK_BRANCH_TO INTEGER;
  DECLARE VARIABLE WK_NEW_BRANCH_TO INTEGER;
  DECLARE VARIABLE WK_REQUIRE_ENTRY CHAR(1);
  DECLARE VARIABLE WK_FIELD_TYPE INTEGER;
  DECLARE VARIABLE WK_HIGH_DATE_LIM TIMESTAMP;
  DECLARE VARIABLE WK_HIGH_NUM_LIM FLOAT;
  DECLARE VARIABLE WK_LOW_DATE_LIM TIMESTAMP;
  DECLARE VARIABLE WK_LOW_NUM_LIM FLOAT;
  DECLARE VARIABLE WK_MANDATORY_INPUT CHAR(1);
  DECLARE VARIABLE WK_RUN_PROCEDURE VARCHAR(30);
  DECLARE VARIABLE WK_UPDATE_FIELD VARCHAR(30);
  DECLARE VARIABLE WK_VALID_SELECTION BLOB;
  DECLARE VARIABLE WK_VR_INSPECT_CATEGORY VARCHAR(1);
  DECLARE VARIABLE WK_INSPECT_DESCRIPTION VARCHAR(25);
  DECLARE VARIABLE WK_INSPECT_PASS_CRITERIA VARCHAR(6);
  DECLARE VARIABLE WK_RESPONSE_ID INTEGER;

BEGIN
 UPDATE TEST_QUESTIONS SET ORIGINAL_QUESTION_ID = NULL
  WHERE SSN_TYPE = :WK_TO_TYPE;
 FOR SELECT 
         SEQUENCE ,
         QUESTION_ID ,
         QUESTION ,
         INSPECT_CATEGORY 
  FROM TEST_QUESTIONS WHERE SSN_TYPE = :WK_FROM_TYPE
                INTO :WK_SEQUENCE,
   :WK_QUESTION_ID,
   :WK_QUESTION,
   :WK_INSPECT_CATEGORY
 DO
 BEGIN
  WK_NEW_QUESTION_ID = GEN_ID(TEST_QUESTIONS_RECORD_ID_GEN, 1);
  INSERT INTO TEST_QUESTIONS (
         SEQUENCE ,
         ORIGINAL_QUESTION_ID ,
         QUESTION ,
         INSPECT_CATEGORY, 
  SSN_TYPE,
  QUESTION_ID)
  VALUES (
         :WK_SEQUENCE ,
         :WK_QUESTION_ID ,
         :WK_QUESTION ,
         :WK_INSPECT_CATEGORY, 
  :WK_TO_TYPE,
  :WK_NEW_QUESTION_ID);

  FOR SELECT 
          VALID_RESPONSE ,
          BRANCH_TO ,
          REQUIRE_ENTRY ,
          FIELD_TYPE ,
          HIGH_DATE_LIM ,
          HIGH_NUM_LIM ,
          LOW_DATE_LIM ,
          LOW_NUM_LIM ,
          MANDATORY_INPUT ,
          RUN_PROCEDURE ,
          UPDATE_FIELD ,
          VALID_SELECTION ,
          INSPECT_CATEGORY ,
          INSPECT_DESCRIPTION ,
          INSPECT_PASS_CRITERIA 
   FROM VALID_RESPONSES WHERE QUESTION_ID = :WK_QUESTION_ID
                 INTO 
          :WK_VALID_RESPONSE ,
          :WK_BRANCH_TO ,
          :WK_REQUIRE_ENTRY ,
          :WK_FIELD_TYPE ,
          :WK_HIGH_DATE_LIM , 
   :WK_HIGH_NUM_LIM , 
   :WK_LOW_DATE_LIM , 
   :WK_LOW_NUM_LIM , 
   :WK_MANDATORY_INPUT , 
   :WK_RUN_PROCEDURE ,
          :WK_UPDATE_FIELD ,
          :WK_VALID_SELECTION ,
          :WK_VR_INSPECT_CATEGORY ,
          :WK_INSPECT_DESCRIPTION ,
          :WK_INSPECT_PASS_CRITERIA 
  DO
  BEGIN
   /* calc question id for branch_to */
   WK_NEW_BRANCH_TO = 0 - WK_BRANCH_TO;
   SELECT QUESTION_ID
    FROM TEST_QUESTIONS
    WHERE ORIGINAL_QUESTION_ID = :WK_QUESTION_ID AND 
     SSN_TYPE= :WK_TO_TYPE
    INTO :WK_NEW_BRANCH_TO;
   INSERT INTO VALID_RESPONSES (
   QUESTION_ID,
          VALID_RESPONSE ,
          BRANCH_TO ,
          REQUIRE_ENTRY ,
          FIELD_TYPE ,
          HIGH_DATE_LIM ,
          HIGH_NUM_LIM ,
          LOW_DATE_LIM ,
          LOW_NUM_LIM ,
          MANDATORY_INPUT ,
          RUN_PROCEDURE ,
          UPDATE_FIELD ,
          VALID_SELECTION ,
          INSPECT_CATEGORY ,
          INSPECT_DESCRIPTION ,
          INSPECT_PASS_CRITERIA )
   VALUES (
   :WK_NEW_QUESTION_ID,
          :WK_VALID_RESPONSE ,
          :WK_NEW_BRANCH_TO ,
          :WK_REQUIRE_ENTRY ,
          :WK_FIELD_TYPE ,
          :WK_HIGH_DATE_LIM ,
          :WK_HIGH_NUM_LIM ,
          :WK_LOW_DATE_LIM ,
          :WK_LOW_NUM_LIM ,
          :WK_MANDATORY_INPUT ,
          :WK_RUN_PROCEDURE ,
          :WK_UPDATE_FIELD ,
          :WK_VALID_SELECTION ,
          :WK_VR_INSPECT_CATEGORY ,
          :WK_INSPECT_DESCRIPTION ,
          :WK_INSPECT_PASS_CRITERIA );
 
  END
 END
 /* now must go though valid responses for new type
    where  branch to is negative
 */

 FOR SELECT 
         TQ.QUESTION_ID ,
         VR.RESPONSE_ID ,
         VR.VALID_RESPONSE ,
         VR.BRANCH_TO ,
         VR.REQUIRE_ENTRY ,
         VR.FIELD_TYPE ,
         VR.HIGH_DATE_LIM ,
         VR.HIGH_NUM_LIM ,
         VR.LOW_DATE_LIM ,
         VR.LOW_NUM_LIM ,
         VR.MANDATORY_INPUT ,
         VR.RUN_PROCEDURE ,
         VR.UPDATE_FIELD ,
         VR.VALID_SELECTION ,
         VR.INSPECT_CATEGORY ,
         VR.INSPECT_DESCRIPTION ,
         VR.INSPECT_PASS_CRITERIA 
  FROM TEST_QUESTIONS TQ JOIN VALID_RESPONSES VR 
  ON TQ.QUESTION_ID = VR.QUESTION_ID
  WHERE TQ.SSN_TYPE = :WK_TO_TYPE AND
        VR.BRANCH_TO < 0
                 INTO 
          :WK_QUESTION_ID ,
          :WK_RESPONSE_ID,
          :WK_VALID_RESPONSE ,
          :WK_BRANCH_TO ,
          :WK_REQUIRE_ENTRY ,
          :WK_FIELD_TYPE ,
          :WK_HIGH_DATE_LIM , 
   :WK_HIGH_NUM_LIM , 
   :WK_LOW_DATE_LIM , 
   :WK_LOW_NUM_LIM , 
   :WK_MANDATORY_INPUT , 
   :WK_RUN_PROCEDURE ,
          :WK_UPDATE_FIELD ,
          :WK_VALID_SELECTION ,
          :WK_VR_INSPECT_CATEGORY ,
          :WK_INSPECT_DESCRIPTION ,
          :WK_INSPECT_PASS_CRITERIA 
 DO
 BEGIN
  /* must calc to branch to to use */
  WK_NEW_BRANCH_TO = WK_BRANCH_TO;
  SELECT QUESTION_ID
   FROM TEST_QUESTIONS
   WHERE ORIGINAL_QUESTION_ID = :WK_QUESTION_ID AND 
    SSN_TYPE= :WK_TO_TYPE
   INTO :WK_NEW_BRANCH_TO;
  UPDATE VALID_RESPONSES 
   SET BRANCH_TO = :WK_NEW_BRANCH_TO
          WHERE RESPONSE_ID = :WK_RESPONSE_ID;
 END
      
END ^

ALTER PROCEDURE CREATE_ISSN_FROM_SSN AS 
 
 
                                                       
  DECLARE VARIABLE WK_STATUS VARCHAR(2);
  DECLARE VARIABLE WK_WH_ID VARCHAR(2);
  DECLARE VARIABLE WK_LOCN_ID VARCHAR(10);
  DECLARE VARIABLE WK_PROD VARCHAR(30);
  DECLARE VARIABLE WK_SSN VARCHAR(20);
  DECLARE VARIABLE WK_SSN_QTY INTEGER;
  DECLARE VARIABLE WK_FOUND   INTEGER;
  DECLARE VARIABLE WK_COMPANY VARCHAR(20);
     
BEGIN
   /* Update ISSN table */   
         
   FOR SELECT 
       SSN_ID, WH_ID, LOCN_ID, PROD_ID, STATUS_SSN, CURRENT_QTY, COMPANY_ID
       FROM SSN 
       INTO :WK_SSN, :WK_WH_ID, :WK_LOCN_ID, :WK_PROD, :WK_STATUS, :WK_SSN_QTY, :WK_COMPANY
   DO
   BEGIN
       WK_FOUND = 0;
       SELECT COUNT(*) FROM ISSN WHERE SSN_ID = :WK_SSN INTO :WK_FOUND;
       IF (WK_FOUND = 0) THEN
       BEGIN
           INSERT INTO ISSN 
               (SSN_ID, ORIGINAL_SSN, WH_ID, LOCN_ID, PROD_ID, ISSN_STATUS,CURRENT_QTY, COMPANY_ID)
               VALUES (:WK_SSN, :WK_SSN, :WK_WH_ID, :WK_LOCN_ID, :WK_PROD, :WK_STATUS, :WK_SSN_QTY, :WK_COMPANY );
       END
   END
END ^

ALTER PROCEDURE CREATE_PICK_DETAIL_FROM_ISSN AS 

                                                       
  DECLARE VARIABLE WK_SSN VARCHAR(20);
  DECLARE VARIABLE WK_SSN_QTY INTEGER;
  DECLARE VARIABLE WK_FOUND INTEGER;
  DECLARE VARIABLE WK_PID_FOUND INTEGER;
  DECLARE VARIABLE WK_LABEL_NO VARCHAR(7);
  DECLARE VARIABLE WK_USER VARCHAR(10);
  DECLARE VARIABLE WK_LOCN_ID VARCHAR(10);
  DECLARE VARIABLE WK_DETAIL_ID INTEGER;
     
BEGIN
         
   FOR SELECT SSN_ID, CURRENT_QTY, USER_ID, LOCN_ID
       FROM ISSN
       WHERE ISSN_STATUS = 'DS'
       INTO :WK_SSN, :WK_SSN_QTY, :WK_USER, :WK_LOCN_ID
   DO
   BEGIN
     WK_FOUND = 0;
     FOR SELECT 1, PICK_LABEL_NO 
            FROM PICK_ITEM
      WHERE SSN_ID = :WK_SSN
      AND PICK_LINE_STATUS IN ('OP','CN','HD')
            INTO :WK_FOUND,
                 :WK_LABEL_NO
      DO
      BEGIN
      IF (WK_FOUND = 1) THEN
      BEGIN
         UPDATE PICK_ITEM 
   SET PICK_LINE_STATUS = 'DS',
   PICKED_QTY = :WK_SSN_QTY,
   DESPATCH_LOCATION = :WK_LOCN_ID 
      WHERE SSN_ID = :WK_SSN
      AND PICK_LABEL_NO = :WK_LABEL_NO;
         WK_PID_FOUND = 0;
         FOR SELECT 1, PICK_DETAIL_ID 
                FROM PICK_ITEM_DETAIL
                WHERE PICK_LABEL_NO = :WK_LABEL_NO
                AND SSN_ID = :WK_SSN
                INTO :WK_PID_FOUND, :WK_DETAIL_ID
         DO
         BEGIN
            UPDATE PICK_ITEM_DETAIL 
            SET  PICK_DETAIL_STATUS =
                 'DS',
                 QTY_PICKED =
                 :WK_SSN_QTY ,
                 DESPATCH_LOCATION =
                 :WK_LOCN_ID ,
                 USER_ID =
                 :WK_USER
            WHERE PICK_DETAIL_ID = :WK_DETAIL_ID;
         END
         IF (WK_PID_FOUND = 0) THEN
         BEGIN
            /* no detail record */
            INSERT INTO PICK_ITEM_DETAIL 
                (PICK_LABEL_NO, 
                 SSN_ID, 
                 PICK_DETAIL_STATUS, 
           DESPATCH_LOCATION,
                 QTY_PICKED,
                 USER_ID, 
                 CREATE_DATE)
            VALUES (:WK_LABEL_NO, 
                 :WK_SSN,
                 'DS',
                 :WK_LOCN_ID ,
                 :WK_SSN_QTY,
                 :WK_USER,
                 "NOW");
         END
         /*
         ELSE
         BEGIN
            UPDATE PICK_ITEM_DETAIL 
            SET  PICK_DETAIL_STATUS =
                 'DS',
                 QTY_PICKED =
                 :WK_SSN_QTY ,
                 DESPATCH_LOCATION =
                 :WK_LOCN_ID ,
                 USER_ID =
                 :WK_USER
            WHERE PICK_DETAIL_ID = :WK_DETAIL_ID;
         END
         */
         END
      END
   END
END ^

ALTER PROCEDURE CREATE_PROD_PROFILE AS 

DECLARE VARIABLE WK_PROD VARCHAR(30);
DECLARE VARIABLE WK_DESC VARCHAR(80);
DECLARE VARIABLE WK_FOUND INTEGER;
BEGIN
   FOR SELECT ISSN.PROD_ID, SSN.SSN_DESCRIPTION
       FROM ISSN
            JOIN SSN ON SSN.SSN_ID = ISSN.ORIGINAL_SSN
       WHERE NOT ISSN.PROD_ID IS NULL
       GROUP BY ISSN.PROD_ID, SSN.SSN_DESCRIPTION
       INTO :WK_PROD, :WK_DESC
   DO
   BEGIN
      WK_DESC = SUBSTR(WK_DESC,1,50);
      WK_FOUND = 0;
      SELECT 1 FROM PROD_PROFILE 
      WHERE PROD_ID = :WK_PROD
      INTO :WK_FOUND;
      IF (WK_FOUND IS NULL) THEN
      BEGIN
         WK_FOUND = 0;
      END
      IF (WK_FOUND = 0) THEN
      BEGIN
         INSERT INTO PROD_PROFILE( PROD_ID, SHORT_DESC)
            VALUES (:WK_PROD, :WK_DESC);
      END
      ELSE
      BEGIN
         UPDATE PROD_PROFILE
            SET SHORT_DESC = :WK_DESC 
            WHERE PROD_ID = :WK_PROD;
      END
   END
END ^

ALTER PROCEDURE DELETE_ISSN (SSN_ID VARCHAR(20) CHARACTER SET NONE)
AS 

BEGIN
   UPDATE ISSN SET WH_ID = 'XX',
          LOCN_ID = '00000000'
          WHERE ORIGINAL_SSN = :SSN_ID;
END ^

ALTER PROCEDURE DELETE_PROD_COND_STATUS (SSN_ID VARCHAR(20) CHARACTER SET NONE,
CODE VARCHAR(1) CHARACTER SET NONE,
ORIGINAL VARCHAR(1) CHARACTER SET NONE)
AS 
 


  DECLARE VARIABLE WK_GLOBAL VARCHAR(30);
  DECLARE VARIABLE WK_FAIL_CNT INTEGER;

BEGIN
  DELETE FROM PRODUCT_COND_STATUS
  WHERE SSN_ID = :SSN_ID
  AND   CODE = :CODE
  AND   ORIGINAL_TEST = :ORIGINAL;

  IF (:ORIGINAL = 'S') THEN
  BEGIN
     IF (:CODE = 'A') THEN
     BEGIN
        WK_FAIL_CNT = 0;
        SELECT COUNT(*) FROM PRODUCT_COND_STATUS
        WHERE SSN_ID = :SSN_ID
        AND   CODE = :CODE
        AND   ORIGINAL_TEST = 'S'
        INTO :WK_FAIL_CNT;
        IF (WK_FAIL_CNT = 0) THEN
        BEGIN
           EXECUTE PROCEDURE GET_GLOBAL_CONDITION 1, 'P' RETURNING_VALUES :WK_GLOBAL;
           UPDATE SSN
           SET OTHER1 = :WK_GLOBAL
           WHERE SSN_ID = :SSN_ID;
        END
        ELSE
        BEGIN
           EXECUTE PROCEDURE GET_GLOBAL_CONDITION 1, 'F' RETURNING_VALUES :WK_GLOBAL;
           UPDATE SSN
           SET OTHER1 = :WK_GLOBAL
           WHERE SSN_ID = :SSN_ID;
        END
     END
     ELSE IF (:CODE = 'B') THEN
     BEGIN
        WK_FAIL_CNT = 0;
        SELECT COUNT(*) FROM PRODUCT_COND_STATUS
        WHERE SSN_ID = :SSN_ID
        AND   CODE = :CODE
        AND   ORIGINAL_TEST = 'S'
        INTO :WK_FAIL_CNT;
        IF (WK_FAIL_CNT = 0) THEN
        BEGIN
           EXECUTE PROCEDURE GET_GLOBAL_CONDITION 2, 'P' RETURNING_VALUES :WK_GLOBAL;
           UPDATE SSN
           SET OTHER2 = :WK_GLOBAL
           WHERE SSN_ID = :SSN_ID;
        END
        ELSE
        BEGIN
           EXECUTE PROCEDURE GET_GLOBAL_CONDITION 2, 'F' RETURNING_VALUES :WK_GLOBAL;
           UPDATE SSN
           SET OTHER2 = :WK_GLOBAL
           WHERE SSN_ID = :SSN_ID;
        END
     END
     ELSE IF (:CODE = 'C') THEN
     BEGIN
        WK_FAIL_CNT = 0;
        SELECT COUNT(*) FROM PRODUCT_COND_STATUS
        WHERE SSN_ID = :SSN_ID
        AND   CODE = :CODE
        AND   ORIGINAL_TEST = 'S'
        INTO :WK_FAIL_CNT;
        IF (WK_FAIL_CNT = 0) THEN
        BEGIN
           EXECUTE PROCEDURE GET_GLOBAL_CONDITION 3, 'P' RETURNING_VALUES :WK_GLOBAL;
           UPDATE SSN
           SET OTHER3 = :WK_GLOBAL
           WHERE SSN_ID = :SSN_ID;
        END
        ELSE
        BEGIN
           EXECUTE PROCEDURE GET_GLOBAL_CONDITION 3, 'F' RETURNING_VALUES :WK_GLOBAL;
           UPDATE SSN
           SET OTHER3 = :WK_GLOBAL
           WHERE SSN_ID = :SSN_ID;
        END
     END   
     ELSE IF (:CODE = 'D') THEN
     BEGIN
        WK_FAIL_CNT = 0;
        SELECT COUNT(*) FROM PRODUCT_COND_STATUS
        WHERE SSN_ID = :SSN_ID
        AND   CODE = :CODE
        AND   ORIGINAL_TEST = 'S'
        INTO :WK_FAIL_CNT;
        IF (WK_FAIL_CNT = 0) THEN
        BEGIN
           EXECUTE PROCEDURE GET_GLOBAL_CONDITION 4, 'P' RETURNING_VALUES :WK_GLOBAL;
           UPDATE SSN
           SET OTHER4 = :WK_GLOBAL
           WHERE SSN_ID = :SSN_ID;
        END
        ELSE
        BEGIN
           EXECUTE PROCEDURE GET_GLOBAL_CONDITION 4, 'F' RETURNING_VALUES :WK_GLOBAL;
           UPDATE SSN
           SET OTHER4 = :WK_GLOBAL
           WHERE SSN_ID = :SSN_ID;
        END
     END   
     ELSE IF (:CODE = 'E') THEN
     BEGIN
        WK_FAIL_CNT = 0;
        SELECT COUNT(*) FROM PRODUCT_COND_STATUS
        WHERE SSN_ID = :SSN_ID
        AND   CODE = :CODE
        AND   ORIGINAL_TEST = 'S'
        INTO :WK_FAIL_CNT;
        IF (WK_FAIL_CNT = 0) THEN
        BEGIN
           EXECUTE PROCEDURE GET_GLOBAL_CONDITION 5, 'P' RETURNING_VALUES :WK_GLOBAL;
           UPDATE SSN
           SET OTHER5 = :WK_GLOBAL
           WHERE SSN_ID = :SSN_ID;
        END
        ELSE
        BEGIN
           EXECUTE PROCEDURE GET_GLOBAL_CONDITION 5, 'F' RETURNING_VALUES :WK_GLOBAL;
           UPDATE SSN
           SET OTHER5 = :WK_GLOBAL
           WHERE SSN_ID = :SSN_ID;
        END
     END   
  END   
END ^

ALTER PROCEDURE DELETE_SALE_ORDER_LINE (PICK_LABEL VARCHAR(7) CHARACTER SET NONE)
AS 
DECLARE VARIABLE WK_LABEL VARCHAR(7);
DECLARE VARIABLE WK_STATUS CHAR(2);
DECLARE VARIABLE WK_DOIT CHAR(2);
DECLARE VARIABLE WK_SSN VARCHAR(20);
DECLARE VARIABLE WK_PROD VARCHAR(30);

BEGIN
        
    /* Update Pick Item Status */
    FOR SELECT PICK_LABEL_NO, PICK_LINE_STATUS, SSN_ID, PROD_ID
       FROM PICK_ITEM 
       WHERE PICK_LABEL_NO = :PICK_LABEL
       INTO :WK_LABEL, :WK_STATUS, :WK_SSN, :WK_PROD
    DO
    BEGIN
       WK_DOIT = 'N';
       IF (WK_STATUS IS NULL) THEN
       BEGIN
          WK_DOIT = 'UC';
       END
       IF (WK_STATUS = 'UC') THEN
       BEGIN
          WK_DOIT = 'UC';
       END
       IF (WK_STATUS = 'CF') THEN
       BEGIN
          WK_DOIT = 'CF';
       END
       IF (WK_STATUS = 'OP') THEN
       BEGIN
          WK_DOIT = 'CF';
       END
       IF (WK_STATUS = 'UP') THEN
       BEGIN
          WK_DOIT = 'CF';
       END
       IF (WK_DOIT = 'UC') THEN
       BEGIN
          /* Unconfirmed line so can just cancel the line - no change to issn */
          DELETE FROM PICK_ITEM
          WHERE PICK_LABEL_NO = :WK_LABEL;
       END
       IF (WK_DOIT = 'CF') THEN
       BEGIN
          /* Confirmed line so cancel the line and change status of issn*/
          IF (WK_SSN IS NOT NULL) THEN
          BEGIN
             UPDATE ISSN SET ISSN_STATUS = 'PA', PICK_ORDER = NULL
             WHERE ORIGINAL_SSN = :WK_SSN
               AND PICK_ORDER = :WK_LABEL;
          END
          DELETE FROM PICK_ITEM
          WHERE PICK_LABEL_NO = :WK_LABEL;
       END
    END
END ^

ALTER PROCEDURE DELETE_SALE_ORDER_LINES (PICK_ORDER VARCHAR(10) CHARACTER SET NONE)
AS 
DECLARE VARIABLE WK_LABEL VARCHAR(7);
DECLARE VARIABLE WK_STATUS CHAR(2);
DECLARE VARIABLE WK_DOIT CHAR(2);
DECLARE VARIABLE WK_SSN VARCHAR(20);
DECLARE VARIABLE WK_PROD VARCHAR(30);

BEGIN
        
    /* Update Pick Item Status */
    FOR SELECT PICK_LABEL_NO, PICK_LINE_STATUS, SSN_ID, PROD_ID
       FROM PICK_ITEM 
       WHERE PICK_ORDER = :PICK_ORDER
       INTO :WK_LABEL, :WK_STATUS, :WK_SSN, :WK_PROD
    DO
    BEGIN
       WK_DOIT = 'N';
       IF (WK_STATUS IS NULL) THEN
       BEGIN
          WK_DOIT = 'UC';
       END
       IF (WK_STATUS = 'UC') THEN
       BEGIN
          WK_DOIT = 'UC';
       END
       IF (WK_STATUS = 'CF') THEN
       BEGIN
          WK_DOIT = 'CF';
       END
       IF (WK_STATUS = 'OP') THEN
       BEGIN
          WK_DOIT = 'CF';
       END
       IF (WK_STATUS = 'UP') THEN
       BEGIN
          WK_DOIT = 'CF';
       END
       IF (WK_DOIT = 'UC') THEN
       BEGIN
          /* Unconfirmed line so can just cancel the line - no change to issn */
          DELETE FROM PICK_ITEM
          WHERE PICK_LABEL_NO = :WK_LABEL;
       END
       IF (WK_DOIT = 'CF') THEN
       BEGIN
          /* Confirmed line so cancel the line and change status of issn*/
          IF (WK_SSN IS NOT NULL) THEN
          BEGIN
             UPDATE ISSN SET ISSN_STATUS = 'PA', PICK_ORDER = NULL
             WHERE ORIGINAL_SSN = :WK_SSN
               AND PICK_ORDER = :WK_LABEL;
          END
          DELETE FROM PICK_ITEM
          WHERE PICK_LABEL_NO = :WK_LABEL;
       END
    END
END ^

ALTER PROCEDURE DEL_REPORT_TEMP AS 
   
BEGIN  
    DELETE FROM REPORT_TEMP;       
END ^

ALTER PROCEDURE DESPATCH_LOCN_LIST (LOCATION VARCHAR(10) CHARACTER SET NONE)
RETURNS (DESPATCH_LOCATION VARCHAR(10) CHARACTER SET NONE,
PICK_ORDER VARCHAR(15) CHARACTER SET NONE,
PERSON_ID VARCHAR(10) CHARACTER SET NONE,
PICK_STATUS CHAR(2) CHARACTER SET NONE,
CONTACT_NAME VARCHAR(50) CHARACTER SET NONE,
PICK_PRIORITY INTEGER,
PICK_DUE_DATE TIMESTAMP,
SHIP_VIA VARCHAR(10) CHARACTER SET NONE,
CREATED_BY VARCHAR(10) CHARACTER SET NONE,
PARTIAL_PICK_ALLOWED CHAR(1) CHARACTER SET NONE,
SPECIAL_INSTRUCTIONS1 VARCHAR(8196) CHARACTER SET NONE,
SPECIAL_INSTRUCTIONS2 VARCHAR(255) CHARACTER SET NONE,
CREATE_DATE TIMESTAMP,
CUSTOMER_PO_WO VARCHAR(20) CHARACTER SET NONE,
INV_WITH_GOODS CHAR(1) CHARACTER SET NONE,
PICK_ORDER_TYPE VARCHAR(2) CHARACTER SET NONE)
AS 
BEGIN
/* MODIFIED 22/07/2004 BY MANUEL TO ADD PICK_ORDER_TYPE FIELD TO OUTPUT. THATS ALL*/
   FOR SELECT
      PICK_ITEM_DETAIL.DESPATCH_LOCATION , 
      PICK_ITEM.PICK_ORDER 
      FROM PICK_ITEM_DETAIL 
      JOIN PICK_ITEM ON PICK_ITEM.PICK_LABEL_NO = PICK_ITEM_DETAIL.PICK_LABEL_NO 
      WHERE PICK_ITEM_DETAIL.PICK_DETAIL_STATUS = 'DS' 
       AND PICK_ITEM_DETAIL.DESPATCH_LOCATION = :LOCATION 
      GROUP BY PICK_ITEM_DETAIL.DESPATCH_LOCATION, 
               PICK_ITEM.PICK_ORDER  
      INTO :DESPATCH_LOCATION, PICK_ORDER
   DO
   BEGIN
      SELECT PERSON_ID, PICK_STATUS, CONTACT_NAME, 
                 PICK_PRIORITY, PICK_DUE_DATE, SHIP_VIA, CREATED_BY, 
                 PARTIAL_PICK_ALLOWED, SPECIAL_INSTRUCTIONS1, SPECIAL_INSTRUCTIONS2, 
                 CREATE_DATE, CUSTOMER_PO_WO, INV_WITH_GOODS, PICK_ORDER_TYPE
           FROM PICK_ORDER
           WHERE PICK_ORDER = :PICK_ORDER
           INTO :PERSON_ID, :PICK_STATUS, :CONTACT_NAME, 
                 :PICK_PRIORITY, :PICK_DUE_DATE, :SHIP_VIA, :CREATED_BY, 
                 :PARTIAL_PICK_ALLOWED, :SPECIAL_INSTRUCTIONS1, :SPECIAL_INSTRUCTIONS2, 
                 :CREATE_DATE, :CUSTOMER_PO_WO, :INV_WITH_GOODS, :PICK_ORDER_TYPE;
       SUSPEND;
   END 
END ^

ALTER PROCEDURE EXPORT_CANCEL_ORDER (ORDER_ID VARCHAR(15) CHARACTER SET NONE)
AS 
 
 
  DECLARE VARIABLE WK_DO_EXPORT_W CHAR(1);
  DECLARE VARIABLE WK_DATE VARCHAR(8);
  DECLARE VARIABLE WK_DATE2 VARCHAR(14);
  DECLARE VARIABLE WK_PROD VARCHAR(30);
  DECLARE VARIABLE WK_EXTERNAL_ORDER VARCHAR(20);
  DECLARE VARIABLE WK_QTY INTEGER;
  DECLARE VARIABLE WK_PROD_QTY INTEGER;
  DECLARE VARIABLE WK_ORDER VARCHAR(15);
  DECLARE VARIABLE WK_EXPORT_ORDER VARCHAR(15);
  DECLARE VARIABLE WK_OTHER1 VARCHAR(40);
  DECLARE VARIABLE WK_ORDER_PREFIX VARCHAR(40);
  DECLARE VARIABLE WK_COMPANY VARCHAR(20);
  DECLARE VARIABLE WK_PRINTER CHAR(2);
  DECLARE VARIABLE WK_PRINTER_CANCEL CHAR(2);
  DECLARE VARIABLE WK_DIRECTORY VARCHAR(75);
  DECLARE VARIABLE WK_FILENAME VARCHAR(255);
  DECLARE VARIABLE WK_FILENAME2 VARCHAR(255);
  DECLARE VARIABLE WK_LABEL_LINE VARCHAR(250);
  DECLARE VARIABLE WK_HAVE_FILE INTEGER;
  DECLARE VARIABLE WK_RESULT INTEGER;
  DECLARE VARIABLE DEVICE_ID CHAR(2);
  DECLARE VARIABLE PERSON_ID VARCHAR(10);
  DECLARE VARIABLE TRN_DATE TIMESTAMP;

BEGIN
   WK_HAVE_FILE = 0;
   SELECT SEND_SO_CANCEL, EXPORT_SO_HELD_PRINTER , EXPORT_SO_CANCEL_PRINTER 
   FROM CONTROL 
   INTO :WK_DO_EXPORT_W, :WK_PRINTER, :WK_PRINTER_CANCEL;
   IF (WK_DO_EXPORT_W = 'T') THEN
   BEGIN
      TRN_DATE = 'NOW';
      WK_DATE = LPAD(MER_DAY(TRN_DATE),'0',2) || LPAD(MER_MONTH(TRN_DATE),'0',2) || SUBSTR(CAST(MER_YEAR(TRN_DATE) AS CHAR(4)) , 3,4);
      WK_DATE2 = CAST(MER_YEAR(TRN_DATE) AS CHAR(4)) || LPAD(MER_MONTH(TRN_DATE),'0',2) || LPAD(MER_DAY(TRN_DATE),'0',2) || LPAD(MER_HOUR(TRN_DATE),'0',2) || LPAD(MER_MINUTE(TRN_DATE),'0',2) || LPAD(SEC(TRN_DATE),'0',2) ; 
      /* need the directory for this label set */
      SELECT WORKING_DIRECTORY FROM SYS_EQUIP 
             WHERE DEVICE_ID = :WK_PRINTER
             INTO :WK_DIRECTORY;
      BEGIN
         FOR SELECT PICK_ORDER.CUSTOMER_PO_WO, PICK_ITEM.PROD_ID, PICK_ITEM.PICK_ORDER_QTY, PICK_ORDER.PICK_ORDER, PICK_ORDER.OTHER1, PICK_ORDER.OTHER3
         FROM PICK_ORDER 
         JOIN PICK_ITEM ON PICK_ORDER.PICK_ORDER = PICK_ITEM.PICK_ORDER
         WHERE PICK_ORDER.PICK_ORDER = :ORDER_ID
         AND PICK_ITEM.PICK_LINE_STATUS = 'HD'
         INTO :WK_EXTERNAL_ORDER , :WK_PROD, :WK_QTY, :WK_ORDER, :WK_OTHER1, :WK_ORDER_PREFIX
         DO
         BEGIN
            IF (WK_EXTERNAL_ORDER IS NULL) THEN
            BEGIN
               WK_EXTERNAL_ORDER = '';
            END
            IF (WK_PROD IS NULL) THEN
            BEGIN
               WK_PROD = '';
            END
            IF (WK_ORDER IS NULL) THEN
            BEGIN
               WK_ORDER = '';
            END
            IF (WK_OTHER1 IS NULL) THEN
            BEGIN
               WK_OTHER1 = '';
            END
            IF (WK_ORDER_PREFIX IS NULL) THEN
            BEGIN
               WK_ORDER_PREFIX = '';
            END
            IF (WK_QTY IS NULL) THEN
            BEGIN
               WK_QTY = 0;
            END
            WK_EXPORT_ORDER = SUBSTR(WK_ORDER,LEN(WK_ORDER_PREFIX) + 1,LEN(WK_ORDER));
            /* append the file name to the directory*/
            WK_FILENAME = WK_DIRECTORY || WK_ORDER_PREFIX || 'REVERSAL' || WK_DATE || WK_EXPORT_ORDER || '.1xt';
            WK_LABEL_LINE = '"' || WK_EXTERNAL_ORDER || '","' ||
                WK_PROD || '","' ||
                WK_QTY || '","' ||
                WK_EXPORT_ORDER || '","' ||
                WK_OTHER1 || '","' ||
                WK_ORDER_PREFIX || '"' ;
     
            WK_HAVE_FILE = 1;
            WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE);
            IF (WK_RESULT <> 0) THEN
            BEGIN
               WK_FILENAME = WK_DIRECTORY || WK_ORDER_PREFIX || 'REVERSAL' || WK_DATE || WK_EXPORT_ORDER || '.2xt';
               WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE);
               WK_HAVE_FILE = -1;
            END
         END
      END /* end of held lines */
      IF (WK_HAVE_FILE = 1) THEN
      BEGIN
         WK_FILENAME = WK_DIRECTORY || WK_ORDER_PREFIX || 'REVERSAL' || WK_DATE || WK_EXPORT_ORDER || '.1xt';
         WK_FILENAME2 = WK_DIRECTORY || WK_ORDER_PREFIX || 'REVERSAL' || WK_DATE || WK_EXPORT_ORDER || '.txt';
         WK_RESULT = FILE_RENAME(WK_FILENAME, WK_FILENAME2);
      END
      IF (WK_HAVE_FILE = -1) THEN
      BEGIN
         WK_FILENAME = WK_DIRECTORY || WK_ORDER_PREFIX || 'REVERSAL' || WK_DATE || WK_EXPORT_ORDER || '.2xt';
         WK_FILENAME2 = WK_DIRECTORY || WK_ORDER_PREFIX || 'REVERSAL' || WK_DATE || WK_EXPORT_ORDER || '.txt';
         WK_RESULT = FILE_RENAME(WK_FILENAME, WK_FILENAME2);
      END
      WK_HAVE_FILE = 0;
      /* need the directory for this label set */
      SELECT WORKING_DIRECTORY FROM SYS_EQUIP 
             WHERE DEVICE_ID = :WK_PRINTER_CANCEL
             INTO :WK_DIRECTORY;
      BEGIN
         FOR SELECT PICK_ORDER.CUSTOMER_PO_WO, PICK_ITEM.PROD_ID, PICK_ITEM.PICK_ORDER_QTY, PICK_ORDER.PICK_ORDER, PICK_ORDER.OTHER1, PICK_ORDER.COMPANY_ID, PICK_ORDER.OTHER3
         FROM PICK_ORDER 
         JOIN PICK_ITEM ON PICK_ORDER.PICK_ORDER = PICK_ITEM.PICK_ORDER
         WHERE PICK_ORDER.PICK_ORDER = :ORDER_ID
         INTO :WK_EXTERNAL_ORDER , :WK_PROD, :WK_QTY, :WK_ORDER, :WK_OTHER1, :WK_COMPANY, :WK_ORDER_PREFIX
         DO
         BEGIN
            IF (WK_EXTERNAL_ORDER IS NULL) THEN
            BEGIN
               WK_EXTERNAL_ORDER = '';
            END
            IF (WK_PROD IS NULL) THEN
            BEGIN
               WK_PROD = '';
            END
            IF (WK_ORDER IS NULL) THEN
            BEGIN
               WK_ORDER = '';
            END
            IF (WK_OTHER1 IS NULL) THEN
            BEGIN
               WK_OTHER1 = '';
            END
            IF (WK_ORDER_PREFIX IS NULL) THEN
            BEGIN
               WK_ORDER_PREFIX = '';
            END
            IF (WK_COMPANY IS NULL) THEN
            BEGIN
               WK_COMPANY = '';
            END
            IF (WK_QTY IS NULL) THEN
            BEGIN
               WK_QTY = 0;
            END
            WK_EXPORT_ORDER = SUBSTR(WK_ORDER,LEN(WK_ORDER_PREFIX) + 1,LEN(WK_ORDER));
            /* append the file name to the directory*/
            WK_FILENAME = WK_DIRECTORY || WK_ORDER_PREFIX || 'CANCEL' || WK_DATE || WK_EXPORT_ORDER || '.1xt';
            WK_LABEL_LINE = '"UOST","O","' || WK_DATE2 || '","' ||
               WK_EXPORT_ORDER || '","' ||
               WK_COMPANY || '","' ||
               "CN" || '","' ||
               WK_PROD || '","' ||
               WK_QTY || '","BDCS","XX","' ||
               WK_EXTERNAL_ORDER || '","' ||
               WK_OTHER1 || '","' ||
               WK_ORDER_PREFIX || '"' ;
     
            WK_HAVE_FILE = 1;
            WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE);
            IF (WK_RESULT <> 0) THEN
            BEGIN
               WK_FILENAME = WK_DIRECTORY || WK_ORDER_PREFIX || 'CANCEL' || WK_DATE || WK_EXPORT_ORDER || '.2xt';
               WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE);
               WK_HAVE_FILE = -1;
            END
         END
      END
      IF (WK_HAVE_FILE = 1) THEN
      BEGIN
         WK_FILENAME = WK_DIRECTORY || WK_ORDER_PREFIX || 'CANCEL' || WK_DATE || WK_EXPORT_ORDER || '.1xt';
         WK_FILENAME2 = WK_DIRECTORY || WK_ORDER_PREFIX || 'CANCEL' || WK_DATE || WK_EXPORT_ORDER || '.txt';
         WK_RESULT = FILE_RENAME(WK_FILENAME, WK_FILENAME2);
      END
      IF (WK_HAVE_FILE = -1) THEN
      BEGIN
         WK_FILENAME = WK_DIRECTORY ||  WK_ORDER_PREFIX || 'CANCEL' || WK_DATE || WK_EXPORT_ORDER || '.2xt';
         WK_FILENAME2 = WK_DIRECTORY || WK_ORDER_PREFIX || 'CANCEL' || WK_DATE || WK_EXPORT_ORDER || '.txt';
         WK_RESULT = FILE_RENAME(WK_FILENAME, WK_FILENAME2);
      END
   END
END ^

ALTER PROCEDURE EXPORT_PUTAWAY (PUTAWAY_ID VARCHAR(10) CHARACTER SET NONE)
AS 
 
  DECLARE VARIABLE WK_DO_EXPORT_W CHAR(1);
  DECLARE VARIABLE WK_DATE VARCHAR(8);
  DECLARE VARIABLE WK_PROD VARCHAR(30);
  DECLARE VARIABLE WK_COMPANY VARCHAR(20);
  DECLARE VARIABLE WK_QTY INTEGER;
  DECLARE VARIABLE WK_PROD_QTY INTEGER;
  DECLARE VARIABLE WK_GRN VARCHAR(10);
  DECLARE VARIABLE WK_PO VARCHAR(10);
  DECLARE VARIABLE WK_PRINTER CHAR(2);
  DECLARE VARIABLE WK_DIRECTORY VARCHAR(75);
  DECLARE VARIABLE WK_FILENAME VARCHAR(255);
  DECLARE VARIABLE WK_LABEL_LINE VARCHAR(250);
  DECLARE VARIABLE WK_HAVE_FILE INTEGER;
  DECLARE VARIABLE WK_RESULT INTEGER;
  DECLARE VARIABLE WK_OBJECT VARCHAR(30);
  DECLARE VARIABLE DEVICE_ID CHAR(2);
  DECLARE VARIABLE PERSON_ID VARCHAR(10);
  DECLARE VARIABLE TRN_DATE TIMESTAMP;

BEGIN
   SELECT EXPORT_TRIL_W, EXPORT_PUTAWAY_PRINTER 
   FROM CONTROL 
   INTO :WK_DO_EXPORT_W, :WK_PRINTER;
   IF (WK_DO_EXPORT_W = 'T') THEN
   BEGIN
      TRN_DATE = 'NOW';
      WK_DATE = LPAD(MER_DAY(TRN_DATE),'0',2) || LPAD(MER_MONTH(TRN_DATE),'0',2) || SUBSTR(CAST(MER_YEAR(TRN_DATE) AS CHAR(4)) , 3,4);
      /* need the directory for this label set */
      SELECT WORKING_DIRECTORY FROM SYS_EQUIP 
             WHERE DEVICE_ID = :WK_PRINTER
             INTO :WK_DIRECTORY;
      BEGIN
         FOR SELECT ISSN.COMPANY_ID, ISSN.PROD_ID , SUM(ISSN.CURRENT_QTY), SSN.GRN, SSN.PO_ORDER, ISSN_PUTAWAY.DEVICE_ID, ISSN_PUTAWAY.PERSON_ID
         FROM ISSN_PUTAWAY 
         JOIN ISSN ON ISSN.SSN_ID = ISSN_PUTAWAY.SSN_ID
         JOIN SSN ON SSN.SSN_ID = ISSN.ORIGINAL_SSN
         WHERE PUTAWAY_ID = :PUTAWAY_ID
         GROUP BY ISSN.COMPANY_ID, ISSN.PROD_ID, SSN.GRN, SSN.PO_ORDER, ISSN_PUTAWAY.DEVICE_ID, ISSN_PUTAWAY.PERSON_ID
         INTO :WK_COMPANY , :WK_PROD, :WK_QTY, :WK_GRN, :WK_PO, :DEVICE_ID, PERSON_ID
         DO
         BEGIN
            IF (WK_COMPANY IS NULL) THEN
            BEGIN
               WK_COMPANY = '';
            END
            IF (WK_PROD IS NULL) THEN
            BEGIN
               WK_PROD = '';
            END
            IF (WK_GRN IS NULL) THEN
            BEGIN
               WK_GRN = '';
            END
            IF (WK_PO IS NULL) THEN
            BEGIN
               WK_PO = '';
            END
            IF (WK_QTY IS NULL) THEN
            BEGIN
               WK_QTY = 0;
            END
            /* append the file name to the directory*/
            WK_FILENAME = WK_DIRECTORY || 'PUTAWAY.txt';
            WK_LABEL_LINE = '"' || WK_COMPANY || '",' ||
                WK_DATE || ',"' ||
                WK_PO || '","' ||
                WK_GRN || '","' ||
                WK_PROD || '",' ||
                WK_QTY || ',"' ||
                DEVICE_ID || ' ' || PUTAWAY_ID || '"' ;
     
            WK_HAVE_FILE = 1;
            WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE);
            IF (WK_RESULT <> 0) THEN
            BEGIN
               WK_FILENAME = WK_DIRECTORY || 'PUTAWAY.2xt';
               WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE);
               WK_HAVE_FILE = -1;
            END
         END
      END
      
   END
END ^

ALTER PROCEDURE FILECONCAT (SOURCEFILES VARCHAR(1024) CHARACTER SET NONE,
DESTFILE VARCHAR(255) CHARACTER SET NONE)
RETURNS (RES INTEGER)
AS 

begin
   res=file_concat(sourcefiles,destfile);
   suspend;
end ^

ALTER PROCEDURE FILECREATE (FILENAME VARCHAR(255) CHARACTER SET NONE)
RETURNS (RES INTEGER)
AS 

begin
   res=file_create(filename);
   suspend;
end ^

ALTER PROCEDURE FILEDELETE (FILENAME VARCHAR(255) CHARACTER SET NONE)
RETURNS (RES INTEGER)
AS 

begin
   res=file_delete(filename);
   suspend;
end ^

ALTER PROCEDURE FILERENAME (OLDFILENAME VARCHAR(255) CHARACTER SET NONE,
NEWFILENAME VARCHAR(255) CHARACTER SET NONE)
RETURNS (RES INTEGER)
AS 

begin
   res=file_rename(oldfilename,newfilename);
   suspend;
end ^

ALTER PROCEDURE GET_ALPHA (WK_CODE VARCHAR(20) CHARACTER SET NONE)
RETURNS (WK_NEW_CODE VARCHAR(20) CHARACTER SET NONE)
AS 
 
 
DECLARE VARIABLE WK_CHAR CHAR(1);
DECLARE VARIABLE WK_FOUND INTEGER;
DECLARE VARIABLE WK_CNT INTEGER;
BEGIN
   WK_CNT = 1;
   WK_NEW_CODE = '';
   WHILE (WK_CNT <= LEN(WK_CODE)) DO
   BEGIN
      WK_CHAR = SUBSTR(WK_CODE, WK_CNT,WK_CNT);
      WK_CNT = WK_CNT + 1;
      IF ((WK_CHAR >= 'A' AND WK_CHAR <= 'Z') OR
          (WK_CHAR >= 'a' AND WK_CHAR <= 'z')) THEN
      BEGIN
         WK_NEW_CODE = WK_NEW_CODE || WK_CHAR;
      END
   END
   SUSPEND;
END ^

ALTER PROCEDURE GET_ALPHA_NUMERIC (WK_CODE VARCHAR(20) CHARACTER SET NONE)
RETURNS (WK_NEW_CODE VARCHAR(20) CHARACTER SET NONE)
AS 
 
 
DECLARE VARIABLE WK_CHAR CHAR(1);
DECLARE VARIABLE WK_FOUND INTEGER;
DECLARE VARIABLE WK_CNT INTEGER;
BEGIN
   WK_CNT = 1;
   WK_NEW_CODE = '';
   WHILE (WK_CNT <= LEN(WK_CODE)) DO
   BEGIN
      WK_CHAR = SUBSTR(WK_CODE, WK_CNT,WK_CNT);
      WK_CNT = WK_CNT + 1;
      IF ((WK_CHAR >= '0' AND WK_CHAR <= '9') OR
          (WK_CHAR >= 'A' AND WK_CHAR <= 'Z') OR
          (WK_CHAR >= 'a' AND WK_CHAR <= 'z')) THEN
      BEGIN
         WK_NEW_CODE = WK_NEW_CODE || WK_CHAR;
      END
   END
   SUSPEND;
END ^

ALTER PROCEDURE GET_BARCODE_LENGTH RETURNS (BARCODE_LENGTH INTEGER)
AS 
    
     
BEGIN

  SELECT MAX_LENGTH
  FROM PARAM
  WHERE DATA_ID = 'BARCODE'
  INTO :BARCODE_LENGTH;
  
END ^

ALTER PROCEDURE GET_CURRENT_PROD_STATUS AS 
 


  DECLARE VARIABLE WK_SSN VARCHAR(30);
  DECLARE VARIABLE WK_GLOBAL1 VARCHAR(30);
  DECLARE VARIABLE WK_GLOBAL2 VARCHAR(30);
  DECLARE VARIABLE WK_GLOBAL3 VARCHAR(30);
  DECLARE VARIABLE WK_GLOBAL4 VARCHAR(30);
  DECLARE VARIABLE WK_FAIL_CNT INTEGER;

BEGIN
   FOR SELECT SSN_ID FROM SSN INTO :WK_SSN
   DO
   BEGIN
      WK_FAIL_CNT = 0;
      SELECT COUNT(*) FROM PRODUCT_COND_STATUS
      WHERE SSN_ID = :WK_SSN
      AND   CODE = 'A'
      AND   ORIGINAL_TEST = 'S'
      INTO :WK_FAIL_CNT;
      IF (WK_FAIL_CNT = 0) THEN
      BEGIN
         EXECUTE PROCEDURE GET_GLOBAL_CONDITION 1, 'P' RETURNING_VALUES :WK_GLOBAL1;
      END
      ELSE
      BEGIN
         EXECUTE PROCEDURE GET_GLOBAL_CONDITION 1, 'F' RETURNING_VALUES :WK_GLOBAL1;
      END
      WK_FAIL_CNT = 0;
      SELECT COUNT(*) FROM PRODUCT_COND_STATUS
      WHERE SSN_ID = :WK_SSN
      AND   CODE = 'B'
      AND   ORIGINAL_TEST = 'S'
      INTO :WK_FAIL_CNT;
      IF (WK_FAIL_CNT = 0) THEN
      BEGIN
         EXECUTE PROCEDURE GET_GLOBAL_CONDITION 2, 'P' RETURNING_VALUES :WK_GLOBAL2;
      END
      ELSE
      BEGIN
         EXECUTE PROCEDURE GET_GLOBAL_CONDITION 2, 'F' RETURNING_VALUES :WK_GLOBAL2;
      END
      WK_FAIL_CNT = 0;
      SELECT COUNT(*) FROM PRODUCT_COND_STATUS
      WHERE SSN_ID = :WK_SSN
      AND   CODE = 'C'
      AND   ORIGINAL_TEST = 'S'
      INTO :WK_FAIL_CNT;
      IF (WK_FAIL_CNT = 0) THEN
      BEGIN
         EXECUTE PROCEDURE GET_GLOBAL_CONDITION 3, 'P' RETURNING_VALUES :WK_GLOBAL3;
      END
      ELSE
      BEGIN
         EXECUTE PROCEDURE GET_GLOBAL_CONDITION 3, 'F' RETURNING_VALUES :WK_GLOBAL3;
      END
      WK_FAIL_CNT = 0;
      SELECT COUNT(*) FROM PRODUCT_COND_STATUS
      WHERE SSN_ID = :WK_SSN
      AND   CODE = 'D'
      AND   ORIGINAL_TEST = 'S'
      INTO :WK_FAIL_CNT;
      IF (WK_FAIL_CNT = 0) THEN
      BEGIN
         EXECUTE PROCEDURE GET_GLOBAL_CONDITION 4, 'P' RETURNING_VALUES :WK_GLOBAL4;
      END
      ELSE
      BEGIN
         EXECUTE PROCEDURE GET_GLOBAL_CONDITION 4, 'F' RETURNING_VALUES :WK_GLOBAL4;
      END
      UPDATE SSN
      SET OTHER1 = :WK_GLOBAL1,
      OTHER2 = :WK_GLOBAL2,
      OTHER3 = :WK_GLOBAL3,
      OTHER4 = :WK_GLOBAL4
      WHERE SSN_ID = :WK_SSN;
   END
END ^

ALTER PROCEDURE GET_DATA_REFERENCE_FIELD4 (REFERENCE VARCHAR(1024) CHARACTER SET NONE,
WK_DELIMITER CHAR(1) CHARACTER SET NONE)
RETURNS (WK_FIELD_LABEL VARCHAR(1024) CHARACTER SET NONE,
WK_FIELD_DATA VARCHAR(1024) CHARACTER SET NONE)
AS 
 
 
BEGIN
  WK_FIELD_LABEL = '';
  WK_FIELD_DATA = '';
  
  IF (STRLEN(:REFERENCE) = 0) THEN
  BEGIN     
     EXIT;
  END
  WK_FIELD_LABEL = V4ALLTRIM(V4PARSE(REFERENCE, WK_DELIMITER, 1));
  IF (WK_FIELD_LABEL = 'Token to long in parse') THEN
  BEGIN
     WK_FIELD_LABEL = '';
  END
  WK_FIELD_DATA = V4ALLTRIM(V4PARSE(REFERENCE, WK_DELIMITER, 2));
  IF (WK_FIELD_DATA = 'Token to long in parse') THEN
  BEGIN
     WK_FIELD_DATA = '';
  END
  SUSPEND;
END ^

ALTER PROCEDURE GET_EMP_IMAGE_ID RETURNS (IMAGE_ID INTEGER)
AS 
 
BEGIN 
   IMAGE_ID = GEN_ID(EMP_IMAGE_GEN, 1);
END ^

ALTER PROCEDURE GET_EMP_NO RETURNS (EMPLOYEE_ID VARCHAR(10) CHARACTER SET NONE)
AS 
  
DECLARE VARIABLE iEmpNo INTEGER;
DECLARE VARIABLE iLengthEmpNo INTEGER;
DECLARE VARIABLE sEmpNo VARCHAR(10);
BEGIN
  iEmpNo = GEN_ID(EMP_NO_GEN, 1) ;
  iLengthEmpNo = STRLEN(iEmpNo);
  
  /* default prefix */
  sEmpNo = 'M7-';
  
  /* Padding leading with 0 */
  WHILE (iLengthEmpNo < 7) DO
  BEGIN
        sEmpNo = sEmpNo || '0';      
        iLengthEmpNo = iLengthEmpNo + 1;
  END
  sEmpNo = sEmpNo || iEmpNo;
  
  /* Return LoadNo to the caller */
  EMPLOYEE_ID = sEmpNo;
  
END ^

ALTER PROCEDURE GET_FORM_NO RETURNS (FORM_NO VARCHAR(8) CHARACTER SET NONE)
AS 
  
DECLARE VARIABLE wk_formno_i INTEGER;
DECLARE VARIABLE wk_len INTEGER;
DECLARE VARIABLE wk_formno VARCHAR(8);
BEGIN
  wk_formno_i = GEN_ID(FORM_NO_GEN, 1) ;
  
  /* default prefix */
  SELECT FORM_NO_PREFIX
    FROM CONTROL
    INTO :wk_formno;

  wk_len = STRLEN(wk_formno_i) + STRLEN(wk_formno);

  /* Padding leading with 0 */
  WHILE (wk_len < 8) DO
  BEGIN
        wk_formno = wk_formno || '0';      
        wk_len = wk_len + 1;
  END
  wk_formno = wk_formno || wk_formno_i;
  
  /* Return LoadNo to the caller */
  FORM_NO = wk_formno;
  
END ^

ALTER PROCEDURE GET_GLOBAL_CONDITION (OTHER_NO INTEGER,
RESULT CHAR(1) CHARACTER SET NONE)
RETURNS (DESCRIPTION VARCHAR(30) CHARACTER SET NONE)
AS 
 
 

BEGIN
  SELECT DESCRIPTION FROM GLOBAL_CONDITIONS
  WHERE OTHER_NO = :OTHER_NO
  AND RESULT = :RESULT
  INTO :DESCRIPTION;
  SUSPEND;

END ^

ALTER PROCEDURE GET_HANDHELD_TRANSFERS (DEVICE_ID VARCHAR(2) CHARACTER SET NONE)
RETURNS (PICK_ORDER VARCHAR(30) CHARACTER SET NONE,
PROD_ID VARCHAR(30) CHARACTER SET NONE,
SHORT_DESC VARCHAR(50) CHARACTER SET NONE)
AS 
 
DECLARE VARIABLE WK_PROD VARCHAR(30);
DECLARE VARIABLE WK_SSN VARCHAR(20);
DECLARE VARIABLE WK_PROD_DESC VARCHAR(50);
DECLARE VARIABLE WK_TYPE_DESC VARCHAR(50);
BEGIN
   /* Procedure body */ 
   FOR SELECT P1.PICK_ORDER, P1.PROD_ID, P1.SSN_ID, P2.SHORT_DESC, S3.DESCRIPTION
       FROM PICK_ITEM P1 
       LEFT OUTER JOIN PROD_PROFILE P2 ON P1.PROD_ID = P2.PROD_ID 
       LEFT OUTER JOIN ISSN S1 ON P1.SSN_ID = S1.SSN_ID 
       LEFT OUTER JOIN SSN S2 ON S1.ORIGINAL_SSN = S2.SSN_ID 
       LEFT OUTER JOIN SSN_TYPE S3 ON S2.SSN_TYPE = S3.CODE 
       WHERE P1.PICK_LINE_STATUS IN ('AL','PG','PL','DS') 
       AND P1.DEVICE_ID = :DEVICE_ID 
       INTO :PICK_ORDER, :WK_PROD, :WK_SSN, :WK_PROD_DESC, :WK_TYPE_DESC 
   DO
   BEGIN 
      IF ((WK_SSN IS NULL) OR (WK_SSN = '')) THEN
      BEGIN
         /* a prod */
         PROD_ID = WK_PROD;
         SHORT_DESC = WK_PROD_DESC;
      END
      ELSE
      BEGIN
         /* a ssn */
         PROD_ID = WK_SSN;
         SHORT_DESC = WK_TYPE_DESC;
      END 
      SUSPEND; 
   END 
   EXIT; 
END ^

ALTER PROCEDURE GET_ISSN_REPLENISH AS 

/* populate the replenish from the prod profile */
/*
this procedure updates the transfer_requests product based
*/
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_DEVICE CHAR(2);
DECLARE VARIABLE WK_RECORD INTEGER;
DECLARE VARIABLE WK_DATE TIMESTAMP;
DECLARE VARIABLE WK_PROD VARCHAR(30);
DECLARE VARIABLE WK_WH_ID CHAR(2);
DECLARE VARIABLE WK_LOCN VARCHAR(10);
DECLARE VARIABLE WK_PROD_ID2 VARCHAR(30);
DECLARE VARIABLE WK_MIN_QTY INTEGER;
DECLARE VARIABLE WK_MAX_QTY INTEGER;
DECLARE VARIABLE WK_REORDER_QTY INTEGER;
DECLARE VARIABLE WK_WH_QTY INTEGER;
DECLARE VARIABLE WK_CURRENT_QTY INTEGER;
DECLARE VARIABLE WK_FOUND INTEGER;
DECLARE VARIABLE WK_TRANSFER_LINE INTEGER;
DECLARE VARIABLE WK_TRANSFER_STATUS CHAR(2);
DECLARE VARIABLE WK_TRANSFER_PRIORITY SMALLINT;
DECLARE VARIABLE IMPORTSTATUS VARCHAR(40);
DECLARE VARIABLE WK_DUMMY INTEGER;
BEGIN
   WK_DATE = 'NOW';
   SELECT CONTROL.PICK_IMPORT_SSN_STATUS
   FROM CONTROL
   INTO :IMPORTSTATUS; 
   
   FOR  SELECT PROD_ID, WH_ID, LOCN_ID,  MIN_QTY, MAX_QTY, REORDER_QTY
      FROM LOCATION
      WHERE REPLENISH = 'T'
      AND (PROD_ID IS NOT NULL)
      AND (REORDER_QTY IS NOT NULL)
      AND (MAX_QTY IS NOT NULL)
      INTO :WK_PROD, 
           :WK_WH_ID, 
           :WK_LOCN, 
           :WK_MIN_QTY,
           :WK_MAX_QTY,
           :WK_REORDER_QTY
   DO
   BEGIN
      /* ok have a match - iand qts not null */
      /*
      SELECT AVAILABLE_QTY 
      FROM PRODUCT_STOCK_STATUS(:WK_PROD) 
      INTO :WK_WH_QTY;
      */
      /*
      SELECT FIRST 1 CURRENT_QTY
      FROM ISSN
      WHERE ISSN.PROD_ID = :WK_PROD
      AND CURRENT_QTY > 0
      AND (POS(:IMPORTSTATUS,ISSN.ISSN_STATUS,0,1) > -1)
      */
      WK_WH_QTY = 0;
      SELECT FIRST 1 CURRENT_QTY
      FROM ISSN
      JOIN LOCATION L1 ON L1.WH_ID = ISSN.WH_ID AND L1.LOCN_ID = ISSN.LOCN_ID
      WHERE ISSN.PROD_ID = :WK_PROD
      AND CURRENT_QTY > 0
      AND (POS(:IMPORTSTATUS,ISSN.ISSN_STATUS,0,1) > -1)
      AND L1.STORE_AREA <> 'PS'
      INTO :WK_WH_QTY;
      IF (WK_WH_QTY IS NULL) THEN
      BEGIN
         WK_WH_QTY = 0;
      END
      IF (WK_WH_QTY > 0) THEN
      BEGIN
         WK_CURRENT_QTY = 0;
         SELECT SUM( ISSN.CURRENT_QTY ) 
            FROM ISSN
            WHERE ISSN.PROD_ID = :WK_PROD
            AND WH_ID = :WK_WH_ID
            AND LOCN_ID = :WK_LOCN
            /* AND (POS(:IMPORTSTATUS,ISSN.ISSN_STATUS,0,1) > -1) */
            INTO :WK_CURRENT_QTY;
         IF (WK_CURRENT_QTY IS NULL) THEN
         BEGIN
            WK_CURRENT_QTY = 0;
         END

         IF (WK_CURRENT_QTY < WK_REORDER_QTY) THEN
         BEGIN
            IF (WK_CURRENT_QTY < WK_MIN_QTY) THEN
            BEGIN
               WK_TRANSFER_PRIORITY = 5;
            END
            ELSE
            BEGIN
               WK_TRANSFER_PRIORITY = 10;
            END
            /* now get the transfer request to update */
            WK_FOUND = 0;
            SELECT FIRST 1 1, TRN_LINE_NO, TRN_STATUS
            FROM TRANSFER_REQUEST
            WHERE TO_WH_ID = :WK_WH_ID
            AND TO_LOCN_ID = :WK_LOCN
            AND PROD_ID = :WK_PROD
            AND TRN_STATUS IN ( 'OP', 'CN','AL','PG','PL')
            AND QTY IS NULL
            INTO :WK_FOUND, :WK_TRANSFER_LINE, :WK_TRANSFER_STATUS;
            IF (WK_FOUND = 0) THEN
            BEGIN
               /* insert it */
               /* only nominate the wh,locn ,product and priority */
               INSERT INTO TRANSFER_REQUEST (TO_WH_ID, TO_LOCN_ID, PROD_ID, TRN_PRIORITY, TRN_STATUS) VALUES (:WK_WH_ID, :WK_LOCN, :WK_PROD, :WK_TRANSFER_PRIORITY, 'OP'); 
            END
            ELSE
            BEGIN
               /* update it */
               IF (WK_TRANSFER_STATUS = 'CN') THEN
               BEGIN
                  UPDATE TRANSFER_REQUEST
                  SET TRN_STATUS = 'OP',
                  TRN_PRIORITY = :WK_TRANSFER_PRIORITY
                  WHERE TRN_LINE_NO = :WK_TRANSFER_LINE;
               END
               ELSE
               BEGIN
                  IF (WK_TRANSFER_STATUS = 'OP') THEN
                  BEGIN
                     UPDATE TRANSFER_REQUEST
                     SET TRN_PRIORITY = :WK_TRANSFER_PRIORITY
                     WHERE TRN_LINE_NO = :WK_TRANSFER_LINE;
                  END
                  ELSE
                  BEGIN
                     IF (WK_TRANSFER_STATUS = 'AL') THEN
                     BEGIN
                        UPDATE TRANSFER_REQUEST
                        SET TRN_PRIORITY = :WK_TRANSFER_PRIORITY
                        WHERE TRN_LINE_NO = :WK_TRANSFER_LINE;
                     END
                  END
               END
            END
            
         END            
         ELSE
         BEGIN
            /*
            qty exceeds recorder qty so cancel request
            need to remove / change status for 
            records with no qty that 
            were in the transfer request
            but now the qty is OK
            */
            UPDATE TRANSFER_REQUEST
            SET TRN_STATUS = 'CN'
            WHERE TO_WH_ID = :WK_WH_ID
            AND TO_LOCN_ID = :WK_LOCN
            AND PROD_ID = :WK_PROD
            AND TRN_STATUS = 'OP'
            AND QTY IS NULL;
         END
      END            
      ELSE
      BEGIN
         /*
         no qty in warehouse available 
         so  cancel request
         */
         UPDATE TRANSFER_REQUEST
         SET TRN_STATUS = 'CN',
         DEVICE_ID = NULL
         WHERE TO_WH_ID = :WK_WH_ID
         AND TO_LOCN_ID = :WK_LOCN
         AND PROD_ID = :WK_PROD
         AND TRN_STATUS IN ('OP','AL')
         AND QTY IS NULL;
      END
   END
   FOR  SELECT PROD_ID, WH_ID, LOCN_ID  
      FROM LOCATION
      WHERE REPLENISH = 'F'
      INTO :WK_PROD, 
           :WK_WH_ID, 
           :WK_LOCN 
   DO
   BEGIN
      UPDATE TRANSFER_REQUEST
      SET TRN_STATUS = 'CN',
      DEVICE_ID = NULL
      WHERE TO_WH_ID = :WK_WH_ID
      AND TO_LOCN_ID = :WK_LOCN
      AND PROD_ID = :WK_PROD
      AND TRN_STATUS IN ('OP','AL')
      AND QTY IS NULL;
   END
END ^

ALTER PROCEDURE GET_LENGTH (DATA_ID VARCHAR(20) CHARACTER SET NONE)
RETURNS (MAX_LENGTH INTEGER)
AS 
     
     
BEGIN

  SELECT MAX_LENGTH
  FROM PARAM
  WHERE DATA_ID = :DATA_ID
  INTO :MAX_LENGTH;
  
END ^

ALTER PROCEDURE GET_LOAD_NO RETURNS (LOAD_ID VARCHAR(10) CHARACTER SET NONE)
AS 
 
 

DECLARE VARIABLE iLoadNo INTEGER;
DECLARE VARIABLE iLengthLoadNo INTEGER;
DECLARE VARIABLE sLoadNo VARCHAR(10);
     
BEGIN
  iLoadNo = GEN_ID(LOAD_NO_GEN, 1) ;
  iLengthLoadNo = STRLEN(iLoadNo);
  
  /* Get Load Prefix from Control */
  /* sLoadNo = 'RPC'; */
  SELECT LOAD_PREFIX
  FROM CONTROL
  INTO :sLoadNo;  

  /* Padding leading with 0 */
  WHILE (iLengthLoadNo < 6) DO
  BEGIN
        sLoadNo = sLoadNo || '0';      
        iLengthLoadNo = iLengthLoadNo + 1;
  END
  sLoadNo = sLoadNo || iLoadNo;
  
  /* Return LoadNo to the caller */
  LOAD_ID = sLoadNo;
  SUSPEND;
  
END ^

ALTER PROCEDURE GET_LOAN_ID RETURNS (LOAN_ID INTEGER)
AS 
   
     
BEGIN
  LOAN_ID = GEN_ID(LOAN_NO_GEN, 1) ;  
END ^

ALTER PROCEDURE GET_LOAN_LINE_ID (LOAN_ORDER_NO INTEGER)
RETURNS (LOAN_ORDER_LINE_NO INTEGER)
AS 
  
 
  DECLARE VARIABLE LINE_NO INTEGER;  
BEGIN
  LINE_NO = 0; 

  /* Get the maximum number of line no */
  SELECT MAX(LOAN_ORDER_LINE_NO)
  FROM LOAN_ORDER_LINE
  WHERE LOAN_ORDER_NO = :LOAN_ORDER_NO  
  INTO :LINE_NO; 
  
  IF (:LINE_NO IS NULL) THEN LINE_NO = 0;

  /* Return the value of line no */
  LOAN_ORDER_LINE_NO = LINE_NO + 1;
  
END ^

ALTER PROCEDURE GET_NEXT_MESSAGE RETURNS (MESSAGE_ID VARCHAR(10) CHARACTER SET NONE)
AS 

BEGIN
     MESSAGE_ID = CAST(GEN_ID(MESSAGE_ID_GEN, 1) AS VARCHAR(10));
     SUSPEND;
END ^

ALTER PROCEDURE GET_NEXT_PUTAWAY RETURNS (PUTAWAY_ID VARCHAR(10) CHARACTER SET NONE)
AS 
 

BEGIN
     PUTAWAY_ID = CAST(GEN_ID(PUTAWAY_ID_GEN, 1) AS VARCHAR(10));
     SUSPEND;
END ^

ALTER PROCEDURE GET_NEXT_SSN RETURNS (SSN_ID VARCHAR(20) CHARACTER SET NONE)
AS 
 

  DECLARE VARIABLE REC_ID INTEGER;
  DECLARE VARIABLE WK_START INTEGER;
  DECLARE VARIABLE WK_ISSN_VALUE VARCHAR(20);
  DECLARE VARIABLE SSN_LENGTH INTEGER;

BEGIN
   /* Get Next SSN_ID */                                                                      
   REC_ID = GEN_ID(ISSN_SSN_ID, 1);
  
   WK_START = REC_ID - 1 ;
  
   /* Get length for Barcode */   
   EXECUTE PROCEDURE GET_BARCODE_LENGTH RETURNING_VALUES SSN_LENGTH;

   WK_ISSN_VALUE =  WK_START;
   WHILE (STRLEN(WK_ISSN_VALUE) < SSN_LENGTH) DO
   BEGIN
      WK_ISSN_VALUE = '0' || WK_ISSN_VALUE;
   END
   SSN_ID = WK_ISSN_VALUE;
   SUSPEND;

END ^

ALTER PROCEDURE GET_NUMERIC (WK_CODE VARCHAR(20) CHARACTER SET NONE)
RETURNS (WK_NEW_CODE VARCHAR(20) CHARACTER SET NONE)
AS 
 
 
DECLARE VARIABLE WK_CHAR CHAR(1);
DECLARE VARIABLE WK_FOUND INTEGER;
DECLARE VARIABLE WK_CNT INTEGER;
BEGIN
   WK_CNT = 1;
   WK_NEW_CODE = '';
   WHILE (WK_CNT <= LEN(WK_CODE)) DO
   BEGIN
      WK_CHAR = SUBSTR(WK_CODE, WK_CNT,WK_CNT);
      WK_CNT = WK_CNT + 1;
      IF ((WK_CHAR >= '0' AND WK_CHAR <= '9')) THEN
      BEGIN
         WK_NEW_CODE = WK_NEW_CODE || WK_CHAR;
      END
   END
   SUSPEND;
END ^

ALTER PROCEDURE GET_OBJECT_ID RETURNS (UNIQUEID INTEGER)
AS 
  
       
BEGIN
  UNIQUEID = gen_id(ObjectID_Gen,1) ;
  if (UNIQUEID = 10000000) then
  begin
    UNIQUEID = gen_id(ObjectID_Gen, -9999999) ;
  end
END ^

ALTER PROCEDURE GET_PICK_INVOICE_NO RETURNS (PICK_INVOICE_NO VARCHAR(10) CHARACTER SET NONE)
AS 
DECLARE VARIABLE WK_INVOICE_LENGTH INTEGER;
DECLARE VARIABLE WK_PICK_INVOICE_NO CHAR(10);
DECLARE VARIABLE WK_PICK_INVOICE_START INTEGER;
DECLARE VARIABLE WK_PICK_INVOICE_STOP INTEGER;
DECLARE VARIABLE WK_PICK_INVOICE_PREFIX INTEGER;
DECLARE VARIABLE WK_LEN_INVOICE_NO INTEGER;
DECLARE VARIABLE WK_PICK_ADJUSTMENT INTEGER;
     
BEGIN
   SELECT MAX_LENGTH FROM PARAM WHERE DATA_ID = 'INVOICE_NO' INTO :WK_INVOICE_LENGTH;
  IF (WK_INVOICE_LENGTH IS NULL) THEN
  BEGIN
     WK_INVOICE_LENGTH = 6;
  END
   WK_PICK_INVOICE_NO = GEN_ID(PICK_INVOICE_GEN, 1);
   WK_PICK_INVOICE_START = GEN_ID(PICK_INVOICE_START, 0);
   WK_PICK_INVOICE_STOP = GEN_ID(PICK_INVOICE_STOP, 0);
   WK_PICK_INVOICE_PREFIX = GEN_ID(PICK_INVOICE_PREFIX , 0);
   IF (WK_PICK_INVOICE_NO > WK_PICK_INVOICE_STOP) THEN
   BEGIN
      WK_PICK_ADJUSTMENT = WK_PICK_INVOICE_START - WK_PICK_INVOICE_STOP;
      WK_PICK_INVOICE_NO = GEN_ID(PICK_INVOICE_GEN, WK_PICK_ADJUSTMENT);
      WK_PICK_INVOICE_PREFIX = GEN_ID(PICK_INVOICE_PREFIX , 1);
      WK_PICK_INVOICE_NO = WK_PICK_INVOICE_START;
   END
   WK_LEN_INVOICE_NO = STRLEN(ALLTRIM(WK_PICK_INVOICE_NO)) + 1;     
   /* Get Label prefix */      
   PICK_INVOICE_NO = CHR(WK_PICK_INVOICE_PREFIX);
   /* Padding leading with 0 */
   WHILE (WK_LEN_INVOICE_NO < WK_INVOICE_LENGTH) DO
   BEGIN
      PICK_INVOICE_NO = PICK_INVOICE_NO || '0';      
      WK_LEN_INVOICE_NO = WK_LEN_INVOICE_NO + 1;
   END
   PICK_INVOICE_NO = PICK_INVOICE_NO || ALLTRIM(WK_PICK_INVOICE_NO);
END ^

ALTER PROCEDURE GET_PICK_LABEL_NO RETURNS (PICK_LABEL_NO VARCHAR(7) CHARACTER SET NONE)
AS 
   

DECLARE VARIABLE iLabelNo INTEGER;
DECLARE VARIABLE iLengthLabelNo INTEGER;
DECLARE VARIABLE sLabelNo VARCHAR(7);
     
BEGIN
  iLabelNo = GEN_ID(PICK_LABEL_GEN, 1) ;
  iLengthLabelNo = STRLEN(iLabelNo);
  
  sLabelNo = ''; /* Enter prefix number here */
  /* Padding leading with 0 */
  WHILE (iLengthLabelNo < 7) DO
  BEGIN
        sLabelNo = sLabelNo || '0';      
        iLengthLabelNo = iLengthLabelNo + 1;
  END
  sLabelNo = sLabelNo || iLabelNo;
  
  /* Return LoadNo to the caller */
  PICK_LABEL_NO = sLabelNo;
  
  
END ^

ALTER PROCEDURE GET_PO_LINE_NO (PURCHASE_ORDER VARCHAR(10) CHARACTER SET NONE)
RETURNS (PO_LINE INTEGER)
AS 
DECLARE VARIABLE WK_PURCHASE_ORDER VARCHAR(10);
DECLARE VARIABLE WK_LAST_LINE CHAR(4);
DECLARE VARIABLE WK_LAST_LINE_I INTEGER;
DECLARE VARIABLE WK_ORDER_CONNOTE VARCHAR(40);
DECLARE VARIABLE WK_CHECK_LINE INTEGER;
DECLARE VARIABLE WK_NEW_LINE INTEGER;
     
BEGIN
   /* must calc the line no to use for this order
         is the next line for this connote  */
   WK_PURCHASE_ORDER = PURCHASE_ORDER;
   WK_ORDER_CONNOTE = '';
   WK_LAST_LINE = '0';
   WK_CHECK_LINE = 0;
   SELECT PO_LEGACY_CONSIGNMENT 
   FROM PURCHASE_ORDER 
   WHERE PURCHASE_ORDER = :WK_PURCHASE_ORDER
   INTO :WK_ORDER_CONNOTE;
   IF (WK_ORDER_CONNOTE IS NULL) THEN
   BEGIN
      WK_ORDER_CONNOTE = '';
   END
   IF (WK_ORDER_CONNOTE = '') THEN
   BEGIN
      /* no connote so just use the po */
      SELECT MAX(PURCHASE_ORDER_LINE.PO_LINE),COUNT(*) 
      FROM PURCHASE_ORDER 
      JOIN PURCHASE_ORDER_LINE ON PURCHASE_ORDER_LINE.PURCHASE_ORDER = PURCHASE_ORDER.PURCHASE_ORDER 
      WHERE PURCHASE_ORDER.PURCHASE_ORDER = :WK_PURCHASE_ORDER
      INTO :WK_LAST_LINE, :WK_CHECK_LINE;
   END
   ELSE
   BEGIN
      SELECT MAX(PURCHASE_ORDER_LINE.PO_LINE),COUNT(*) 
      FROM PURCHASE_ORDER 
      JOIN PURCHASE_ORDER_LINE ON PURCHASE_ORDER_LINE.PURCHASE_ORDER = PURCHASE_ORDER.PURCHASE_ORDER 
      WHERE PURCHASE_ORDER.PO_LEGACY_CONSIGNMENT = :WK_ORDER_CONNOTE
      INTO :WK_LAST_LINE, :WK_CHECK_LINE;
   END
   IF (WK_LAST_LINE IS NULL) THEN
   BEGIN
      WK_LAST_LINE = '0';
   END
   IF (WK_CHECK_LINE IS NULL) THEN
   BEGIN
      WK_CHECK_LINE = 0;
   END
   WK_LAST_LINE_I = :WK_LAST_LINE;
   IF (WK_CHECK_LINE > WK_LAST_LINE_I) THEN
   BEGIN
      WK_LAST_LINE_I = WK_CHECK_LINE;
   END
   WK_NEW_LINE = WK_LAST_LINE_I + 1;
  
  PO_LINE  = WK_NEW_LINE;
  SUSPEND;
  
END ^

ALTER PROCEDURE GET_PO_ORDER_NO (ORDER_TYPE CHAR(2) CHARACTER SET NONE)
RETURNS (ORDER_ID VARCHAR(10) CHARACTER SET NONE)
AS 
DECLARE VARIABLE WK_PO VARCHAR(10);
DECLARE VARIABLE WK_PO_LENGTH INTEGER;
DECLARE VARIABLE WK_PO_ORDER VARCHAR(10);
DECLARE VARIABLE WK_ORDER_PREFIX VARCHAR(10);
DECLARE VARIABLE WK_PREFIX_LENGTH INTEGER;
DECLARE VARIABLE WK_ORDER_LENGTH INTEGER;
     
BEGIN
  WK_PO = GEN_ID(PURCHASE_ORDER_ID_GEN, 1) ;
  WK_PO_LENGTH = STRLEN(WK_PO);
  WK_ORDER_LENGTH = 10;
  /* get length from param */
  SELECT MAX_LENGTH
  FROM PARAM
  WHERE DATA_ID = 'PURCHASE'
  INTO :WK_ORDER_LENGTH;
  IF (WK_ORDER_LENGTH IS NULL) THEN
  BEGIN
     WK_ORDER_LENGTH = 10;
  END
  /* get prefix from where */
  IF (ORDER_TYPE IS NULL) THEN
  BEGIN
     WK_ORDER_PREFIX = NULL;
  END
  ELSE
  BEGIN
     WK_ORDER_PREFIX = SUBSTR(ORDER_TYPE,1,1);
  END
  
  IF (WK_ORDER_PREFIX IS NULL) THEN
  BEGIN
     WK_PO_ORDER = '';
  END
  ELSE
  BEGIN
     WK_PO_ORDER = WK_ORDER_PREFIX; /* Enter prefix number here */
  END
  WK_PREFIX_LENGTH = STRLEN(WK_PO_ORDER);
  WK_ORDER_LENGTH = WK_ORDER_LENGTH - WK_PREFIX_LENGTH;
  /* Padding leading with 0 */
  WHILE (WK_PO_LENGTH < WK_ORDER_LENGTH) DO
  BEGIN
        WK_PO_ORDER = WK_PO_ORDER || '0';      
        WK_PO_LENGTH = WK_PO_LENGTH + 1;
  END
  WK_PO_ORDER = WK_PO_ORDER || WK_PO;
  
  /* Return LoadNo to the caller */
  ORDER_ID = WK_PO_ORDER;
  SUSPEND;
  
  
END ^

ALTER PROCEDURE GET_QTY_LABEL (REFERENCE VARCHAR(40) CHARACTER SET NONE)
RETURNS (QTY_LABEL INTEGER)
AS 
                                    
 
DECLARE VARIABLE POS INTEGER; 
DECLARE VARIABLE S_TEMP VARCHAR(40);
DECLARE VARIABLE STR VARCHAR(40);
DECLARE VARIABLE X INTEGER;
DECLARE VARIABLE S_POS INTEGER;
DECLARE VARIABLE E_POS INTEGER;
 
BEGIN
  X = 0;  
  POS = 0;
  STR = '';  
  
  IF (STRLEN(:REFERENCE) = 0) THEN
  BEGIN     
     EXIT;
  END
  
  WHILE (POS <= STRLEN(:REFERENCE)) DO  
  BEGIN        
     S_TEMP = SUBSTR(:REFERENCE, POS, POS);     
     IF (S_TEMP = '|') THEN
     BEGIN
       X = X + 1;
       IF (X = 3) THEN
       BEGIN
         S_POS = POS+1;
       END
       IF (X = 4) THEN
       BEGIN
         E_POS = POS-1;
       END
     END   
     POS = POS + 1;
  END
  STR = SUBSTR(:REFERENCE, S_POS, E_POS);
  QTY_LABEL = CAST(STR AS INTEGER);
    
END ^

ALTER PROCEDURE GET_REFERENCE_FIELD (REFERENCE VARCHAR(256) CHARACTER SET NONE,
FIELD_NO INTEGER)
RETURNS (WK_FIELD_TEXT VARCHAR(256) CHARACTER SET NONE)
AS 
 
 
BEGIN
  
  IF (STRLEN(:REFERENCE) = 0) THEN
  BEGIN     
     EXIT;
  END
  
  WK_FIELD_TEXT = ALLTRIM(PARSE(REFERENCE, '|', FIELD_NO));
  IF (WK_FIELD_TEXT = 'Token to long in parse') THEN
  BEGIN
     WK_FIELD_TEXT = '';
  END
  SUSPEND;
END ^

ALTER PROCEDURE GET_REFERENCE_FIELD4 (REFERENCE VARCHAR(1024) CHARACTER SET NONE,
FIELD_NO INTEGER,
WK_DELIMITER CHAR(1) CHARACTER SET NONE)
RETURNS (WK_FIELD_TEXT VARCHAR(1024) CHARACTER SET NONE,
WK_AT_END CHAR(1) CHARACTER SET NONE)
AS 
 
 
 
BEGIN
  WK_FIELD_TEXT = '';
  WK_AT_END = 'F';
  
  IF (STRLEN(:REFERENCE) = 0) THEN
  BEGIN     
     EXIT;
  END
  WK_FIELD_TEXT = V4ALLTRIM(V4PARSE(REFERENCE, WK_DELIMITER, FIELD_NO));
  IF (WK_FIELD_TEXT = 'Token to long in parse') THEN
  BEGIN
     WK_FIELD_TEXT = '';
     WK_AT_END = 'T';
  END
  SUSPEND;
END ^

ALTER PROCEDURE GET_SALE_LINES_NO (PICK_ORDER VARCHAR(10) CHARACTER SET NONE)
RETURNS (PICK_ORDER_LINE_NO VARCHAR(4) CHARACTER SET NONE)
AS 
 

  DECLARE VARIABLE LINE_NO INTEGER; 
  DECLARE VARIABLE iLenPickLineNo INTEGER;
  DECLARE VARIABLE sPickLineNo VARCHAR(4);
BEGIN
  LINE_NO = 0;
  sPickLineNo = '';

  /* Get the maximum number of line no */
  SELECT LAST_LINE_NO + 1 AS LAST_LINE_NO
  FROM PICK_ITEM_LINE_NO
  WHERE PICK_ORDER = :PICK_ORDER  
  INTO :LINE_NO; 
  
  iLenPickLineNo = STRLEN(LINE_NO);
    
  /* Padding leading with 0 */
    WHILE (iLenPickLineNo < 4) DO
    BEGIN
       sPickLineNo = sPickLineNo || '0';      
       iLenPickLineNo = iLenPickLineNo + 1;
    END
    sPickLineNo = sPickLineNo || LINE_NO;       
    
    /* Return LoadNo to the caller */
   PICK_ORDER_LINE_NO = sPickLineNo;
   
   /* update last line no */
   UPDATE PICK_ITEM_LINE_NO
   SET LAST_LINE_NO = :LINE_NO
   WHERE PICK_ORDER = :PICK_ORDER; 
   SUSPEND;
END ^

ALTER PROCEDURE GET_SALE_LINE_NO (SALE_ORDER_ID VARCHAR(10) CHARACTER SET NONE)
RETURNS (SALE_ORDER_LINE_NO INTEGER)
AS 
   
 
  DECLARE VARIABLE LINE_NO INTEGER;  
BEGIN
  LINE_NO = 0; 

  /* Get the maximum number of line no */
  SELECT MAX(SALE_ORDER_LINE_NO)
  FROM SALE_ORDER_LINE
  WHERE SALE_ORDER_ID = :SALE_ORDER_ID  
  INTO :LINE_NO; 
  
  IF (:LINE_NO IS NULL) THEN LINE_NO = 0;

  /* Return the value of line no */
  SALE_ORDER_LINE_NO = LINE_NO + 1;
  
END ^

ALTER PROCEDURE GET_SALE_ORDER_NO (ORDER_PREFIX CHAR(1) CHARACTER SET NONE)
RETURNS (SALE_ORDER_ID VARCHAR(10) CHARACTER SET NONE)
AS 
DECLARE VARIABLE iSaleNo INTEGER;
DECLARE VARIABLE iLengthSaleNo INTEGER;
DECLARE VARIABLE WK_MAX_LENGTH INTEGER;
DECLARE VARIABLE sSaleNo VARCHAR(10);
     
BEGIN
  iSaleNo = GEN_ID(SALE_ORDER_ID_GEN, 1) ;
  iLengthSaleNo = STRLEN(iSaleNo);
  
  /*
  sSaleNo = 'S'; /- Enter prefix number here -/
  */
  IF (ORDER_PREFIX IS NULL) THEN
  BEGIN
     sSaleNo = '';
  END
  ELSE
  BEGIN
     sSaleNo = ORDER_PREFIX; /* Enter prefix number here */
  END
  SELECT MAX_LENGTH FROM PARAM WHERE DATA_ID = 'SALESORDER' INTO :WK_MAX_LENGTH;
  WK_MAX_LENGTH = WK_MAX_LENGTH - STRLEN(sSaleNo);
  /* Padding leading with 0 */
  /* WHILE (iLengthSaleNo < 9) DO */
  WHILE (iLengthSaleNo < :WK_MAX_LENGTH) DO
  BEGIN
        sSaleNo = sSaleNo || '0';      
        iLengthSaleNo = iLengthSaleNo + 1;
  END
  sSaleNo = sSaleNo || iSaleNo;
  
  /* Return LoadNo to the caller */
  SALE_ORDER_ID = sSaleNo;
  SUSPEND;
  
  
END ^

ALTER PROCEDURE GET_TABLE_DATA (IN_TABLE VARCHAR(40) CHARACTER SET NONE,
IN_FIELD_DELIMITER CHAR(1) CHARACTER SET NONE,
IN_DATA_DELIMITER CHAR(1) CHARACTER SET NONE,
IN_WHERE VARCHAR(100) CHARACTER SET NONE)
RETURNS (OUT_DATA VARCHAR(32000) CHARACTER SET NONE)
AS 
DECLARE VARIABLE WK_FIELD_NAME VARCHAR(31);
  DECLARE VARIABLE WK_FIELD_TYPE INTEGER;
  DECLARE VARIABLE WK_FIELD_SUB_TYPE INTEGER;
  DECLARE VARIABLE WK_FIELD_DATA VARCHAR(1024);  
  DECLARE VARIABLE WK_STMT VARCHAR(1024);  
  
BEGIN 
  
   OUT_DATA = '';
   FOR SELECT REL_FIELD.RDB$FIELD_NAME,
       RDB$FIELD_TYPE,
       RDB$FIELD_SUB_TYPE
    FROM RDB$RELATIONS REL
       JOIN RDB$RELATION_FIELDS REL_FIELD 
            ON REL_FIELD.RDB$RELATION_NAME=REL.RDB$RELATION_NAME
       JOIN RDB$FIELDS FIELD
            ON REL_FIELD.RDB$FIELD_SOURCE=FIELD.RDB$FIELD_NAME
    WHERE REL.RDB$RELATION_NAME=:IN_TABLE
    ORDER BY REL_FIELD.RDB$FIELD_POSITION,REL_FIELD.RDB$FIELD_NAME 
    INTO :WK_FIELD_NAME,
         :WK_FIELD_TYPE,
         :WK_FIELD_SUB_TYPE
    DO
    BEGIN
       IF (WK_FIELD_TYPE <> 261) THEN
       BEGIN
          WK_FIELD_NAME = RTRIM(WK_FIELD_NAME);
          WK_STMT = 'SELECT ' || WK_FIELD_NAME || ' FROM ' || IN_TABLE || ' ' || IN_WHERE;
          EXECUTE STATEMENT WK_STMT INTO :WK_FIELD_DATA;
          IF (WK_FIELD_DATA IS NULL) THEN
          BEGIN
             WK_FIELD_DATA = '';
          END
          OUT_DATA = OUT_DATA || IN_FIELD_DELIMITER || IN_TABLE || '.' || WK_FIELD_NAME || IN_FIELD_DELIMITER || '=' || :WK_FIELD_DATA || IN_DATA_DELIMITER ;
       END
    END
    SUSPEND;
  
END ^

ALTER PROCEDURE GET_TRANSACTION_ID RETURNS (TRANSID INTEGER)
AS 
 
 
  
   
BEGIN
  TransID = gen_id(Transaction_ID,1) ;
END ^

ALTER PROCEDURE LOCATION_CALC_PRODUCT (WH_ID CHAR(2) CHARACTER SET NONE)
AS 
 
 

DECLARE VARIABLE WK_LOCN_ID VARCHAR(10);
DECLARE VARIABLE IMPORTSTATUS VARCHAR(40);
DECLARE VARIABLE WK_WH_ID CHAR(2);
DECLARE VARIABLE WK_PROD VARCHAR(30);
BEGIN
/*
have a procedure toset the prod_id
for a location

*/
   UPDATE LOCATION SET PROD_ID = NULL
   WHERE WH_ID = :WH_ID
   AND LOCN_ID STARTING 'PM';
   
   FOR SELECT LOCN_ID
   FROM LOCATION 
   WHERE WH_ID = :WH_ID
   AND LOCN_ID STARTING 'PM'
   AND REPLENISH='T' AND MIN_QTY IS NOT NULL
   INTO :WK_LOCN_ID
   DO
   BEGIN
      WK_PROD = '';
      SELECT FIRST 1 PROD_ID
      FROM ISSN
      WHERE WH_ID = :WH_ID
      AND LOCN_ID = :WK_LOCN_ID
      AND PROD_ID IS NOT NULL
      AND CURRENT_QTY > 0
      INTO :WK_PROD;
      IF (WK_PROD IS NULL) THEN
      BEGIN
         WK_PROD = '';
      END
      IF (WK_PROD > '') THEN
      BEGIN
         UPDATE LOCATION SET PROD_ID = :WK_PROD
         WHERE WH_ID = :WH_ID
         AND LOCN_ID = :WK_LOCN_ID;
         UPDATE PICK_ITEM
         SET WH_ID = :WH_ID,
         PICK_LOCATION = :WK_LOCN_ID,
         OVER_SIZED = 'F'
         WHERE PROD_ID = :WK_PROD
         AND PICK_ORDER STARTING '201';
      END
   END 
END ^

ALTER PROCEDURE LOCN_STATISTICS (IN_WH_ID CHAR(2) CHARACTER SET NONE,
IN_LOCN_ID VARCHAR(20) CHARACTER SET NONE,
IN_OVERALL_WEIGHT CHAR(1) CHARACTER SET NONE,
IN_TARE_WEIGHT CHAR(1) CHARACTER SET NONE,
IN_MOBILE_WEIGHT CHAR(1) CHARACTER SET NONE,
IN_SSN_WEIGHT CHAR(1) CHARACTER SET NONE,
IN_PROD_WEIGHT CHAR(1) CHARACTER SET NONE,
IN_ISSUES CHAR(1) CHARACTER SET NONE)
RETURNS (WK_WT_OVERALL NUMERIC(15, 3),
WK_WT_TARE NUMERIC(15, 3),
WK_WT_MOBILE NUMERIC(15, 3),
WK_WT_SSN NUMERIC(15, 3),
WK_WT_PROD NUMERIC(15, 3),
WK_ISSUE_PROD INTEGER)
AS 
DECLARE VARIABLE WK_WH_ID CHAR(2);
DECLARE VARIABLE WK_SSN_ID VARCHAR(20);
DECLARE VARIABLE WK_LOCN_ID VARCHAR(10);
DECLARE VARIABLE WK_PROD_TYPE VARCHAR(40);
DECLARE VARIABLE WK_STATUS CHAR(2);
DECLARE VARIABLE WK_PROD VARCHAR(30);
DECLARE VARIABLE WK_STD_WT_UOM CHAR(2);
DECLARE VARIABLE WK_TARE_WEIGHT DOUBLE PRECISION;
DECLARE VARIABLE WK_TARE_WEIGHT_UOM CHAR(2);
DECLARE VARIABLE WK_TO_STD_CONV DOUBLE PRECISION;
DECLARE VARIABLE WK_SSN_WEIGHT DOUBLE PRECISION;
DECLARE VARIABLE WK_PROD_WEIGHT DOUBLE PRECISION;
DECLARE VARIABLE WK_TARE_WT DOUBLE PRECISION;
DECLARE VARIABLE WK_MOBILE_WT DOUBLE PRECISION;
DECLARE VARIABLE WK_SSN_WT DOUBLE PRECISION;
DECLARE VARIABLE WK_PROD_WT DOUBLE PRECISION;
DECLARE VARIABLE WK_WT_STD_TARE DOUBLE PRECISION;
DECLARE VARIABLE WK_WT_STD_SSN DOUBLE PRECISION;
DECLARE VARIABLE WK_WT_STD_PROD DOUBLE PRECISION;
DECLARE VARIABLE WK_WT_FROM_KG DOUBLE PRECISION;
DECLARE VARIABLE WK_REC_ID INTEGER;
DECLARE VARIABLE WK_MOBILE_DONE INTEGER;
DECLARE VARIABLE WK_PREV_WH_ID CHAR(2);
DECLARE VARIABLE WK_PREV_LOCN_ID VARCHAR(10);
DECLARE VARIABLE WK_CURRENT_WH_ID CHAR(2);
DECLARE VARIABLE WK_CURRENT_LOCN_ID VARCHAR(10);
DECLARE VARIABLE WK_CURRENT_QTY INTEGER;
DECLARE VARIABLE WK_LOCN_TYPE VARCHAR(30);
DECLARE VARIABLE WK_CNT INTEGER;
DECLARE VARIABLE WK_FOUND INTEGER;
DECLARE VARIABLE WK_LOG_FILENAME VARCHAR(70);
DECLARE VARIABLE WK_RESULT INTEGER;

BEGIN    
    
/*
input locn_id as locn_id or a like clause

want  tare weights of locations involved

moveable locations

ssn's

(issn's - this must be zero since no issn's have weights)

prod_id's

overall weight

# issue units for prods

now since all reported weights are in kg's
	want to use the uom weight conversion table

*/

   WK_LOG_FILENAME = '/tmp/locnstat.log';
   /* what is std WT uom */
   SELECT STANDARD_UOM FROM UOM_TYPE WHERE CODE = 'WT' INTO :WK_STD_WT_UOM;
   /* what is conv from std to KG */
   SELECT TO_STANDARD_CONV FROM UOM WHERE CODE = 'KG' AND UOM_TYPE = 'WT' INTO :WK_WT_FROM_KG;

   WK_TARE_WT = 0;
   WK_MOBILE_WT = 0;
   WK_SSN_WT = 0;
   WK_PROD_WT = 0;
   WK_CNT = 0;
   WK_REC_ID = GEN_ID(TRANSACTION_ID, 1);    
   DELETE FROM TRANSACTIONS_WORK WHERE RECORD_ID = :WK_REC_ID;
   FOR SELECT LOCATION.WH_ID, LOCATION.LOCN_ID, LOCATION.LOCN_TARE_WEIGHT, LOCATION.LOCN_TARE_WEIGHT_UOM, UOM.TO_STANDARD_CONV
   FROM LOCATION 
   LEFT OUTER JOIN UOM ON LOCATION.LOCN_TARE_WEIGHT_UOM = UOM.CODE
   WHERE WH_ID = :IN_WH_ID AND LOCN_ID LIKE :IN_LOCN_ID
   INTO :WK_WH_ID, :WK_LOCN_ID, :WK_TARE_WEIGHT, :WK_TARE_WEIGHT_UOM, :WK_TO_STD_CONV
   DO
   BEGIN
      IF (WK_TO_STD_CONV IS NULL) THEN
      BEGIN
         WK_TO_STD_CONV = 1;
      END
      IF (WK_TARE_WEIGHT IS NULL) THEN
      BEGIN
         WK_TARE_WEIGHT  = 0;
      END
      /* does the location already exist */
      WK_FOUND = 0;
      SELECT 1 FROM TRANSACTIONS_WORK
      WHERE RECORD_ID = :WK_REC_ID
      AND LOCN_ID = :WK_LOCN_ID 
      INTO :WK_FOUND;
      IF (WK_FOUND = 0) THEN
      BEGIN
         INSERT INTO TRANSACTIONS_WORK (RECORD_ID, WH_ID, LOCN_ID, OBJECT, SUB_LOCN_ID, QTY) VALUES (:WK_REC_ID, :WK_WH_ID, :WK_LOCN_ID, 'P', 'PO', :WK_CNT);
         /* then in standard units */
         WK_WT_STD_TARE = WK_TARE_WEIGHT * WK_TO_STD_CONV;
         WK_TARE_WT = WK_TARE_WT + (WK_WT_STD_TARE / WK_WT_FROM_KG);
      END
      WK_CNT = WK_CNT + 1;
      /* now get mobile locations in there */
      IF (IN_MOBILE_WEIGHT = 'T') THEN
      BEGIN
         WK_MOBILE_DONE = 1;
      END
      ELSE
      BEGIN
         /* do not check mobile locations */
         WK_MOBILE_DONE = 0;
      END
      WK_PREV_WH_ID =  WK_WH_ID;
      WK_PREV_LOCN_ID =  WK_LOCN_ID;
      WHILE (WK_MOBILE_DONE = 1) DO
      BEGIN
         FOR SELECT WH_ID, LOCN_ID 
             FROM LOCATION 
             WHERE PARENT_LOCN_ID = :WK_PREV_LOCN_ID
             AND CURRENT_WH_ID = :WK_PREV_WH_ID
             INTO :WK_CURRENT_WH_ID ,:WK_CURRENT_LOCN_ID
         DO
         BEGIN
            /* include this location */
            /* does the location already exist */
            WK_FOUND = 0;
            SELECT 1 FROM TRANSACTIONS_WORK
            WHERE RECORD_ID = :WK_REC_ID
            AND LOCN_ID = :WK_CURRENT_LOCN_ID 
            INTO :WK_FOUND;
            IF (WK_FOUND = 0) THEN
            BEGIN
               INSERT INTO TRANSACTIONS_WORK (RECORD_ID, WH_ID, LOCN_ID, OBJECT, SUB_LOCN_ID, QTY) VALUES (:WK_REC_ID, :WK_CURRENT_WH_ID, :WK_CURRENT_LOCN_ID, 'M', 'OK', :WK_CNT);
               FOR SELECT LOCATION.LOCN_TARE_WEIGHT, LOCATION.LOCN_TARE_WEIGHT_UOM, UOM.TO_STANDARD_CONV
                   FROM LOCATION 
                   LEFT OUTER JOIN UOM ON LOCATION.LOCN_TARE_WEIGHT_UOM = UOM.CODE
                   WHERE WH_ID = :WK_CURRENT_WH_ID AND LOCN_ID = :WK_CURRENT_LOCN_ID
                   INTO :WK_TARE_WEIGHT, :WK_TARE_WEIGHT_UOM, :WK_TO_STD_CONV
               DO
               BEGIN
                  IF (WK_TO_STD_CONV IS NULL) THEN
                  BEGIN
                     WK_TO_STD_CONV = 1;
                  END
                  IF (WK_TARE_WEIGHT IS NULL) THEN
                  BEGIN
                     WK_TARE_WEIGHT  = 0;
                  END
                  /* then in standard units */
                  WK_WT_STD_TARE = WK_TARE_WEIGHT * WK_TO_STD_CONV;
                  /* WK_TARE_WT = WK_TARE_WT + (WK_WT_STD_TARE / WK_WT_FROM_KG); */
                  /* tare weight is in the mobile wt field for mobiles */
                  WK_MOBILE_WT = WK_MOBILE_WT + (WK_WT_STD_TARE / WK_WT_FROM_KG);
               END
            END
            ELSE
            BEGIN
               UPDATE TRANSACTIONS_WORK SET SUB_LOCN_ID = 'OK'
               WHERE RECORD_ID = :WK_REC_ID
               AND LOCN_ID = :WK_CURRENT_LOCN_ID
               AND SUB_LOCN_ID = 'PO';
            END
            WK_CNT = WK_CNT + 1;
         END
         /* change the prev locn to next in list   */
         WK_FOUND = 0;
         SELECT FIRST 1 1, LOCN_ID FROM TRANSACTIONS_WORK 
         WHERE RECORD_ID = :WK_REC_ID
         AND SUB_LOCN_ID = 'OK'
         INTO :WK_FOUND, :WK_PREV_LOCN_ID;
         /* if no more then  mobile done = 0 */
         IF (WK_FOUND IS NULL) THEN
         BEGIN
            WK_FOUND = 0;
         END
         IF (WK_FOUND = 0) THEN
         BEGIN
            WK_PREV_LOCN_ID = NULL;
         END
         IF (WK_PREV_LOCN_ID IS NULL) THEN 
         BEGIN
            WK_MOBILE_DONE = 0;
         END
         ELSE
         BEGIN
            UPDATE TRANSACTIONS_WORK SET SUB_LOCN_ID = 'PM'
            WHERE RECORD_ID = :WK_REC_ID
            AND LOCN_ID = :WK_PREV_LOCN_ID
            AND SUB_LOCN_ID = 'OK';
         END
      END
   END

   /* now get issns in the locations */
   FOR SELECT WH_ID, LOCN_ID , OBJECT
       FROM TRANSACTIONS_WORK
       WHERE RECORD_ID = :WK_REC_ID
       INTO :WK_WH_ID, :WK_LOCN_ID, :WK_LOCN_TYPE
   DO
   BEGIN
      /* now get ssns in the locations */
      FOR SELECT SSN.NET_WEIGHT, UOM.TO_STANDARD_CONV, ISSN.CURRENT_QTY
          FROM ISSN 
          JOIN SSN ON SSN.SSN_ID = ISSN.ORIGINAL_SSN
          LEFT OUTER JOIN UOM ON SSN.NET_WEIGHT_UOM = UOM.CODE
          WHERE ISSN.WH_ID = :WK_WH_ID AND ISSN.LOCN_ID = :WK_LOCN_ID
          AND ISSN.CURRENT_QTY > 0
          AND (ISSN.PROD_ID IS NULL)
          INTO :WK_SSN_WEIGHT, :WK_TO_STD_CONV, :WK_CURRENT_QTY
      DO
      BEGIN
         IF (WK_TO_STD_CONV IS NULL) THEN
         BEGIN
            WK_TO_STD_CONV = 1;
         END
         IF (WK_SSN_WEIGHT IS NULL) THEN
         BEGIN
            WK_SSN_WEIGHT  = 0;
         END
         IF (WK_CURRENT_QTY IS NULL) THEN
         BEGIN
            WK_CURRENT_QTY  = 1;
         END
         /* then in standard units */
         WK_WT_STD_SSN = WK_SSN_WEIGHT * WK_TO_STD_CONV;
         WK_SSN_WT = WK_SSN_WT + WK_CURRENT_QTY *  (WK_WT_STD_SSN / WK_WT_FROM_KG);
      END
      /* now get products in the locations */
      FOR SELECT PROD_PROFILE.NET_WEIGHT, UOM.TO_STANDARD_CONV, ISSN.CURRENT_QTY
          FROM ISSN 
          JOIN PROD_PROFILE ON ISSN.PROD_ID = PROD_PROFILE.PROD_ID
          LEFT OUTER JOIN UOM ON PROD_PROFILE.NET_WEIGHT_UOM = UOM.CODE
          WHERE ISSN.WH_ID = :WK_WH_ID AND ISSN.LOCN_ID = :WK_LOCN_ID
          AND ISSN.CURRENT_QTY > 0
          AND (ISSN.PROD_ID IS NOT NULL)
          INTO :WK_PROD_WEIGHT, :WK_TO_STD_CONV, :WK_CURRENT_QTY
      DO
      BEGIN
         IF (WK_TO_STD_CONV IS NULL) THEN
         BEGIN
            WK_TO_STD_CONV = 1;
         END
         IF (WK_PROD_WEIGHT IS NULL) THEN
         BEGIN
            WK_PROD_WEIGHT  = 0;
         END
         IF (WK_CURRENT_QTY IS NULL) THEN
         BEGIN
            WK_CURRENT_QTY  = 1;
         END
         /* then in standard units */
         WK_WT_STD_PROD = WK_PROD_WEIGHT * WK_TO_STD_CONV;
         WK_PROD_WT = WK_PROD_WT + WK_CURRENT_QTY *  (WK_WT_STD_PROD / WK_WT_FROM_KG);
      END
   END

   IF (IN_TARE_WEIGHT = 'T') THEN
   BEGIN
      WK_WT_TARE = WK_TARE_WT;
   END
   ELSE
   BEGIN
      WK_WT_TARE = 0;
   END

   IF (IN_MOBILE_WEIGHT = 'T') THEN
   BEGIN
      WK_WT_MOBILE = WK_MOBILE_WT;
   END
   ELSE
   BEGIN
      WK_WT_MOBILE = 0;
   END

   IF (IN_SSN_WEIGHT = 'T') THEN
   BEGIN
      WK_WT_SSN = WK_SSN_WT;
   END
   ELSE
   BEGIN
      WK_WT_SSN = 0;
   END

   IF (IN_PROD_WEIGHT = 'T') THEN
   BEGIN
      WK_WT_PROD = WK_PROD_WT;
   END
   ELSE
   BEGIN
      WK_WT_PROD = 0;
   END

   IF (IN_OVERALL_WEIGHT = 'T') THEN
   BEGIN
      WK_WT_OVERALL = WK_WT_TARE + WK_WT_MOBILE +  WK_WT_SSN + WK_WT_PROD;
   END
   ELSE
   BEGIN
      WK_WT_OVERALL = 0;
   END
   SUSPEND;
END ^

ALTER PROCEDURE LOGIN_DEVICE (IP_ADDRESS VARCHAR(40) CHARACTER SET NONE,
COMPUTER_NAME VARCHAR(50) CHARACTER SET NONE,
USER_ID VARCHAR(10) CHARACTER SET NONE)
RETURNS (DEVICE_ID CHAR(2) CHARACTER SET NONE,
LG_STATUS INTEGER,
LG_MESSAGE VARCHAR(80) CHARACTER SET NONE)
AS 
 
 
 
 
DECLARE VARIABLE WK_USER VARCHAR(10);
DECLARE VARIABLE WK_FOUND INTEGER;
DECLARE VARIABLE WK_IP VARCHAR(40);
DECLARE VARIABLE WK_NAME VARCHAR(50);
DECLARE VARIABLE WK_LICENSE VARCHAR(40);
DECLARE VARIABLE WK_LOGIN INTEGER;

BEGIN
        
    /* Update Pick Item Status */
    LG_STATUS = -1;
    WK_FOUND = -1;
    LG_MESSAGE = '';
    DEVICE_ID = NULL;
    /* try the passed ip */
    IF (IP_ADDRESS IS NULL) THEN
    BEGIN
        WK_IP = '';
    END
    ELSE
    BEGIN
        WK_IP = IP_ADDRESS;
    END
    IF (WK_IP > '') THEN
    BEGIN
        FOR SELECT FIRST 1  DEVICE_ID
        FROM SYS_EQUIP
        WHERE IP_ADDRESS = :WK_IP
          AND DEVICE_TYPE IN ('HH','PC')
        INTO :DEVICE_ID
        DO
        BEGIN
            LG_STATUS = 1;
        END
    END
    ELSE
    BEGIN
        LG_MESSAGE = LG_MESSAGE || 'No IP Address Supplied';
    END

    IF (LG_STATUS < 0) THEN
    BEGIN
        /* no ip found */
        /* try the passed name */
        IF (COMPUTER_NAME IS NULL) THEN
        BEGIN
            WK_NAME = '';
        END
        ELSE
        BEGIN
            WK_NAME = COMPUTER_NAME;
        END
        IF (WK_NAME > '') THEN
        BEGIN
            FOR SELECT FIRST 1  DEVICE_ID
            FROM SYS_EQUIP
            WHERE COMPUTER_NAME = :WK_NAME
              AND DEVICE_TYPE IN ('HH','PC')
            INTO :DEVICE_ID
            DO
            BEGIN
                LG_STATUS = 10;
            END
        END
    END

    IF (LG_STATUS < 0) THEN
    BEGIN
        /* no name found */
        /* try using dhcp */
        IF (WK_IP > '') THEN
        BEGIN
            FOR SELECT FIRST 1  DEVICE_ID
            FROM SYS_EQUIP
            WHERE IP_ADDRESS = 'DHCP'
              AND DEVICE_TYPE IN ('HH','PC')
              AND CURRENT_PERSON IS NULL
              AND CURRENT_LOGGED_ON IS NULL
            INTO :DEVICE_ID
            DO
            BEGIN
                LG_STATUS = 20;
            END
        END
    END
   
    IF (LG_STATUS < 0) THEN
    BEGIN
        /* no device available */
        LG_MESSAGE = LG_MESSAGE || '- No Free Devices Available';
    END
    ELSE
    BEGIN
        /* have a device check user */

        IF (USER_ID IS NULL) THEN
        BEGIN
            WK_USER = '';
        END
        ELSE
        BEGIN
            WK_USER = USER_ID;
        END
        IF (WK_USER IS NULL) THEN
        BEGIN
            LG_MESSAGE = '- No User Supplied - Cannot LogIn'; 
            LG_STATUS = -10;
        END
        ELSE
        BEGIN
            SELECT 1 FROM SYS_USER WHERE USER_ID = :WK_USER INTO :WK_FOUND;
            IF (WK_FOUND = 1) THEN
            BEGIN     
                SELECT COUNT(*) FROM SYS_EQUIP
                WHERE
                    DEVICE_TYPE IN ('HH','PC')
                    AND (NOT(CURRENT_PERSON IS NULL)
                         OR NOT(CURRENT_LOGGED_ON IS NULL))
                    INTO :WK_FOUND;
                IF (WK_FOUND IS NULL) THEN
                BEGIN
                    WK_FOUND = 0;
                END
                SELECT LICENSE_NO FROM CONTROL INTO :WK_LICENSE;
                WK_LOGIN = CHECK_LOGIN( WK_FOUND, WK_LICENSE);
                IF (WK_LOGIN  > 0) THEN
                BEGIN
                    /* update - login user */
                    UPDATE SYS_EQUIP SET CURRENT_PERSON = :WK_USER, CURRENT_LOGGED_ON = 'NOW' ,LAST_PERSON = :WK_USER
                    WHERE DEVICE_ID = :DEVICE_ID;
                    UPDATE SYS_USER SET DEVICE_ID = :DEVICE_ID, LOGIN_DATE = 'NOW'
                    WHERE USER_ID = :WK_USER;
                    LG_MESSAGE = 'Logged Into Device ' || :DEVICE_ID || ' by ' || :WK_USER;
                END
                ELSE
                BEGIN
                    IF (WK_LOGIN = -20) THEN
                    BEGIN
                        LG_MESSAGE = 'Too Many Logged In to Allow Login';
                        LG_STATUS = -20;
                    END                  
                    ELSE
                    BEGIN
                        LG_MESSAGE = 'Invalid License Code';
                        LG_STATUS = -30;
                    END                  
                END
            END
            ELSE
            BEGIN
                LG_MESSAGE = '- No User Supplied - Cannot LogIn'; 
                LG_STATUS = -10;
            END
        END
    END

    SUSPEND;
END ^

ALTER PROCEDURE LOGOUT_DEVICE (DEVICE_ID CHAR(2) CHARACTER SET NONE)
RETURNS (LG_STATUS INTEGER,
LG_MESSAGE VARCHAR(50) CHARACTER SET NONE)
AS 
DECLARE VARIABLE WK_USER VARCHAR(10);
DECLARE VARIABLE WK_FOUND INTEGER;
DECLARE VARIABLE WK_DEVICE VARCHAR(2);
DECLARE VARIABLE WK_BUFFER VARCHAR(280);
DECLARE VARIABLE WK_DATE   VARCHAR(26);

BEGIN
        
    /* Update Pick Item Status */
    LG_STATUS = -1;
    WK_FOUND = -1;
    LG_MESSAGE = '';
    IF (DEVICE_ID IS NULL) THEN
    BEGIN
       WK_DEVICE = '';
    END
    ELSE
    BEGIN
       WK_DEVICE = DEVICE_ID;
    END
    WK_BUFFER = 'LOGIN:attempt Logout device ' || :WK_DEVICE;
    SELECT 1, CURRENT_PERSON 
    FROM SYS_EQUIP
    WHERE DEVICE_ID = :DEVICE_ID
    INTO :WK_FOUND, :WK_USER;
    IF (WK_FOUND = 1) THEN
    BEGIN
       IF (WK_USER IS NULL) THEN
       BEGIN
          WK_BUFFER = WK_BUFFER ||  ' No User logged in on device';
          LG_MESSAGE = 'No User Logged in on Device - Cannot LG'; 
       END
       ELSE
       BEGIN
          WK_BUFFER = 'LOGIN:Logout device ' || :WK_DEVICE;
          WK_BUFFER = WK_BUFFER ||  ' User ' || :WK_USER;
          UPDATE SYS_EQUIP SET CURRENT_PERSON = NULL, CURRENT_LOGGED_ON = NULL 
          WHERE DEVICE_ID = :DEVICE_ID;
          UPDATE SYS_USER SET DEVICE_ID = NULL, LOGIN_DATE = NULL 
          WHERE USER_ID = :WK_USER;
          LG_MESSAGE = 'Logged Out From Device ' || :DEVICE_ID || ' by ' || :WK_USER;
          LG_STATUS = 0;
       END
    END
    ELSE
    BEGIN
       WK_BUFFER = WK_BUFFER ||  ' No Device';
       LG_MESSAGE = 'Device Not Found - Cannot LG'; 
    END
    WK_DATE = CAST(CAST('NOW' AS TIMESTAMP) AS CHAR(24));
    WK_BUFFER = WK_BUFFER || WK_DATE;
    INSERT INTO LOG(DESCRIPTION) VALUES( :WK_BUFFER);

    SUSPEND;
END ^

ALTER PROCEDURE MANIFEST_DATA (CONNOTE VARCHAR(20) CHARACTER SET NONE,
DO_CONSOLIDATION CHAR(1) CHARACTER SET NONE,
ORDER_TYPE CHAR(2) CHARACTER SET NONE)
RETURNS (PICK_ORDER VARCHAR(15) CHARACTER SET NONE,
WH_ID CHAR(2) CHARACTER SET NONE,
PICK_LOCATION VARCHAR(10) CHARACTER SET NONE,
AWB_CONSIGNMENT_NO VARCHAR(20) CHARACTER SET NONE,
PICKED_QTY INTEGER,
PICK_ORDER_QTY INTEGER,
PICKD_POST_CODE VARCHAR(10) CHARACTER SET NONE,
PICKD_SUBURB VARCHAR(50) CHARACTER SET NONE,
P_FIRST_NAME VARCHAR(50) CHARACTER SET NONE,
P_ADDRESS_LINE1 VARCHAR(100) CHARACTER SET NONE,
P_LAST_NAME VARCHAR(50) CHARACTER SET NONE,
P_ADDRESS_LINE2 VARCHAR(50) CHARACTER SET NONE,
P_CITY VARCHAR(25) CHARACTER SET NONE,
P_STATE VARCHAR(15) CHARACTER SET NONE,
P_POST_CODE VARCHAR(10) CHARACTER SET NONE,
P_COUNTRY VARCHAR(25) CHARACTER SET NONE,
P_PHONE VARCHAR(30) CHARACTER SET NONE,
SHIP_VIA VARCHAR(10) CHARACTER SET NONE,
CREATED_BY VARCHAR(10) CHARACTER SET NONE,
CREATE_DATE TIMESTAMP,
PICK_ORDER_TYPE CHAR(2) CHARACTER SET NONE,
PICK_ORDER_LINE_NO CHAR(4) CHARACTER SET NONE,
SSN_ID VARCHAR(20) CHARACTER SET NONE,
WARRANTY_TERM VARCHAR(50) CHARACTER SET NONE,
SPECIAL_INSTRUCTIONS1 VARCHAR(8196) CHARACTER SET NONE,
SPECIAL_INSTRUCTIONS2 VARCHAR(255) CHARACTER SET NONE,
INV_WITH_GOODS CHAR(1) CHARACTER SET NONE,
CUSTOMER_PO_WO VARCHAR(20) CHARACTER SET NONE,
PROD_ID VARCHAR(30) CHARACTER SET NONE,
SHORT_DESC VARCHAR(50) CHARACTER SET NONE,
SSN_DESCRIPTION VARCHAR(80) CHARACTER SET NONE,
LEGACY_ID VARCHAR(20) CHARACTER SET NONE,
CONTACT_NAME VARCHAR(50) CHARACTER SET NONE,
P_ADDRESS_LINE3 VARCHAR(50) CHARACTER SET NONE,
P_ADDRESS_LINE4 VARCHAR(50) CHARACTER SET NONE,
P_TITLE VARCHAR(10) CHARACTER SET NONE,
P_AUST_POST_4STATE_ID VARCHAR(255) CHARACTER SET NONE,
P_ADDRESS_LINE5 VARCHAR(50) CHARACTER SET NONE)
AS 
/* DECLARE VARIABLE P_ADDRESS_LINE5 VARCHAR(50); */

BEGIN
   IF (DO_CONSOLIDATION = 'T') THEN
   BEGIN
      FOR SELECT PICK_ITEM.PICK_ORDER,
      PICK_ITEM.WH_ID,
      PICK_ITEM.PICK_LOCATION,
      PICK_DESPATCH.AWB_CONSIGNMENT_NO,
      PICK_ITEM.PICKED_QTY,
      PICK_ITEM.PICK_ORDER_QTY,
      PICK_DESPATCH.PICKD_POST_CODE,
      PICK_DESPATCH.PICKD_SUBURB,
      PICK_ORDER.P_FIRST_NAME,
      PICK_ORDER.P_ADDRESS_LINE1,
      PICK_ORDER.P_LAST_NAME,
      PICK_ORDER.P_ADDRESS_LINE2,
      PICK_ORDER.P_CITY,
      PICK_ORDER.P_STATE,
      PICK_ORDER.P_POST_CODE,
      PICK_ORDER.P_COUNTRY,
      PICK_ORDER.P_PHONE,
      PICK_ORDER.SHIP_VIA,
      PICK_ORDER.CREATED_BY,
      PICK_ORDER.CREATE_DATE,
      PICK_ORDER.PICK_ORDER_TYPE,
      PICK_ITEM.PICK_ORDER_LINE_NO,
      PICK_ITEM.SSN_ID,
      PICK_ITEM.WARRANTY_TERM,
      PICK_ORDER.SPECIAL_INSTRUCTIONS1,
      PICK_ORDER.SPECIAL_INSTRUCTIONS2,
      PICK_ORDER.INV_WITH_GOODS,
      PICK_ORDER.CUSTOMER_PO_WO,
      PICK_ITEM.PROD_ID,
      PROD_PROFILE.SHORT_DESC,
      SSN.SSN_DESCRIPTION,
      SSN.LEGACY_ID,
      PICK_ORDER.CONTACT_NAME,
      PICK_ORDER.P_ADDRESS_LINE3,
      PICK_ORDER.P_ADDRESS_LINE4,
      PICK_ORDER.P_TITLE,
      PICK_ORDER.P_AUST_POST_4STATE_ID,
      PICK_ORDER.P_ADDRESS_LINE5
      FROM PICK_DESPATCH
      INNER JOIN PICK_ITEM_DETAIL ON (PICK_DESPATCH.DESPATCH_ID = PICK_ITEM_DETAIL.DESPATCH_ID)
      INNER JOIN PICK_ITEM ON (PICK_ITEM.PICK_LABEL_NO = PICK_ITEM_DETAIL.PICK_LABEL_NO)
      INNER JOIN PICK_ORDER ON (PICK_ITEM.PICK_ORDER = PICK_ORDER.PICK_ORDER)
      INNER JOIN ISSN ON (PICK_ITEM_DETAIL.SSN_ID = ISSN.SSN_ID)
      INNER JOIN SSN ON (SSN.SSN_ID = ISSN.ORIGINAL_SSN)
      LEFT OUTER JOIN PROD_PROFILE ON (ISSN.PROD_ID = PROD_PROFILE.PROD_ID)
      WHERE PICK_DESPATCH.AWB_CONSIGNMENT_NO = :CONNOTE
      AND PICK_ORDER.PICK_ORDER_TYPE = :ORDER_TYPE
      AND PICK_DESPATCH.DESPATCH_STATUS = 'DC'
      ORDER BY PICK_ITEM.PICK_ORDER,PICK_ITEM.PICK_ORDER_LINE_NO
      INTO :PICK_ORDER,
      :WH_ID,
      :PICK_LOCATION,
      :AWB_CONSIGNMENT_NO,
      :PICKED_QTY,
      :PICK_ORDER_QTY,
      :PICKD_POST_CODE,
      :PICKD_SUBURB,
      :P_FIRST_NAME,
      :P_ADDRESS_LINE1,
      :P_LAST_NAME,
      :P_ADDRESS_LINE2,
      :P_CITY,
      :P_STATE,
      :P_POST_CODE,
      :P_COUNTRY,
      :P_PHONE,
      :SHIP_VIA,
      :CREATED_BY,
      :CREATE_DATE,
      :PICK_ORDER_TYPE,
      :PICK_ORDER_LINE_NO,
      :SSN_ID,
      :WARRANTY_TERM,
      :SPECIAL_INSTRUCTIONS1,
      :SPECIAL_INSTRUCTIONS2,
      :INV_WITH_GOODS,
      :CUSTOMER_PO_WO,
      :PROD_ID,
      :SHORT_DESC,
      :SSN_DESCRIPTION,
      :LEGACY_ID,
      :CONTACT_NAME,
      :P_ADDRESS_LINE3,
      :P_ADDRESS_LINE4,
      :P_TITLE,
      :P_AUST_POST_4STATE_ID,
      :P_ADDRESS_LINE5
      DO
      BEGIN
         SUSPEND;
      END
   END
   ELSE
   BEGIN
      FOR SELECT PICK_ITEM.PICK_ORDER,
      PICK_ITEM.WH_ID,
      PICK_ITEM.PICK_LOCATION,
      PICK_DESPATCH.AWB_CONSIGNMENT_NO,
      PICK_ITEM.PICKED_QTY,
      PICK_ITEM.PICK_ORDER_QTY,
      PICK_DESPATCH.PICKD_POST_CODE,
      PICK_DESPATCH.PICKD_SUBURB,
      PICK_ORDER.P_FIRST_NAME,
      PICK_ORDER.P_ADDRESS_LINE1,
      PICK_ORDER.P_LAST_NAME,
      PICK_ORDER.P_ADDRESS_LINE2,
      PICK_ORDER.P_CITY,
      PICK_ORDER.P_STATE,
      PICK_ORDER.P_POST_CODE,
      PICK_ORDER.P_COUNTRY,
      PICK_ORDER.P_PHONE,
      PICK_ORDER.SHIP_VIA,
      PICK_ORDER.CREATED_BY,
      PICK_ORDER.CREATE_DATE,
      PICK_ORDER.PICK_ORDER_TYPE,
      PICK_ITEM.PICK_ORDER_LINE_NO,
      PICK_ITEM.SSN_ID,
      PICK_ITEM.WARRANTY_TERM,
      PICK_ORDER.SPECIAL_INSTRUCTIONS1,
      PICK_ORDER.SPECIAL_INSTRUCTIONS2,
      PICK_ORDER.INV_WITH_GOODS,
      PICK_ORDER.CUSTOMER_PO_WO,
      PICK_ITEM.PROD_ID,
      PROD_PROFILE.SHORT_DESC,
      SSN.SSN_DESCRIPTION,
      SSN.LEGACY_ID,
      PICK_ORDER.CONTACT_NAME,
      PICK_ORDER.P_ADDRESS_LINE3,
      PICK_ORDER.P_ADDRESS_LINE4,
      PICK_ORDER.P_TITLE,
      PICK_ORDER.P_AUST_POST_4STATE_ID,
      PICK_ORDER.P_ADDRESS_LINE5
      FROM PICK_DESPATCH
      INNER JOIN PICK_ITEM_DETAIL ON (PICK_DESPATCH.DESPATCH_ID = PICK_ITEM_DETAIL.DESPATCH_ID)
      INNER JOIN PICK_ITEM ON (PICK_ITEM.PICK_LABEL_NO = PICK_ITEM_DETAIL.PICK_LABEL_NO)
      INNER JOIN PICK_ORDER ON (PICK_ITEM.PICK_ORDER = PICK_ORDER.PICK_ORDER)
      INNER JOIN ISSN ON (PICK_ITEM_DETAIL.SSN_ID = ISSN.SSN_ID)
      INNER JOIN SSN ON (SSN.SSN_ID = ISSN.ORIGINAL_SSN)
      LEFT OUTER JOIN PROD_PROFILE ON (ISSN.PROD_ID = PROD_PROFILE.PROD_ID)
      WHERE PICK_DESPATCH.AWB_CONSIGNMENT_NO = :CONNOTE
      AND PICK_ORDER.PICK_ORDER_TYPE = :ORDER_TYPE
      ORDER BY PICK_ITEM.PICK_ORDER,PICK_ITEM.PICK_ORDER_LINE_NO
      INTO :PICK_ORDER,
      :WH_ID,
      :PICK_LOCATION,
      :AWB_CONSIGNMENT_NO,
      :PICKED_QTY,
      :PICK_ORDER_QTY,
      :PICKD_POST_CODE,
      :PICKD_SUBURB,
      :P_FIRST_NAME,
      :P_ADDRESS_LINE1,
      :P_LAST_NAME,
      :P_ADDRESS_LINE2,
      :P_CITY,
      :P_STATE,
      :P_POST_CODE,
      :P_COUNTRY,
      :P_PHONE,
      :SHIP_VIA,
      :CREATED_BY,
      :CREATE_DATE,
      :PICK_ORDER_TYPE,
      :PICK_ORDER_LINE_NO,
      :SSN_ID,
      :WARRANTY_TERM,
      :SPECIAL_INSTRUCTIONS1,
      :SPECIAL_INSTRUCTIONS2,
      :INV_WITH_GOODS,
      :CUSTOMER_PO_WO,
      :PROD_ID,
      :SHORT_DESC,
      :SSN_DESCRIPTION,
      :LEGACY_ID,
      :CONTACT_NAME,
      :P_ADDRESS_LINE3,
      :P_ADDRESS_LINE4,
      :P_TITLE,
      :P_AUST_POST_4STATE_ID,
      :P_ADDRESS_LINE5
      DO
      BEGIN
         SUSPEND;
      END
   END

END ^

ALTER PROCEDURE MANIFEST_DELIVERY (IN_PICK_ORDER VARCHAR(15) CHARACTER SET NONE)
RETURNS (PO_PICK_ORDER VARCHAR(15) CHARACTER SET NONE,
PO_P_FIRST_NAME VARCHAR(50) CHARACTER SET NONE,
PO_P_LAST_NAME VARCHAR(50) CHARACTER SET NONE,
PO_P_ADDRESS_LINE1 VARCHAR(100) CHARACTER SET NONE,
PO_P_ADDRESS_LINE2 VARCHAR(50) CHARACTER SET NONE,
PO_P_ADDRESS_LINE3 VARCHAR(50) CHARACTER SET NONE,
PO_P_ADDRESS_LINE4 VARCHAR(50) CHARACTER SET NONE,
PO_P_ADDRESS_LINE5 VARCHAR(50) CHARACTER SET NONE,
PO_P_CITY VARCHAR(25) CHARACTER SET NONE,
PO_P_STATE VARCHAR(15) CHARACTER SET NONE,
PO_P_POST_CODE VARCHAR(10) CHARACTER SET NONE,
PO_P_COUNTRY VARCHAR(25) CHARACTER SET NONE,
PO_P_PHONE VARCHAR(30) CHARACTER SET NONE,
PO_P_TITLE VARCHAR(10) CHARACTER SET NONE,
PO_P_AUST_POST_4STATE_ID VARCHAR(255) CHARACTER SET NONE,
PO_PERSON_ID VARCHAR(10) CHARACTER SET NONE,
PO_TERMS VARCHAR(20) CHARACTER SET NONE,
PO_PAYMENT_METHOD VARCHAR(20) CHARACTER SET NONE,
PO_P_PERSON_TYPE VARCHAR(2) CHARACTER SET NONE,
PO_P_PERSON_ID VARCHAR(10) CHARACTER SET NONE,
PO_P_SAME_AS_INVOICE_TO CHAR(1) CHARACTER SET NONE,
PO_OTHER1 VARCHAR(50) CHARACTER SET NONE,
PO_OTHER2 VARCHAR(50) CHARACTER SET NONE,
PO_OTHER3 VARCHAR(50) CHARACTER SET NONE,
PO_OTHER4 VARCHAR(50) CHARACTER SET NONE,
PO_OTHER5 VARCHAR(50) CHARACTER SET NONE,
PO_D_FIRST_NAME VARCHAR(50) CHARACTER SET NONE,
PO_D_LAST_NAME VARCHAR(50) CHARACTER SET NONE,
PO_D_ADDRESS_LINE1 VARCHAR(100) CHARACTER SET NONE,
PO_D_ADDRESS_LINE2 VARCHAR(50) CHARACTER SET NONE,
PO_D_ADDRESS_LINE3 VARCHAR(50) CHARACTER SET NONE,
PO_D_ADDRESS_LINE4 VARCHAR(50) CHARACTER SET NONE,
PO_D_ADDRESS_LINE5 VARCHAR(50) CHARACTER SET NONE,
PO_D_CITY VARCHAR(25) CHARACTER SET NONE,
PO_D_STATE VARCHAR(15) CHARACTER SET NONE,
PO_D_POST_CODE VARCHAR(10) CHARACTER SET NONE,
PO_D_COUNTRY VARCHAR(35) CHARACTER SET NONE,
PO_D_PHONE VARCHAR(30) CHARACTER SET NONE,
PO_D_TITLE VARCHAR(10) CHARACTER SET NONE,
PO_D_PERSON_ID VARCHAR(10) CHARACTER SET NONE,
PO_S_PERSON_TYPE CHAR(2) CHARACTER SET NONE,
PO_S_FIRST_NAME VARCHAR(50) CHARACTER SET NONE,
PO_S_LAST_NAME VARCHAR(50) CHARACTER SET NONE,
PO_S_ADDRESS_LINE1 VARCHAR(100) CHARACTER SET NONE,
PO_S_ADDRESS_LINE2 VARCHAR(50) CHARACTER SET NONE,
PO_S_ADDRESS_LINE3 VARCHAR(50) CHARACTER SET NONE,
PO_S_ADDRESS_LINE4 VARCHAR(50) CHARACTER SET NONE,
PO_S_ADDRESS_LINE5 VARCHAR(50) CHARACTER SET NONE,
PO_S_CITY VARCHAR(25) CHARACTER SET NONE,
PO_S_STATE VARCHAR(15) CHARACTER SET NONE,
PO_S_POST_CODE VARCHAR(10) CHARACTER SET NONE,
PO_S_COUNTRY VARCHAR(35) CHARACTER SET NONE,
PO_S_PHONE VARCHAR(30) CHARACTER SET NONE,
PO_S_TITLE VARCHAR(10) CHARACTER SET NONE,
PO_S_PERSON_ID VARCHAR(10) CHARACTER SET NONE,
PO_SUPPLIER_ID VARCHAR(10) CHARACTER SET NONE,
PO_S_SAME_AS_SOLD_FROM CHAR(1) CHARACTER SET NONE,
PO_REMARKS1 VARCHAR(80) CHARACTER SET NONE,
PO_REMARKS2 VARCHAR(80) CHARACTER SET NONE,
PO_REMARKS3 VARCHAR(80) CHARACTER SET NONE,
PO_REMARKS4 VARCHAR(80) CHARACTER SET NONE,
PO_REMARKS5 VARCHAR(80) CHARACTER SET NONE,
PO_EXPORT_CATEGORY CHAR(1) CHARACTER SET NONE,
PO_PO_MATERIAL_SAFETY_DATA CHAR(1) CHARACTER SET NONE,
PO_SHIP_VIA VARCHAR(10) CHARACTER SET NONE,
PO_CREATED_BY VARCHAR(10) CHARACTER SET NONE,
PO_CREATE_DATE TIMESTAMP,
PO_PICK_ORDER_TYPE CHAR(2) CHARACTER SET NONE,
PO_SPECIAL_INSTRUCTIONS1 VARCHAR(8196) CHARACTER SET NONE,
PO_SPECIAL_INSTRUCTIONS2 VARCHAR(255) CHARACTER SET NONE,
PO_INV_WITH_GOODS CHAR(1) CHARACTER SET NONE,
PO_CUSTOMER_PO_WO VARCHAR(20) CHARACTER SET NONE,
PO_CONTACT_NAME VARCHAR(50) CHARACTER SET NONE,
PO_PICK_STATUS CHAR(2) CHARACTER SET NONE,
PO_EARLIEST_DATE TIMESTAMP,
PO_RETURN_DATE TIMESTAMP,
PO_PRINTED_DATE TIMESTAMP,
PO_PICK_DUE_DATE TIMESTAMP,
PO_DESPATCH_LOCATION VARCHAR(10) CHARACTER SET NONE,
PO_TOTAL_LOAN_DAYS INTEGER,
PO_D_WH_ID CHAR(2) CHARACTER SET NONE,
PO_WH_ID CHAR(2) CHARACTER SET NONE,
IS_SSN_ID VARCHAR(20) CHARACTER SET NONE,
IS_WH_ID CHAR(2) CHARACTER SET NONE,
IS_LOCN_ID VARCHAR(10) CHARACTER SET NONE,
IS_CURRENT_QTY INTEGER,
IS_ORIGINAL_SSN VARCHAR(20) CHARACTER SET NONE,
IS_PROD_ID VARCHAR(30) CHARACTER SET NONE,
SN_SSN_TYPE VARCHAR(40) CHARACTER SET NONE,
SN_SSN_DESCRIPTION VARCHAR(80) CHARACTER SET NONE,
SN_LEGACY_ID VARCHAR(20) CHARACTER SET NONE,
SN_NET_WEIGHT DOUBLE PRECISION,
SN_NET_WEIGHT_UOM CHAR(2) CHARACTER SET NONE,
SN_PURCHASE_PRICE DOUBLE PRECISION,
SN_LOAN_SAFETY_CHECK CHAR(1) CHARACTER SET NONE,
SN_LOAN_SAFETY_PASS CHAR(1) CHARACTER SET NONE,
SN_LOAN_LAST_SAFETY_CHECK_DATE TIMESTAMP,
SN_LOAN_SAFETY_PERIOD_NO INTEGER,
SN_LOAN_SAFETY_PERIOD CHAR(1) CHARACTER SET NONE,
SN_LOAN_CALIBRATE_CHECK CHAR(1) CHARACTER SET NONE,
SN_LOAN_CALIBRATE_PASS CHAR(1) CHARACTER SET NONE,
SN_LOAN_LAST_CALIBRATE_CHECK_DT TIMESTAMP,
SN_LOAN_CALIBRATE_PERIOD_NO INTEGER,
SN_LOAN_CALIBRATE_PERIOD CHAR(1) CHARACTER SET NONE,
ST_DESCRIPTION VARCHAR(50) CHARACTER SET NONE,
PROD_EXTENDED_PRICE DOUBLE PRECISION,
PP_SHORT_DESC VARCHAR(50) CHARACTER SET NONE,
PP_UOM CHAR(2) CHARACTER SET NONE,
PP_NET_WEIGHT DOUBLE PRECISION,
PP_NET_WEIGHT_UOM CHAR(2) CHARACTER SET NONE,
PP_PP_MATERIAL_SAFETY_DATA CHAR(1) CHARACTER SET NONE,
PP_PP_MATERIAL_SAFETY_DATA_NO VARCHAR(40) CHARACTER SET NONE,
PP_SALE_PRICE DOUBLE PRECISION)
AS 
BEGIN
/*
want issn's in passed wh_id
use pick_order for addresses and special instructions

then for products or ssns which are products in the pick_order
want the sum of unpicked products

for non products ie tools
want se_price ie current_qty*purchase_price
and grouping at ssn_type for this

for products in the pick_order
want pick_item.pick_order_qty * pick_item.sale_price

10/09/09
include moveable locations at the warehouse calulated
include the picked despatch location for the order
*/
   /* initialize variables */
   /* want address and stuff from pick order */
   SELECT PICK_ORDER.PICK_ORDER,
      PICK_ORDER.P_FIRST_NAME,
      PICK_ORDER.P_LAST_NAME,
      PICK_ORDER.P_ADDRESS_LINE1,
      PICK_ORDER.P_ADDRESS_LINE2,
      PICK_ORDER.P_ADDRESS_LINE3,
      PICK_ORDER.P_ADDRESS_LINE4,
      PICK_ORDER.P_ADDRESS_LINE5,
      PICK_ORDER.P_CITY,
      PICK_ORDER.P_STATE,
      PICK_ORDER.P_POST_CODE,
      PICK_ORDER.P_COUNTRY,
      PICK_ORDER.P_PHONE,
      PICK_ORDER.P_TITLE,
      PICK_ORDER.P_AUST_POST_4STATE_ID,
      PICK_ORDER.PERSON_ID ,
      PICK_ORDER.TERMS ,
      PICK_ORDER.PAYMENT_METHOD ,
      PICK_ORDER.P_PERSON_TYPE ,
      PICK_ORDER.P_PERSON_ID PERSON,
      PICK_ORDER.P_SAME_AS_INVOICE_TO ,
      PICK_ORDER.OTHER1 ,
      PICK_ORDER.OTHER2 ,
      PICK_ORDER.OTHER3 ,
      PICK_ORDER.OTHER4 ,
      PICK_ORDER.OTHER5 ,
      PICK_ORDER.D_FIRST_NAME ,
      PICK_ORDER.D_LAST_NAME ,
      PICK_ORDER.D_CITY ,
      PICK_ORDER.D_STATE ,
      PICK_ORDER.D_POST_CODE ,
      PICK_ORDER.D_COUNTRY ,
      PICK_ORDER.D_PHONE ,
      PICK_ORDER.D_ADDRESS_LINE1 ,
      PICK_ORDER.D_ADDRESS_LINE2 ,
      PICK_ORDER.D_ADDRESS_LINE3 ,
      PICK_ORDER.D_ADDRESS_LINE4 ,
      PICK_ORDER.D_ADDRESS_LINE5 ,
      PICK_ORDER.D_TITLE ,
      PICK_ORDER.D_PERSON_ID ,
      PICK_ORDER.SUPPLIER_ID ,
      PICK_ORDER.S_PERSON_ID ,
      PICK_ORDER.S_PERSON_TYPE ,
      PICK_ORDER.S_FIRST_NAME ,
      PICK_ORDER.S_LAST_NAME ,
      PICK_ORDER.S_CITY ,
      PICK_ORDER.S_STATE ,
      PICK_ORDER.S_POST_CODE ,
      PICK_ORDER.S_COUNTRY ,
      PICK_ORDER.S_PHONE ,
      PICK_ORDER.S_ADDRESS_LINE1 ,
      PICK_ORDER.S_ADDRESS_LINE2 ,
      PICK_ORDER.S_ADDRESS_LINE3 ,
      PICK_ORDER.S_ADDRESS_LINE4 ,
      PICK_ORDER.S_ADDRESS_LINE5 ,
      PICK_ORDER.S_TITLE ,
      PICK_ORDER.S_SAME_AS_SOLD_FROM ,
      PICK_ORDER.REMARKS1 ,
      PICK_ORDER.REMARKS2 ,
      PICK_ORDER.REMARKS3 ,
      PICK_ORDER.REMARKS4 ,
      PICK_ORDER.REMARKS5 ,
      PICK_ORDER.EXPORT_CATEGORY,
      PICK_ORDER.PO_MATERIAL_SAFETY_DATA ,
      PICK_ORDER.SHIP_VIA,
      PICK_ORDER.CREATED_BY,
      PICK_ORDER.CREATE_DATE,
      PICK_ORDER.PICK_ORDER_TYPE,
      PICK_ORDER.SPECIAL_INSTRUCTIONS1,
      PICK_ORDER.SPECIAL_INSTRUCTIONS2,
      PICK_ORDER.INV_WITH_GOODS,
      PICK_ORDER.CUSTOMER_PO_WO,
      PICK_ORDER.CONTACT_NAME,
      PICK_ORDER.PICK_STATUS,
      PICK_ORDER.EARLIEST_DATE ,
      PICK_ORDER.RETURN_DATE ,
      PICK_ORDER.PRINTED_DATE ,
      PICK_ORDER.PICK_DUE_DATE ,
      PICK_ORDER.DESPATCH_LOCATION, 
      PICK_ORDER.D_WH_ID, 
      PICK_ORDER.WH_ID 
      FROM PICK_ORDER 
      WHERE PICK_ORDER.PICK_ORDER = :IN_PICK_ORDER
      INTO :PO_PICK_ORDER,
      :PO_P_FIRST_NAME,
      :PO_P_LAST_NAME,
      :PO_P_ADDRESS_LINE1,
      :PO_P_ADDRESS_LINE2,
      :PO_P_ADDRESS_LINE3,
      :PO_P_ADDRESS_LINE4,
      :PO_P_ADDRESS_LINE5,
      :PO_P_CITY,
      :PO_P_STATE,
      :PO_P_POST_CODE,
      :PO_P_COUNTRY,
      :PO_P_PHONE,
      :PO_P_TITLE,
      :PO_P_AUST_POST_4STATE_ID,
      :PO_PERSON_ID ,
      :PO_TERMS ,
      :PO_PAYMENT_METHOD ,
      :PO_P_PERSON_TYPE ,
      :PO_P_PERSON_ID ,
      :PO_P_SAME_AS_INVOICE_TO ,
      :PO_OTHER1 ,
      :PO_OTHER2 ,
      :PO_OTHER3 ,
      :PO_OTHER4 ,
      :PO_OTHER5 ,
      :PO_D_FIRST_NAME,
      :PO_D_LAST_NAME,
      :PO_D_CITY,
      :PO_D_STATE,
      :PO_D_POST_CODE,
      :PO_D_COUNTRY,
      :PO_D_PHONE,
      :PO_D_ADDRESS_LINE1,
      :PO_D_ADDRESS_LINE2,
      :PO_D_ADDRESS_LINE3,
      :PO_D_ADDRESS_LINE4,
      :PO_D_ADDRESS_LINE5,
      :PO_D_TITLE,
      :PO_D_PERSON_ID,
      :PO_SUPPLIER_ID ,
      :PO_S_PERSON_ID ,
      :PO_S_PERSON_TYPE ,
      :PO_S_FIRST_NAME ,
      :PO_S_LAST_NAME ,
      :PO_S_CITY ,
      :PO_S_STATE ,
      :PO_S_POST_CODE ,
      :PO_S_COUNTRY ,
      :PO_S_PHONE ,
      :PO_S_ADDRESS_LINE1 ,
      :PO_S_ADDRESS_LINE2 ,
      :PO_S_ADDRESS_LINE3 ,
      :PO_S_ADDRESS_LINE4 ,
      :PO_S_ADDRESS_LINE5 ,
      :PO_S_TITLE ,
      :PO_S_SAME_AS_SOLD_FROM ,
      :PO_REMARKS1 ,
      :PO_REMARKS2 ,
      :PO_REMARKS3 ,
      :PO_REMARKS4 ,
      :PO_REMARKS5 ,
      :PO_EXPORT_CATEGORY,
      :PO_PO_MATERIAL_SAFETY_DATA ,
      :PO_SHIP_VIA,
      :PO_CREATED_BY,
      :PO_CREATE_DATE,
      :PO_PICK_ORDER_TYPE,
      :PO_SPECIAL_INSTRUCTIONS1,
      :PO_SPECIAL_INSTRUCTIONS2,
      :PO_INV_WITH_GOODS,
      :PO_CUSTOMER_PO_WO,
      :PO_CONTACT_NAME,
      :PO_PICK_STATUS,
      :PO_EARLIEST_DATE ,
      :PO_RETURN_DATE ,
      :PO_PRINTED_DATE ,
      :PO_PICK_DUE_DATE ,
      :PO_DESPATCH_LOCATION ,
      :PO_D_WH_ID ,
      :PO_WH_ID ;
   IF (PO_RETURN_DATE IS NULL) THEN
   BEGIN
         PO_TOTAL_LOAN_DAYS = NULL;
   END
   ELSE
   BEGIN
      IF (PO_PICK_DUE_DATE IS NULL) THEN
      BEGIN
         PO_TOTAL_LOAN_DAYS = NULL;
      END
      ELSE
      BEGIN
         PO_TOTAL_LOAN_DAYS = DIFFDATE(PO_RETURN_DATE, PO_PICK_DUE_DATE, 4);
      END
   END
   /*  want issns in location  */
   FOR SELECT ISSN.SSN_ID, 
      ISSN.WH_ID,
      ISSN.LOCN_ID,
      ISSN.CURRENT_QTY, 
      ISSN.ORIGINAL_SSN,
      SSN.SSN_TYPE,
      SSN.SSN_DESCRIPTION,
      SSN.LEGACY_ID,
      SSN.NET_WEIGHT,
      SSN.NET_WEIGHT_UOM,   
      SSN.PURCHASE_PRICE,  
      SSN.LOAN_SAFETY_CHECK,
      SSN.LOAN_SAFETY_PASS,
      SSN.LOAN_LAST_SAFETY_CHECK_DATE,
      SSN.LOAN_SAFETY_PERIOD_NO,
      SSN.LOAN_SAFETY_PERIOD,
      SSN.LOAN_CALIBRATE_CHECK,
      SSN.LOAN_CALIBRATE_PASS,
      SSN.LOAN_LAST_CALIBRATE_CHECK_DATE,
      SSN.LOAN_CALIBRATE_PERIOD_NO,
      SSN.LOAN_CALIBRATE_PERIOD,
      SSN_TYPE.DESCRIPTION,
      PROD_PROFILE.SHORT_DESC,
      PROD_PROFILE.UOM,
      PROD_PROFILE.NET_WEIGHT,
      PROD_PROFILE.NET_WEIGHT_UOM,
      PROD_PROFILE.PP_MATERIAL_SAFETY_DATA,
      PROD_PROFILE.PP_MATERIAL_SAFETY_DATA_NO,
      PROD_PROFILE.SALE_PRICE,
      ISSN.PROD_ID
      FROM WAREHOUSE 
      INNER JOIN ISSN ON WAREHOUSE.WH_ID = ISSN.WH_ID
      INNER JOIN SSN ON SSN.SSN_ID = ISSN.ORIGINAL_SSN
      LEFT OUTER JOIN PROD_PROFILE ON ISSN.PROD_ID = PROD_PROFILE.PROD_ID
      LEFT OUTER JOIN SSN_TYPE ON SSN.SSN_TYPE = SSN_TYPE.CODE
      WHERE WAREHOUSE.PERSON_ID =:PO_PERSON_ID 
      ORDER BY SSN.SSN_TYPE, ISSN.LOCN_ID
       INTO :IS_SSN_ID,
       :IS_WH_ID,
       :IS_LOCN_ID,
       :IS_CURRENT_QTY,
       :IS_ORIGINAL_SSN,
       :SN_SSN_TYPE,
       :SN_SSN_DESCRIPTION,
       :SN_LEGACY_ID,
       :SN_NET_WEIGHT,
       :SN_NET_WEIGHT_UOM,   
       :SN_PURCHASE_PRICE,  
       :SN_LOAN_SAFETY_CHECK,
       :SN_LOAN_SAFETY_PASS,
       :SN_LOAN_LAST_SAFETY_CHECK_DATE,
       :SN_LOAN_SAFETY_PERIOD_NO,
       :SN_LOAN_SAFETY_PERIOD,
       :SN_LOAN_CALIBRATE_CHECK,
       :SN_LOAN_CALIBRATE_PASS,
       :SN_LOAN_LAST_CALIBRATE_CHECK_DT,
       :SN_LOAN_CALIBRATE_PERIOD_NO,
       :SN_LOAN_CALIBRATE_PERIOD,
       :ST_DESCRIPTION,
       :PP_SHORT_DESC,
       :PP_UOM,
       :PP_NET_WEIGHT,
       :PP_NET_WEIGHT_UOM,
       :PP_PP_MATERIAL_SAFETY_DATA,
       :PP_PP_MATERIAL_SAFETY_DATA_NO,
       :PP_SALE_PRICE,
       :IS_PROD_ID
      DO
      BEGIN
         SUSPEND;
      END

   /*  want issns in  a moveable location in the specified location  */
   FOR SELECT ISSN.SSN_ID, 
      ISSN.WH_ID,
      ISSN.LOCN_ID,
      ISSN.CURRENT_QTY, 
      ISSN.ORIGINAL_SSN,
      SSN.SSN_TYPE,
      SSN.SSN_DESCRIPTION,
      SSN.LEGACY_ID,
      SSN.NET_WEIGHT,
      SSN.NET_WEIGHT_UOM,   
      SSN.PURCHASE_PRICE,  
      SSN.LOAN_SAFETY_CHECK,
      SSN.LOAN_SAFETY_PASS,
      SSN.LOAN_LAST_SAFETY_CHECK_DATE,
      SSN.LOAN_SAFETY_PERIOD_NO,
      SSN.LOAN_SAFETY_PERIOD,
      SSN.LOAN_CALIBRATE_CHECK,
      SSN.LOAN_CALIBRATE_PASS,
      SSN.LOAN_LAST_CALIBRATE_CHECK_DATE,
      SSN.LOAN_CALIBRATE_PERIOD_NO,
      SSN.LOAN_CALIBRATE_PERIOD,
      SSN_TYPE.DESCRIPTION,
      PROD_PROFILE.SHORT_DESC,
      PROD_PROFILE.UOM,
      PROD_PROFILE.NET_WEIGHT,
      PROD_PROFILE.NET_WEIGHT_UOM,
      PROD_PROFILE.PP_MATERIAL_SAFETY_DATA,
      PROD_PROFILE.PP_MATERIAL_SAFETY_DATA_NO,
      PROD_PROFILE.SALE_PRICE,
      ISSN.PROD_ID
      FROM WAREHOUSE 
      INNER JOIN LOCATION  ON WAREHOUSE.WH_ID = LOCATION.CURRENT_WH_ID
      INNER JOIN ISSN ON LOCATION.WH_ID = ISSN.WH_ID AND LOCATION.LOCN_ID = ISSN.LOCN_ID
      INNER JOIN SSN ON SSN.SSN_ID = ISSN.ORIGINAL_SSN
      LEFT OUTER JOIN PROD_PROFILE ON ISSN.PROD_ID = PROD_PROFILE.PROD_ID
      LEFT OUTER JOIN SSN_TYPE ON SSN.SSN_TYPE = SSN_TYPE.CODE
      WHERE WAREHOUSE.PERSON_ID =:PO_PERSON_ID 
        AND LOCATION.WH_ID <> LOCATION.CURRENT_WH_ID
      ORDER BY SSN.SSN_TYPE, ISSN.LOCN_ID
       INTO :IS_SSN_ID,
       :IS_WH_ID,
       :IS_LOCN_ID,
       :IS_CURRENT_QTY,
       :IS_ORIGINAL_SSN,
       :SN_SSN_TYPE,
       :SN_SSN_DESCRIPTION,
       :SN_LEGACY_ID,
       :SN_NET_WEIGHT,
       :SN_NET_WEIGHT_UOM,   
       :SN_PURCHASE_PRICE,  
       :SN_LOAN_SAFETY_CHECK,
       :SN_LOAN_SAFETY_PASS,
       :SN_LOAN_LAST_SAFETY_CHECK_DATE,
       :SN_LOAN_SAFETY_PERIOD_NO,
       :SN_LOAN_SAFETY_PERIOD,
       :SN_LOAN_CALIBRATE_CHECK,
       :SN_LOAN_CALIBRATE_PASS,
       :SN_LOAN_LAST_CALIBRATE_CHECK_DT,
       :SN_LOAN_CALIBRATE_PERIOD_NO,
       :SN_LOAN_CALIBRATE_PERIOD,
       :ST_DESCRIPTION,
       :PP_SHORT_DESC,
       :PP_UOM,
       :PP_NET_WEIGHT,
       :PP_NET_WEIGHT_UOM,
       :PP_PP_MATERIAL_SAFETY_DATA,
       :PP_PP_MATERIAL_SAFETY_DATA_NO,
       :PP_SALE_PRICE,
       :IS_PROD_ID
      DO
      BEGIN
         SUSPEND;
      END

   /*  want issns in pick despatch location  */
   FOR SELECT ISSN.SSN_ID, 
      ISSN.WH_ID,
      ISSN.LOCN_ID,
      ISSN.CURRENT_QTY, 
      ISSN.ORIGINAL_SSN,
      SSN.SSN_TYPE,
      SSN.SSN_DESCRIPTION,
      SSN.LEGACY_ID,
      SSN.NET_WEIGHT,
      SSN.NET_WEIGHT_UOM,   
      SSN.PURCHASE_PRICE,  
      SSN.LOAN_SAFETY_CHECK,
      SSN.LOAN_SAFETY_PASS,
      SSN.LOAN_LAST_SAFETY_CHECK_DATE,
      SSN.LOAN_SAFETY_PERIOD_NO,
      SSN.LOAN_SAFETY_PERIOD,
      SSN.LOAN_CALIBRATE_CHECK,
      SSN.LOAN_CALIBRATE_PASS,
      SSN.LOAN_LAST_CALIBRATE_CHECK_DATE,
      SSN.LOAN_CALIBRATE_PERIOD_NO,
      SSN.LOAN_CALIBRATE_PERIOD,
      SSN_TYPE.DESCRIPTION,
      PROD_PROFILE.SHORT_DESC,
      PROD_PROFILE.UOM,
      PROD_PROFILE.NET_WEIGHT,
      PROD_PROFILE.NET_WEIGHT_UOM,
      PROD_PROFILE.PP_MATERIAL_SAFETY_DATA,
      PROD_PROFILE.PP_MATERIAL_SAFETY_DATA_NO,
      PROD_PROFILE.SALE_PRICE,
      ISSN.PROD_ID
      FROM ISSN 
      INNER JOIN SSN ON SSN.SSN_ID = ISSN.ORIGINAL_SSN
      LEFT OUTER JOIN PROD_PROFILE ON ISSN.PROD_ID = PROD_PROFILE.PROD_ID
      LEFT OUTER JOIN SSN_TYPE ON SSN.SSN_TYPE = SSN_TYPE.CODE
      WHERE (ISSN.WH_ID IN (:PO_WH_ID,'XD')
      AND   ISSN.LOCN_ID=:PO_DESPATCH_LOCATION)
      OR  ( ISSN.WH_ID=SUBSTR(:PO_DESPATCH_LOCATION,1,2)
      AND   ISSN.LOCN_ID=SUBSTR(:PO_DESPATCH_LOCATION,3,10))
      ORDER BY SSN.SSN_TYPE, ISSN.LOCN_ID
       INTO :IS_SSN_ID,
       :IS_WH_ID,
       :IS_LOCN_ID,
       :IS_CURRENT_QTY,
       :IS_ORIGINAL_SSN,
       :SN_SSN_TYPE,
       :SN_SSN_DESCRIPTION,
       :SN_LEGACY_ID,
       :SN_NET_WEIGHT,
       :SN_NET_WEIGHT_UOM,   
       :SN_PURCHASE_PRICE,  
       :SN_LOAN_SAFETY_CHECK,
       :SN_LOAN_SAFETY_PASS,
       :SN_LOAN_LAST_SAFETY_CHECK_DATE,
       :SN_LOAN_SAFETY_PERIOD_NO,
       :SN_LOAN_SAFETY_PERIOD,
       :SN_LOAN_CALIBRATE_CHECK,
       :SN_LOAN_CALIBRATE_PASS,
       :SN_LOAN_LAST_CALIBRATE_CHECK_DT,
       :SN_LOAN_CALIBRATE_PERIOD_NO,
       :SN_LOAN_CALIBRATE_PERIOD,
       :ST_DESCRIPTION,
       :PP_SHORT_DESC,
       :PP_UOM,
       :PP_NET_WEIGHT,
       :PP_NET_WEIGHT_UOM,
       :PP_PP_MATERIAL_SAFETY_DATA,
       :PP_PP_MATERIAL_SAFETY_DATA_NO,
       :PP_SALE_PRICE,
       :IS_PROD_ID
      DO
      BEGIN
         SUSPEND;
      END
   /* clear the issn fields */
   IS_SSN_ID = '';
   IS_WH_ID = '';
   IS_LOCN_ID = '';
   IS_CURRENT_QTY = 0;
   IS_ORIGINAL_SSN = '';
   SN_SSN_TYPE = '';
   SN_SSN_DESCRIPTION = '';
   SN_LEGACY_ID = '';
   SN_NET_WEIGHT = 0;
   SN_NET_WEIGHT_UOM    = '';
   SN_PURCHASE_PRICE   = 0;
   SN_LOAN_SAFETY_CHECK = '';
   SN_LOAN_SAFETY_PASS = '';
   SN_LOAN_LAST_SAFETY_CHECK_DATE = NULL;
   SN_LOAN_SAFETY_PERIOD_NO = 0;
   SN_LOAN_SAFETY_PERIOD = '';
   SN_LOAN_CALIBRATE_CHECK = '';
   SN_LOAN_CALIBRATE_PASS = '';
   SN_LOAN_LAST_CALIBRATE_CHECK_DT = NULL;
   SN_LOAN_CALIBRATE_PERIOD_NO = 0;
   SN_LOAN_CALIBRATE_PERIOD = '';
   ST_DESCRIPTION = '';
   /* now want product lines from order */
END ^

ALTER PROCEDURE MANIFEST_ISSN (IN_WH_ID CHAR(2) CHARACTER SET NONE,
IN_COMPANY_ID VARCHAR(20) CHARACTER SET NONE,
IN_PROD_ID VARCHAR(30) CHARACTER SET NONE,
IN_START_DATE TIMESTAMP,
IN_END_DATE TIMESTAMP)
RETURNS (IS_PROD_ID VARCHAR(30) CHARACTER SET NONE,
IS_METHOD_NAME VARCHAR(15) CHARACTER SET NONE,
IS_QTY INTEGER,
IS_DATE TIMESTAMP)
AS 
DECLARE VARIABLE WK_END_DATE TIMESTAMP;
DECLARE VARIABLE WK_QTY  INTEGER;
DECLARE VARIABLE WK_LAST_PROD VARCHAR(30);
DECLARE VARIABLE WK_SAVE_PROD VARCHAR(30);
DECLARE VARIABLE WK_SAVE_METHOD VARCHAR(40);
DECLARE VARIABLE WK_SAVE_QTY  INTEGER;
DECLARE VARIABLE WK_SAVE_DATE TIMESTAMP;
DECLARE VARIABLE WK_REC_ID    INTEGER;
BEGIN
   WK_END_DATE = MAXTIME(IN_END_DATE);
/* have wh_id and a date range */
/* have current qtys */
/* have receipt qtys */
/* have picked qtys */
/* stock adjust ments */
   /* have done none in last 3 months*/
 /* STIS
    STRC
    AUOB to change location wh or qty */
/* returns */
   /* none of these there not using this */
/* transfers out of wh */
/* transfers into wh */


   /* get current values */
   WK_REC_ID = GEN_ID(TRANSACTION_ID, 1);
   DELETE FROM TRANSACTIONS_WORK WHERE RECORD_ID = :WK_REC_ID;
   INSERT INTO TRANSACTIONS_WORK(RECORD_ID, OBJECT, REFERENCE, QTY, TRN_DATE )
   SELECT :WK_REC_ID, PROD_ID, 'Now' , SUM(CURRENT_QTY) ,:WK_END_DATE
   FROM ISSN 
   WHERE WH_ID= :IN_WH_ID 
   AND  COMPANY_ID= :IN_COMPANY_ID 
   GROUP BY PROD_ID;

   /* get receipts */
   INSERT INTO TRANSACTIONS_WORK(RECORD_ID, OBJECT, REFERENCE, QTY, TRN_DATE)
   SELECT :WK_REC_ID, PROD_ID, 'Received', SUM(ORIGINAL_QTY) ,ZEROTIME(CREATE_DATE) 
   FROM SSN 
   WHERE WH_ID= :IN_WH_ID 
   AND  COMPANY_ID= :IN_COMPANY_ID 
   AND  CREATE_DATE BETWEEN :IN_START_DATE AND :WK_END_DATE 
   GROUP BY PROD_ID, ZEROTIME(CREATE_DATE);

   /* get picks */
   INSERT INTO TRANSACTIONS_WORK(RECORD_ID, OBJECT, REFERENCE, QTY, TRN_DATE)
   SELECT :WK_REC_ID, I1.PROD_ID, 'Picked' , SUM(T1.QTY) , ZEROTIME(T1.TRN_DATE)
   FROM TRANSACTIONS_ARCHIVE  T1 
   JOIN ISSN I1 ON T1.OBJECT = I1.SSN_ID 
   WHERE T1.TRN_DATE BETWEEN :IN_START_DATE AND :WK_END_DATE 
   AND   T1.TRN_TYPE='PKOL' 
   AND   T1.WH_ID= :IN_WH_ID 
   AND   I1.COMPANY_ID= :IN_COMPANY_ID 
   GROUP BY I1.PROD_ID, ZEROTIME(T1.TRN_DATE);

   WK_LAST_PROD = '';
   /*  want issns in location  */
   FOR SELECT TRANSACTIONS_WORK.OBJECT, 
      TRANSACTIONS_WORK.REFERENCE,
      TRANSACTIONS_WORK.QTY,
      TRANSACTIONS_WORK.TRN_DATE
      FROM TRANSACTIONS_WORK 
      WHERE TRANSACTIONS_WORK.RECORD_ID = :WK_REC_ID 
      ORDER BY TRANSACTIONS_WORK.OBJECT, TRANSACTIONS_WORK.REFERENCE, TRANSACTIONS_WORK.TRN_DATE
       INTO :IS_PROD_ID,
       :IS_METHOD_NAME,
       :IS_QTY,
       :IS_DATE
      DO
      BEGIN
         IF (IS_PROD_ID <>  WK_LAST_PROD) THEN
         BEGIN
            /* product changed */
            /* save the result */
            WK_SAVE_METHOD = IS_METHOD_NAME;
            WK_SAVE_PROD = IS_PROD_ID;
            WK_SAVE_QTY = IS_QTY;
            WK_SAVE_DATE = IS_DATE;
            /* write 'Start' record */
            BEGIN
               IS_METHOD_NAME = 'Begin';
               IS_QTY = WK_QTY;
               IS_DATE = IN_START_DATE;
               IS_PROD_ID = WK_LAST_PROD;
               SUSPEND;
               IS_METHOD_NAME = WK_SAVE_METHOD;
               IS_PROD_ID = WK_SAVE_PROD;
               IS_QTY = WK_SAVE_QTY;
               IS_DATE = WK_SAVE_DATE;
            END
            IF (IS_METHOD_NAME <> 'Now') THEN
            BEGIN
               /* product no longer in location */
               /* so send a zero Now record */
               IS_METHOD_NAME = 'Now';
               IS_QTY = 0;
               WK_QTY = 0;
               IS_DATE = WK_END_DATE;
               SUSPEND;
               IS_METHOD_NAME = WK_SAVE_METHOD;
               IS_PROD_ID = WK_SAVE_PROD;
               IS_QTY = WK_SAVE_QTY;
               IS_DATE = WK_SAVE_DATE;
            END
            ELSE
            BEGIN
               WK_QTY = IS_QTY;
            END
            WK_LAST_PROD = IS_PROD_ID;
         END /* end of prod changed */
         /* modify total */
         IF (IS_METHOD_NAME = 'Picked') THEN
         BEGIN
            /* add to now */
            WK_QTY = WK_QTY + IS_QTY;
         END
         IF (IS_METHOD_NAME = 'Received') THEN
         BEGIN
            /* remove from now */
            WK_QTY = WK_QTY - IS_QTY;
         END
         SUSPEND;
      END /* end for */
   /* write last 'Start' */
   BEGIN
      IS_METHOD_NAME = 'Begin';
      IS_QTY = WK_QTY;
      IS_DATE = IN_START_DATE;
      IS_PROD_ID = WK_LAST_PROD;
      SUSPEND;
   END
END ^

ALTER PROCEDURE MANIFEST_ORDER (PICK_ORDER VARCHAR(15) CHARACTER SET NONE)
RETURNS (DESPATCH_ID VARCHAR(20) CHARACTER SET NONE,
AWB_CONSIGNMENT_NO VARCHAR(20) CHARACTER SET NONE,
USER_ID VARCHAR(10) CHARACTER SET NONE,
DESPATCH_STATUS CHAR(2) CHARACTER SET NONE,
ORDER_TYPE CHAR(2) CHARACTER SET NONE)
AS 
/* DECLARE VARIABLE P_ADDRESS_LINE5 VARCHAR(50); */
BEGIN
   FOR SELECT 
      PICK_DESPATCH.DESPATCH_ID,
      PICK_DESPATCH.AWB_CONSIGNMENT_NO,
      PICK_DESPATCH.USER_ID,
      PICK_DESPATCH.DESPATCH_STATUS,
      PICK_ORDER.PICK_ORDER_TYPE
   FROM PICK_ORDER
      INNER JOIN PICK_ITEM ON (PICK_ITEM.PICK_ORDER = PICK_ORDER.PICK_ORDER)
      INNER JOIN PICK_ITEM_DETAIL ON (PICK_ITEM_DETAIL.PICK_LABEL_NO = PICK_ITEM.PICK_LABEL_NO)
      INNER JOIN PICK_DESPATCH ON (PICK_DESPATCH.DESPATCH_ID = PICK_ITEM_DETAIL.DESPATCH_ID)
   WHERE PICK_ORDER.PICK_ORDER = :PICK_ORDER
   GROUP BY PICK_DESPATCH.AWB_CONSIGNMENT_NO, PICK_DESPATCH.DESPATCH_ID, PICK_DESPATCH.USER_ID, PICK_DESPATCH.DESPATCH_STATUS, PICK_ORDER.PICK_ORDER_TYPE
   INTO 
      :DESPATCH_ID,
      :AWB_CONSIGNMENT_NO,
      :USER_ID,
      :DESPATCH_STATUS,
      :ORDER_TYPE
   DO
   BEGIN
      SUSPEND;
   END

END ^

ALTER PROCEDURE NEXT_GRN_ID RETURNS (GRN VARCHAR(10) CHARACTER SET NONE)
AS 
DECLARE VARIABLE WK_GRN_NO CHAR(10);
DECLARE VARIABLE WK_GRN_START INTEGER;
DECLARE VARIABLE WK_GRN_STOP INTEGER;
DECLARE VARIABLE WK_LENGTH INTEGER;
DECLARE VARIABLE WK_GRN_ADJUSTMENT INTEGER;
DECLARE VARIABLE WK_LEN_NO INTEGER;
DECLARE VARIABLE WK_L_GRN_NO  VARCHAR(10);
BEGIN
     SELECT MAX_LENGTH
     FROM PARAM
     WHERE DATA_ID = 'GRN'
     INTO :WK_LENGTH;
     WK_GRN_NO = GEN_ID(GRN, 1); 
     /* WK_GRN_NO = GRN_NO; */
     WK_GRN_START = GEN_ID(GRN_START, 0);
     WK_GRN_STOP = GEN_ID(GRN_STOP, 0);
     IF (WK_GRN_NO > WK_GRN_STOP) THEN
     BEGIN
        WK_GRN_ADJUSTMENT = WK_GRN_START - WK_GRN_STOP;
        WK_GRN_NO = GEN_ID(GRN, WK_GRN_ADJUSTMENT);
        WK_GRN_NO = WK_GRN_START;
     END
     WK_LEN_NO = STRLEN(ALLTRIM(WK_GRN_NO)) ;
     /* Get Label prefix */
     WK_L_GRN_NO = '';
     /* Padding leading with 0 */
     WHILE (WK_LEN_NO < WK_LENGTH) DO
     BEGIN
        WK_L_GRN_NO = WK_L_GRN_NO || '0';
        WK_LEN_NO = WK_LEN_NO + 1;
     END
     WK_L_GRN_NO = WK_L_GRN_NO || ALLTRIM(WK_GRN_NO);
     GRN = WK_L_GRN_NO;
     /* GRN_NO_OUT = WK_GRN_NO; */
     SUSPEND;
END ^

ALTER PROCEDURE NEXT_GRN_ORDER_LABEL RETURNS (LABEL_NO VARCHAR(20) CHARACTER SET NONE)
AS 
DECLARE VARIABLE WK_GRN_LABEL_NO CHAR(20);
DECLARE VARIABLE WK_GRN_LABEL_START INTEGER;
DECLARE VARIABLE WK_GRN_LABEL_STOP INTEGER;
DECLARE VARIABLE WK_LABEL_LENGTH INTEGER;
DECLARE VARIABLE WK_GRN_ADJUSTMENT INTEGER;
DECLARE VARIABLE WK_LEN_LABEL_NO INTEGER;
DECLARE VARIABLE WK_L_GRN_LABEL_NO  VARCHAR(20);
BEGIN
     SELECT MAX_LENGTH
     FROM PARAM
     WHERE DATA_ID = 'GRNORDER'
     INTO :WK_LABEL_LENGTH;
     WK_GRN_LABEL_NO = GEN_ID(GRN_LABEL_GEN, 1); 
     /* WK_GRN_LABEL_NO = GRN_LABEL_NO; */
     WK_GRN_LABEL_START = GEN_ID(GRN_LABEL_START, 0);
     WK_GRN_LABEL_STOP = GEN_ID(GRN_LABEL_STOP, 0);
     IF (WK_GRN_LABEL_NO > WK_GRN_LABEL_STOP) THEN
     BEGIN
        WK_GRN_ADJUSTMENT = WK_GRN_LABEL_START - WK_GRN_LABEL_STOP;
        WK_GRN_LABEL_NO = GEN_ID(GRN_LABEL_GEN, WK_GRN_ADJUSTMENT);
        WK_GRN_LABEL_NO = WK_GRN_LABEL_START;
     END
     WK_LEN_LABEL_NO = STRLEN(ALLTRIM(WK_GRN_LABEL_NO)) ;
     /* Get Label prefix */
     WK_L_GRN_LABEL_NO = '';
     /* Padding leading with 0 */
     WHILE (WK_LEN_LABEL_NO < WK_LABEL_LENGTH) DO
     BEGIN
        WK_L_GRN_LABEL_NO = WK_L_GRN_LABEL_NO || '0';
        WK_LEN_LABEL_NO = WK_LEN_LABEL_NO + 1;
     END
     WK_L_GRN_LABEL_NO = WK_L_GRN_LABEL_NO || ALLTRIM(WK_GRN_LABEL_NO);
     LABEL_NO = WK_L_GRN_LABEL_NO;
     /* GRN_LABEL_NO_OUT = WK_GRN_LABEL_NO; */
     SUSPEND;
END ^

ALTER PROCEDURE NEXT_PICK_LABEL RETURNS (LABEL_NO VARCHAR(7) CHARACTER SET NONE)
AS 
 

DECLARE VARIABLE WK_PICK_LABEL_NO CHAR(8);
DECLARE VARIABLE WK_PICK_LABEL_START INTEGER;
DECLARE VARIABLE WK_PICK_LABEL_STOP INTEGER;
DECLARE VARIABLE WK_PICK_LABEL_PREFIX INTEGER;
DECLARE VARIABLE WK_LABEL_LENGTH INTEGER;
DECLARE VARIABLE WK_PICK_ADJUSTMENT INTEGER;
DECLARE VARIABLE WK_LEN_LABEL_NO INTEGER;
DECLARE VARIABLE WK_L_PICK_LABEL_NO  VARCHAR(7);
BEGIN
     SELECT MAX_LENGTH
     FROM PARAM
     WHERE DATA_ID = 'PICK'
     INTO :WK_LABEL_LENGTH;
     WK_PICK_LABEL_NO = GEN_ID(PICK_LABEL_GEN, 1);
     WK_PICK_LABEL_START = GEN_ID(PICK_LABEL_START, 0);
     WK_PICK_LABEL_STOP = GEN_ID(PICK_LABEL_STOP, 0);
     WK_PICK_LABEL_PREFIX = GEN_ID(PICK_LABEL_PREFIX , 0);
     IF (WK_PICK_LABEL_NO > WK_PICK_LABEL_STOP) THEN
     BEGIN
        WK_PICK_ADJUSTMENT = WK_PICK_LABEL_START - WK_PICK_LABEL_STOP;
        WK_PICK_LABEL_NO = GEN_ID(PICK_LABEL_GEN, WK_PICK_ADJUSTMENT);
        WK_PICK_LABEL_PREFIX = GEN_ID(PICK_LABEL_PREFIX , 1);
        WK_PICK_LABEL_NO = WK_PICK_LABEL_START;
     END
     WK_LEN_LABEL_NO = STRLEN(ALLTRIM(WK_PICK_LABEL_NO)) + 1;
     /* Get Label prefix */
     WK_L_PICK_LABEL_NO = chr(WK_PICK_LABEL_PREFIX);
     /* Padding leading with 0 */
     WHILE (WK_LEN_LABEL_NO < WK_LABEL_LENGTH) DO
     BEGIN
        WK_L_PICK_LABEL_NO = WK_L_PICK_LABEL_NO || '0';
        WK_LEN_LABEL_NO = WK_LEN_LABEL_NO + 1;
     END
     WK_L_PICK_LABEL_NO = WK_L_PICK_LABEL_NO || ALLTRIM(WK_PICK_LABEL_NO);
     LABEL_NO = WK_L_PICK_LABEL_NO;
     SUSPEND;
END ^

ALTER PROCEDURE NEXT_PICK_QUEUE_LABEL (DEVICE_ID CHAR(2) CHARACTER SET NONE)
RETURNS (PICK_ORDER VARCHAR(10) CHARACTER SET NONE,
PRODUCED_DATE TIMESTAMP,
ZONE_DEVICE_ID CHAR(2) CHARACTER SET NONE)
AS 
 
DECLARE VARIABLE WK_DEVICE CHAR(2);
BEGIN 
   WK_DEVICE = DEVICE_ID;
   IF (WK_DEVICE IS NULL) THEN
   BEGIN
      WK_DEVICE = '';
   END
   IF (WK_DEVICE = '') THEN
   BEGIN
      FOR SELECT FIRST 10 
      PICK_ORDER, CREATE_DATE, DEVICE_ID
      FROM PICK_QUEUE
      WHERE PICK_QUEUE_STATUS = 'LB'
      ORDER BY CREATE_DATE
      INTO PICK_ORDER, PRODUCED_DATE, ZONE_DEVICE_ID
      DO
      BEGIN
         SUSPEND;
      END
   END
   ELSE
   BEGIN
      FOR SELECT FIRST 10 
      PICK_ORDER, CREATE_DATE, DEVICE_ID
      FROM PICK_QUEUE
      WHERE PICK_QUEUE_STATUS = 'LB'
      AND DEVICE_ID = :WK_DEVICE
      ORDER BY CREATE_DATE
      INTO PICK_ORDER, PRODUCED_DATE, ZONE_DEVICE_ID
      DO
      BEGIN
         SUSPEND;
      END
   END
   EXIT; 
END ^

ALTER PROCEDURE NONULLP (L_VALOR VARCHAR(1024) CHARACTER SET NONE)
RETURNS (R_VALOR VARCHAR(1024) CHARACTER SET NONE)
AS 
begin
    r_valor=:l_valor;
    if (l_valor is null) then r_valor='';
 suspend;
end ^

ALTER PROCEDURE ORDER_ITEM_STATUS_UPDATE (PICK_LABEL_NUMBER VARCHAR(40) CHARACTER SET NONE,
STATUS_CODE CHAR(3) CHARACTER SET NONE)
RETURNS (ERRORTEXT VARCHAR(80) CHARACTER SET NONE)
AS 

BEGIN
   ERRORTEXT = '';
   IF (STATUS_CODE = 'CN') THEN
   BEGIN
      UPDATE PICK_ITEM 
      SET DEVICE_ID = 'XC'
      WHERE PICK_LABEL_NO = :PICK_LABEL_NUMBER;
      UPDATE PICK_ITEM_DETAIL
      SET DEVICE_ID = 'XC'
      WHERE PICK_LABEL_NO = :PICK_LABEL_NUMBER
      AND DEVICE_ID <> 'XX' 
      AND DEVICE_ID = UPPER(DEVICE_ID);

      EXECUTE PROCEDURE ADD_TRAN(
         'XC',
         '',
         '',
         'PKCA',
         'C',
         'NOW',
         '',
         0,
         'F',
         '',
         'MASTER',
         0,
         :PICK_LABEL_NUMBER,
         'SSSSSSSSS',
         'BDCS',
         'XC');
   END
   ELSE
   BEGIN
      UPDATE PICK_ITEM SET PICK_LINE_STATUS = :STATUS_CODE
      WHERE PICK_LABEL_NO = :PICK_LABEL_NUMBER;
   END
END ^

ALTER PROCEDURE ORDER_STATUS_UPDATE (ORDER_NO VARCHAR(40) CHARACTER SET NONE,
STATUS_CODE CHAR(3) CHARACTER SET NONE)
RETURNS (ERRORTEXT VARCHAR(80) CHARACTER SET NONE)
AS 

DECLARE VARIABLE WK_CURRENT_STATUS CHAR(2);
BEGIN
   ERRORTEXT = '';
   SELECT PICK_STATUS 
   FROM PICK_ORDER 
   WHERE PICK_ORDER = :ORDER_NO
   INTO :WK_CURRENT_STATUS;
   IF ((STATUS_CODE = 'HD') OR
       (STATUS_CODE = 'OP') OR 
       (STATUS_CODE = 'DA') OR 
       (STATUS_CODE = 'CF') OR 
       (STATUS_CODE = 'DX') OR 
       (STATUS_CODE = 'DI') OR 
       (STATUS_CODE = 'UC')) THEN 
   BEGIN
      UPDATE PICK_ORDER SET PICK_STATUS = :STATUS_CODE
      WHERE PICK_ORDER = :ORDER_NO;
   END
   ELSE
   BEGIN
      IF (STATUS_CODE = 'CN') THEN
      BEGIN
         UPDATE PICK_ITEM 
         SET DEVICE_ID = 'XC'
         WHERE PICK_ORDER = :ORDER_NO;
         UPDATE PICK_ITEM_DETAIL
         SET DEVICE_ID = 'XC'
         WHERE PICK_LABEL_NO IN (SELECT PICK_LABEL_NO FROM PICK_ITEM WHERE PICK_ORDER = :ORDER_NO)
         AND DEVICE_ID <> 'XX' 
         AND DEVICE_ID = UPPER(DEVICE_ID);

         EXECUTE PROCEDURE ADD_TRAN(
            'XC',
            '',
            '',
            'PKCA',
            'C',
            'NOW',
            '',
            0,
            'F',
            '',
            'MASTER',
            0,
            '',
            'SSSSSSSSS',
            'BDCS',
            'XC');
      END
      ELSE
      BEGIN
         ERRORTEXT = 'Cannot Change Order to ' || STATUS_CODE || ' Status';
      END
   END
END ^

ALTER PROCEDURE PC_ADD_PROD_COND_STATUS (RECORD_ID INTEGER,
WH_ID CHAR(2) CHARACTER SET NONE,
LOCN_ID VARCHAR(10) CHARACTER SET NONE,
OBJECT VARCHAR(30) CHARACTER SET NONE,
TRN_TYPE VARCHAR(4) CHARACTER SET NONE,
TRN_CODE CHAR(1) CHARACTER SET NONE,
TRN_DATE TIMESTAMP,
REFERENCE VARCHAR(40) CHARACTER SET NONE,
QTY INTEGER,
PERSON_ID VARCHAR(10) CHARACTER SET NONE,
DEVICE_ID CHAR(2) CHARACTER SET NONE)
AS 
 
 
  DECLARE VARIABLE REC_EXIST INTEGER; 
  DECLARE VARIABLE CODE CHAR(1);
  DECLARE VARIABLE strAUDIT_DESC VARCHAR(70);
  DECLARE VARIABLE WK_GLOBAL VARCHAR(30);

BEGIN
  REC_EXIST = 0;
  CODE = ''; 

  /* Assign CODE value */
  IF (:TRN_TYPE = 'NIAP') THEN
  BEGIN
     CODE = 'A';
     strAUDIT_DESC = 'Add Appearance: ' || :REFERENCE;
     EXECUTE PROCEDURE GET_GLOBAL_CONDITION 1, 'F' RETURNING_VALUES :WK_GLOBAL;
     UPDATE SSN
     SET OTHER1 = :WK_GLOBAL
     WHERE SSN_ID = :OBJECT;
  END
  ELSE IF (:TRN_TYPE = 'NIOP') THEN
  BEGIN
     CODE = 'B';
     strAUDIT_DESC = 'Add Operating: ' || :REFERENCE;
     EXECUTE PROCEDURE GET_GLOBAL_CONDITION 2, 'F' RETURNING_VALUES :WK_GLOBAL;
     UPDATE SSN
     SET OTHER2 = :WK_GLOBAL
     WHERE SSN_ID = :OBJECT;
  END
  ELSE IF (:TRN_TYPE = 'NICP') THEN
  BEGIN
     CODE = 'C';
     strAUDIT_DESC = 'Add Completeness: ' || :REFERENCE;
     EXECUTE PROCEDURE GET_GLOBAL_CONDITION 3, 'F' RETURNING_VALUES :WK_GLOBAL;
     UPDATE SSN
     SET OTHER3 = :WK_GLOBAL
     WHERE SSN_ID = :OBJECT;
  END   
  ELSE IF (:TRN_TYPE = 'NIDP') THEN
  BEGIN
     CODE = 'D';
     strAUDIT_DESC = 'Add Service: ' || :REFERENCE;
     EXECUTE PROCEDURE GET_GLOBAL_CONDITION 4, 'F' RETURNING_VALUES :WK_GLOBAL;
     UPDATE SSN
     SET OTHER4 = :WK_GLOBAL
     WHERE SSN_ID = :OBJECT;
  END   
  ELSE IF (:TRN_TYPE = 'NIEP') THEN
  BEGIN
     CODE = 'E';
     strAUDIT_DESC = 'Add Other 5 Condition: ' || :REFERENCE;
     EXECUTE PROCEDURE GET_GLOBAL_CONDITION 5, 'F' RETURNING_VALUES :WK_GLOBAL;
     UPDATE SSN
     SET OTHER5 = :WK_GLOBAL
     WHERE SSN_ID = :OBJECT;
  END   
  
  /* Check if record exists */
  SELECT 1
  FROM PRODUCT_COND_STATUS
  WHERE SSN_ID = :OBJECT
  AND CODE = :CODE
  AND DESCRIPTION = :REFERENCE  
  AND ORIGINAL_TEST = 'S'  
  INTO :REC_EXIST;  

  /* if record not exists then insert */
  IF (REC_EXIST = 0) THEN
  BEGIN     
    INSERT INTO PRODUCT_COND_STATUS (SSN_ID, CODE, DESCRIPTION, ORIGINAL_TEST)
    VALUES (:OBJECT, :CODE, :REFERENCE, 'S');  
    
    /* Add transaction history */                                                                                     
    EXECUTE PROCEDURE ADD_SSN_HIST(:WH_ID, :LOCN_ID, :OBJECT, :TRN_TYPE, :TRN_CODE, :TRN_DATE,
                                   :strAUDIT_DESC, :REFERENCE, :QTY, :PERSON_ID, :DEVICE_ID);           
  END
  /* must ensure that the other1 - 5 is set to the fail condition */


  /* Update transactions table */        
  EXECUTE PROCEDURE UPDATE_TRAN (:RECORD_ID, 'T', 'Processed successfully');

END ^

ALTER PROCEDURE PC_AULO (RECORD_ID INTEGER,
WH_ID CHAR(2) CHARACTER SET NONE,
LOCN_ID VARCHAR(10) CHARACTER SET NONE,
TRN_DATE TIMESTAMP)
AS 
 
 
           
  DECLARE VARIABLE LOCN_EXIST INTEGER; 
  DECLARE VARIABLE WH_EXIST INTEGER;    
  DECLARE VARIABLE LOCN_NAME VARCHAR(50); 
BEGIN
  LOCN_EXIST = 0;   
  WH_EXIST = 0;
  LOCN_NAME = "Created during audit " || :TRN_DATE;

  /* Check if Location exists */
  LOCN_EXIST = 0;
  SELECT 1 
  FROM LOCATION
  WHERE WH_ID = :WH_ID
  AND LOCN_ID = :LOCN_ID 
  INTO :LOCN_EXIST;  
  
  /* Location exists, then update transaction and Last_Audited */
  IF (LOCN_EXIST <> 0) THEN
  BEGIN  
        /* Update transactions table */
        UPDATE TRANSACTIONS
        SET COMPLETE = 'T', ERROR_TEXT = 'Processed successfully'
        WHERE RECORD_ID = :RECORD_ID; 

       /* Update Last_Audited in LOCATION table */
       UPDATE LOCATION
       SET LAST_AUDITED_DATE = :TRN_DATE
       WHERE WH_ID = :WH_ID
       AND LOCN_ID = :LOCN_ID;
  END
  ELSE
  BEGIN
        /* Check WH_ID */     
       WH_EXIST = 0;
       SELECT 1 
       FROM WAREHOUSE
       WHERE WH_ID = :WH_ID       
       INTO :WH_EXIST; 

       IF (WH_EXIST <> 0) THEN
       BEGIN
              /* Add new Location record */
              INSERT INTO LOCATION (LOCN_ID, WH_ID, LOCN_NAME, LAST_AUDITED_DATE)
              VALUES (:LOCN_ID, :WH_ID, :LOCN_NAME, :TRN_DATE);

              /* Update transactions table */
              UPDATE TRANSACTIONS
              SET COMPLETE = 'T', ERROR_TEXT = 'New location created'
              WHERE RECORD_ID = :RECORD_ID; 
       END
       ELSE
       BEGIN
              /* Update transactions table */
              UPDATE TRANSACTIONS
              SET COMPLETE = 'F', ERROR_TEXT = 'Warehouse master not found'
              WHERE RECORD_ID = :RECORD_ID;
       END    
  END
END ^

ALTER PROCEDURE PC_AUOB (RECORD_ID INTEGER,
WH_ID CHAR(2) CHARACTER SET NONE,
LOCN_ID VARCHAR(10) CHARACTER SET NONE,
OBJECT VARCHAR(30) CHARACTER SET NONE,
TRN_TYPE VARCHAR(4) CHARACTER SET NONE,
TRN_CODE CHAR(1) CHARACTER SET NONE,
TRN_DATE TIMESTAMP,
REFERENCE VARCHAR(40) CHARACTER SET NONE,
QTY INTEGER,
PERSON_ID VARCHAR(10) CHARACTER SET NONE,
DEVICE_ID CHAR(2) CHARACTER SET NONE,
INSTANCE_ID VARCHAR(10) CHARACTER SET NONE)
AS 
DECLARE VARIABLE strWH_ID CHAR(2); 
  DECLARE VARIABLE strINSTANCE VARCHAR(10); 
  DECLARE VARIABLE strSSN VARCHAR(20);  
  DECLARE VARIABLE strLOCN_ID VARCHAR(10);  
  DECLARE VARIABLE strGRN VARCHAR(40);  
  DECLARE VARIABLE strCurrentGRN VARCHAR(40);  
  DECLARE VARIABLE strNewGRN VARCHAR(40);  
  DECLARE VARIABLE strAUDIT_DESC VARCHAR(40); 
  DECLARE VARIABLE REC_ID INTEGER;    
  DECLARE VARIABLE LOCN_NAME VARCHAR(50); 
  DECLARE VARIABLE strLOCN_exists INTEGER;  
  DECLARE VARIABLE Currentqty INTEGER;  
  DECLARE VARIABLE diff_qty INTEGER;  
  DECLARE VARIABLE last_date TIMESTAMP;  
  DECLARE VARIABLE WK_RESPONSE_FINAL VARCHAR(70); 
DECLARE VARIABLE SSN_ID INTEGER;
DECLARE VARIABLE P_SSN_ID INTEGER;
DECLARE VARIABLE W_SSN_ID VARCHAR(20);
DECLARE VARIABLE I_SSN_ID VARCHAR(20);
DECLARE VARIABLE LEN_SSN_ID INTEGER;
DECLARE VARIABLE I_LEN_SSN_ID INTEGER;
DECLARE VARIABLE SSN_LENGTH INTEGER;
DECLARE VARIABLE WK_GENERATE_SSN_METHOD VARCHAR(25);
DECLARE VARIABLE WK_ISSN_ID INTEGER;
  
BEGIN
    strWH_ID = '';
    strINSTANCE = '';
    strSSN = '';
    strWH_ID = '';
    strLOCN_ID = '';   
    strGRN = '';
    strAUDIT_DESC = '';  

    /* Check trasaction code */
    IF (:TRN_CODE = 'P') THEN
    BEGIN
       /* Update transactions table */               
       EXECUTE PROCEDURE UPDATE_TRAN (:RECORD_ID, 'F', 'Invalid code');
       EXIT;
    END 

    /* Assign GRN */
    IF (:TRN_TYPE = 'NIID') THEN
    BEGIN
       strGRN = :REFERENCE;
    END
    
    strLOCN_exists = 0;
    SELECT 1 FROM LOCATION 
    WHERE WH_ID = :WH_ID AND LOCN_ID = :LOCN_ID 
    INTO :strLOCN_exists;
    IF (strLOCN_exists = 0) THEN /* Location not found */
    BEGIN
        LOCN_NAME = LOCN_ID || :TRN_DATE;
        /* Add new Location record */
        INSERT INTO LOCATION (LOCN_ID, WH_ID, LOCN_NAME , LAST_UPDATE_DATE, LAST_UPDATE_BY )
        VALUES (:LOCN_ID, :WH_ID, :LOCN_NAME, :TRN_DATE, :PERSON_ID);
    END

    /* Check if warehouse exists */
    SELECT WH_ID, INSTANCE_ID 
    FROM WAREHOUSE
    WHERE WH_ID = :WH_ID
    INTO :strWH_ID, :strINSTANCE;

    /* Check warehouse*/
    IF (strWH_ID <> '') THEN
    BEGIN
          /* Check instance */
          /* IF (strINSTANCE = :INSTANCE_ID) THEN  */ 
          BEGIN
                /* Check ObjectLocation */
  /* please check issn first */
  /* since it may not be in ssn table then update
  original_ssn */
             IF (OBJECT IS NULL) THEN
             BEGIN
                OBJECT = '';
             END
             IF (OBJECT = '') THEN
             BEGIN
                /* no object so create it */
                /* Get length for Barcode */
                EXECUTE PROCEDURE GET_BARCODE_LENGTH RETURNING_VALUES SSN_LENGTH;
             
               SELECT GENERATE_SSN_METHOD FROM CONTROL INTO :WK_GENERATE_SSN_METHOD;
               /* IF ((WK_GENERATE_SSN_METHOD IS NULL) OR (WK_GENERATE_SSN_METHOD <> '|GRN=4|LINE=2|SUFFIX=2,3|')) THEN */
               BEGIN
                SSN_ID = GEN_ID(ISSN_SSN_ID, 1);
                P_SSN_ID = SSN_ID - 1;
                LEN_SSN_ID = STRLEN(P_SSN_ID);
                   
                W_SSN_ID = '';
                   /* Padding leading with 0 */
                WHILE (LEN_SSN_ID < :SSN_LENGTH) DO
                BEGIN
                    W_SSN_ID = W_SSN_ID || '0';
                    LEN_SSN_ID = LEN_SSN_ID + 1;
                 END
                 W_SSN_ID = W_SSN_ID || P_SSN_ID;
          
                 OBJECT = W_SSN_ID;
               END
          
             END
  SELECT SD.ORIGINAL_SSN, SD.WH_ID, SD.LOCN_ID, SN.GRN, SD.CURRENT_QTY, SD.INTO_DATE
  FROM ISSN SD JOIN SSN SN ON SN.SSN_ID = SD.ORIGINAL_SSN
                WHERE SD.SSN_ID = :OBJECT
                INTO :strSSN, :strWH_ID, :strLOCN_ID, :strCurrentGRN, :Currentqty, :last_date;
                
                /* Check SSN */
                IF (strSSN = '') THEN
                BEGIN
                /* Object not found */
                       /* Add SSN */
                       INSERT INTO SSN (SSN_ID, WH_ID, LOCN_ID, INTO_DATE, AUDITED, GRN, AUDIT_DATE, AUDITED_QTY, CURRENT_QTY)
                       VALUES (:OBJECT, :WH_ID, :LOCN_ID, :TRN_DATE, 'N', :strGRN, :TRN_DATE, :QTY, :QTY);
                       INSERT INTO ISSN (SSN_ID, ORIGINAL_SSN, WH_ID, LOCN_ID, CURRENT_QTY, AUDITED)
                       VALUES (:OBJECT, :OBJECT, :WH_ID, :LOCN_ID, :QTY, 'N');

                       strAUDIT_DESC = 'New object record created during audit';
                       strSSN = OBJECT;
                       strCurrentGRN = strGRN;
                END
                ELSE
                BEGIN
                      IF (strGRN = '') THEN
                      BEGIN
                            strNewGRN = strCurrentGRN;
                      END
                      ELSE
                      BEGIN
                            strNewGRN = strGRN;
                      END
                      IF (last_date IS NULL) THEN
                      BEGIN
                         last_date = CAST('JAN-01-2000' AS TIMESTAMP);
                      END
                      diff_qty = QTY - Currentqty;
                      IF ((strWH_ID <> :WH_ID) OR (strLOCN_ID <> :LOCN_ID)) THEN
                      BEGIN          
                            /* item found in different location, update object relocated */
                            IF (last_date < TRN_DATE) THEN
                            BEGIN
                                  UPDATE ISSN
                                  SET PREV_PREV_WH_ID = PREV_WH_ID, 
                                      PREV_PREV_LOCN_ID = PREV_LOCN_ID,
                                      PREV_WH_ID = WH_ID,
                                      PREV_LOCN_ID = LOCN_ID,
                                      WH_ID = :WH_ID, 
                                      LOCN_ID = :LOCN_ID, 
                                      INTO_DATE = :TRN_DATE,
                                      AUDIT_DATE = :TRN_DATE,
                                      CURRENT_QTY = :QTY,
                                      AUDITED = 'C'
                                  WHERE SSN_ID = :OBJECT;
                                  IF (OBJECT = strSSN) THEN
                                  BEGIN
                                        UPDATE SSN
                                        SET WH_ID = :WH_ID, LOCN_ID = :LOCN_ID, INTO_DATE = :TRN_DATE,
                                            AUDITED = 'C', GRN = :strNewGRN, AUDIT_DATE = :TRN_DATE, AUDITED_QTY = :QTY, CURRENT_QTY = CURRENT_QTY + :diff_qty
                                        WHERE SSN_ID = :strSSN;
                                  END
                                  ELSE
                                  BEGIN
                                        UPDATE SSN
                                        SET CURRENT_QTY = CURRENT_QTY + :diff_qty  
                                        WHERE SSN_ID = :strSSN;
                                  END
                                  strAUDIT_DESC = 'Item found in different location';  
                            END
                            ELSE
                            BEGIN
                                  strAUDIT_DESC = 'Item found in different location Past';  
                            END
                      END
                      ELSE
                      BEGIN                           
                            /* object found in expected location, upload object found */
                            IF (last_date < TRN_DATE) THEN
                            BEGIN
                                  UPDATE ISSN
                                  SET INTO_DATE = :TRN_DATE,
                                      AUDIT_DATE = :TRN_DATE,
                                      CURRENT_QTY = :QTY,
                                      AUDITED = 'F'
                                  WHERE SSN_ID = :OBJECT;
                                  IF (OBJECT = strSSN) THEN
                                  BEGIN
                                        UPDATE SSN
                                        SET INTO_DATE = :TRN_DATE, AUDITED = 'F',  
                                            GRN = :strNewGRN, AUDIT_DATE = :TRN_DATE, AUDITED_QTY = :QTY, CURRENT_QTY = CURRENT_QTY + :diff_qty
                                        WHERE SSN_ID = :strSSN;
                                  END
                                  ELSE
                                  BEGIN
                                        UPDATE SSN
                                        SET CURRENT_QTY = CURRENT_QTY + :diff_qty
                                        WHERE SSN_ID = :strSSN;
                                  END
                                  strAUDIT_DESC = 'Item found in correct location';
                            END
                            ELSE
                            BEGIN

                                  strAUDIT_DESC = 'Item found in correct location Past';
                            END
                      END
                END

               /* Update transactions table */               
               IF (TRN_CODE = 'C') THEN
               BEGIN
                  WK_RESPONSE_FINAL = :OBJECT || '|' || 'Processed successfully';
                  EXECUTE PROCEDURE UPDATE_TRAN (:RECORD_ID, 'T', :WK_RESPONSE_FINAL);
               END
               ELSE
               BEGIN
                  IF (TRN_CODE = 'A') THEN
                  BEGIN
                     EXECUTE PROCEDURE UPDATE_TRAN (:RECORD_ID, 'T', 'Processed successfully'); 
                  END
                  ELSE
                  BEGIN
                     EXECUTE PROCEDURE UPDATE_TRAN (:RECORD_ID, 'T', 'Processed successfully'); 
                  END
               END
               
               /* Add transaction history */                                                                                     
               EXECUTE PROCEDURE ADD_SSN_HIST(:WH_ID, :LOCN_ID, :strSSN, :TRN_TYPE, :TRN_CODE, :TRN_DATE,
                                              :strAUDIT_DESC, :REFERENCE, :QTY,  :PERSON_ID, :DEVICE_ID);
          END
    END
    ELSE
    BEGIN
       EXECUTE PROCEDURE UPDATE_TRAN (:RECORD_ID, 'F', 'No Warehouse'); 
    END
END ^

ALTER PROCEDURE PC_DELETE_ONE_PROD_COND_STATUS (RECORD_ID INTEGER,
WH_ID CHAR(2) CHARACTER SET NONE,
LOCN_ID VARCHAR(10) CHARACTER SET NONE,
OBJECT VARCHAR(30) CHARACTER SET NONE,
TRN_TYPE VARCHAR(4) CHARACTER SET NONE,
TRN_CODE CHAR(1) CHARACTER SET NONE,
TRN_DATE TIMESTAMP,
REFERENCE VARCHAR(40) CHARACTER SET NONE,
QTY INTEGER,
PERSON_ID VARCHAR(10) CHARACTER SET NONE,
DEVICE_ID CHAR(2) CHARACTER SET NONE)
AS 
 
 
  DECLARE VARIABLE CODE CHAR(1);
  DECLARE VARIABLE strAUDIT_DESC VARCHAR(50);
  DECLARE VARIABLE WK_GLOBAL VARCHAR(30);
  DECLARE VARIABLE WK_FAIL_CNT INTEGER;

BEGIN
  
  CODE = ''; 

  /* Assign CODE value */
  IF (:TRN_TYPE = 'NXAP') THEN
  BEGIN
     CODE = 'A';
     strAUDIT_DESC = 'Delete Appearance: ' || :REFERENCE;
  END
  ELSE IF (:TRN_TYPE = 'NXOP') THEN
  BEGIN
     CODE = 'B';
     strAUDIT_DESC = 'Delete Operating: ' || :REFERENCE;
  END
  ELSE IF (:TRN_TYPE = 'NXCP') THEN
  BEGIN
     CODE = 'C';
     strAUDIT_DESC = 'Delete Completeness: ' || :REFERENCE;
  END   
  ELSE IF (:TRN_TYPE = 'NXDP') THEN
  BEGIN
     CODE = 'D';
     strAUDIT_DESC = 'Delete Service: ' || :REFERENCE;
  END   
  ELSE IF (:TRN_TYPE = 'NXEP') THEN
  BEGIN
     CODE = 'C';
     strAUDIT_DESC = 'Delete Other 5: ' || :REFERENCE;
  END   
  
   
    /* Delete record */
    DELETE FROM PRODUCT_COND_STATUS
    WHERE SSN_ID = :OBJECT
    AND   CODE = :CODE
    AND   DESCRIPTION = :REFERENCE 
    AND   ORIGINAL_TEST = 'S';
    
  IF (:TRN_TYPE = 'NXAP') THEN
  BEGIN
     WK_FAIL_CNT = 0;
     SELECT COUNT(*) FROM PRODUCT_COND_STATUS
     WHERE SSN_ID = :OBJECT
     AND   CODE = :CODE
     AND   ORIGINAL_TEST = 'S'
     INTO :WK_FAIL_CNT;
     IF (WK_FAIL_CNT = 0) THEN
     BEGIN
        EXECUTE PROCEDURE GET_GLOBAL_CONDITION 1, 'P' RETURNING_VALUES :WK_GLOBAL;
        UPDATE SSN
        SET OTHER1 = :WK_GLOBAL
        WHERE SSN_ID = :OBJECT;
     END
     ELSE
     BEGIN
        EXECUTE PROCEDURE GET_GLOBAL_CONDITION 1, 'F' RETURNING_VALUES :WK_GLOBAL;
        UPDATE SSN
        SET OTHER1 = :WK_GLOBAL
        WHERE SSN_ID = :OBJECT;
     END
  END
  ELSE IF (:TRN_TYPE = 'NXOP') THEN
  BEGIN
     WK_FAIL_CNT = 0;
     SELECT COUNT(*) FROM PRODUCT_COND_STATUS
     WHERE SSN_ID = :OBJECT
     AND   CODE = :CODE
     AND   ORIGINAL_TEST = 'S'
     INTO :WK_FAIL_CNT;
     IF (WK_FAIL_CNT = 0) THEN
     BEGIN
        EXECUTE PROCEDURE GET_GLOBAL_CONDITION 2, 'P' RETURNING_VALUES :WK_GLOBAL;
        UPDATE SSN
        SET OTHER2 = :WK_GLOBAL
        WHERE SSN_ID = :OBJECT;
     END
     ELSE
     BEGIN
        EXECUTE PROCEDURE GET_GLOBAL_CONDITION 2, 'F' RETURNING_VALUES :WK_GLOBAL;
        UPDATE SSN
        SET OTHER2 = :WK_GLOBAL
        WHERE SSN_ID = :OBJECT;
     END
  END
  ELSE IF (:TRN_TYPE = 'NXCP') THEN
  BEGIN
     WK_FAIL_CNT = 0;
     SELECT COUNT(*) FROM PRODUCT_COND_STATUS
     WHERE SSN_ID = :OBJECT
     AND   CODE = :CODE
     AND   ORIGINAL_TEST = 'S'
     INTO :WK_FAIL_CNT;
     IF (WK_FAIL_CNT = 0) THEN
     BEGIN
        EXECUTE PROCEDURE GET_GLOBAL_CONDITION 3, 'P' RETURNING_VALUES :WK_GLOBAL;
        UPDATE SSN
        SET OTHER3 = :WK_GLOBAL
        WHERE SSN_ID = :OBJECT;
     END
     ELSE
     BEGIN
        EXECUTE PROCEDURE GET_GLOBAL_CONDITION 3, 'F' RETURNING_VALUES :WK_GLOBAL;
        UPDATE SSN
        SET OTHER3 = :WK_GLOBAL
        WHERE SSN_ID = :OBJECT;
     END
  END   
  ELSE IF (:TRN_TYPE = 'NXDP') THEN
  BEGIN
     WK_FAIL_CNT = 0;
     SELECT COUNT(*) FROM PRODUCT_COND_STATUS
     WHERE SSN_ID = :OBJECT
     AND   CODE = :CODE
     AND   ORIGINAL_TEST = 'S'
     INTO :WK_FAIL_CNT;
     IF (WK_FAIL_CNT = 0) THEN
     BEGIN
        EXECUTE PROCEDURE GET_GLOBAL_CONDITION 4, 'P' RETURNING_VALUES :WK_GLOBAL;
        UPDATE SSN
        SET OTHER4 = :WK_GLOBAL
        WHERE SSN_ID = :OBJECT;
     END
     ELSE
     BEGIN
        EXECUTE PROCEDURE GET_GLOBAL_CONDITION 4, 'F' RETURNING_VALUES :WK_GLOBAL;
        UPDATE SSN
        SET OTHER4 = :WK_GLOBAL
        WHERE SSN_ID = :OBJECT;
     END
  END   
  ELSE IF (:TRN_TYPE = 'NXEP') THEN
  BEGIN
     WK_FAIL_CNT = 0;
     SELECT COUNT(*) FROM PRODUCT_COND_STATUS
     WHERE SSN_ID = :OBJECT
     AND   CODE = :CODE
     AND   ORIGINAL_TEST = 'S'
     INTO :WK_FAIL_CNT;
     IF (WK_FAIL_CNT = 0) THEN
     BEGIN
        EXECUTE PROCEDURE GET_GLOBAL_CONDITION 5, 'P' RETURNING_VALUES :WK_GLOBAL;
        UPDATE SSN
        SET OTHER5 = :WK_GLOBAL
        WHERE SSN_ID = :OBJECT;
     END
     ELSE
     BEGIN
        EXECUTE PROCEDURE GET_GLOBAL_CONDITION 5, 'F' RETURNING_VALUES :WK_GLOBAL;
        UPDATE SSN
        SET OTHER5 = :WK_GLOBAL
        WHERE SSN_ID = :OBJECT;
     END
  END   
  
    /* Add transaction history */                                                                                     
    EXECUTE PROCEDURE ADD_SSN_HIST(:WH_ID, :LOCN_ID, :OBJECT, :TRN_TYPE, :TRN_CODE, :TRN_DATE,
                                   :strAUDIT_DESC, :REFERENCE, :QTY, :PERSON_ID, :DEVICE_ID);           
  
    /* Update transactions table */        
    EXECUTE PROCEDURE UPDATE_TRAN (:RECORD_ID, 'T', 'Processed successfully');

  SUSPEND;
END ^

ALTER PROCEDURE PC_DSDX (RECORD_ID INTEGER,
WH_ID CHAR(2) CHARACTER SET NONE,
LOCN_ID VARCHAR(10) CHARACTER SET NONE,
OBJECT VARCHAR(30) CHARACTER SET NONE,
TRN_TYPE VARCHAR(4) CHARACTER SET NONE,
TRN_CODE CHAR(1) CHARACTER SET NONE,
TRN_DATE TIMESTAMP,
REFERENCE VARCHAR(40) CHARACTER SET NONE,
QTY INTEGER,
PERSON_ID VARCHAR(10) CHARACTER SET NONE,
DEVICE_ID CHAR(2) CHARACTER SET NONE,
SUB_LOCN VARCHAR(10) CHARACTER SET NONE)
AS 
DECLARE VARIABLE WK_CONSIGNMENT VARCHAR(40);
DECLARE VARIABLE WK_DESPATCH INTEGER;
DECLARE VARIABLE WK_SSN VARCHAR(20);
DECLARE VARIABLE WK_SSN_SSN VARCHAR(20);
DECLARE VARIABLE WK_LABEL VARCHAR(8);
DECLARE VARIABLE WK_SALES_PRICE NUMERIC(9, 3);
DECLARE VARIABLE WK_WARRANTY VARCHAR(50);
DECLARE VARIABLE WK_DETAIL_STATUS CHAR(2);
DECLARE VARIABLE WK_DAYS INTEGER;
DECLARE VARIABLE WK_EXPIRY_DATE TIMESTAMP;
DECLARE VARIABLE WK_QTY_TOGET INTEGER;
DECLARE VARIABLE WK_LOCN VARCHAR(10);
DECLARE VARIABLE WK_REASON VARCHAR(70);
DECLARE VARIABLE WK_DETAIL_ID INTEGER;
DECLARE VARIABLE WK_FOUND INTEGER;
DECLARE VARIABLE WK_PICKED_QTY INTEGER;
DECLARE VARIABLE WK_ORDER_QTY INTEGER;
DECLARE VARIABLE WK_PRICE_EXT INTEGER;
DECLARE VARIABLE WK_ORDER VARCHAR(15);
DECLARE VARIABLE WK_ORDER_TYPE CHAR(2);
DECLARE VARIABLE WK_RETURN_DATE TIMESTAMP;
DECLARE VARIABLE WK_PERSON VARCHAR(10);
DECLARE VARIABLE WK_WH_ID CHAR(2);
DECLARE VARIABLE WK_INSTRUCTION1 VARCHAR(8196);
DECLARE VARIABLE WK_APPROVED_BY VARCHAR(10);
DECLARE VARIABLE WK_ORDER_RETURN_DATE TIMESTAMP;
DECLARE VARIABLE LO_NUMBER INTEGER;
DECLARE VARIABLE LOAN_TYPE VARCHAR(2);
DECLARE VARIABLE LO_LINE VARCHAR(4);
DECLARE VARIABLE WK_PI_PROD_ID VARCHAR(30);
DECLARE VARIABLE WK_PI_SSN_ID VARCHAR(20);
DECLARE VARIABLE LOAN_QTY Integer;
DECLARE VARIABLE LOAN_COMMENTS VARCHAR(255);
DECLARE VARIABLE WK_DESPATCH_DATE TIMESTAMP;
DECLARE VARIABLE WK_GM_MESSAGE VARCHAR(10);
DECLARE VARIABLE WK_T4_DELIM CHAR(1);
DECLARE VARIABLE WK_T4_TRAN_DATA VARCHAR(1024);
DECLARE VARIABLE WK_T4_SOURCE VARCHAR(512);
DECLARE VARIABLE WK_NEW_RECORD INTEGER;
DECLARE VARIABLE WK_CN_PRIORITY SMALLINT;
DECLARE VARIABLE WK_DATE TIMESTAMP;
DECLARE VARIABLE WK_DO_UCIS CHAR(1);
DECLARE VARIABLE WK_DO_EXPORT_DESPATCH CHAR(1);
DECLARE VARIABLE WK_PRINTER CHAR(2);
DECLARE VARIABLE WK_PARTIAL_PICK CHAR(2);
DECLARE VARIABLE WK_DSDX_DETAIL_STATUS VARCHAR(40);
DECLARE VARIABLE WK_IS_WH_ID CHAR(2);
DECLARE VARIABLE WK_LOCN_MOVEABLE CHAR(1);

BEGIN 
 /* 
           reference is connote

 for SO type Orders
        in DSDX calc warranty date based on warranty_term and 
  the days specified in the table warranty 
  and save the sales price from the pick item into the ssn

  if the current_qty <> 0
   move current qty to zero and prev_qty has the current_qty
  move to XD repository and status to DX

  check pick items complete
  if not complete must create a new line for it

 for TO type Orders
        in DSDX create/update loan order from the pick_order  

  update the loan fields in the ssn

  move to repository of order (via person to repositorys person)
 location 'INTRANST'
 and status to DI

  check pick items complete
  if not complete must create a new line for it
*/

    WK_DESPATCH_DATE = ZEROTIME(TRN_DATE);
    WK_DATE = TRN_DATE;
    WK_CN_PRIORITY = 0;
    SELECT DEFAULT_PICK_PRIORITY, 
       SEND_UCIS_V4, 
       EXPORT_DESPATCH, 
       EXPORT_DESPATCH_PRINTER,
       PICK_DETAIL_DSDX_STATUS 
    FROM CONTROL 
    INTO :WK_CN_PRIORITY, 
       :WK_DO_UCIS, 
       :WK_DO_EXPORT_DESPATCH, 
       :WK_PRINTER,
       :WK_DSDX_DETAIL_STATUS;
    /* must get the consignment */
    WK_CONSIGNMENT = REFERENCE;
    FOR SELECT DESPATCH_ID 
        FROM PICK_DESPATCH 
        WHERE AWB_CONSIGNMENT_NO = :WK_CONSIGNMENT
          AND DESPATCH_STATUS = 'DC'
        INTO :WK_DESPATCH
    DO
    BEGIN
       FOR SELECT PID.SSN_ID, PID.PICK_LABEL_NO , PI.WARRANTY_TERM, PID.PICK_DETAIL_STATUS, PID.PICK_DETAIL_ID, PI.PICKED_QTY, PI.PICK_ORDER_QTY, PO.PICK_ORDER_TYPE
           FROM PICK_ITEM_DETAIL PID
           JOIN PICK_ITEM PI ON PI.PICK_LABEL_NO = PID.PICK_LABEL_NO
           JOIN PICK_ORDER PO ON PO.PICK_ORDER = PI.PICK_ORDER
           WHERE PID.DESPATCH_ID = :WK_DESPATCH
           INTO :WK_SSN, :WK_LABEL, :WK_WARRANTY, :WK_DETAIL_STATUS, :WK_DETAIL_ID, :WK_PICKED_QTY, :WK_ORDER_QTY, :WK_ORDER_TYPE
       DO
       BEGIN
          IF (WK_DETAIL_STATUS = 'DC') THEN
          BEGIN
             IF (WK_ORDER_TYPE = 'SO') THEN
             BEGIN
                WK_DAYS = 0;
                SELECT WARRANTY_DAYS FROM WARRANTY
                WHERE WARRANTY_CODE = :WK_WARRANTY
                INTO :WK_DAYS;
                IF (WK_DAYS IS NULL) THEN
                   WK_DAYS = 0;
                IF (WK_DAYS = 0) THEN
                   /* WK_EXPIRY_DATE = TRN_DATE; */
                   WK_EXPIRY_DATE = WK_DESPATCH_DATE;
                ELSE
                   WK_EXPIRY_DATE = ADD_TIME(:WK_DESPATCH_DATE, :WK_DAYS, 0,0,0,0);
                SELECT ORIGINAL_SSN, CURRENT_QTY,LOCN_ID FROM ISSN
                WHERE SSN_ID = :WK_SSN
                INTO :WK_SSN_SSN, :WK_QTY_TOGET, :WK_LOCN;
                /* ok now have the ssn */
                SELECT SALE_PRICE, PICK_ORDER FROM PICK_ITEM 
                WHERE PICK_LABEL_NO = :WK_LABEL
                INTO :WK_SALES_PRICE, :WK_ORDER;
   
                IF (WK_QTY_TOGET <> 0) THEN
                BEGIN
                   UPDATE ISSN SET ISSN_STATUS = 'DX',
                       PREV_PREV_WH_ID = PREV_WH_ID,
                       PREV_PREV_LOCN_ID = PREV_LOCN_ID,
                       PREV_WH_ID = WH_ID,
                       PREV_LOCN_ID = LOCN_ID,
                       WH_ID = 'XD',
                       PREV_QTY = CURRENT_QTY,
                       INTO_DATE = :TRN_DATE,
                       DESPATCHED_DATE = :WK_DESPATCH_DATE,
                       CURRENT_QTY = 0
                   WHERE SSN_ID = :WK_SSN;
                END
                ELSE
                BEGIN
                   /* zero qty item */
                   UPDATE ISSN SET ISSN_STATUS = 'DX',
                       PREV_PREV_WH_ID = PREV_WH_ID,
                       PREV_PREV_LOCN_ID = PREV_LOCN_ID,
                       PREV_WH_ID = WH_ID,
                       PREV_LOCN_ID = LOCN_ID,
                       INTO_DATE = :TRN_DATE,
                       DESPATCHED_DATE = :WK_DESPATCH_DATE,
                       WH_ID = 'XD'
                   WHERE SSN_ID = :WK_SSN;
                END
                WK_PRICE_EXT = WK_SALES_PRICE * WK_QTY_TOGET;
                WK_FOUND = 0;
                SELECT 1 FROM SSN 
                WHERE SSN_ID = :WK_SSN_SSN
                  AND DISPOSAL_PRICE IS NULL
                INTO :WK_FOUND;
                IF (WK_FOUND IS NULL) THEN
                   WK_FOUND = 0;
                IF (WK_FOUND = 0) THEN
                BEGIN
                   UPDATE SSN SET DISPOSAL_PRICE = DISPOSAL_PRICE + :WK_PRICE_EXT,
                               WARRANTY_EXPIRY_DATE = :WK_EXPIRY_DATE,
                               CURRENT_QTY = CURRENT_QTY - :WK_QTY_TOGET
                   WHERE SSN_ID = :WK_SSN_SSN;
                END
                ELSE
                BEGIN
                   UPDATE SSN SET DISPOSAL_PRICE = :WK_PRICE_EXT,
                               WARRANTY_EXPIRY_DATE = :WK_EXPIRY_DATE,
                               CURRENT_QTY = CURRENT_QTY - :WK_QTY_TOGET
                   WHERE SSN_ID = :WK_SSN_SSN;
                END
                WK_REASON = 'Despatched ' || :WK_QTY_TOGET || ' to User ' || :PERSON_ID || ' ISSN ' || :WK_SSN ;
                IF (WK_SSN_SSN IS NOT NULL) THEN
                BEGIN
                   EXECUTE PROCEDURE ADD_SSN_HIST('XD', :WK_LOCN, :WK_SSN_SSN, 
                          :TRN_TYPE, :TRN_CODE, :TRN_DATE,
                          :WK_REASON, 'ON TO TRUCK' , :WK_QTY_TOGET, :PERSON_ID, :DEVICE_ID); 
                END
             END /* end of order type SO */
             ELSE
             BEGIN
                IF (WK_ORDER_TYPE = 'TO') THEN
                BEGIN
                   SELECT ORIGINAL_SSN, CURRENT_QTY,LOCN_ID, WH_ID 
                   FROM ISSN
                   WHERE SSN_ID = :WK_SSN
                   INTO :WK_SSN_SSN, :WK_QTY_TOGET, :WK_LOCN, :WK_IS_WH_ID;
                   WK_LOCN_MOVEABLE = 'F';
                   SELECT MOVEABLE_LOCN
                   FROM LOCATION
                   WHERE WH_ID = :WK_IS_WH_ID
                   AND   LOCN_ID = :WK_LOCN
                   INTO :WK_LOCN_MOVEABLE;
                   IF (WK_LOCN_MOVEABLE IS NULL) THEN
                   BEGIN
                      WK_LOCN_MOVEABLE = 'F';
                   END
                   /* ok now have the ssn */
                   SELECT RETURN_DATE, PICK_ORDER FROM PICK_ITEM 
                   WHERE PICK_LABEL_NO = :WK_LABEL
                   INTO :WK_RETURN_DATE, :WK_ORDER;
                   SELECT PERSON_ID FROM PICK_ORDER 
                   WHERE PICK_ORDER = :WK_ORDER
                   INTO :WK_PERSON;
                   WK_WH_ID = NULL;
                   SELECT D_WH_ID FROM PICK_ORDER
                   WHERE PICK_ORDER = :WK_ORDER
                   INTO :WK_WH_ID;
                   IF (WK_WH_ID IS NULL) THEN
                   BEGIN
                      SELECT FIRST 1 WH_ID FROM WAREHOUSE
                      WHERE  PERSON_ID = :WK_PERSON
                      INTO :WK_WH_ID;
                      UPDATE PICK_ORDER 
                      SET D_WH_ID = :WK_WH_ID
                      WHERE PICK_ORDER = :WK_ORDER;
                   END
                   /* need wk_days as diff between wk_return_date
                      and trn_date */
                   WK_DAYS = DIFFDATE(TRN_DATE, WK_RETURN_DATE, 4);
                   /* if despatch location is a mobile then leave in that location
                         and shift the location into the new warehouse 
                      otherwise do the transfer */
                   /* update location */
                   IF (WK_LOCN_MOVEABLE = 'T') THEN
                   BEGIN
                      UPDATE LOCATION SET CURRENT_WH_ID = :WK_WH_ID
                      WHERE WH_ID = :WK_IS_WH_ID
                      AND   LOCN_ID = :WK_LOCN;
                      UPDATE ISSN SET ISSN_STATUS = 'DI'
                      WHERE SSN_ID = :WK_SSN;
                   END
                   ELSE
                   BEGIN
                      UPDATE ISSN SET ISSN_STATUS = 'DI',
                          PREV_PREV_WH_ID = PREV_WH_ID,
                          PREV_PREV_LOCN_ID = PREV_LOCN_ID,
                          PREV_WH_ID = WH_ID,
                          PREV_LOCN_ID = LOCN_ID,
                          WH_ID = :WK_WH_ID,
                          LOCN_ID = 'INTRANST'
                      WHERE SSN_ID = :WK_SSN;
                   END
                   UPDATE SSN SET 
                               LEASE_EXPIRY_DATE = :WK_RETURN_DATE,
                               LOAN_PERIOD = 'D',
                               LOAN_PERIOD_NO = :WK_DAYS,
                               LOAN_STATUS = 'L'
                   WHERE SSN_ID = :WK_SSN_SSN;
                   WK_REASON = 'Despatched ' || :WK_QTY_TOGET || ' to User ' || :PERSON_ID || ' ISSN ' || :WK_SSN ;
                   IF (WK_SSN_SSN IS NOT NULL) THEN
                   BEGIN
                      EXECUTE PROCEDURE ADD_SSN_HIST(:WK_WH_ID, 'INTRANST', :WK_SSN_SSN, 
                             :TRN_TYPE, :TRN_CODE, :TRN_DATE,
                             :WK_REASON, 'ON TO TRUCK' , :WK_QTY_TOGET, :PERSON_ID, :DEVICE_ID); 
                   END
                   /* check loan order */
                   SELECT LOAN_ORDER_NO FROM LOAN_ORDER
                   WHERE PICK_ORDER = :WK_ORDER
                   INTO :LO_NUMBER;
                   IF (LO_NUMBER IS NULL) THEN
                   BEGIN
                      SELECT SPECIAL_INSTRUCTIONS1, APPROVED_DESP_BY, RETURN_DATE
                      FROM PICK_ORDER
                      WHERE PICK_ORDER = :WK_ORDER
                      INTO :WK_INSTRUCTION1, :WK_APPROVED_BY, :WK_ORDER_RETURN_DATE;
                     
                      EXECUTE PROCEDURE GET_LOAN_ID RETURNING_VALUES :LO_NUMBER;
                      LOAN_TYPE = 'TO'; /* Transfer Order */
                      INSERT INTO LOAN_ORDER (LOAN_ORDER_NO, LOAN_ORDER_DATE, STATUS, JOB_NO, COMMENTS, PICK_ORDER, RETURN_DATE, USER_ID, LOAN_TYPE)
                      VALUES (:LO_NUMBER, :TRN_DATE, 'OP', :WK_ORDER, :WK_INSTRUCTION1, :WK_ORDER, :WK_ORDER_RETURN_DATE, :WK_APPROVED_BY, :LOAN_TYPE);
                   END
                   SELECT PICK_ORDER_LINE_NO, PROD_ID, SSN_ID, PICKED_QTY, SPECIAL_INSTRUCTIONS1 
                   FROM PICK_ITEM WHERE PICK_LABEL_NO = :WK_LABEL
                   INTO :LO_LINE, :WK_PI_PROD_ID, :WK_PI_SSN_ID, :LOAN_QTY, :LOAN_COMMENTS;
                   /* check loan line  */
                   WK_FOUND = 0;
                   SELECT 1 FROM LOAN_ORDER_LINE
                   WHERE LOAN_ORDER_NO = :LO_NUMBER
                   AND LOAN_ORDER_LINE_NO = :LO_LINE
                   INTO :WK_FOUND;
                   IF ((WK_FOUND IS NULL) OR (WK_FOUND = 0)) THEN
                   BEGIN
                      INSERT INTO LOAN_ORDER_LINE (LOAN_ORDER_NO, LOAN_ORDER_LINE_NO, SSN_ID, STATUS, PROD_ID, LOAN_QTY, LOAN_TYPE, LOAN_RETURN_DATE, COMMENTS)
                      VALUES (:LO_NUMBER, :LO_LINE, :WK_PI_SSN_ID, 'OP', :WK_PI_PROD_ID, :LOAN_QTY, 'TO', :WK_RETURN_DATE, :LOAN_COMMENTS );
                   END
                   /* check loan history  */
                   WK_FOUND = 0;
                   SELECT 1 FROM LOAN_HISTORY
                   WHERE LOAN_ORDER_NO = :LO_NUMBER
                   AND LOAN_ORDER_LINE_NO = :LO_LINE
                   AND SSN_ID = :WK_PI_SSN_ID
                   INTO :WK_FOUND;
                   IF ((WK_FOUND IS NULL) OR (WK_FOUND = 0)) THEN
                   BEGIN
                      INSERT INTO LOAN_HISTORY (LOAN_ORDER_NO, LOAN_ORDER_LINE_NO, SSN_ID, STATUS, PROD_ID, LOAN_QTY, LOAN_TYPE, RETURN_DATE, COMMENTS)
                      VALUES (:LO_NUMBER, :LO_LINE, :WK_PI_SSN_ID, 'OP', :WK_PI_PROD_ID, :LOAN_QTY, 'TO', :WK_RETURN_DATE, :LOAN_COMMENTS );
                   END
                   ELSE
                   BEGIN
                      UPDATE LOAN_HISTORY SET 
                         STATUS = 'OP', 
                         PROD_ID = :WK_PI_PROD_ID, 
                         LOAN_QTY = :LOAN_QTY, 
                         LOAN_TYPE = 'TO', 
                         RETURN_DATE = :WK_RETURN_DATE, 
                         COMMENTS = :LOAN_COMMENTS 
                      WHERE LOAN_ORDER_NO = :LO_NUMBER
                      AND LOAN_ORDER_LINE_NO = :LO_LINE
                      AND SSN_ID = :WK_PI_SSN_ID;
                   END
                END /* end of order type 'TO' */
             END /* end order order types */
             /* update detail status to stop rerun */
/*
             UPDATE PICK_ITEM_DETAIL 
                    SET PICK_DETAIL_STATUS = 'DX',
                    DEVICE_ID = 'XX'
             WHERE PICK_DETAIL_ID = :WK_DETAIL_ID;
*/
             UPDATE PICK_ITEM_DETAIL 
                    SET PICK_DETAIL_STATUS = :WK_DSDX_DETAIL_STATUS,
                    DEVICE_ID = 'XX'
             WHERE PICK_DETAIL_ID = :WK_DETAIL_ID;
             /* check despatched all of line */
             WK_FOUND = 0;
             SELECT FIRST 1 1 FROM PICK_ITEM_DETAIL
             WHERE PICK_LABEL_NO = :WK_LABEL
               AND PICK_DETAIL_STATUS <> 'DX'
               AND PICK_DETAIL_STATUS <> 'DL'
               AND PICK_DETAIL_STATUS <> 'Dl'
               AND PICK_DETAIL_STATUS <> 'XX'
               AND SSN_ID <> ''
             INTO :WK_FOUND;
             IF (WK_FOUND IS NULL) THEN
                WK_FOUND = 0;
             IF (WK_FOUND = 0) THEN
             BEGIN
                /* no undespatched ssns on item */
                /* UPDATE PICK_ITEM SET PICK_LINE_STATUS = 'DX'
                   WHERE PICK_LABEL_NO = :WK_LABEL; */
                IF (WK_PICKED_QTY < WK_ORDER_QTY) THEN
                BEGIN
                   /* must change line to allow picking of the remaining qty */
                   WK_PARTIAL_PICK = 'T';
                   SELECT PICK_ORDER.PARTIAL_PICK_ALLOWED
                      FROM PICK_ITEM
                      JOIN PICK_ORDER ON PICK_ITEM.PICK_ORDER = PICK_ORDER.PICK_ORDER
                      WHERE PICK_ITEM.PICK_LABEL_NO = :WK_LABEL
                      INTO :WK_PARTIAL_PICK;
                   IF (WK_PARTIAL_PICK IS NULL) THEN
                   BEGIN
                      WK_PARTIAL_PICK = 'T';
                   END
                   IF (WK_PARTIAL_PICK = 'T') THEN
                   BEGIN
                      UPDATE PICK_ITEM SET PICK_LINE_STATUS = 'OP',
                             DEVICE_ID = NULL,
                             REASON = NULL
                      WHERE PICK_LABEL_NO = :WK_LABEL;
                   END
                   ELSE
                   BEGIN
                      /* must change line to allow picking of the remaining qty */
                      UPDATE PICK_ITEM SET PICK_LINE_STATUS = 'DX',
                             DEVICE_ID = NULL
                      WHERE PICK_LABEL_NO = :WK_LABEL;
                   END
                END
                ELSE
                BEGIN
                   /* must change line to allow picking of the remaining qty */
                   UPDATE PICK_ITEM SET PICK_LINE_STATUS = 'DX',
                          DEVICE_ID = NULL
                   WHERE PICK_LABEL_NO = :WK_LABEL;
                END
             END
             /* check despatched all of order */
             WK_FOUND = 0;
             SELECT FIRST 1 1 FROM PICK_ITEM
             WHERE PICK_ORDER = :WK_ORDER
               AND PICK_LINE_STATUS <> 'DX'
               AND PICK_LINE_STATUS <> 'CN'
               AND PICK_LINE_STATUS <> 'HD'
             INTO :WK_FOUND;
             IF (WK_FOUND IS NULL) THEN
                WK_FOUND = 0;
             IF (WK_FOUND = 0) THEN
             BEGIN
                UPDATE PICK_ORDER SET PICK_STATUS = 'DX'
                WHERE PICK_ORDER = :WK_ORDER;
                IF (WK_DO_UCIS = 'T') THEN
                BEGIN
                /* update remote order status */
                    WK_GM_MESSAGE = '';
                    SELECT MESSAGE_ID 
                    FROM GET_NEXT_MESSAGE 
                    INTO :WK_GM_MESSAGE;
                    WK_T4_DELIM = '|';
                    WK_T4_TRAN_DATA = PERSON_ID || WK_T4_DELIM ;
                    WK_T4_TRAN_DATA = WK_T4_TRAN_DATA || DEVICE_ID || WK_T4_DELIM ;
                    WK_T4_TRAN_DATA = WK_T4_TRAN_DATA || WK_GM_MESSAGE || WK_T4_DELIM ;
                    WK_T4_TRAN_DATA = WK_T4_TRAN_DATA || '<ContactInstanceID>' || WK_ORDER || WK_T4_DELIM ;
                    WK_T4_TRAN_DATA = WK_T4_TRAN_DATA || '<ContactInstanceStatusCode>DX' || WK_T4_DELIM ;
                    WK_T4_TRAN_DATA = WK_T4_TRAN_DATA || '<UpdateDateTime>' || MER_YEAR('NOW') || '-' || LPAD(MER_MONTH('NOW'),'0',2) || '-' || LPAD(MER_DAY('NOW'),'0',2) || 'T' || LPAD(MER_HOUR('NOW'),'0',2) || ':' || LPAD(MER_MINUTE('NOW'),'0',2) || ':' || LPAD(SEC('NOW'),'0',2) || WK_T4_DELIM ;
                    WK_T4_SOURCE = 'SSSSSS' ;
                    SELECT REC_ID FROM ADD_TRAN_V4 ( 'V4', 'UCIS','S',
                       :TRN_DATE,
                       :WK_T4_DELIM,
                       :PERSON_ID,
                       :DEVICE_ID,
                       :WK_GM_MESSAGE,
                       :WK_T4_TRAN_DATA,
                       'F','','MASTER',0,
                       :WK_T4_SOURCE)
                    INTO :WK_NEW_RECORD;
                    EXECUTE PROCEDURE ADD_MESSAGE_V4 ( 
                       :WK_GM_MESSAGE,
                      'V4', 'UCIS','S',
                       :TRN_DATE,
                       :PERSON_ID,
                       :DEVICE_ID,
                       :WK_CN_PRIORITY,
                       'WS','',NULL);
                END
             END
          END /* end of detail status 'DC' */
       END
       UPDATE PICK_DESPATCH SET DESPATCH_STATUS = 'DX',
              PICKD_EXIT = 'NOW'
       WHERE DESPATCH_ID = :WK_DESPATCH;
       IF (WK_DO_EXPORT_DESPATCH = 'T') THEN
       BEGIN
          EXECUTE PROCEDURE PC_EXPORT_DESPATCH(:WK_DESPATCH, :WK_PRINTER);
       END
    END
    EXECUTE PROCEDURE UPDATE_TRAN (RECORD_ID, 'T','Processed successfully');
END ^

ALTER PROCEDURE PC_DSDX_LOCATION (WK_LOCN VARCHAR(10) CHARACTER SET NONE,
WK_END_TIME VARCHAR(30) CHARACTER SET NONE)
AS 
 

/*
Amendments
only choose issns with history update to a date (01 feb 2005)
then if any os a line closed - must close all lines of that order
and the order it self
*/

DECLARE VARIABLE WK_SSN VARCHAR(30);
DECLARE VARIABLE WK_SSN_SSN VARCHAR(30);
DECLARE VARIABLE WK_QTY_TOGET INTEGER;
DECLARE VARIABLE WK_REASON VARCHAR(70);
DECLARE VARIABLE WK_FOUND INTEGER;
DECLARE VARIABLE WK_ORDER VARCHAR(15);
DECLARE VARIABLE WK_LABEL VARCHAR(7);
DECLARE VARIABLE WK_PICKED_QTY INTEGER;
DECLARE VARIABLE WK_ORDER_QTY INTEGER;
DECLARE VARIABLE WK_DETAIL_ID INTEGER;
DECLARE VARIABLE WK_PROCESS_TYPE VARCHAR(10);
DECLARE VARIABLE WK_ISSN_PICK_LABEL VARCHAR(15);
DECLARE VARIABLE WK_BUFFER VARCHAR(150);
DECLARE VARIABLE WK_END_DATE TIMESTAMP;
DECLARE VARIABLE WK_HIST_DATE TIMESTAMP;

/* 
    get issn in location
    must despatch exit these
    if we have a pick_item_detail for these
        use this to drive the exit
    otherwise
        if have a 'D######' pick_order in the issn
            we know that issn was confirmed but not transferred
            so have the order , label, order_qty
                but the picked_qty will be null
    otherwise
        if pick_order is an order
            must choose the line to use
    otherwise
        pick_order is null 
        must choose the 1st pick_item for this ssn
*/
BEGIN
 WK_END_DATE = CAST(:WK_END_TIME AS TIMESTAMP);
 FOR SELECT ORIGINAL_SSN, CURRENT_QTY, SSN_ID, PICK_ORDER 
   FROM ISSN
   WHERE LOCN_ID = :WK_LOCN
   AND WH_ID <> 'XD'
   INTO :WK_SSN_SSN, :WK_QTY_TOGET, :WK_SSN, :WK_ISSN_PICK_LABEL
   DO
   BEGIN
       WK_HIST_DATE = 'TODAY';
       SELECT MAX(TRN_DATE) 
       FROM SSN_HIST 
       WHERE SSN_ID = :WK_SSN_SSN
       INTO :WK_HIST_DATE;
       IF (WK_HIST_DATE IS NULL) THEN
          WK_HIST_DATE = 'TODAY';

       IF (WK_HIST_DATE < WK_END_DATE) THEN
       BEGIN
          IF (WK_QTY_TOGET <> 0) THEN
          BEGIN
             UPDATE ISSN SET ISSN_STATUS = 'DX',
                 PREV_PREV_WH_ID = PREV_WH_ID,
                 PREV_PREV_LOCN_ID = PREV_LOCN_ID,
                 PREV_WH_ID = WH_ID,
                 PREV_LOCN_ID = LOCN_ID,
                 WH_ID = 'XD',
                 PREV_QTY = CURRENT_QTY,
                 CURRENT_QTY = 0
             WHERE SSN_ID = :WK_SSN;
          END
          ELSE
          BEGIN
             /* zero qty item */
             UPDATE ISSN SET ISSN_STATUS = 'DX',
                 PREV_PREV_WH_ID = PREV_WH_ID,
                 PREV_PREV_LOCN_ID = PREV_LOCN_ID,
                 PREV_WH_ID = WH_ID,
                 PREV_LOCN_ID = LOCN_ID,
                 WH_ID = 'XD'
             WHERE SSN_ID = :WK_SSN;
          END
          UPDATE SSN SET CURRENT_QTY = CURRENT_QTY - :WK_QTY_TOGET
             WHERE SSN_ID = :WK_SSN_SSN;
          WK_REASON = 'Despatched ' || :WK_QTY_TOGET || ' ISSN ' || :WK_SSN ;
          EXECUTE PROCEDURE ADD_SSN_HIST('XD', :WK_LOCN, :WK_SSN_SSN, 
                    'DSDX', 'A', :WK_END_DATE,
                    :WK_REASON, 'ON TO TRUCK' , :WK_QTY_TOGET, 'SYSTEM', 'SS'); 
          WK_PROCESS_TYPE = '';
          FOR SELECT PICK_LABEL_NO , PICK_DETAIL_ID
              FROM PICK_ITEM_DETAIL
          WHERE SSN_ID = :WK_SSN
          INTO :WK_LABEL,:WK_DETAIL_ID
          DO
          BEGIN
              WK_PROCESS_TYPE = 'DETAIL';
              /* update detail status to stop rerun */
              UPDATE PICK_ITEM_DETAIL SET PICK_DETAIL_STATUS = 'DX'
              WHERE PICK_DETAIL_ID = :WK_DETAIL_ID;
              SELECT PICK_ORDER, PICKED_QTY, PICK_ORDER_QTY
              FROM PICK_ITEM WHERE PICK_LABEL_NO = :WK_LABEL
              INTO :WK_ORDER, :WK_PICKED_QTY, :WK_ORDER_QTY;
   
              /* check despatched all of line */
              WK_FOUND = 0;
              SELECT FIRST 1 1 FROM PICK_ITEM_DETAIL
              WHERE PICK_LABEL_NO = :WK_LABEL
                AND PICK_DETAIL_STATUS <> 'DX'
              INTO :WK_FOUND;
              IF (WK_FOUND IS NULL) THEN
                 WK_FOUND = 0;
              IF (WK_FOUND = 0) THEN
              BEGIN
                 /* no undespatched ssns on item */
                 UPDATE PICK_ITEM SET PICK_LINE_STATUS = 'DX'
                 WHERE PICK_LABEL_NO = :WK_LABEL;
                 IF (WK_PICKED_QTY < WK_ORDER_QTY) THEN
                 BEGIN
                    /* must change line to allow picking of the remaining qty */
                    UPDATE PICK_ITEM SET PICK_LINE_STATUS = 'OP',
                           DEVICE_ID = NULL
                    WHERE PICK_LABEL_NO = :WK_LABEL;
                 END
                 ELSE
                 BEGIN
                    /* must change line to allow picking of the remaining qty */
                    UPDATE PICK_ITEM SET PICK_LINE_STATUS = 'DX',
                           DEVICE_ID = NULL
                    WHERE PICK_LABEL_NO = :WK_LABEL;
                 END
              END
              /* check despatched all of order */
              WK_FOUND = 0;
              SELECT FIRST 1 1 FROM PICK_ITEM
              WHERE PICK_ORDER = :WK_ORDER
                AND PICK_LINE_STATUS <> 'DX'
                AND PICK_LINE_STATUS <> 'CN'
                AND PICK_LINE_STATUS <> 'HD'
              INTO :WK_FOUND;
              IF (WK_FOUND IS NULL) THEN
                 WK_FOUND = 0;
              IF (WK_FOUND = 0) THEN
              BEGIN
                 UPDATE PICK_ORDER SET PICK_STATUS = 'DX'
                 WHERE PICK_ORDER = :WK_ORDER;
              END
          END /* for pick item detail */
          IF (WK_PROCESS_TYPE = '') THEN
          BEGIN
              /* try the issn pick_order is a label no */
              WK_FOUND = 0; 
              SELECT 1, PICK_ORDER, PICK_ORDER_QTY, PICK_LABEL_NO
              FROM PICK_ITEM WHERE PICK_LABEL_NO = :WK_ISSN_PICK_LABEL
              INTO :WK_FOUND, :WK_ORDER, :WK_ORDER_QTY, :WK_LABEL;
              IF (WK_FOUND = 1) THEN
              BEGIN
                  WK_PROCESS_TYPE = 'LABEL';
                  /* have confirmed line but not picked right */
                  WK_PICKED_QTY = WK_ORDER_QTY; /* since pick_qty is null */
                  /* check despatched all of line */
                  WK_FOUND = 0;
                  SELECT FIRST 1 1 FROM PICK_ITEM_DETAIL
                  WHERE PICK_LABEL_NO = :WK_LABEL
                    AND PICK_DETAIL_STATUS <> 'DX'
                  INTO :WK_FOUND;
                  IF (WK_FOUND IS NULL) THEN
                     WK_FOUND = 0;
                  IF (WK_FOUND = 0) THEN
                  BEGIN
                     /* no undespatched ssns on item */
                     UPDATE PICK_ITEM SET PICK_LINE_STATUS = 'DX'
                     WHERE PICK_LABEL_NO = :WK_LABEL;
                     IF (WK_PICKED_QTY < WK_ORDER_QTY) THEN
                     BEGIN
                        /* must change line to allow picking of the remaining qty */
                        UPDATE PICK_ITEM SET PICK_LINE_STATUS = 'OP',
                               DEVICE_ID = NULL
                        WHERE PICK_LABEL_NO = :WK_LABEL;
                     END
                     ELSE
                     BEGIN
                        /* must change line to allow picking of the remaining qty */
                        UPDATE PICK_ITEM SET PICK_LINE_STATUS = 'DX',
                               DEVICE_ID = NULL
                        WHERE PICK_LABEL_NO = :WK_LABEL;
                     END
                  END
                  /* check despatched all of order */
                  WK_FOUND = 0;
                  SELECT FIRST 1 1 FROM PICK_ITEM
                  WHERE PICK_ORDER = :WK_ORDER
                    AND PICK_LINE_STATUS <> 'DX'
                    AND PICK_LINE_STATUS <> 'CN'
                    AND PICK_LINE_STATUS <> 'HD'
                  INTO :WK_FOUND;
                  IF (WK_FOUND IS NULL) THEN
                     WK_FOUND = 0;
                  IF (WK_FOUND = 0) THEN
                  BEGIN
                     UPDATE PICK_ORDER SET PICK_STATUS = 'DX'
                     WHERE PICK_ORDER = :WK_ORDER;
                  END
              END /* end LABEL process type */
          END
          IF (WK_PROCESS_TYPE = '') THEN
          BEGIN
              /* try the issn pick_order is an order no */
              WK_FOUND = 0; 
              SELECT FIRST 1 1, PICK_ORDER, PICK_ORDER_QTY, PICK_LABEL_NO
              FROM PICK_ITEM 
              WHERE PICK_ORDER = :WK_ISSN_PICK_LABEL
              AND SSN_ID = :WK_SSN_SSN
              INTO :WK_FOUND, :WK_ORDER, :WK_ORDER_QTY, :WK_LABEL;
              IF (WK_FOUND = 1) THEN
              BEGIN
                  WK_PROCESS_TYPE = 'ORDER';
                  /* have maybe confirmed or unconfirmed line and not picked right */
                  WK_PICKED_QTY = WK_ORDER_QTY; /* since pick_qty is null */
                  /* check despatched all of line */
                  WK_FOUND = 0;
                  SELECT FIRST 1 1 FROM PICK_ITEM_DETAIL
                  WHERE PICK_LABEL_NO = :WK_LABEL
                    AND PICK_DETAIL_STATUS <> 'DX'
                  INTO :WK_FOUND;
                  IF (WK_FOUND IS NULL) THEN
                     WK_FOUND = 0;
                  IF (WK_FOUND = 0) THEN
                  BEGIN
                     /* no undespatched ssns on item */
                     UPDATE PICK_ITEM SET PICK_LINE_STATUS = 'DX'
                     WHERE PICK_LABEL_NO = :WK_LABEL;
                     IF (WK_PICKED_QTY < WK_ORDER_QTY) THEN
                     BEGIN
                        /* must change line to allow picking of the remaining qty */
                        UPDATE PICK_ITEM SET PICK_LINE_STATUS = 'OP',
                               DEVICE_ID = NULL
                        WHERE PICK_LABEL_NO = :WK_LABEL;
                     END
                     ELSE
                     BEGIN
                        /* must change line to allow picking of the remaining qty */
                        UPDATE PICK_ITEM SET PICK_LINE_STATUS = 'DX',
                               DEVICE_ID = NULL
                        WHERE PICK_LABEL_NO = :WK_LABEL;
                     END
                  END
                  /* check despatched all of order */
                  WK_FOUND = 0;
                  SELECT FIRST 1 1 FROM PICK_ITEM
                  WHERE PICK_ORDER = :WK_ORDER
                    AND PICK_LINE_STATUS <> 'DX'
                    AND PICK_LINE_STATUS <> 'CN'
                    AND PICK_LINE_STATUS <> 'HD'
                  INTO :WK_FOUND;
                  IF (WK_FOUND IS NULL) THEN
                     WK_FOUND = 0;
                  IF (WK_FOUND = 0) THEN
                  BEGIN
                     UPDATE PICK_ORDER SET PICK_STATUS = 'DX'
                     WHERE PICK_ORDER = :WK_ORDER;
                  END
              END /* end ORDER process type */
          END
          IF (WK_PROCESS_TYPE = '') THEN
          BEGIN
              /* the issn pick_order is null so use the 1st line for this ssn */
              WK_FOUND = 0;
              SELECT FIRST 1 1, PICK_ORDER, PICK_ORDER_QTY, PICK_LABEL_NO
              FROM PICK_ITEM 
              WHERE SSN_ID = :WK_SSN_SSN
              INTO :WK_FOUND, :WK_ORDER, :WK_ORDER_QTY, :WK_LABEL;
              IF (WK_FOUND = 1) THEN
              BEGIN
                  WK_PROCESS_TYPE = 'NULL';
                  WK_BUFFER = 'issn in Despatch issn_pick_location order not found ' || :WK_SSN || ' SSN ' || :WK_SSN_SSN || ' used order ' || :WK_ORDER ;
/*
                  INSERT INTO LOG(DESCRIPTION) VALUES (:WK_BUFFER);
*/
                  /* have unconfirmed line */
                  WK_PICKED_QTY = WK_ORDER_QTY; /* since pick_qty is null */
                  /* check despatched all of line */
                  WK_FOUND = 0;
                  SELECT FIRST 1 1 FROM PICK_ITEM_DETAIL
                  WHERE PICK_LABEL_NO = :WK_LABEL
                    AND PICK_DETAIL_STATUS <> 'DX'
                  INTO :WK_FOUND;
                  IF (WK_FOUND IS NULL) THEN
                     WK_FOUND = 0;
                  IF (WK_FOUND = 0) THEN
                  BEGIN
                     /* no undespatched ssns on item */
                     UPDATE PICK_ITEM SET PICK_LINE_STATUS = 'DX'
                     WHERE PICK_LABEL_NO = :WK_LABEL;
                     IF (WK_PICKED_QTY < WK_ORDER_QTY) THEN
                     BEGIN
                        /* must change line to allow picking of the remaining qty */
                        UPDATE PICK_ITEM SET PICK_LINE_STATUS = 'OP',
                               DEVICE_ID = NULL
                        WHERE PICK_LABEL_NO = :WK_LABEL;
                     END
                     ELSE
                     BEGIN
                        /* must change line to allow picking of the remaining qty */
                        UPDATE PICK_ITEM SET PICK_LINE_STATUS = 'DX',
                               DEVICE_ID = NULL
                        WHERE PICK_LABEL_NO = :WK_LABEL;
                     END
                  END
                  /* check despatched all of order */
                  WK_FOUND = 0;
                  SELECT FIRST 1 1 FROM PICK_ITEM
                  WHERE PICK_ORDER = :WK_ORDER
                    AND PICK_LINE_STATUS <> 'DX'
                    AND PICK_LINE_STATUS <> 'CN'
                    AND PICK_LINE_STATUS <> 'HD'
                  INTO :WK_FOUND;
                  IF (WK_FOUND IS NULL) THEN
                     WK_FOUND = 0;
                  IF (WK_FOUND = 0) THEN
                  BEGIN
                     UPDATE PICK_ORDER SET PICK_STATUS = 'DX'
                     WHERE PICK_ORDER = :WK_ORDER;
                  END
              END /* end NULL process type */
          END
          IF (WK_PROCESS_TYPE = '') THEN
          BEGIN
              /* not any of the above */
              WK_BUFFER = 'issn in Despatch but cannot exit' || :WK_SSN || ' SSN ' || :WK_SSN_SSN ;
              INSERT INTO LOG(DESCRIPTION) VALUES (:WK_BUFFER);
          END
          /* must despatch any pick lines not confirmed for ssn */
          UPDATE PICK_ITEM SET PICK_LINE_STATUS = 'DX', DEVICE_ID = NULL
          WHERE SSN_ID = :WK_SSN_SSN
          AND ((PICK_LINE_STATUS IS NULL) OR (PICK_LINE_STATUS <> 'DX'));
       END /* date < end date */
   END /* for issn */
   /* must close unpicked lines for orders where 
   /* close these unconfirmed lined orders */
   FOR SELECT PICK_ORDER FROM PICK_ORDER
       WHERE PICK_STATUS <> 'DX' OR
             PICK_STATUS IS NULL
       INTO :WK_ORDER
    DO
    BEGIN
       WK_FOUND = 0;
       SELECT FIRST 1 1 FROM PICK_ITEM
       WHERE PICK_ORDER = :WK_ORDER
         AND PICK_LINE_STATUS = 'DX'
         INTO :WK_FOUND;
       IF (WK_FOUND IS NULL) THEN
          WK_FOUND = 0;
       IF (WK_FOUND = 1) THEN
       BEGIN
          /* have a despatched line */
          /* so must ensure that all lines are despatched */
          UPDATE PICK_ITEM SET PICK_LINE_STATUS = 'DX', DEVICE_ID = NULL
          WHERE PICK_ORDER = :WK_ORDER
          AND ((PICK_LINE_STATUS IS NULL) 
         OR ( PICK_LINE_STATUS <> 'DX'
             AND PICK_LINE_STATUS <> 'CN'
             AND PICK_LINE_STATUS <> 'HD'));
       END
       WK_FOUND = 0;
       SELECT FIRST 1 1 FROM PICK_ITEM
       WHERE PICK_ORDER = :WK_ORDER
         AND ((PICK_LINE_STATUS IS NULL)
         OR ( PICK_LINE_STATUS <> 'DX'
             AND PICK_LINE_STATUS <> 'CN'
             AND PICK_LINE_STATUS <> 'HD'))
       INTO :WK_FOUND;
       IF (WK_FOUND IS NULL) THEN
          WK_FOUND = 0;
       IF (WK_FOUND = 0) THEN
       BEGIN
          UPDATE PICK_ORDER SET PICK_STATUS = 'DX'
          WHERE PICK_ORDER = :WK_ORDER;
       END
    END /* for */
END ^

ALTER PROCEDURE PC_EXPORT_DESPATCH (WK_DESPATCH_ID INTEGER,
WK_PRINTER CHAR(2) CHARACTER SET NONE)
AS 
DECLARE VARIABLE WK_FILE_PATH VARCHAR(70);
  DECLARE VARIABLE WK_FILE_PATH2 VARCHAR(70);
  DECLARE VARIABLE WK_LABEL VARCHAR(256);
  DECLARE VARIABLE WK_COMPANY VARCHAR(20);
  DECLARE VARIABLE WK_ORDER VARCHAR(20);
  DECLARE VARIABLE WK_ORDER_PREFIX VARCHAR(20);
  DECLARE VARIABLE WK_EXPORT_ORDER VARCHAR(20);
  DECLARE VARIABLE WK_PACK_TYPE CHAR(1);
  DECLARE VARIABLE WK_WEIGHT DECIMAL(9,3);
  DECLARE VARIABLE WK_RESULT INTEGER;
  DECLARE VARIABLE WK_TRAN_DATE VARCHAR(24);
  DECLARE VARIABLE WK_TRAN_DATE2 VARCHAR(24);
  DECLARE VARIABLE WK_COUNTRY VARCHAR(25);
  DECLARE VARIABLE WK_SATCHEL_QTY INTEGER;
  DECLARE VARIABLE WK_EXPORT_METHOD VARCHAR(40);

  DECLARE VARIABLE WK_PD_CONNOTE VARCHAR(20);
  DECLARE VARIABLE WK_PD_CARRIER_ID VARCHAR(10);

  DECLARE VARIABLE WK_PI_PICK_ORDER_LINE_NO VARCHAR(4);
  DECLARE VARIABLE WK_PI_PICK_LABEL_NO VARCHAR(10);
  DECLARE VARIABLE WK_PI_PICK_ORDER_QTY INTEGER;
  DECLARE VARIABLE WK_PI_PICKED_QTY INTEGER;
  DECLARE VARIABLE WK_PI_EXPORT_DESPATCH_QTY INTEGER;
  DECLARE VARIABLE WK_PI_PICK_LINE_STATUS CHAR(2);

  DECLARE VARIABLE WK_STATUS CHAR(2);
  DECLARE VARIABLE WK_LAST_ORDER VARCHAR(20);
  DECLARE VARIABLE WK_LAST_LINE VARCHAR(10);
  DECLARE VARIABLE WK_LAST_QTY INTEGER;
  DECLARE VARIABLE WK_LAST_CONNOTE VARCHAR(40);
  DECLARE VARIABLE WK_LAST_CARRIER_ID VARCHAR(40);
  DECLARE VARIABLE WK_LOG_FILENAME VARCHAR(80); 
  DECLARE VARIABLE WK_LOG_BUFFER VARCHAR(250);
  DECLARE VARIABLE WK_PI_K_ORDER VARCHAR(20);
  DECLARE VARIABLE WK_PI_EXPORT_DESPATCH VARCHAR(2);

BEGIN 
   WK_LOG_FILENAME = '/tmp/exportDespatch.log'; 
   SELECT EXPORT_DESPATCH_METHOD 
   FROM CONTROL
   INTO :WK_EXPORT_METHOD;
   IF (WK_EXPORT_METHOD IS NULL) THEN
   BEGIN
      WK_EXPORT_METHOD = '';
   END
   IF (WK_EXPORT_METHOD = 'MGM-SATCHEL WEIGHT') THEN
   BEGIN
      WK_PACK_TYPE = 'P';
  
      WK_TRAN_DATE = MER_YEAR('NOW') || LPAD(MER_MONTH('NOW'),'0',2) || LPAD(MER_DAY('NOW'),'0',2) || 'T' || LPAD(MER_HOUR('NOW'),'0',2) || LPAD(MER_MINUTE('NOW'),'0',2) ;
      /* GET THE PRINTER DIR */
  
      /* NEED THE DIRECTORY FOR THIS LABEL SET */
      SELECT WORKING_DIRECTORY FROM SYS_EQUIP 
      WHERE DEVICE_ID = :WK_PRINTER
      INTO :WK_FILE_PATH;
  
      SELECT PD.AWB_CONSIGNMENT_NO, PO.COMPANY_ID, PO.P_COUNTRY, PD.PICKD_WT_ACTUAL, PO.OTHER3, PD.PACK_TYPE, PD.PICKD_SATCHEL_QTY
      FROM PICK_DESPATCH PD 
      LEFT OUTER JOIN PICK_ORDER PO ON PD.AWB_CONSIGNMENT_NO = PO.PICK_ORDER
      WHERE PD.DESPATCH_ID = :WK_DESPATCH_ID
      INTO :WK_ORDER, :WK_COMPANY, :WK_COUNTRY, :WK_WEIGHT, :WK_ORDER_PREFIX, :WK_PACK_TYPE, :WK_SATCHEL_QTY;
      IF (WK_ORDER IS NULL) THEN
      BEGIN
         WK_ORDER = '';
      END
      IF (WK_ORDER_PREFIX IS NULL) THEN
      BEGIN
         WK_ORDER_PREFIX = '';
      END
      IF (WK_PACK_TYPE IS NULL) THEN
      BEGIN
         WK_PACK_TYPE = 'P';
      END
      IF (WK_SATCHEL_QTY IS NULL) THEN
      BEGIN
         WK_SATCHEL_QTY = 0;
      END
      WK_EXPORT_ORDER = SUBSTR(WK_ORDER,LEN(WK_ORDER_PREFIX) + 1,LEN(WK_ORDER));
      WK_FILE_PATH2 = WK_FILE_PATH || WK_ORDER_PREFIX || 'DESPATCH' || WK_TRAN_DATE || '.TXT';
       
      WK_LABEL = '"' || WK_COMPANY || '","' ||
          WK_EXPORT_ORDER || '","' ||
          WK_WEIGHT || '","' ||
          WK_PACK_TYPE || '","' ||
          WK_COUNTRY || '","' ||
          WK_SATCHEL_QTY || '"';
   
       WK_RESULT = FILE_WRITELN(:WK_FILE_PATH2, :WK_LABEL);
      IF (WK_RESULT <> 0) THEN
      BEGIN
         WK_FILE_PATH2 = WK_FILE_PATH || WK_ORDER_PREFIX || 'DESPATCH' || WK_TRAN_DATE || '.2XT';
          WK_RESULT = FILE_WRITELN(:WK_FILE_PATH2, :WK_LABEL);
      END   
   END   

   IF (WK_EXPORT_METHOD = 'PIN-PICK_ITEM QTY') THEN
   BEGIN
      WK_TRAN_DATE2 =  LPAD(MER_DAY('NOW'),'0',2) || ' ' || SUBSTR(MONTH_OF_YEAR('NOW'),1,3) || ' ' || MER_YEAR('NOW') ||  ' ' || LPAD(MER_HOUR('NOW'),'0',2) || ':' || LPAD(MER_MINUTE('NOW'),'0',2) || ':' || LPAD(SEC('NOW'), '0', 2) ;
      WK_TRAN_DATE = MER_YEAR('NOW') || LPAD(MER_MONTH('NOW'),'0',2) || LPAD(MER_DAY('NOW'),'0',2) || 'T' || LPAD(MER_HOUR('NOW'),'0',2) || LPAD(MER_MINUTE('NOW'),'0',2) ;
      WK_LOG_BUFFER = 'tran date2 ' || WK_TRAN_DATE2;
      WK_LOG_BUFFER = 'tran date ' || WK_TRAN_DATE;
      /* GET THE PRINTER DIR */
  
      /* NEED THE DIRECTORY FOR THIS LABEL SET */
      SELECT WORKING_DIRECTORY FROM SYS_EQUIP 
      WHERE DEVICE_ID = :WK_PRINTER
      INTO :WK_FILE_PATH;
      WK_LOG_BUFFER = 'file path ' || WK_FILE_PATH;
  
      WK_LAST_ORDER = 'DONTHAVE';
      WK_LAST_LINE  = 'DONTHAVE';
      WK_LAST_QTY = 0;
      WK_SATCHEL_QTY = 0;
      WK_LOG_BUFFER = 'set last qty to 0 - init ' ;
      WK_LAST_CONNOTE  = '';
      WK_LAST_CARRIER_ID  = '';
      WK_PI_K_ORDER = '';
      /* need order, line no, qty picked, date, connote, carrier, status */
      /* am passed a despatch_id
         which most likely is kit components
         so we need to include the kits lines as well which will be with as null despatch_ida and pick_detail_status 'DX'
      */
      FOR SELECT PD.AWB_CONSIGNMENT_NO, PD.PICKD_CARRIER_ID, PO.PICK_ORDER, PI.PICK_ORDER_LINE_NO, PI.PICK_LABEL_NO, PI.PICK_ORDER_QTY, PI.PICKED_QTY, PI.EXPORTED_DESPATCH_QTY, PI.PICK_LINE_STATUS, PI.EXPORTED_DESPATCH
         FROM PICK_DESPATCH PD 
         JOIN PICK_ITEM_DETAIL PID ON PD.DESPATCH_ID = PID.DESPATCH_ID
         JOIN PICK_ITEM  PI ON PID.PICK_LABEL_NO = PI.PICK_LABEL_NO 
         JOIN PICK_ORDER PO ON PI.PICK_ORDER = PO.PICK_ORDER
         WHERE PD.DESPATCH_ID = :WK_DESPATCH_ID
         AND PI.EXPORTED_DESPATCH IN ( 'F', 'K' )
         AND PI.PICK_LINE_STATUS IN ('OP','DX', 'CR')
         GROUP BY  PD.AWB_CONSIGNMENT_NO, PD.PICKD_CARRIER_ID, PO.PICK_ORDER, PI.PICK_ORDER_LINE_NO, PI.PICK_LABEL_NO, PI.PICK_ORDER_QTY, PI.PICKED_QTY, PI.EXPORTED_DESPATCH_QTY, PI.PICK_LINE_STATUS, PI.EXPORTED_DESPATCH   
         INTO :WK_PD_CONNOTE, :WK_PD_CARRIER_ID, :WK_ORDER, :WK_PI_PICK_ORDER_LINE_NO, :WK_PI_PICK_LABEL_NO, :WK_PI_PICK_ORDER_QTY, :WK_PI_PICKED_QTY, :WK_PI_EXPORT_DESPATCH_QTY, :WK_PI_PICK_LINE_STATUS, :WK_PI_EXPORT_DESPATCH
      DO
      BEGIN
      WK_LOG_BUFFER = 'got a record ' ;
      WK_LOG_BUFFER =  WK_PD_CONNOTE;
         IF (WK_ORDER IS NULL) THEN
         BEGIN
            WK_ORDER = '';
         END
         IF (WK_PD_CONNOTE IS NULL) THEN
         BEGIN
            WK_PD_CONNOTE = '';
         END
         IF (WK_PD_CARRIER_ID IS NULL) THEN
         BEGIN
            WK_PD_CARRIER_ID = '';
         END
         IF (WK_PI_PICK_ORDER_LINE_NO IS NULL) THEN
         BEGIN
            WK_PI_PICK_ORDER_LINE_NO = '';
         END
         IF (WK_PI_PICK_LABEL_NO IS NULL) THEN
         BEGIN
            WK_PI_PICK_LABEL_NO = '';
         END
         IF (WK_PI_PICK_ORDER_QTY IS NULL) THEN
         BEGIN
            WK_PI_PICK_ORDER_QTY = 0;
         END
         IF (WK_PI_PICKED_QTY IS NULL) THEN
         BEGIN
            WK_PI_PICKED_QTY = 0;
         END
         IF (WK_PI_EXPORT_DESPATCH_QTY IS NULL) THEN
         BEGIN
            WK_PI_EXPORT_DESPATCH_QTY = 0;
         END
      WK_LOG_BUFFER =  'pi picked_qty ' || WK_PI_PICKED_QTY;
      WK_LOG_BUFFER =  'pi exported_qty ' || WK_PI_EXPORT_DESPATCH_QTY;
      WK_LOG_BUFFER =  'pi exported_despatch ' || WK_PI_EXPORT_DESPATCH;
      WK_LOG_BUFFER =  'pi label_no ' || WK_PI_PICK_LABEL_NO;
         IF (WK_PI_EXPORT_DESPATCH = 'F') THEN
         BEGIN
            WK_SATCHEL_QTY = WK_PI_PICKED_QTY - WK_PI_EXPORT_DESPATCH_QTY;
      WK_LOG_BUFFER =  'set satchel_qty ' || WK_SATCHEL_QTY;
         WK_LOG_BUFFER = 'order ' || WK_ORDER ;
            /* need to sum the totals to get 1 line per pick_order_line_no */
            /* if the net sum < 0 then status is RT
               else DA  */
            IF (WK_ORDER <> WK_LAST_ORDER) THEN
            BEGIN
      WK_LOG_BUFFER =  'last order different ' ;
               IF (WK_LAST_ORDER <> 'DONTHAVE') THEN
               BEGIN
                  /* calc the status */
                  IF (WK_LAST_QTY < 0) THEN
                  BEGIN
                     WK_STATUS = 'RA';
                  END
                  ELSE
                  BEGIN
                     WK_STATUS = 'DA';
                  END
      WK_LOG_BUFFER =  'last order not donthave ' ;
      WK_LOG_BUFFER =  WK_LAST_ORDER  ;
      WK_LOG_BUFFER =  'last qty2 ' || :WK_LAST_QTY ;
                  /* write the sum line */
                  WK_FILE_PATH2 = WK_FILE_PATH ||  'ORDER_STATUS' || WK_TRAN_DATE || '.CSV';
         WK_LOG_BUFFER = 'file ' || WK_FILE_PATH2 ;
                  WK_LABEL =  WK_LAST_ORDER || ',' ||
                      WK_LAST_LINE || ',' ||
                      WK_LAST_QTY || ',' ||
                      WK_TRAN_DATE2 || ',' ||
                      WK_LAST_CONNOTE || ',' ||
                      WK_LAST_CARRIER_ID || ',' ||
                      WK_STATUS  ;
         WK_LOG_BUFFER = 'file ' || WK_LABEL ;
                   WK_RESULT = FILE_WRITELN(:WK_FILE_PATH2, :WK_LABEL);
                  IF (WK_RESULT <> 0) THEN
                  BEGIN
                     WK_FILE_PATH2 = WK_FILE_PATH || 'ORDER_STATUS' || WK_TRAN_DATE || '.2SV';
                     WK_RESULT = FILE_WRITELN(:WK_FILE_PATH2, :WK_LABEL);
                  END   
               END
               /* save the last fields */
               WK_LAST_ORDER = WK_ORDER;
               WK_LAST_LINE =  WK_PI_PICK_ORDER_LINE_NO;
               WK_LAST_QTY =  0 ;
      WK_LOG_BUFFER = 'set last qty to 0 - after write order changed ' ;
               WK_LAST_CONNOTE =  WK_PD_CONNOTE;
               /* WK_LAST_CARRIER_ID =  WK_PD_CARRIER_ID; */
            END
            IF (WK_PI_PICK_ORDER_LINE_NO <> WK_LAST_LINE) THEN
            BEGIN
      WK_LOG_BUFFER =  'last line  different ' ;
               IF (WK_LAST_LINE  <> 'DONTHAVE') THEN
               BEGIN
                  /* calc the status */
                  IF (WK_LAST_QTY < 0) THEN
                  BEGIN
                     WK_STATUS = 'RA';
                  END
                  ELSE
                  BEGIN
                     WK_STATUS = 'DA';
                  END
      WK_LOG_BUFFER =  'last line  not donthave ' ;
      WK_LOG_BUFFER =  WK_LAST_LINE   ;
      WK_LOG_BUFFER =  'last qty2 ' || :WK_LAST_QTY ;
                  /* write the sum line */
                  WK_FILE_PATH2 = WK_FILE_PATH ||  'ORDER_STATUS' || WK_TRAN_DATE || '.CSV';
                  WK_LABEL =  WK_LAST_ORDER || ',' ||
                      WK_LAST_LINE || ',' ||
                      WK_LAST_QTY || ',' ||
                      WK_TRAN_DATE2 || ',' ||
                      WK_LAST_CONNOTE || ',' ||
                      WK_LAST_CARRIER_ID || ',' ||
                      WK_STATUS ;
                   WK_RESULT = FILE_WRITELN(:WK_FILE_PATH2, :WK_LABEL);
                  IF (WK_RESULT <> 0) THEN
                  BEGIN
                     WK_FILE_PATH2 = WK_FILE_PATH || 'ORDER_STATUS' || WK_TRAN_DATE || '.2SV';
                     WK_RESULT = FILE_WRITELN(:WK_FILE_PATH2, :WK_LABEL);
                  END   
               END
               /* save the last fields */
               WK_LAST_LINE = WK_PI_PICK_ORDER_LINE_NO;
               WK_LAST_QTY =  0 ;
      WK_LOG_BUFFER = 'set last qty to 0 - after write line changed ' ;
               WK_LAST_CONNOTE =  WK_PD_CONNOTE;
               /* WK_LAST_CARRIER_ID =  WK_PD_CARRIER_ID; */
            END
      WK_LOG_BUFFER = 'wk_last_qty before ' || WK_LAST_QTY ;
            WK_LAST_QTY =  WK_LAST_QTY + WK_SATCHEL_QTY ;
      WK_LOG_BUFFER = 'add to last qty ' ;
      WK_LOG_BUFFER = 'wk_last_qty after  ' || WK_LAST_QTY ;
   
   /*
            WK_FILE_PATH2 = WK_FILE_PATH ||  'ORDER_STATUS' || WK_TRAN_DATE || '.CSV';
          
            WK_LABEL = '"' || WK_EXPORT_ORDER || '","' ||
                WK_PI_PICK_ORDER_LINE_NO || '","' ||
                WK_SATCHEL_QTY || '","' ||
                WK_TRAN_DATE2 || '","' ||
                WK_PD_CONNOTE || '","' ||
                WK_PD_CARRIER_ID || '","' ||
                WK_STATUS || '"';
      
             WK_RESULT = FILE_WRITELN(:WK_FILE_PATH2, :WK_LABEL);
            IF (WK_RESULT <> 0) THEN
            BEGIN
               WK_FILE_PATH2 = WK_FILE_PATH || 'ORDER_STATUS' || WK_TRAN_DATE || '.2SV';
               WK_RESULT = FILE_WRITELN(:WK_FILE_PATH2, :WK_LABEL);
            END   
   */
            /* now update this pick item */
            UPDATE PICK_ITEM 
            SET EXPORTED_DESPATCH = 'T',
                EXPORTED_DESPATCH_QTY = :WK_PI_PICKED_QTY
            WHERE PICK_LABEL_NO = :WK_PI_PICK_LABEL_NO;
         END
         ELSE
         BEGIN
            WK_PI_K_ORDER = WK_ORDER;
         END
      END /* end of do */  
      /* now the same but for the Kitted Items */
      WK_PI_EXPORT_DESPATCH = 'F';
      WK_LOG_BUFFER = 'now for kit items  '  ;
      WK_LOG_BUFFER = 'current order  ' || WK_LAST_ORDER ;
      WK_LOG_BUFFER = 'current line   ' || WK_LAST_LINE  ;
      WK_LOG_BUFFER = 'current qty    ' || WK_LAST_QTY   ;
      WK_LOG_BUFFER = 'try to get for for orde ' || WK_PI_K_ORDER ;
      FOR SELECT PO.PICK_ORDER, PI.PICK_ORDER_LINE_NO, PI.PICK_LABEL_NO, PI.PICK_ORDER_QTY, PI.PICKED_QTY, PI.EXPORTED_DESPATCH_QTY, PI.PICK_LINE_STATUS, PI.EXPORTED_DESPATCH 
         FROM PICK_ORDER PO    
         JOIN PICK_ITEM  PI ON PO.PICK_ORDER  = PI.PICK_ORDER    
         JOIN PICK_ITEM_DETAIL PID ON PI.PICK_LABEL_NO  = PID.PICK_LABEL_NO
         WHERE PO.PICK_ORDER  = :WK_PI_K_ORDER
         AND PI.EXPORTED_DESPATCH =  'F' 
         AND PI.PICK_LINE_STATUS IN ('OP','DX', 'CR')
         AND PID.DESPATCH_ID IS NULL
         AND PID.PICK_DETAIL_STATUS IN ( 'DX', 'CR')
         GROUP BY  PO.PICK_ORDER, PI.PICK_ORDER_LINE_NO, PI.PICK_LABEL_NO, PI.PICK_ORDER_QTY, PI.PICKED_QTY, PI.EXPORTED_DESPATCH_QTY, PI.PICK_LINE_STATUS, PI.EXPORTED_DESPATCH   
         INTO :WK_ORDER, :WK_PI_PICK_ORDER_LINE_NO, :WK_PI_PICK_LABEL_NO, :WK_PI_PICK_ORDER_QTY, :WK_PI_PICKED_QTY, :WK_PI_EXPORT_DESPATCH_QTY, :WK_PI_PICK_LINE_STATUS, :WK_PI_EXPORT_DESPATCH 
      DO
      BEGIN
      WK_LOG_BUFFER = 'got a record ' ;
      WK_LOG_BUFFER =  WK_PD_CONNOTE;
         IF (WK_ORDER IS NULL) THEN
         BEGIN
            WK_ORDER = '';
         END
         IF (WK_PI_PICK_ORDER_LINE_NO IS NULL) THEN
         BEGIN
            WK_PI_PICK_ORDER_LINE_NO = '';
         END
         IF (WK_PI_PICK_LABEL_NO IS NULL) THEN
         BEGIN
            WK_PI_PICK_LABEL_NO = '';
         END
         IF (WK_PI_PICK_ORDER_QTY IS NULL) THEN
         BEGIN
            WK_PI_PICK_ORDER_QTY = 0;
         END
         IF (WK_PI_PICKED_QTY IS NULL) THEN
         BEGIN
            WK_PI_PICKED_QTY = 0;
         END
         IF (WK_PI_EXPORT_DESPATCH_QTY IS NULL) THEN
         BEGIN
            WK_PI_EXPORT_DESPATCH_QTY = 0;
         END
      WK_LOG_BUFFER =  'pi picked_qty ' || WK_PI_PICKED_QTY;
      WK_LOG_BUFFER =  'pi exported_qty ' || WK_PI_EXPORT_DESPATCH_QTY;
      WK_LOG_BUFFER =  'pi exported_despatch ' || WK_PI_EXPORT_DESPATCH;
      WK_LOG_BUFFER =  'pi label_no ' || WK_PI_PICK_LABEL_NO;
         BEGIN
            WK_SATCHEL_QTY = WK_PI_PICKED_QTY - WK_PI_EXPORT_DESPATCH_QTY;
      WK_LOG_BUFFER =  'set satchel_qty ' || WK_SATCHEL_QTY;
         WK_LOG_BUFFER = 'order ' || WK_ORDER ;
            /* need to sum the totals to get 1 line per pick_order_line_no */
            /* if the net sum < 0 then status is RT
               else DA  */
            IF (WK_ORDER <> WK_LAST_ORDER) THEN
            BEGIN
      WK_LOG_BUFFER =  'last order different ' ;
               IF (WK_LAST_ORDER <> 'DONTHAVE') THEN
               BEGIN
                  /* calc the status */
                  IF (WK_LAST_QTY < 0) THEN
                  BEGIN
                     WK_STATUS = 'RA';
                  END
                  ELSE
                  BEGIN
                     WK_STATUS = 'DA';
                  END
      WK_LOG_BUFFER =  'last line  not donthave ' ;
      WK_LOG_BUFFER =  WK_LAST_ORDER  ;
      WK_LOG_BUFFER =  'last qty2 ' || :WK_LAST_QTY ;
                  /* write the sum line */
                  WK_FILE_PATH2 = WK_FILE_PATH ||  'ORDER_STATUS' || WK_TRAN_DATE || '.CSV';
         WK_LOG_BUFFER = 'file ' || WK_FILE_PATH2 ;
                  WK_LABEL =  WK_LAST_ORDER || ',' ||
                      WK_LAST_LINE || ',' ||
                      WK_LAST_QTY || ',' ||
                      WK_TRAN_DATE2 || ',' ||
                      WK_LAST_CONNOTE || ',' ||
                      WK_LAST_CARRIER_ID || ',' ||
                      WK_STATUS  ;
         WK_LOG_BUFFER = 'file ' || WK_LABEL ;
                   WK_RESULT = FILE_WRITELN(:WK_FILE_PATH2, :WK_LABEL);
                  IF (WK_RESULT <> 0) THEN
                  BEGIN
                     WK_FILE_PATH2 = WK_FILE_PATH || 'ORDER_STATUS' || WK_TRAN_DATE || '.2SV';
                     WK_RESULT = FILE_WRITELN(:WK_FILE_PATH2, :WK_LABEL);
                  END   
               END
               /* save the last fields */
               WK_LAST_ORDER = WK_ORDER;
               WK_LAST_LINE =  WK_PI_PICK_ORDER_LINE_NO;
               WK_LAST_QTY =  0 ;
      WK_LOG_BUFFER = 'set last qty to 0 - after write order changed ' ;
               WK_LAST_CONNOTE =  WK_PD_CONNOTE;
               /* WK_LAST_CARRIER_ID =  WK_PD_CARRIER_ID; */
            END
            IF (WK_PI_PICK_ORDER_LINE_NO <> WK_LAST_LINE) THEN
            BEGIN
      WK_LOG_BUFFER =  'last line  different ' ;
               IF (WK_LAST_LINE  <> 'DONTHAVE') THEN
               BEGIN
                  /* calc the status */
                  IF (WK_LAST_QTY < 0) THEN
                  BEGIN
                     WK_STATUS = 'RA';
                  END
                  ELSE
                  BEGIN
                     WK_STATUS = 'DA';
                  END
      WK_LOG_BUFFER =  'last line  not donthave ' ;
      WK_LOG_BUFFER =  WK_LAST_LINE   ;
      WK_LOG_BUFFER =  'last qty2 ' || :WK_LAST_QTY ;
                  /* write the sum line */
                  WK_FILE_PATH2 = WK_FILE_PATH ||  'ORDER_STATUS' || WK_TRAN_DATE || '.CSV';
                  WK_LABEL =  WK_LAST_ORDER || ',' ||
                      WK_LAST_LINE || ',' ||
                      WK_LAST_QTY || ',' ||
                      WK_TRAN_DATE2 || ',' ||
                      WK_LAST_CONNOTE || ',' ||
                      WK_LAST_CARRIER_ID || ',' ||
                      WK_STATUS ;
                   WK_RESULT = FILE_WRITELN(:WK_FILE_PATH2, :WK_LABEL);
                  IF (WK_RESULT <> 0) THEN
                  BEGIN
                     WK_FILE_PATH2 = WK_FILE_PATH || 'ORDER_STATUS' || WK_TRAN_DATE || '.2SV';
                     WK_RESULT = FILE_WRITELN(:WK_FILE_PATH2, :WK_LABEL);
                  END   
               END
               /* save the last fields */
               WK_LAST_LINE = WK_PI_PICK_ORDER_LINE_NO;
               WK_LAST_QTY =  0 ;
      WK_LOG_BUFFER = 'set last qty to 0 - after write order changed ' ;
               WK_LAST_CONNOTE =  WK_PD_CONNOTE;
               /* WK_LAST_CARRIER_ID =  WK_PD_CARRIER_ID; */
            END
      WK_LOG_BUFFER = 'wk_last_qty before ' || WK_LAST_QTY ;
            WK_LAST_QTY =  WK_LAST_QTY + WK_SATCHEL_QTY ;
      WK_LOG_BUFFER = 'add to last qty ' ;
      WK_LOG_BUFFER = 'wk_last_qty after  ' || WK_LAST_QTY ;
   
   /*
            WK_FILE_PATH2 = WK_FILE_PATH ||  'ORDER_STATUS' || WK_TRAN_DATE || '.CSV';
          
            WK_LABEL = '"' || WK_EXPORT_ORDER || '","' ||
                WK_PI_PICK_ORDER_LINE_NO || '","' ||
                WK_SATCHEL_QTY || '","' ||
                WK_TRAN_DATE2 || '","' ||
                WK_PD_CONNOTE || '","' ||
                WK_PD_CARRIER_ID || '","' ||
                WK_STATUS || '"';
      
             WK_RESULT = FILE_WRITELN(:WK_FILE_PATH2, :WK_LABEL);
            IF (WK_RESULT <> 0) THEN
            BEGIN
               WK_FILE_PATH2 = WK_FILE_PATH || 'ORDER_STATUS' || WK_TRAN_DATE || '.2SV';
               WK_RESULT = FILE_WRITELN(:WK_FILE_PATH2, :WK_LABEL);
            END   
   */
            /* now update this pick item */
            UPDATE PICK_ITEM 
            SET EXPORTED_DESPATCH = 'T',
                EXPORTED_DESPATCH_QTY = :WK_PI_PICKED_QTY
            WHERE PICK_LABEL_NO = :WK_PI_PICK_LABEL_NO;
         END
      END /* end of do */  

      WK_LOG_BUFFER = 'end of do ' ;
      BEGIN
            IF ((WK_LAST_ORDER <> 'DONTHAVE') AND (WK_LAST_LINE  <> 'DONTHAVE')) THEN
            BEGIN
               /* calc the status */
               IF (WK_LAST_QTY < 0) THEN
               BEGIN
                  WK_STATUS = 'RA';
               END
               ELSE
               BEGIN
                  WK_STATUS = 'DA';
               END
      WK_LOG_BUFFER =  'last line  not donthave and last order not donthave ' ;
      WK_LOG_BUFFER =  :WK_LAST_LINE   ;
      WK_LOG_BUFFER =  WK_LAST_ORDER  ;
      WK_LOG_BUFFER =  'last qty2 ' || :WK_LAST_QTY ;
               /* write the sum line */
               WK_FILE_PATH2 = WK_FILE_PATH ||  'ORDER_STATUS' || WK_TRAN_DATE || '.CSV';
      WK_LOG_BUFFER = 'file path2 ' || WK_FILE_PATH2;
               WK_LABEL =  WK_LAST_ORDER || ',' ||
                   WK_LAST_LINE || ',' ||
                   WK_LAST_QTY || ',' ||
                   WK_TRAN_DATE2 || ',' ||
                   WK_LAST_CONNOTE || ',' ||
                   WK_LAST_CARRIER_ID || ',' ||
                   WK_STATUS ;
      WK_LOG_BUFFER = 'label ' ;
                WK_RESULT = FILE_WRITELN(:WK_FILE_PATH2, :WK_LABEL);
               IF (WK_RESULT <> 0) THEN
               BEGIN
                  WK_FILE_PATH2 = WK_FILE_PATH || 'ORDER_STATUS' || WK_TRAN_DATE || '.2SV';
                  WK_RESULT = FILE_WRITELN(:WK_FILE_PATH2, :WK_LABEL);
               END   
            END   
      END
   END   
  
      WK_LOG_BUFFER = 'end of pc_export_despatch ' ;
END ^

ALTER PROCEDURE PC_GROUP_COPY (OBJECT VARCHAR(30) CHARACTER SET NONE,
SSN_TYPE VARCHAR(40) CHARACTER SET NONE,
GENERIC VARCHAR(40) CHARACTER SET NONE,
BRAND VARCHAR(40) CHARACTER SET NONE,
MODEL VARCHAR(40) CHARACTER SET NONE,
PROD_ID VARCHAR(30) CHARACTER SET NONE,
SUPPLIER_ID VARCHAR(40) CHARACTER SET NONE,
OTHER6 VARCHAR(50) CHARACTER SET NONE,
OTHER7 VARCHAR(50) CHARACTER SET NONE,
OTHER8 VARCHAR(50) CHARACTER SET NONE,
OTHER9 VARCHAR(50) CHARACTER SET NONE,
OTHER10 VARCHAR(50) CHARACTER SET NONE,
DESCRIPTION VARCHAR(50) CHARACTER SET NONE)
AS 
 
 
     
BEGIN
       
    UPDATE SSN
    SET SSN_TYPE = :SSN_TYPE, 
        GENERIC = :GENERIC, 
        BRAND = :BRAND, 
        MODEL = :MODEL,
        PROD_ID = :PROD_ID,
        SUPPLIER_ID = :SUPPLIER_ID,
        OTHER6 = :OTHER6,
        OTHER7 = :OTHER7,
        OTHER8 = :OTHER8,
        OTHER9 = :OTHER9,
        OTHER10 = :OTHER10,
        SSN_DESCRIPTION = :DESCRIPTION
    WHERE SSN_ID = :OBJECT; 
                      
END ^

ALTER PROCEDURE PC_INDUCTION_FORM (QTY INTEGER,
PERSON_ID VARCHAR(10) CHARACTER SET NONE)
RETURNS (RES INTEGER)
AS 
        
  
  DECLARE VARIABLE iGEN INTEGER;    
  DECLARE VARIABLE sFilePath VARCHAR(70);  
  DECLARE VARIABLE sPrinterName CHAR(2);   
  DECLARE VARIABLE sForm VARCHAR(256);
  DECLARE VARIABLE sFIRST_FORM_ID VARCHAR(8);  
       
BEGIN 
  
  sPrinterName = 'PD';
  
  /* Need the directory for this label set */
  SELECT WORKING_DIRECTORY FROM SYS_EQUIP 
  WHERE DEVICE_ID = :sPrinterName
  INTO :sFilePath;
  
  sFilePath = sFilePath || 'Induction.txt';         
  
  /* Get the first Form ID */
  EXECUTE PROCEDURE GET_FORM_NO RETURNING_VALUES :sFIRST_FORM_ID;
  
  /* Resever Form ID with Qty */
  iGEN = GEN_ID(FORM_NO_GEN, :QTY-1);
           
  
  /* Write data to file */
  sForm = DQUOTEDSTR(:QTY) || ',' ||
          DQUOTEDSTR(:sFIRST_FORM_ID) || ',' ||
          DQUOTEDSTR(:PERSON_ID) || ',' ||
          DQUOTEDSTR(:sPrinterName);
  
  RES = FILE_WRITELN(:sFilePath, :sForm);    
  
END ^

ALTER PROCEDURE PC_ISSN_TRANSFER (SSN_ID CHAR(20) CHARACTER SET NONE,
TO_WH_ID CHAR(2) CHARACTER SET NONE,
TO_LOCN_ID CHAR(10) CHARACTER SET NONE,
UPDATE_SSN CHAR(1) CHARACTER SET NONE,
STATUS CHAR(2) CHARACTER SET NONE)
AS 
 
     
              
BEGIN   
   /* Update ISSN */
/*
   UPDATE ISSN
   SET WH_ID = :TO_WH_ID,
       PREV_LOCN_ID = LOCN_ID,
       LOCN_ID = :TO_LOCN_ID,
       PREV_DATE = INTO_DATE,
       INTO_DATE = 'NOW',
       ISSN_STATUS = :STATUS
   WHERE SSN_ID = :SSN_ID;
*/
   UPDATE ISSN
   SET WH_ID = :TO_WH_ID,
       PREV_LOCN_ID = LOCN_ID,
       LOCN_ID = :TO_LOCN_ID,
       PREV_DATE = INTO_DATE,
       INTO_DATE = 'NOW'
   WHERE SSN_ID = :SSN_ID;

   /* Update SSN */
   if (:UPDATE_SSN = 'T') then
   begin
/*
     UPDATE SSN
     SET WH_ID = :TO_WH_ID,
         PREV_LOCN_ID = LOCN_ID, 
         LOCN_ID = :TO_LOCN_ID,
         PREV_LOCN_DATE = INTO_DATE,
         INTO_DATE = 'NOW',
         STATUS_SSN = :STATUS
     WHERE SSN_ID = :SSN_ID;
*/
     UPDATE SSN
     SET WH_ID = :TO_WH_ID,
         PREV_LOCN_ID = LOCN_ID, 
         LOCN_ID = :TO_LOCN_ID,
         PREV_LOCN_DATE = INTO_DATE,
         INTO_DATE = 'NOW'
     WHERE SSN_ID = :SSN_ID;
   end
   
END ^

ALTER PROCEDURE PC_LABEL (DEVICE_ID CHAR(2) CHARACTER SET NONE,
PRN_TYPE VARCHAR(40) CHARACTER SET NONE,
PRN_COPY INTEGER,
PRN_FILE_NAME VARCHAR(70) CHARACTER SET NONE,
PRN_DATA VARCHAR(32000) CHARACTER SET NONE,
PERSON_ID VARCHAR(10) CHARACTER SET NONE)
RETURNS (RES INTEGER,
ERROR_TEXT VARCHAR(1024) CHARACTER SET NONE)
AS 
DECLARE VARIABLE WK_DEVICE_ID CHAR(2);
DECLARE VARIABLE WK_LABEL_TYPE VARCHAR(70);
DECLARE VARIABLE WK_COPIES INTEGER;
DECLARE VARIABLE WK_DO_SYSLABEL CHAR(2);
DECLARE VARIABLE WK_FORMAT VARCHAR(40);
DECLARE VARIABLE WK_FORMAT_LINES INTEGER;
DECLARE VARIABLE WK_GM_MESSAGE VARCHAR(10);
BEGIN 
  
  /* insert into print_requests */
  /* with status NP  new request
			create the print file
                 CP  created print file
			send to the device
                 XP  completed */
  WK_DO_SYSLABEL = '';
  WK_GM_MESSAGE = '';
  SELECT GENERATE_LABEL_TEXT 
  FROM CONTROL
  INTO :WK_DO_SYSLABEL;
  IF (WK_DO_SYSLABEL = 'F') THEN
  BEGIN
     /* check that the format exists */
     WK_FORMAT = '';
     SELECT DESCRIPTION 
     FROM OPTIONS
     WHERE GROUP_CODE = (:DEVICE_ID || '_FORMAT') 
     AND   CODE = :PRN_TYPE
     INTO :WK_FORMAT;
     IF (WK_FORMAT IS NULL) THEN
     BEGIN
        WK_FORMAT = '';
     END
     IF (WK_FORMAT = '') THEN
     BEGIN
        RES = -10;
        ERROR_TEXT = 'No Format for Type ' || :PRN_TYPE;
     END
     ELSE
     BEGIN
        WK_FORMAT_LINES = 0;
        SELECT COUNT(*)
        FROM SYS_LABEL
        WHERE SL_NAME = :WK_FORMAT
        INTO :WK_FORMAT_LINES;
        IF (WK_FORMAT_LINES IS NULL) THEN
        BEGIN
           WK_FORMAT_LINES = 0;
        END
        IF (WK_FORMAT_LINES > 0) THEN
        BEGIN
/*
           INSERT INTO PRINT_REQUESTS (DEVICE_ID, PRN_TYPE, PRN_COPY, BASE_FILE_NAME, PRN_DATA, PERSON_ID, REQUEST_STATUS, ERROR_TEXT)
           VALUES ( :DEVICE_ID, :PRN_TYPE, :PRN_COPY, :PRN_FILE_NAME, :PRN_DATA, :PERSON_ID, 'NP', '');
TAKE OUT File Name since binary choose bad file names not unique and not a prn but an old format file
*/
           SELECT MESSAGE_ID
           FROM GET_NEXT_MESSAGE
           INTO :WK_GM_MESSAGE;
           INSERT INTO PRINT_REQUESTS (DEVICE_ID, PRN_TYPE, PRN_COPY, BASE_FILE_NAME, PRN_DATA, PERSON_ID, REQUEST_STATUS, ERROR_TEXT, MESSAGE_ID)
           VALUES ( :DEVICE_ID, :PRN_TYPE, :PRN_COPY, '', :PRN_DATA, :PERSON_ID, 'NP', '', :WK_GM_MESSAGE);
           RES = 0;
           ERROR_TEXT = 'Print Request Sent';
        END
        ELSE
        BEGIN
           RES = -20;
           ERROR_TEXT = 'No Format Lines for Type ' || :PRN_TYPE || ' and Format ' || :WK_FORMAT;
        END
     END
  END
  ELSE
  BEGIN
     RES = -1;
     ERROR_TEXT = 'Bartender File - Not able to create Bartender files yet';
  END
  IF (STRLEN(PRN_DATA) > 254) THEN
  BEGIN
     INSERT INTO TRANSACTIONS_ARCHIVE (TRN_TYPE, TRN_CODE, WH_ID, OBJECT, QTY, REFERENCE, PERSON_ID, SUB_LOCN_ID, ERROR_TEXT, DEVICE_ID, TRN_DATE, INSTANCE_ID)
     VALUES ( 'PRRQ','D', :DEVICE_ID, :PRN_TYPE, :PRN_COPY, V4SUBSTRING(:PRN_DATA, 1, 254), :PERSON_ID, 'NP', :ERROR_TEXT, '', 'NOW', :WK_GM_MESSAGE);
  END
  ELSE
  BEGIN
     INSERT INTO TRANSACTIONS_ARCHIVE (TRN_TYPE, TRN_CODE, WH_ID, OBJECT, QTY, REFERENCE, PERSON_ID, SUB_LOCN_ID, ERROR_TEXT, DEVICE_ID, TRN_DATE, INSTANCE_ID)
     VALUES ( 'PRRQ','D', :DEVICE_ID, :PRN_TYPE, :PRN_COPY, :PRN_DATA , :PERSON_ID, 'NP', :ERROR_TEXT, '', 'NOW', :WK_GM_MESSAGE);
  END
  SUSPEND;

END ^

ALTER PROCEDURE PC_LABEL_BARCODE (REFERENCE VARCHAR(40) CHARACTER SET NONE)
RETURNS (RES INTEGER)
AS 

    
  DECLARE VARIABLE sFilePath VARCHAR(70);
  DECLARE VARIABLE sFilePath2 VARCHAR(70);
  DECLARE VARIABLE sPrinterName CHAR(2);
  DECLARE VARIABLE sRef VARCHAR(40);  
  DECLARE VARIABLE sLabel VARCHAR(256);
  
BEGIN 
  
  /* Get the printer dir */
  sPrinterName = SUBSTR(:REFERENCE,1,2);
  sRef = SUBSTR(:REFERENCE,3,STRLEN(:REFERENCE));
  
  /* Need the directory for this label set */
  SELECT WORKING_DIRECTORY FROM SYS_EQUIP 
  WHERE DEVICE_ID = :sPrinterName
  INTO :sFilePath;
  
  sFilePath2 = sFilePath || 'Barcode.txt';
       
  sLabel = DQUOTEDSTR(:sRef) || ',' || DQUOTEDSTR(:sPrinterName);
  
  RES = FILE_WRITELN(:sFilePath2, :sLabel);
  if (RES <> 0) then
  begin
     sFilePath2 = sFilePath || 'Barcode.2xt';
     RES = FILE_WRITELN(:sFilePath2, :sLabel);
  end   
  
END ^

ALTER PROCEDURE PC_LABEL_DESPATCH (WK_ORDER VARCHAR(15) CHARACTER SET NONE,
WK_PRINTER CHAR(2) CHARACTER SET NONE)
AS 
 
 
    
  DECLARE VARIABLE WK_FILE_PATH VARCHAR(70);
  DECLARE VARIABLE WK_FILE_PATH2 VARCHAR(70);
  DECLARE VARIABLE WK_FILE_PATH3 VARCHAR(70);
  DECLARE VARIABLE WK_DESCRIPTION VARCHAR(255);
  DECLARE VARIABLE WK_DESCRIPTION2 VARCHAR(256);
  DECLARE VARIABLE WK_DESCRIPTION3 VARCHAR(256);
  DECLARE VARIABLE WK_LABEL VARCHAR(256);
  DECLARE VARIABLE WK_RESULT INTEGER;
  DECLARE VARIABLE WK_TRAN_DATE VARCHAR(24);
  DECLARE VARIABLE WK_PROD VARCHAR(30);
  DECLARE VARIABLE WK_PICK_STATUS CHAR(2);
  DECLARE VARIABLE WK_PICKED_QTY INTEGER;
  DECLARE VARIABLE WK_PICKED_LINE VARCHAR(11);
  DECLARE VARIABLE WK_LINE_CNT INTEGER;
  DECLARE VARIABLE WK_PAGE_CNT INTEGER;
  DECLARE VARIABLE WK_LINE_PER_PAGE INTEGER;
  DECLARE VARIABLE WK_PRECODE VARCHAR(55);
  DECLARE VARIABLE WK_FIRST_2 VARCHAR(2);
  DECLARE VARIABLE WK_USERS VARCHAR(25);
  DECLARE VARIABLE WK_USER VARCHAR(10);
  
BEGIN 
  
  WK_TRAN_DATE = MER_YEAR('NOW') || LPAD(MER_MONTH('NOW'),'0',2) || LPAD(MER_DAY('NOW'),'0',2) || 'T' || LPAD(MER_HOUR('NOW'),'0',2) || LPAD(MER_MINUTE('NOW'),'0',2) ;
  /* GET THE PRINTER DIR */
  
  /* NEED THE DIRECTORY FOR THIS LABEL SET */
  SELECT WORKING_DIRECTORY FROM SYS_EQUIP 
  WHERE DEVICE_ID = :WK_PRINTER
  INTO :WK_FILE_PATH;
  
  WK_FILE_PATH2 = WK_FILE_PATH || 'DESPATCH' || WK_ORDER || WK_TRAN_DATE || '.1XT';
  WK_FILE_PATH3 = WK_FILE_PATH || 'DESP_' || WK_ORDER || '_' || WK_TRAN_DATE || '.TXT';
  /* do header */
  FOR SELECT DESCRIPTION
  FROM OPTIONS  
  WHERE GROUP_CODE = 'DEV-HEAD'
  AND VSUBSTRING(CODE,1,3) =  :WK_PRINTER
  ORDER BY CODE
  INTO :WK_DESCRIPTION
  DO
  BEGIN
     IF (WK_DESCRIPTION IS NULL) THEN
     BEGIN
        WK_DESCRIPTION = '';
     END
     ELSE
     BEGIN
        WK_LABEL = WK_DESCRIPTION;
        WK_RESULT = FILE_WRITELN(:WK_FILE_PATH2, :WK_LABEL);
     END
  END
  /* data */
  WK_LINE_CNT = 0;
  WK_PAGE_CNT = 0;
  WK_LINE_PER_PAGE = 67;
  WK_PRECODE = '';
  SELECT COMPANY_ID || P_COUNTRY
  FROM PICK_ORDER
  WHERE PICK_ORDER = :WK_ORDER
  INTO :WK_PRECODE ;
  WK_PRECODE = '';
  FOR SELECT DESCRIPTION
  FROM PICK_FORM  
  WHERE PICK_ORDER = :WK_ORDER
  ORDER BY SEQ
  INTO :WK_DESCRIPTION
  DO
  BEGIN
     IF (WK_DESCRIPTION IS NULL) THEN
     BEGIN
        WK_DESCRIPTION = '';
     END
     WK_LINE_CNT = WK_LINE_CNT + 1;
     /* replace form feeds by line feeds */
     IF (LEN(WK_DESCRIPTION) > 2) THEN
     BEGIN
        WK_FIRST_2 = VSUBSTRING(WK_DESCRIPTION,1,3);
        IF (WK_FIRST_2 = '') THEN
        BEGIN
           WHILE (WK_LINE_CNT < WK_LINE_PER_PAGE) DO
           BEGIN
              WK_LABEL = ' ';
              WK_RESULT = FILE_WRITELN(:WK_FILE_PATH2, :WK_LABEL);
              WK_LINE_CNT = WK_LINE_CNT + 1;
           END
           WK_LINE_CNT = 1;
           WK_PAGE_CNT = 2;
        END
     END
     /* for 1st line add spaces to match a \r\f string */
     IF ((WK_LINE_CNT = 1) AND (WK_PAGE_CNT = 0)) THEN
     BEGIN
           WK_DESCRIPTION2 = WK_DESCRIPTION ;
           WK_DESCRIPTION = '  ' || WK_DESCRIPTION2;
     END
     /* check for for new page but no formfeed */
     IF (LEN(WK_DESCRIPTION) > 25) THEN
     BEGIN
        WK_DESCRIPTION2 = VSUBSTRING(WK_DESCRIPTION || '   ',1,22);
        IF (WK_DESCRIPTION2 = 'Despatch Note - Zone:') THEN
        BEGIN
           WK_DESCRIPTION2 = WK_DESCRIPTION ;
           WK_DESCRIPTION = '  ' || WK_DESCRIPTION2;
           WK_LINE_CNT = 1;
        END
     END
     /* add pre code to 1st line on page */
     IF (WK_LINE_CNT = 1) THEN
     BEGIN
        WK_DESCRIPTION2 = VSUBSTRING(WK_DESCRIPTION || '   ',3,LEN(WK_DESCRIPTION) + 1);
        WK_DESCRIPTION = WK_PRECODE || WK_DESCRIPTION2;

        /* check for picked by */
        /* IF (WK_DESCRIPTION2 = 'Picked by (Operator') THEN */
        /* get users who picked this */
        WK_USERS = '';
        FOR SELECT DISTINCT USER_ID
        FROM PICK_ITEM 
        WHERE PICK_ORDER = :WK_ORDER
        AND (USER_ID IS NOT NULL)
        INTO :WK_USER
        DO
        BEGIN
           IF ((LEN(WK_USER) + LEN(WK_USERS)) < 20) THEN
           BEGIN
              WK_USERS = WK_USERS || WK_USER || ' ';
           END
        END
        WK_DESCRIPTION2 = VSUBSTRING(WK_DESCRIPTION,1,26);
        WK_DESCRIPTION3 = VSUBSTRING(WK_DESCRIPTION || '   ',LEN(WK_USERS) + 26,LEN(WK_DESCRIPTION) + 1);
        WK_DESCRIPTION = WK_DESCRIPTION2 || WK_USERS || WK_DESCRIPTION3;
     END

     /* do prod thing */
     IF (LEN(WK_DESCRIPTION) > 48) THEN
     BEGIN
        WK_PROD = VSUBSTRING(WK_DESCRIPTION, 42, 47);
        WK_PICK_STATUS = '';
        WK_PICKED_QTY = 0;
        /* check that the prod exists */
        SELECT PICKED_QTY,PICK_LINE_STATUS
        FROM PICK_ITEM
        WHERE PICK_ORDER = :WK_ORDER
        AND PROD_ID = :WK_PROD
        INTO :WK_PICKED_QTY, WK_PICK_STATUS;
        IF (WK_PICKED_QTY IS NULL) THEN
        BEGIN
           WK_PICKED_QTY = 0;
        END
        IF (WK_PICK_STATUS IS NULL) THEN
        BEGIN
           WK_PICK_STATUS = '';
        END
        IF (WK_PICK_STATUS = '') THEN
        BEGIN
           /* not a pick line so do nothing */
           WK_LABEL = VSUBSTRING(WK_DESCRIPTION || '  ',1, LEN(WK_DESCRIPTION));
        END
        ELSE
        BEGIN
           WK_PICKED_LINE = WK_PICK_STATUS || LPAD(WK_PICKED_QTY,' ',7) || '  ';
           WK_DESCRIPTION2 = VSUBSTRING(WK_DESCRIPTION || '  ',12,LEN(WK_DESCRIPTION));
           WK_LABEL = WK_PICKED_LINE || WK_DESCRIPTION2;
        END
     END
     ELSE
     BEGIN
        WK_LABEL = VSUBSTRING(WK_DESCRIPTION || '  ',1, LEN(WK_DESCRIPTION));
     END
     WK_RESULT = FILE_WRITELN(:WK_FILE_PATH2, :WK_LABEL);
  END
  /* do footer */
  FOR SELECT DESCRIPTION
  FROM OPTIONS  
  WHERE GROUP_CODE = 'DEV-FOOT'
  AND VSUBSTRING(CODE,1,3) =  :WK_PRINTER
  ORDER BY CODE
  INTO :WK_DESCRIPTION
  DO
  BEGIN
     IF (WK_DESCRIPTION IS NULL) THEN
     BEGIN
        WK_DESCRIPTION = '';
     END
     ELSE
     BEGIN
        WK_LABEL = WK_DESCRIPTION;
        WK_RESULT = FILE_WRITELN(:WK_FILE_PATH2, :WK_LABEL);
     END
  END
  WK_RESULT = FILE_RENAME(:WK_FILE_PATH2, :WK_FILE_PATH3);
  
END ^

ALTER PROCEDURE PC_LABEL_GRN (DEVICE_ID CHAR(2) CHARACTER SET NONE,
PRN_COPY INTEGER,
GRN VARCHAR(10) CHARACTER SET NONE,
GRN_LABEL_NO VARCHAR(10) CHARACTER SET NONE,
PERSON_ID VARCHAR(10) CHARACTER SET NONE)
RETURNS (RES INTEGER,
ERROR_TEXT VARCHAR(1024) CHARACTER SET NONE,
DO_BARTENDER CHAR(1) CHARACTER SET NONE)
AS 
DECLARE VARIABLE WK_COPIES INTEGER;
DECLARE VARIABLE WK_RESULT INTEGER;
DECLARE VARIABLE WK_DO_BARTENDER CHAR(1);
DECLARE VARIABLE WK_LABEL_TYPE CHAR(1);
DECLARE VARIABLE WK_LABEL_USE_EXTERNAL CHAR(1);
DECLARE VARIABLE WK_LABEL_FIELD_WRAPPER CHAR(1);
DECLARE VARIABLE WK_BUFFER VARCHAR(40);
DECLARE VARIABLE WK_LABEL_PART VARCHAR(32000);
DECLARE VARIABLE WK_LABEL_PREFIX VARCHAR(32000);
DECLARE VARIABLE WK_WHERE VARCHAR(100);
DECLARE VARIABLE WK_ERROR_TEXT VARCHAR(1024);
DECLARE VARIABLE WK_LABEL_DATA VARCHAR(32000) ;
DECLARE VARIABLE WK_USER VARCHAR(10);
DECLARE VARIABLE WK_LABEL_PRINTER  CHAR(2);
DECLARE VARIABLE WK_GRN  VARCHAR(10);
DECLARE VARIABLE WK_GRN_LABEL_NO  VARCHAR(10);

BEGIN 
  
/*
  passed qty of labels
         printer
         grn
         grn label no
         user
         */
   WK_LABEL_PRINTER = DEVICE_ID;
   WK_LABEL_PREFIX = '';
   WK_USER = PERSON_ID;
   WK_GRN  = GRN;
   WK_GRN_LABEL_NO  = GRN_LABEL_NO;
   WK_COPIES = PRN_COPY;
   SELECT GENERATE_LABEL_TEXT, 
          EXTERNAL_SCRIPT_4_LABEL,
          LABEL_FIELD_WRAPPER 
   FROM CONTROL
   INTO :WK_LABEL_TYPE, 
        :WK_LABEL_USE_EXTERNAL,
        :WK_LABEL_FIELD_WRAPPER;
   IF (WK_LABEL_TYPE IS NULL) THEN
   BEGIN
      WK_LABEL_TYPE = 'F';
   END
   IF (WK_LABEL_TYPE = '') THEN
   BEGIN
      WK_LABEL_TYPE = 'F';
   END
   IF (WK_LABEL_USE_EXTERNAL IS NULL) THEN
   BEGIN
      WK_LABEL_USE_EXTERNAL = 'F';
   END
   IF (WK_LABEL_USE_EXTERNAL = '') THEN
   BEGIN
      WK_LABEL_USE_EXTERNAL = 'F';
   END
   IF (WK_LABEL_FIELD_WRAPPER IS NULL) THEN
   BEGIN
      WK_LABEL_FIELD_WRAPPER = '%';
   END
   IF (WK_LABEL_PRINTER IS NULL) THEN
   BEGIN
      WK_LABEL_PRINTER = 'PA';
   END
   IF (WK_LABEL_PREFIX IS NULL) THEN
   BEGIN
      WK_LABEL_PREFIX  = '';
   END
   WK_DO_BARTENDER = 'F';
   /* now must print a label */
   WK_RESULT = 0;
   WK_ERROR_TEXT = '';
   IF (WK_LABEL_USE_EXTERNAL = 'F') THEN
   BEGIN
      IF (WK_LABEL_TYPE = 'F') THEN
      BEGIN
         /* use pc_label for label creation */
         WK_RESULT = 0;
         WK_LABEL_DATA = '';
         WK_LABEL_PART = '';
         WK_WHERE = " WHERE GRN='" || WK_GRN || "'";
         EXECUTE PROCEDURE GET_TABLE_DATA ('GRN', WK_LABEL_FIELD_WRAPPER, '|', :WK_WHERE)
         RETURNING_VALUES :WK_LABEL_PART;
         IF (WK_LABEL_PART IS NULL) THEN
         BEGIN
            WK_LABEL_PART = '';
         END
         WK_LABEL_DATA = WK_LABEL_DATA || :WK_LABEL_PART;
         WK_WHERE = " WHERE GRN_LABEL_NO='" || WK_GRN_LABEL_NO || "'";
         EXECUTE PROCEDURE GET_TABLE_DATA ('GRN_ORDER', WK_LABEL_FIELD_WRAPPER, '|', :WK_WHERE)
         RETURNING_VALUES :WK_LABEL_PART;
         IF (WK_LABEL_PART IS NULL) THEN
         BEGIN
            WK_LABEL_PART = '';
         END
         WK_LABEL_DATA = WK_LABEL_DATA || :WK_LABEL_PART;

         EXECUTE  PROCEDURE PC_LABEL (:WK_LABEL_PRINTER ,
                  'GRNORDER' , 
                  :WK_COPIES ,
                  NULL ,
                  :WK_LABEL_DATA ,
                  :WK_USER )
         RETURNING_VALUES :WK_RESULT ,
                          :WK_ERROR_TEXT ;
      END
      ELSE
      BEGIN
         /* use bartender for printing */
         WK_DO_BARTENDER = 'T';
      END
   END
   ELSE
   BEGIN
      IF (WK_LABEL_TYPE = 'F') THEN
      BEGIN
         /* use error text to pass back data for label creation */
      END
      ELSE
      BEGIN
         /* use bartender for printing */
         WK_DO_BARTENDER = 'T';
      END
   END
   DO_BARTENDER = WK_DO_BARTENDER;
   RES = WK_RESULT;
   ERROR_TEXT = WK_ERROR_TEXT;
   SUSPEND;
END ^

ALTER PROCEDURE PC_LABEL_ISSN (REFERENCE VARCHAR(40) CHARACTER SET NONE)
RETURNS (RES INTEGER)
AS 
DECLARE VARIABLE SFILEPATH VARCHAR(70);
  DECLARE VARIABLE SFILEPATH2 VARCHAR(70);
  DECLARE VARIABLE SPRINTERNAME CHAR(2);
  DECLARE VARIABLE SREF VARCHAR(40);
  DECLARE VARIABLE SLOADNO VARCHAR(20);
  DECLARE VARIABLE SLABEL VARCHAR(1020);
  DECLARE VARIABLE SDESC VARCHAR(255);
  DECLARE VARIABLE SLLOCN CHAR(1);
  DECLARE VARIABLE SSSN VARCHAR(20);
  
BEGIN 
  
  /* GET THE PRINTER DIR */
  SPRINTERNAME = SUBSTR(:REFERENCE,1,2);
  SREF = SUBSTR(:REFERENCE,3,STRLEN(:REFERENCE));
  
  /* NEED THE DIRECTORY FOR THIS LABEL SET */
  SELECT WORKING_DIRECTORY FROM SYS_EQUIP 
  WHERE DEVICE_ID = :SPRINTERNAME
  INTO :SFILEPATH;
  
  SFILEPATH2 = SFILEPATH || 'ISSN.TXT';
       
  SELECT G.ORDER_NO
  FROM GRN G, SSN S, ISSN I
  WHERE G.GRN = S.GRN
  AND S.SSN_ID = I.ORIGINAL_SSN
  AND I.SSN_ID = :SREF
  INTO :SLOADNO;

  IF (SLOADNO IS NULL) THEN
  BEGIN
     SELECT LEGACY_ID 
     FROM SSN , ISSN
     WHERE SSN.SSN_ID = ISSN.ORIGINAL_SSN
     AND ISSN.SSN_ID = :SREF
     INTO :SLOADNO;
  END
  
  SELECT SSN.SSN_DESCRIPTION ,SSN.LABEL_LOCN, SSN.SSN_ID
  FROM SSN , ISSN
  WHERE SSN.SSN_ID = ISSN.ORIGINAL_SSN
  AND ISSN.SSN_ID = :SREF
  INTO :SDESC, :SLLOCN, :SSSN;

  IF (SLOADNO IS NULL) THEN
  BEGIN
     SLOADNO = '';
  END
  IF (SLLOCN = 'M') THEN
  BEGIN
     /* SLABEL = '"_' || :SSSN || '",' || DQUOTEDSTR(NONULL(:SLOADNO)) || ',' || 
           DQUOTEDSTR('1') || ',' || DQUOTEDSTR(:SPRINTERNAME) || ',' ||
           DQUOTEDSTR(:SDESC);
     */
     SLABEL = '"_' || :SSSN || '","' || :SLOADNO || '","' || 
           '1' || '","' || :SPRINTERNAME || '","' ||
           :SDESC || '"';
  END
  ELSE
  BEGIN
     /* SLABEL = DQUOTEDSTR(:SREF) || ',' || DQUOTEDSTR(NONULL(:SLOADNO)) || ',' || 
           DQUOTEDSTR('1') || ',' || DQUOTEDSTR(:SPRINTERNAME) || ',' ||
           DQUOTEDSTR(:SDESC);
     */
     SLABEL = '"' || :SREF || '","' || :SLOADNO || '","' || 
           '1' || '","' || :SPRINTERNAME || '","' ||
           :SDESC || '"';
  END
  
  RES = FILE_WRITELN(:SFILEPATH2, :SLABEL);
  IF (RES <> 0) THEN
  BEGIN
     SFILEPATH2 = SFILEPATH || 'ISSN.2XT';
     RES = FILE_WRITELN(:SFILEPATH2, :SLABEL);
  END   

END ^

ALTER PROCEDURE PC_LABEL_LATER (PRINT_DEVICE_ID CHAR(2) CHARACTER SET NONE,
PRN_TYPE VARCHAR(40) CHARACTER SET NONE,
PRN_COPY INTEGER,
PRN_FILE_NAME VARCHAR(70) CHARACTER SET NONE,
PRN_DATA VARCHAR(32000) CHARACTER SET NONE,
PERSON_ID VARCHAR(10) CHARACTER SET NONE,
DEVICE_ID CHAR(2) CHARACTER SET NONE)
RETURNS (RES INTEGER,
ERROR_TEXT VARCHAR(1024) CHARACTER SET NONE)
AS 
DECLARE VARIABLE WK_DEVICE_ID CHAR(2);
DECLARE VARIABLE WK_LABEL_TYPE VARCHAR(70);
DECLARE VARIABLE WK_COPIES INTEGER;
DECLARE VARIABLE WK_DO_SYSLABEL CHAR(2);
DECLARE VARIABLE WK_FORMAT VARCHAR(40);
DECLARE VARIABLE WK_FORMAT_LINES INTEGER;
DECLARE VARIABLE WK_RESULT INTEGER;
DECLARE VARIABLE WK_LOG_FILENAME VARCHAR(140);
DECLARE VARIABLE WK_GM_MESSAGE VARCHAR(10);
BEGIN 
   WK_LOG_FILENAME = '/tmp/pcLabelLater.log'; 
  /* insert into print_requests */
  /* with status NP  new request
			create the print file
                 CP  created print file
			send to the device
                 XP  completed */
  WK_DO_SYSLABEL = '';
  WK_GM_MESSAGE = '';
  SELECT GENERATE_LABEL_TEXT 
  FROM CONTROL
  INTO :WK_DO_SYSLABEL;
  IF (WK_DO_SYSLABEL = 'F') THEN
  BEGIN
     /* check that the format exists */
     WK_FORMAT = '';
     SELECT DESCRIPTION 
     FROM OPTIONS
     WHERE GROUP_CODE = (:PRINT_DEVICE_ID || '_FORMAT') 
     AND   CODE = :PRN_TYPE
     INTO :WK_FORMAT;
     IF (WK_FORMAT IS NULL) THEN
     BEGIN
        WK_FORMAT = '';
     END
     IF (WK_FORMAT = '') THEN
     BEGIN
        RES = -10;
        ERROR_TEXT = 'No Format for Type ' || :PRN_TYPE;
     END
     ELSE
     BEGIN
        WK_FORMAT_LINES = 0;
        SELECT COUNT(*)
        FROM SYS_LABEL
        WHERE SL_NAME = :WK_FORMAT
        INTO :WK_FORMAT_LINES;
        IF (WK_FORMAT_LINES IS NULL) THEN
        BEGIN
           WK_FORMAT_LINES = 0;
        END
        IF (WK_FORMAT_LINES > 0) THEN
        BEGIN
           SELECT MESSAGE_ID
           FROM GET_NEXT_MESSAGE
           INTO :WK_GM_MESSAGE;
           INSERT INTO PRINT_REQUESTS (DEVICE_ID, PRN_TYPE, PRN_COPY, BASE_FILE_NAME, PRN_DATA, PERSON_ID, REQUEST_STATUS, ERROR_TEXT, FROM_DEVICE_ID, MESSAGE_ID)
           VALUES ( :PRINT_DEVICE_ID, :PRN_TYPE, :PRN_COPY, '', :PRN_DATA, :PERSON_ID, 'LP', '', :DEVICE_ID, :WK_GM_MESSAGE);
           RES = 0;
           ERROR_TEXT = 'Print Request Sent';
        END
        ELSE
        BEGIN
           RES = -20;
           ERROR_TEXT = 'No Format Lines for Type ' || :PRN_TYPE || ' and Format ' || :WK_FORMAT;
        END
     END
  END
  ELSE
  BEGIN
     RES = -1;
     ERROR_TEXT = 'Bartender File - Not able to create Bartender files yet';
  END
  IF (STRLEN(PRN_DATA) > 40) THEN
  BEGIN
     INSERT INTO TRANSACTIONS_ARCHIVE (TRN_TYPE, TRN_CODE, WH_ID, OBJECT, QTY, REFERENCE, PERSON_ID, SUB_LOCN_ID, ERROR_TEXT, DEVICE_ID, TRN_DATE, INSTANCE_ID)
     VALUES ('PRRQ', 'L', :PRINT_DEVICE_ID, :PRN_TYPE, :PRN_COPY, V4SUBSTRING(:PRN_DATA, 1, 40), :PERSON_ID, 'LP', :ERROR_TEXT, :DEVICE_ID, 'NOW', :WK_GM_MESSAGE) ;
  END
  ELSE
  BEGIN
     INSERT INTO TRANSACTIONS_ARCHIVE (TRN_TYPE, TRN_CODE, WH_ID, OBJECT, QTY, REFERENCE, PERSON_ID, SUB_LOCN_ID, ERROR_TEXT, DEVICE_ID, TRN_DATE, INSTANCE_ID)
     VALUES ('PRRQ', 'L', :PRINT_DEVICE_ID, :PRN_TYPE, :PRN_COPY, :PRN_DATA, :PERSON_ID, 'LP', :ERROR_TEXT, :DEVICE_ID, 'NOW', :WK_GM_MESSAGE) ;
  END
  SUSPEND;

END ^

ALTER PROCEDURE PC_LABEL_LOAD (WH_ID VARCHAR(2) CHARACTER SET NONE,
REFERENCE VARCHAR(40) CHARACTER SET NONE,
LABEL_NO INTEGER)
RETURNS (RES INTEGER)
AS 
DECLARE VARIABLE iSSN_ID INTEGER;
  DECLARE VARIABLE P_SSN_ID INTEGER;
  DECLARE VARIABLE sORI_SSN_ID VARCHAR(20);
  DECLARE VARIABLE I_SSN_ID VARCHAR(20);
  DECLARE VARIABLE LEN_SSN_ID INTEGER;
  DECLARE VARIABLE I_LEN_SSN_ID INTEGER;
  DECLARE VARIABLE iSSN_LENGTH INTEGER;
  DECLARE VARIABLE iFIRST INTEGER;
  DECLARE VARIABLE WK_FIRST_SSN_ID VARCHAR(20);
  DECLARE VARIABLE GRN VARCHAR(10);
  DECLARE VARIABLE WK_PO_LINE CHAR(4);
  DECLARE VARIABLE WK_SUPPLIER VARCHAR(10);
  DECLARE VARIABLE WK_FILE_PATH VARCHAR(70);
  DECLARE VARIABLE WK_FILE_PATH2 VARCHAR(70);
  DECLARE VARIABLE WK_LABEL_PRINTER CHAR(2);
  DECLARE VARIABLE WK_ORDER_NO VARCHAR(40);  
  DECLARE VARIABLE WK_LABEL_LINE VARCHAR(256);
  DECLARE VARIABLE WK_DEFAULT_SSN_STATUS CHAR(2);
  DECLARE VARIABLE WK_NEW_LOCN_ID VARCHAR(10);
  DECLARE VARIABLE WK_COMPANY_ID VARCHAR(20);
  DECLARE VARIABLE WK_RESULT INTEGER;
  DECLARE VARIABLE WK_DO_BARTENDER CHAR(1);
  DECLARE VARIABLE WK_DEFAULT_PROD_STATUS CHAR(2);
  DECLARE VARIABLE WK_LABEL_TYPE CHAR(1);
  DECLARE VARIABLE WK_LABEL_USE_EXTERNAL CHAR(1);
  DECLARE VARIABLE WK_LABEL_FIELD_WRAPPER CHAR(1);
  DECLARE VARIABLE WK_BUFFER VARCHAR(40);
  DECLARE VARIABLE WK_LABEL_PART VARCHAR(32000);
  DECLARE VARIABLE WK_LABEL_PREFIX VARCHAR(32000);
  DECLARE VARIABLE WK_WHERE VARCHAR(100);
  DECLARE VARIABLE WK_ERROR_TEXT VARCHAR(1024);
  DECLARE VARIABLE WK_LABEL_DATA VARCHAR(32000) ;
  DECLARE VARIABLE WK_USER VARCHAR(10);
BEGIN 
   SELECT NEW_LABEL_LOCN_ID FROM CONTROL INTO :WK_NEW_LOCN_ID;
   WK_LABEL_PRINTER = SUBSTR(:REFERENCE,1,2);
   WK_ORDER_NO = SUBSTR(:REFERENCE,3,STRLEN(:REFERENCE));
   SELECT NEW_SSN_STATUS, 
          NEW_PROD_STATUS, 
          GENERATE_LABEL_TEXT, 
          EXTERNAL_SCRIPT_4_LABEL,
          LABEL_FIELD_WRAPPER 
   FROM CONTROL
   INTO :WK_DEFAULT_SSN_STATUS, 
        :WK_DEFAULT_PROD_STATUS, 
        :WK_LABEL_TYPE, 
        :WK_LABEL_USE_EXTERNAL,
        :WK_LABEL_FIELD_WRAPPER;
   IF (WK_LABEL_TYPE IS NULL) THEN
   BEGIN
      WK_LABEL_TYPE = 'F';
   END
   IF (WK_LABEL_TYPE = '') THEN
   BEGIN
      WK_LABEL_TYPE = 'F';
   END
   IF (WK_LABEL_USE_EXTERNAL IS NULL) THEN
   BEGIN
      WK_LABEL_USE_EXTERNAL = 'F';
   END
   IF (WK_LABEL_USE_EXTERNAL = '') THEN
   BEGIN
      WK_LABEL_USE_EXTERNAL = 'F';
   END
   IF (WK_LABEL_FIELD_WRAPPER IS NULL) THEN
   BEGIN
      WK_LABEL_FIELD_WRAPPER = '%';
   END
   IF (WK_LABEL_PRINTER IS NULL) THEN
   BEGIN
      WK_LABEL_PRINTER = 'PA';
   END
   IF (WK_LABEL_PREFIX IS NULL) THEN
   BEGIN
      WK_LABEL_PREFIX  = '';
   END
   WK_USER = 'BDCS';
   /* Get the printer dir */
   /* Need the directory for this label set */
   SELECT WORKING_DIRECTORY FROM SYS_EQUIP 
   WHERE DEVICE_ID = :WK_LABEL_PRINTER
   INTO :WK_FILE_PATH;
   WK_FILE_PATH2 = WK_FILE_PATH || 'Load.txt';
   /* Get length for Barcode */   
   EXECUTE PROCEDURE GET_BARCODE_LENGTH RETURNING_VALUES iSSN_LENGTH;
   iSSN_ID = GEN_ID(ISSN_SSN_ID, :LABEL_NO);
   P_SSN_ID = iSSN_ID - :LABEL_NO;
   LEN_SSN_ID = STRLEN(P_SSN_ID);
   /* Get the first matching SSN */
   /* FROM SSN S JOIN  GRN G */
   SELECT FIRST 1 S.SSN_ID, S.GRN, S.PO_LINE, S.SUPPLIER_ID, S.COMPANY_ID
   FROM GRN G JOIN  SSN S
   ON  G.GRN = S.GRN
   WHERE G.ORDER_NO = :WK_ORDER_NO
   INTO :sORI_SSN_ID, :GRN, :WK_PO_LINE, :WK_SUPPLIER, :WK_COMPANY_ID;
   iFIRST = P_SSN_ID;
   /* Insert data into ISSN table */
   WHILE (P_SSN_ID < iSSN_ID) DO
   BEGIN
      I_SSN_ID = '';
      I_LEN_SSN_ID = STRLEN(P_SSN_ID);
      /* Padding leading with 0 */
      WHILE (I_LEN_SSN_ID < :iSSN_LENGTH) DO
      BEGIN
       I_SSN_ID = I_SSN_ID || '0';
       I_LEN_SSN_ID = I_LEN_SSN_ID + 1;
      END
      I_SSN_ID = I_SSN_ID || P_SSN_ID;
      /* Get the first SSNId */
      IF (iFIRST = P_SSN_ID) THEN
      BEGIN
         WK_FIRST_SSN_ID = I_SSN_ID;
      END
/*
      INSERT INTO ISSN (SSN_ID, ORIGINAL_SSN, WH_ID, LOCN_ID)
      VALUES (:I_SSN_ID, :sORI_SSN_ID, :WH_ID, 'RPNEWLABEL'); 
      VALUES (:I_SSN_ID, :WH_ID, 'NEWLABEL', :GRN, 'TS', 'NOW', 1, 1, :WK_ORDER_NO, 'NOW', :WK_PO_LINE, :WK_SUPPLIER);     
      VALUES (:I_SSN_ID, :I_SSN_ID, :WH_ID, 'NEWLABEL', 1, 'TS'); 
*/
      INSERT INTO SSN (SSN_ID, WH_ID, LOCN_ID, GRN, STATUS_SSN, LABEL_DATE, ORIGINAL_QTY,
                 CURRENT_QTY, PO_ORDER, PO_RECEIVE_DATE, PO_LINE, SUPPLIER_ID, CREATE_DATE, COMPANY_ID)
      VALUES (:I_SSN_ID, :WH_ID, :WK_NEW_LOCN_ID, :GRN, :WK_DEFAULT_SSN_STATUS, 'NOW', 1, 1, :WK_ORDER_NO, 'NOW', :WK_PO_LINE, :WK_SUPPLIER, 'NOW', :WK_COMPANY_ID);     
      INSERT INTO ISSN (SSN_ID, ORIGINAL_SSN, WH_ID, LOCN_ID, CURRENT_QTY,ISSN_STATUS, CREATE_DATE, COMPANY_ID)
      VALUES (:I_SSN_ID, :I_SSN_ID, :WH_ID, :WK_NEW_LOCN_ID, 1, :WK_DEFAULT_SSN_STATUS, 'NOW', :WK_COMPANY_ID); 
      P_SSN_ID = P_SSN_ID + 1;
   END  
   /* now must print a label */
   WK_RESULT = 0;
   WK_DO_BARTENDER = 'T';
   IF (WK_LABEL_USE_EXTERNAL = 'F') THEN
   BEGIN
      IF (WK_LABEL_TYPE = 'F') THEN
      BEGIN
         /* use pc_label for label creation */
         WK_RESULT = 0;
         WK_LABEL_DATA = '';
         WK_LABEL_PART = '';
         WK_LABEL_DATA = WK_LABEL_DATA || :WK_LABEL_PREFIX;
         WK_WHERE = " WHERE SSN_ID='" || :WK_FIRST_SSN_ID  || "'";
         EXECUTE PROCEDURE GET_TABLE_DATA ('SSN', WK_LABEL_FIELD_WRAPPER, '|', :WK_WHERE)
         RETURNING_VALUES :WK_LABEL_PART;
         IF (WK_LABEL_PART IS NULL) THEN
         BEGIN
            WK_LABEL_PART = '';
         END
         WK_LABEL_DATA = WK_LABEL_DATA || :WK_LABEL_PART;
         WK_WHERE = " WHERE GRN='" || :GRN   || "'";
         EXECUTE PROCEDURE GET_TABLE_DATA ('GRN', WK_LABEL_FIELD_WRAPPER, '|', :WK_WHERE)
         RETURNING_VALUES :WK_LABEL_PART;
         IF (WK_LABEL_PART IS NULL) THEN
         BEGIN
            WK_LABEL_PART = '';
         END
         WK_LABEL_DATA = WK_LABEL_DATA || :WK_LABEL_PART;
         WK_WHERE = " WHERE SSN_ID='" || WK_FIRST_SSN_ID   || "'";
         EXECUTE PROCEDURE GET_TABLE_DATA ('ISSN', WK_LABEL_FIELD_WRAPPER, '|', :WK_WHERE)
         RETURNING_VALUES :WK_LABEL_PART;
         IF (WK_LABEL_PART IS NULL) THEN
         BEGIN
            WK_LABEL_PART = '';
         END
         WK_LABEL_DATA = WK_LABEL_DATA || :WK_LABEL_PART;
         WK_DO_BARTENDER = 'F';
         /* now write to print_requests */
         EXECUTE  PROCEDURE PC_LABEL (:WK_LABEL_PRINTER ,
                  'LOAD' , 
                  :LABEL_NO ,
                  NULL ,
                  :WK_LABEL_DATA ,
                  :WK_USER )
         RETURNING_VALUES :WK_RESULT ,
                           :WK_ERROR_TEXT ;
      END
   END

   IF (WK_DO_BARTENDER = 'T') THEN
   BEGIN
      /* Write data to file */
      /*
      WK_LABEL_LINE = DQUOTEDSTR(:WK_FIRST_SSN_ID) || ',' || 
         DQUOTEDSTR(:WK_ORDER_NO) || ',' ||                 
         DQUOTEDSTR(:LABEL_NO) || ',' ||                 
              DQUOTEDSTR(:WK_LABEL_PRINTER);
      */
      WK_LABEL_LINE = '"' || :WK_FIRST_SSN_ID || '","' ||
                  :WK_ORDER_NO || '","' ||
                  :LABEL_NO || '","' ||
                  :WK_LABEL_PRINTER || '"' ;
      WK_RESULT = FILE_WRITELN(:WK_FILE_PATH2, :WK_LABEL_LINE);
      IF (WK_RESULT <> 0) THEN
      BEGIN
         WK_FILE_PATH2 = WK_FILE_PATH || 'Load.2xt';
         WK_RESULT = FILE_WRITELN(:WK_FILE_PATH2, :WK_LABEL_LINE);
      END   
   END   
   RES = WK_RESULT;
END ^

ALTER PROCEDURE PC_LABEL_LOCATION (REFERENCE VARCHAR(40) CHARACTER SET NONE)
RETURNS (RES INTEGER)
AS 
 
    
  DECLARE VARIABLE sFilePath VARCHAR(70);
  DECLARE VARIABLE sFilePath2 VARCHAR(70);
  DECLARE VARIABLE sPrinterName CHAR(2);
  DECLARE VARIABLE sRef VARCHAR(40);  
  DECLARE VARIABLE WK_1ST_FIELD VARCHAR(40);  
  DECLARE VARIABLE WK_2ND_FIELD VARCHAR(40);  
  DECLARE VARIABLE sLabel VARCHAR(256);
  DECLARE VARIABLE WK_HAVE_FILE_1 INTEGER;
  DECLARE VARIABLE WK_HAVE_FILE_2 INTEGER;
  DECLARE VARIABLE WK_FILENAME VARCHAR(100);  
  DECLARE VARIABLE WK_FILENAME2 VARCHAR(100);  
  DECLARE VARIABLE WK_LOCN_NAME VARCHAR(50);  
  DECLARE VARIABLE WK_WH_ID VARCHAR(2);  
  DECLARE VARIABLE WK_LOCN_ID VARCHAR(10);  
  DECLARE VARIABLE WK_STORE_AREA VARCHAR(2);  
  DECLARE VARIABLE WK_WH_FROM VARCHAR(2);  
  DECLARE VARIABLE WK_WH_TO VARCHAR(2);  
  DECLARE VARIABLE WK_LOCN_FROM VARCHAR(10);  
  DECLARE VARIABLE WK_LOCN_TO VARCHAR(10);  
  
BEGIN 
  
  WK_HAVE_FILE_1 = 0;
  WK_HAVE_FILE_2 = 0;
  /* Get the printer dir */
  sPrinterName = SUBSTR(:REFERENCE,1,2);
  sRef = SUBSTR(:REFERENCE,3,STRLEN(:REFERENCE));
  
   WK_1ST_FIELD = '';
   WK_2ND_FIELD = '';
   SELECT WK_FIELD_TEXT 
   FROM GET_REFERENCE_FIELD4 (:sRef, 1, '|') 
   INTO :WK_1ST_FIELD;
   SELECT WK_FIELD_TEXT 
   FROM GET_REFERENCE_FIELD4 (:sRef, 2, '|') 
   INTO :WK_2ND_FIELD;
  /* Need the directory for this label set */
  SELECT WORKING_DIRECTORY FROM SYS_EQUIP 
  WHERE DEVICE_ID = :sPrinterName
  INTO :sFilePath;
  
       
  IF (WK_2ND_FIELD > '') THEN
  BEGIN
     WK_WH_FROM = SUBSTR(WK_1ST_FIELD, 1, 2);
     WK_WH_TO = SUBSTR(WK_2ND_FIELD, 1, 2);
     WK_LOCN_FROM = SUBSTR(WK_1ST_FIELD, 3, 10);
     WK_LOCN_TO = SUBSTR(WK_2ND_FIELD, 3, 10);

     FOR SELECT WH_ID, LOCN_ID, LOCN_NAME, STORE_AREA
     FROM LOCATION 
     WHERE
        (((WH_ID > :WK_WH_FROM) OR (WH_ID = :WK_WH_FROM AND LOCN_ID >= :WK_LOCN_FROM)) AND
         ((WH_ID < :WK_WH_TO) OR (WH_ID = :WK_WH_TO AND LOCN_ID <= :WK_LOCN_TO)))
     ORDER BY WH_ID, LOCN_ID
     INTO :WK_WH_ID, :WK_LOCN_ID, :WK_LOCN_NAME, :WK_STORE_AREA
     DO 
     BEGIN
        IF (WK_LOCN_NAME IS NULL) THEN
        BEGIN
           WK_LOCN_NAME = WK_LOCN_ID;
        END
        IF (WK_STORE_AREA IS NULL) THEN
        BEGIN
           WK_STORE_AREA = '';
        END
        sFilePath2 = sFilePath || 'Location.2xt';
        sLabel = '"' || WK_WH_ID || WK_LOCN_ID || '","' || :sPrinterName || '","' || :WK_STORE_AREA || '","' || :WK_LOCN_NAME || '"';
        RES = FILE_WRITELN(:sFilePath2, :sLabel);
        IF (RES <> 0) THEN
        BEGIN
           sFilePath2 = sFilePath || 'Location.uxt';
           RES = FILE_WRITELN(:sFilePath2, :sLabel);
           WK_HAVE_FILE_2 = 1;
        END   
        ELSE
        BEGIN
           WK_HAVE_FILE_1 = 1;
        END
     END
  END
  ELSE
  BEGIN
     sLabel = DQUOTEDSTR(:sRef) || ',' || DQUOTEDSTR(:sPrinterName);
     RES = FILE_WRITELN(:sFilePath2, :sLabel);
     IF (RES <> 0) THEN
     BEGIN
        sFilePath2 = sFilePath || 'Location.uxt';
        RES = FILE_WRITELN(:sFilePath2, :sLabel);
        WK_HAVE_FILE_2 = 1;
     END   
     ELSE
     BEGIN
        WK_HAVE_FILE_1 = 1;
     END

  END
  
  /* do renames */
   IF (WK_HAVE_FILE_1 = 1) THEN
   BEGIN
      /* rename load.2xt to load.txt */
      WK_FILENAME = sFilePath || 'Location.2xt';
      WK_FILENAME2 = sFilePath || 'Location.txt';
      RES = FILE_RENAME(WK_FILENAME, WK_FILENAME2);
   END
   IF (WK_HAVE_FILE_2 = 1) THEN
   BEGIN
      /* rename load.uxt to load.txt */
      WK_FILENAME = sFilePath || 'Location.uxt';
      WK_FILENAME2 = sFilePath || 'Location2.txt';
      RES = FILE_RENAME(WK_FILENAME, WK_FILENAME2);
   END
  
END ^

ALTER PROCEDURE PC_LABEL_LOC_ISSN (REFERENCE VARCHAR(40) CHARACTER SET NONE)
RETURNS (RES INTEGER)
AS 
DECLARE VARIABLE sFilePath VARCHAR(70);
  DECLARE VARIABLE sFilePath2 VARCHAR(70);
  DECLARE VARIABLE sPrinterName CHAR(2);
  DECLARE VARIABLE sRef VARCHAR(40);  
  DECLARE VARIABLE WK_1ST_FIELD VARCHAR(40);  
  DECLARE VARIABLE WK_2ND_FIELD VARCHAR(40);  
  DECLARE VARIABLE WK_3RD_FIELD VARCHAR(40);  
  DECLARE VARIABLE sLabel VARCHAR(256);
  DECLARE VARIABLE WK_HAVE_FILE_1 INTEGER;
  DECLARE VARIABLE WK_HAVE_FILE_2 INTEGER;
  DECLARE VARIABLE WK_FILENAME VARCHAR(100);  
  DECLARE VARIABLE WK_FILENAME2 VARCHAR(100);  
  DECLARE VARIABLE WK_LOCN_NAME VARCHAR(50);  
  DECLARE VARIABLE WK_WH_ID VARCHAR(2);  
  DECLARE VARIABLE WK_LOCN_ID VARCHAR(10);  
  DECLARE VARIABLE WK_STORE_AREA VARCHAR(2);  
  DECLARE VARIABLE WK_WH_FROM VARCHAR(2);  
  DECLARE VARIABLE WK_WH_TO VARCHAR(2);  
  DECLARE VARIABLE WK_LOCN_FROM VARCHAR(10);  
  DECLARE VARIABLE WK_LOCN_TO VARCHAR(10);  
  DECLARE VARIABLE WK_COPYS INTEGER;  
  DECLARE VARIABLE WK_SSN_ID VARCHAR(20);  
  DECLARE VARIABLE WK_ORIGINAL_SSN VARCHAR(20);  
  DECLARE VARIABLE WK_LOADNO VARCHAR(10);  
  DECLARE VARIABLE WK_DESC VARCHAR(80);  
  DECLARE VARIABLE WK_LABEL_LOCN VARCHAR(10);  
  
BEGIN 
  
  WK_HAVE_FILE_1 = 0;
  WK_HAVE_FILE_2 = 0;
  /* Get the printer dir */
  sPrinterName = SUBSTR(:REFERENCE,1,2);
  sRef = SUBSTR(:REFERENCE,3,STRLEN(:REFERENCE));
  
   WK_1ST_FIELD = '';
   WK_2ND_FIELD = '';
   SELECT WK_FIELD_TEXT 
   FROM GET_REFERENCE_FIELD4 (:sRef, 1, '|') 
   INTO :WK_1ST_FIELD;
   SELECT WK_FIELD_TEXT 
   FROM GET_REFERENCE_FIELD4 (:sRef, 2, '|') 
   INTO :WK_2ND_FIELD;
   SELECT WK_FIELD_TEXT 
   FROM GET_REFERENCE_FIELD4 (:sRef, 3, '|') 
   INTO :WK_3RD_FIELD;
  /* Need the directory for this label set */
  SELECT WORKING_DIRECTORY FROM SYS_EQUIP 
  WHERE DEVICE_ID = :sPrinterName
  INTO :sFilePath;
  
       
  BEGIN
     WK_WH_FROM = SUBSTR(WK_1ST_FIELD, 1, 2);
     WK_WH_TO = SUBSTR(WK_2ND_FIELD, 1, 2);
     WK_LOCN_FROM = SUBSTR(WK_1ST_FIELD, 3, 10);
     WK_LOCN_TO = SUBSTR(WK_2ND_FIELD, 3, 10);
     WK_COPYS = WK_3RD_FIELD;

     FOR SELECT WH_ID, LOCN_ID, SSN_ID, ORIGINAL_SSN
     FROM ISSN 
     WHERE
        (((WH_ID > :WK_WH_FROM) OR (WH_ID = :WK_WH_FROM AND LOCN_ID >= :WK_LOCN_FROM)) AND
         ((WH_ID < :WK_WH_TO) OR (WH_ID = :WK_WH_TO AND LOCN_ID <= :WK_LOCN_TO)))
         AND (CURRENT_QTY > 0)
     ORDER BY WH_ID, LOCN_ID, SSN_ID
     INTO :WK_WH_ID, :WK_LOCN_ID, :WK_SSN_ID, :WK_ORIGINAL_SSN
     DO 
     BEGIN
        /* get ssn info */
        SELECT G.ORDER_NO
        FROM GRN G, SSN S
        WHERE G.GRN = S.GRN
        AND S.SSN_ID = :WK_ORIGINAL_SSN
        INTO :WK_LOADNO;

        IF (WK_LOADNO IS NULL) THEN
        BEGIN
           SELECT LEGACY_ID 
           FROM SSN 
           WHERE SSN_ID = :WK_ORIGINAL_SSN
           INTO :WK_LOADNO;
        END
  
        IF (WK_LOADNO IS NULL) THEN
        BEGIN
           WK_LOADNO = '';
        END

        SELECT SSN.SSN_DESCRIPTION ,SSN.LABEL_LOCN 
        FROM SSN 
        WHERE SSN_ID = :WK_ORIGINAL_SSN
        INTO :WK_DESC, :WK_LABEL_LOCN ;

        IF (WK_LABEL_LOCN = 'M') THEN
        BEGIN
        /* SLABEL = '"_' || :WK_ORIGINAL_SSN || '",' || DQUOTEDSTR(NONULL(:WK_LOADNO)) || ',' || 
                 DQUOTEDSTR(WK_3RD_FIELD) || ',' || DQUOTEDSTR(:SPRINTERNAME) || ',' ||
                 DQUOTEDSTR(:WK_DESC); */
            SLABEL = '"' || :WK_ORIGINAL_SSN || '","' || :WK_LOADNO || '","' || 
           :WK_3RD_FIELD || '","' || :SPRINTERNAME || '","' ||
           :WK_DESC || '"';
        END
        ELSE
        BEGIN
        /* SLABEL = DQUOTEDSTR(:WK_SSN_ID) || ',' || DQUOTEDSTR(NONULL(:WK_LOADNO)) || ',' || 
                 DQUOTEDSTR(WK_3RD_FIELD) || ',' || DQUOTEDSTR(:SPRINTERNAME) || ',' ||
                 DQUOTEDSTR(:WK_DESC); */
            SLABEL = '"' || :WK_SSN_ID || '","' || :WK_LOADNO || '","' || 
           :WK_3RD_FIELD || '","' || :SPRINTERNAME || '","' ||
           :WK_DESC || '"';
        END
  
        SLABEL = SLABEL || ',"' || WK_WH_ID || '","' || WK_LOCN_ID || '"';
        /* OK have location - want ISSN */
        sFilePath2 = sFilePath || 'LocnISSN.2xt';
        RES = FILE_WRITELN(:sFilePath2, :sLabel);
        IF (RES <> 0) THEN
        BEGIN
           sFilePath2 = sFilePath || 'LocnISSN.uxt';
           RES = FILE_WRITELN(:sFilePath2, :sLabel);
           WK_HAVE_FILE_2 = 1;
        END   
        ELSE
        BEGIN
           WK_HAVE_FILE_1 = 1;
        END
     END
  END
  
  /* do renames */
   IF (WK_HAVE_FILE_1 = 1) THEN
   BEGIN
      /* rename load.2xt to load.txt */
      WK_FILENAME = sFilePath || 'LocnISSN.2xt';
      WK_FILENAME2 = sFilePath || 'LocnISSN.txt';
      RES = FILE_RENAME(WK_FILENAME, WK_FILENAME2);
   END
   IF (WK_HAVE_FILE_2 = 1) THEN
   BEGIN
      /* rename load.uxt to load.txt */
      WK_FILENAME = sFilePath || 'LocnISSN.uxt';
      WK_FILENAME2 = sFilePath || 'LocnISSN2.txt';
      RES = FILE_RENAME(WK_FILENAME, WK_FILENAME2);
   END
  
END ^

ALTER PROCEDURE PC_LABEL_PICK (REFERENCE VARCHAR(40) CHARACTER SET NONE)
RETURNS (RES INTEGER)
AS 
 
    
  DECLARE VARIABLE sFilePath VARCHAR(70);
  DECLARE VARIABLE sFilePath2 VARCHAR(70);
  DECLARE VARIABLE sPrinterName CHAR(2);
  DECLARE VARIABLE sRef VARCHAR(40);  
  DECLARE VARIABLE sLabel VARCHAR(256);
  
  DECLARE VARIABLE sPickLabel VARCHAR(7);
  DECLARE VARIABLE iOrderQty INTEGER;
  DECLARE VARIABLE sPickOrder VARCHAR(15);
  DECLARE VARIABLE sPersonId VARCHAR(10);
  DECLARE VARIABLE sProductId VARCHAR(30);
  DECLARE VARIABLE sDesc VARCHAR(50);
  DECLARE VARIABLE sContactName VARCHAR(50);
  DECLARE VARIABLE sAdd1 VARCHAR(100);
  DECLARE VARIABLE sLoc VARCHAR(10);
  
BEGIN 
  
  /* Get the printer dir */
  sPrinterName = SUBSTR(:REFERENCE,1,2);
  sRef = SUBSTR(:REFERENCE,3,STRLEN(:REFERENCE));
  
  /* Need the directory for this label set */
  SELECT WORKING_DIRECTORY FROM SYS_EQUIP 
  WHERE DEVICE_ID = :sPrinterName
  INTO :sFilePath;
  
  sFilePath2 = sFilePath || 'Pick.txt';
       
  /* Get Pick data */
  SELECT Pick_item.PICK_LABEL_NO,
         Pick_item.PICK_ORDER_QTY,
         Pick_item.PICK_ORDER,
         Pick_order.PERSON_ID,
         Pick_item.PROD_ID,
         Prod_profile.SHORT_DESC,
         Pick_item.CONTACT_NAME,
         Person.ADDRESS_LINE1,
         Pick_item.DESPATCH_LOCATION
    FROM ((PICK_ITEM
         LEFT OUTER JOIN PROD_PROFILE
                      ON Pick_item.PROD_ID = Prod_profile.PROD_ID)
         INNER JOIN PICK_ORDER
                 ON Pick_item.PICK_ORDER = Pick_order.PICK_ORDER)
         LEFT OUTER JOIN PERSON
                      ON Pick_order.PERSON_ID = Person.PERSON_ID
   WHERE Pick_item.PICK_LABEL_NO = :sRef
   INTO :sPickLabel, :iOrderQty, :sPickOrder, :sPersonId, :sProductId,
        :sDesc, :sContactName, :sAdd1, :sLoc;
  
  
  sLabel = DQUOTEDSTR(:sRef) || ',' || 
      DQUOTEDSTR(:iOrderQty) || ',' || 
      DQUOTEDSTR(:sPickOrder) || ',' || 
      DQUOTEDSTR(:sPersonId) || ',' || 
      DQUOTEDSTR(:sProductId) || ',' || 
      DQUOTEDSTR(:sDesc) || ',' || 
      DQUOTEDSTR(:sContactName) || ',' || 
      DQUOTEDSTR(:sAdd1) || ',' || 
      DQUOTEDSTR(:sLoc) || ',' ||            
  
           DQUOTEDSTR(:sPrinterName);
  
  RES = FILE_WRITELN(:sFilePath2, :sLabel);
  if (RES <> 0) then
  begin
     sFilePath2 = sFilePath || 'Pick.2xt';
     RES = FILE_WRITELN(:sFilePath2, :sLabel);
  end   

  
END ^

ALTER PROCEDURE PC_LABEL_PRODUCT (REFERENCE VARCHAR(40) CHARACTER SET NONE)
RETURNS (RES INTEGER)
AS 

    
  DECLARE VARIABLE sFilePath VARCHAR(70);
  DECLARE VARIABLE sFilePath2 VARCHAR(70);
  DECLARE VARIABLE sPrinterName CHAR(2);
  DECLARE VARIABLE sRef VARCHAR(40);  
  DECLARE VARIABLE sLabel VARCHAR(256);
  
  DECLARE VARIABLE sSSNId VARCHAR(20);
  DECLARE VARIABLE iCurQty INTEGER;
  DECLARE VARIABLE sProductId VARCHAR(30);    
  DECLARE VARIABLE sDesc VARCHAR(50);  
  DECLARE VARIABLE tLabelDate TIMESTAMP;  
  DECLARE VARIABLE WK_DATE VARCHAR(20);  
  DECLARE VARIABLE WK_TIME VARCHAR(10);  
     
BEGIN 
  
  /* Get the printer dir */
  sPrinterName = SUBSTR(:REFERENCE,1,2);
  sRef = SUBSTR(:REFERENCE,3,STRLEN(:REFERENCE));
  
  /* Need the directory for this label set */
  SELECT WORKING_DIRECTORY FROM SYS_EQUIP 
  WHERE DEVICE_ID = :sPrinterName
  INTO :sFilePath;
  
  sFilePath2 = sFilePath || 'Product.txt';
       
  /* Get Product data */
  SELECT Issn.SSN_ID,
         Issn.CURRENT_QTY,
         Issn.PROD_ID,
         Prod_profile.SHORT_DESC,
         Ssn.LABEL_DATE
  FROM (ISSN
         LEFT OUTER JOIN PROD_PROFILE
                      ON Issn.PROD_ID = Prod_profile.PROD_ID)
         INNER JOIN SSN
                 ON Issn.ORIGINAL_SSN = Ssn.SSN_ID
  WHERE Issn.SSN_ID = :sRef  
  INTO :sSSNId, :iCurQty, :sProductId, :sDesc, :tLabelDate;        
  
  
  WK_DATE = MER_DAY(tLabelDate) || '/' || MER_MONTH(tLabelDate) || '/' || SUBSTR(CAST(MER_YEAR(tLabelDate) AS CHAR(4)) , 3,4);
  WK_TIME = MER_HOUR(tLabelDate) || ':' || MER_MINUTE(tLabelDate) ;
  WK_DATE = WK_DATE || ' ' || WK_TIME;
  sLabel = DQUOTEDSTR(:sRef) || ',' || 
      DQUOTEDSTR(:iCurQty) || ',' || 
      DQUOTEDSTR(:sProductId) || ',' || 
      DQUOTEDSTR(:sDesc) || ',' || 
      DQUOTEDSTR( WK_DATE) || ',' ||                 
           DQUOTEDSTR(:sPrinterName);
  
  RES = FILE_WRITELN(:sFilePath2, :sLabel);
  if (RES <> 0) then
  begin
     sFilePath2 = sFilePath || 'Product.2xt';
     RES = FILE_WRITELN(:sFilePath2, :sLabel);
  end   

  
END ^

ALTER PROCEDURE PC_LABEL_SALE_ORDER (REFERENCE VARCHAR(40) CHARACTER SET NONE)
RETURNS (WK_RESULT INTEGER)
AS 
 
 
  DECLARE VARIABLE WK_FILE_PATH VARCHAR(70);
  DECLARE VARIABLE WK_FILE_PATH2 VARCHAR(70);
  DECLARE VARIABLE WK_PRINTER_DEVICE CHAR(2);
  DECLARE VARIABLE WK_ORDER VARCHAR(40);  
  DECLARE VARIABLE WK_DOCUMENT_NO VARCHAR(10);
  DECLARE VARIABLE WK_LABEL_TEXT VARCHAR(256);
  
  DECLARE VARIABLE WK_LABEL_DATE TIMESTAMP;  
  DECLARE VARIABLE WK_DATE VARCHAR(20);  
  DECLARE VARIABLE WK_TIME VARCHAR(10);  
     
BEGIN 
  
  /* GET THE PRINTER DIR */
  /* WK_PRINTER_DEVICE = SUBSTR(:REFERENCE,1,2); */
  EXECUTE PROCEDURE GET_REFERENCE_FIELD :REFERENCE, 1  RETURNING_VALUES :WK_ORDER ; 
  EXECUTE PROCEDURE GET_REFERENCE_FIELD :REFERENCE, 2  RETURNING_VALUES :WK_PRINTER_DEVICE ; 
  EXECUTE PROCEDURE GET_REFERENCE_FIELD :REFERENCE, 3  RETURNING_VALUES :WK_DOCUMENT_NO ; 
  /* WK_ORDER = SUBSTR(:REFERENCE,3,STRLEN(:REFERENCE)); */
  
  /* NEED THE DIRECTORY FOR THIS LABEL SET */
  SELECT WORKING_DIRECTORY FROM SYS_EQUIP 
  WHERE DEVICE_ID = :WK_PRINTER_DEVICE
  INTO :WK_FILE_PATH;
  
  WK_FILE_PATH2 = WK_FILE_PATH || 'ORDER.PXT';
       
  WK_LABEL_TEXT = '"' || WK_ORDER || '","' || WK_PRINTER_DEVICE || '","' || WK_DOCUMENT_NO || '"';
  WK_RESULT = FILE_WRITELN(:WK_FILE_PATH2, :WK_LABEL_TEXT);
  SUSPEND;
END ^

ALTER PROCEDURE PC_LABEL_SO_PRINT (WK_FILE_PATH2 VARCHAR(70) CHARACTER SET NONE,
WK_PRINTER_DEVICE CHAR(2) CHARACTER SET NONE,
WK_ORDER VARCHAR(40) CHARACTER SET NONE,
WK_PO_COMPANY_ID VARCHAR(20) CHARACTER SET NONE,
WK_PO_CUSTOMER_PO_WO VARCHAR(20) CHARACTER SET NONE,
WK_PO_PICK_DUE_DATE VARCHAR(10) CHARACTER SET NONE,
WK_PO_PERSON_ID VARCHAR(10) CHARACTER SET NONE,
WK_PO_CONTACT_NAME VARCHAR(50) CHARACTER SET NONE,
WK_PO_SPECIAL_INSTRUCTIONS1 VARCHAR(255) CHARACTER SET NONE,
WK_PO_SPECIAL_INSTRUCTIONS2 VARCHAR(255) CHARACTER SET NONE,
WK_PO_FREIGHT NUMERIC(9, 2),
WK_PO_PAYMENT_METHOD VARCHAR(20) CHARACTER SET NONE,
WK_PO_TERMS VARCHAR(20) CHARACTER SET NONE,
WK_PO_AMOUNT_PAID NUMERIC(9, 2),
WK_PO_SHIP_VIA VARCHAR(10) CHARACTER SET NONE,
WK_PO_OTHER1 VARCHAR(50) CHARACTER SET NONE,
WK_PO_OTHER2 VARCHAR(50) CHARACTER SET NONE,
WK_PO_OTHER3 VARCHAR(50) CHARACTER SET NONE,
WK_PO_OTHER4 VARCHAR(50) CHARACTER SET NONE,
WK_PO_OTHER5 VARCHAR(50) CHARACTER SET NONE,
WK_PO_OTHER6 VARCHAR(50) CHARACTER SET NONE,
WK_PO_OTHER7 VARCHAR(50) CHARACTER SET NONE,
WK_PO_OTHER8 VARCHAR(50) CHARACTER SET NONE,
WK_PO_OTHER9 VARCHAR(50) CHARACTER SET NONE,
WK_PO_P_FIRST_NAME VARCHAR(50) CHARACTER SET NONE,
WK_PO_P_ADDRESS_LINE1 VARCHAR(100) CHARACTER SET NONE,
WK_PO_P_ADDRESS_LINE2 VARCHAR(50) CHARACTER SET NONE,
WK_PO_P_ADDRESS_LINE3 VARCHAR(50) CHARACTER SET NONE,
WK_PO_P_ADDRESS_LINE4 VARCHAR(50) CHARACTER SET NONE,
WK_PO_P_ADDRESS_LINE5 VARCHAR(50) CHARACTER SET NONE,
WK_PO_P_POST_CODE VARCHAR(10) CHARACTER SET NONE,
WK_PO_P_COUNTRY VARCHAR(25) CHARACTER SET NONE,
WK_PO_OVER_SIZED VARCHAR(1) CHARACTER SET NONE,
WK_PO_NET_WEIGHT NUMERIC(9, 3),
WK_PO_TAX_AMOUNT NUMERIC(9, 2),
WK_PO_SUB_TOTAL_AMOUNT NUMERIC(9, 2),
WK_PO_FREIGHT_TAX_AMOUNT NUMERIC(9, 2),
WK_PO_PALLET_BASE VARCHAR(30) CHARACTER SET NONE,
WK_CONTINUE VARCHAR(10) CHARACTER SET NONE,
WK_PI_1_BAY SMALLINT,
WK_PI_1_SHELF SMALLINT,
WK_PI_1_COMPARTMENT SMALLINT,
WK_PI_1_SHELF_COMP VARCHAR(4) CHARACTER SET NONE,
WK_PI_1_PROD_ID VARCHAR(30) CHARACTER SET NONE,
WK_PI_1_PICK_ORDER_QTY INTEGER,
WK_PI_1_SALE_PRICE NUMERIC(9, 2),
WK_PI_1_TAX_AMOUNT NUMERIC(9, 2),
WK_PI_1_LINE_TOTAL NUMERIC(9, 2),
WK_PI_1_OTHER1 VARCHAR(50) CHARACTER SET NONE,
WK_PI_1_OTHER2 VARCHAR(50) CHARACTER SET NONE,
WK_PI_1_OTHER3 VARCHAR(50) CHARACTER SET NONE,
WK_PI_1_OTHER4 VARCHAR(50) CHARACTER SET NONE,
WK_PI_1_OTHER5 VARCHAR(50) CHARACTER SET NONE,
WK_PI_1_OTHER6 VARCHAR(50) CHARACTER SET NONE,
WK_PI_1_OTHER7 VARCHAR(50) CHARACTER SET NONE,
WK_PI_1_OTHER8 VARCHAR(50) CHARACTER SET NONE,
WK_PI_1_OTHER9 VARCHAR(50) CHARACTER SET NONE,
WK_PI_1_WH_ID VARCHAR(2) CHARACTER SET NONE,
WK_PI_1_PICK_LOCATION VARCHAR(10) CHARACTER SET NONE,
WK_PI_1_OVER_SIZED VARCHAR(1) CHARACTER SET NONE,
WK_PI_1_SPECIAL_INSTRUCTIONS1 VARCHAR(255) CHARACTER SET NONE,
WK_PI_1_SPECIAL_INSTRUCTIONS2 VARCHAR(255) CHARACTER SET NONE,
WK_PP_1_SHORT_DESC VARCHAR(50) CHARACTER SET NONE,
WK_PI_2_BAY SMALLINT,
WK_PI_2_SHELF SMALLINT,
WK_PI_2_COMPARTMENT SMALLINT,
WK_PI_2_SHELF_COMP VARCHAR(4) CHARACTER SET NONE,
WK_PI_2_PROD_ID VARCHAR(30) CHARACTER SET NONE,
WK_PI_2_PICK_ORDER_QTY INTEGER,
WK_PI_2_SALE_PRICE NUMERIC(9, 2),
WK_PI_2_TAX_AMOUNT NUMERIC(9, 2),
WK_PI_2_LINE_TOTAL NUMERIC(9, 2),
WK_PI_2_OTHER1 VARCHAR(50) CHARACTER SET NONE,
WK_PI_2_OTHER2 VARCHAR(50) CHARACTER SET NONE,
WK_PI_2_OTHER3 VARCHAR(50) CHARACTER SET NONE,
WK_PI_2_OTHER4 VARCHAR(50) CHARACTER SET NONE,
WK_PI_2_OTHER5 VARCHAR(50) CHARACTER SET NONE,
WK_PI_2_OTHER6 VARCHAR(50) CHARACTER SET NONE,
WK_PI_2_OTHER7 VARCHAR(50) CHARACTER SET NONE,
WK_PI_2_OTHER8 VARCHAR(50) CHARACTER SET NONE,
WK_PI_2_OTHER9 VARCHAR(50) CHARACTER SET NONE,
WK_PI_2_WH_ID VARCHAR(2) CHARACTER SET NONE,
WK_PI_2_PICK_LOCATION VARCHAR(10) CHARACTER SET NONE,
WK_PI_2_OVER_SIZED VARCHAR(1) CHARACTER SET NONE,
WK_PI_2_SPECIAL_INSTRUCTIONS1 VARCHAR(255) CHARACTER SET NONE,
WK_PI_2_SPECIAL_INSTRUCTIONS2 VARCHAR(255) CHARACTER SET NONE,
WK_PP_2_SHORT_DESC VARCHAR(50) CHARACTER SET NONE,
WK_PI_3_BAY SMALLINT,
WK_PI_3_SHELF SMALLINT,
WK_PI_3_COMPARTMENT SMALLINT,
WK_PI_3_SHELF_COMP VARCHAR(4) CHARACTER SET NONE,
WK_PI_3_PROD_ID VARCHAR(30) CHARACTER SET NONE,
WK_PI_3_PICK_ORDER_QTY INTEGER,
WK_PI_3_SALE_PRICE NUMERIC(9, 2),
WK_PI_3_TAX_AMOUNT NUMERIC(9, 2),
WK_PI_3_LINE_TOTAL NUMERIC(9, 2),
WK_PI_3_OTHER1 VARCHAR(50) CHARACTER SET NONE,
WK_PI_3_OTHER2 VARCHAR(50) CHARACTER SET NONE,
WK_PI_3_OTHER3 VARCHAR(50) CHARACTER SET NONE,
WK_PI_3_OTHER4 VARCHAR(50) CHARACTER SET NONE,
WK_PI_3_OTHER5 VARCHAR(50) CHARACTER SET NONE,
WK_PI_3_OTHER6 VARCHAR(50) CHARACTER SET NONE,
WK_PI_3_OTHER7 VARCHAR(50) CHARACTER SET NONE,
WK_PI_3_OTHER8 VARCHAR(50) CHARACTER SET NONE,
WK_PI_3_OTHER9 VARCHAR(50) CHARACTER SET NONE,
WK_PI_3_WH_ID VARCHAR(2) CHARACTER SET NONE,
WK_PI_3_PICK_LOCATION VARCHAR(10) CHARACTER SET NONE,
WK_PI_3_OVER_SIZED VARCHAR(1) CHARACTER SET NONE,
WK_PI_3_SPECIAL_INSTRUCTIONS1 VARCHAR(255) CHARACTER SET NONE,
WK_PI_3_SPECIAL_INSTRUCTIONS2 VARCHAR(255) CHARACTER SET NONE,
WK_PP_3_SHORT_DESC VARCHAR(50) CHARACTER SET NONE,
WK_PI_4_BAY SMALLINT,
WK_PI_4_SHELF SMALLINT,
WK_PI_4_COMPARTMENT SMALLINT,
WK_PI_4_SHELF_COMP VARCHAR(4) CHARACTER SET NONE,
WK_PI_4_PROD_ID VARCHAR(30) CHARACTER SET NONE,
WK_PI_4_PICK_ORDER_QTY INTEGER,
WK_PI_4_SALE_PRICE NUMERIC(9, 2),
WK_PI_4_TAX_AMOUNT NUMERIC(9, 2),
WK_PI_4_LINE_TOTAL NUMERIC(9, 2),
WK_PI_4_OTHER1 VARCHAR(50) CHARACTER SET NONE,
WK_PI_4_OTHER2 VARCHAR(50) CHARACTER SET NONE,
WK_PI_4_OTHER3 VARCHAR(50) CHARACTER SET NONE,
WK_PI_4_OTHER4 VARCHAR(50) CHARACTER SET NONE,
WK_PI_4_OTHER5 VARCHAR(50) CHARACTER SET NONE,
WK_PI_4_OTHER6 VARCHAR(50) CHARACTER SET NONE,
WK_PI_4_OTHER7 VARCHAR(50) CHARACTER SET NONE,
WK_PI_4_OTHER8 VARCHAR(50) CHARACTER SET NONE,
WK_PI_4_OTHER9 VARCHAR(50) CHARACTER SET NONE,
WK_PI_4_WH_ID VARCHAR(2) CHARACTER SET NONE,
WK_PI_4_PICK_LOCATION VARCHAR(10) CHARACTER SET NONE,
WK_PI_4_OVER_SIZED VARCHAR(1) CHARACTER SET NONE,
WK_PI_4_SPECIAL_INSTRUCTIONS1 VARCHAR(255) CHARACTER SET NONE,
WK_PI_4_SPECIAL_INSTRUCTIONS2 VARCHAR(255) CHARACTER SET NONE,
WK_PP_4_SHORT_DESC VARCHAR(50) CHARACTER SET NONE,
WK_PI_5_BAY SMALLINT,
WK_PI_5_SHELF SMALLINT,
WK_PI_5_COMPARTMENT SMALLINT,
WK_PI_5_SHELF_COMP VARCHAR(4) CHARACTER SET NONE,
WK_PI_5_PROD_ID VARCHAR(30) CHARACTER SET NONE,
WK_PI_5_PICK_ORDER_QTY INTEGER,
WK_PI_5_SALE_PRICE NUMERIC(9, 2),
WK_PI_5_TAX_AMOUNT NUMERIC(9, 2),
WK_PI_5_LINE_TOTAL NUMERIC(9, 2),
WK_PI_5_OTHER1 VARCHAR(50) CHARACTER SET NONE,
WK_PI_5_OTHER2 VARCHAR(50) CHARACTER SET NONE,
WK_PI_5_OTHER3 VARCHAR(50) CHARACTER SET NONE,
WK_PI_5_OTHER4 VARCHAR(50) CHARACTER SET NONE,
WK_PI_5_OTHER5 VARCHAR(50) CHARACTER SET NONE,
WK_PI_5_OTHER6 VARCHAR(50) CHARACTER SET NONE,
WK_PI_5_OTHER7 VARCHAR(50) CHARACTER SET NONE,
WK_PI_5_OTHER8 VARCHAR(50) CHARACTER SET NONE,
WK_PI_5_OTHER9 VARCHAR(50) CHARACTER SET NONE,
WK_PI_5_WH_ID VARCHAR(2) CHARACTER SET NONE,
WK_PI_5_PICK_LOCATION VARCHAR(10) CHARACTER SET NONE,
WK_PI_5_OVER_SIZED VARCHAR(1) CHARACTER SET NONE,
WK_PI_5_SPECIAL_INSTRUCTIONS1 VARCHAR(255) CHARACTER SET NONE,
WK_PI_5_SPECIAL_INSTRUCTIONS2 VARCHAR(255) CHARACTER SET NONE,
WK_PP_5_SHORT_DESC VARCHAR(50) CHARACTER SET NONE,
WK_PI_6_BAY SMALLINT,
WK_PI_6_SHELF SMALLINT,
WK_PI_6_COMPARTMENT SMALLINT,
WK_PI_6_SHELF_COMP VARCHAR(4) CHARACTER SET NONE,
WK_PI_6_PROD_ID VARCHAR(30) CHARACTER SET NONE,
WK_PI_6_PICK_ORDER_QTY INTEGER,
WK_PI_6_SALE_PRICE NUMERIC(9, 2),
WK_PI_6_TAX_AMOUNT NUMERIC(9, 2),
WK_PI_6_LINE_TOTAL NUMERIC(9, 2),
WK_PI_6_OTHER1 VARCHAR(50) CHARACTER SET NONE,
WK_PI_6_OTHER2 VARCHAR(50) CHARACTER SET NONE,
WK_PI_6_OTHER3 VARCHAR(50) CHARACTER SET NONE,
WK_PI_6_OTHER4 VARCHAR(50) CHARACTER SET NONE,
WK_PI_6_OTHER5 VARCHAR(50) CHARACTER SET NONE,
WK_PI_6_OTHER6 VARCHAR(50) CHARACTER SET NONE,
WK_PI_6_OTHER7 VARCHAR(50) CHARACTER SET NONE,
WK_PI_6_OTHER8 VARCHAR(50) CHARACTER SET NONE,
WK_PI_6_OTHER9 VARCHAR(50) CHARACTER SET NONE,
WK_PI_6_WH_ID VARCHAR(2) CHARACTER SET NONE,
WK_PI_6_PICK_LOCATION VARCHAR(10) CHARACTER SET NONE,
WK_PI_6_OVER_SIZED VARCHAR(1) CHARACTER SET NONE,
WK_PI_6_SPECIAL_INSTRUCTIONS1 VARCHAR(255) CHARACTER SET NONE,
WK_PI_6_SPECIAL_INSTRUCTIONS2 VARCHAR(255) CHARACTER SET NONE,
WK_PP_6_SHORT_DESC VARCHAR(50) CHARACTER SET NONE,
WK_PI_7_BAY SMALLINT,
WK_PI_7_SHELF SMALLINT,
WK_PI_7_COMPARTMENT SMALLINT,
WK_PI_7_SHELF_COMP VARCHAR(4) CHARACTER SET NONE,
WK_PI_7_PROD_ID VARCHAR(30) CHARACTER SET NONE,
WK_PI_7_PICK_ORDER_QTY INTEGER,
WK_PI_7_SALE_PRICE NUMERIC(9, 2),
WK_PI_7_TAX_AMOUNT NUMERIC(9, 2),
WK_PI_7_LINE_TOTAL NUMERIC(9, 2),
WK_PI_7_OTHER1 VARCHAR(50) CHARACTER SET NONE,
WK_PI_7_OTHER2 VARCHAR(50) CHARACTER SET NONE,
WK_PI_7_OTHER3 VARCHAR(50) CHARACTER SET NONE,
WK_PI_7_OTHER4 VARCHAR(50) CHARACTER SET NONE,
WK_PI_7_OTHER5 VARCHAR(50) CHARACTER SET NONE,
WK_PI_7_OTHER6 VARCHAR(50) CHARACTER SET NONE,
WK_PI_7_OTHER7 VARCHAR(50) CHARACTER SET NONE,
WK_PI_7_OTHER8 VARCHAR(50) CHARACTER SET NONE,
WK_PI_7_OTHER9 VARCHAR(50) CHARACTER SET NONE,
WK_PI_7_WH_ID VARCHAR(2) CHARACTER SET NONE,
WK_PI_7_PICK_LOCATION VARCHAR(10) CHARACTER SET NONE,
WK_PI_7_OVER_SIZED VARCHAR(1) CHARACTER SET NONE,
WK_PI_7_SPECIAL_INSTRUCTIONS1 VARCHAR(255) CHARACTER SET NONE,
WK_PI_7_SPECIAL_INSTRUCTIONS2 VARCHAR(255) CHARACTER SET NONE,
WK_PP_7_SHORT_DESC VARCHAR(50) CHARACTER SET NONE,
WK_PI_8_BAY SMALLINT,
WK_PI_8_SHELF SMALLINT,
WK_PI_8_COMPARTMENT SMALLINT,
WK_PI_8_SHELF_COMP VARCHAR(4) CHARACTER SET NONE,
WK_PI_8_PROD_ID VARCHAR(30) CHARACTER SET NONE,
WK_PI_8_PICK_ORDER_QTY INTEGER,
WK_PI_8_SALE_PRICE NUMERIC(9, 2),
WK_PI_8_TAX_AMOUNT NUMERIC(9, 2),
WK_PI_8_LINE_TOTAL NUMERIC(9, 2),
WK_PI_8_OTHER1 VARCHAR(50) CHARACTER SET NONE,
WK_PI_8_OTHER2 VARCHAR(50) CHARACTER SET NONE,
WK_PI_8_OTHER3 VARCHAR(50) CHARACTER SET NONE,
WK_PI_8_OTHER4 VARCHAR(50) CHARACTER SET NONE,
WK_PI_8_OTHER5 VARCHAR(50) CHARACTER SET NONE,
WK_PI_8_OTHER6 VARCHAR(50) CHARACTER SET NONE,
WK_PI_8_OTHER7 VARCHAR(50) CHARACTER SET NONE,
WK_PI_8_OTHER8 VARCHAR(50) CHARACTER SET NONE,
WK_PI_8_OTHER9 VARCHAR(50) CHARACTER SET NONE,
WK_PI_8_WH_ID VARCHAR(2) CHARACTER SET NONE,
WK_PI_8_PICK_LOCATION VARCHAR(10) CHARACTER SET NONE,
WK_PI_8_OVER_SIZED VARCHAR(1) CHARACTER SET NONE,
WK_PI_8_SPECIAL_INSTRUCTIONS1 VARCHAR(255) CHARACTER SET NONE,
WK_PI_8_SPECIAL_INSTRUCTIONS2 VARCHAR(255) CHARACTER SET NONE,
WK_PP_8_SHORT_DESC VARCHAR(50) CHARACTER SET NONE,
WK_PI_9_BAY SMALLINT,
WK_PI_9_SHELF SMALLINT,
WK_PI_9_COMPARTMENT SMALLINT,
WK_PI_9_SHELF_COMP VARCHAR(4) CHARACTER SET NONE,
WK_PI_9_PROD_ID VARCHAR(30) CHARACTER SET NONE,
WK_PI_9_PICK_ORDER_QTY INTEGER,
WK_PI_9_SALE_PRICE NUMERIC(9, 2),
WK_PI_9_TAX_AMOUNT NUMERIC(9, 2),
WK_PI_9_LINE_TOTAL NUMERIC(9, 2),
WK_PI_9_OTHER1 VARCHAR(50) CHARACTER SET NONE,
WK_PI_9_OTHER2 VARCHAR(50) CHARACTER SET NONE,
WK_PI_9_OTHER3 VARCHAR(50) CHARACTER SET NONE,
WK_PI_9_OTHER4 VARCHAR(50) CHARACTER SET NONE,
WK_PI_9_OTHER5 VARCHAR(50) CHARACTER SET NONE,
WK_PI_9_OTHER6 VARCHAR(50) CHARACTER SET NONE,
WK_PI_9_OTHER7 VARCHAR(50) CHARACTER SET NONE,
WK_PI_9_OTHER8 VARCHAR(50) CHARACTER SET NONE,
WK_PI_9_OTHER9 VARCHAR(50) CHARACTER SET NONE,
WK_PI_9_WH_ID VARCHAR(2) CHARACTER SET NONE,
WK_PI_9_PICK_LOCATION VARCHAR(10) CHARACTER SET NONE,
WK_PI_9_OVER_SIZED VARCHAR(1) CHARACTER SET NONE,
WK_PI_9_SPECIAL_INSTRUCTIONS1 VARCHAR(255) CHARACTER SET NONE,
WK_PI_9_SPECIAL_INSTRUCTIONS2 VARCHAR(255) CHARACTER SET NONE,
WK_PP_9_SHORT_DESC VARCHAR(50) CHARACTER SET NONE,
WK_PI_10_BAY SMALLINT,
WK_PI_10_SHELF SMALLINT,
WK_PI_10_COMPARTMENT SMALLINT,
WK_PI_10_SHELF_COMP VARCHAR(4) CHARACTER SET NONE,
WK_PI_10_PROD_ID VARCHAR(30) CHARACTER SET NONE,
WK_PI_10_PICK_ORDER_QTY INTEGER,
WK_PI_10_SALE_PRICE NUMERIC(9, 2),
WK_PI_10_TAX_AMOUNT NUMERIC(9, 2),
WK_PI_10_LINE_TOTAL NUMERIC(9, 2),
WK_PI_10_OTHER1 VARCHAR(50) CHARACTER SET NONE,
WK_PI_10_OTHER2 VARCHAR(50) CHARACTER SET NONE,
WK_PI_10_OTHER3 VARCHAR(50) CHARACTER SET NONE,
WK_PI_10_OTHER4 VARCHAR(50) CHARACTER SET NONE,
WK_PI_10_OTHER5 VARCHAR(50) CHARACTER SET NONE,
WK_PI_10_OTHER6 VARCHAR(50) CHARACTER SET NONE,
WK_PI_10_OTHER7 VARCHAR(50) CHARACTER SET NONE,
WK_PI_10_OTHER8 VARCHAR(50) CHARACTER SET NONE,
WK_PI_10_OTHER9 VARCHAR(50) CHARACTER SET NONE,
WK_PI_10_WH_ID VARCHAR(2) CHARACTER SET NONE,
WK_PI_10_PICK_LOCATION VARCHAR(10) CHARACTER SET NONE,
WK_PI_10_OVER_SIZED VARCHAR(1) CHARACTER SET NONE,
WK_PI_10_SPECIAL_INSTRUCTIONS1 VARCHAR(255) CHARACTER SET NONE,
WK_PI_10_SPECIAL_INSTRUCTIONS2 VARCHAR(255) CHARACTER SET NONE,
WK_PP_10_SHORT_DESC VARCHAR(50) CHARACTER SET NONE)
AS 
 
  DECLARE VARIABLE WK_LABEL_TEXT VARCHAR(256);
  DECLARE VARIABLE WK_LAST_LINE SMALLINT;
  DECLARE VARIABLE WK_RESULT INTEGER;
BEGIN 
  /* print last lines */
  WK_LABEL_TEXT = '"' || WK_ORDER || '","' || WK_PRINTER_DEVICE || '","' || WK_PO_COMPANY_ID || '","' || WK_PO_CUSTOMER_PO_WO || '","' || WK_PO_PICK_DUE_DATE || '","' || WK_PO_PERSON_ID || '","' || WK_PO_CONTACT_NAME || '","' ; 
  WK_RESULT = FILE_WRITE(:WK_FILE_PATH2, :WK_LABEL_TEXT);
/*
  IF (WK_RESULT <> 0) THEN
  BEGIN
     WK_FILE_PATH2 = WK_FILE_PATH || 'ORDER.2XT';
     WK_RESULT = FILE_WRITE(:WK_FILE_PATH2, :WK_LABEL_TEXT);
  END   
*/
  WK_LABEL_TEXT = WK_PO_SPECIAL_INSTRUCTIONS1;
  WK_RESULT = FILE_WRITE(:WK_FILE_PATH2, :WK_LABEL_TEXT);
  WK_LABEL_TEXT = '","';
  WK_RESULT = FILE_WRITE(:WK_FILE_PATH2, :WK_LABEL_TEXT);
  WK_LABEL_TEXT = WK_PO_SPECIAL_INSTRUCTIONS2;
  WK_RESULT = FILE_WRITE(:WK_FILE_PATH2, :WK_LABEL_TEXT);
  WK_LABEL_TEXT = '","';
  WK_RESULT = FILE_WRITE(:WK_FILE_PATH2, :WK_LABEL_TEXT);
  WK_LABEL_TEXT = WK_PO_FREIGHT || '","' || WK_PO_PAYMENT_METHOD || '","' || WK_PO_TERMS || '","' || WK_PO_AMOUNT_PAID || '","' || WK_PO_SHIP_VIA || '","' || WK_PO_OTHER1 || '","' || WK_PO_OTHER2 || '","' || WK_PO_OTHER3 || '","' ;
  WK_RESULT = FILE_WRITE(:WK_FILE_PATH2, :WK_LABEL_TEXT);
  WK_LABEL_TEXT = WK_PO_OTHER4 || '","' || WK_PO_OTHER5 || '","' || WK_PO_OTHER6 || '","' || WK_PO_OTHER7 || '","' ;
  WK_RESULT = FILE_WRITE(:WK_FILE_PATH2, :WK_LABEL_TEXT);
  WK_LABEL_TEXT = WK_PO_OTHER8 || '","' || WK_PO_OTHER9 || '","' || WK_PO_P_FIRST_NAME || '","' ;
  WK_RESULT = FILE_WRITE(:WK_FILE_PATH2, :WK_LABEL_TEXT);
  WK_LABEL_TEXT =  WK_PO_P_ADDRESS_LINE1 || '","' || WK_PO_P_ADDRESS_LINE2 || '","' || WK_PO_P_ADDRESS_LINE3 || '","' ;
  WK_RESULT = FILE_WRITE(:WK_FILE_PATH2, :WK_LABEL_TEXT);
  WK_LABEL_TEXT = WK_PO_P_ADDRESS_LINE4 || '","' || WK_PO_P_ADDRESS_LINE5 || '","' || WK_PO_P_POST_CODE || '","' || WK_PO_P_COUNTRY || '","' || WK_PO_OVER_SIZED || '","' || WK_PO_NET_WEIGHT || '","' || WK_PO_TAX_AMOUNT || '","' || WK_PO_SUB_TOTAL_AMOUNT || '","' || WK_PO_FREIGHT_TAX_AMOUNT || '","' || WK_PO_PALLET_BASE || '","';
  WK_RESULT = FILE_WRITE(:WK_FILE_PATH2, :WK_LABEL_TEXT);
  EXECUTE PROCEDURE PC_LABEL_SO_PRINT_LINE :WK_FILE_PATH2, :WK_PI_1_BAY , :WK_PI_1_SHELF , :WK_PI_1_COMPARTMENT , :WK_PI_1_SHELF_COMP , :WK_PI_1_PROD_ID , :WK_PI_1_PICK_ORDER_QTY , :WK_PI_1_SALE_PRICE , :WK_PI_1_TAX_AMOUNT , :WK_PI_1_LINE_TOTAL , :WK_PI_1_OTHER1 , :WK_PI_1_OTHER2 , :WK_PI_1_OTHER3 , :WK_PI_1_OTHER4 , :WK_PI_1_OTHER5 , :WK_PI_1_OTHER6 , :WK_PI_1_OTHER7 , :WK_PI_1_OTHER8 , :WK_PI_1_OTHER9 , :WK_PI_1_WH_ID , :WK_PI_1_PICK_LOCATION , :WK_PI_1_OVER_SIZED , :WK_PI_1_SPECIAL_INSTRUCTIONS1 , :WK_PI_1_SPECIAL_INSTRUCTIONS2, :WK_PP_1_SHORT_DESC;
  EXECUTE PROCEDURE PC_LABEL_SO_PRINT_LINE :WK_FILE_PATH2, :WK_PI_2_BAY , :WK_PI_2_SHELF , :WK_PI_2_COMPARTMENT , :WK_PI_2_SHELF_COMP , :WK_PI_2_PROD_ID , :WK_PI_2_PICK_ORDER_QTY , :WK_PI_2_SALE_PRICE , :WK_PI_2_TAX_AMOUNT , :WK_PI_2_LINE_TOTAL , :WK_PI_2_OTHER1 , :WK_PI_2_OTHER2 , :WK_PI_2_OTHER3 , :WK_PI_2_OTHER4 , :WK_PI_2_OTHER5 , :WK_PI_2_OTHER6 , :WK_PI_2_OTHER7 , :WK_PI_2_OTHER8 , :WK_PI_2_OTHER9 , :WK_PI_2_WH_ID , :WK_PI_2_PICK_LOCATION , :WK_PI_2_OVER_SIZED , :WK_PI_2_SPECIAL_INSTRUCTIONS1 , :WK_PI_2_SPECIAL_INSTRUCTIONS2 , :WK_PP_2_SHORT_DESC;
  EXECUTE PROCEDURE PC_LABEL_SO_PRINT_LINE :WK_FILE_PATH2, :WK_PI_3_BAY , :WK_PI_3_SHELF , :WK_PI_3_COMPARTMENT , :WK_PI_3_SHELF_COMP , :WK_PI_3_PROD_ID , :WK_PI_3_PICK_ORDER_QTY , :WK_PI_3_SALE_PRICE , :WK_PI_3_TAX_AMOUNT , :WK_PI_3_LINE_TOTAL , :WK_PI_3_OTHER1 , :WK_PI_3_OTHER2 , :WK_PI_3_OTHER3 , :WK_PI_3_OTHER4 , :WK_PI_3_OTHER5 , :WK_PI_3_OTHER6 , :WK_PI_3_OTHER7 , :WK_PI_3_OTHER8 , :WK_PI_3_OTHER9 , :WK_PI_3_WH_ID , :WK_PI_3_PICK_LOCATION , :WK_PI_3_OVER_SIZED , :WK_PI_3_SPECIAL_INSTRUCTIONS1 , :WK_PI_3_SPECIAL_INSTRUCTIONS2 , :WK_PP_3_SHORT_DESC;
  EXECUTE PROCEDURE PC_LABEL_SO_PRINT_LINE :WK_FILE_PATH2, :WK_PI_4_BAY , :WK_PI_4_SHELF , :WK_PI_4_COMPARTMENT , :WK_PI_4_SHELF_COMP , :WK_PI_4_PROD_ID , :WK_PI_4_PICK_ORDER_QTY , :WK_PI_4_SALE_PRICE , :WK_PI_4_TAX_AMOUNT , :WK_PI_4_LINE_TOTAL , :WK_PI_4_OTHER1 , :WK_PI_4_OTHER2 , :WK_PI_4_OTHER3 , :WK_PI_4_OTHER4 , :WK_PI_4_OTHER5 , :WK_PI_4_OTHER6 , :WK_PI_4_OTHER7 , :WK_PI_4_OTHER8 , :WK_PI_4_OTHER9 , :WK_PI_4_WH_ID , :WK_PI_4_PICK_LOCATION , :WK_PI_4_OVER_SIZED , :WK_PI_4_SPECIAL_INSTRUCTIONS1 , :WK_PI_4_SPECIAL_INSTRUCTIONS2 , :WK_PP_4_SHORT_DESC;
  EXECUTE PROCEDURE PC_LABEL_SO_PRINT_LINE :WK_FILE_PATH2, :WK_PI_5_BAY , :WK_PI_5_SHELF , :WK_PI_5_COMPARTMENT , :WK_PI_5_SHELF_COMP , :WK_PI_5_PROD_ID , :WK_PI_5_PICK_ORDER_QTY , :WK_PI_5_SALE_PRICE , :WK_PI_5_TAX_AMOUNT , :WK_PI_5_LINE_TOTAL , :WK_PI_5_OTHER1 , :WK_PI_5_OTHER2 , :WK_PI_5_OTHER3 , :WK_PI_5_OTHER4 , :WK_PI_5_OTHER5 , :WK_PI_5_OTHER6 , :WK_PI_5_OTHER7 , :WK_PI_5_OTHER8 , :WK_PI_5_OTHER9 , :WK_PI_5_WH_ID , :WK_PI_5_PICK_LOCATION , :WK_PI_5_OVER_SIZED , :WK_PI_5_SPECIAL_INSTRUCTIONS1 , :WK_PI_5_SPECIAL_INSTRUCTIONS2 , :WK_PP_5_SHORT_DESC;
  EXECUTE PROCEDURE PC_LABEL_SO_PRINT_LINE :WK_FILE_PATH2, :WK_PI_6_BAY , :WK_PI_6_SHELF , :WK_PI_6_COMPARTMENT , :WK_PI_6_SHELF_COMP , :WK_PI_6_PROD_ID , :WK_PI_6_PICK_ORDER_QTY , :WK_PI_6_SALE_PRICE , :WK_PI_6_TAX_AMOUNT , :WK_PI_6_LINE_TOTAL , :WK_PI_6_OTHER1 , :WK_PI_6_OTHER2 , :WK_PI_6_OTHER3 , :WK_PI_6_OTHER4 , :WK_PI_6_OTHER5 , :WK_PI_6_OTHER6 , :WK_PI_6_OTHER7 , :WK_PI_6_OTHER8 , :WK_PI_6_OTHER9 , :WK_PI_6_WH_ID , :WK_PI_6_PICK_LOCATION , :WK_PI_6_OVER_SIZED , :WK_PI_6_SPECIAL_INSTRUCTIONS1 , :WK_PI_6_SPECIAL_INSTRUCTIONS2 , :WK_PP_6_SHORT_DESC;
  EXECUTE PROCEDURE PC_LABEL_SO_PRINT_LINE :WK_FILE_PATH2, :WK_PI_7_BAY , :WK_PI_7_SHELF , :WK_PI_7_COMPARTMENT , :WK_PI_7_SHELF_COMP , :WK_PI_7_PROD_ID , :WK_PI_7_PICK_ORDER_QTY , :WK_PI_7_SALE_PRICE , :WK_PI_7_TAX_AMOUNT , :WK_PI_7_LINE_TOTAL , :WK_PI_7_OTHER1 , :WK_PI_7_OTHER2 , :WK_PI_7_OTHER3 , :WK_PI_7_OTHER4 , :WK_PI_7_OTHER5 , :WK_PI_7_OTHER6 , :WK_PI_7_OTHER7 , :WK_PI_7_OTHER8 , :WK_PI_7_OTHER9 , :WK_PI_7_WH_ID , :WK_PI_7_PICK_LOCATION , :WK_PI_7_OVER_SIZED , :WK_PI_7_SPECIAL_INSTRUCTIONS1 , :WK_PI_7_SPECIAL_INSTRUCTIONS2 , :WK_PP_7_SHORT_DESC;
  EXECUTE PROCEDURE PC_LABEL_SO_PRINT_LINE :WK_FILE_PATH2, :WK_PI_8_BAY , :WK_PI_8_SHELF , :WK_PI_8_COMPARTMENT , :WK_PI_8_SHELF_COMP , :WK_PI_8_PROD_ID , :WK_PI_8_PICK_ORDER_QTY , :WK_PI_8_SALE_PRICE , :WK_PI_8_TAX_AMOUNT , :WK_PI_8_LINE_TOTAL , :WK_PI_8_OTHER1 , :WK_PI_8_OTHER2 , :WK_PI_8_OTHER3 , :WK_PI_8_OTHER4 , :WK_PI_8_OTHER5 , :WK_PI_8_OTHER6 , :WK_PI_8_OTHER7 , :WK_PI_8_OTHER8 , :WK_PI_8_OTHER9 , :WK_PI_8_WH_ID , :WK_PI_8_PICK_LOCATION , :WK_PI_8_OVER_SIZED , :WK_PI_8_SPECIAL_INSTRUCTIONS1 , :WK_PI_8_SPECIAL_INSTRUCTIONS2 , :WK_PP_8_SHORT_DESC;
  EXECUTE PROCEDURE PC_LABEL_SO_PRINT_LINE :WK_FILE_PATH2, :WK_PI_9_BAY , :WK_PI_9_SHELF , :WK_PI_9_COMPARTMENT , :WK_PI_9_SHELF_COMP , :WK_PI_9_PROD_ID , :WK_PI_9_PICK_ORDER_QTY , :WK_PI_9_SALE_PRICE , :WK_PI_9_TAX_AMOUNT , :WK_PI_9_LINE_TOTAL , :WK_PI_9_OTHER1 , :WK_PI_9_OTHER2 , :WK_PI_9_OTHER3 , :WK_PI_9_OTHER4 , :WK_PI_9_OTHER5 , :WK_PI_9_OTHER6 , :WK_PI_9_OTHER7 , :WK_PI_9_OTHER8 , :WK_PI_9_OTHER9 , :WK_PI_9_WH_ID , :WK_PI_9_PICK_LOCATION , :WK_PI_9_OVER_SIZED , :WK_PI_9_SPECIAL_INSTRUCTIONS1 , :WK_PI_9_SPECIAL_INSTRUCTIONS2 , :WK_PP_9_SHORT_DESC;
  EXECUTE PROCEDURE PC_LABEL_SO_PRINT_LINE :WK_FILE_PATH2, :WK_PI_10_BAY , :WK_PI_10_SHELF , :WK_PI_10_COMPARTMENT , :WK_PI_10_SHELF_COMP , :WK_PI_10_PROD_ID , :WK_PI_10_PICK_ORDER_QTY , :WK_PI_10_SALE_PRICE , :WK_PI_10_TAX_AMOUNT , :WK_PI_10_LINE_TOTAL , :WK_PI_10_OTHER1 , :WK_PI_10_OTHER2 , :WK_PI_10_OTHER3 , :WK_PI_10_OTHER4 , :WK_PI_10_OTHER5 , :WK_PI_10_OTHER6 , :WK_PI_10_OTHER7 , :WK_PI_10_OTHER8 , :WK_PI_10_OTHER9 , :WK_PI_10_WH_ID , :WK_PI_10_PICK_LOCATION , :WK_PI_10_OVER_SIZED , :WK_PI_10_SPECIAL_INSTRUCTIONS1 , :WK_PI_10_SPECIAL_INSTRUCTIONS2 , :WK_PP_10_SHORT_DESC;
  WK_LABEL_TEXT = WK_CONTINUE || '"' ;
  WK_RESULT = FILE_WRITELN(:WK_FILE_PATH2, :WK_LABEL_TEXT); 
END ^

ALTER PROCEDURE PC_LABEL_SO_PRINT_LINE (WK_FILE_PATH2 VARCHAR(70) CHARACTER SET NONE,
WK_PI_1_BAY VARCHAR(20) CHARACTER SET NONE,
WK_PI_1_SHELF VARCHAR(20) CHARACTER SET NONE,
WK_PI_1_COMPARTMENT VARCHAR(20) CHARACTER SET NONE,
WK_PI_1_SHELF_COMP VARCHAR(20) CHARACTER SET NONE,
WK_PI_1_PROD_ID VARCHAR(30) CHARACTER SET NONE,
WK_PI_1_PICK_ORDER_QTY VARCHAR(20) CHARACTER SET NONE,
WK_PI_1_SALE_PRICE VARCHAR(20) CHARACTER SET NONE,
WK_PI_1_TAX_AMOUNT VARCHAR(20) CHARACTER SET NONE,
WK_PI_1_LINE_TOTAL VARCHAR(20) CHARACTER SET NONE,
WK_PI_1_OTHER1 VARCHAR(50) CHARACTER SET NONE,
WK_PI_1_OTHER2 VARCHAR(50) CHARACTER SET NONE,
WK_PI_1_OTHER3 VARCHAR(50) CHARACTER SET NONE,
WK_PI_1_OTHER4 VARCHAR(50) CHARACTER SET NONE,
WK_PI_1_OTHER5 VARCHAR(50) CHARACTER SET NONE,
WK_PI_1_OTHER6 VARCHAR(50) CHARACTER SET NONE,
WK_PI_1_OTHER7 VARCHAR(50) CHARACTER SET NONE,
WK_PI_1_OTHER8 VARCHAR(50) CHARACTER SET NONE,
WK_PI_1_OTHER9 VARCHAR(50) CHARACTER SET NONE,
WK_PI_1_WH_ID VARCHAR(20) CHARACTER SET NONE,
WK_PI_1_PICK_LOCATION VARCHAR(20) CHARACTER SET NONE,
WK_PI_1_OVER_SIZED VARCHAR(20) CHARACTER SET NONE,
WK_PI_1_SPECIAL_INSTRUCTIONS1 VARCHAR(255) CHARACTER SET NONE,
WK_PI_1_SPECIAL_INSTRUCTIONS2 VARCHAR(255) CHARACTER SET NONE,
WK_PP_1_SHORT_DESC VARCHAR(50) CHARACTER SET NONE)
AS 
 

  DECLARE VARIABLE WK_LABEL_TEXT VARCHAR(256);
  DECLARE VARIABLE WK_RESULT INTEGER;
  
BEGIN 
  
  WK_LABEL_TEXT = WK_PI_1_PROD_ID || '","' ||
        WK_PP_1_SHORT_DESC  || '","' ||
        WK_PI_1_PICK_ORDER_QTY  || '","' ||
        WK_PI_1_SALE_PRICE  || '","' ||
        WK_PI_1_TAX_AMOUNT  || '","' ||
        WK_PI_1_LINE_TOTAL  || '","' ||
        WK_PI_1_OTHER1  || '","' ||
        WK_PI_1_OTHER2  || '","' ;
  WK_RESULT = FILE_WRITE(:WK_FILE_PATH2, :WK_LABEL_TEXT);

  WK_LABEL_TEXT = WK_PI_1_OTHER3  || '","' ||
        WK_PI_1_OTHER4  || '","' ||
        WK_PI_1_OTHER5  || '","' ||
        WK_PI_1_OTHER6  || '","' ;
  WK_RESULT = FILE_WRITE(:WK_FILE_PATH2, :WK_LABEL_TEXT);

  WK_LABEL_TEXT = WK_PI_1_OTHER7  || '","' ||
        WK_PI_1_OTHER8  || '","' ||
        WK_PI_1_OTHER9  || '","' ||
        WK_PI_1_WH_ID  || '","' ||
        WK_PI_1_PICK_LOCATION  || '","' ||
        WK_PI_1_OVER_SIZED  || '","' ;
  WK_RESULT = FILE_WRITE(:WK_FILE_PATH2, :WK_LABEL_TEXT);

  WK_LABEL_TEXT = WK_PI_1_SPECIAL_INSTRUCTIONS1; 
  WK_RESULT = FILE_WRITE(:WK_FILE_PATH2, :WK_LABEL_TEXT);
  WK_LABEL_TEXT = '","' ;
  WK_RESULT = FILE_WRITE(:WK_FILE_PATH2, :WK_LABEL_TEXT);

  WK_LABEL_TEXT = WK_PI_1_SPECIAL_INSTRUCTIONS2; 
  WK_RESULT = FILE_WRITE(:WK_FILE_PATH2, :WK_LABEL_TEXT);
  WK_LABEL_TEXT = '","' ;
  WK_RESULT = FILE_WRITE(:WK_FILE_PATH2, :WK_LABEL_TEXT);

  WK_LABEL_TEXT = WK_PI_1_BAY  || '","' ||
        WK_PI_1_SHELF  || '","' ||
        WK_PI_1_COMPARTMENT  || '","' ||
        WK_PI_1_SHELF_COMP  || '","' ;
  WK_RESULT = FILE_WRITE(:WK_FILE_PATH2, :WK_LABEL_TEXT);
  
END ^

ALTER PROCEDURE PC_LABEL_SPLIT (WH_ID VARCHAR(2) CHARACTER SET NONE,
PRINTED_BY VARCHAR(10) CHARACTER SET NONE,
LABEL_NO INTEGER,
PASSED_SSN_LENGTH INTEGER,
PRINTER_NAME VARCHAR(2) CHARACTER SET NONE)
RETURNS (ISSN VARCHAR(20) CHARACTER SET NONE,
RES INTEGER)
AS 
 
 
DECLARE VARIABLE SSN_LENGTH INTEGER;
DECLARE VARIABLE SSN_ID INTEGER;
DECLARE VARIABLE P_SSN_ID INTEGER;
DECLARE VARIABLE W_SSN_ID VARCHAR(20);
DECLARE VARIABLE I_SSN_ID VARCHAR(20);
DECLARE VARIABLE LEN_SSN_ID INTEGER;
DECLARE VARIABLE I_LEN_SSN_ID INTEGER;

DECLARE VARIABLE sFilePath VARCHAR(70);
DECLARE VARIABLE sFilePath2 VARCHAR(70);
DECLARE VARIABLE sLabel VARCHAR(256);
DECLARE VARIABLE WK_NEW_LOCN_ID VARCHAR(10);

BEGIN          
   SELECT NEW_LABEL_LOCN_ID FROM CONTROL INTO :WK_NEW_LOCN_ID;
   SSN_ID = GEN_ID(ISSN_SSN_ID, :LABEL_NO);
   P_SSN_ID = SSN_ID - :LABEL_NO;
   LEN_SSN_ID = STRLEN(P_SSN_ID);     
         
   /* Get length for Barcode */   
   EXECUTE PROCEDURE GET_BARCODE_LENGTH RETURNING_VALUES SSN_LENGTH;
   W_SSN_ID = '';
   /* Padding leading with 0 */
   WHILE (LEN_SSN_ID < :SSN_LENGTH) DO
   BEGIN
      W_SSN_ID = W_SSN_ID || '0';      
      LEN_SSN_ID = LEN_SSN_ID + 1;
   END
   W_SSN_ID = W_SSN_ID || P_SSN_ID;
   
   /* insert into log(description) values ('create split - len ' || :SSN_LENGTH || ' w ssn ' || :W_SSN_ID || ']'); */
   /* Insert data into SSN table */   
   INSERT INTO SSN (SSN_ID, WH_ID, LOCN_ID, STATUS_SSN, LABEL_DATE, PRINTED_BY, CREATE_DATE)
   VALUES (:W_SSN_ID, :WH_ID, :WK_NEW_LOCN_ID, 'LB', 'NOW', :PRINTED_BY, 'NOW');     
   
   /* Return ISSN value to the caller */
   ISSN = W_SSN_ID;
        
   
   /* Insert data into ISSN table */
   WHILE (P_SSN_ID < SSN_ID) DO
   BEGIN
      I_SSN_ID = '';
      I_LEN_SSN_ID = STRLEN(P_SSN_ID);
      
      /* Padding leading with 0 */
      WHILE (I_LEN_SSN_ID < :SSN_LENGTH) DO
      BEGIN
       I_SSN_ID = I_SSN_ID || '0';
       I_LEN_SSN_ID = I_LEN_SSN_ID + 1;
      END
      I_SSN_ID = I_SSN_ID || P_SSN_ID;
      
   /* insert into log(description) values ('create split - issn ' || :SSN_LENGTH || ' i ssn ' || :I_SSN_ID || ']'); */
      INSERT INTO ISSN (SSN_ID, ORIGINAL_SSN, WH_ID, LOCN_ID, ISSN_STATUS, CREATE_DATE)
      VALUES (:I_SSN_ID, :W_SSN_ID, :WH_ID, :WK_NEW_LOCN_ID, 'LB', 'NOW'); 
      
      P_SSN_ID = P_SSN_ID + 1;
   END
   
   /* Export data to text file */    
   
   /* Need the directory for this label set */
   SELECT WORKING_DIRECTORY FROM SYS_EQUIP 
   WHERE DEVICE_ID = :PRINTER_NAME
   INTO :sFilePath;   
   
   sFilePath2 = sFilePath || 'Split.txt';
          
   sLabel = DQUOTEDSTR(:ISSN) || ',' || DQUOTEDSTR(:LABEL_NO) || ',' || 
            DQUOTEDSTR(:PRINTER_NAME);
     
   RES = FILE_WRITELN(:sFilePath2, :sLabel);
  if (RES <> 0) then
  begin
     sFilePath2 = sFilePath || 'Split.2xt';
     RES = FILE_WRITELN(:sFilePath2, :sLabel);
  end   
                
END ^

ALTER PROCEDURE PC_NILT_NILS (RECORD_ID INTEGER,
WH_ID CHAR(2) CHARACTER SET NONE,
LOCN_ID VARCHAR(10) CHARACTER SET NONE,
OBJECT VARCHAR(30) CHARACTER SET NONE,
TRN_TYPE VARCHAR(4) CHARACTER SET NONE,
TRN_CODE CHAR(1) CHARACTER SET NONE,
TRN_DATE TIMESTAMP,
REFERENCE VARCHAR(40) CHARACTER SET NONE,
QTY INTEGER,
PERSON_ID VARCHAR(10) CHARACTER SET NONE,
DEVICE_ID CHAR(2) CHARACTER SET NONE)
AS 
DECLARE VARIABLE REC_EXIST INTEGER;   
 
BEGIN
  REC_EXIST = 0;
      
  /* Check if record exists */
  SELECT 1
  FROM LOCATION
  WHERE WH_ID = :WH_ID
  AND LOCN_ID = :LOCN_ID 
  INTO :REC_EXIST;  

  /* record does not exist */
  IF (REC_EXIST = 0) THEN
  BEGIN   
    /* Update transactions table */        
    EXECUTE PROCEDURE UPDATE_TRAN (:RECORD_ID, 'F', 'Location is not exist in the database');                            
  END
  ELSE
  BEGIN
    IF (:TRN_TYPE = 'NILT') THEN
    BEGIN
      /* Update LOCN_TYPE */
      UPDATE LOCATION
      SET LOCN_TYPE = :REFERENCE, LAST_UPDATE_DATE = :TRN_DATE, LAST_UPDATE_BY = :PERSON_ID
      WHERE WH_ID = :WH_ID
      AND LOCN_ID = :LOCN_ID;
    END
    ELSE IF (:TRN_TYPE = 'NILS') THEN
    BEGIN
      /* Update LOCN_STAT */
      UPDATE LOCATION
      SET LOCN_STAT = :REFERENCE, LAST_UPDATE_DATE = :TRN_DATE, LAST_UPDATE_BY = :PERSON_ID
      WHERE WH_ID = :WH_ID
      AND LOCN_ID = :LOCN_ID;
    END

    /* Update transactions table */        
    EXECUTE PROCEDURE UPDATE_TRAN (:RECORD_ID, 'T', 'Processed successfully');    
  END 
  SUSPEND;
END ^

ALTER PROCEDURE PC_NIXX (RECORD_ID INTEGER,
WH_ID CHAR(2) CHARACTER SET NONE,
LOCN_ID VARCHAR(10) CHARACTER SET NONE,
OBJECT VARCHAR(30) CHARACTER SET NONE,
TRN_TYPE VARCHAR(4) CHARACTER SET NONE,
TRN_CODE CHAR(1) CHARACTER SET NONE,
TRN_DATE TIMESTAMP,
REFERENCE VARCHAR(40) CHARACTER SET NONE,
QTY INTEGER,
PERSON_ID VARCHAR(10) CHARACTER SET NONE,
DEVICE_ID CHAR(2) CHARACTER SET NONE,
INSTANCE_ID VARCHAR(10) CHARACTER SET NONE)
AS 
DECLARE VARIABLE strWH_ID CHAR(2); 
  DECLARE VARIABLE strINSTANCE VARCHAR(10);
  DECLARE VARIABLE LOCN_EXIST INTEGER; 
  DECLARE VARIABLE LOCN_NAME VARCHAR(50);
  DECLARE VARIABLE SSN_EXIST INTEGER;
  DECLARE VARIABLE strAUDIT_DESC VARCHAR(50);
  DECLARE VARIABLE RESULT INTEGER;
  DECLARE VARIABLE strTYPE VARCHAR(40);
  DECLARE VARIABLE WK_SSN VARCHAR(20);
  DECLARE VARIABLE WK_CODE VARCHAR(75);
  
BEGIN /* Main */
    strWH_ID = '';
    strINSTANCE = '';
    LOCN_EXIST = 0;
    /* LOCN_NAME = 'Created during audit ' || :TRN_DATE; */
    LOCN_NAME = LOCN_ID;
    SSN_EXIST = 0;
    strAUDIT_DESC = ''; 
    /* Check trasaction code */
    IF (:TRN_CODE = 'P') THEN
    BEGIN
       /* Update transactions table */               
       /* EXECUTE PROCEDURE UPDATE_TRAN (:RECORD_ID, 'F', 'Invalid code'); */
       EXECUTE PROCEDURE PC_NIXX_P (:RECORD_ID ,
   :WH_ID ,
   :LOCN_ID ,
   :OBJECT ,
   :TRN_TYPE ,
   :TRN_CODE ,
   :TRN_DATE ,
   :REFERENCE ,
   :QTY ,
   :PERSON_ID ,
   :DEVICE_ID ,
   :INSTANCE_ID );
       EXIT;
    END  
               
    /* Check if warehouse exists */
    SELECT WH_ID, INSTANCE_ID 
    FROM WAREHOUSE
    WHERE WH_ID = :WH_ID
    INTO :strWH_ID, :strINSTANCE;

    /* Check warehouse*/
    IF (strWH_ID = '') THEN
    BEGIN
       /* Update transactions table */               
       EXECUTE PROCEDURE UPDATE_TRAN (:RECORD_ID, 'F', 'Invalid Warehouse');
       EXIT;
    END
    ELSE
    BEGIN /* WH */
        /* Check instance */
        IF (strINSTANCE <> :INSTANCE_ID) THEN  
        BEGIN
          /* Update transactions table */               
          EXECUTE PROCEDURE UPDATE_TRAN (:RECORD_ID, 'F', 'Invalid InstanceID');
          EXIT;
        END
        ELSE
        BEGIN /* Location */
           /* Check Location */                 
    SELECT 1 
    FROM LOCATION
    WHERE WH_ID = :WH_ID
    AND LOCN_ID = :LOCN_ID 
           INTO :LOCN_EXIST; 
           
           /* Location not exists, then add new location */
           IF (LOCN_EXIST = 0) THEN
           BEGIN
              /* Add new Location record */
       INSERT INTO LOCATION (LOCN_ID, WH_ID, LOCN_NAME, LAST_AUDITED_DATE)
              VALUES (:LOCN_ID, :WH_ID, :LOCN_NAME, :TRN_DATE);
           END
                      
           IF (:TRN_TYPE <> 'NIUI') THEN
           BEGIN
              /* Check SSN */
              SELECT 1
              FROM SSN
              WHERE SSN_ID = :OBJECT
              INTO :SSN_EXIST;
              
              /* If SSN does not exists, then add new SSN */
              IF (SSN_EXIST = 0) THEN
              BEGIN
                 /* Not an SSN - try an ISSN */
                 /* Check SSN */
                 SELECT 1, ORIGINAL_SSN
                 FROM ISSN
                 WHERE SSN_ID = :OBJECT
                 INTO :SSN_EXIST, :WK_SSN;
              
                 /* If SSN does not exists, then add new SSN */
                 IF (SSN_EXIST = 0) THEN
                 BEGIN
                    /* Add new SSN */
                    INSERT INTO SSN (SSN_ID, WH_ID, LOCN_ID)
                    VALUES (:OBJECT, :WH_ID, :LOCN_ID);
                    INSERT INTO ISSN (SSN_ID, ORIGINAL_SSN, WH_ID, LOCN_ID)
                    VALUES (:OBJECT, :OBJECT, :WH_ID, :LOCN_ID);
                 END
                 ELSE
                 BEGIN
                    OBJECT = WK_SSN;
                 END
              END
              
              /* Update fields of SSN */
              IF (:TRN_TYPE = 'NITP') THEN  
              BEGIN
          EXECUTE PROCEDURE UPDATE_SSN(:OBJECT, 'NITP', :REFERENCE);  /* Update Type */
          EXECUTE PROCEDURE ADD_MASTER_DATA(:TRN_TYPE, :TRN_DATE, :REFERENCE); 
          strAUDIT_DESC = 'SSN Type was modified';
       END
       ELSE IF (:TRN_TYPE = 'NIOB') THEN
       BEGIN
          EXECUTE PROCEDURE UPDATE_SSN(:OBJECT, 'NIOB', :REFERENCE); /* Update Generic */
          WK_CODE = :OBJECT || '|' || :REFERENCE; 
          EXECUTE PROCEDURE ADD_MASTER_DATA(:TRN_TYPE, :TRN_DATE, :WK_CODE); 
          strAUDIT_DESC = 'Generic description modified';
       END
       ELSE IF (:TRN_TYPE = 'NIBC') THEN
       BEGIN
          EXECUTE PROCEDURE UPDATE_SSN(:OBJECT, 'NIBC', :REFERENCE); /* Update Brand */
          EXECUTE PROCEDURE ADD_MASTER_DATA(:TRN_TYPE, :TRN_DATE, :REFERENCE); 
                 strAUDIT_DESC = 'Brand description modified';
       END
       ELSE IF (:TRN_TYPE = 'NIMO') THEN
       BEGIN
                 EXECUTE PROCEDURE UPDATE_SSN(:OBJECT, 'NIMO', :REFERENCE); /* Update Model */
                 EXECUTE PROCEDURE ADD_MASTER_DATA(:TRN_TYPE, :TRN_DATE, :REFERENCE); 
                 strAUDIT_DESC = 'Model description modified';
              END
              ELSE IF (:TRN_TYPE = 'NICC') THEN
              BEGIN
                 EXECUTE PROCEDURE UPDATE_SSN(:OBJECT, 'NICC', :REFERENCE); /* Update Cost Center */
                 EXECUTE PROCEDURE ADD_MASTER_DATA(:TRN_TYPE, :TRN_DATE, :REFERENCE); 
                 strAUDIT_DESC = 'Cost Center modified';
              END
              ELSE IF (:TRN_TYPE = 'NILG') THEN
              BEGIN
                 EXECUTE PROCEDURE UPDATE_SSN(:OBJECT, 'NILG', :REFERENCE); /* Update LegacyID */
/*
                 EXECUTE PROCEDURE ADD_MASTER_DATA(:TRN_TYPE, :TRN_DATE, :REFERENCE); 
*/
                 strAUDIT_DESC = 'Legacy ID modified';
              END
              ELSE IF (:TRN_TYPE = 'PSRF') THEN
              BEGIN
          EXECUTE PROCEDURE UPDATE_SSN(:OBJECT, 'PSRF', :REFERENCE); /* Update GRN */
          strAUDIT_DESC = 'Product Serial Reference Number modified';
       END
       ELSE IF (:TRN_TYPE = 'NISN') THEN
       BEGIN
                 EXECUTE PROCEDURE UPDATE_SSN(:OBJECT, 'NISN', :REFERENCE); /* Update Serial Number */
                 strAUDIT_DESC = 'Serial Number modified';
              END
       ELSE IF (:TRN_TYPE = 'NIO1') THEN
       BEGIN
                 EXECUTE PROCEDURE UPDATE_SSN(:OBJECT, 'NIO1', :REFERENCE); /* Update Other1 */
                 strAUDIT_DESC = 'Custom Field 1 modified';
              END
       ELSE IF (:TRN_TYPE = 'NIO2') THEN
       BEGIN
                 EXECUTE PROCEDURE UPDATE_SSN(:OBJECT, 'NIO2', :REFERENCE); /* Update Other2 */
                 strAUDIT_DESC = 'Custom Field 2 modified';
              END
       ELSE IF (:TRN_TYPE = 'NIO3') THEN
       BEGIN
                 EXECUTE PROCEDURE UPDATE_SSN(:OBJECT, 'NIO3', :REFERENCE); /* Update Other3 */
                 strAUDIT_DESC = 'Custom Field 3 modified';
              END
       ELSE IF (:TRN_TYPE = 'NIO4') THEN
       BEGIN
                 EXECUTE PROCEDURE UPDATE_SSN(:OBJECT, 'NIO4', :REFERENCE); /* Update Other4 */
                 strAUDIT_DESC = 'Custom Field 4 modified';
              END
       ELSE IF (:TRN_TYPE = 'NIO5') THEN
       BEGIN
                 EXECUTE PROCEDURE UPDATE_SSN(:OBJECT, 'NIO5', :REFERENCE); /* Update Other5 */
                 strAUDIT_DESC = 'Custom Field 5 modified';
              END
       ELSE IF (:TRN_TYPE = 'NIO6') THEN
       BEGIN
                 EXECUTE PROCEDURE UPDATE_SSN(:OBJECT, 'NIO6', :REFERENCE); /* Update Other6 */
                 SELECT SSN_TYPE 
                 FROM SSN 
                 WHERE SSN_ID = :OBJECT
                 INTO :strTYPE; 
                 EXECUTE PROCEDURE ADD_GROUP_DATA('NIO6', :TRN_DATE, :REFERENCE, :strTYPE); 
                 strAUDIT_DESC = 'Type Custom Field 1 modified';
              END
       ELSE IF (:TRN_TYPE = 'NIO7') THEN
       BEGIN
                 EXECUTE PROCEDURE UPDATE_SSN(:OBJECT, 'NIO7', :REFERENCE); /* Update Other7 */
                 SELECT SSN_TYPE 
                 FROM SSN 
                 WHERE SSN_ID = :OBJECT
                 INTO :strTYPE; 
                 EXECUTE PROCEDURE ADD_GROUP_DATA('NIO7', :TRN_DATE, :REFERENCE, :strTYPE); 
                 strAUDIT_DESC = 'Type Custom Field 2 modified';
              END
       ELSE IF (:TRN_TYPE = 'NIO8') THEN
       BEGIN
                 EXECUTE PROCEDURE UPDATE_SSN(:OBJECT, 'NIO8', :REFERENCE); /* Update Other8 */
                 SELECT SSN_TYPE 
                 FROM SSN 
                 WHERE SSN_ID = :OBJECT
                 INTO :strTYPE; 
                 EXECUTE PROCEDURE ADD_GROUP_DATA('NIO8', :TRN_DATE, :REFERENCE, :strTYPE); 
                 strAUDIT_DESC = 'Type Custom Field 3 modified';
              END
       ELSE IF (:TRN_TYPE = 'NIO9') THEN
       BEGIN
                 EXECUTE PROCEDURE UPDATE_SSN(:OBJECT, 'NIO9', :REFERENCE); /* Update Other9 */
                 SELECT SSN_TYPE 
                 FROM SSN 
                 WHERE SSN_ID = :OBJECT
                 INTO :strTYPE; 
                 EXECUTE PROCEDURE ADD_GROUP_DATA('NIO9', :TRN_DATE, :REFERENCE, :strTYPE); 
                 strAUDIT_DESC = 'Type Custom Field 4 modified';
              END
       ELSE IF (:TRN_TYPE = 'NIOA') THEN
       BEGIN
                 EXECUTE PROCEDURE UPDATE_SSN(:OBJECT, 'NIOA', :REFERENCE); /* Update Other10 */
                 SELECT SSN_TYPE 
                 FROM SSN 
                 WHERE SSN_ID = :OBJECT
                 INTO :strTYPE; 
                 EXECUTE PROCEDURE ADD_GROUP_DATA('NIOA', :TRN_DATE, :REFERENCE, :strTYPE); 
                 strAUDIT_DESC = 'Type Custom Field 5 modified';
              END
       ELSE IF (:TRN_TYPE = 'NIOK') THEN
       BEGIN
                 EXECUTE PROCEDURE UPDATE_SSN(:OBJECT, 'NIOK', :REFERENCE); /* Update Other19 */
                 strAUDIT_DESC = 'Maintenance Support No modified';
              END
       ELSE IF (:TRN_TYPE = 'NIPC') THEN
       BEGIN
                 EXECUTE PROCEDURE UPDATE_SSN(:OBJECT, 'NIPC', :REFERENCE); /* Update Product */
                 strAUDIT_DESC = 'Product No modified';
              END
       ELSE IF (:TRN_TYPE = 'NIOL') THEN 
       BEGIN
                 EXECUTE PROCEDURE UPDATE_SSN(:OBJECT, 'NIOL', :REFERENCE); /* Update Other20 */       
                 strAUDIT_DESC = 'Other 20 modified';
              END
       ELSE IF (:TRN_TYPE = 'NI11') THEN 
       BEGIN
                 EXECUTE PROCEDURE UPDATE_SSN(:OBJECT, :TRN_TYPE, :REFERENCE); /* Update Other11 */       
                 EXECUTE PROCEDURE ADD_MASTER_DATA(:TRN_TYPE, :TRN_DATE, :REFERENCE); 
                 strAUDIT_DESC = 'Other 11 modified';
              END
       ELSE IF (:TRN_TYPE = 'NI12') THEN 
       BEGIN
                 EXECUTE PROCEDURE UPDATE_SSN(:OBJECT, :TRN_TYPE, :REFERENCE); /* Update Other12 */       
                 EXECUTE PROCEDURE ADD_MASTER_DATA(:TRN_TYPE, :TRN_DATE, :REFERENCE); 
                 strAUDIT_DESC = 'Other 12 modified';
              END
       ELSE IF (:TRN_TYPE = 'NI13') THEN 
       BEGIN
                 EXECUTE PROCEDURE UPDATE_SSN(:OBJECT, :TRN_TYPE, :REFERENCE); /* Update Other13 */       
                 EXECUTE PROCEDURE ADD_MASTER_DATA(:TRN_TYPE, :TRN_DATE, :REFERENCE); 
                 strAUDIT_DESC = 'Other 13 modified';
              END
       ELSE IF (:TRN_TYPE = 'NI14') THEN 
       BEGIN
                 EXECUTE PROCEDURE UPDATE_SSN(:OBJECT, :TRN_TYPE, :REFERENCE); /* Update Other14 */       
                 EXECUTE PROCEDURE ADD_MASTER_DATA(:TRN_TYPE, :TRN_DATE, :REFERENCE); 
                 strAUDIT_DESC = 'Other 14 modified';
              END
       ELSE IF (:TRN_TYPE = 'NI15') THEN 
       BEGIN
                 EXECUTE PROCEDURE UPDATE_SSN(:OBJECT, :TRN_TYPE, :REFERENCE); /* Update Other15 */       
                 strAUDIT_DESC = 'Other 15 modified';
              END
       ELSE IF (:TRN_TYPE = 'NI16') THEN 
       BEGIN
                 EXECUTE PROCEDURE UPDATE_SSN(:OBJECT, :TRN_TYPE, :REFERENCE); /* Update Other16 */       
                 strAUDIT_DESC = 'Other 16 modified';
              END
       ELSE IF (:TRN_TYPE = 'NI17') THEN 
       BEGIN
                 EXECUTE PROCEDURE UPDATE_SSN(:OBJECT, :TRN_TYPE, :REFERENCE); /* Update Other17 */       
                 strAUDIT_DESC = 'Other 17 modified';
              END
       ELSE IF (:TRN_TYPE = 'NI18') THEN 
       BEGIN
                 EXECUTE PROCEDURE UPDATE_SSN(:OBJECT, :TRN_TYPE, :REFERENCE); /* Update Other18 */       
                 strAUDIT_DESC = 'Other 18 modified';
              END
       ELSE IF (:TRN_TYPE = 'NI19') THEN 
       BEGIN
                 EXECUTE PROCEDURE UPDATE_SSN(:OBJECT, :TRN_TYPE, :REFERENCE); /* Update Other19 */       
                 EXECUTE PROCEDURE ADD_MASTER_DATA(:TRN_TYPE, :TRN_DATE, :REFERENCE); 
                 strAUDIT_DESC = 'Other 19 modified';
              END
       ELSE IF (:TRN_TYPE = 'NI20') THEN 
       BEGIN
                 EXECUTE PROCEDURE UPDATE_SSN(:OBJECT, :TRN_TYPE, :REFERENCE); /* Update Other20 */       
                 EXECUTE PROCEDURE ADD_MASTER_DATA(:TRN_TYPE, :TRN_DATE, :REFERENCE); 
                 strAUDIT_DESC = 'Other 20 modified';
              END
       ELSE IF (:TRN_TYPE = 'NIPP') THEN
       BEGIN
                 SELECT ORIGINAL_SSN
                 FROM ISSN
                 WHERE SSN_ID = :OBJECT
                 INTO WK_SSN;
                 IF (NOT WK_SSN IS NULL) THEN
                 BEGIN
                    UPDATE SSN
                    SET PURCHASE_PRICE = (:QTY / 100)
                    WHERE SSN_ID = :WK_SSN;
                    strAUDIT_DESC = 'Purchase Price modified';
                 END
                 ELSE
                 BEGIN
                    strAUDIT_DESC = 'Purchase Price NOT modified';
                 END
              END
       ELSE IF (:TRN_TYPE = 'NIST') THEN
       BEGIN
                 EXECUTE PROCEDURE UPDATE_SSN(:OBJECT, 'NIST', :REFERENCE); /* Update Status Code */
                 strAUDIT_DESC = 'Status modified';
              END
       ELSE IF (:TRN_TYPE = 'NILX') THEN
       BEGIN
                 EXECUTE PROCEDURE UPDATE_SSN(:OBJECT, 'NILX', :REFERENCE); /* Update Label Location */
                 strAUDIT_DESC = 'Label location modified';
              END
       ELSE IF (:TRN_TYPE = 'NIGC') THEN
       BEGIN
                 EXECUTE PROCEDURE UPDATE_SSN(:OBJECT, 'NIGC', :REFERENCE); /* Group copy */                  
                 strAUDIT_DESC = 'Copy fields from group ' || :REFERENCE;
              END
       ELSE IF (:TRN_TYPE = 'NISU') THEN
       BEGIN
                 EXECUTE PROCEDURE UPDATE_SSN(:OBJECT, 'NISU', :REFERENCE); /* Supplier */                  
                 strAUDIT_DESC = 'Supplier modified ' || :REFERENCE;
              END
       ELSE IF (:TRN_TYPE = 'NIPD') THEN
       BEGIN
                 EXECUTE PROCEDURE UPDATE_SSN(:OBJECT, 'NIPD', :REFERENCE); /* Update Assets Product */
                  EXECUTE PROCEDURE ADD_MASTER_DATA(:TRN_TYPE, :TRN_DATE, :REFERENCE); 
                  strAUDIT_DESC = 'Assets Product modified' || :REFERENCE;
       END
       ELSE IF (:TRN_TYPE = 'NID3') THEN
       BEGIN
                 EXECUTE PROCEDURE UPDATE_SSN(:OBJECT, 'NID3', :REFERENCE); /* Update SSN Sub Type */
                  EXECUTE PROCEDURE ADD_MASTER_DATA(:TRN_TYPE, :TRN_DATE, :REFERENCE); 
                  strAUDIT_DESC = 'Assets SSN Sub Type modified' || :REFERENCE;
       END
       ELSE IF (:TRN_TYPE = 'NICI') THEN
       BEGIN
                 EXECUTE PROCEDURE UPDATE_SSN(:OBJECT, 'NICI', :REFERENCE); /* Update SSN Company */
                  strAUDIT_DESC = 'Assets Company modified' || :REFERENCE;
       END
       
       /* Update transactions table */               
               EXECUTE PROCEDURE UPDATE_TRAN (:RECORD_ID, 'T', 'Processed successfully'); 
               
              /* Add transaction history */                                                                                     
               EXECUTE PROCEDURE ADD_SSN_HIST(:WH_ID, :LOCN_ID, :OBJECT, :TRN_TYPE, :TRN_CODE, :TRN_DATE,
                                              :strAUDIT_DESC, :REFERENCE, :QTY, :PERSON_ID, :DEVICE_ID); 
                           
           END /* SSN */
                                
        END /* Location */
    END /* WH */
END ^

ALTER PROCEDURE PC_NIXX_P (RECORD_ID INTEGER,
WH_ID CHAR(2) CHARACTER SET NONE,
LOCN_ID VARCHAR(10) CHARACTER SET NONE,
OBJECT VARCHAR(30) CHARACTER SET NONE,
TRN_TYPE VARCHAR(4) CHARACTER SET NONE,
TRN_CODE CHAR(1) CHARACTER SET NONE,
TRN_DATE TIMESTAMP,
REFERENCE VARCHAR(40) CHARACTER SET NONE,
QTY INTEGER,
PERSON_ID VARCHAR(10) CHARACTER SET NONE,
DEVICE_ID CHAR(2) CHARACTER SET NONE,
INSTANCE_ID VARCHAR(10) CHARACTER SET NONE)
AS 
 
 
  DECLARE VARIABLE strWH_ID CHAR(2); 
  DECLARE VARIABLE strINSTANCE VARCHAR(10);
  DECLARE VARIABLE LOCN_EXIST INTEGER; 
  DECLARE VARIABLE LOCN_NAME VARCHAR(50);
  DECLARE VARIABLE SSN_EXIST INTEGER;
  DECLARE VARIABLE strAUDIT_DESC VARCHAR(50);
  DECLARE VARIABLE strSSN_ID VARCHAR(20);
  DECLARE VARIABLE strTYPE VARCHAR(40);
  DECLARE VARIABLE WK_SSN VARCHAR(20);
  DECLARE VARIABLE WK_CODE VARCHAR(75);
  
BEGIN /* Main */
    strWH_ID = '';
    strINSTANCE = '';
    LOCN_EXIST = 0;
    LOCN_NAME = 'Created during audit ' || :TRN_DATE;
    SSN_EXIST = 0;
    strAUDIT_DESC = ''; 

    /* Check if warehouse exists */
    SELECT WH_ID, INSTANCE_ID 
    FROM WAREHOUSE
    WHERE WH_ID = :WH_ID
    INTO :strWH_ID, :strINSTANCE;

    /* Check warehouse*/
    IF (strWH_ID = '') THEN
    BEGIN
       /* Update transactions table */               
       EXECUTE PROCEDURE UPDATE_TRAN (:RECORD_ID, 'F', 'Invalid Warehouse');
       EXIT;
    END
    ELSE
    BEGIN /* WH */
        /* Check instance */
        IF (strINSTANCE <> :INSTANCE_ID) THEN  
        BEGIN
          /* Update transactions table */               
          EXECUTE PROCEDURE UPDATE_TRAN (:RECORD_ID, 'F', 'Invalid InstanceID');
          EXIT;
        END
        ELSE
        BEGIN /* Location */
           /* Check Location */                 
           SELECT 1 
           FROM LOCATION
           WHERE WH_ID = :WH_ID
           AND LOCN_ID = :LOCN_ID 
           INTO :LOCN_EXIST; 
           
           /* Location not exists, then add new location */
           IF (LOCN_EXIST = 0) THEN
           BEGIN
              /* Add new Location record */
       INSERT INTO LOCATION (LOCN_ID, WH_ID, LOCN_NAME, LAST_AUDITED_DATE)
              VALUES (:LOCN_ID, :WH_ID, :LOCN_NAME, :TRN_DATE);
           END
                      
           IF (:TRN_TYPE <> 'NIUI') THEN
           BEGIN
              /* Check SSN */
              SELECT COUNT(*)
              FROM SSN
              WHERE PROD_ID = :OBJECT
  AND WH_ID = :WH_ID 
  AND LOCN_ID = :LOCN_ID
              INTO :SSN_EXIST;
              
              /* If SSN does not exists, then can create it */
              IF (SSN_EXIST = 0) THEN
              BEGIN
                 /* new SSN */ 
           EXECUTE PROCEDURE UPDATE_TRAN (:RECORD_ID, 'F', 'Product Not In Location - Use Asset Audit to Create');
           EXIT;
              END
              
              /* Update fields of SSN */

        FOR SELECT SSN_ID
         FROM SSN
              WHERE PROD_ID = :OBJECT
  AND WH_ID = :WH_ID 
  AND LOCN_ID = :LOCN_ID
         INTO :strSSN_ID
        DO
         BEGIN
  IF (:TRN_TYPE = 'NITP') THEN  
         BEGIN
           EXECUTE PROCEDURE UPDATE_SSN(:strSSN_ID, 'NITP', :REFERENCE);  /* Update Type */
           EXECUTE PROCEDURE ADD_MASTER_DATA(:TRN_TYPE, :TRN_DATE, :REFERENCE); 
           strAUDIT_DESC = 'SSN Type was modified';
         END
         ELSE IF (:TRN_TYPE = 'NIOB') THEN
         BEGIN
                  EXECUTE PROCEDURE UPDATE_SSN(:strSSN_ID, 'NIOB', :REFERENCE); /* Update Generic */
                  WK_CODE = :strSSN_ID || '|' || :REFERENCE; 
                  EXECUTE PROCEDURE ADD_MASTER_DATA(:TRN_TYPE, :TRN_DATE, :WK_CODE); 
                  strAUDIT_DESC = 'Generic description modified';
         END
         ELSE IF (:TRN_TYPE = 'NIBC') THEN
         BEGIN
           EXECUTE PROCEDURE UPDATE_SSN(:strSSN_ID, 'NIBC', :REFERENCE); /* Update Brand */
           EXECUTE PROCEDURE ADD_MASTER_DATA(:TRN_TYPE, :TRN_DATE, :REFERENCE); 
                  strAUDIT_DESC = 'Brand description modified';
         END
         ELSE IF (:TRN_TYPE = 'NIMO') THEN
         BEGIN
                  EXECUTE PROCEDURE UPDATE_SSN(:strSSN_ID, 'NIMO', :REFERENCE); /* Update Model */
                  EXECUTE PROCEDURE ADD_MASTER_DATA(:TRN_TYPE, :TRN_DATE, :REFERENCE); 
                  strAUDIT_DESC = 'Model description modified';
         END
         ELSE IF (:TRN_TYPE = 'NICC') THEN
         BEGIN
                  EXECUTE PROCEDURE UPDATE_SSN(:strSSN_ID, 'NICC', :REFERENCE); /* Update Cost Center */
                  EXECUTE PROCEDURE ADD_MASTER_DATA(:TRN_TYPE, :TRN_DATE, :REFERENCE); 
                  strAUDIT_DESC = 'Cost Center modified';
         END
         ELSE IF (:TRN_TYPE = 'NILG') THEN
         BEGIN
                  EXECUTE PROCEDURE UPDATE_SSN(:strSSN_ID, 'NILG', :REFERENCE); /* Update LegacyID */
                  EXECUTE PROCEDURE ADD_MASTER_DATA(:TRN_TYPE, :TRN_DATE, :REFERENCE); 
                  strAUDIT_DESC = 'Legacy ID modified';
         END
         ELSE IF (:TRN_TYPE = 'PSRF') THEN
         BEGIN
           EXECUTE PROCEDURE UPDATE_SSN(:strSSN_ID, 'PSRF', :REFERENCE); /* Update GRN */
           strAUDIT_DESC = 'Product Serial Reference Number modified';
         END
         ELSE IF (:TRN_TYPE = 'NISN') THEN
         BEGIN
                  EXECUTE PROCEDURE UPDATE_SSN(:strSSN_ID, 'NISN', :REFERENCE); /* Update Serial Number */
                  strAUDIT_DESC = 'Serial Number modified';
         END
         ELSE IF (:TRN_TYPE = 'NIO1') THEN
         BEGIN
                  EXECUTE PROCEDURE UPDATE_SSN(:strSSN_ID, 'NIO1', :REFERENCE); /* Update Other1 */
                  strAUDIT_DESC = 'Custom Field 1 modified';
         END
         ELSE IF (:TRN_TYPE = 'NIO2') THEN
         BEGIN
                  EXECUTE PROCEDURE UPDATE_SSN(:strSSN_ID, 'NIO2', :REFERENCE); /* Update Other2 */
                  strAUDIT_DESC = 'Custom Field 2 modified';
         END
         ELSE IF (:TRN_TYPE = 'NIO3') THEN
         BEGIN
                  EXECUTE PROCEDURE UPDATE_SSN(:strSSN_ID, 'NIO3', :REFERENCE); /* Update Other3 */
                  strAUDIT_DESC = 'Custom Field 3 modified';
         END
         ELSE IF (:TRN_TYPE = 'NIO4') THEN
         BEGIN
                  EXECUTE PROCEDURE UPDATE_SSN(:strSSN_ID, 'NIO4', :REFERENCE); /* Update Other4 */
                  strAUDIT_DESC = 'Custom Field 4 modified';
         END
         ELSE IF (:TRN_TYPE = 'NIO5') THEN
         BEGIN
                  EXECUTE PROCEDURE UPDATE_SSN(:strSSN_ID, 'NIO5', :REFERENCE); /* Update Other5 */
                  strAUDIT_DESC = 'Custom Field 5 modified';
         END
         ELSE IF (:TRN_TYPE = 'NIO6') THEN
         BEGIN
                  EXECUTE PROCEDURE UPDATE_SSN(:strSSN_ID, 'NIO6', :REFERENCE); /* Update Other6 */
                 SELECT SSN_TYPE 
                 FROM SSN 
                 WHERE SSN_ID = :OBJECT
                 INTO :strTYPE; 
                 EXECUTE PROCEDURE ADD_GROUP_DATA('NIO6', :TRN_DATE, :REFERENCE, :strTYPE); 
                  strAUDIT_DESC = 'Type Custom Field 1 modified';
         END
         ELSE IF (:TRN_TYPE = 'NIO7') THEN
         BEGIN
                  EXECUTE PROCEDURE UPDATE_SSN(:strSSN_ID, 'NIO7', :REFERENCE); /* Update Other7 */
                 SELECT SSN_TYPE 
                 FROM SSN 
                 WHERE SSN_ID = :OBJECT
                 INTO :strTYPE; 
                 EXECUTE PROCEDURE ADD_GROUP_DATA('NIO7', :TRN_DATE, :REFERENCE, :strTYPE); 
                  strAUDIT_DESC = 'Type Custom Field 2 modified';
         END
         ELSE IF (:TRN_TYPE = 'NIO8') THEN
         BEGIN
                  EXECUTE PROCEDURE UPDATE_SSN(:strSSN_ID, 'NIO8', :REFERENCE); /* Update Other8 */
                 SELECT SSN_TYPE 
                 FROM SSN 
                 WHERE SSN_ID = :OBJECT
                 INTO :strTYPE; 
                 EXECUTE PROCEDURE ADD_GROUP_DATA('NIO8', :TRN_DATE, :REFERENCE, :strTYPE); 
                  strAUDIT_DESC = 'Type Custom Field 3 modified';
         END
         ELSE IF (:TRN_TYPE = 'NIO9') THEN
         BEGIN
                  EXECUTE PROCEDURE UPDATE_SSN(:strSSN_ID, 'NIO9', :REFERENCE); /* Update Other9 */
                 SELECT SSN_TYPE 
                 FROM SSN 
                 WHERE SSN_ID = :OBJECT
                 INTO :strTYPE; 
                 EXECUTE PROCEDURE ADD_GROUP_DATA('NIO9', :TRN_DATE, :REFERENCE, :strTYPE); 
                  strAUDIT_DESC = 'Type Custom Field 4 modified';
         END
         ELSE IF (:TRN_TYPE = 'NIOA') THEN
         BEGIN
                  EXECUTE PROCEDURE UPDATE_SSN(:strSSN_ID, 'NIOA', :REFERENCE); /* Update Other10 */
                 SELECT SSN_TYPE 
                 FROM SSN 
                 WHERE SSN_ID = :OBJECT
                 INTO :strTYPE; 
                 EXECUTE PROCEDURE ADD_GROUP_DATA('NIOA', :TRN_DATE, :REFERENCE, :strTYPE); 
                  strAUDIT_DESC = 'Type Custom Field 5 modified';
         END
         ELSE IF (:TRN_TYPE = 'NIOK') THEN
         BEGIN
                  EXECUTE PROCEDURE UPDATE_SSN(:strSSN_ID, 'NIOK', :REFERENCE); /* Update Other19 */
                  strAUDIT_DESC = 'Maintenance Support No modified';
         END

         ELSE IF (:TRN_TYPE = 'NI11') THEN 
         BEGIN
                   EXECUTE PROCEDURE UPDATE_SSN(:strSSN_ID, :TRN_TYPE, :REFERENCE); /* Update Other11 */       
                   EXECUTE PROCEDURE ADD_MASTER_DATA(:TRN_TYPE, :TRN_DATE, :REFERENCE); 
                   strAUDIT_DESC = 'Other 11 modified';
                END
         ELSE IF (:TRN_TYPE = 'NI12') THEN 
         BEGIN
                   EXECUTE PROCEDURE UPDATE_SSN(:strSSN_ID, :TRN_TYPE, :REFERENCE); /* Update Other12 */       
                   EXECUTE PROCEDURE ADD_MASTER_DATA(:TRN_TYPE, :TRN_DATE, :REFERENCE); 
                   strAUDIT_DESC = 'Other 12 modified';
                END
         ELSE IF (:TRN_TYPE = 'NI13') THEN 
         BEGIN
                   EXECUTE PROCEDURE UPDATE_SSN(:strSSN_ID, :TRN_TYPE, :REFERENCE); /* Update Other13 */       
                   EXECUTE PROCEDURE ADD_MASTER_DATA(:TRN_TYPE, :TRN_DATE, :REFERENCE); 
                   strAUDIT_DESC = 'Other 13 modified';
                END
         ELSE IF (:TRN_TYPE = 'NI14') THEN 
         BEGIN
                   EXECUTE PROCEDURE UPDATE_SSN(:strSSN_ID, :TRN_TYPE, :REFERENCE); /* Update Other14 */       
                   EXECUTE PROCEDURE ADD_MASTER_DATA(:TRN_TYPE, :TRN_DATE, :REFERENCE); 
                   strAUDIT_DESC = 'Other 14 modified';
                END
         ELSE IF (:TRN_TYPE = 'NI15') THEN 
         BEGIN
                   EXECUTE PROCEDURE UPDATE_SSN(:strSSN_ID, :TRN_TYPE, :REFERENCE); /* Update Other15 */       
                   strAUDIT_DESC = 'Other 15 modified';
                END
         ELSE IF (:TRN_TYPE = 'NI16') THEN 
         BEGIN
                   EXECUTE PROCEDURE UPDATE_SSN(:strSSN_ID, :TRN_TYPE, :REFERENCE); /* Update Other16 */       
                   strAUDIT_DESC = 'Other 16 modified';
                END
         ELSE IF (:TRN_TYPE = 'NI17') THEN 
         BEGIN
                   EXECUTE PROCEDURE UPDATE_SSN(:strSSN_ID, :TRN_TYPE, :REFERENCE); /* Update Other17 */       
                   strAUDIT_DESC = 'Other 17 modified';
                END
         ELSE IF (:TRN_TYPE = 'NI18') THEN 
         BEGIN
                   EXECUTE PROCEDURE UPDATE_SSN(:strSSN_ID, :TRN_TYPE, :REFERENCE); /* Update Other18 */       
                   strAUDIT_DESC = 'Other 18 modified';
                END
         ELSE IF (:TRN_TYPE = 'NI19') THEN 
         BEGIN
                   EXECUTE PROCEDURE UPDATE_SSN(:strSSN_ID, :TRN_TYPE, :REFERENCE); /* Update Other19 */       
                   EXECUTE PROCEDURE ADD_MASTER_DATA(:TRN_TYPE, :TRN_DATE, :REFERENCE); 
                   strAUDIT_DESC = 'Other 19 modified';
                END
         ELSE IF (:TRN_TYPE = 'NI20') THEN 
         BEGIN
                   EXECUTE PROCEDURE UPDATE_SSN(:strSSN_ID, :TRN_TYPE, :REFERENCE); /* Update Other20 */       
                   EXECUTE PROCEDURE ADD_MASTER_DATA(:TRN_TYPE, :TRN_DATE, :REFERENCE); 
                   strAUDIT_DESC = 'Other 20 modified';
                END
         ELSE IF (:TRN_TYPE = 'NIPP') THEN
         BEGIN
                 SELECT ORIGINAL_SSN
                 FROM ISSN
                 WHERE SSN_ID = :strSSN_ID
                 INTO WK_SSN;
                 IF (NOT WK_SSN IS NULL) THEN
                 BEGIN
                    UPDATE SSN
                    SET PURCHASE_PRICE = (:QTY / 100)
                    WHERE SSN_ID = :WK_SSN;
                    strAUDIT_DESC = 'Purchase Price modified';
                 END
                 ELSE
                 BEGIN
                    strAUDIT_DESC = 'Purchase Price NOT modified';
                 END
              END
         ELSE IF (:TRN_TYPE = 'NIPC') THEN
         BEGIN
                  EXECUTE PROCEDURE UPDATE_SSN(:strSSN_ID, 'NIPC', :REFERENCE); /* Update Product */
                  strAUDIT_DESC = 'Product No modified';
         END
         ELSE IF (:TRN_TYPE = 'NIOL') THEN 
         BEGIN
                  EXECUTE PROCEDURE UPDATE_SSN(:strSSN_ID, 'NIOL', :REFERENCE); /* Update Other20 */       
                  strAUDIT_DESC = 'Other 20 modified';
         END
         ELSE IF (:TRN_TYPE = 'NIST') THEN
         BEGIN
                  EXECUTE PROCEDURE UPDATE_SSN(:strSSN_ID, 'NIST', :REFERENCE); /* Update Status Code */
                  strAUDIT_DESC = 'Status modified';
         END
         ELSE IF (:TRN_TYPE = 'NILX') THEN
         BEGIN
                  EXECUTE PROCEDURE UPDATE_SSN(:strSSN_ID, 'NILX', :REFERENCE); /* Update Label Location */
                  strAUDIT_DESC = 'Label location modified';
         END
         ELSE IF (:TRN_TYPE = 'NIGC') THEN
         BEGIN
                  EXECUTE PROCEDURE UPDATE_SSN(:strSSN_ID, 'NIGC', :REFERENCE); /* Group copy */                  
                  strAUDIT_DESC = 'Copy fields from group ' || :REFERENCE;
         END
         ELSE IF (:TRN_TYPE = 'NISU') THEN
         BEGIN
                  EXECUTE PROCEDURE UPDATE_SSN(:strSSN_ID, 'NISU', :REFERENCE); /* Supplier */                  
                  EXECUTE PROCEDURE ADD_MASTER_DATA(:TRN_TYPE, :TRN_DATE, :REFERENCE); 
                  strAUDIT_DESC = 'Supplier modified ' || :REFERENCE;
         END
         ELSE IF (:TRN_TYPE = 'NIPD') THEN
         BEGIN
                  EXECUTE PROCEDURE UPDATE_SSN(:strSSN_ID, 'NIPD', :REFERENCE); /* Update Assets Product */
                  EXECUTE PROCEDURE ADD_MASTER_DATA(:TRN_TYPE, :TRN_DATE, :REFERENCE); 
                  strAUDIT_DESC = 'Assets Product modified';
         END
         ELSE IF (:TRN_TYPE = 'NID3') THEN
         BEGIN
                  EXECUTE PROCEDURE UPDATE_SSN(:strSSN_ID, 'NID3', :REFERENCE); /* Update Assets Sub Type */
                  WK_CODE = :strSSN_ID || '|' || :REFERENCE; 
                  EXECUTE PROCEDURE ADD_MASTER_DATA(:TRN_TYPE, :TRN_DATE, :WK_CODE); 
                  strAUDIT_DESC = 'Assets Sub Type modified';
         END
         /* Add transaction history */                                                                                     
         EXECUTE PROCEDURE ADD_SSN_HIST(:WH_ID, :LOCN_ID, :strSSN_ID, :TRN_TYPE, :TRN_CODE, :TRN_DATE,
                                              :strAUDIT_DESC, :REFERENCE, :QTY, :PERSON_ID, :DEVICE_ID); 
         END /* for */
       
       /* Update transactions table */               
              EXECUTE PROCEDURE UPDATE_TRAN (:RECORD_ID, 'T', 'Processed successfully'); 
               
                           
           END /* SSN */
                                
        END /* Location */
    END /* WH */
  SUSPEND;
END ^

ALTER PROCEDURE PC_QANS (RECORD_ID INTEGER,
WH_ID CHAR(2) CHARACTER SET NONE,
LOCN_ID VARCHAR(10) CHARACTER SET NONE,
OBJECT VARCHAR(30) CHARACTER SET NONE,
TRN_TYPE VARCHAR(4) CHARACTER SET NONE,
TRN_CODE CHAR(1) CHARACTER SET NONE,
TRN_DATE TIMESTAMP,
REFERENCE VARCHAR(40) CHARACTER SET NONE,
QTY INTEGER,
PERSON_ID VARCHAR(10) CHARACTER SET NONE,
DEVICE_ID CHAR(2) CHARACTER SET NONE,
SUB_LOCN VARCHAR(10) CHARACTER SET NONE)
AS 
 
  
  DECLARE VARIABLE WK_QUESTION_ID CHAR(5);
  DECLARE VARIABLE WK_ANSWER_ID CHAR(5);
  DECLARE VARIABLE WK_QUESTION_NO INTEGER;
  DECLARE VARIABLE WK_ANSWER_NO INTEGER;
  DECLARE VARIABLE WK_QUESTION VARCHAR(70);
  DECLARE VARIABLE WK_CATEGORY VARCHAR(1);
  DECLARE VARIABLE WK_CATEGORY2 VARCHAR(1);
  DECLARE VARIABLE WK_FIELD_TYPE INTEGER;
  DECLARE VARIABLE WK_UPDATE_FIELD VARCHAR(30);
  DECLARE VARIABLE WK_RUN_PROCEDURE VARCHAR(30);
  DECLARE VARIABLE WK_REPAIR VARCHAR(1);
  DECLARE VARIABLE WK_INSPECT_PASS VARCHAR(6);
  DECLARE VARIABLE WK_TEST_EXISTS INTEGER;
  DECLARE VARIABLE WK_TEST_ID INTEGER;
  DECLARE VARIABLE WK_ORIGINAL VARCHAR(1);
  DECLARE VARIABLE WK_RESPONSE VARCHAR(50);
  DECLARE VARIABLE WK_RESPONSE_CNT INTEGER;
  DECLARE VARIABLE WK_TEST_CNT INTEGER;
  DECLARE VARIABLE WK_SSN_TEST_ID INTEGER;
  DECLARE VARIABLE WK_COND_RESULT CHAR(1);
  DECLARE VARIABLE WK_SSN VARCHAR(20);
  DECLARE VARIABLE WK_SSN_1ST_ANSWER INTEGER;
 DECLARE VARIABLE strDesc VARCHAR(30);
  
BEGIN /* Main */
 /* ssn is in object
           location is current location
           sub location 1st 5 bytes is question id
                        2nd 5 bytes is response id
           reference is user enered response
           qty 0 or 1 is repair_required
        */
   WK_QUESTION_ID = SUBSTR(SUB_LOCN, 1,5);
   WK_ANSWER_ID = SUBSTR(SUB_LOCN, 6,10);
   WK_QUESTION_NO = CAST(WK_QUESTION_ID AS INTEGER);
   WK_ANSWER_NO = CAST(WK_ANSWER_ID AS INTEGER);

    WK_SSN_1ST_ANSWER = 0;
    SELECT 1 FROM SSN 
        WHERE SSN_ID = :OBJECT
          AND ANSWER_ID IS NULL
          INTO WK_SSN_1ST_ANSWER;
    IF (WK_SSN_1ST_ANSWER = 1) THEN
    BEGIN
        /* not answered yet - so 1st question for ssn */
        DELETE FROM PRODUCT_COND_STATUS
            WHERE SSN_ID = :OBJECT
              AND ORIGINAL_TEST = 'S';

    END

    SELECT QUESTION, INSPECT_CATEGORY
        FROM TEST_QUESTIONS
        WHERE QUESTION_ID = :WK_QUESTION_NO
        INTO :WK_QUESTION, :WK_CATEGORY;

    SELECT FIELD_TYPE, 
           UPDATE_FIELD, 
           RUN_PROCEDURE, 
           VALID_RESPONSE, 
           INSPECT_PASS_CRITERIA,
           INSPECT_CATEGORY
        FROM VALID_RESPONSES
        WHERE RESPONSE_ID = :WK_ANSWER_NO
        INTO :WK_FIELD_TYPE, 
             :WK_UPDATE_FIELD, 
             :WK_RUN_PROCEDURE, 
             :WK_RESPONSE, 
             :WK_INSPECT_PASS,
             :WK_CATEGORY2;
    IF (WK_CATEGORY2 IS NULL) THEN
       WK_CATEGORY2 = WK_CATEGORY;
    ELSE
    BEGIN
       WK_CATEGORY = WK_CATEGORY2;
    END
    WK_RESPONSE_CNT = 0;
    SELECT COUNT(*) 
        FROM VALID_RESPONSES
        WHERE QUESTION_ID = :WK_QUESTION_NO
        INTO :WK_RESPONSE_CNT;
    IF (WK_RESPONSE_CNT = 1) THEN
    BEGIN
        WK_RESPONSE = REFERENCE;
    END
    IF (QTY > 0) THEN
    BEGIN
        WK_REPAIR = 'Y';
    END
    ELSE
    BEGIN
        WK_REPAIR = 'N';
    END
    WK_TEST_EXISTS = 0;
    SELECT 1, TEST_ID FROM SSN_TEST
        WHERE SSN_ID = :OBJECT AND
              STATUS_TEST = 'OP'
        INTO :WK_TEST_EXISTS, :WK_TEST_ID;
    IF (WK_TEST_EXISTS = 0) THEN
    BEGIN
        /* must get the next test id */
        WK_TEST_ID = GEN_ID(TEST_ID, 1);
        WK_ORIGINAL = 'O';
        INSERT INTO SSN_TEST(TEST_ID, SSN_ID, START_DATE, STATUS_TEST)
               VALUES (:WK_TEST_ID, :OBJECT, :TRN_DATE, 'OP');
      
    END 
    ELSE
    BEGIN
        WK_TEST_CNT = 0;
        SELECT COUNT(*) FROM SSN_TEST
            WHERE SSN_ID = :OBJECT 
            INTO :WK_TEST_CNT;
        IF (WK_TEST_CNT = 1) THEN
        BEGIN
            WK_ORIGINAL = 'O';
        END
        ELSE
        BEGIN
            WK_ORIGINAL = 'S';
        END
    END
    /* must get the next test id */
    WK_SSN_TEST_ID = GEN_ID(SSN_TEST_ID_GEN, 1);
    INSERT INTO SSN_TEST_RESULTS (SSN_TEST_ID,
        SSN_ID, TIME_STAMP, QUESTION, RESPONSE, FIELD_TYPE,
        UPDATE_FIELD, REPAIR_REQUIRED, RUN_PROCEDURE, 
        INSPECT_CATEGORY, INSPECT_PASS_CRITERIA, ORIGINAL_TEST,
        USER_ID, QUESTION_ID, RESPONSE_ID, TEST_ID, TEXT_RESPONSE)
        VALUES ( :WK_SSN_TEST_ID,
        :OBJECT, :TRN_DATE, :WK_QUESTION, :WK_RESPONSE, :WK_FIELD_TYPE,
        :WK_UPDATE_FIELD, :WK_REPAIR, :WK_RUN_PROCEDURE, 
        :WK_CATEGORY, :WK_INSPECT_PASS, :WK_ORIGINAL,
        :PERSON_ID, :WK_QUESTION_NO, :WK_ANSWER_NO, :WK_TEST_ID, :REFERENCE);
    UPDATE SSN SET QUESTION_ID = :WK_QUESTION_NO,
           ANSWER_ID = :WK_ANSWER_NO
           WHERE SSN_ID = :OBJECT;
    /* now process this result */
    IF (WK_CATEGORY = 'E') THEN 
    BEGIN
        UPDATE SSN
        SET OTHER5 = :WK_RESPONSE
        WHERE SSN_ID = :OBJECT;
    END
    ELSE
    BEGIN
        IF (WK_INSPECT_PASS = 'FAILED') THEN 
        BEGIN
                WK_SSN = OBJECT;
                EXECUTE PROCEDURE ADD_PROD_COND_STATUS_TEST :WK_SSN, :WK_CATEGORY, :WK_RESPONSE , :WK_ORIGINAL
                  RETURNING_VALUES :WK_COND_RESULT;
                IF (WK_ORIGINAL = 'O') THEN
                BEGIN
                    EXECUTE PROCEDURE ADD_PROD_COND_STATUS_TEST :WK_SSN, :WK_CATEGORY, :WK_RESPONSE , 'S'
                      RETURNING_VALUES :WK_COND_RESULT;
                END
                IF (WK_CATEGORY = 'A') THEN 
                BEGIN
                    EXECUTE PROCEDURE GET_GLOBAL_CONDITION 1, 'F' RETURNING_VALUES :strDesc;
                    UPDATE SSN
                         /*SET OTHER1 = 'NOT NEW CONDITION'*/
                         SET OTHER1 = :strDesc
                         WHERE SSN_ID = :OBJECT;
                END
                IF (WK_CATEGORY = 'B') THEN
                BEGIN
                    EXECUTE PROCEDURE GET_GLOBAL_CONDITION 2, 'F' RETURNING_VALUES :strDesc;
                    UPDATE SSN
                         /* SET OTHER2 = 'TESTED - FAULTY'*/
                         SET OTHER2 = :strDesc
                         WHERE SSN_ID = :OBJECT;
                END
                IF (WK_CATEGORY = 'C') THEN
                BEGIN
                    EXECUTE PROCEDURE GET_GLOBAL_CONDITION 3, 'F' RETURNING_VALUES :strDesc;
                    UPDATE SSN
                         /*SET OTHER3 = 'INCOMPLETE'*/
                         SET OTHER3 = :strDesc
                         WHERE SSN_ID = :OBJECT;
                END
                IF (WK_CATEGORY = 'D') THEN
                BEGIN
                    EXECUTE PROCEDURE GET_GLOBAL_CONDITION 4, 'F' RETURNING_VALUES :strDesc;
                    UPDATE SSN
                         /*SET OTHER4 = 'SERVICE PROVIDED'*/
                         SET OTHER4 = :strDesc
                         WHERE SSN_ID = :OBJECT;
                END
        END
    END
    UPDATE SSN_TEST_RESULTS SET PROCESSED = 'P'
        WHERE SSN_TEST_ID = :WK_SSN_TEST_ID;
    EXECUTE PROCEDURE UPDATE_TRAN (RECORD_ID, 'T','Processed successfully');
END ^

ALTER PROCEDURE PC_QANX (RECORD_ID INTEGER,
WH_ID CHAR(2) CHARACTER SET NONE,
LOCN_ID VARCHAR(10) CHARACTER SET NONE,
OBJECT VARCHAR(30) CHARACTER SET NONE,
TRN_TYPE VARCHAR(4) CHARACTER SET NONE,
TRN_CODE CHAR(1) CHARACTER SET NONE,
TRN_DATE TIMESTAMP,
REFERENCE VARCHAR(40) CHARACTER SET NONE,
QTY INTEGER,
PERSON_ID VARCHAR(10) CHARACTER SET NONE,
DEVICE_ID CHAR(2) CHARACTER SET NONE,
SUB_LOCN VARCHAR(10) CHARACTER SET NONE)
AS 
 
 
  DECLARE VARIABLE WK_QUESTION_NO INTEGER;
  DECLARE VARIABLE WK_ANSWER_NO INTEGER;
  DECLARE VARIABLE WK_CATEGORY VARCHAR(1);
  DECLARE VARIABLE WK_INSPECT_PASS VARCHAR(6);
  DECLARE VARIABLE WK_TEST_EXISTS INTEGER;
  DECLARE VARIABLE WK_TEST_ID INTEGER;
  DECLARE VARIABLE WK_ORIGINAL VARCHAR(1);
  DECLARE VARIABLE WK_RESPONSE VARCHAR(50);
  DECLARE VARIABLE WK_SSN_TEST_ID INTEGER;
  DECLARE VARIABLE WK_COUNT INTEGER;
  DECLARE VARIABLE WK_SSN_SSNID VARCHAR(30);
  
BEGIN /* Main */
 /* ssn is in object
           location is current location
        */
/*
calc whether an original test for ssn
calc test_id that is open for ssn
calc last question and answer from ssn_test_results order by date
calc 2nd to last question and answer from ssn_test_results
remove last prod_con_status entry if a failure
 if this was for an original then remove both
if was for category 'E' update other5 to ''
update ssn's question and answer - must read previous ssn_test_result
 if no more then original and null
update ssn_test_result processed to 'U' for last entry
*/

    SELECT ORIGINAL_SSN
       FROM ISSN 
       WHERE SSN_ID = :OBJECT
        INTO :WK_SSN_SSNID;
    WK_TEST_EXISTS = 0;
    SELECT 1, TEST_ID FROM SSN_TEST
        WHERE SSN_ID = :OBJECT AND
              STATUS_TEST = 'OP'
        INTO :WK_TEST_EXISTS, :WK_TEST_ID;
    IF (WK_TEST_EXISTS = 0) THEN
    BEGIN
        /* no test for this - uggh */
        WK_TEST_ID = -1;
    END 
    /* must get the last test id */
    WK_COUNT = 0;
    FOR SELECT FIRST 2 SSN_TEST_ID, QUESTION_ID, RESPONSE, RESPONSE_ID,
        INSPECT_CATEGORY, INSPECT_PASS_CRITERIA, ORIGINAL_TEST 
        FROM SSN_TEST_RESULTS
        WHERE SSN_ID = :OBJECT
        AND TEST_ID = :WK_TEST_ID
        AND PROCESSED = 'P'
        ORDER BY TIME_STAMP DESC
        INTO :WK_SSN_TEST_ID, :WK_QUESTION_NO, :WK_RESPONSE, :WK_ANSWER_NO, :WK_CATEGORY, :WK_INSPECT_PASS, :WK_ORIGINAL
    DO
    BEGIN
       WK_COUNT = WK_COUNT + 1;
       IF (WK_COUNT = 1) THEN
       BEGIN
          IF (WK_INSPECT_PASS = 'FAILED') THEN
          BEGIN
             DELETE FROM PRODUCT_COND_STATUS
                WHERE SSN_ID = :OBJECT
                  AND CODE = :WK_CATEGORY
                  AND DESCRIPTION = :WK_RESPONSE
                  AND ORIGINAL_TEST = :WK_ORIGINAL;
             IF (WK_ORIGINAL = 'O') THEN
             BEGIN
                DELETE FROM PRODUCT_COND_STATUS
                   WHERE SSN_ID = :OBJECT
                     AND CODE = :WK_CATEGORY
                     AND DESCRIPTION = :WK_RESPONSE
                     AND ORIGINAL_TEST = 'S';
             END 
          END
          IF (WK_CATEGORY = 'E') THEN
          BEGIN
             UPDATE SSN SET OTHER5 = ''
             WHERE SSN_ID = :WK_SSN_SSNID;
          END
          UPDATE SSN_TEST_RESULTS SET PROCESSED = 'U'
          WHERE SSN_TEST_ID = :WK_SSN_TEST_ID;
       END
       IF (WK_COUNT = 2) THEN
       BEGIN
          UPDATE SSN SET QUESTION_ID = :WK_QUESTION_NO, ANSWER_ID = :WK_ANSWER_NO
          WHERE SSN_ID = :WK_SSN_SSNID;
       END
    END
    IF (WK_COUNT < 2) THEN
    BEGIN
       /* update ssn's answer and question to null and original */
       SELECT TQ.QUESTION_ID
           FROM SSN SN 
                JOIN TEST_QUESTIONS TQ ON TQ.SSN_TYPE = SN.SSN_TYPE
           WHERE SN.SSN_ID = :WK_SSN_SSNID
                AND TQ.SEQUENCE = 0
           INTO :WK_QUESTION_NO ;
       UPDATE SSN SET ANSWER_ID = NULL, QUESTION_ID = :WK_QUESTION_NO
       WHERE SSN_ID = :WK_SSN_SSNID;
    END

    EXECUTE PROCEDURE UPDATE_TRAN (RECORD_ID, 'T','Processed successfully');
END ^

ALTER PROCEDURE PC_QTY_TROL_TRIL_P (RECORD_ID INTEGER,
WH_ID CHAR(2) CHARACTER SET NONE,
LOCN_ID VARCHAR(10) CHARACTER SET NONE,
PREV_LOCN_ID VARCHAR(10) CHARACTER SET NONE,
PROD_ID VARCHAR(30) CHARACTER SET NONE,
TRN_TYPE VARCHAR(4) CHARACTER SET NONE,
REFERENCE VARCHAR(40) CHARACTER SET NONE,
QTY INTEGER,
PERSON_ID VARCHAR(10) CHARACTER SET NONE,
DEVICE_ID CHAR(2) CHARACTER SET NONE,
TRN_CODE CHAR(1) CHARACTER SET NONE,
TRN_DATE TIMESTAMP,
HIST_DESC VARCHAR(70) CHARACTER SET NONE)
RETURNS (PROCESS_OK CHAR(1) CHARACTER SET NONE)
AS 
 
 
 

  DECLARE VARIABLE PROD_EXIST INTEGER;
  DECLARE VARIABLE strSSN VARCHAR(20); 
  DECLARE VARIABLE strOrigSSN VARCHAR(20); 
  DECLARE VARIABLE iSUB_QTY INTEGER;
  DECLARE VARIABLE iSUB_QTY_WK INTEGER;
  DECLARE VARIABLE iCURRENT_QTY INTEGER;
  DECLARE VARIABLE strISSN_STATUS CHAR(2);
  DECLARE VARIABLE strISSN_STATUS_CODE VARCHAR(10);
  DECLARE VARIABLE strPREV_LOCN VARCHAR(10);
  DECLARE VARIABLE WK_NEW_SSN VARCHAR(20); 

BEGIN

   PROD_EXIST = 0;
   strSSN = '';   
   PROCESS_OK = 'F';
   
   /* Check PROD_ID in SSN */                                                                      
   SELECT FIRST 1 1
   FROM ISSN
   WHERE PROD_ID = :PROD_ID
   INTO :PROD_EXIST;
   
   /* PROD_ID not exist, then exit */
   IF (PROD_EXIST = 0) THEN
   BEGIN
      /* Update transactions table */        
      EXECUTE PROCEDURE UPDATE_TRAN (:RECORD_ID, 'F', 'PROD_ID is not in the SSN table');
      EXIT;   
   END
   
   ELSE
   
   BEGIN
     IF (:TRN_TYPE = 'TRIL') THEN
     BEGIN
       /* must transfer QTY of product (object)
          from location LOCN_ID (= device)
          to location (WH_ID and PREV_LOCN)
       */
       
       iSUB_QTY =  :QTY;
       iCURRENT_QTY = -1;
       strISSN_STATUS = '';
       
       SELECT SUM(CURRENT_QTY)  
       FROM ISSN
       WHERE PROD_ID = :PROD_ID
       AND LOCN_ID = :LOCN_ID
       AND CURRENT_QTY <> 0
       INTO :iCURRENT_QTY; 
       IF (iCURRENT_QTY IS NULL) THEN
       BEGIN
          iCURRENT_QTY = 0;
       END
       IF (iCURRENT_QTY = 0) THEN
       BEGIN
          /* Update transactions table */        
          EXECUTE PROCEDURE UPDATE_TRAN (:RECORD_ID, 'F', 'None of Product found in Location');
          EXIT;
       END            
       ELSE
       BEGIN
          IF (iCURRENT_QTY < QTY) THEN
          BEGIN
             /* Update transactions table */        
             EXECUTE PROCEDURE UPDATE_TRAN (:RECORD_ID, 'F', 'Not Enough Product is in the Location');
             EXIT;
          END            
          ELSE 
          BEGIN
             /* want qty to take */
             FOR SELECT SSN_ID, CURRENT_QTY, ISSN_STATUS, ORIGINAL_SSN, STATUS_CODE, PREV_LOCN_ID 
             FROM ISSN
             WHERE PROD_ID = :PROD_ID
             AND LOCN_ID = :LOCN_ID
             AND CURRENT_QTY <> 0
             INTO :strSSN, :iCURRENT_QTY, :strISSN_STATUS, :strOrigSSN, :strISSN_STATUS_CODE , :strPREV_LOCN
             DO
             BEGIN
                IF (iSUB_QTY > 0) THEN
                BEGIN
                   IF (:iSUB_QTY < :iCURRENT_QTY) THEN
                   BEGIN
                      /* must do a split and take this newer issn */
                      /* Add new record to ISSN table */
                      EXECUTE PROCEDURE ADD_ISSN (:strOrigSSN, :WH_ID, :PREV_LOCN_ID, :strPREV_LOCN,
                                 iSUB_QTY, 0, 'NOW', 
                                 :strISSN_STATUS, :strISSN_STATUS_CODE, 'NOW', :PERSON_ID, :PROD_ID, 1 ); 
                                               
                      SELECT MAX(SSN_ID) 
                      FROM ISSN 
                      WHERE ORIGINAL_SSN = :strOrigSSN AND 
                         WH_ID = :WH_ID AND 
                         LOCN_ID = :PREV_LOCN_ID AND 
                         CURRENT_QTY = :iSUB_QTY
                      INTO :WK_NEW_SSN;
                      /* Update Current_Qty */
                      iSUB_QTY_WK = 0 - iSUB_QTY;
                      EXECUTE PROCEDURE UPDATE_SSN_QTY_TROL (:strSSN, :iSUB_QTY_WK);
                      EXECUTE PROCEDURE ADD_SSN_HIST(:WH_ID, :PREV_LOCN_ID, :WK_NEW_SSN, :TRN_TYPE, :TRN_CODE, :TRN_DATE,
                              :HIST_DESC, :REFERENCE, :iSUB_QTY,  :PERSON_ID, :DEVICE_ID);
                      iSUB_QTY = 0;
                   END   
                   ELSE IF (:iSUB_QTY >= :iCURRENT_QTY) THEN   
                   BEGIN
                      /* take all of this issn */
                      /* Update SSN */ 
                      /* EXECUTE PROCEDURE UPDATE_SSN_TROL_A (:strSSN, :WH_ID, :PREV_LOCN_ID, 'NOW', :DEVICE_ID);     */ 
                      EXECUTE PROCEDURE UPDATE_SSN_TROL_A10 (:strSSN, :WH_ID, :DEVICE_ID, 'NOW', :PREV_LOCN_ID);      
                      iSUB_QTY = iSUB_QTY - iCURRENT_QTY;
                      EXECUTE PROCEDURE ADD_SSN_HIST(:WH_ID, :PREV_LOCN_ID, :strSSN, :TRN_TYPE, :TRN_CODE, :TRN_DATE,
                              :HIST_DESC, :REFERENCE, :iCURRENT_QTY,  :PERSON_ID, :DEVICE_ID);
                   END                       
                END /* end of is qty positive */                       
             END /* end for */
                 
             /* Update transactions table */               
             EXECUTE PROCEDURE UPDATE_TRAN (:RECORD_ID, 'T', 'Processed successfully');
             PROCESS_OK = 'T';
                    
          END /* end else */
       END  /* end else */      
     END /* TRN_TYPE = 'TRIL' */    
     
     ELSE     
     
     IF (:TRN_TYPE = 'TROL') THEN
     BEGIN
       iSUB_QTY =  :QTY;
       iCURRENT_QTY = -1;
       strISSN_STATUS = '';
       
       SELECT SUM(CURRENT_QTY)  
       FROM ISSN
       WHERE PROD_ID = :PROD_ID
       AND WH_ID = :PREV_LOCN_ID
       AND LOCN_ID = :LOCN_ID
       AND CURRENT_QTY <> 0
       INTO :iCURRENT_QTY; 
       IF (iCURRENT_QTY IS NULL) THEN
       BEGIN
          iCURRENT_QTY = 0;
       END
       IF (iCURRENT_QTY = 0) THEN
       BEGIN
          /* Update transactions table */        
          EXECUTE PROCEDURE UPDATE_TRAN (:RECORD_ID, 'F', 'None of Product found in Location');
          EXIT;
       END            
       ELSE
       BEGIN
          IF (iCURRENT_QTY < QTY) THEN
          BEGIN
             /* Update transactions table */        
             EXECUTE PROCEDURE UPDATE_TRAN (:RECORD_ID, 'F', 'Not Enough Product is in the Location');
             EXIT;
          END            
          ELSE 
          BEGIN
             /* want qty to take */
             FOR SELECT SSN_ID, CURRENT_QTY, ISSN_STATUS, ORIGINAL_SSN, STATUS_CODE 
             FROM ISSN
             WHERE PROD_ID = :PROD_ID
             AND WH_ID = :PREV_LOCN_ID
             AND LOCN_ID = :LOCN_ID
             AND CURRENT_QTY <> 0
             INTO :strSSN, :iCURRENT_QTY, :strISSN_STATUS, :strOrigSSN, :strISSN_STATUS_CODE 
             DO
             BEGIN
                IF (iSUB_QTY > 0) THEN
                BEGIN
                   IF (:iSUB_QTY < :iCURRENT_QTY) THEN
                   BEGIN
                      /* must do a split and take this newer issn */
                      /* Add new record to ISSN table */
                      EXECUTE PROCEDURE ADD_ISSN (:strOrigSSN, :WH_ID, :DEVICE_ID, :LOCN_ID,
                                 iSUB_QTY, 0, 'NOW', 
                                 :strISSN_STATUS, :strISSN_STATUS_CODE, 'NOW', :PERSON_ID, :PROD_ID, 1 ); 
                                               
                      SELECT MAX(SSN_ID) 
                      FROM ISSN 
                      WHERE ORIGINAL_SSN = :strOrigSSN AND 
                         WH_ID = :WH_ID AND 
                         LOCN_ID = :DEVICE_ID AND 
                         CURRENT_QTY = :iSUB_QTY
                      INTO :WK_NEW_SSN;
                      /* Update Current_Qty */
                      iSUB_QTY_WK = 0 - iSUB_QTY;
                      EXECUTE PROCEDURE UPDATE_SSN_QTY_TROL (:strSSN, :iSUB_QTY_WK);
                      EXECUTE PROCEDURE ADD_SSN_HIST(:PREV_LOCN_ID, :LOCN_ID, :WK_NEW_SSN, :TRN_TYPE, :TRN_CODE, :TRN_DATE,
                              :HIST_DESC, :REFERENCE, :iSUB_QTY,  :PERSON_ID, :DEVICE_ID);
                      iSUB_QTY = 0;
                   END   
                   ELSE IF (:iSUB_QTY >= :iCURRENT_QTY) THEN   
                   BEGIN
                      /* take all of this issn */
                      /* Update SSN */ 
                      EXECUTE PROCEDURE UPDATE_SSN_TROL_A (:strSSN, :WH_ID, :LOCN_ID, 'NOW', :DEVICE_ID);      
                      iSUB_QTY = iSUB_QTY - iCURRENT_QTY;
                      EXECUTE PROCEDURE ADD_SSN_HIST(:PREV_LOCN_ID, :LOCN_ID, :strSSN, :TRN_TYPE, :TRN_CODE, :TRN_DATE,
                              :HIST_DESC, :REFERENCE, :iCURRENT_QTY,  :PERSON_ID, :DEVICE_ID);
                   END                       
                END /* end of is qty positive */                       
             END /* end for */
          
                 
             /* Update transactions table */               
             EXECUTE PROCEDURE UPDATE_TRAN (:RECORD_ID, 'T', 'Processed successfully');
                              
             PROCESS_OK = 'T';
          END
       END
     
     END /* TRN_TYPE = 'TROL' */
     
   END /* ELSE */
    
   SUSPEND;
END ^

ALTER PROCEDURE PC_STAV (RECORD_ID INTEGER,
WH_ID CHAR(2) CHARACTER SET NONE,
LOCN_ID VARCHAR(10) CHARACTER SET NONE,
OBJECT VARCHAR(30) CHARACTER SET NONE,
TRN_TYPE VARCHAR(4) CHARACTER SET NONE,
TRN_CODE CHAR(1) CHARACTER SET NONE,
TRN_DATE TIMESTAMP,
REFERENCE VARCHAR(40) CHARACTER SET NONE,
QTY INTEGER,
SUB_LOCN_ID VARCHAR(10) CHARACTER SET NONE)
AS 
DECLARE VARIABLE WK_STOCK_RECORD VARCHAR(40);
  DECLARE VARIABLE WK_STOCK_RECORD_ID INTEGER;
  DECLARE VARIABLE WK_STOCK_ACTION VARCHAR(40);
  DECLARE VARIABLE WK_CURRENT_ACTION CHAR(2);
  DECLARE VARIABLE WK_CURRENT_VARIANCE DOUBLE PRECISION;
  DECLARE VARIABLE WK_STOCK_VARIANCE DOUBLE PRECISION;
  DECLARE VARIABLE WK_COMMENT VARCHAR(50);
  DECLARE VARIABLE WK_FOUND INTEGER;
  DECLARE VARIABLE WK_RESPONSE VARCHAR(70);
  DECLARE VARIABLE WK_ORIGINAL_SSN VARCHAR(20);
  DECLARE VARIABLE WK_ISSN_QTY INTEGER;
  DECLARE VARIABLE WK_DEVICE_ID CHAR(2);
  DECLARE VARIABLE WK_USER VARCHAR(10);
  DECLARE VARIABLE WK_DO_UASL CHAR(2);
  DECLARE VARIABLE WK_ISSN_COMPANY VARCHAR(20);
  DECLARE VARIABLE WK_ISSN_PROD VARCHAR(30);
  DECLARE VARIABLE WK_SSN_DESC VARCHAR(255);
  DECLARE VARIABLE WK_ISSUE_UOM CHAR(2);
  DECLARE VARIABLE WK_PROD_COST NUMERIC(9,2);
  DECLARE VARIABLE WK_TOTAL_COST NUMERIC(9,2);

BEGIN

   /*
    want to get the do uasl from the companys record in options table
   */
   WK_CURRENT_ACTION = '';
   /* get the passed record id */
   WK_STOCK_RECORD = '' ; 
   WK_COMMENT = '' ; 
   WK_ISSN_COMPANY = '';
   WK_ISSN_PROD = '';

   EXECUTE PROCEDURE GET_REFERENCE_FIELD :REFERENCE, 1  RETURNING_VALUES :WK_STOCK_RECORD ; 
   EXECUTE PROCEDURE GET_REFERENCE_FIELD :REFERENCE, 2  RETURNING_VALUES :WK_COMMENT ; 

   WK_STOCK_ACTION = 'PA' ;  /* the new action */
   WK_STOCK_RECORD_ID = WK_STOCK_RECORD;

   SELECT PERSON_ID, DEVICE_ID 
   FROM TRANSACTIONS
   WHERE RECORD_ID = :RECORD_ID
   INTO :WK_USER, :WK_DEVICE_ID ;
   
   IF (TRN_CODE NOT IN ( 'A' )) THEN
   BEGIN
      /* UPDATE TRANSACTIONS
      SET COMPLETE = 'F', ERROR_TEXT = 'TRN_CODE HAS TO BE A'
      WHERE RECORD_ID = :RECORD_ID; */
      EXECUTE PROCEDURE UPDATE_TRAN (RECORD_ID, 'F','TRN CODE is Not A');
      EXIT;
   END
   
   IF (SUB_LOCN_ID IS NOT NULL) THEN
   BEGIN
      WK_COMMENT = WK_COMMENT || SUB_LOCN_ID;
   END

   SELECT SEND_UASL_V4 
   FROM CONTROL
   INTO :WK_DO_UASL;

   IF (WK_DO_UASL IS NULL) THEN
   BEGIN
      WK_DO_UASL = 'F';
   END
   WK_FOUND = 0;
   SELECT 1, ST_ACTION, ST_VARIANCE
   FROM STOCKTAKE
   WHERE RECORD_ID = :WK_STOCK_RECORD_ID
   INTO :WK_FOUND, :WK_CURRENT_ACTION, :WK_CURRENT_VARIANCE;

   IF (WK_FOUND IS NULL) THEN
   BEGIN
      WK_FOUND = 0;
   END

   IF (WK_FOUND = 0) THEN
   BEGIN
      WK_RESPONSE = 'No Stocktake record for this ID ' || :WK_STOCK_RECORD;
      EXECUTE PROCEDURE UPDATE_TRAN (RECORD_ID, 'F',:WK_RESPONSE);
      EXIT;
   END

   IF (WK_CURRENT_ACTION IS NULL) THEN
   BEGIN
      WK_CURRENT_ACTION = '';
   END

   IF (WK_CURRENT_VARIANCE IS NULL) THEN
   BEGIN
      WK_CURRENT_VARIANCE = 0;
   END

   WK_STOCK_VARIANCE = QTY;

   WK_FOUND = 0;
   SELECT 1, ORIGINAL_SSN, CURRENT_QTY, COMPANY_ID, PROD_ID
   FROM ISSN
   WHERE SSN_ID = :OBJECT
   INTO :WK_FOUND, :WK_ORIGINAL_SSN, WK_ISSN_QTY, :WK_ISSN_COMPANY, :WK_ISSN_PROD;

   IF (WK_FOUND IS NULL) THEN
   BEGIN
      WK_FOUND = 0;
   END

   IF (WK_ISSN_COMPANY IS NULL) THEN
   BEGIN
      SELECT COMPANY_ID FROM CONTROL INTO :WK_ISSN_COMPANY;
   END
   IF (WK_ISSN_COMPANY IS NULL) THEN
   BEGIN
      WK_ISSN_COMPANY = '';
   END

   IF (WK_FOUND = 0) THEN
   BEGIN
      WK_RESPONSE = 'No ISSN record for this ID ' || :OBJECT;
      EXECUTE PROCEDURE UPDATE_TRAN (RECORD_ID, 'F',:WK_RESPONSE);
      EXIT;
   END

   WK_SSN_DESC = '';
   SELECT SSN_DESCRIPTION
   FROM SSN
   WHERE SSN_ID = :WK_ORIGINAL_SSN
   INTO :WK_SSN_DESC;

   IF (WK_SSN_DESC IS NULL) THEN
   BEGIN
      WK_SSN_DESC = '';
   END

   WK_ISSUE_UOM = '';
   WK_PROD_COST = 0;
   SELECT ISSUE_UOM, STANDARD_COST
   FROM PROD_PROFILE
   WHERE PROD_ID = :WK_ISSN_PROD
   INTO :WK_ISSUE_UOM, :WK_PROD_COST;

   IF (WK_ISSUE_UOM IS NULL) THEN
   BEGIN
      WK_ISSUE_UOM = 'EA';
   END

   WK_TOTAL_COST = WK_PROD_COST * WK_ISSN_QTY;

   IF (WK_ISSN_QTY + WK_CURRENT_VARIANCE < 0) THEN
   BEGIN
      EXECUTE PROCEDURE UPDATE_TRAN (RECORD_ID, 'F','Cannot Update as Current Qty Will become Negative');
      EXIT;
   END

   IF (WK_CURRENT_ACTION = 'AV') THEN
   BEGIN
      /* want to apply the change to the qty */
      UPDATE ISSN
      SET CURRENT_QTY = CURRENT_QTY + :WK_CURRENT_VARIANCE
      WHERE SSN_ID = :OBJECT;
      UPDATE SSN
      SET CURRENT_QTY = CURRENT_QTY + :WK_CURRENT_VARIANCE
      WHERE SSN_ID = :WK_ORIGINAL_SSN;

      WK_RESPONSE = 'Processed successfully';
      /* want to add ssn hist */
      EXECUTE PROCEDURE ADD_SSN_HIST(:WH_ID, :LOCN_ID, :OBJECT, 
                       :TRN_TYPE, :TRN_CODE, :TRN_DATE,
                       :WK_RESPONSE, :REFERENCE , :QTY, :WK_USER, :WK_DEVICE_ID); 
      /* want to add legacy adjustment */
      IF (WK_DO_UASL = 'T') THEN
      BEGIN
         INSERT INTO LEGACY_ADJUSTMENT (
                LA_PROD_ID ,
                LA_SSN_ID ,
                LA_WH_ID ,
                LA_LOCN_ID ,
                LA_ADJUST_BY ,
                LA_UOM , 
                LA_UNIT_COST , 
                LA_TOTAL_VALUE , 
                LA_DESCRIPTION , 
                LA_CREATE_DATE ,
                LA_COMPANY_ID , 
                LA_STATUS , 
                LA_USER_ID ,
                LA_DEVICE_ID ,
                STOCKTAKE_RECORD_ID
                ) VALUES (
                :WK_ISSN_PROD ,
                :OBJECT ,
                :WH_ID ,
                :LOCN_ID ,
                :WK_CURRENT_VARIANCE ,
                :WK_ISSUE_UOM , 
                :WK_PROD_COST , 
                :WK_TOTAL_COST , 
                :WK_SSN_DESC , 
                :TRN_DATE ,
                :WK_ISSN_COMPANY , 
                'PU' , 
                :WK_USER ,
                :WK_DEVICE_ID ,
                :WK_STOCK_RECORD_ID );

      END

      UPDATE STOCKTAKE 
      SET ST_ACTION = :WK_STOCK_ACTION
      WHERE RECORD_ID = :WK_STOCK_RECORD_ID; 

      EXECUTE PROCEDURE UPDATE_TRAN (RECORD_ID, 'T',:WK_RESPONSE);
   END
   ELSE
   BEGIN
      EXECUTE PROCEDURE UPDATE_TRAN (RECORD_ID, 'F','Not an AV action for this Stocktake Record');
      EXIT;
   END

END ^

ALTER PROCEDURE PC_STIS (RECORD_ID INTEGER,
WH_ID CHAR(2) CHARACTER SET NONE,
LOCN_ID VARCHAR(10) CHARACTER SET NONE,
OBJECT VARCHAR(30) CHARACTER SET NONE,
TRN_TYPE VARCHAR(4) CHARACTER SET NONE,
TRN_CODE CHAR(1) CHARACTER SET NONE,
TRN_DATE TIMESTAMP,
REFERENCE VARCHAR(40) CHARACTER SET NONE,
ISSN_QTY INTEGER)
AS 
DECLARE VARIABLE LOCN_EXIST INTEGER;
  DECLARE VARIABLE WH_EXIST INTEGER;
  DECLARE VARIABLE COUNT_ISSN INTEGER;
  DECLARE VARIABLE LOCN_NAME VARCHAR(50);
  DECLARE VARIABLE LOCN_STAT CHAR(2);
  DECLARE VARIABLE LOCN_OWNER VARCHAR(10);
  DECLARE VARIABLE ST_MAX_RECORD_ID INTEGER;
  DECLARE VARIABLE ST_INITIATE_STIS INTEGER;
  DECLARE VARIABLE ST_STATUS CHAR(2);
  DECLARE VARIABLE ST_ACTION CHAR(2);
  DECLARE VARIABLE ST_VARIANCE INTEGER;
  DECLARE VARIABLE ISSN_COMPANYID VARCHAR(20);
  DECLARE VARIABLE ISSN_LOCN_ID VARCHAR(10);
  DECLARE VARIABLE ISSN_WH_ID VARCHAR(2);
  DECLARE VARIABLE QTY_ISSN_IN_LOCN INTEGER;
  DECLARE VARIABLE WK_QTY_IN_TRAN DOUBLE PRECISION;
  DECLARE VARIABLE WK_DEVICE_ID CHAR(2);
  DECLARE VARIABLE WK_USER VARCHAR(10);
  DECLARE VARIABLE ST_NEW_RECORD_ID INTEGER;
  DECLARE VARIABLE WK_NEW_ISSN CHAR(1);
  DECLARE VARIABLE WK_SUB_LOCN_ID VARCHAR(10);
  DECLARE VARIABLE WK_QTY_ISSN VARCHAR(20);
  DECLARE VARIABLE WK_STOCK_RECORD VARCHAR(20);
  DECLARE VARIABLE WK_COMMENT VARCHAR(40);
  DECLARE VARIABLE WK_RESPONSE VARCHAR(70);
  DECLARE VARIABLE WK_AUDIT CHAR(1);

  DECLARE VARIABLE WK_ORIG_SSN_ID VARCHAR(20);
  DECLARE VARIABLE WK_OWNER       VARCHAR(20);
  DECLARE VARIABLE WK_PROD_STATUS CHAR(2);
  DECLARE VARIABLE WK_PROD_DESC VARCHAR(50);
  DECLARE VARIABLE WK_PROD_TYPE VARCHAR(40);
  DECLARE VARIABLE SSN_ID INTEGER;
  DECLARE VARIABLE P_SSN_ID INTEGER;
  DECLARE VARIABLE W_SSN_ID VARCHAR(20);
  DECLARE VARIABLE LEN_SSN_ID INTEGER;
  DECLARE VARIABLE SSN_LENGTH INTEGER;

  DECLARE VARIABLE WK_LOG_FILENAME VARCHAR(80);
  DECLARE VARIABLE WK_BUFFER VARCHAR(200);
  DECLARE VARIABLE WK_LOG_RESULT INTEGER;
  
BEGIN

   WK_LOG_FILENAME = '/tmp/stis.log';
   /* DATE: 2ND FEB: DO I NEED TO FIRE THIS PROC EVEN WHEN THE LOCATION IS CORRECT */
   /* I THINK BEFORE FIRING THIS PROC I HAVE TO ESTABLISH WHETHER ST_STATUS OF LOCATION HAS BEEN UPDATED BY STLX (I THINK) ? OTHERWISE THROW ERROR AND EXIT */
/* I want to change the audit status for any seen issn so that the totals left to see work */

  ST_NEW_RECORD_ID = '0';
  LOCN_EXIST = 0;
  WH_EXIST = 0;
  COUNT_ISSN = 0;
  QTY_ISSN_IN_LOCN = 0;
  WK_QTY_IN_TRAN = 0;
  ST_INITIATE_STIS = 0;
  ISSN_COMPANYID = '';
  ISSN_LOCN_ID = '';
  ISSN_WH_ID = '';
  ST_ACTION = 'IG'; /* IGNORE */
  WK_NEW_ISSN = 'F';
  ST_MAX_RECORD_ID = NULL;
  /* get the passed qty */
  EXECUTE PROCEDURE GET_REFERENCE_FIELD :REFERENCE, 1  RETURNING_VALUES :WK_QTY_ISSN ; 
  EXECUTE PROCEDURE GET_REFERENCE_FIELD :REFERENCE, 2  RETURNING_VALUES :WK_STOCK_RECORD ; 
  EXECUTE PROCEDURE GET_REFERENCE_FIELD :REFERENCE, 3  RETURNING_VALUES :WK_COMMENT ; 
  WK_QTY_IN_TRAN  = WK_QTY_ISSN;

  IF (TRN_CODE NOT IN ('R', 'F', 'A', 'P', 'Q')) THEN
  BEGIN
     UPDATE TRANSACTIONS
     SET COMPLETE = 'F', ERROR_TEXT = 'TRN_CODE HAS TO BE R OR F OR A OR P OR Q'
     WHERE RECORD_ID = :RECORD_ID;
     EXIT;
  END
   
  SELECT 1,LOCN_STAT,LOCN_OWNER
  FROM LOCATION
  WHERE WH_ID = :WH_ID
  AND LOCN_ID = :LOCN_ID
  INTO :LOCN_EXIST, :LOCN_STAT, :LOCN_OWNER;

  IF (LOCN_EXIST = 0) THEN
  BEGIN
     UPDATE TRANSACTIONS
     SET COMPLETE = 'F', ERROR_TEXT = 'LOCATION DOES NOT EXIST. STLO TRANSACTION REQUIRED.'
     WHERE RECORD_ID = :RECORD_ID;
     EXIT;
  END

  IF (LOCN_STAT IS NULL) THEN
  BEGIN
     LOCN_STAT = 'OK';
  END
  IF (LOCN_OWNER IS NULL) THEN
  BEGIN
     LOCN_STAT = 'OK';
     SELECT PERSON_ID FROM TRANSACTIONS WHERE RECORD_ID = :RECORD_ID INTO :LOCN_OWNER;
  END
  IF (LOCN_STAT = 'OK') THEN
  BEGIN
     UPDATE LOCATION SET LOCN_STAT = 'ST', LOCN_OWNER = :LOCN_OWNER
     WHERE WH_ID = :WH_ID
     AND LOCN_ID = :LOCN_ID;
     LOCN_STAT = 'ST';
  END
/*
  IF (LOCN_STAT NOT IN ('ST')) THEN
  BEGIN
     UPDATE TRANSACTIONS
     SET COMPLETE = 'F', ERROR_TEXT = 'LOCN_STAT HAS TO BE ST. STLO TRANSACTION REQUIRED.'
     WHERE RECORD_ID = :RECORD_ID;
     EXIT;
  END
*/
   
  SELECT PERSON_ID, DEVICE_ID, SUB_LOCN_ID
  FROM TRANSACTIONS
  WHERE RECORD_ID = :RECORD_ID
  INTO :WK_USER, :WK_DEVICE_ID, :WK_SUB_LOCN_ID;
   
  IF (WK_SUB_LOCN_ID IS NULL) THEN
  BEGIN
     WK_SUB_LOCN_ID = '';
  END

  IF ((TRN_CODE = 'R') OR (TRN_CODE = 'F')) THEN
  BEGIN
     SELECT COUNT(*) FROM ISSN
     WHERE SSN_ID = :OBJECT
     INTO :COUNT_ISSN;

     IF (COUNT_ISSN = 0) THEN
     BEGIN
        UPDATE TRANSACTIONS
        SET COMPLETE = 'F', ERROR_TEXT = 'ISSN DOES NOT EXIST'
        WHERE RECORD_ID = :RECORD_ID;
        EXIT;
        WK_NEW_ISSN = 'T';
     END

     SELECT SUM(CURRENT_QTY) 
     FROM ISSN
     WHERE SSN_ID = :OBJECT
     AND WH_ID = :WH_ID
     AND LOCN_ID = :LOCN_ID
     INTO :QTY_ISSN_IN_LOCN;

     SELECT COMPANY_ID, LOCN_ID, WH_ID 
     FROM ISSN
     WHERE SSN_ID = :OBJECT
/*
   AND WH_ID = :WH_ID
   AND LOCN_ID = :LOCN_ID
*/
     INTO :ISSN_COMPANYID, :ISSN_LOCN_ID, :ISSN_WH_ID;
  END
  IF ((TRN_CODE = 'Q') OR (TRN_CODE = 'P')) THEN
  BEGIN
     SELECT COUNT(*) FROM ISSN
     WHERE PROD_ID = :OBJECT
     AND WH_ID = :WH_ID
     AND LOCN_ID = :LOCN_ID
     INTO :COUNT_ISSN;

     IF (COUNT_ISSN = 0) THEN
     BEGIN
        WK_NEW_ISSN = 'T';
     END

     SELECT SUM(CURRENT_QTY) 
     FROM ISSN
     WHERE PROD_ID = :OBJECT
     AND WH_ID = :WH_ID
     AND LOCN_ID = :LOCN_ID
     INTO :QTY_ISSN_IN_LOCN;

     SELECT FIRST 1 COMPANY_ID, LOCN_ID, WH_ID 
     FROM ISSN
     WHERE PROD_ID = :OBJECT
     AND WH_ID = :WH_ID
     AND LOCN_ID = :LOCN_ID
     INTO :ISSN_COMPANYID, :ISSN_LOCN_ID, :ISSN_WH_ID;
  END

  IF (QTY_ISSN_IN_LOCN IS NULL) THEN
  BEGIN
     QTY_ISSN_IN_LOCN = 0;
  END
  IF (ISSN_COMPANYID IS NULL) THEN
  BEGIN
     ISSN_COMPANYID = '';
  END
  IF (ISSN_LOCN_ID IS NULL) THEN
  BEGIN
     ISSN_LOCN_ID = '';
  END
  IF (ISSN_WH_ID IS NULL) THEN
  BEGIN
     ISSN_WH_ID = '';
  END

  IF (TRN_CODE = 'R') THEN
  BEGIN
     SELECT FIRST 1 RECORD_ID FROM STOCKTAKE
     WHERE ST_SSN_ID = :OBJECT
     ORDER BY ST_AUDIT_DATE DESC
     INTO :ST_MAX_RECORD_ID;

     IF (ST_MAX_RECORD_ID IS NOT NULL) THEN
     BEGIN
        ST_INITIATE_STIS = 1;
        ST_ACTION = 'IR';
        UPDATE STOCKTAKE
           SET ST_ACTION = 'IR',
           ST_APPLIED_DATE = :TRN_DATE,
           ST_APPLIED_BY = :WK_USER,
           ST_APPLIED_DEVICE_ID = :WK_DEVICE_ID
        WHERE RECORD_ID = :ST_MAX_RECORD_ID;
               
        UPDATE STOCKTAKE
           SET ST_ACTION = 'IR',
           ST_APPLIED_DATE = :TRN_DATE,
           ST_APPLIED_BY = :WK_USER,
           ST_APPLIED_DEVICE_ID = :WK_DEVICE_ID
        WHERE ST_SSN_ID = :OBJECT
        AND ST_ACTION <> 'IR' ;
     END
     ELSE
     BEGIN
        ST_INITIATE_STIS = 0;
        UPDATE TRANSACTIONS
           SET COMPLETE = 'F', ERROR_TEXT = 'CANNOT RECOUNT:' + '|' + ' STOCKTAKE NOT INITIATED FOR THIS ISSN'
           WHERE RECORD_ID = :RECORD_ID;
        EXIT;
     END
            /* if (ST_MAX_RECORD_ID IS NULL) then */
  END     /* if (TRN_CODE = 'R') then */

  IF (TRN_CODE = 'Q') THEN
  BEGIN
     SELECT FIRST 1 RECORD_ID FROM STOCKTAKE
     WHERE ST_PROD_ID = :OBJECT
     AND ST_WH_ID = :WH_ID
     AND ST_LOCN_ID = :LOCN_ID
     ORDER BY ST_AUDIT_DATE DESC
     INTO :ST_MAX_RECORD_ID;

     IF (ST_MAX_RECORD_ID IS NOT NULL) THEN
     BEGIN
        ST_INITIATE_STIS = 3;
        ST_ACTION = 'IR';
        UPDATE STOCKTAKE
           SET ST_ACTION = 'IR',
           ST_APPLIED_DATE = :TRN_DATE,
           ST_APPLIED_BY = :WK_USER,
           ST_APPLIED_DEVICE_ID = :WK_DEVICE_ID
        WHERE RECORD_ID = :ST_MAX_RECORD_ID;
               
        UPDATE STOCKTAKE
           SET ST_ACTION = 'IR',
           ST_APPLIED_DATE = :TRN_DATE,
           ST_APPLIED_BY = :WK_USER,
           ST_APPLIED_DEVICE_ID = :WK_DEVICE_ID
        WHERE ST_PROD_ID = :OBJECT
        AND ST_WH_ID = :WH_ID
        AND ST_LOCN_ID = :LOCN_ID
        AND ST_ACTION <> 'IR' ;
     END
     ELSE
     BEGIN
        ST_INITIATE_STIS = 2;
        UPDATE TRANSACTIONS
           SET COMPLETE = 'F', ERROR_TEXT = 'CANNOT RECOUNT:' + '|' + ' STOCKTAKE NOT INITIATED FOR THIS PRODUCT'
           WHERE RECORD_ID = :RECORD_ID;
        EXIT;
     END
            /* if (ST_MAX_RECORD_ID IS NULL) then */
  END     /* if (TRN_CODE = 'Q') then */

  IF (TRN_CODE = 'F') THEN
  BEGIN
     ST_INITIATE_STIS = 1;
     UPDATE STOCKTAKE
     SET ST_ACTION = 'IR',
     ST_APPLIED_DATE = :TRN_DATE,
     ST_APPLIED_BY = :WK_USER,
     ST_APPLIED_DEVICE_ID = :WK_DEVICE_ID
     WHERE ST_SSN_ID = :OBJECT
     AND ST_ACTION <> 'IR' ;
  END
  IF (TRN_CODE = 'P') THEN
  BEGIN
     ST_INITIATE_STIS = 3;
     UPDATE STOCKTAKE
     SET ST_ACTION = 'IR',
     ST_APPLIED_DATE = :TRN_DATE,
     ST_APPLIED_BY = :WK_USER,
     ST_APPLIED_DEVICE_ID = :WK_DEVICE_ID
     WHERE ST_PROD_ID = :OBJECT
     AND ST_WH_ID = :WH_ID
     AND ST_LOCN_ID = :LOCN_ID
     AND ST_ACTION <> 'IR' ;
  END

  IF (ST_INITIATE_STIS = 1) THEN
  BEGIN
     IF (WK_NEW_ISSN = 'T') THEN
     BEGIN
        /* must create the issn but whats its company and product */
        QTY_ISSN_IN_LOCN = WK_QTY_IN_TRAN;
     END
     IF (WH_ID || LOCN_ID = ISSN_WH_ID || ISSN_LOCN_ID) THEN
          /* CORRECT LOCATION */
     BEGIN
        IF (QTY_ISSN_IN_LOCN = WK_QTY_IN_TRAN) THEN
        BEGIN
           ST_STATUS = 'CC';
           /* want to update the issns audit date audited flag  */
           UPDATE ISSN SET AUDITED = 'C', AUDIT_DATE=:TRN_DATE
           WHERE SSN_ID = :OBJECT;
           WK_AUDIT = 'C';
        END
        ELSE
        BEGIN
           ST_STATUS = 'IC';
           ST_ACTION = 'RC';
           /* want to update the issns audit date audited flag  */
           IF (ST_MAX_RECORD_ID IS NULL) THEN
           BEGIN
              /* an F trn code */
              UPDATE ISSN SET AUDITED = 'R', AUDIT_DATE=:TRN_DATE
              WHERE SSN_ID = :OBJECT;
              WK_AUDIT = 'R';
           END
           ELSE
           BEGIN
              /* an R trn code */
              UPDATE ISSN SET AUDITED = 'C', AUDIT_DATE=:TRN_DATE
              WHERE SSN_ID = :OBJECT;
              WK_AUDIT = 'C';
              /* ST_ACTION = 'CC'; */ /* ???? */
              /* ST_STATUS = 'CC'; */
           END
        END
        WK_RESPONSE = 'Processed successfully' || ' Audit ' || :WK_AUDIT || ' SubLocn ' || :WK_SUB_LOCN_ID;
        /* want to add ssn hist */
        EXECUTE PROCEDURE ADD_SSN_HIST(:WH_ID, :LOCN_ID, :OBJECT, 
                :TRN_TYPE, :TRN_CODE, :TRN_DATE,
                :WK_RESPONSE, :REFERENCE , :ISSN_QTY, :WK_USER, :WK_DEVICE_ID); 
     END

     IF (WH_ID || LOCN_ID <> ISSN_WH_ID || ISSN_LOCN_ID) THEN
        /* INCORRECT LOCATION */
     BEGIN
        IF (QTY_ISSN_IN_LOCN = WK_QTY_IN_TRAN) THEN
        BEGIN
           ST_STATUS = 'CL';
           /* want to update the issns audit date audited flag and wh and locn */
           UPDATE ISSN SET AUDITED = 'D', AUDIT_DATE=:TRN_DATE, WH_ID = :WH_ID, LOCN_ID = :LOCN_ID
           WHERE SSN_ID = :OBJECT;
           WK_AUDIT = 'D';
        END
        ELSE
        BEGIN
           ST_STATUS = 'IL';
           ST_ACTION = 'RC';
           /* want to update the issns audit date audited flag and wh and locn */
           IF (ST_MAX_RECORD_ID IS NULL) THEN
           BEGIN
              /* an F trn code */
              UPDATE ISSN SET AUDITED = 'R', AUDIT_DATE=:TRN_DATE, WH_ID = :WH_ID, LOCN_ID = :LOCN_ID
              WHERE SSN_ID = :OBJECT;
              WK_AUDIT = 'R';
           END
           ELSE
           BEGIN
              /* an R trn code */
              UPDATE ISSN SET AUDITED = 'D', AUDIT_DATE=:TRN_DATE, WH_ID = :WH_ID, LOCN_ID = :LOCN_ID
              WHERE SSN_ID = :OBJECT;
              /* ST_STATUS = 'CL'; */
              /* ST_ACTION = 'CC'; */ /* ???? */
              WK_AUDIT = 'D';
           END
        END
        WK_RESPONSE = 'Processed successfully' || ' Audit ' || :WK_AUDIT || ' SubLocn ' || :WK_SUB_LOCN_ID;
        /* want to add ssn hist */
        EXECUTE PROCEDURE ADD_SSN_HIST(:WH_ID, :LOCN_ID, :OBJECT, 
                :TRN_TYPE, :TRN_CODE, :TRN_DATE,
                :WK_RESPONSE, :REFERENCE , :ISSN_QTY, :WK_USER, :WK_DEVICE_ID); 
     END
  END

  IF (ST_INITIATE_STIS = 3) THEN
  BEGIN
     IF (WK_NEW_ISSN = 'T') THEN
     BEGIN
        /* must create the issn but whats its company and product */
        QTY_ISSN_IN_LOCN = WK_QTY_IN_TRAN;
        ISSN_WH_ID = WH_ID;
        ISSN_LOCN_ID = LOCN_ID;
        /* need 
           ssn.ssn_id to use
           initial prod status
           company
           issn.ssn_id to use */
        EXECUTE PROCEDURE GET_BARCODE_LENGTH RETURNING_VALUES SSN_LENGTH;
        WK_OWNER = NULL;
        IF (WK_OWNER IS NULL) THEN
        BEGIN
           SELECT COMPANY_ID FROM CONTROL INTO :WK_OWNER; 
        END
        SELECT NEW_PROD_STATUS 
           FROM CONTROL
           INTO :WK_PROD_STATUS;
        BEGIN
           SSN_ID = GEN_ID(ISSN_SSN_ID, 1);
           P_SSN_ID = SSN_ID - 1;
           LEN_SSN_ID = STRLEN(P_SSN_ID);
           W_SSN_ID = '';
              /* Padding leading with 0 */
           WHILE (LEN_SSN_ID < :SSN_LENGTH) DO
           BEGIN
              W_SSN_ID = W_SSN_ID || '0';
              LEN_SSN_ID = LEN_SSN_ID + 1;
           END
           W_SSN_ID = W_SSN_ID || P_SSN_ID;
        END
        SELECT FIRST 1 SSN_ID 
           FROM SSN
           WHERE PROD_ID = :OBJECT
           AND COMPANY_ID = :WK_OWNER
           INTO :WK_ORIG_SSN_ID;
        IF (WK_ORIG_SSN_ID IS NULL) THEN
        BEGIN
           SELECT SHORT_DESC, SSN_TYPE
           FROM PROD_PROFILE
           WHERE PROD_ID = :OBJECT
           INTO :WK_PROD_DESC, :WK_PROD_TYPE;
           INSERT INTO SSN (SSN_ID, WH_ID, LOCN_ID,  STATUS_SSN, LABEL_DATE, ORIGINAL_QTY,
           CURRENT_QTY, PO_RECEIVE_DATE, PROD_ID, SSN_DESCRIPTION, COMPANY_ID, CREATE_DATE, CREATED_BY, SSN_TYPE)
           VALUES (:W_SSN_ID, :WH_ID, :LOCN_ID,  :WK_PROD_STATUS, 'NOW', :QTY_ISSN_IN_LOCN, :QTY_ISSN_IN_LOCN, 'NOW', :OBJECT, :WK_PROD_DESC, :WK_OWNER, :TRN_DATE, :WK_USER, :WK_PROD_TYPE);
        END
        INSERT INTO ISSN (SSN_ID, ORIGINAL_SSN, WH_ID, LOCN_ID, CURRENT_QTY,ISSN_STATUS, PROD_ID, LABEL_DATE, COMPANY_ID, ORIGINAL_QTY, CREATE_DATE,USER_ID, INTO_DATE)
        VALUES (:W_SSN_ID, :WK_ORIG_SSN_ID, :WH_ID, :LOCN_ID, :QTY_ISSN_IN_LOCN, :WK_PROD_STATUS, :OBJECT, 'NOW', :WK_OWNER, :QTY_ISSN_IN_LOCN, :TRN_DATE, :WK_USER, :TRN_DATE );
     END
     IF (WH_ID || LOCN_ID = ISSN_WH_ID || ISSN_LOCN_ID) THEN
          /* CORRECT LOCATION */
     BEGIN
        IF (QTY_ISSN_IN_LOCN = WK_QTY_IN_TRAN) THEN
        BEGIN
           ST_STATUS = 'CC';
           /* want to update the issns audit date audited flag  */
           UPDATE ISSN SET AUDITED = 'C', AUDIT_DATE=:TRN_DATE
           WHERE PROD_ID = :OBJECT
           AND WH_ID = :WH_ID
           AND LOCN_ID = :LOCN_ID;
           WK_AUDIT = 'C';
        END
        ELSE
        BEGIN
           ST_STATUS = 'IC';
           ST_ACTION = 'RC';
           /* want to update the issns audit date audited flag  */
           IF (ST_MAX_RECORD_ID IS NULL) THEN
           BEGIN
              /* an F trn code */
              UPDATE ISSN SET AUDITED = 'R', AUDIT_DATE=:TRN_DATE
              WHERE PROD_ID = :OBJECT
              AND WH_ID = :WH_ID
              AND LOCN_ID = :LOCN_ID;
              WK_AUDIT = 'R';
           END
           ELSE
           BEGIN
              /* an R trn code */
              UPDATE ISSN SET AUDITED = 'C', AUDIT_DATE=:TRN_DATE
              WHERE PROD_ID = :OBJECT
              AND WH_ID = :WH_ID
              AND LOCN_ID = :LOCN_ID;
              WK_AUDIT = 'C';
              /* ST_ACTION = 'CC'; */ /* ???? */
              /* ST_STATUS = 'CC'; */
           END
        END
        WK_RESPONSE = 'Processed successfully' || ' Audit ' || :WK_AUDIT || ' SubLocn ' || :WK_SUB_LOCN_ID;
        /* want to add ssn hist */
        EXECUTE PROCEDURE ADD_SSN_HIST(:WH_ID, :LOCN_ID, :OBJECT, 
                :TRN_TYPE, :TRN_CODE, :TRN_DATE,
                :WK_RESPONSE, :REFERENCE , :ISSN_QTY, :WK_USER, :WK_DEVICE_ID); 
     END

     IF (WH_ID || LOCN_ID <> ISSN_WH_ID || ISSN_LOCN_ID) THEN
        /* INCORRECT LOCATION */
     BEGIN
        IF (QTY_ISSN_IN_LOCN = WK_QTY_IN_TRAN) THEN
        BEGIN
           ST_STATUS = 'CL';
           /* want to update the issns audit date audited flag and wh and locn */
           UPDATE ISSN SET AUDITED = 'D', AUDIT_DATE=:TRN_DATE, WH_ID = :WH_ID, LOCN_ID = :LOCN_ID
           WHERE PROD_ID = :OBJECT
           AND WH_ID = :WH_ID
           AND LOCN_ID = :LOCN_ID;
           WK_AUDIT = 'D';
        END
        ELSE
        BEGIN
           ST_STATUS = 'IL';
           ST_ACTION = 'RC';
           /* want to update the issns audit date audited flag and wh and locn */
           IF (ST_MAX_RECORD_ID IS NULL) THEN
           BEGIN
              /* an F trn code */
              UPDATE ISSN SET AUDITED = 'R', AUDIT_DATE=:TRN_DATE, WH_ID = :WH_ID, LOCN_ID = :LOCN_ID
              WHERE PROD_ID = :OBJECT
              AND WH_ID = :WH_ID
              AND LOCN_ID = :LOCN_ID;
              WK_AUDIT = 'R';
           END
           ELSE
           BEGIN
              /* an R trn code */
              UPDATE ISSN SET AUDITED = 'D', AUDIT_DATE=:TRN_DATE, WH_ID = :WH_ID, LOCN_ID = :LOCN_ID
              WHERE PROD_ID = :OBJECT
              AND WH_ID = :WH_ID
              AND LOCN_ID = :LOCN_ID;
              /* ST_STATUS = 'CL'; */
              /* ST_ACTION = 'CC'; */ /* ???? */
              WK_AUDIT = 'D';
           END
        END
        WK_RESPONSE = 'Processed successfully' || ' Audit ' || :WK_AUDIT || ' SubLocn ' || :WK_SUB_LOCN_ID;
        /* want to add ssn hist */
        EXECUTE PROCEDURE ADD_SSN_HIST(:WH_ID, :LOCN_ID, :OBJECT, 
                :TRN_TYPE, :TRN_CODE, :TRN_DATE,
                :WK_RESPONSE, :REFERENCE , :ISSN_QTY, :WK_USER, :WK_DEVICE_ID); 
     END
  END
  ST_VARIANCE = WK_QTY_IN_TRAN - QTY_ISSN_IN_LOCN;
  IF ((TRN_CODE = 'R') OR (TRN_CODE = 'F')) THEN
  BEGIN
     SELECT NEW_RECORD_ID FROM ADD_UPDATE_STOCKTAKE (
       0, :OBJECT, :WH_ID, :LOCN_ID, :WK_QTY_IN_TRAN, :ST_VARIANCE , :TRN_DATE, :WK_USER, :WK_DEVICE_ID, :ST_STATUS, : ST_ACTION, NULL, NULL, NULL,:ISSN_COMPANYID )
       INTO :ST_NEW_RECORD_ID;
  END
  IF ((TRN_CODE = 'Q') OR (TRN_CODE = 'P')) THEN
  BEGIN
     SELECT NEW_RECORD_ID FROM ADD_UPDATE_STOCKTAKE (
       0, NULL, :WH_ID, :LOCN_ID, :WK_QTY_IN_TRAN, :ST_VARIANCE , :TRN_DATE, :WK_USER, :WK_DEVICE_ID, :ST_STATUS, : ST_ACTION, NULL, NULL, NULL,:ISSN_COMPANYID )
       INTO :ST_NEW_RECORD_ID;
      UPDATE STOCKTAKE SET ST_PROD_ID = :OBJECT WHERE RECORD_ID = :ST_NEW_RECORD_ID;
  END

  IF (ST_NEW_RECORD_ID IS NULL) THEN
  BEGIN
    UPDATE TRANSACTIONS
    SET COMPLETE = 'F', ERROR_TEXT = 'ERROR IN INSERTING RECORD IN STOCKTAKE.'
    WHERE RECORD_ID = :RECORD_ID;
  END

  IF (ST_NEW_RECORD_ID IS NOT NULL) THEN
  BEGIN
   UPDATE TRANSACTIONS
   SET COMPLETE = 'T', ERROR_TEXT = 'Processed successfully' || '|' || :ST_NEW_RECORD_ID || '|' || :ST_ACTION || '|' || CAST(:ST_VARIANCE AS VARCHAR(10)) || '|' || :ST_STATUS || '|'
   WHERE RECORD_ID = :RECORD_ID;
  END

END ^

ALTER PROCEDURE PC_STLO (RECORD_ID INTEGER,
WH_ID CHAR(2) CHARACTER SET NONE,
LOCN_ID VARCHAR(10) CHARACTER SET NONE,
DEVICE VARCHAR(10) CHARACTER SET NONE,
TRN_DATE TIMESTAMP)
AS 
DECLARE VARIABLE LOCN_EXIST INTEGER;
  DECLARE VARIABLE WH_EXIST INTEGER;    
  DECLARE VARIABLE LOCN_NAME VARCHAR(50); 
  DECLARE VARIABLE LOCN_STAT CHAR(2); 
  DECLARE VARIABLE LOCN_OWNER VARCHAR(10); 
  DECLARE VARIABLE COUNT_ISSN_IN_LOCN INTEGER;

BEGIN
  LOCN_EXIST = 0;   
  WH_EXIST = 0;
  COUNT_ISSN_IN_LOCN = 0;
  LOCN_NAME = LEFTS(LOCN_ID || ' Created during audit ' || :TRN_DATE,50);

  /* Check if Location exists */
  LOCN_EXIST = 0;
  SELECT 1,LOCN_STAT,LOCN_OWNER
  FROM LOCATION
  WHERE WH_ID = :WH_ID
  AND LOCN_ID = :LOCN_ID 
  INTO :LOCN_EXIST, :LOCN_STAT, :LOCN_OWNER;  
  
  
  /* Location exists, then update transaction and Last_Audited */
  IF (LOCN_EXIST <> 0) THEN
  BEGIN  
       IF (LOCN_STAT = 'OK') THEN
       BEGIN

            /* TRACK 216
            ASK GLEN if WHERE CLAUSE RELATED TO AUDIT IS NOT NULL CORRECT? BECAUSE I BELIEVE
            THAT if (AUDIT IS NOT NULL) then THE ISSN IS UNDERGOING SOME AUDIT PROCESS AND HENCE SHOULD
            NOT BE CONSIDERED. REFER THIS TO GLEN... */
              SELECT COUNT(*) FROM ISSN
              WHERE WH_ID = :WH_ID
              AND   LOCN_ID = :LOCN_ID
              INTO :COUNT_ISSN_IN_LOCN;
              
               /* 
               UPDATE ISSN
               SET AUDITED = 'M', AUDIT_DATE = :TRN_DATE
               WHERE WH_ID = :WH_ID
               AND LOCN_ID = :LOCN_ID;
               */
               UPDATE ISSN
               SET AUDITED = 'M' 
               WHERE WH_ID = :WH_ID
               AND LOCN_ID = :LOCN_ID
               AND AUDIT_DATE IS NULL;
               UPDATE ISSN
               SET AUDITED = 'M' 
               WHERE WH_ID = :WH_ID
               AND LOCN_ID = :LOCN_ID
               AND AUDIT_DATE < ZEROTIME(:TRN_DATE);
               
               /* END OF TRACK 216 */
       
              /* Update Last_Audited in LOCATION table */
              UPDATE LOCATION
              SET LAST_AUDITED_DATE = :TRN_DATE,
                  LOCN_STAT = 'ST',
                  LOCN_OWNER = :DEVICE
              WHERE WH_ID = :WH_ID
              AND LOCN_ID = :LOCN_ID;
              
                             /* Update transactions table */
               UPDATE TRANSACTIONS
               SET COMPLETE = 'T', ERROR_TEXT = 'Processed successfully' || '|' || :COUNT_ISSN_IN_LOCN || '|'
               WHERE RECORD_ID = :RECORD_ID;

       END
       ELSE
       BEGIN
               IF (LOCN_STAT = 'ST' AND LOCN_OWNER = DEVICE) THEN
               BEGIN
                  /* TRACK 216
            ASK GLEN if WHERE CLAUSE RELATED TO AUDIT IS NOT NULL CORRECT? BECAUSE I BELIEVE
            THAT if (AUDIT IS NOT NULL) then THE ISSN IS UNDERGOING SOME AUDIT PROCESS AND HENCE SHOULD
            NOT BE CONSIDERED. REFER THIS TO GLEN... */
            
            /* I THINK THERE COULD BE A CASE WHERE IN THE LOCN_STAT = 'ST' AND USER TRIES TO INITIATE STOCK TAKE AGAIN
            MAYBE MORE RECORDS HAVE BEEN ADDED TO THE LOCN BY THEN.. AND THIS TIME EVEN THOUGH THE STATUS IS OF THE LOCATION IS UNDER STOCKTAKE
            WE WOULD LIKE TO UPDATE THE PENDING ISSN WITH AUDITED = 'M' AS PER GLENS 216 TRACK NUMBER */

              SELECT COUNT(*) FROM ISSN
              WHERE WH_ID = :WH_ID
              AND   LOCN_ID = :LOCN_ID
              AND   AUDITED = 'M'
              INTO :COUNT_ISSN_IN_LOCN;


/*
               UPDATE ISSN
               SET AUDITED = 'M', AUDIT_DATE = :TRN_DATE
               WHERE WH_ID = :WH_ID
               AND LOCN_ID = :LOCN_ID;
*/

               /* END OF TRACK 216 */
                       /* Update transactions table */
                       UPDATE TRANSACTIONS
                       SET COMPLETE = 'T', ERROR_TEXT = 'Processed successfully'
                       || '|'  || :COUNT_ISSN_IN_LOCN || '|'
                       WHERE RECORD_ID = :RECORD_ID; 
               END
               ELSE
               BEGIN
                       /* Update transactions table */
                       UPDATE TRANSACTIONS
                       SET COMPLETE = 'F', ERROR_TEXT = 'Cannot Stocktake - Not an Open Location'
                       WHERE RECORD_ID = :RECORD_ID; 
       
               END
       END
  END
  ELSE
  BEGIN
        /* Check WH_ID */     
       WH_EXIST = 0;
       SELECT 1 
       FROM WAREHOUSE
       WHERE WH_ID = :WH_ID       
       INTO :WH_EXIST; 

       IF (WH_EXIST <> 0) THEN
       BEGIN
              /* Add new Location record */
              INSERT INTO LOCATION (LOCN_ID, WH_ID, LOCN_NAME, LAST_AUDITED_DATE,LOCN_STAT,LOCN_OWNER)
              VALUES (:LOCN_ID, :WH_ID, :LOCN_NAME, :TRN_DATE,'ST',:DEVICE);

              /* Update transactions table */
              UPDATE TRANSACTIONS
              SET COMPLETE = 'T', ERROR_TEXT = 'New location created'
              WHERE RECORD_ID = :RECORD_ID; 
       END
       ELSE
       BEGIN
              /* Update transactions table */
              UPDATE TRANSACTIONS
              SET COMPLETE = 'F', ERROR_TEXT = 'Warehouse master not found'
              WHERE RECORD_ID = :RECORD_ID;
       END    
  END
END ^

ALTER PROCEDURE PC_STLX (RECORD_ID INTEGER,
WH_ID CHAR(2) CHARACTER SET NONE,
LOCN_ID VARCHAR(10) CHARACTER SET NONE,
DEVICE VARCHAR(10) CHARACTER SET NONE,
TRN_DATE TIMESTAMP)
AS 
DECLARE VARIABLE LOCN_EXIST INTEGER; 
  DECLARE VARIABLE WH_EXIST INTEGER;    
  DECLARE VARIABLE LOCN_STAT CHAR(2); 
  DECLARE VARIABLE LOCN_OWNER VARCHAR(10); 
  DECLARE VARIABLE WK_WH_ID CHAR(2); 
  DECLARE VARIABLE WK_LOCN_ID VARCHAR(10); 
  DECLARE VARIABLE WK_USER VARCHAR(10); 
  DECLARE VARIABLE WK_ISSN_SSN VARCHAR(30); 
  DECLARE VARIABLE WK_ISSN_COMPANY_ID VARCHAR(20); 
  DECLARE VARIABLE WK_ISSN_QTY INTEGER; 
  DECLARE VARIABLE WK_ISSN_VARIANCE INTEGER; 
  DECLARE VARIABLE WK_NEW_RECORD_ID INTEGER; 
  DECLARE VARIABLE WK_TRN_TYPE VARCHAR(4); 
  DECLARE VARIABLE WK_TRN_CODE CHAR(1); 
  DECLARE VARIABLE WK_UPDATED CHAR(1); 

BEGIN
   LOCN_EXIST = 0;   
   WH_EXIST = 0;
   LOCN_OWNER = DEVICE;
   WK_USER = '';
   WK_TRN_CODE = '';
   WK_TRN_TYPE = '';
   WK_UPDATED = 'F';

   SELECT  PERSON_ID, TRN_TYPE, TRN_CODE 
   FROM TRANSACTIONS
   WHERE RECORD_ID = :RECORD_ID 
   INTO :WK_USER, :WK_TRN_TYPE, :WK_TRN_CODE;
  /* Check if Location exists */
  /* try the passed location */
   LOCN_EXIST = 0;
   FOR SELECT 1,LOCN_STAT,WH_ID,LOCN_ID
   FROM LOCATION
   WHERE WH_ID = :WH_ID AND LOCN_ID = :LOCN_ID
   INTO :LOCN_EXIST, :LOCN_STAT, :WK_WH_ID, :WK_LOCN_ID
   DO
   BEGIN
      IF (:LOCN_STAT IS NULL) THEN 
      BEGIN
         LOCN_STAT = '';
      END
      /* Location exists, then update transaction and Last_Audited */
      IF (LOCN_STAT = 'ST') THEN
      BEGIN
         /* Update transactions table */
         IF (WK_TRN_TYPE = 'STLX') THEN
         BEGIN
            UPDATE TRANSACTIONS
            SET COMPLETE = 'T', 
                ERROR_TEXT = 'Processed successfully',
                WH_ID = :WK_WH_ID,
                LOCN_ID = :WK_LOCN_ID
            WHERE RECORD_ID = :RECORD_ID ;
            WK_UPDATED = 'T';
         END
         ELSE
         BEGIN
            INSERT INTO TRANSACTIONS_ARCHIVE
               (WH_ID, LOCN_ID, OBJECT, TRN_TYPE, TRN_CODE, TRN_DATE, REFERENCE,
                QTY, ERROR_TEXT, INSTANCE_ID, EXPORTED, SUB_LOCN_ID, INPUT_SOURCE,
                PERSON_ID, DEVICE_ID)
            SELECT :WK_WH_ID, :WK_LOCN_ID, OBJECT, TRN_TYPE, TRN_CODE, TRN_DATE, REFERENCE,
                QTY, 'Processed successfully', INSTANCE_ID, EXPORTED, SUB_LOCN_ID, INPUT_SOURCE,
                PERSON_ID, DEVICE_ID 
             FROM TRANSACTIONS
             WHERE RECORD_ID = :RECORD_ID;
            WK_UPDATED = 'T';
         END
         /* Update Last_Audited in LOCATION table */
         UPDATE LOCATION
         SET LOCN_STAT = 'OK',
             LOCN_OWNER = ''
         WHERE WH_ID = :WK_WH_ID
         AND LOCN_ID = :WK_LOCN_ID;
         /* want to add stocktake records for all 'M' audit issns for the location */
         IF (WK_TRN_CODE = 'A') THEN
         BEGIN
            FOR SELECT SSN_ID, COMPANY_ID, CURRENT_QTY
                FROM ISSN
                WHERE WH_ID = :WK_WH_ID
                AND LOCN_ID = :WK_LOCN_ID
                AND AUDITED = 'M'
                INTO :WK_ISSN_SSN, :WK_ISSN_COMPANY_ID, :WK_ISSN_QTY
            DO
            BEGIN
               /* must update the previous stocktake records for this issn */
               UPDATE STOCKTAKE
               SET ST_ACTION = 'IR',
               ST_APPLIED_DATE = :TRN_DATE,
               ST_APPLIED_BY = :WK_USER,
               ST_APPLIED_DEVICE_ID = :DEVICE
               WHERE ST_SSN_ID = :WK_ISSN_SSN
               AND ST_ACTION <> 'IR' ;
               WK_ISSN_VARIANCE = 0 - WK_ISSN_QTY;
               SELECT NEW_RECORD_ID FROM ADD_UPDATE_STOCKTAKE (
                 0, :WK_ISSN_SSN, :WK_WH_ID, :WK_LOCN_ID, 0, :WK_ISSN_VARIANCE , :TRN_DATE, :WK_USER, :DEVICE, 'MI', 'RC', NULL, NULL, NULL,:WK_ISSN_COMPANY_ID )
               INTO :WK_NEW_RECORD_ID;
            END
         END
         IF (WK_TRN_CODE = 'P') THEN
         BEGIN
            FOR SELECT PROD_ID, COMPANY_ID, SUM(CURRENT_QTY)
            FROM ISSN
                WHERE WH_ID = :WK_WH_ID
                AND LOCN_ID = :WK_LOCN_ID
                AND AUDITED = 'M'
             GROUP BY PROD_ID, COMPANY_ID
                INTO :WK_ISSN_SSN, :WK_ISSN_COMPANY_ID, :WK_ISSN_QTY
            DO
            BEGIN
               /* must update the previous stocktake records for this issn */
               UPDATE STOCKTAKE
               SET ST_ACTION = 'IR',
               ST_APPLIED_DATE = :TRN_DATE,
               ST_APPLIED_BY = :WK_USER,
               ST_APPLIED_DEVICE_ID = :DEVICE
               WHERE ST_PROD_ID = :WK_ISSN_SSN
               AND   ST_WH_ID   = :WK_WH_ID
               AND   ST_LOCN_ID = :WK_LOCN_ID
               AND ST_ACTION <> 'IR' ;
               WK_ISSN_VARIANCE = 0 - WK_ISSN_QTY;
               SELECT NEW_RECORD_ID FROM ADD_UPDATE_STOCKTAKE (
                 0, NULL, :WK_WH_ID, :WK_LOCN_ID, 0, :WK_ISSN_VARIANCE , :TRN_DATE, :WK_USER, :DEVICE, 'MI', 'RC', NULL, NULL, NULL,:WK_ISSN_COMPANY_ID )
               INTO :WK_NEW_RECORD_ID;
               UPDATE STOCKTAKE SET ST_PROD_ID = :WK_ISSN_SSN WHERE RECORD_ID = :WK_NEW_RECORD_ID;
            END
         END
      END
      ELSE
      BEGIN
         /* Update transactions table */
         EXECUTE PROCEDURE UPDATE_TRAN (:RECORD_ID, 'F', 'Cannot Close Stocktake - Not being Stocktaked');
         WK_UPDATED = 'T';
      END
   END

  /* now   do the locations owned by this device */
   LOCN_EXIST = 0;
   FOR SELECT 1,LOCN_STAT,WH_ID,LOCN_ID
   FROM LOCATION
   WHERE LOCN_OWNER = :DEVICE
   INTO :LOCN_EXIST, :LOCN_STAT, :WK_WH_ID, :WK_LOCN_ID
   DO
   BEGIN
      IF (:LOCN_STAT IS NULL) THEN 
      BEGIN
         LOCN_STAT = '';
      END
      /* Location exists, then update transaction and Last_Audited */
      IF (LOCN_STAT = 'ST') THEN
      BEGIN
         /* Update transactions table */
         IF (WK_TRN_TYPE = 'STLX') THEN
         BEGIN
            UPDATE TRANSACTIONS
            SET COMPLETE = 'T', 
                ERROR_TEXT = 'Processed successfully',
                WH_ID = :WK_WH_ID,
                LOCN_ID = :WK_LOCN_ID
            WHERE RECORD_ID = :RECORD_ID ;
            WK_UPDATED = 'T';
         END
         ELSE
         BEGIN
            INSERT INTO TRANSACTIONS_ARCHIVE
               (WH_ID, LOCN_ID, OBJECT, TRN_TYPE, TRN_CODE, TRN_DATE, REFERENCE,
                QTY, ERROR_TEXT, INSTANCE_ID, EXPORTED, SUB_LOCN_ID, INPUT_SOURCE,
                PERSON_ID, DEVICE_ID)
            SELECT :WK_WH_ID, :WK_LOCN_ID, OBJECT, TRN_TYPE, TRN_CODE, TRN_DATE, REFERENCE,
                QTY, 'Processed successfully', INSTANCE_ID, EXPORTED, SUB_LOCN_ID, INPUT_SOURCE,
                PERSON_ID, DEVICE_ID 
             FROM TRANSACTIONS
            WHERE RECORD_ID = :RECORD_ID;
            WK_UPDATED = 'T';
         END
        /* Update Last_Audited in LOCATION table */
         UPDATE LOCATION
         SET LOCN_STAT = 'OK',
            LOCN_OWNER = ''
         WHERE WH_ID = :WK_WH_ID
         AND LOCN_ID = :WK_LOCN_ID;
         /* want to add stocktake records for all 'M' audit issns for the location */
         IF (WK_TRN_CODE = 'A') THEN
         BEGIN
            FOR SELECT SSN_ID, COMPANY_ID, CURRENT_QTY
            FROM ISSN
            WHERE WH_ID = :WK_WH_ID
            AND LOCN_ID = :WK_LOCN_ID
            AND AUDITED = 'M'
            INTO :WK_ISSN_SSN, :WK_ISSN_COMPANY_ID, :WK_ISSN_QTY
            DO
            BEGIN
               /* must update the previous stocktake records for this issn */
               UPDATE STOCKTAKE
               SET ST_ACTION = 'IR',
               ST_APPLIED_DATE = :TRN_DATE,
               ST_APPLIED_BY = :WK_USER,
               ST_APPLIED_DEVICE_ID = :DEVICE
               WHERE ST_SSN_ID = :WK_ISSN_SSN
               AND ST_ACTION <> 'IR' ;
               WK_ISSN_VARIANCE = 0 - WK_ISSN_QTY;
               SELECT NEW_RECORD_ID FROM ADD_UPDATE_STOCKTAKE (
                  0, :WK_ISSN_SSN, :WK_WH_ID, :WK_LOCN_ID, 0, :WK_ISSN_VARIANCE , :TRN_DATE, :WK_USER, :DEVICE, 'MI', 'RC', NULL, NULL, NULL,:WK_ISSN_COMPANY_ID )
               INTO :WK_NEW_RECORD_ID;
            END
         END
         IF (WK_TRN_CODE = 'P') THEN
         BEGIN
            FOR SELECT PROD_ID, COMPANY_ID, SUM(CURRENT_QTY)
            FROM ISSN
            WHERE WH_ID = :WK_WH_ID
            AND LOCN_ID = :WK_LOCN_ID
            AND AUDITED = 'M'
             GROUP BY PROD_ID, COMPANY_ID
            INTO :WK_ISSN_SSN, :WK_ISSN_COMPANY_ID, :WK_ISSN_QTY
            DO
            BEGIN
               /* must update the previous stocktake records for this issn */
               UPDATE STOCKTAKE
               SET ST_ACTION = 'IR',
               ST_APPLIED_DATE = :TRN_DATE,
               ST_APPLIED_BY = :WK_USER,
               ST_APPLIED_DEVICE_ID = :DEVICE
               WHERE ST_PROD_ID = :WK_ISSN_SSN
               AND ST_ACTION <> 'IR' ;
               WK_ISSN_VARIANCE = 0 - WK_ISSN_QTY;
               SELECT NEW_RECORD_ID FROM ADD_UPDATE_STOCKTAKE (
                  0, NULL, :WK_WH_ID, :WK_LOCN_ID, 0, :WK_ISSN_VARIANCE , :TRN_DATE, :WK_USER, :DEVICE, 'MI', 'RC', NULL, NULL, NULL,:WK_ISSN_COMPANY_ID )
               INTO :WK_NEW_RECORD_ID;
               UPDATE STOCKTAKE SET ST_PROD_ID = :WK_ISSN_SSN WHERE RECORD_ID = :WK_NEW_RECORD_ID;
            END
         END
      END
      ELSE
      BEGIN
         /* Update transactions table */
         EXECUTE PROCEDURE UPDATE_TRAN (:RECORD_ID, 'F', 'Cannot Close Stocktake - Not being Stocktaked');
         WK_UPDATED = 'T';
      END
   END
   IF (WK_UPDATED = 'F') THEN
   BEGIN
      EXECUTE PROCEDURE UPDATE_TRAN (:RECORD_ID, 'F', 'Nothing Closed');
   END
END ^

ALTER PROCEDURE PC_STOB (RECORD_ID INTEGER,
WH_ID CHAR(2) CHARACTER SET NONE,
LOCN_ID VARCHAR(10) CHARACTER SET NONE,
OBJECT VARCHAR(30) CHARACTER SET NONE,
TRN_TYPE VARCHAR(4) CHARACTER SET NONE,
TRN_CODE CHAR(1) CHARACTER SET NONE,
TRN_DATE TIMESTAMP,
REFERENCE VARCHAR(40) CHARACTER SET NONE,
QTY INTEGER,
PERSON_ID VARCHAR(10) CHARACTER SET NONE,
DEVICE_ID CHAR(2) CHARACTER SET NONE,
INSTANCE_ID VARCHAR(10) CHARACTER SET NONE)
AS 
DECLARE VARIABLE strWH_ID CHAR(2);
  DECLARE VARIABLE strINSTANCE VARCHAR(10); 
  DECLARE VARIABLE strSSN VARCHAR(20);  
  DECLARE VARIABLE strLOCN_ID VARCHAR(10);  
  DECLARE VARIABLE strAUDIT_DESC VARCHAR(40); 
  DECLARE VARIABLE REC_ID INTEGER;    
  DECLARE VARIABLE LOCN_NAME VARCHAR(50); 
  DECLARE VARIABLE strLOCN_exists INTEGER;  
  DECLARE VARIABLE Currentqty INTEGER;  
  DECLARE VARIABLE strUOM CHAR(2); 
  DECLARE VARIABLE WK_PROD VARCHAR(30); 
  DECLARE VARIABLE WK_REFERENCE VARCHAR(40); 
  DECLARE VARIABLE WK_COMPANY VARCHAR(20); 
  DECLARE VARIABLE WK_LAST_PROD VARCHAR(30); 
  DECLARE VARIABLE WK_SUB_LOCN VARCHAR(10); 
  DECLARE VARIABLE WK_NEW_COMPANY VARCHAR(20); 
  DECLARE VARIABLE WK_PROD_SSN_TYPE VARCHAR(40); 
  DECLARE VARIABLE WK_NEW_PROD VARCHAR(30); 
  
BEGIN
    strWH_ID = '';
    strINSTANCE = '';
    strSSN = '';
    strWH_ID = '';
    strLOCN_ID = '';   
    strAUDIT_DESC = '';  
    strUOM = '';
    WK_PROD = '';
    WK_SUB_LOCN = '';
    WK_REFERENCE = vrtrim(REFERENCE);

    strUOM = lefts(:WK_REFERENCE,2);
    IF (len(:WK_REFERENCE) > 2) THEN
    BEGIN
       EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_REFERENCE, 2  RETURNING_VALUES :WK_PROD ; 
    END

    /* added 06/08/07 for owner */
    SELECT SUB_LOCN_ID 
    FROM TRANSACTIONS 
    WHERE RECORD_ID = :RECORD_ID
    INTO :WK_SUB_LOCN;
   
    IF (WK_SUB_LOCN IS NULL) THEN
    BEGIN
         WK_SUB_LOCN = '';
    END
    WK_NEW_COMPANY = vrtrim(WK_SUB_LOCN); 

    /* Check trasaction code */
    IF (:TRN_CODE = 'A') THEN
    BEGIN

       strLOCN_exists = 0;
       SELECT 1 FROM LOCATION 
       WHERE WH_ID = :WH_ID AND LOCN_ID = :LOCN_ID 
       INTO :strLOCN_exists;
       IF (strLOCN_exists = 0) THEN /* Location not found */
       BEGIN
           LOCN_NAME = LOCN_ID || :TRN_DATE;
           /* Add new Location record */
           INSERT INTO LOCATION (LOCN_ID, WH_ID, LOCN_NAME , LAST_UPDATE_DATE, LAST_UPDATE_BY )
           VALUES (:LOCN_ID, :WH_ID, :LOCN_NAME, :TRN_DATE, :PERSON_ID);
       END
   
       /* Check if warehouse exists */
       SELECT WH_ID, INSTANCE_ID 
       FROM WAREHOUSE
       WHERE WH_ID = :WH_ID
       INTO :strWH_ID, :strINSTANCE;
   
       /* Check warehouse*/
       IF (strWH_ID <> '') THEN
       BEGIN
             /* Check instance */
             /* IF (strINSTANCE = :INSTANCE_ID) THEN */  
             BEGIN
                WK_COMPANY = '';
                WK_COMPANY = WK_NEW_COMPANY;

                   /* Check ObjectLocation */
     /* please check issn first */
     /* since it may not be in ssn table then update
     original_ssn */
                   SELECT SD.ORIGINAL_SSN, SD.WH_ID, SD.LOCN_ID, SD.CURRENT_QTY
                   FROM ISSN SD JOIN SSN SN ON SN.SSN_ID = SD.ORIGINAL_SSN
                   WHERE SD.SSN_ID = :OBJECT
                   INTO :strSSN, :strWH_ID, :strLOCN_ID, :Currentqty ;
                   
                   /* Check SSN */
                   IF (strSSN = '') THEN
                   BEGIN
                   /* Object not found */
                          /* Add SSN */
                           /* DATE: 11TH NOV 07 - SUMEER SHOREE, MODIFIED INSERTS TO INCLUDE CREATE DATE, INTO_DATE(ONLY ISSN), LABEL_DATE(THOUGH NOT SURE - WHETHER LABEL_DATE SHOULD BE UPDATED NOW), CREATED_BY (SSN), USER_ID (ISSN) */
                          SELECT SSN_TYPE 
                          FROM PROD_PROFILE
                          WHERE PROD_ID = :WK_PROD
                          INTO  :WK_PROD_SSN_TYPE;

                          INSERT INTO SSN (SSN_ID, WH_ID, LOCN_ID, INTO_DATE, AUDITED, AUDIT_DATE, AUDITED_QTY, STATUS_SSN, CURRENT_QTY, STORAGE_UOM,ORIGINAL_QTY,COMPANY_ID, CREATE_DATE, CREATED_BY, LABEL_DATE, LAST_UPDATE_DATE, LAST_UPDATE_BY, SSN_TYPE )
                          VALUES (:OBJECT, :WH_ID, :LOCN_ID, :TRN_DATE, 'N', :TRN_DATE, :QTY, 'ST', :QTY, :strUOM, :QTY, :WK_COMPANY, :TRN_DATE, :PERSON_ID, :TRN_DATE, :TRN_DATE, :PERSON_ID, :WK_PROD_SSN_TYPE  );
                          INSERT INTO ISSN (SSN_ID, ORIGINAL_SSN, WH_ID, LOCN_ID, CURRENT_QTY, ISSN_STATUS,AUDITED,ORIGINAL_QTY,COMPANY_ID,AUDIT_DATE, USER_ID, CREATE_DATE, INTO_DATE, LABEL_DATE, LAST_UPDATE_DATE )
                          VALUES (:OBJECT, :OBJECT, :WH_ID, :LOCN_ID, :QTY, 'ST', 'N', :QTY, :WK_COMPANY, :TRN_DATE, :PERSON_ID, :TRN_DATE, :TRN_DATE, :TRN_DATE, :TRN_DATE );
                          IF (WK_PROD > '') THEN
                          BEGIN
                             IF (WK_NEW_COMPANY = '') THEN
                             BEGIN
                                SELECT COMPANY_ID, SSN_TYPE 
                                FROM PROD_PROFILE
                                WHERE PROD_ID = :WK_PROD
                                INTO :WK_COMPANY, :WK_PROD_SSN_TYPE;
                                IF (WK_PROD_SSN_TYPE IS NULL) THEN
                                BEGIN
                                   SELECT SSN_TYPE
                                   FROM SSN
                                   WHERE SSN_ID = :OBJECT
                                   INTO :WK_PROD_SSN_TYPE;
                                END
                                UPDATE SSN SET PROD_ID = :WK_PROD,
                                   COMPANY_ID = :WK_COMPANY,
                                   SSN_TYPE   = :WK_PROD_SSN_TYPE,
                                   LAST_UPDATE_DATE =  :TRN_DATE, 
                                   LAST_UPDATE_BY  = :PERSON_ID
                                WHERE SSN_ID = :OBJECT;
                                UPDATE ISSN SET PROD_ID = :WK_PROD,
                                   COMPANY_ID = :WK_COMPANY,
                                   PROD_ID_UPDATE = :TRN_DATE,
                                   LAST_UPDATE_DATE =  :TRN_DATE 
                                WHERE SSN_ID = :OBJECT;
                             END
                             ELSE
                             BEGIN
                                SELECT COMPANY_ID, SSN_TYPE 
                                FROM PROD_PROFILE
                                WHERE PROD_ID = :WK_PROD
                                INTO :WK_COMPANY, :WK_PROD_SSN_TYPE;
                                IF (WK_PROD_SSN_TYPE IS NULL) THEN
                                BEGIN
                                   SELECT SSN_TYPE
                                   FROM SSN
                                   WHERE SSN_ID = :OBJECT
                                   INTO :WK_PROD_SSN_TYPE;
                                END
                                UPDATE SSN SET PROD_ID = :WK_PROD,
                                   SSN_TYPE   = :WK_PROD_SSN_TYPE,
                                   LAST_UPDATE_DATE =  :TRN_DATE, 
                                   LAST_UPDATE_BY  = :PERSON_ID
                                WHERE SSN_ID = :OBJECT;
                                UPDATE ISSN SET PROD_ID = :WK_PROD,
                                   PROD_ID_UPDATE = :TRN_DATE,
                                   LAST_UPDATE_DATE =  :TRN_DATE 
                                WHERE SSN_ID = :OBJECT;
                             END
                          END
                          strAUDIT_DESC = 'New object record created during audit';
                          strSSN = OBJECT;
                   END
                   ELSE
                   BEGIN
                         IF (WK_PROD > '') THEN
                         BEGIN
                            IF (OBJECT = strSSN) THEN
                            BEGIN
                               IF (WK_NEW_COMPANY = '') THEN
                               BEGIN
                                  SELECT COMPANY_ID, SSN_TYPE 
                                  FROM PROD_PROFILE
                                  WHERE PROD_ID = :WK_PROD
                                  INTO :WK_COMPANY, :WK_PROD_SSN_TYPE;
                                  IF (WK_PROD_SSN_TYPE IS NULL) THEN
                                  BEGIN
                                     SELECT SSN_TYPE
                                     FROM SSN
                                     WHERE SSN_ID = :OBJECT
                                     INTO :WK_PROD_SSN_TYPE;
                                  END
                               END
                               ELSE
                               BEGIN
                                  SELECT SSN_TYPE 
                                  FROM PROD_PROFILE
                                  WHERE PROD_ID = :WK_PROD
                                  INTO :WK_PROD_SSN_TYPE;
                                  IF (WK_PROD_SSN_TYPE IS NULL) THEN
                                  BEGIN
                                     SELECT SSN_TYPE
                                     FROM SSN
                                     WHERE SSN_ID = :OBJECT
                                     INTO :WK_PROD_SSN_TYPE;
                                  END
                               END
                               UPDATE SSN SET PROD_ID = :WK_PROD,
                                  COMPANY_ID = :WK_COMPANY,
                                  SSN_TYPE   = :WK_PROD_SSN_TYPE,
                                  LAST_UPDATE_DATE =  :TRN_DATE, 
                                  LAST_UPDATE_BY  = :PERSON_ID
                               WHERE SSN_ID = :OBJECT;
                            END
                            ELSE
                            BEGIN
                               IF (WK_NEW_COMPANY = '') THEN
                               BEGIN
                                  SELECT COMPANY_ID 
                                  FROM PROD_PROFILE
                                  WHERE PROD_ID = :WK_PROD
                                  INTO :WK_COMPANY;
                               END
                            END
                            WK_LAST_PROD = '';
                            SELECT PROD_ID
                            FROM ISSN
                            WHERE SSN_ID = :OBJECT
                            INTO :WK_LAST_PROD;
                            IF (WK_LAST_PROD IS NULL) THEN
                            BEGIN
                               WK_LAST_PROD = '';
                            END
                            IF (WK_LAST_PROD <> WK_PROD) THEN
                            BEGIN
                               UPDATE ISSN SET 
                                   PREV_PREV_PROD_ID_UPDATE = PREV_PROD_ID_UPDATE,
                                   PREV_PROD_ID_UPDATE = PROD_ID_UPDATE,
                                   PROD_ID_UPDATE = :TRN_DATE,
                                   PREV_PREV_PROD_ID = PREV_PROD_ID,
                                   PREV_PROD_ID = PROD_ID,
                                   PROD_ID = :WK_PROD,
                                   COMPANY_ID = :WK_COMPANY,
                                   LAST_UPDATE_DATE =  :TRN_DATE 
                               WHERE SSN_ID = :OBJECT;
                            END
                            ELSE
                            BEGIN
                               UPDATE ISSN SET PROD_ID = :WK_PROD,
                                   COMPANY_ID = :WK_COMPANY,
                                   LAST_UPDATE_DATE =  :TRN_DATE 
                               WHERE SSN_ID = :OBJECT;
                            END
                         END
                         IF ((strWH_ID <> :WH_ID) OR (strLOCN_ID <> :LOCN_ID)) THEN
                         BEGIN          
                               /* item found in different location, update object relocated */
                               IF (Currentqty = QTY) THEN
                               BEGIN
                                     UPDATE ISSN
                                     SET PREV_PREV_WH_ID = PREV_WH_ID, 
                                         PREV_PREV_LOCN_ID = PREV_LOCN_ID,
                                         PREV_WH_ID = WH_ID,
                                         PREV_LOCN_ID = LOCN_ID,
                                         WH_ID = :WH_ID, 
                                         LOCN_ID = :LOCN_ID, 
                                         INTO_DATE = :TRN_DATE,
                                         AUDIT_DATE = :TRN_DATE,
                                         AUDITED = 'C',
                                         LAST_UPDATE_DATE =  :TRN_DATE 
                                     WHERE SSN_ID = :OBJECT;
                                     IF (OBJECT = strSSN) THEN
                                     BEGIN
                                           UPDATE SSN
                                           SET WH_ID = :WH_ID, LOCN_ID = :LOCN_ID, INTO_DATE = :TRN_DATE,
                                               AUDITED = 'C', AUDIT_DATE = :TRN_DATE, AUDITED_QTY = :QTY, STORAGE_UOM = :strUOM,
                                               LAST_UPDATE_DATE =  :TRN_DATE, 
                                               LAST_UPDATE_BY  = :PERSON_ID
                                           WHERE SSN_ID = :strSSN;
                                     END
                                     ELSE
                                     BEGIN
                                           UPDATE SSN
                                           SET STORAGE_UOM = :strUOM,
                                               LAST_UPDATE_DATE =  :TRN_DATE, 
                                               LAST_UPDATE_BY  = :PERSON_ID
                                           WHERE SSN_ID = :strSSN;
                                     END

                               
                                     strAUDIT_DESC = 'Item found in different location';  
                               END
                               ELSE
                               BEGIN
                                     UPDATE ISSN
                                     SET PREV_PREV_WH_ID = PREV_WH_ID, 
                                         PREV_PREV_LOCN_ID = PREV_LOCN_ID,
                                         PREV_WH_ID = WH_ID,
                                         PREV_LOCN_ID = LOCN_ID,
                                         WH_ID = :WH_ID, 
                                         LOCN_ID = :LOCN_ID, 
                                         INTO_DATE = :TRN_DATE,
                                         AUDIT_DATE = :TRN_DATE,
                                         AUDITED = 'R',
                                         LAST_UPDATE_DATE =  :TRN_DATE 
                                     WHERE SSN_ID = :OBJECT;
                                     IF (OBJECT = strSSN) THEN
                                     BEGIN
                                           UPDATE SSN
                                           SET WH_ID = :WH_ID, LOCN_ID = :LOCN_ID, INTO_DATE = :TRN_DATE, AUDITED = 'R', STORAGE_UOM = :strUOM,
                                               LAST_UPDATE_DATE =  :TRN_DATE, 
                                               LAST_UPDATE_BY  = :PERSON_ID
                                           WHERE SSN_ID = :strSSN;
                                     END
                                     ELSE
                                     BEGIN
                                           UPDATE SSN
                                           SET STORAGE_UOM = :strUOM,
                                               LAST_UPDATE_DATE =  :TRN_DATE, 
                                               LAST_UPDATE_BY  = :PERSON_ID
                                           WHERE SSN_ID = :strSSN;
                                     END
                                     strAUDIT_DESC = 'Recount Required';
                               END
                         END
                         ELSE
                         BEGIN                           
                               /* object found in expected location, upload object found */
                               IF (Currentqty = QTY) THEN
                               BEGIN
                                     IF (OBJECT = strSSN) THEN
                                     BEGIN
                                           UPDATE ISSN
                                           SET INTO_DATE = :TRN_DATE, AUDITED = 'F', AUDIT_DATE = :TRN_DATE, 
                                               LAST_UPDATE_DATE =  :TRN_DATE 
                                           WHERE SSN_ID = :OBJECT;
                                           UPDATE SSN
                                           SET INTO_DATE = :TRN_DATE, AUDITED = 'F',  
                                               AUDIT_DATE = :TRN_DATE, AUDITED_QTY = :QTY, STORAGE_UOM = :strUOM,
                                               LAST_UPDATE_DATE =  :TRN_DATE, 
                                               LAST_UPDATE_BY  = :PERSON_ID
                                           WHERE SSN_ID = :strSSN;
                                     END
                                     ELSE
                                     BEGIN
                                           UPDATE ISSN
                                           SET INTO_DATE = :TRN_DATE, AUDITED = 'F', AUDIT_DATE = :TRN_DATE, 
                                               LAST_UPDATE_DATE =  :TRN_DATE 
                                           WHERE SSN_ID = :OBJECT;
                                           UPDATE SSN
                                           SET STORAGE_UOM = :strUOM, 
                                               LAST_UPDATE_DATE =  :TRN_DATE, 
                                               LAST_UPDATE_BY  = :PERSON_ID
                                           WHERE SSN_ID = :strSSN;
                                     END

                                     strAUDIT_DESC = 'Item found in correct location';
                               END
                               ELSE
                               BEGIN
                                     IF (OBJECT = strSSN) THEN
                                     BEGIN
                                           UPDATE ISSN
                                           SET AUDITED = 'R',  
                                               LAST_UPDATE_DATE =  :TRN_DATE 
                                           WHERE SSN_ID = :OBJECT;
                                           UPDATE SSN
                                           SET AUDITED = 'R', STORAGE_UOM = :strUOM, 
                                               LAST_UPDATE_DATE =  :TRN_DATE, 
                                               LAST_UPDATE_BY  = :PERSON_ID
                                           WHERE SSN_ID = :strSSN;
                                     END
                                     ELSE
                                     BEGIN
                                           UPDATE ISSN
                                           SET AUDITED = 'R',  
                                               LAST_UPDATE_DATE =  :TRN_DATE 
                                           WHERE SSN_ID = :OBJECT;
                                           UPDATE SSN
                                           SET STORAGE_UOM = :strUOM, 
                                               LAST_UPDATE_DATE =  :TRN_DATE, 
                                               LAST_UPDATE_BY  = :PERSON_ID
                                           WHERE SSN_ID = :strSSN;
                                     END
                                     strAUDIT_DESC = 'Recount Required';
                               END
                         END
                   END
   
                  /* Update transactions table */               
                  EXECUTE PROCEDURE UPDATE_TRAN (:RECORD_ID, 'T', 'Processed successfully'); 
                  
                  /* Add transaction history */                                                                                     
                  EXECUTE PROCEDURE ADD_SSN_HIST(:WH_ID, :LOCN_ID, :strSSN, :TRN_TYPE, :TRN_CODE, :TRN_DATE,
                                                 :strAUDIT_DESC, :REFERENCE, :QTY,  :PERSON_ID, :DEVICE_ID);
             END
       END
    END
    ELSE
    BEGIN
       /* Update transactions table */               
       EXECUTE PROCEDURE UPDATE_TRAN (:RECORD_ID, 'F', 'Invalid class code');
       EXIT;
    END 
END ^

ALTER PROCEDURE PC_STRC (RECORD_ID INTEGER,
WH_ID CHAR(2) CHARACTER SET NONE,
LOCN_ID VARCHAR(10) CHARACTER SET NONE,
OBJECT VARCHAR(30) CHARACTER SET NONE,
TRN_TYPE VARCHAR(4) CHARACTER SET NONE,
TRN_CODE CHAR(1) CHARACTER SET NONE,
TRN_DATE TIMESTAMP,
REFERENCE VARCHAR(40) CHARACTER SET NONE,
QTY INTEGER,
PERSON_ID VARCHAR(10) CHARACTER SET NONE,
DEVICE_ID CHAR(2) CHARACTER SET NONE,
INSTANCE_ID VARCHAR(10) CHARACTER SET NONE)
AS 
DECLARE VARIABLE strWH_ID CHAR(2); 
  DECLARE VARIABLE strINSTANCE VARCHAR(10); 
  DECLARE VARIABLE strSSN VARCHAR(20);  
  DECLARE VARIABLE strLOCN_ID VARCHAR(10);  
  DECLARE VARIABLE strAUDIT_DESC VARCHAR(40); 
  DECLARE VARIABLE REC_ID INTEGER;    
  DECLARE VARIABLE LOCN_NAME VARCHAR(50); 
  DECLARE VARIABLE strLOCN_exists INTEGER;  
  DECLARE VARIABLE Currentqty INTEGER;  
  DECLARE VARIABLE strUOM CHAR(2); 
  DECLARE VARIABLE diff_qty INTEGER;  
  
BEGIN
    strWH_ID = "";
    strINSTANCE = "";
    strSSN = "";
    strWH_ID = "";
    strLOCN_ID = "";   
    strAUDIT_DESC = "";  
    strUOM = "";

    strUOM = lefts(alltrim(REFERENCE),2);
    /* Check trasaction code */
    IF (:TRN_CODE = 'A') THEN
    BEGIN

       strLOCN_exists = 0;
       SELECT 1 FROM LOCATION 
       WHERE WH_ID = :WH_ID AND LOCN_ID = :LOCN_ID 
       INTO :strLOCN_exists;
       IF (strLOCN_exists = 0) THEN /* Location not found */
       BEGIN
           LOCN_NAME = LOCN_ID || :TRN_DATE;
           /* Add new Location record */
           INSERT INTO LOCATION (LOCN_ID, WH_ID, LOCN_NAME , LAST_UPDATE_DATE, LAST_UPDATE_BY )
           VALUES (:LOCN_ID, :WH_ID, :LOCN_NAME, :TRN_DATE, :PERSON_ID);
       END
   
       /* Check if warehouse exists */
       SELECT WH_ID, INSTANCE_ID 
       FROM WAREHOUSE
       WHERE WH_ID = :WH_ID
       INTO :strWH_ID, :strINSTANCE;
   
       /* Check warehouse*/
       IF (strWH_ID <> '') THEN
       BEGIN
             /* Check instance */
             /* IF (strINSTANCE = :INSTANCE_ID) THEN  */ 
             BEGIN
                   /* Check ObjectLocation */
     /* please check issn first */
     /* since it may not be in ssn table then update
     original_ssn */
                   SELECT SD.ORIGINAL_SSN, SD.WH_ID, SD.LOCN_ID, SD.CURRENT_QTY
                   FROM ISSN SD JOIN SSN SN ON SN.SSN_ID = SD.ORIGINAL_SSN
                   WHERE SD.SSN_ID = :OBJECT
                   INTO :strSSN, :strWH_ID, :strLOCN_ID, :Currentqty ;
                   
                   /* Check SSN */
                   IF (strSSN = "") THEN
                   BEGIN
                   /* Object not found */
                          /* Add SSN */
                          INSERT INTO SSN (SSN_ID, WH_ID, LOCN_ID, INTO_DATE, AUDITED, AUDIT_DATE, AUDITED_QTY, STATUS_SSN, CURRENT_QTY, STORAGE_UOM, LAST_UPDATE_DATE, LAST_UPDATE_BY )
                          VALUES (:OBJECT, :WH_ID, :LOCN_ID, :TRN_DATE, 'N', :TRN_DATE, :QTY, 'ST', :QTY, :strUOM, :TRN_DATE, :PERSON_ID );
                          INSERT INTO ISSN (SSN_ID, ORIGINAL_SSN, WH_ID, LOCN_ID, CURRENT_QTY, ISSN_STATUS, AUDITED, AUDIT_DATE, LAST_UPDATE_DATE )
                          VALUES (:OBJECT, :OBJECT, :WH_ID, :LOCN_ID, :QTY, 'ST', 'N', :TRN_DATE , :TRN_DATE);
                          strAUDIT_DESC = "New object record created during audit";
                          strSSN = OBJECT;
                   END
                   ELSE
                   BEGIN
                         diff_qty = QTY - Currentqty;
                         IF ((strWH_ID <> :WH_ID) OR (strLOCN_ID <> :LOCN_ID)) THEN
                         BEGIN          
                               /* item found in different location, update object relocated */
                               UPDATE ISSN
                               SET PREV_PREV_WH_ID = PREV_WH_ID, 
                                   PREV_PREV_LOCN_ID = PREV_LOCN_ID,
                                   PREV_WH_ID = WH_ID,
                                   PREV_LOCN_ID = LOCN_ID,
                                   WH_ID = :WH_ID, 
                                   LOCN_ID = :LOCN_ID, 
                                   INTO_DATE = :TRN_DATE,
                                   AUDIT_DATE = :TRN_DATE,
                                   CURRENT_QTY = :QTY,
                                   AUDITED = 'C',
                                   LAST_UPDATE_DATE =  :TRN_DATE 
                               WHERE SSN_ID = :OBJECT;
                               IF (OBJECT = strSSN) THEN
                               BEGIN
                                     UPDATE SSN
                                     SET WH_ID = :WH_ID, LOCN_ID = :LOCN_ID, INTO_DATE = :TRN_DATE,
                                         AUDITED = 'C', AUDIT_DATE = :TRN_DATE, AUDITED_QTY = :QTY, CURRENT_QTY = CURRENT_QTY + :diff_qty , STORAGE_UOM = :strUOM,
                                         LAST_UPDATE_DATE =  :TRN_DATE, 
                                         LAST_UPDATE_BY  = :PERSON_ID
                                     WHERE SSN_ID = :strSSN;
                               END
                               ELSE
                               BEGIN
                                     UPDATE SSN
                                     SET CURRENT_QTY = CURRENT_QTY + :diff_qty , STORAGE_UOM = :strUOM,
                                         LAST_UPDATE_DATE =  :TRN_DATE, 
                                         LAST_UPDATE_BY  = :PERSON_ID
                                     WHERE SSN_ID = :strSSN;
                               END
                               
                               strAUDIT_DESC = "Item found in different location";  
                         END
                         ELSE
                         BEGIN                           
                               /* object found in expected location, upload object found */
                               UPDATE ISSN
                               SET INTO_DATE = :TRN_DATE,
                                   AUDIT_DATE = :TRN_DATE,
                                   CURRENT_QTY = :QTY,
                                   AUDITED = 'F',
                                   LAST_UPDATE_DATE =  :TRN_DATE 
                               WHERE SSN_ID = :OBJECT;
                               IF (OBJECT = strSSN) THEN
                               BEGIN
                                     UPDATE SSN
                                     SET INTO_DATE = :TRN_DATE, AUDITED = 'F',  
                                         AUDIT_DATE = :TRN_DATE, AUDITED_QTY = :QTY, STORAGE_UOM = :strUOM, CURRENT_QTY = CURRENT_QTY + :diff_qty ,
                                         LAST_UPDATE_DATE =  :TRN_DATE, 
                                         LAST_UPDATE_BY  = :PERSON_ID
                                     WHERE SSN_ID = :strSSN;
                               END
                               ELSE
                               BEGIN
                                     UPDATE SSN
                                     SET STORAGE_UOM = :strUOM, CURRENT_QTY = CURRENT_QTY + :diff_qty,
                                         LAST_UPDATE_DATE =  :TRN_DATE, 
                                         LAST_UPDATE_BY  = :PERSON_ID
                                     WHERE SSN_ID = :strSSN;
                               END
   
                               strAUDIT_DESC = "Item found in correct location";
                         END
                   END
   
                  /* Update transactions table */               
                  EXECUTE PROCEDURE UPDATE_TRAN (:RECORD_ID, 'T', 'Processed successfully'); 
                  
                  /* Add transaction history */                                                                                     
                  EXECUTE PROCEDURE ADD_SSN_HIST(:WH_ID, :LOCN_ID, :strSSN, :TRN_TYPE, :TRN_CODE, :TRN_DATE,
                                                 :strAUDIT_DESC, :REFERENCE, :QTY,  :PERSON_ID, :DEVICE_ID);
             END
       END
    END
    ELSE
    BEGIN
       /* Update transactions table */               
       EXECUTE PROCEDURE UPDATE_TRAN (:RECORD_ID, 'F', 'Invalid class code');
       EXIT;
    END 
END ^

ALTER PROCEDURE PC_STUA (RECORD_ID INTEGER,
WH_ID CHAR(2) CHARACTER SET NONE,
LOCN_ID VARCHAR(10) CHARACTER SET NONE,
OBJECT VARCHAR(30) CHARACTER SET NONE,
TRN_TYPE VARCHAR(4) CHARACTER SET NONE,
TRN_CODE CHAR(1) CHARACTER SET NONE,
TRN_DATE TIMESTAMP,
REFERENCE VARCHAR(40) CHARACTER SET NONE,
QTY INTEGER,
SUB_LOCN_ID VARCHAR(10) CHARACTER SET NONE)
AS 
DECLARE VARIABLE WK_STOCK_RECORD VARCHAR(40);
  DECLARE VARIABLE WK_STOCK_RECORD_ID INTEGER;
  DECLARE VARIABLE WK_STOCK_ACTION VARCHAR(40);

BEGIN

   /* get the passed record id */
   WK_STOCK_RECORD = REFERENCE ; 
   WK_STOCK_ACTION = SUB_LOCN_ID ; 
   WK_STOCK_RECORD_ID = WK_STOCK_RECORD;
   IF (STRLEN(WK_STOCK_ACTION) > 2) THEN
   BEGIN
      WK_STOCK_ACTION = SUBSTR(WK_STOCK_ACTION,1,2);
   END

   IF (TRN_CODE NOT IN ( 'A' )) THEN
   BEGIN
        UPDATE TRANSACTIONS
        SET COMPLETE = 'F', ERROR_TEXT = 'TRN_CODE HAS TO BE A'
        WHERE RECORD_ID = :RECORD_ID;
        EXIT;
   END
   
   UPDATE STOCKTAKE SET ST_ACTION = :WK_STOCK_ACTION
   WHERE RECORD_ID = :WK_STOCK_RECORD_ID;

   EXECUTE PROCEDURE UPDATE_TRAN (RECORD_ID, 'T','Processed successfully');

END ^

ALTER PROCEDURE PC_TRIS (RECORD_ID INTEGER,
WH_ID CHAR(2) CHARACTER SET NONE,
LOCN_ID VARCHAR(10) CHARACTER SET NONE,
OBJECT VARCHAR(30) CHARACTER SET NONE,
TRN_TYPE VARCHAR(4) CHARACTER SET NONE,
TRN_CODE CHAR(1) CHARACTER SET NONE,
TRN_DATE TIMESTAMP,
REFERENCE VARCHAR(40) CHARACTER SET NONE,
QTY INTEGER,
SUB_LOCN_ID VARCHAR(10) CHARACTER SET NONE,
PERSON_ID VARCHAR(10) CHARACTER SET NONE,
DEVICE_ID CHAR(2) CHARACTER SET NONE)
AS 
 
 
 
      
DECLARE VARIABLE SSN_EXIST INTEGER;
DECLARE VARIABLE strWH_ID CHAR(2);
DECLARE VARIABLE strLOCN_ID VARCHAR(10);
DECLARE VARIABLE str_SSN VARCHAR(30);
DECLARE VARIABLE strAUDIT_DESC VARCHAR(70);
DECLARE VARIABLE iCURRENT_QTY INTEGER;
DECLARE VARIABLE iSUB_QTY INTEGER;
DECLARE VARIABLE iQTY INTEGER;
DECLARE VARIABLE LAST_DATE TIMESTAMP;
DECLARE VARIABLE strPROD VARCHAR(30);
DECLARE VARIABLE iSSN_LENGTH INTEGER;
DECLARE VARIABLE iSSN_ID INTEGER;
DECLARE VARIABLE I_SSN_ID VARCHAR(20);
DECLARE VARIABLE I_LEN_SSN_ID INTEGER;
DECLARE VARIABLE LEN_SSN_ID INTEGER;
DECLARE VARIABLE P_SSN_ID INTEGER;
DECLARE VARIABLE strSTATUS CHAR(2);
DECLARE VARIABLE WK_COMPANY VARCHAR(20);
       
BEGIN
  
   strAUDIT_DESC = ''; 
    
   strWH_ID = substr(SUB_LOCN_ID,1,2);
   strLOCN_ID = substr(SUB_LOCN_ID,3,10);

   /* Get length for Barcode */   
   EXECUTE PROCEDURE GET_BARCODE_LENGTH RETURNING_VALUES :iSSN_LENGTH;
   SELECT NEW_SSN_STATUS
   FROM CONTROL
   INTO :strSTATUS;
    
   IF (:TRN_CODE = 'A') THEN
   BEGIN
      SSN_EXIST = 0;
      iCURRENT_QTY = -1; 
      iSUB_QTY = :QTY;

           /* Check SSN */
      SELECT 1, CURRENT_QTY 
      FROM SSN
      WHERE SSN_ID = :OBJECT
      INTO :SSN_EXIST, :iCURRENT_QTY ;
      SELECT PROD_ID
      FROM ISSN
      WHERE SSN_ID = :OBJECT
      INTO :strPROD;
                
           /* SSN not exists, then exit */
      IF (SSN_EXIST = 0) THEN
      BEGIN 
             /* Update transactions table */        
        EXECUTE PROCEDURE UPDATE_TRAN (:RECORD_ID, 'F', 'SSN is not in the database');
        EXIT;
      END 
      /* Update SSN */ 
       WK_COMPANY = '';
       FOR SELECT SSN_ID, INTO_DATE, CURRENT_QTY, COMPANY_ID 
          FROM ISSN 
          WHERE ORIGINAL_SSN = :OBJECT
            AND WH_ID = :strWH_ID
            AND LOCN_ID = :strLOCN_ID
          AND SSN_ID <> ORIGINAL_SSN
          INTO :str_SSN, :last_date, :iQTY, :WK_COMPANY
       DO
       BEGIN
          IF (ISUB_QTY > 0) THEN
          BEGIN
             IF (LAST_DATE IS NULL) THEN
             BEGIN
                last_date = CAST('JAN-01-2000' AS DATE);
             END
             IF (LAST_DATE < TRN_DATE) THEN
             BEGIN
                UPDATE ISSN
                SET PREV_PREV_LOCN_ID = PREV_LOCN_ID, PREV_PREV_WH_ID = PREV_WH_ID, 
                    PREV_LOCN_ID = LOCN_ID, PREV_WH_ID = WH_ID, 
                    LOCN_ID = :LOCN_ID, WH_ID = :WH_ID,
                    PREV_DATE = :TRN_DATE
                WHERE SSN_ID = :str_SSN;
                iSUB_QTY = iSUB_QTY - iQTY;
                IF (str_SSN = OBJECT) THEN
                BEGIN
                   UPDATE SSN
                   SET PREV_LOCN_ID = :strLOCN_ID, LOCN_ID = :LOCN_ID, WH_ID = :WH_ID,
                       DT_PREV_INTO = :TRN_DATE
                   WHERE SSN_ID = :OBJECT;
                END
             END
             ELSE
             BEGIN
                EXECUTE PROCEDURE ADD_SSN_HIST(:WH_ID, :LOCN_ID, :OBJECT, '', '', :TRN_DATE,
                'No Update Prior to INTO Date', '', :QTY,  '', :DEVICE_ID);
             END
          END /* sub qty */
       END /* for */
       IF (iSUB_QTY > 0) THEN
       BEGIN
          /* havent found the required qty in the from location */
          /* so create stock until have the qty */
          IF (WK_COMPANY IS NULL) THEN
          BEGIN
             WK_COMPANY = '';
          END
          IF (WK_COMPANY = '') THEN
          BEGIN
             SELECT COMPANY_ID
             FROM PROD_PROFILE
             WHERE PROD_ID = :strPROD
             INTO :WK_COMPANY;             
             IF (WK_COMPANY IS NULL) THEN
             BEGIN
                WK_COMPANY = '';
             END
          END
          IF (WK_COMPANY = '') THEN
          BEGIN
             SELECT COMPANY_ID
             FROM CONTROL
             INTO :WK_COMPANY;             
             IF (WK_COMPANY IS NULL) THEN
             BEGIN
                WK_COMPANY = '';
             END
          END
          WHILE (iSUB_QTY > 0)
          DO
          BEGIN
             iSSN_ID = GEN_ID(ISSN_SSN_ID, 1);
             P_SSN_ID = iSSN_ID - 1;
             LEN_SSN_ID = STRLEN(P_SSN_ID);
             I_SSN_ID = '';
             I_LEN_SSN_ID = STRLEN(P_SSN_ID);
                 
             /* Padding leading with 0 */
             WHILE (I_LEN_SSN_ID < :iSSN_LENGTH) DO
             BEGIN
                I_SSN_ID = I_SSN_ID || '0';
                I_LEN_SSN_ID = I_LEN_SSN_ID + 1;
             END
             I_SSN_ID = I_SSN_ID || P_SSN_ID;

             INSERT INTO ISSN (SSN_ID ,
                    ORIGINAL_SSN ,
                    WH_ID ,
                    LOCN_ID ,
                    CURRENT_QTY ,
                    ISSN_STATUS ,
                    CREATE_DATE ,
                    USER_ID ,
                    PROD_ID ,
                    INTO_DATE,
                    COMPANY_ID) 
                    VALUES (:I_SSN_ID ,
                    :OBJECT,
                    :WH_ID,
                    :LOCN_ID,
                    1,
                    :strSTATUS ,
                    :TRN_DATE,
                    :PERSON_ID,
                    :strPROD ,
                    :TRN_DATE,
                    :WK_COMPANY);
             iSUB_QTY = iSUB_QTY - 1;
          END
          IF (iCURRENT_QTY IS NULL) THEN
          BEGIN
             UPDATE SSN SET CURRENT_QTY = 1 + :QTY
             WHERE SSN_ID = :OBJECT; 
          END
          ELSE
          BEGIN
             UPDATE SSN SET CURRENT_QTY = CURRENT_QTY + :QTY
             WHERE SSN_ID = :OBJECT; 
          END
       END

      strAUDIT_DESC = 'Transfered ' || :QTY || ' from ' || :SUB_LOCN_ID || ' into ' || :WH_ID || ' ' || :LOCN_ID; 

      /* Update transactions table */               
      EXECUTE PROCEDURE UPDATE_TRAN (:RECORD_ID, 'T', 'Processed successfully');

      /* Add transaction history */                                                                                     
      EXECUTE PROCEDURE ADD_SSN_HIST(:WH_ID, :LOCN_ID, :OBJECT, :TRN_TYPE, :TRN_CODE, :TRN_DATE,
                                     :strAUDIT_DESC, :REFERENCE, :QTY,  :PERSON_ID, :DEVICE_ID);
   END /* TRN_CODE = 'A' */
       
END ^

ALTER PROCEDURE PC_TRLO_TRLI (RECORD_ID INTEGER,
WH_ID CHAR(2) CHARACTER SET NONE,
LOCN_ID VARCHAR(10) CHARACTER SET NONE,
OBJECT VARCHAR(30) CHARACTER SET NONE,
TRN_TYPE VARCHAR(4) CHARACTER SET NONE,
TRN_CODE CHAR(1) CHARACTER SET NONE,
TRN_DATE TIMESTAMP,
REFERENCE VARCHAR(40) CHARACTER SET NONE,
QTY INTEGER,
PERSON_ID VARCHAR(10) CHARACTER SET NONE,
DEVICE_ID CHAR(2) CHARACTER SET NONE)
AS 
 
 
  DECLARE VARIABLE strWH_ID CHAR(2);
  DECLARE VARIABLE strLOCN_ID VARCHAR(10);
  DECLARE VARIABLE strAUDIT_DESC VARCHAR(70);
  DECLARE VARIABLE WK_SUB_LOCN VARCHAR(10);
  DECLARE VARIABLE WK_CURRENT_QTY INTEGER;
BEGIN
  strAUDIT_DESC = '';
  IF (:TRN_TYPE = 'TRLO') THEN
  BEGIN       
     strWH_ID = '';
     strLOCN_ID = '';
     /* Check transit location */
     SELECT LOCN_ID, WH_ID 
     FROM LOCATION
     WHERE LOCN_ID = :DEVICE_ID
     INTO :strLOCN_ID, :strWH_ID;
     IF (strLOCN_ID = '') THEN /* Transit Location not found */
     BEGIN
        /* Update transactions table */        
        EXECUTE PROCEDURE UPDATE_TRAN (RECORD_ID, 'F', 'Transit Location not found -TRLO');
        EXIT;
     END
     ELSE
     BEGIN                         
         /* for SSNs in location */
         FOR
           SELECT SSN_ID, CURRENT_QTY 
           FROM ISSN
           WHERE LOCN_ID = :LOCN_ID AND WH_ID = :WH_ID
           INTO :OBJECT, :WK_CURRENT_QTY
         DO
         BEGIN
           /* Update SSN */
           EXECUTE PROCEDURE UPDATE_SSN_TROL_A (OBJECT, strWH_ID, strLOCN_ID, TRN_DATE, DEVICE_ID);
           strAUDIT_DESC = 'Transfered all qty  ' || :QTY || ' into transit location';
           /* Add transaction history */                                                                                     
/*
           EXECUTE PROCEDURE ADD_SSN_HIST(WH_ID, LOCN_ID, OBJECT, TRN_TYPE, TRN_CODE, TRN_DATE,
                                          strAUDIT_DESC, REFERENCE, QTY,  PERSON_ID, DEVICE_ID);
*/
           EXECUTE PROCEDURE ADD_SSN_HIST(WH_ID, LOCN_ID, OBJECT, TRN_TYPE, TRN_CODE, TRN_DATE,
                                          strAUDIT_DESC, REFERENCE, :WK_CURRENT_QTY,  PERSON_ID, DEVICE_ID);
         END /* FOR ISSN */
         /* Update transactions table */               
         EXECUTE PROCEDURE UPDATE_TRAN (RECORD_ID, 'T', 'Processed successfully');
     END /* else */
  END /* TRN_TYPE = 'TRLO' */
  ELSE IF (:TRN_TYPE = 'TRLI') THEN
  BEGIN
     strWH_ID = '';
     strLOCN_ID = '';
     /* Check transit location */
     SELECT LOCN_ID, WH_ID 
     FROM LOCATION
     WHERE LOCN_ID = :DEVICE_ID
     INTO :strLOCN_ID, :strWH_ID;
     IF (strLOCN_ID = '') THEN /* Transit Location not found */
     BEGIN
        /* Update transactions table */        
        EXECUTE PROCEDURE UPDATE_TRAN (RECORD_ID, 'F', 'Transit Location not found TRLI');
        EXIT;
     END
     ELSE
     BEGIN                         
         SELECT SUB_LOCN_ID 
         FROM TRANSACTIONS 
         WHERE RECORD_ID = :RECORD_ID 
         INTO :WK_SUB_LOCN;
         /* for SSNs in location */
         FOR
           SELECT SSN_ID , CURRENT_QTY
           FROM ISSN
           WHERE LOCN_ID = :strLOCN_ID AND WH_ID = :strWH_ID
           INTO :OBJECT, :WK_CURRENT_QTY
         DO
         BEGIN
          /* Update SSN */
          EXECUTE PROCEDURE UPDATE_SSN_TRIL_A (OBJECT, WH_ID, LOCN_ID, TRN_DATE, QTY, TRN_CODE, WK_SUB_LOCN, DEVICE_ID, PERSON_ID);
          strAUDIT_DESC = 'Transfered all qty into location'; 
          /* Add transaction history */                                                                                     
/*
          EXECUTE PROCEDURE ADD_SSN_HIST(WH_ID, LOCN_ID, OBJECT, TRN_TYPE, TRN_CODE, TRN_DATE,
                                         strAUDIT_DESC, REFERENCE, QTY,  PERSON_ID, DEVICE_ID);
*/
          EXECUTE PROCEDURE ADD_SSN_HIST(WH_ID, LOCN_ID, OBJECT, TRN_TYPE, TRN_CODE, TRN_DATE,
                                         strAUDIT_DESC, REFERENCE, :WK_CURRENT_QTY,  PERSON_ID, DEVICE_ID);
         END /* for */
         /* Update transactions table */               
         EXECUTE PROCEDURE UPDATE_TRAN (RECORD_ID, 'T', 'Processed successfully');
     END /* else */
  END /* TRN_TYPE = 'TRLI' */
END ^

ALTER PROCEDURE PC_TRMI (RECORD_ID INTEGER,
WH_ID CHAR(2) CHARACTER SET NONE,
LOCN_ID VARCHAR(10) CHARACTER SET NONE,
SUBLOCN_ID VARCHAR(10) CHARACTER SET NONE,
OBJECT VARCHAR(30) CHARACTER SET NONE,
TRN_TYPE VARCHAR(4) CHARACTER SET NONE,
TRN_CODE CHAR(1) CHARACTER SET NONE,
TRN_DATE TIMESTAMP,
REFERENCE VARCHAR(40) CHARACTER SET NONE,
QTY INTEGER,
PERSON_ID VARCHAR(8) CHARACTER SET NONE,
DEVICE_ID CHAR(2) CHARACTER SET NONE)
AS 
 
 
                                                           
  DECLARE VARIABLE STRWH_ID CHAR(2);
  DECLARE VARIABLE STRLOCN_ID VARCHAR(10);
  DECLARE VARIABLE STR_MOBILE_WH_ID CHAR(2);
  DECLARE VARIABLE STR_ORIG_MOBILE_WH_ID CHAR(2);
  DECLARE VARIABLE STR_MOBILE_LOCN_ID VARCHAR(10);
  DECLARE VARIABLE STRAUDIT_DESC VARCHAR(70);
  DECLARE VARIABLE LOCN_NAME VARCHAR(50); 
  DECLARE VARIABLE STR_LAST_PARENT_LOCN_ID VARCHAR(10);
  DECLARE VARIABLE STR_PARENT_LOCN_ID VARCHAR(10);
  DECLARE VARIABLE INT_UPDATED INTEGER;
  DECLARE VARIABLE STR_CURRENT_WH_ID CHAR(2);
  DECLARE VARIABLE STR_PREV_PARENT_LOCN_ID VARCHAR(10);
       
BEGIN
  
  STRAUDIT_DESC = ''; 
    
  IF (:TRN_TYPE = 'TRMI') THEN
  BEGIN       
     /* 
 MOVE MOBILE LOCATION TO BE A SON OF LOCATION
 AND UPDATE WH_ID OF MOBILE LOCATION AND GOODS WITHIN
     */
     /* CHECK LOCATION EXISTS */
     /* ELSE CREATE THE NEW LOCATION */

     STRWH_ID = '';
     STRLOCN_ID = '';
     STR_CURRENT_WH_ID = '';
    
     /* CHECK TO LOCATION */
     SELECT LOCN_ID, CURRENT_WH_ID 
     FROM LOCATION
     WHERE LOCN_ID = :LOCN_ID
       AND WH_ID = :WH_ID
     INTO :STRLOCN_ID, :STRWH_ID; 

     IF (STRLOCN_ID IS NULL) THEN /* LOCATION NOT FOUND */
     BEGIN
        LOCN_NAME = 'CREATED DURING MOBTRAN ' || :TRN_DATE;
        /* ADD NEW LOCATION RECORD */
        INSERT INTO LOCATION (LOCN_ID, WH_ID, LOCN_NAME , LAST_UPDATE_DATE, LAST_UPDATE_BY )
        VALUES (:LOCN_ID, :WH_ID, :LOCN_NAME, :TRN_DATE, :PERSON_ID);

     END
     IF (STRWH_ID IS NULL) THEN
     BEGIN
        STRWH_ID = WH_ID;
     END
     /* GET CURRENT WH_ID FOR MOBILE */
     STR_MOBILE_WH_ID = '';
     STR_ORIG_MOBILE_WH_ID = '';
     STR_ORIG_MOBILE_WH_ID = SUBSTR(SUBLOCN_ID, 1,2);
     STR_MOBILE_LOCN_ID = SUBSTR(SUBLOCN_ID, 3,STRLEN(SUBLOCN_ID) );
     /* STR_ORIG_MOBILE_WH_ID = :ORIG_MOBILE_WH_ID; */
     /* STR_MOBILE_LOCN_ID = :MOBILE_LOCN_ID; */ 
     /* CHECK FROM LOCATION */
     SELECT CURRENT_WH_ID 
     FROM LOCATION
     WHERE LOCN_ID = :STR_MOBILE_LOCN_ID
       AND WH_ID = :STR_ORIG_MOBILE_WH_ID
     INTO :STR_CURRENT_WH_ID; 
     IF (STR_CURRENT_WH_ID IS NULL) THEN
     BEGIN
        STR_CURRENT_WH_ID = STR_ORIG_MOBILE_WH_ID;
     END

     /* MUST CHECK THAT WE ARE NOT MOVING THIS DOWN THE CHAIN */
     STR_LAST_PARENT_LOCN_ID = STR_MOBILE_LOCN_ID;
     INT_UPDATED = 1;
     WHILE (INT_UPDATED = 1) DO
     BEGIN
        INT_UPDATED = 0;
        FOR SELECT LOCN_ID
            FROM LOCATION 
            WHERE PARENT_LOCN_ID = :STR_LAST_PARENT_LOCN_ID
            AND CURRENT_WH_ID = :STR_CURRENT_WH_ID
            INTO :STR_PARENT_LOCN_ID
        DO
        BEGIN
           INT_UPDATED = 1;    
        END
        STR_LAST_PARENT_LOCN_ID = STR_PARENT_LOCN_ID;
        IF (STR_LAST_PARENT_LOCN_ID = STR_MOBILE_LOCN_ID) THEN
        BEGIN
           EXECUTE PROCEDURE UPDATE_TRAN (:RECORD_ID, 'F', 'TRYED TO MOVE MOBILE LOCATION FURTHER DOWN THE CHAIN');
           EXIT;
        END
     END
     /* OK DO UPDATE */
     STR_PREV_PARENT_LOCN_ID = '';
     FOR SELECT WH_ID, PARENT_LOCN_ID
         FROM LOCATION 
         WHERE LOCN_ID = :STR_MOBILE_LOCN_ID
         AND WH_ID = :STR_ORIG_MOBILE_WH_ID
         INTO :STR_MOBILE_WH_ID ,:STR_PREV_PARENT_LOCN_ID
     DO
     BEGIN
    
        /* UPDATE THE MOBILES WH_ID */
        UPDATE LOCATION
           SET CURRENT_WH_ID = :STRWH_ID , 
               PARENT_LOCN_ID = :LOCN_ID,      
               LAST_UPDATE_DATE = :TRN_DATE,    
               LAST_UPDATE_BY = :PERSON_ID    
           WHERE WH_ID = :STR_MOBILE_WH_ID
           AND LOCN_ID = :STR_MOBILE_LOCN_ID;
     END

     STR_LAST_PARENT_LOCN_ID = STR_MOBILE_LOCN_ID;
     INT_UPDATED = 1;
     WHILE (INT_UPDATED = 1) DO
     BEGIN
        INT_UPDATED = 0;
        FOR SELECT LOCN_ID
            FROM LOCATION 
            WHERE PARENT_LOCN_ID = :STR_LAST_PARENT_LOCN_ID
            AND CURRENT_WH_ID = :STR_CURRENT_WH_ID
            INTO :STR_PARENT_LOCN_ID
        DO
        BEGIN
           /* UPDATE THE MOBILES WH_ID */
           UPDATE LOCATION
              SET CURRENT_WH_ID = :STRWH_ID , 
                  LAST_UPDATE_DATE = :TRN_DATE,    
                  LAST_UPDATE_BY = :PERSON_ID    
              WHERE CURRENT_WH_ID = :STR_CURRENT_WH_ID
              AND LOCN_ID = :STR_PARENT_LOCN_ID;
           INT_UPDATED = 1;    
        END
        STR_LAST_PARENT_LOCN_ID = STR_PARENT_LOCN_ID;
        IF (STR_LAST_PARENT_LOCN_ID = STR_MOBILE_LOCN_ID) THEN
        BEGIN
           INT_UPDATED = 0;
        END
     END

     /* UPDATE TRANSACTIONS TABLE */               
     EXECUTE PROCEDURE UPDATE_TRAN (:RECORD_ID, 'T', 'Processed successfully');

  END /* TRN_TYPE = 'TRMI' */
      

END ^

ALTER PROCEDURE PC_TROL_TRIL (RECORD_ID INTEGER,
WH_ID CHAR(2) CHARACTER SET NONE,
LOCN_ID VARCHAR(10) CHARACTER SET NONE,
OBJECT VARCHAR(30) CHARACTER SET NONE,
TRN_TYPE VARCHAR(4) CHARACTER SET NONE,
TRN_CODE CHAR(1) CHARACTER SET NONE,
TRN_DATE TIMESTAMP,
REFERENCE VARCHAR(40) CHARACTER SET NONE,
QTY INTEGER,
PERSON_ID VARCHAR(10) CHARACTER SET NONE,
DEVICE_ID CHAR(2) CHARACTER SET NONE)
AS 
DECLARE VARIABLE SSN_EXIST INTEGER;
  DECLARE VARIABLE strWH_ID CHAR(2);
  DECLARE VARIABLE strLOCN_ID VARCHAR(10);
  DECLARE VARIABLE strAUDIT_DESC VARCHAR(70);
  DECLARE VARIABLE iCURRENT_QTY INTEGER;
  DECLARE VARIABLE iSUB_QTY INTEGER;
  DECLARE VARIABLE PROCESS_OK CHAR(1);
  DECLARE VARIABLE strISSN_STATUS CHAR(2);
  DECLARE VARIABLE strISSN_STATUS_CODE VARCHAR(10);
  DECLARE VARIABLE strPROD_ID VARCHAR(30);
  DECLARE VARIABLE intPRODisNULL INTEGER;
DECLARE VARIABLE WK_DO_UASL CHAR(1);
  DECLARE VARIABLE WK_SUB_LOCN VARCHAR(10);
       
BEGIN
  
  strAUDIT_DESC = ''; 
    
  IF (:TRN_TYPE = 'TROL') THEN
  BEGIN       
     strWH_ID = '';
     strLOCN_ID = '';
    
     /* Check transit location */
     SELECT FIRST 1 LOCN_ID, WH_ID 
     FROM LOCATION
     WHERE LOCN_ID = :DEVICE_ID
     INTO :strLOCN_ID, :strWH_ID; 

     IF (strLOCN_ID = '') THEN /* Transit Location not found */
     BEGIN
        /* Update transactions table */        
        EXECUTE PROCEDURE UPDATE_TRAN (:RECORD_ID, 'F', 'Transit Location not found TROL');
        EXIT;
     END
     ELSE
     BEGIN                         
       IF ((:TRN_CODE = 'A') OR  
           (:TRN_CODE = 'W')) THEN
       BEGIN
           SSN_EXIST = 0;
           iCURRENT_QTY = -1; 
           iSUB_QTY = (-1) * :QTY;
           strISSN_STATUS = '';
           strISSN_STATUS_CODE = '';

           /* Check SSN */
/*
           SELECT 1, CURRENT_QTY, STATUS_SSN, STATUS_CODE, PROD_ID
           FROM SSN
           WHERE SSN_ID = :OBJECT
           INTO :SSN_EXIST, :iCURRENT_QTY, :strISSN_STATUS, :strISSN_STATUS_CODE, :strPROD_ID intPRODisNULL;
*/
           SELECT 1, CURRENT_QTY, ISSN_STATUS, STATUS_CODE, PROD_ID
           FROM ISSN
           WHERE SSN_ID = :OBJECT
           INTO :SSN_EXIST, :iCURRENT_QTY, :strISSN_STATUS, :strISSN_STATUS_CODE, :strPROD_ID ;
                
           /* SSN not exists, then exit */
           IF (SSN_EXIST = 0) THEN
           BEGIN 
             /* Update transactions table */        
             EXECUTE PROCEDURE UPDATE_TRAN (:RECORD_ID, 'F', 'SSN is not in the database');
             EXIT;
           END 
/*
           IF (:QTY < :iCURRENT_QTY) THEN
           BEGIN
               -* Add new record to ISSN table *-
               EXECUTE PROCEDURE ADD_ISSN (:OBJECT, :strWH_ID, :strLOCN_ID, 
   :LOCN_ID, :iCURRENT_QTY, :QTY, :TRN_DATE, 
                        :strISSN_STATUS, :strISSN_STATUS_CODE, 'NOW', :PERSON_ID, :strPROD_ID, 1); 
                                      
               -* Update Current_Qty *-
               EXECUTE PROCEDURE UPDATE_SSN_QTY_TROL (:OBJECT, :iSUB_QTY);

               strAUDIT_DESC = 'Transfered partial qty ' || :QTY || ' into transit location'; 
           END
           ELSE IF (:QTY >= :iCURRENT_QTY) THEN
*/
           BEGIN
               /* Update SSN */ 
               EXECUTE PROCEDURE UPDATE_SSN_TROL_A (:OBJECT, :strWH_ID, :strLOCN_ID, :TRN_DATE, :DEVICE_ID);

               strAUDIT_DESC = 'Transfered all qty  ' || :iCURRENT_QTY || ' into transit location'; 
           END

           /* Update transactions table */               
           EXECUTE PROCEDURE UPDATE_TRAN (:RECORD_ID, 'T', 'Processed successfully');

           /* Add transaction history */                                                                                     
/*
           EXECUTE PROCEDURE ADD_SSN_HIST(:WH_ID, :LOCN_ID, :OBJECT, :TRN_TYPE, :TRN_CODE, :TRN_DATE,
                                          :strAUDIT_DESC, :REFERENCE, :QTY,  :PERSON_ID, :DEVICE_ID);
*/
           EXECUTE PROCEDURE ADD_SSN_HIST(:WH_ID, :LOCN_ID, :OBJECT, :TRN_TYPE, :TRN_CODE, :TRN_DATE,
                                          :strAUDIT_DESC, :REFERENCE, :iCURRENT_QTY,  :PERSON_ID, :DEVICE_ID);
       END /* TRN_CODE = 'A' */
       
       ELSE IF (:TRN_CODE = 'P') THEN
       BEGIN
          PROCESS_OK = 'F';
          strAUDIT_DESC = 'Transfered qty of ' || :QTY || ' into transit location'; 
          
          EXECUTE PROCEDURE PC_QTY_TROL_TRIL_P (:RECORD_ID, :strWH_ID, :LOCN_ID, :WH_ID,
                                         :OBJECT, :TRN_TYPE, :REFERENCE, :QTY, :PERSON_ID, :DEVICE_ID, :TRN_CODE, :TRN_DATE, :strAUDIT_DESC) 
                         RETURNING_VALUES :PROCESS_OK; 
   
/*
          IF (PROCESS_OK = 'T') THEN
          BEGIN
              -* Add transaction history *-                                                                                     
              EXECUTE PROCEDURE ADD_SSN_HIST(:WH_ID, :LOCN_ID, :OBJECT, :TRN_TYPE, :TRN_CODE, :TRN_DATE,
                                             :strAUDIT_DESC, :REFERENCE, :QTY,  :PERSON_ID, :DEVICE_ID);
          END         
*/
       END /* TRN_CODE = 'P' */
       
     END /* else */ 
  END /* TRN_TYPE = 'TROL' */
      
  ELSE IF (:TRN_TYPE = 'TRIL') THEN
  BEGIN
     IF (:TRN_CODE = 'A') THEN
     BEGIN
         SELECT SUB_LOCN_ID 
         FROM TRANSACTIONS 
         WHERE RECORD_ID = :RECORD_ID 
         INTO :WK_SUB_LOCN;
        /* Update SSN */ 
        EXECUTE PROCEDURE UPDATE_SSN_TRIL_A (:OBJECT, :WH_ID, :LOCN_ID, :TRN_DATE, :QTY, :TRN_CODE, :WK_SUB_LOCN, :DEVICE_ID, :PERSON_ID);          
         SELECT 1, CURRENT_QTY 
         FROM ISSN
         WHERE SSN_ID = :OBJECT
         INTO :SSN_EXIST, :iCURRENT_QTY ;

        /* Update transactions table */               
 /* this adds to locn a new issn */
 /* must remove this qty from issn in transit location */
        EXECUTE PROCEDURE UPDATE_TRAN (:RECORD_ID, 'T', 'Processed successfully');

        strAUDIT_DESC = 'Transfered qty of ' || :QTY || ' into location'; 

        /* Add transaction history */                                                                                     
/*
        EXECUTE PROCEDURE ADD_SSN_HIST(:WH_ID, :LOCN_ID, :OBJECT, :TRN_TYPE, :TRN_CODE, :TRN_DATE,
                                         :strAUDIT_DESC, :REFERENCE, :QTY,  :PERSON_ID, :DEVICE_ID); 
*/
        EXECUTE PROCEDURE ADD_SSN_HIST(:WH_ID, :LOCN_ID, :OBJECT, :TRN_TYPE, :TRN_CODE, :TRN_DATE,
                                         :strAUDIT_DESC, :REFERENCE, :iCURRENT_QTY,  :PERSON_ID, :DEVICE_ID); 
     END /* TRN_CODE = 'A' */
     
     ELSE IF (:TRN_CODE = 'W') THEN
     BEGIN
         SELECT SUB_LOCN_ID 
         FROM TRANSACTIONS 
         WHERE RECORD_ID = :RECORD_ID 
         INTO :WK_SUB_LOCN;
        /* Update SSN */ 
        EXECUTE PROCEDURE UPDATE_SSN_TRIL_A (:OBJECT, :WH_ID, :LOCN_ID, :TRN_DATE, :QTY, :TRN_CODE, :WK_SUB_LOCN, :DEVICE_ID, :PERSON_ID);          
        SELECT 1, CURRENT_QTY 
        FROM ISSN
        WHERE SSN_ID = :OBJECT
        INTO :SSN_EXIST, :iCURRENT_QTY ;

        /* Update transactions table */               
 /* this adds to locn a new issn */
 /* must remove this qty from issn in transit location */
        EXECUTE PROCEDURE UPDATE_TRAN (:RECORD_ID, 'T', 'Processed successfully');

        strAUDIT_DESC = 'Transfered qty of ' || :iCURRENT_QTY || ' into location'; 
/*
        strAUDIT_DESC = 'Transfered qty of ' || :QTY || ' into location'; 
*/

        /* Add transaction history */                                                                                     
/*
        EXECUTE PROCEDURE ADD_SSN_HIST(:WH_ID, :LOCN_ID, :OBJECT, :TRN_TYPE, :TRN_CODE, :TRN_DATE,
                                         :strAUDIT_DESC, :REFERENCE, :QTY,  :PERSON_ID, :DEVICE_ID); 
*/
        EXECUTE PROCEDURE ADD_SSN_HIST(:WH_ID, :LOCN_ID, :OBJECT, :TRN_TYPE, :TRN_CODE, :TRN_DATE,
                                         :strAUDIT_DESC, :REFERENCE, :iCURRENT_QTY,  :PERSON_ID, :DEVICE_ID); 
     END /* TRN_CODE = 'W' */
     
     ELSE IF (:TRN_CODE = 'P') THEN
     BEGIN
        PROCESS_OK = 'F';
        strAUDIT_DESC = 'Transfered qty of ' || :QTY || ' into location'; 

        EXECUTE PROCEDURE PC_QTY_TROL_TRIL_P (:RECORD_ID, :WH_ID, :DEVICE_ID, :LOCN_ID, :OBJECT, :TRN_TYPE, :REFERENCE, :QTY, :PERSON_ID, :DEVICE_ID, :TRN_CODE, :TRN_DATE, :strAUDIT_DESC) 
                                               RETURNING_VALUES :PROCESS_OK; 

        IF (PROCESS_OK = 'T') THEN
        BEGIN
           /* Add transaction history */                                                                                     
/*
           EXECUTE PROCEDURE ADD_SSN_HIST(:WH_ID, :LOCN_ID, :OBJECT, :TRN_TYPE, :TRN_CODE, :TRN_DATE,
                                         :strAUDIT_DESC, :REFERENCE, :QTY,  :PERSON_ID, :DEVICE_ID);
*/

           /* send to remote the available qty of the prod */
           SELECT SEND_UASL_V4 FROM CONTROL INTO :WK_DO_UASL;
           IF (WK_DO_UASL = 'T') THEN
           BEGIN
              EXECUTE PROCEDURE SEND_PICKABLE_STOCK (:OBJECT,
                 :PERSON_ID,
                 :DEVICE_ID,
                 :TRN_DATE);
           END
        END 
      END /* TRN_CODE = 'P' */
  END /* TRN_TYPE = 'TRIL' */

END ^

ALTER PROCEDURE PC_TRSS (RECORD_ID INTEGER,
WH_ID CHAR(2) CHARACTER SET NONE,
LOCN_ID VARCHAR(10) CHARACTER SET NONE,
OBJECT VARCHAR(30) CHARACTER SET NONE,
TRN_TYPE VARCHAR(4) CHARACTER SET NONE,
TRN_CODE CHAR(1) CHARACTER SET NONE,
TRN_DATE TIMESTAMP,
REFERENCE VARCHAR(40) CHARACTER SET NONE,
QTY INTEGER,
PERSON_ID VARCHAR(10) CHARACTER SET NONE,
DEVICE_ID CHAR(2) CHARACTER SET NONE)
AS 
DECLARE VARIABLE SSN_EXIST INTEGER;
  DECLARE VARIABLE strWH_ID CHAR(2);
  DECLARE VARIABLE strLOCN_ID VARCHAR(10);
  DECLARE VARIABLE strAUDIT_DESC VARCHAR(70);
  DECLARE VARIABLE iCURRENT_QTY INTEGER;
  DECLARE VARIABLE iSUB_QTY INTEGER;
  DECLARE VARIABLE PROCESS_OK CHAR(1);
  DECLARE VARIABLE strISSN_STATUS CHAR(2);
  DECLARE VARIABLE strISSN_STATUS_CODE VARCHAR(10);
  DECLARE VARIABLE strPROD_ID VARCHAR(30);
  DECLARE VARIABLE strORIGINAL_SSN VARCHAR(20);
  DECLARE VARIABLE SSN_NEW_EXIST INTEGER;
  DECLARE VARIABLE LOCN_NAME VARCHAR(50);
  DECLARE VARIABLE WK_COMPANY VARCHAR(20);
       
BEGIN
  
  strAUDIT_DESC = ''; 
    
  IF (:TRN_TYPE = 'TRSS') THEN
  BEGIN       
     strWH_ID = '';
     strLOCN_ID = '';
    
     /* Check too location */
     SELECT LOCN_ID, WH_ID 
     FROM LOCATION
     WHERE LOCN_ID = :LOCN_ID
       AND WH_ID = :WH_ID
     INTO :strLOCN_ID, :strWH_ID; 

     IF (strLOCN_ID = '') THEN /* Location not found */
     BEGIN
        LOCN_NAME = 'Created during split ' || :TRN_DATE;
        /* Add new Location record */
        INSERT INTO LOCATION (LOCN_ID, WH_ID, LOCN_NAME , LAST_UPDATE_DATE, LAST_UPDATE_BY )
        VALUES (:LOCN_ID, :WH_ID, :LOCN_NAME, :TRN_DATE, :PERSON_ID);

     END
     BEGIN                         
        /* it dosn t make sense to split a product so i ll treat all splits as for an ssn */
           SSN_EXIST = 0;
           SSN_NEW_EXIST = 0;
           iCURRENT_QTY = -1; 
           iSUB_QTY = (-1) * :QTY;
           strISSN_STATUS = '';
           strISSN_STATUS_CODE = '';

           /* Check From SSN */
           SELECT 1, CURRENT_QTY, ISSN_STATUS, STATUS_CODE, PROD_ID, ORIGINAL_SSN, COMPANY_ID
           FROM ISSN
           WHERE SSN_ID = :OBJECT
           INTO :SSN_EXIST, :iCURRENT_QTY, :strISSN_STATUS, :strISSN_STATUS_CODE, :strPROD_ID , :strORIGINAL_SSN, :WK_COMPANY ;
                
           /* SSN not exists, then exit */
           IF (SSN_EXIST = 0) THEN
           BEGIN 
             /* Update transactions table */        
             EXECUTE PROCEDURE UPDATE_TRAN (:RECORD_ID, 'F', 'SSN is not in the database');
             EXIT;
           END 
           /* Check new SSN */
           SELECT 1
           FROM ISSN
           WHERE SSN_ID = :REFERENCE
           INTO :SSN_NEW_EXIST;
                
           IF (:QTY < :iCURRENT_QTY) THEN
           BEGIN
              /* SSN not exists, then update */
              IF (SSN_NEW_EXIST = 1) THEN
              BEGIN 
                 /* Update record in ISSN table */
                 UPDATE ISSN   
                    SET ORIGINAL_SSN = :strORIGINAL_SSN , 
                        WH_ID = :WH_ID , 
                        LOCN_ID = :LOCN_ID , 
                        PREV_LOCN_ID = :LOCN_ID , 
                        CURRENT_QTY = :QTY , 
                        PREV_QTY = :QTY ,
                        PREV_DATE = :TRN_DATE , 
                        ISSN_STATUS = :strISSN_STATUS , 
                        STATUS_CODE = :strISSN_STATUS_CODE , 
                        INTO_DATE = 'NOW' , 
                        USER_ID = :PERSON_ID , 
                        PROD_ID = :strPROD_ID ,
                        COMPANY_ID = :WK_COMPANY 
                    WHERE SSN_ID = :REFERENCE;
              END 
              ELSE
              BEGIN
                 /* Add new record to ISSN table */
                 INSERT INTO ISSN   
                    (SSN_ID, ORIGINAL_SSN, WH_ID, LOCN_ID, PREV_LOCN_ID, CURRENT_QTY, PREV_QTY,
                     PREV_DATE, ISSN_STATUS, STATUS_CODE, CREATE_DATE, USER_ID, PROD_ID, ORIGINAL_QTY, COMPANY_ID)

                    VALUES (:REFERENCE, 
                       :strORIGINAL_SSN,
                       :WH_ID, 
                       :LOCN_ID, 
                       :LOCN_ID, 
                       :QTY, 
                       :QTY,
                       :TRN_DATE, 
                       :strISSN_STATUS,
                       :strISSN_STATUS_CODE,
                       'NOW',
                       :PERSON_ID, 
                       :strPROD_ID,
                       0,
                       :WK_COMPANY);
              END /* new issn */

              /* Update Current_Qty */
              EXECUTE PROCEDURE UPDATE_SSN_QTY_TROL (:OBJECT, :iSUB_QTY);

              strAUDIT_DESC = 'Transfered partial qty ' || :QTY || ' into ssn ' || :REFERENCE; 
           END /* qty less */
           ELSE IF (:QTY >= :iCURRENT_QTY) THEN
           BEGIN
               iSUB_QTY = (-1) * :iCURRENT_QTY;
              /* SSN not exists, then update */
              IF (SSN_NEW_EXIST = 1) THEN
              BEGIN 
                 /* Update record in ISSN table */
                 UPDATE ISSN   
                    SET ORIGINAL_SSN = :strORIGINAL_SSN , 
                        WH_ID = :WH_ID , 
                        LOCN_ID = :LOCN_ID , 
                        PREV_LOCN_ID = :LOCN_ID , 
                        CURRENT_QTY = :QTY , 
                        PREV_QTY = :QTY ,
                        PREV_DATE = :TRN_DATE , 
                        ISSN_STATUS = :strISSN_STATUS , 
                        STATUS_CODE = :strISSN_STATUS_CODE , 
                        INTO_DATE = 'NOW' , 
                        USER_ID = :PERSON_ID , 
                        PROD_ID = :strPROD_ID ,
                        COMPANY_ID = :WK_COMPANY 
                    WHERE SSN_ID = :REFERENCE;
              END 
              ELSE
              BEGIN
                 /* Add new record to ISSN table */
                 INSERT INTO ISSN   
                    (SSN_ID, ORIGINAL_SSN, WH_ID, LOCN_ID, PREV_LOCN_ID, CURRENT_QTY, PREV_QTY,
                     PREV_DATE, ISSN_STATUS, STATUS_CODE, CREATE_DATE, USER_ID, PROD_ID, COMPANY_ID)

                    VALUES (:REFERENCE, :strORIGINAL_SSN, :WH_ID, :LOCN_ID,:LOCN_ID, :QTY, :QTY,
                    :TRN_DATE, :strISSN_STATUS, :strISSN_STATUS_CODE, 'NOW', :PERSON_ID, :strPROD_ID, :WK_COMPANY );
              END /* new issn */

              /* Update Current_Qty */
              EXECUTE PROCEDURE UPDATE_SSN_QTY_TROL (:OBJECT, :iSUB_QTY);
              strAUDIT_DESC = 'Transfered all qty  ' || :QTY || ' into ssn ' || :REFERENCE ; 
           END

           /* Update transactions table */               
           EXECUTE PROCEDURE UPDATE_TRAN (:RECORD_ID, 'T', 'Processed successfully');

           /* Add transaction history */                                                                                     
           EXECUTE PROCEDURE ADD_SSN_HIST(:WH_ID, :LOCN_ID, :OBJECT, :TRN_TYPE, :TRN_CODE, :TRN_DATE,
                                          :strAUDIT_DESC, :REFERENCE, :QTY,  :PERSON_ID, :DEVICE_ID);
       
     END /* else */ 
  END /* TRN_TYPE = 'TRSS' */
      
  SUSPEND;  
END ^

ALTER PROCEDURE PC_UGXX (RECORD_ID INTEGER,
WH_ID CHAR(2) CHARACTER SET NONE,
LOCN_ID VARCHAR(10) CHARACTER SET NONE,
OBJECT VARCHAR(30) CHARACTER SET NONE,
TRN_TYPE VARCHAR(4) CHARACTER SET NONE,
TRN_CODE CHAR(1) CHARACTER SET NONE,
TRN_DATE TIMESTAMP,
REFERENCE VARCHAR(40) CHARACTER SET NONE,
QTY INTEGER,
PERSON_ID VARCHAR(10) CHARACTER SET NONE,
DEVICE_ID CHAR(2) CHARACTER SET NONE,
INSTANCE_ID VARCHAR(10) CHARACTER SET NONE)
AS 
DECLARE VARIABLE strWH_ID CHAR(2);
  DECLARE VARIABLE strINSTANCE VARCHAR(10);
  DECLARE VARIABLE LOCN_EXIST INTEGER;
  DECLARE VARIABLE LOCN_NAME VARCHAR(50);
  DECLARE VARIABLE GRN_EXIST INTEGER;
  DECLARE VARIABLE strAUDIT_DESC VARCHAR(255);
  DECLARE VARIABLE RESULT INTEGER;
  DECLARE VARIABLE strTYPE VARCHAR(40);
  DECLARE VARIABLE WK_GRN VARCHAR(20);
  DECLARE VARIABLE WK_CODE VARCHAR(75);
BEGIN
    strWH_ID = '';
    strINSTANCE = '';
    LOCN_EXIST = 0;
    /* LOCN_NAME = 'Created during audit ' || :TRN_DATE; */
    LOCN_NAME = LOCN_ID;
    GRN_EXIST = 0;
    strAUDIT_DESC = '';
    /* Check trasaction code */

        /* Check if warehouse exists */
/*
    SELECT WH_ID, INSTANCE_ID
    FROM WAREHOUSE
    WHERE WH_ID = :WH_ID
    INTO :strWH_ID, :strINSTANCE;

    -* Check warehouse*-
    IF ((strWH_ID = '') or (strWH_ID is null)) THEN
    BEGIN
       -* Update transactions table *-
       EXECUTE PROCEDURE UPDATE_TRAN (:RECORD_ID, 'F', 'Invalid Warehouse');
       EXIT;
    END
    ELSE
    BEGIN -* WH *-
        -* Check instance *-
        IF (strINSTANCE <> :INSTANCE_ID) THEN
        BEGIN
          -* Update transactions table *-
          EXECUTE PROCEDURE UPDATE_TRAN (:RECORD_ID, 'F', 'Invalid InstanceID');
          EXIT;
        END
        ELSE
        BEGIN -* Location *-
           -* Check Location *-
           SELECT 1
           FROM LOCATION
           WHERE WH_ID = :WH_ID
           AND LOCN_ID = :LOCN_ID
           INTO :LOCN_EXIST;

           -* Location not exists, then add new location *-
           IF (LOCN_EXIST = 0) THEN
           BEGIN
              -* Add new Location record *-
              INSERT INTO LOCATION (LOCN_ID, WH_ID, LOCN_NAME, LAST_AUDITED_DATE)
              VALUES (:LOCN_ID, :WH_ID, :LOCN_NAME, :TRN_DATE);
           END
     END -* INSTANCEID *-
     END -* WH *-
*/


       SELECT 1
       FROM GRN
       WHERE GRN = :OBJECT
       INTO :GRN_EXIST;

       IF (GRN_EXIST = 0) THEN
       BEGIN
                 /* Add new SSN */
          EXECUTE PROCEDURE UPDATE_TRAN (:RECORD_ID, 'F','Invalid GRN');
          EXIT;
       END


    IF (:TRN_TYPE = 'UGON') THEN /* Update Owner */
    BEGIN
         EXECUTE PROCEDURE UPDATE_GRN(:OBJECT, :TRN_TYPE,0, :REFERENCE);
         strAudit_Desc = 'GRN OWNER_ID HAS BEEN UPDATED ' || :REFERENCE;

    END

  IF (:TRN_TYPE = 'UGRI') THEN      /* Update Return - Supplier */
    BEGIN
         EXECUTE PROCEDURE UPDATE_GRN(:OBJECT, :TRN_TYPE,0, :REFERENCE);
         strAudit_Desc = 'GRN RETURN_ID HAS BEEN UPDATED ' || :REFERENCE;
    END

 IF (:TRN_TYPE = 'UGCA') THEN      /* Update Carrier */
    BEGIN
         EXECUTE PROCEDURE UPDATE_GRN(:OBJECT, :TRN_TYPE,0, :REFERENCE);
         strAudit_Desc = 'GRN CARRIER HAS BEEN UPDATED ' || :REFERENCE;
    END

 IF (:TRN_TYPE = 'UGCN') THEN      /* Update Connote */
    BEGIN
         EXECUTE PROCEDURE UPDATE_GRN(:OBJECT, :TRN_TYPE,0, :REFERENCE);
         strAudit_Desc = 'GRN AWB_CONSIGNMENT_NO HAS BEEN UPDATED ' || :REFERENCE;
    END

 IF (:TRN_TYPE = 'UGHP') THEN      /* Update Pallets */
    BEGIN
         EXECUTE PROCEDURE UPDATE_GRN(:OBJECT, :TRN_TYPE,0, :REFERENCE);
         strAudit_Desc = 'GRN PALLET_YN AND GRN_PALLET_QTY HAS BEEN UPDATED ' || :REFERENCE;
    END

 IF (:TRN_TYPE = 'UGHC') THEN      /* Update Crate */
    BEGIN
         EXECUTE PROCEDURE UPDATE_GRN(:OBJECT, :TRN_TYPE,0, :REFERENCE);
         strAudit_Desc = 'GRN PACK_CRATE OWNER, TYPE, QTY HAVE BEEN UPDATED ' || :REFERENCE;
    END

 IF (:TRN_TYPE = 'UGSN') THEN      /* Update Container */
    BEGIN
         EXECUTE PROCEDURE UPDATE_GRN(:OBJECT, :TRN_TYPE,0, :REFERENCE);
         strAudit_Desc = 'GRN CONTAINER NO AND TYPE HAVE BEEN UPDATED ' || :REFERENCE;
    END

 IF (:TRN_TYPE = 'UGLT') THEN      /* Update Lot No */
    BEGIN
         EXECUTE PROCEDURE UPDATE_GRN(:OBJECT, :TRN_TYPE,0, :REFERENCE);
         strAudit_Desc = 'GRN LAST LOT AND  LAST PALLET NO AND LAST_LINE_NO HAVE BEEN UPDATED ' || :REFERENCE;
    END


    EXECUTE PROCEDURE UPDATE_TRAN (:RECORD_ID, 'T', 'Processed successfully');

END ^

ALTER PROCEDURE PC_UIXX (RECORD_ID INTEGER,
WH_ID CHAR(2) CHARACTER SET NONE,
LOCN_ID VARCHAR(10) CHARACTER SET NONE,
OBJECT VARCHAR(30) CHARACTER SET NONE,
TRN_TYPE VARCHAR(4) CHARACTER SET NONE,
TRN_CODE CHAR(1) CHARACTER SET NONE,
TRN_DATE TIMESTAMP,
REFERENCE VARCHAR(40) CHARACTER SET NONE,
QTY INTEGER,
PERSON_ID VARCHAR(10) CHARACTER SET NONE,
DEVICE_ID CHAR(2) CHARACTER SET NONE,
INSTANCE_ID VARCHAR(10) CHARACTER SET NONE)
AS 
DECLARE VARIABLE strWH_ID CHAR(2);
  DECLARE VARIABLE strINSTANCE VARCHAR(10);
  DECLARE VARIABLE strLOCN_ID VARCHAR(10);
  DECLARE VARIABLE LOCN_EXIST INTEGER;
  DECLARE VARIABLE LOCN_NAME VARCHAR(50);
  DECLARE VARIABLE ISSN_EXIST INTEGER;
  DECLARE VARIABLE PROD_EXIST INTEGER;
  DECLARE VARIABLE COMPANY_EXIST INTEGER;
  DECLARE VARIABLE strAUDIT_DESC VARCHAR(50);
  DECLARE VARIABLE RESULT INTEGER;
  DECLARE VARIABLE strTYPE VARCHAR(40);
  DECLARE VARIABLE WK_ISSN VARCHAR(20);
  DECLARE VARIABLE WK_CODE VARCHAR(75);
  DECLARE VARIABLE WK_FILENAME VARCHAR(75);
  DECLARE VARIABLE WK_LOG VARCHAR(75);
  DECLARE VARIABLE WK_CURRENT_QTY INTEGER;
  DECLARE VARIABLE ISSN_RESPONSE_TEXT VARCHAR(255);
  DECLARE VARIABLE WK_SSN_ID VARCHAR(20);

BEGIN
ISSN_RESPONSE_TEXT = '';
/* 15 NOV 07 - AFTER DISCUSSING WITH GLENN
HAS BEEN RESOLVED THAT WE ARE GOING TO GET WHID AND LOCNID FROM ISSN
WE ARE NOT GOING TO WORRY ABOUT WHID AND LOCNID THAT IS PASSED TO THIS PROC */
    strWH_ID = '';
    strINSTANCE = '';
    strLOCN_ID = '';
    LOCN_EXIST = 0;
    /* LOCN_NAME = 'Created during audit  :TRN_DATE; */
    LOCN_NAME = LOCN_ID;
    ISSN_EXIST = 0;
    strAUDIT_DESC = '';
    

       SELECT COUNT(*)
       FROM ISSN
       WHERE SSN_ID = :OBJECT
       INTO :ISSN_EXIST;
       


       IF (ISSN_EXIST = 0) THEN
       BEGIN
                 /* Add new SSN */
          EXECUTE PROCEDURE UPDATE_TRAN (:RECORD_ID, 'F', 'Invalid ISSN');
          EXIT;
       END

    SELECT WH_ID, LOCN_ID
    FROM ISSN
    WHERE SSN_ID = :object
    INTO :strWH_ID, :strLOCN_ID;
    
       IF (strWH_ID <> WH_ID) THEN
       BEGIN
                 /* Add new SSN */
          EXECUTE PROCEDURE UPDATE_TRAN (:RECORD_ID, 'F', 'ISSN NOT IN WAREHOUSE');
          EXIT;
       END

       IF (strLOCN_ID <> LOCN_ID) THEN
       BEGIN
                 /* Add new SSN */
          EXECUTE PROCEDURE UPDATE_TRAN (:RECORD_ID, 'F', 'ISSN NOT IN LOCATION');
          EXIT;
       END

    IF (:TRN_TYPE = 'UIO1') THEN
    BEGIN
         EXECUTE PROCEDURE UPDATE_ISSN(:OBJECT, 'UIO1', :TRN_CODE, :REFERENCE, :TRN_DATE, :PERSON_ID, :QTY) RETURNING_VALUES ISSN_RESPONSE_TEXT;
         strAudit_Desc = 'Other1 field updated ' || :REFERENCE;
         EXECUTE PROCEDURE ADD_SSN_HIST(:strWH_ID, :strLOCN_ID, :OBJECT, :TRN_TYPE, :TRN_CODE, :TRN_DATE,
                                              :strAUDIT_DESC, :REFERENCE, :QTY, :PERSON_ID, :DEVICE_ID);
         EXECUTE PROCEDURE UPDATE_TRAN (:RECORD_ID, 'T', 'Processed successfully');
         EXIT;
    END
    
   IF (:TRN_TYPE = 'UIO2') THEN
    BEGIN
         EXECUTE PROCEDURE UPDATE_ISSN(:OBJECT, 'UIO2', :TRN_CODE, :REFERENCE, :TRN_DATE, :PERSON_ID, :QTY) RETURNING_VALUES ISSN_RESPONSE_TEXT;
         strAudit_Desc = 'Other2 field updated ' || :REFERENCE;
         EXECUTE PROCEDURE ADD_SSN_HIST(:strWH_ID, :strLOCN_ID, :OBJECT, :TRN_TYPE, :TRN_CODE, :TRN_DATE,
                                              :strAUDIT_DESC, :REFERENCE, :QTY, :PERSON_ID, :DEVICE_ID);
         EXECUTE PROCEDURE UPDATE_TRAN (:RECORD_ID, 'T', 'Processed successfully');
         EXIT;
    END
    
   IF (:TRN_TYPE = 'UIO3') THEN
    BEGIN
         EXECUTE PROCEDURE UPDATE_ISSN(:OBJECT, 'UIO3', :TRN_CODE, :REFERENCE, :TRN_DATE, :PERSON_ID, :QTY) RETURNING_VALUES ISSN_RESPONSE_TEXT;
         strAudit_Desc = 'Other3 field updated ' || :REFERENCE;
         EXECUTE PROCEDURE ADD_SSN_HIST(:strWH_ID, :strLOCN_ID, :OBJECT, :TRN_TYPE, :TRN_CODE, :TRN_DATE,
                                              :strAUDIT_DESC, :REFERENCE, :QTY, :PERSON_ID, :DEVICE_ID);
         EXECUTE PROCEDURE UPDATE_TRAN (:RECORD_ID, 'T', 'Processed successfully');
         EXIT;
    END

   IF (:TRN_TYPE = 'UIO4') THEN
    BEGIN
         EXECUTE PROCEDURE UPDATE_ISSN(:OBJECT, 'UIO4', :TRN_CODE, :REFERENCE, :TRN_DATE, :PERSON_ID, :QTY) RETURNING_VALUES ISSN_RESPONSE_TEXT;
         strAudit_Desc = 'Other4 field updated ' || :REFERENCE;
         EXECUTE PROCEDURE ADD_SSN_HIST(:strWH_ID, :strLOCN_ID, :OBJECT, :TRN_TYPE, :TRN_CODE, :TRN_DATE,
                                              :strAUDIT_DESC, :REFERENCE, :QTY, :PERSON_ID, :DEVICE_ID);
         EXECUTE PROCEDURE UPDATE_TRAN (:RECORD_ID, 'T', 'Processed successfully');
         EXIT;
    END

   IF (:TRN_TYPE = 'UICO') THEN
    BEGIN
         IF (LEN(:REFERENCE) > 20) THEN
         BEGIN
              EXECUTE PROCEDURE UPDATE_TRAN (:RECORD_ID, 'F', 'LENGTH OF FIELD GREATER THAN 20');
              EXIT;
         END
         
       SELECT COUNT(*)
       FROM COMPANY
       WHERE COMPANY_ID = :REFERENCE
       INTO :COMPANY_EXIST;

       IF (COMPANY_EXIST = 0) THEN
       BEGIN
                 /* Add new SSN */
          EXECUTE PROCEDURE UPDATE_TRAN (:RECORD_ID, 'F', 'Invalid Company Code');
          EXIT;
       END


         EXECUTE PROCEDURE UPDATE_ISSN(:OBJECT, 'UICO', :TRN_CODE, :REFERENCE, :TRN_DATE,:PERSON_ID, :QTY) RETURNING_VALUES ISSN_RESPONSE_TEXT;
         strAudit_Desc = 'Company field updated ' || :REFERENCE;
         EXECUTE PROCEDURE ADD_SSN_HIST(:strWH_ID, :strLOCN_ID, :OBJECT, :TRN_TYPE, :TRN_CODE, :TRN_DATE,
                                              :strAUDIT_DESC, :REFERENCE, :QTY, :PERSON_ID, :DEVICE_ID);
         EXECUTE PROCEDURE UPDATE_TRAN (:RECORD_ID, 'T', 'Processed successfully');
         EXIT;
    END
    
    IF (:TRN_TYPE = 'UIDI') THEN
    BEGIN
         IF (LEN(:REFERENCE) > 20) THEN
         BEGIN
              EXECUTE PROCEDURE UPDATE_TRAN (:RECORD_ID, 'F', 'LENGTH OF FIELD GREATER THAN 20');
              EXIT;
         END

         EXECUTE PROCEDURE UPDATE_ISSN(:OBJECT, 'UIDI', :TRN_CODE, :REFERENCE, :TRN_DATE,:PERSON_ID, :QTY) RETURNING_VALUES ISSN_RESPONSE_TEXT;
         strAudit_Desc = 'Division field updated ' || :REFERENCE;
         EXECUTE PROCEDURE ADD_SSN_HIST(:strWH_ID, :strLOCN_ID, :OBJECT, :TRN_TYPE, :TRN_CODE, :TRN_DATE,
                                              :strAUDIT_DESC, :REFERENCE, :QTY, :PERSON_ID, :DEVICE_ID);
         EXECUTE PROCEDURE UPDATE_TRAN (:RECORD_ID, 'T', 'Processed successfully');
         EXIT;
    END
    
    IF (:TRN_TYPE = 'UISN') THEN
    BEGIN
         IF (LEN(:REFERENCE) > 30) THEN
         BEGIN
              EXECUTE PROCEDURE UPDATE_TRAN (:RECORD_ID, 'F', 'LENGTH OF FIELD GREATER THAN 30');
              EXIT;
         END

         EXECUTE PROCEDURE UPDATE_ISSN(:OBJECT, 'UISN', :TRN_CODE, :REFERENCE, :TRN_DATE,:PERSON_ID, :QTY) RETURNING_VALUES ISSN_RESPONSE_TEXT;
         strAudit_Desc = 'Serial No field updated ' || :REFERENCE;
         EXECUTE PROCEDURE ADD_SSN_HIST(:strWH_ID, :strLOCN_ID, :OBJECT, :TRN_TYPE, :TRN_CODE, :TRN_DATE,
                                              :strAUDIT_DESC, :REFERENCE, :QTY, :PERSON_ID, :DEVICE_ID);
         EXECUTE PROCEDURE UPDATE_TRAN (:RECORD_ID, 'T', 'Processed successfully');
         EXIT;
    END
    
    IF (:TRN_TYPE = 'UISC') THEN
    BEGIN
         IF (LEN(:REFERENCE) > 10) THEN
         BEGIN
              EXECUTE PROCEDURE UPDATE_TRAN (:RECORD_ID, 'F', 'LENGTH OF FIELD GREATER THAN 10');
              EXIT;
         END
         EXECUTE PROCEDURE UPDATE_ISSN(:OBJECT, 'UISC', :TRN_CODE, :REFERENCE, :TRN_DATE,:PERSON_ID, :QTY) RETURNING_VALUES ISSN_RESPONSE_TEXT;
         strAudit_Desc = 'Status Code field updated ' || :REFERENCE;
         EXECUTE PROCEDURE ADD_SSN_HIST(:strWH_ID, :strLOCN_ID, :OBJECT, :TRN_TYPE, :TRN_CODE, :TRN_DATE,
                                              :strAUDIT_DESC, :REFERENCE, :QTY, :PERSON_ID, :DEVICE_ID);
         EXECUTE PROCEDURE UPDATE_TRAN (:RECORD_ID, 'T', 'Processed successfully');
         EXIT;
    END
    
    IF (:TRN_TYPE = 'UIKT') THEN
    BEGIN
         IF (LEN(:REFERENCE) > 1) THEN
         BEGIN
              EXECUTE PROCEDURE UPDATE_TRAN (:RECORD_ID, 'F', 'LENGTH OF FIELD GREATER THAN 1');
              EXIT;
         END

         EXECUTE PROCEDURE UPDATE_ISSN(:OBJECT, 'UIKT', :TRN_CODE, :REFERENCE, :TRN_DATE,:PERSON_ID, :QTY) RETURNING_VALUES ISSN_RESPONSE_TEXT;
         strAudit_Desc = 'Kitted field updated ' || :REFERENCE;
         EXECUTE PROCEDURE ADD_SSN_HIST(:strWH_ID, :strLOCN_ID, :OBJECT, :TRN_TYPE, :TRN_CODE, :TRN_DATE,
                                              :strAUDIT_DESC, :REFERENCE, :QTY, :PERSON_ID, :DEVICE_ID);
         EXECUTE PROCEDURE UPDATE_TRAN (:RECORD_ID, 'T', 'Processed successfully');
         EXIT;
    END
    
    IF (:TRN_TYPE = 'UIPC') THEN
    BEGIN
         IF (LEN(:REFERENCE) > 30) THEN
         BEGIN
              EXECUTE PROCEDURE UPDATE_TRAN (:RECORD_ID, 'F', 'LENGTH OF FIELD GREATER THAN 30');
              EXIT;
         END
         
       SELECT COUNT(*)
       FROM PROD_PROFILE
       WHERE PROD_ID = :REFERENCE
       INTO :PROD_EXIST;

       IF (PROD_EXIST = 0) THEN
       BEGIN
                 /* Add new SSN */
          EXECUTE PROCEDURE UPDATE_TRAN (:RECORD_ID, 'F', 'Invalid Product Code');
          EXIT;
       END



         EXECUTE PROCEDURE UPDATE_ISSN(:OBJECT, 'UIPC', :TRN_CODE, :REFERENCE, :TRN_DATE,:PERSON_ID, :QTY) RETURNING_VALUES ISSN_RESPONSE_TEXT;
         strAudit_Desc = 'Product ID field updated ' || :REFERENCE;
         EXECUTE PROCEDURE ADD_SSN_HIST(:strWH_ID, :strLOCN_ID, :OBJECT, :TRN_TYPE, :TRN_CODE, :TRN_DATE,
                                              :strAUDIT_DESC, :REFERENCE, :QTY, :PERSON_ID, :DEVICE_ID);
         EXECUTE PROCEDURE UPDATE_TRAN (:RECORD_ID, 'T', 'Processed successfully');
         EXIT;
    END
    
    IF (:TRN_TYPE = 'UIST') THEN
    BEGIN
         IF (LEN(:REFERENCE) > 2) THEN
         BEGIN
              EXECUTE PROCEDURE UPDATE_TRAN (:RECORD_ID, 'F', 'LENGTH OF FIELD GREATER THAN 2');
              EXIT;
         END

         EXECUTE PROCEDURE UPDATE_ISSN(:OBJECT, 'UIST', :TRN_CODE, :REFERENCE, :TRN_DATE,:PERSON_ID, :QTY) RETURNING_VALUES ISSN_RESPONSE_TEXT;
         strAudit_Desc = 'Issn Status field updated ' || :REFERENCE;
         EXECUTE PROCEDURE ADD_SSN_HIST(:strWH_ID, :strLOCN_ID, :OBJECT, :TRN_TYPE, :TRN_CODE, :TRN_DATE,
                                              :strAUDIT_DESC, :REFERENCE, :QTY, :PERSON_ID, :DEVICE_ID);
         EXECUTE PROCEDURE UPDATE_TRAN (:RECORD_ID, 'T', 'Processed successfully');
         EXIT;
    END
    
    
     IF (:TRN_TYPE = 'UIPT') THEN
    BEGIN

         EXECUTE PROCEDURE UPDATE_ISSN(:OBJECT, 'UIPT', :TRN_CODE, :REFERENCE, :TRN_DATE,:PERSON_ID, :QTY) RETURNING_VALUES ISSN_RESPONSE_TEXT;
         strAudit_Desc = 'ISSN Package Type field updated ' || :REFERENCE;
         EXECUTE PROCEDURE ADD_SSN_HIST(:strWH_ID, :strLOCN_ID, :OBJECT, :TRN_TYPE, :TRN_CODE, :TRN_DATE,
                                              :strAUDIT_DESC, :REFERENCE, :QTY, :PERSON_ID, :DEVICE_ID);
         EXECUTE PROCEDURE UPDATE_TRAN (:RECORD_ID, 'T', 'Processed successfully');
         EXIT;
    END


     IF (:TRN_TYPE = 'UILD') THEN
    BEGIN

         EXECUTE PROCEDURE UPDATE_ISSN(:OBJECT, 'UILD', :TRN_CODE, :REFERENCE, :TRN_DATE,:PERSON_ID, :QTY) RETURNING_VALUES ISSN_RESPONSE_TEXT;
         strAudit_Desc = 'ISSN Label Date field updated ' || :REFERENCE;
         EXECUTE PROCEDURE ADD_SSN_HIST(:strWH_ID, :strLOCN_ID, :OBJECT, :TRN_TYPE, :TRN_CODE, :TRN_DATE,
                                              :strAUDIT_DESC, :REFERENCE, :QTY, :PERSON_ID, :DEVICE_ID);
         EXECUTE PROCEDURE UPDATE_TRAN (:RECORD_ID, 'T', 'Processed successfully');
         EXIT;
    END
    
    /*
    UISS transaction is complex.
    Step 1: The easy bit unlike GRNV-P transaction is that we can assume that
           ssn exists. Creating the first ssn id is very difficult. I have copied
           the code from run_transaction_grnv - p trigger. add_ssn_issn_grnv procedure.
    Step 2: Then we generate the issn with the new ssn id.
    Step 3: Do we need to print the lablel. Ask Glen.
    
    */


     IF (:TRN_TYPE = 'UISS') THEN
    BEGIN



    
        SELECT CURRENT_QTY FROM ISSN
      WHERE SSN_ID = :OBJECT
      INTO :WK_CURRENT_QTY;
      
         IF (:WK_CURRENT_QTY < :QTY) THEN
         BEGIN
              EXECUTE PROCEDURE UPDATE_TRAN (:RECORD_ID, 'F', 'QUANTITY HAS TO BE LESS THAN ISSN CURRENT QUANTITY');
              EXIT;
         END
         



         EXECUTE PROCEDURE UPDATE_ISSN(:OBJECT, 'UISS', :TRN_CODE, :REFERENCE, :TRN_DATE,:PERSON_ID, :QTY) RETURNING_VALUES ISSN_RESPONSE_TEXT;


         strAudit_Desc = 'ISSN Split Completed ' || :OBJECT;
         

         EXECUTE PROCEDURE ADD_SSN_HIST(:strWH_ID, :strLOCN_ID, :OBJECT, :TRN_TYPE, :TRN_CODE, :TRN_DATE,
                                              :strAUDIT_DESC, :REFERENCE, :QTY, :PERSON_ID, :DEVICE_ID);
                                              

         /* strAudit_Desc = 'Processed successfully|' || ISSN_RESPONSE_TEXT; */
         strAudit_Desc = 'Processed successfully|' || ISSN_RESPONSE_TEXT || '|';
         EXECUTE PROCEDURE UPDATE_TRAN (:RECORD_ID, 'T', strAudit_Desc);
         EXIT;
         



    END

     IF (:TRN_TYPE = 'UICQ') THEN
    BEGIN

        WK_CURRENT_QTY = 0;
        SELECT CURRENT_QTY, ORIGINAL_SSN
        FROM ISSN
        WHERE SSN_ID = :OBJECT
        INTO :WK_CURRENT_QTY, :WK_SSN_ID;
        IF (WK_CURRENT_QTY IS NULL) THEN
        BEGIN
           WK_CURRENT_QTY = 0;
        END
      
         strAudit_Desc = 'ISSN change qty from ' || :WK_CURRENT_QTY;
         
         UPDATE ISSN SET PREV_QTY = CURRENT_QTY, CURRENT_QTY = :QTY
         WHERE SSN_ID = :OBJECT;

         UPDATE SSN SET CURRENT_QTY = CURRENT_QTY + :QTY - :WK_CURRENT_QTY
         WHERE SSN_ID = :WK_SSN_ID;

         EXECUTE PROCEDURE ADD_SSN_HIST(:strWH_ID, :strLOCN_ID, :OBJECT, :TRN_TYPE, :TRN_CODE, :TRN_DATE,
                                              :strAUDIT_DESC, :REFERENCE, :QTY, :PERSON_ID, :DEVICE_ID);
                                              

         strAudit_Desc = 'Processed successfully|' ;
         EXECUTE PROCEDURE UPDATE_TRAN (:RECORD_ID, 'T', strAudit_Desc);
         EXIT;
         
    END

   EXECUTE PROCEDURE UPDATE_TRAN (:RECORD_ID, 'F', 'Invalid Transaction Code');

END ^

ALTER PROCEDURE PC_WMAR (RECORD_ID INTEGER,
WH_ID CHAR(2) CHARACTER SET NONE,
LOCN_ID VARCHAR(10) CHARACTER SET NONE,
OBJECT VARCHAR(30) CHARACTER SET NONE,
TRN_TYPE VARCHAR(4) CHARACTER SET NONE,
TRN_CODE CHAR(1) CHARACTER SET NONE,
TRN_DATE TIMESTAMP,
REFERENCE VARCHAR(40) CHARACTER SET NONE,
QTY INTEGER,
PERSON_ID VARCHAR(10) CHARACTER SET NONE,
DEVICE_ID CHAR(2) CHARACTER SET NONE,
SUBLOCN_ID VARCHAR(10) CHARACTER SET NONE)
AS 
 
 
   
           
  DECLARE VARIABLE SSN_EXIST INTEGER; 
  DECLARE VARIABLE PARENT_SSN VARCHAR(22);
  DECLARE VARIABLE strAUDIT_DESC VARCHAR(50);
  
BEGIN
   SSN_EXIST = 0;
   PARENT_SSN = :WH_ID || :LOCN_ID || :SUBLOCN_ID;     
  
   /* Check SSN */
   SELECT 1
   FROM SSN
   WHERE SSN_ID = :OBJECT
   INTO :SSN_EXIST;

   /* If SSN does not exists, then exit */
   IF (SSN_EXIST = 0) THEN
   BEGIN
       /* Update transactions table */        
       EXECUTE PROCEDURE UPDATE_TRAN (:RECORD_ID, 'F', 'SSN is not in the database');
       EXIT;         
   END
   ELSE
   BEGIN
      /* Update Parent SSN */
      UPDATE SSN
      SET PARENT_SSN_ID = :PARENT_SSN
      WHERE SSN_ID = :OBJECT;

      /* Update transactions table */        
      EXECUTE PROCEDURE UPDATE_TRAN (:RECORD_ID, 'T', 'Processed successfully');

      strAUDIT_DESC = 'Add parent barcode ' || :PARENT_SSN;
      /* Add transaction history */                                                                                     
      EXECUTE PROCEDURE ADD_SSN_HIST(:WH_ID, :LOCN_ID, :OBJECT, :TRN_TYPE, :TRN_CODE, :TRN_DATE,
                                     :strAUDIT_DESC, :REFERENCE, :QTY, :PERSON_ID, :DEVICE_ID);

   END

   SUSPEND;
END ^

ALTER PROCEDURE PICK_ITEM_PROD_SEQ (WK_WH_ID CHAR(2) CHARACTER SET NONE,
WK_COMPANY VARCHAR(20) CHARACTER SET NONE,
WK_PROD_ID VARCHAR(30) CHARACTER SET NONE,
WK_SSN_ID VARCHAR(20) CHARACTER SET NONE)
RETURNS (WK_SEQ VARCHAR(30) CHARACTER SET NONE)
AS 
DECLARE VARIABLE WK_WORK_PROD_ID VARCHAR(30);
DECLARE VARIABLE WK_WORK_PROD_ID2 VARCHAR(30);
DECLARE VARIABLE WK_WORK_SSN_ID VARCHAR(20);
DECLARE VARIABLE WK_FOUND INTEGER;
DECLARE VARIABLE WK_RES INTEGER;
BEGIN
   /* initialize */
   /* add the restriction of issns in the products - so only for wh and company */
   WK_WORK_PROD_ID = '';
   WK_WORK_PROD_ID2 = '';
   WK_WORK_SSN_ID = '';
   WK_SEQ = '';
   IF (WK_SSN_ID IS NULL) THEN
   BEGIN
      WK_WORK_SSN_ID = '';
   END
   ELSE
   BEGIN
      WK_WORK_SSN_ID = WK_SSN_ID;
   END
   IF (WK_PROD_ID IS NULL) THEN
   BEGIN
      WK_WORK_PROD_ID = '';
   END
   ELSE
   BEGIN
      WK_WORK_PROD_ID = WK_PROD_ID;
   END
   /* get the seq */
   IF (WK_WORK_SSN_ID = '') THEN
   BEGIN
      /* product */
      IF (WK_WH_ID > '') THEN
      BEGIN
         IF (WK_COMPANY > '') THEN
         BEGIN
            SELECT FIRST 1 WH_ID || LOCN_ID 
            FROM ISSN 
            WHERE PROD_ID = :WK_WORK_PROD_ID
            AND WH_ID = :WK_WH_ID
            AND COMPANY_ID = :WK_COMPANY
            ORDER BY CREATE_DATE
            INTO :WK_SEQ;
         END
         ELSE
         BEGIN
            SELECT FIRST 1 WH_ID || LOCN_ID 
            FROM ISSN 
            WHERE PROD_ID = :WK_WORK_PROD_ID
            AND WH_ID = :WK_WH_ID
            ORDER BY CREATE_DATE
            INTO :WK_SEQ;
         END
      END
      ELSE
      BEGIN
         IF (WK_COMPANY > '') THEN
         BEGIN
            SELECT FIRST 1 WH_ID || LOCN_ID 
            FROM ISSN 
            WHERE PROD_ID = :WK_WORK_PROD_ID
            AND (WH_ID < 'X' OR WH_ID > 'X~')
            AND COMPANY_ID = :WK_COMPANY
            ORDER BY CREATE_DATE
            INTO :WK_SEQ;
         END
         ELSE
         BEGIN
            SELECT FIRST 1 WH_ID || LOCN_ID 
            FROM ISSN 
            WHERE PROD_ID = :WK_WORK_PROD_ID
            AND (WH_ID < 'X' OR WH_ID > 'X~')
            ORDER BY CREATE_DATE
            INTO :WK_SEQ;
         END
      END
   END
   ELSE
   BEGIN
      /* try the ssn */
      SELECT PROD_ID FROM ISSN WHERE SSN_ID = :WK_WORK_SSN_ID
      INTO :WK_WORK_PROD_ID2;
      IF (WK_WORK_PROD_ID2 IS NULL) THEN
      BEGIN
         /* no product for ssn */
         SELECT WH_ID || LOCN_ID FROM ISSN WHERE SSN_ID = :WK_WORK_SSN_ID
         INTO :WK_SEQ;
      END
      ELSE
      BEGIN
         /* use the product from the issn */
         IF (WK_WH_ID > '') THEN
         BEGIN
            IF (WK_COMPANY > '') THEN
            BEGIN
               SELECT FIRST 1 WH_ID || LOCN_ID 
               FROM ISSN 
               WHERE PROD_ID = :WK_WORK_PROD_ID2
               AND WH_ID = :WK_WH_ID
               AND COMPANY_ID = :WK_COMPANY
               ORDER BY CREATE_DATE
               INTO :WK_SEQ;
            END
            ELSE
            BEGIN
               SELECT FIRST 1 WH_ID || LOCN_ID 
               FROM ISSN 
               WHERE PROD_ID = :WK_WORK_PROD_ID2
               AND WH_ID = :WK_WH_ID
               ORDER BY CREATE_DATE
               INTO :WK_SEQ;
            END
         END
         ELSE
         BEGIN
            IF (WK_COMPANY > '') THEN
            BEGIN
               SELECT FIRST 1 WH_ID || LOCN_ID 
               FROM ISSN 
               WHERE PROD_ID = :WK_WORK_PROD_ID2
               AND (WH_ID < 'X' OR WH_ID > 'X~')
               AND COMPANY_ID = :WK_COMPANY
               ORDER BY CREATE_DATE
               INTO :WK_SEQ;
            END
            ELSE
            BEGIN
               SELECT FIRST 1 WH_ID || LOCN_ID 
               FROM ISSN 
               WHERE PROD_ID = :WK_WORK_PROD_ID2
               AND (WH_ID < 'X' OR WH_ID > 'X~')
               ORDER BY CREATE_DATE
               INTO :WK_SEQ;
            END
         END
      END
   END
   SUSPEND;

END ^

ALTER PROCEDURE PICK_MODE_P1 (WK_ORDER_TYPES VARCHAR(255) CHARACTER SET NONE,
WK_ORDER_MODES VARCHAR(255) CHARACTER SET NONE,
WK_ORDERS VARCHAR(255) CHARACTER SET NONE,
WK_ORDER_STATUSES VARCHAR(255) CHARACTER SET NONE,
WK_ORDER_PRIORITYS VARCHAR(255) CHARACTER SET NONE,
WK_PARAM_IDS VARCHAR(255) CHARACTER SET NONE)
RETURNS (WK_ORDER VARCHAR(15) CHARACTER SET NONE)
AS 
 
 
DECLARE VARIABLE WK_DELIM CHAR(1);
DECLARE VARIABLE WK_FOUND INTEGER;
DECLARE VARIABLE WK_ORDER_TYPE1 VARCHAR(10);
DECLARE VARIABLE WK_ORDER_TYPE2 VARCHAR(10);
DECLARE VARIABLE WK_ORDER_TYPE3 VARCHAR(10);
DECLARE VARIABLE WK_ORDER_TYPE4 VARCHAR(10);
DECLARE VARIABLE WK_ORDER_TYPE5 VARCHAR(10);
DECLARE VARIABLE WK_TYPE_CNT INTEGER;
DECLARE VARIABLE WK_ORDER_STATUS1 VARCHAR(10);
DECLARE VARIABLE WK_ORDER_STATUS2 VARCHAR(10);
DECLARE VARIABLE WK_ORDER_STATUS3 VARCHAR(10);
DECLARE VARIABLE WK_ORDER_STATUS4 VARCHAR(10);
DECLARE VARIABLE WK_ORDER_STATUS5 VARCHAR(10);
DECLARE VARIABLE WK_STATUS_CNT INTEGER;
DECLARE VARIABLE WK_PRIORITY1 INTEGER;
DECLARE VARIABLE WK_PRIORITY2 INTEGER;
DECLARE VARIABLE WK_PRIORITY3 INTEGER;
DECLARE VARIABLE WK_PRIORITY4 INTEGER;
DECLARE VARIABLE WK_PRIORITY5 INTEGER;
DECLARE VARIABLE WK_PRIORITY_CNT INTEGER;
DECLARE VARIABLE WK_ORDER_CNT INTEGER;
DECLARE VARIABLE WK_IDX INTEGER;
DECLARE VARIABLE WK_COND VARCHAR(35);
DECLARE VARIABLE WK_ORDER1 VARCHAR(15);
DECLARE VARIABLE WK_ORDER2 VARCHAR(15);
DECLARE VARIABLE WK_ORDER3 VARCHAR(15);
DECLARE VARIABLE WK_ORDER4 VARCHAR(15);
DECLARE VARIABLE WK_ORDER5 VARCHAR(15);
DECLARE VARIABLE WK_ORDER6 VARCHAR(15);
DECLARE VARIABLE WK_ORDER7 VARCHAR(15);
DECLARE VARIABLE WK_ORDER8 VARCHAR(15);
DECLARE VARIABLE WK_ORDER9 VARCHAR(15);
DECLARE VARIABLE WK_ORDER10 VARCHAR(15);
DECLARE VARIABLE WK_ORDER11 VARCHAR(15);
DECLARE VARIABLE WK_ORDER12 VARCHAR(15);
DECLARE VARIABLE WK_ORDER13 VARCHAR(15);
DECLARE VARIABLE WK_ORDER14 VARCHAR(15);
DECLARE VARIABLE WK_ORDER15 VARCHAR(15);
DECLARE VARIABLE WK_ORDER16 VARCHAR(15);
DECLARE VARIABLE WK_ORDER17 VARCHAR(15);
DECLARE VARIABLE WK_ORDER18 VARCHAR(15);
DECLARE VARIABLE WK_ORDER19 VARCHAR(15);
DECLARE VARIABLE WK_ORDER20 VARCHAR(15);

BEGIN
   WK_DELIM = '|';
   WK_ORDER_TYPE1 = '';
   WK_ORDER_TYPE2 = '';
   WK_ORDER_TYPE3 = '';
   WK_ORDER_TYPE4 = '';
   WK_ORDER_TYPE5 = '';
   WK_ORDER_STATUS1 = '';
   WK_ORDER_STATUS2 = '';
   WK_ORDER_STATUS3 = '';
   WK_ORDER_STATUS4 = '';
   WK_ORDER_STATUS5 = '';
   WK_ORDER1 = '';
   WK_ORDER2 = '';
   WK_ORDER3 = '';
   WK_ORDER4 = '';
   WK_ORDER5 = '';
   WK_ORDER6 = '';
   WK_ORDER7 = '';
   WK_ORDER8 = '';
   WK_ORDER9 = '';
   WK_ORDER10 = '';
   WK_ORDER11 = '';
   WK_ORDER12 = '';
   WK_ORDER13 = '';
   WK_ORDER14 = '';
   WK_ORDER15 = '';
   WK_ORDER16 = '';
   WK_ORDER17 = '';
   WK_ORDER18 = '';
   WK_ORDER19 = '';
   WK_ORDER20 = '';
   WK_PRIORITY1 = -32000;
   WK_PRIORITY2 = -32000;
   WK_PRIORITY3 = -32000;
   WK_PRIORITY4 = -32000;
   WK_PRIORITY5 = -32000;
   /* normally only one order type but glen wants several or GETALL */
   IF (WK_ORDER_TYPES = 'GETALL') THEN
   BEGIN
      WK_ORDER_TYPE1 = 'GETALL';
      WK_TYPE_CNT = 1;
   END
   ELSE
   BEGIN
      /* allow up to 5 types */
      WK_TYPE_CNT = 0;
      WK_IDX = 1;
      WK_COND = ALLTRIM(PARSE(:WK_ORDER_TYPES,:WK_DELIM,:WK_IDX));
      WHILE (WK_COND <> 'Token to long in parse') DO 
      BEGIN
         WK_TYPE_CNT = WK_TYPE_CNT + 1;
         IF (WK_TYPE_CNT = 1) THEN
            WK_ORDER_TYPE1 = WK_COND;
         ELSE
         IF (WK_TYPE_CNT = 2) THEN
            WK_ORDER_TYPE2 = WK_COND;
         ELSE
         IF (WK_TYPE_CNT = 3) THEN
            WK_ORDER_TYPE3 = WK_COND;
         ELSE
         IF (WK_TYPE_CNT = 4) THEN
            WK_ORDER_TYPE4 = WK_COND;
         ELSE
         IF (WK_TYPE_CNT = 5) THEN
            WK_ORDER_TYPE5 = WK_COND;
         /* get next type */
         WK_IDX = WK_IDX + 1;
         WK_COND = ALLTRIM(PARSE(:WK_ORDER_TYPES,:WK_DELIM,:WK_IDX));
      END
   END

   /* normally GETALL in the mode - unused field */

   /* order statuses - why this ?? - must be confirmed lines OP or UP */
   IF (WK_ORDER_STATUSES = 'GETALL') THEN
   BEGIN
      WK_ORDER_STATUS1 = 'GETALL';
      WK_STATUS_CNT = 1;
   END
   ELSE
   BEGIN
      /* allow up to 5 STATUSs */
      WK_STATUS_CNT = 0;
      WK_IDX = 1;
      WK_COND = ALLTRIM(PARSE(:WK_ORDER_STATUSES,:WK_DELIM,:WK_IDX));
      WHILE (WK_COND <> 'Token to long in parse') DO 
      BEGIN
         WK_STATUS_CNT = WK_STATUS_CNT + 1;
         IF (WK_STATUS_CNT = 1) THEN
            WK_ORDER_STATUS1 = WK_COND;
         ELSE
         IF (WK_STATUS_CNT = 2) THEN
            WK_ORDER_STATUS2 = WK_COND;
         ELSE
         IF (WK_STATUS_CNT = 3) THEN
            WK_ORDER_STATUS3 = WK_COND;
         ELSE
         IF (WK_STATUS_CNT = 4) THEN
            WK_ORDER_STATUS4 = WK_COND;
         ELSE
         IF (WK_STATUS_CNT = 5) THEN
            WK_ORDER_STATUS5 = WK_COND;
         /* get next STATUS */
         WK_IDX = WK_IDX + 1;
         WK_COND = ALLTRIM(PARSE(:WK_ORDER_STATUSES,:WK_DELIM,:WK_IDX));
      END
   END

   /* ordno is a list of orders or GETALL */
   /* orders are length 9 or 10 for internal */
   /* so can have a maximum of 255 = (1 + n*10) */   
   /* thus n = 25 */
   /* calc orders 1 - 25 */
   /* but only allow upto 20 */
   IF (WK_ORDERS = 'GETALL') THEN
   BEGIN
      WK_ORDER1 = 'GETALL';
      WK_ORDER_CNT = 1;
   END
   ELSE
   BEGIN
      WK_ORDER_CNT = 0;
      WK_IDX = 1;
      WK_COND = ALLTRIM(PARSE(:WK_ORDERS,:WK_DELIM,:WK_IDX));
      WHILE (WK_COND <> 'Token to long in parse') DO 
      BEGIN
         WK_ORDER_CNT = WK_ORDER_CNT + 1;
         IF (WK_ORDER_CNT = 1) THEN
            WK_ORDER1 = WK_COND;
         ELSE
         IF (WK_ORDER_CNT = 2) THEN
            WK_ORDER2 = WK_COND;
         ELSE
         IF (WK_ORDER_CNT = 3) THEN
            WK_ORDER3 = WK_COND;
         ELSE
         IF (WK_ORDER_CNT = 4) THEN
            WK_ORDER4 = WK_COND;
         ELSE
         IF (WK_ORDER_CNT = 5) THEN
            WK_ORDER5 = WK_COND;
         ELSE
         IF (WK_ORDER_CNT = 6) THEN
            WK_ORDER6 = WK_COND;
         ELSE
         IF (WK_ORDER_CNT = 7) THEN
            WK_ORDER7 = WK_COND;
         ELSE
         IF (WK_ORDER_CNT = 8) THEN
            WK_ORDER8 = WK_COND;
         ELSE
         IF (WK_ORDER_CNT = 9) THEN
            WK_ORDER9 = WK_COND;
         ELSE
         IF (WK_ORDER_CNT = 10) THEN
            WK_ORDER10 = WK_COND;
         ELSE
         IF (WK_ORDER_CNT = 11) THEN
            WK_ORDER11 = WK_COND;
         ELSE
         IF (WK_ORDER_CNT = 12) THEN
            WK_ORDER12 = WK_COND;
         ELSE
         IF (WK_ORDER_CNT = 13) THEN
            WK_ORDER13 = WK_COND;
         ELSE
         IF (WK_ORDER_CNT = 14) THEN
            WK_ORDER14 = WK_COND;
         ELSE
         IF (WK_ORDER_CNT = 15) THEN
            WK_ORDER15 = WK_COND;
         ELSE
         IF (WK_ORDER_CNT = 16) THEN
            WK_ORDER16 = WK_COND;
         ELSE
         IF (WK_ORDER_CNT = 17) THEN
            WK_ORDER17 = WK_COND;
         ELSE
         IF (WK_ORDER_CNT = 18) THEN
            WK_ORDER18 = WK_COND;
         ELSE
         IF (WK_ORDER_CNT = 19) THEN
            WK_ORDER19 = WK_COND;
         ELSE
         IF (WK_ORDER_CNT = 20) THEN
            WK_ORDER20 = WK_COND;
         /* get next order */
         WK_IDX = WK_IDX + 1;
         WK_COND = ALLTRIM(PARSE(:WK_ORDERS,:WK_DELIM,:WK_IDX));
      END
   END

   /* order priorities 0 = GETALL or a specific priority */
   /* priorities are small int - range -32768 - +32767 */
   /* but really 0 - 9 and -9 - -1 since a 1 char display */
   /* so a max of 19 */
   /* but only allow upto 2 */

   IF (WK_ORDER_PRIORITYS = 'GETALL') THEN
   BEGIN
      WK_PRIORITY1 = 0;
      WK_STATUS_CNT = 1;
   END
   ELSE
   BEGIN
      /* allow up to 2 Prioritys */
      WK_PRIORITY_CNT = 0;
      WK_IDX = 1;
      WK_COND = ALLTRIM(PARSE(:WK_ORDER_PRIORITYS,:WK_DELIM,:WK_IDX));
      WHILE (WK_COND <> 'Token to long in parse') DO 
      BEGIN
         WK_PRIORITY_CNT = WK_PRIORITY_CNT + 1;
         IF (WK_PRIORITY_CNT = 1) THEN
            WK_PRIORITY1 = WK_COND;
         ELSE
         IF (WK_PRIORITY_CNT = 2) THEN
            WK_PRIORITY2 = WK_COND;
         ELSE
         IF (WK_PRIORITY_CNT = 3) THEN
            WK_PRIORITY3 = WK_COND;
         ELSE
         IF (WK_PRIORITY_CNT = 4) THEN
            WK_PRIORITY4 = WK_COND;
         ELSE
         IF (WK_PRIORITY_CNT = 5) THEN
            WK_PRIORITY5 = WK_COND;
         /* get next Priority */
         WK_IDX = WK_IDX + 1;
         WK_COND = ALLTRIM(PARSE(:WK_ORDER_PRIORITYS,:WK_DELIM,:WK_IDX));
      END
   END

   /* parms for a specifiy procedure either GETALL or a LIST */
   /* for P1 this is GETALL */

   IF ((WK_ORDER1 = 'GETALL') AND
       (WK_ORDER_TYPE1 = 'GETALL') AND
       (WK_ORDER_STATUS1 = 'GETALL') AND
       (WK_PRIORITY1 = 0)) THEN
   BEGIN
      FOR 
         SELECT P1.PICK_ORDER 
         FROM PICK_ITEM P1 
             JOIN PICK_ORDER P2 ON P2.PICK_ORDER = P1.PICK_ORDER 
         WHERE P1.PICK_LINE_STATUS IN ('OP','UP') 
           AND  P1.PICK_ORDER_QTY > 0   
           AND P2.PICK_STATUS IN ('OP','DA')
           GROUP BY P1.PICK_ORDER
           ORDER BY P2.PICK_PRIORITY, P2.WIP_ORDERING, P1.WIP_PRELOCN_ORDERING, P1.PICK_LOCATION, P1.WIP_POSTLOCN_ORDERING 
         INTO :WK_ORDER 
      DO
      BEGIN
         SUSPEND;
      END
   END
   ELSE
   IF ((WK_ORDER1 = 'GETALL') AND
       (WK_ORDER_TYPE1 = 'GETALL') AND
       (WK_ORDER_STATUS1 = 'GETALL') AND
       (WK_PRIORITY_CNT > 0)) THEN
   BEGIN
      FOR 
         SELECT P1.PICK_ORDER 
         FROM PICK_ITEM P1 
             JOIN PICK_ORDER P2 ON P2.PICK_ORDER = P1.PICK_ORDER 
         WHERE P1.PICK_LINE_STATUS IN ('OP','UP') 
           AND  P1.PICK_ORDER_QTY > 0   
           AND P2.PICK_STATUS IN ('OP','DA')
           AND (P2.PICK_PRIORITY = :WK_PRIORITY1 
                OR P2.PICK_PRIORITY = :WK_PRIORITY2
                OR P2.PICK_PRIORITY = :WK_PRIORITY3
                OR P2.PICK_PRIORITY = :WK_PRIORITY4
                OR P2.PICK_PRIORITY = :WK_PRIORITY5)
           GROUP BY P1.PICK_ORDER
           ORDER BY P2.PICK_PRIORITY, P2.WIP_ORDERING, P1.WIP_PRELOCN_ORDERING, P1.PICK_LOCATION, P1.WIP_POSTLOCN_ORDERING 
         INTO :WK_ORDER 
      DO
      BEGIN
         SUSPEND;
      END
   END
   ELSE
   IF ((WK_ORDER1 = 'GETALL') AND
       (WK_ORDER_TYPE1 = 'GETALL') AND
       (WK_STATUS_CNT > 0) AND
       (WK_PRIORITY1 = 0)) THEN
   BEGIN
      FOR 
         SELECT P1.PICK_ORDER 
         FROM PICK_ITEM P1 
             JOIN PICK_ORDER P2 ON P2.PICK_ORDER = P1.PICK_ORDER 
         WHERE (P1.PICK_LINE_STATUS = :WK_ORDER_STATUS1 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS2 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS3 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS4 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS5) 
           AND  P1.PICK_ORDER_QTY > 0   
           AND P2.PICK_STATUS IN ('OP','DA')
           GROUP BY P1.PICK_ORDER
           ORDER BY P2.PICK_PRIORITY, P2.WIP_ORDERING, P1.WIP_PRELOCN_ORDERING, P1.PICK_LOCATION, P1.WIP_POSTLOCN_ORDERING 
         INTO :WK_ORDER 
      DO
      BEGIN
         SUSPEND;
      END
   END
   ELSE
   IF ((WK_ORDER1 = 'GETALL') AND
       (WK_ORDER_TYPE1 = 'GETALL') AND
       (WK_STATUS_CNT > 0) AND
       (WK_PRIORITY_CNT > 0)) THEN
   BEGIN
      FOR 
         SELECT P1.PICK_ORDER 
         FROM PICK_ITEM P1 
             JOIN PICK_ORDER P2 ON P2.PICK_ORDER = P1.PICK_ORDER 
         WHERE (P1.PICK_LINE_STATUS = :WK_ORDER_STATUS1 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS2 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS3 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS4 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS5) 
           AND  P1.PICK_ORDER_QTY > 0   
           AND P2.PICK_STATUS IN ('OP','DA')
           AND (P2.PICK_PRIORITY = :WK_PRIORITY1 
                OR P2.PICK_PRIORITY = :WK_PRIORITY2
                OR P2.PICK_PRIORITY = :WK_PRIORITY3
                OR P2.PICK_PRIORITY = :WK_PRIORITY4
                OR P2.PICK_PRIORITY = :WK_PRIORITY5)
           GROUP BY P1.PICK_ORDER
           ORDER BY P2.PICK_PRIORITY, P2.WIP_ORDERING, P1.WIP_PRELOCN_ORDERING, P1.PICK_LOCATION, P1.WIP_POSTLOCN_ORDERING 
         INTO :WK_ORDER 
      DO
      BEGIN
         SUSPEND;
      END
   END
   ELSE
   IF ((WK_ORDER1 = 'GETALL') AND
       (WK_TYPE_CNT > 0) AND
       (WK_ORDER_STATUS1 = 'GETALL') AND
       (WK_PRIORITY1 = 0)) THEN
   BEGIN
      FOR 
         SELECT P1.PICK_ORDER 
         FROM PICK_ITEM P1 
             JOIN PICK_ORDER P2 ON P2.PICK_ORDER = P1.PICK_ORDER 
         WHERE P1.PICK_LINE_STATUS IN ('OP','UP') 
           AND  P1.PICK_ORDER_QTY > 0   
           AND P2.PICK_STATUS IN ('OP','DA')
           AND (P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE1
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE2
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE3
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE4
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE5)
           GROUP BY P1.PICK_ORDER
           ORDER BY P2.PICK_PRIORITY, P2.WIP_ORDERING, P1.WIP_PRELOCN_ORDERING, P1.PICK_LOCATION, P1.WIP_POSTLOCN_ORDERING 
         INTO :WK_ORDER 
      DO
      BEGIN
         SUSPEND;
      END
   END
   ELSE
   IF ((WK_ORDER1 = 'GETALL') AND
       (WK_TYPE_CNT > 0) AND
       (WK_ORDER_STATUS1 = 'GETALL') AND
       (WK_PRIORITY_CNT > 0)) THEN
   BEGIN
      FOR 
         SELECT P1.PICK_ORDER 
         FROM PICK_ITEM P1 
             JOIN PICK_ORDER P2 ON P2.PICK_ORDER = P1.PICK_ORDER 
         WHERE P1.PICK_LINE_STATUS IN ('OP','UP') 
           AND  P1.PICK_ORDER_QTY > 0   
           AND P2.PICK_STATUS IN ('OP','DA')
           AND (P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE1
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE2
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE3
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE4
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE5)
           AND (P2.PICK_PRIORITY = :WK_PRIORITY1 
                OR P2.PICK_PRIORITY = :WK_PRIORITY2
                OR P2.PICK_PRIORITY = :WK_PRIORITY3
                OR P2.PICK_PRIORITY = :WK_PRIORITY4
                OR P2.PICK_PRIORITY = :WK_PRIORITY5)
           GROUP BY P1.PICK_ORDER
           ORDER BY P2.PICK_PRIORITY, P2.WIP_ORDERING, P1.WIP_PRELOCN_ORDERING, P1.PICK_LOCATION, P1.WIP_POSTLOCN_ORDERING 
         INTO :WK_ORDER 
      DO
      BEGIN
         SUSPEND;
      END
   END
   ELSE
   IF ((WK_ORDER1 = 'GETALL') AND
       (WK_TYPE_CNT > 0) AND
       (WK_STATUS_CNT > 0) AND
       (WK_PRIORITY1 = 0)) THEN
   BEGIN
      FOR 
         SELECT P1.PICK_ORDER 
         FROM PICK_ITEM P1 
             JOIN PICK_ORDER P2 ON P2.PICK_ORDER = P1.PICK_ORDER 
         WHERE (P1.PICK_LINE_STATUS = :WK_ORDER_STATUS1 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS2 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS3 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS4 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS5) 
           AND  P1.PICK_ORDER_QTY > 0   
           AND P2.PICK_STATUS IN ('OP','DA')
           AND (P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE1
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE2
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE3
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE4
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE5)
           GROUP BY P1.PICK_ORDER
           ORDER BY P2.PICK_PRIORITY, P2.WIP_ORDERING, P1.WIP_PRELOCN_ORDERING, P1.PICK_LOCATION, P1.WIP_POSTLOCN_ORDERING 
         INTO :WK_ORDER 
      DO
      BEGIN
         SUSPEND;
      END
   END
   ELSE
   IF ((WK_ORDER1 = 'GETALL') AND
       (WK_TYPE_CNT > 0) AND
       (WK_STATUS_CNT > 0) AND
       (WK_PRIORITY_CNT > 0)) THEN
   BEGIN
      FOR 
         SELECT P1.PICK_ORDER 
         FROM PICK_ITEM P1 
             JOIN PICK_ORDER P2 ON P2.PICK_ORDER = P1.PICK_ORDER 
         WHERE (P1.PICK_LINE_STATUS = :WK_ORDER_STATUS1 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS2 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS3 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS4 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS5) 
           AND  P1.PICK_ORDER_QTY > 0   
           AND P2.PICK_STATUS IN ('OP','DA')
           AND (P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE1
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE2
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE3
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE4
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE5)
           AND (P2.PICK_PRIORITY = :WK_PRIORITY1 
                OR P2.PICK_PRIORITY = :WK_PRIORITY2
                OR P2.PICK_PRIORITY = :WK_PRIORITY3
                OR P2.PICK_PRIORITY = :WK_PRIORITY4
                OR P2.PICK_PRIORITY = :WK_PRIORITY5)
           GROUP BY P1.PICK_ORDER
           ORDER BY P2.PICK_PRIORITY, P2.WIP_ORDERING, P1.WIP_PRELOCN_ORDERING, P1.PICK_LOCATION, P1.WIP_POSTLOCN_ORDERING 
         INTO :WK_ORDER 
      DO
      BEGIN
         SUSPEND;
      END
   END
   ELSE
   IF ((WK_ORDER_CNT > 0) AND
       (WK_ORDER_TYPE1 = 'GETALL') AND
       (WK_ORDER_STATUS1 = 'GETALL') AND
       (WK_PRIORITY1 = 0)) THEN
   BEGIN
      FOR 
         SELECT P1.PICK_ORDER 
         FROM PICK_ITEM P1 
             JOIN PICK_ORDER P2 ON P2.PICK_ORDER = P1.PICK_ORDER 
         WHERE P1.PICK_LINE_STATUS IN ('OP','UP') 
           AND  P1.PICK_ORDER_QTY > 0   
           AND (P1.PICK_ORDER = :WK_ORDER1
                OR P1.PICK_ORDER = :WK_ORDER2
                OR P1.PICK_ORDER = :WK_ORDER3
                OR P1.PICK_ORDER = :WK_ORDER4
                OR P1.PICK_ORDER = :WK_ORDER5
                OR P1.PICK_ORDER = :WK_ORDER6
                OR P1.PICK_ORDER = :WK_ORDER7
                OR P1.PICK_ORDER = :WK_ORDER8
                OR P1.PICK_ORDER = :WK_ORDER9
                OR P1.PICK_ORDER = :WK_ORDER10
                OR P1.PICK_ORDER = :WK_ORDER11
                OR P1.PICK_ORDER = :WK_ORDER12
                OR P1.PICK_ORDER = :WK_ORDER13
                OR P1.PICK_ORDER = :WK_ORDER14
                OR P1.PICK_ORDER = :WK_ORDER15
                OR P1.PICK_ORDER = :WK_ORDER16
                OR P1.PICK_ORDER = :WK_ORDER17
                OR P1.PICK_ORDER = :WK_ORDER18
                OR P1.PICK_ORDER = :WK_ORDER19
                OR P1.PICK_ORDER = :WK_ORDER20)
           AND P2.PICK_STATUS IN ('OP','DA')
           GROUP BY P1.PICK_ORDER
           ORDER BY P2.PICK_PRIORITY, P2.WIP_ORDERING, P1.WIP_PRELOCN_ORDERING, P1.PICK_LOCATION, P1.WIP_POSTLOCN_ORDERING 
         INTO :WK_ORDER 
      DO
      BEGIN
         SUSPEND;
      END
   END
   ELSE
   IF ((WK_ORDER_CNT > 0) AND
       (WK_ORDER_TYPE1 = 'GETALL') AND
       (WK_ORDER_STATUS1 = 'GETALL') AND
       (WK_PRIORITY_CNT > 0)) THEN
   BEGIN
      FOR 
         SELECT P1.PICK_ORDER 
         FROM PICK_ITEM P1 
             JOIN PICK_ORDER P2 ON P2.PICK_ORDER = P1.PICK_ORDER 
         WHERE P1.PICK_LINE_STATUS IN ('OP','UP') 
           AND (P1.PICK_ORDER = :WK_ORDER1
                OR P1.PICK_ORDER = :WK_ORDER2
                OR P1.PICK_ORDER = :WK_ORDER3
                OR P1.PICK_ORDER = :WK_ORDER4
                OR P1.PICK_ORDER = :WK_ORDER5
                OR P1.PICK_ORDER = :WK_ORDER6
                OR P1.PICK_ORDER = :WK_ORDER7
                OR P1.PICK_ORDER = :WK_ORDER8
                OR P1.PICK_ORDER = :WK_ORDER9
                OR P1.PICK_ORDER = :WK_ORDER10
                OR P1.PICK_ORDER = :WK_ORDER11
                OR P1.PICK_ORDER = :WK_ORDER12
                OR P1.PICK_ORDER = :WK_ORDER13
                OR P1.PICK_ORDER = :WK_ORDER14
                OR P1.PICK_ORDER = :WK_ORDER15
                OR P1.PICK_ORDER = :WK_ORDER16
                OR P1.PICK_ORDER = :WK_ORDER17
                OR P1.PICK_ORDER = :WK_ORDER18
                OR P1.PICK_ORDER = :WK_ORDER19
                OR P1.PICK_ORDER = :WK_ORDER20)
           AND  P1.PICK_ORDER_QTY > 0   
           AND P2.PICK_STATUS IN ('OP','DA')
           AND (P2.PICK_PRIORITY = :WK_PRIORITY1 
                OR P2.PICK_PRIORITY = :WK_PRIORITY2
                OR P2.PICK_PRIORITY = :WK_PRIORITY3
                OR P2.PICK_PRIORITY = :WK_PRIORITY4
                OR P2.PICK_PRIORITY = :WK_PRIORITY5)
           GROUP BY P1.PICK_ORDER
           ORDER BY P2.PICK_PRIORITY, P2.WIP_ORDERING, P1.WIP_PRELOCN_ORDERING, P1.PICK_LOCATION, P1.WIP_POSTLOCN_ORDERING 
         INTO :WK_ORDER 
      DO
      BEGIN
         SUSPEND;
      END
   END
   ELSE
   IF ((WK_ORDER_CNT > 0) AND
       (WK_ORDER_TYPE1 = 'GETALL') AND
       (WK_STATUS_CNT > 0) AND
       (WK_PRIORITY1 = 0)) THEN
   BEGIN
      FOR 
         SELECT P1.PICK_ORDER 
         FROM PICK_ITEM P1 
             JOIN PICK_ORDER P2 ON P2.PICK_ORDER = P1.PICK_ORDER 
         WHERE (P1.PICK_LINE_STATUS = :WK_ORDER_STATUS1 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS2 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS3 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS4 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS5) 
           AND (P1.PICK_ORDER = :WK_ORDER1
                OR P1.PICK_ORDER = :WK_ORDER2
                OR P1.PICK_ORDER = :WK_ORDER3
                OR P1.PICK_ORDER = :WK_ORDER4
                OR P1.PICK_ORDER = :WK_ORDER5
                OR P1.PICK_ORDER = :WK_ORDER6
                OR P1.PICK_ORDER = :WK_ORDER7
                OR P1.PICK_ORDER = :WK_ORDER8
                OR P1.PICK_ORDER = :WK_ORDER9
                OR P1.PICK_ORDER = :WK_ORDER10
                OR P1.PICK_ORDER = :WK_ORDER11
                OR P1.PICK_ORDER = :WK_ORDER12
                OR P1.PICK_ORDER = :WK_ORDER13
                OR P1.PICK_ORDER = :WK_ORDER14
                OR P1.PICK_ORDER = :WK_ORDER15
                OR P1.PICK_ORDER = :WK_ORDER16
                OR P1.PICK_ORDER = :WK_ORDER17
                OR P1.PICK_ORDER = :WK_ORDER18
                OR P1.PICK_ORDER = :WK_ORDER19
                OR P1.PICK_ORDER = :WK_ORDER20)
           AND  P1.PICK_ORDER_QTY > 0   
           AND P2.PICK_STATUS IN ('OP','DA')
           GROUP BY P1.PICK_ORDER
           ORDER BY P2.PICK_PRIORITY, P2.WIP_ORDERING, P1.WIP_PRELOCN_ORDERING, P1.PICK_LOCATION, P1.WIP_POSTLOCN_ORDERING 
         INTO :WK_ORDER 
      DO
      BEGIN
         SUSPEND;
      END
   END
   ELSE
   IF ((WK_ORDER_CNT > 0) AND
       (WK_ORDER_TYPE1 = 'GETALL') AND
       (WK_STATUS_CNT > 0) AND
       (WK_PRIORITY_CNT > 0)) THEN
   BEGIN
      FOR 
         SELECT P1.PICK_ORDER 
         FROM PICK_ITEM P1 
             JOIN PICK_ORDER P2 ON P2.PICK_ORDER = P1.PICK_ORDER 
         WHERE (P1.PICK_LINE_STATUS = :WK_ORDER_STATUS1 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS2 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS3 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS4 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS5) 
           AND (P1.PICK_ORDER = :WK_ORDER1
                OR P1.PICK_ORDER = :WK_ORDER2
                OR P1.PICK_ORDER = :WK_ORDER3
                OR P1.PICK_ORDER = :WK_ORDER4
                OR P1.PICK_ORDER = :WK_ORDER5
                OR P1.PICK_ORDER = :WK_ORDER6
                OR P1.PICK_ORDER = :WK_ORDER7
                OR P1.PICK_ORDER = :WK_ORDER8
                OR P1.PICK_ORDER = :WK_ORDER9
                OR P1.PICK_ORDER = :WK_ORDER10
                OR P1.PICK_ORDER = :WK_ORDER11
                OR P1.PICK_ORDER = :WK_ORDER12
                OR P1.PICK_ORDER = :WK_ORDER13
                OR P1.PICK_ORDER = :WK_ORDER14
                OR P1.PICK_ORDER = :WK_ORDER15
                OR P1.PICK_ORDER = :WK_ORDER16
                OR P1.PICK_ORDER = :WK_ORDER17
                OR P1.PICK_ORDER = :WK_ORDER18
                OR P1.PICK_ORDER = :WK_ORDER19
                OR P1.PICK_ORDER = :WK_ORDER20)
           AND  P1.PICK_ORDER_QTY > 0   
           AND P2.PICK_STATUS IN ('OP','DA')
           AND (P2.PICK_PRIORITY = :WK_PRIORITY1 
                OR P2.PICK_PRIORITY = :WK_PRIORITY2
                OR P2.PICK_PRIORITY = :WK_PRIORITY3
                OR P2.PICK_PRIORITY = :WK_PRIORITY4
                OR P2.PICK_PRIORITY = :WK_PRIORITY5)
           GROUP BY P1.PICK_ORDER
           ORDER BY P2.PICK_PRIORITY, P2.WIP_ORDERING, P1.WIP_PRELOCN_ORDERING, P1.PICK_LOCATION, P1.WIP_POSTLOCN_ORDERING 
         INTO :WK_ORDER 
      DO
      BEGIN
         SUSPEND;
      END
   END
   ELSE
   IF ((WK_ORDER_CNT > 0) AND
       (WK_TYPE_CNT > 0) AND
       (WK_ORDER_STATUS1 = 'GETALL') AND
       (WK_PRIORITY1 = 0)) THEN
   BEGIN
      FOR 
         SELECT P1.PICK_ORDER 
         FROM PICK_ITEM P1 
             JOIN PICK_ORDER P2 ON P2.PICK_ORDER = P1.PICK_ORDER 
         WHERE P1.PICK_LINE_STATUS IN ('OP','UP') 
           AND (P1.PICK_ORDER = :WK_ORDER1
                OR P1.PICK_ORDER = :WK_ORDER2
                OR P1.PICK_ORDER = :WK_ORDER3
                OR P1.PICK_ORDER = :WK_ORDER4
                OR P1.PICK_ORDER = :WK_ORDER5
                OR P1.PICK_ORDER = :WK_ORDER6
                OR P1.PICK_ORDER = :WK_ORDER7
                OR P1.PICK_ORDER = :WK_ORDER8
                OR P1.PICK_ORDER = :WK_ORDER9
                OR P1.PICK_ORDER = :WK_ORDER10
                OR P1.PICK_ORDER = :WK_ORDER11
                OR P1.PICK_ORDER = :WK_ORDER12
                OR P1.PICK_ORDER = :WK_ORDER13
                OR P1.PICK_ORDER = :WK_ORDER14
                OR P1.PICK_ORDER = :WK_ORDER15
                OR P1.PICK_ORDER = :WK_ORDER16
                OR P1.PICK_ORDER = :WK_ORDER17
                OR P1.PICK_ORDER = :WK_ORDER18
                OR P1.PICK_ORDER = :WK_ORDER19
                OR P1.PICK_ORDER = :WK_ORDER20)
           AND  P1.PICK_ORDER_QTY > 0   
           AND P2.PICK_STATUS IN ('OP','DA')
           AND (P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE1
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE2
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE3
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE4
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE5)
           GROUP BY P1.PICK_ORDER
           ORDER BY P2.PICK_PRIORITY, P2.WIP_ORDERING, P1.WIP_PRELOCN_ORDERING, P1.PICK_LOCATION, P1.WIP_POSTLOCN_ORDERING 
         INTO :WK_ORDER 
      DO
      BEGIN
         SUSPEND;
      END
   END
   ELSE
   IF ((WK_ORDER_CNT > 0) AND
       (WK_TYPE_CNT > 0) AND
       (WK_ORDER_STATUS1 = 'GETALL') AND
       (WK_PRIORITY_CNT > 0)) THEN
   BEGIN
      FOR 
         SELECT P1.PICK_ORDER 
         FROM PICK_ITEM P1 
             JOIN PICK_ORDER P2 ON P2.PICK_ORDER = P1.PICK_ORDER 
         WHERE P1.PICK_LINE_STATUS IN ('OP','UP') 
           AND (P1.PICK_ORDER = :WK_ORDER1
                OR P1.PICK_ORDER = :WK_ORDER2
                OR P1.PICK_ORDER = :WK_ORDER3
                OR P1.PICK_ORDER = :WK_ORDER4
                OR P1.PICK_ORDER = :WK_ORDER5
                OR P1.PICK_ORDER = :WK_ORDER6
                OR P1.PICK_ORDER = :WK_ORDER7
                OR P1.PICK_ORDER = :WK_ORDER8
                OR P1.PICK_ORDER = :WK_ORDER9
                OR P1.PICK_ORDER = :WK_ORDER10
                OR P1.PICK_ORDER = :WK_ORDER11
                OR P1.PICK_ORDER = :WK_ORDER12
                OR P1.PICK_ORDER = :WK_ORDER13
                OR P1.PICK_ORDER = :WK_ORDER14
                OR P1.PICK_ORDER = :WK_ORDER15
                OR P1.PICK_ORDER = :WK_ORDER16
                OR P1.PICK_ORDER = :WK_ORDER17
                OR P1.PICK_ORDER = :WK_ORDER18
                OR P1.PICK_ORDER = :WK_ORDER19
                OR P1.PICK_ORDER = :WK_ORDER20)
           AND  P1.PICK_ORDER_QTY > 0   
           AND P2.PICK_STATUS IN ('OP','DA')
           AND (P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE1
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE2
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE3
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE4
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE5)
           AND (P2.PICK_PRIORITY = :WK_PRIORITY1 
                OR P2.PICK_PRIORITY = :WK_PRIORITY2
                OR P2.PICK_PRIORITY = :WK_PRIORITY3
                OR P2.PICK_PRIORITY = :WK_PRIORITY4
                OR P2.PICK_PRIORITY = :WK_PRIORITY5)
           GROUP BY P1.PICK_ORDER
           ORDER BY P2.PICK_PRIORITY, P2.WIP_ORDERING, P1.WIP_PRELOCN_ORDERING, P1.PICK_LOCATION, P1.WIP_POSTLOCN_ORDERING 
         INTO :WK_ORDER 
      DO
      BEGIN
         SUSPEND;
      END
   END
   ELSE
   IF ((WK_ORDER_CNT > 0) AND
       (WK_TYPE_CNT > 0) AND
       (WK_STATUS_CNT > 0) AND
       (WK_PRIORITY1 = 0)) THEN
   BEGIN
      FOR 
         SELECT P1.PICK_ORDER 
         FROM PICK_ITEM P1 
             JOIN PICK_ORDER P2 ON P2.PICK_ORDER = P1.PICK_ORDER 
         WHERE (P1.PICK_LINE_STATUS = :WK_ORDER_STATUS1 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS2 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS3 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS4 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS5) 
           AND (P1.PICK_ORDER = :WK_ORDER1
                OR P1.PICK_ORDER = :WK_ORDER2
                OR P1.PICK_ORDER = :WK_ORDER3
                OR P1.PICK_ORDER = :WK_ORDER4
                OR P1.PICK_ORDER = :WK_ORDER5
                OR P1.PICK_ORDER = :WK_ORDER6
                OR P1.PICK_ORDER = :WK_ORDER7
                OR P1.PICK_ORDER = :WK_ORDER8
                OR P1.PICK_ORDER = :WK_ORDER9
                OR P1.PICK_ORDER = :WK_ORDER10
                OR P1.PICK_ORDER = :WK_ORDER11
                OR P1.PICK_ORDER = :WK_ORDER12
                OR P1.PICK_ORDER = :WK_ORDER13
                OR P1.PICK_ORDER = :WK_ORDER14
                OR P1.PICK_ORDER = :WK_ORDER15
                OR P1.PICK_ORDER = :WK_ORDER16
                OR P1.PICK_ORDER = :WK_ORDER17
                OR P1.PICK_ORDER = :WK_ORDER18
                OR P1.PICK_ORDER = :WK_ORDER19
                OR P1.PICK_ORDER = :WK_ORDER20)
           AND  P1.PICK_ORDER_QTY > 0   
           AND P2.PICK_STATUS IN ('OP','DA')
           AND (P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE1
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE2
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE3
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE4
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE5)
           GROUP BY P1.PICK_ORDER
           ORDER BY P2.PICK_PRIORITY, P2.WIP_ORDERING, P1.WIP_PRELOCN_ORDERING, P1.PICK_LOCATION, P1.WIP_POSTLOCN_ORDERING 
         INTO :WK_ORDER 
      DO
      BEGIN
         SUSPEND;
      END
   END
   ELSE
   IF ((WK_ORDER_CNT > 0) AND
       (WK_TYPE_CNT > 0) AND
       (WK_STATUS_CNT > 0) AND
       (WK_PRIORITY_CNT > 0)) THEN
   BEGIN
      FOR 
         SELECT P1.PICK_ORDER 
         FROM PICK_ITEM P1 
             JOIN PICK_ORDER P2 ON P2.PICK_ORDER = P1.PICK_ORDER 
         WHERE (P1.PICK_LINE_STATUS = :WK_ORDER_STATUS1 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS2 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS3 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS4 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS5) 
           AND (P1.PICK_ORDER = :WK_ORDER1
                OR P1.PICK_ORDER = :WK_ORDER2
                OR P1.PICK_ORDER = :WK_ORDER3
                OR P1.PICK_ORDER = :WK_ORDER4
                OR P1.PICK_ORDER = :WK_ORDER5
                OR P1.PICK_ORDER = :WK_ORDER6
                OR P1.PICK_ORDER = :WK_ORDER7
                OR P1.PICK_ORDER = :WK_ORDER8
                OR P1.PICK_ORDER = :WK_ORDER9
                OR P1.PICK_ORDER = :WK_ORDER10
                OR P1.PICK_ORDER = :WK_ORDER11
                OR P1.PICK_ORDER = :WK_ORDER12
                OR P1.PICK_ORDER = :WK_ORDER13
                OR P1.PICK_ORDER = :WK_ORDER14
                OR P1.PICK_ORDER = :WK_ORDER15
                OR P1.PICK_ORDER = :WK_ORDER16
                OR P1.PICK_ORDER = :WK_ORDER17
                OR P1.PICK_ORDER = :WK_ORDER18
                OR P1.PICK_ORDER = :WK_ORDER19
                OR P1.PICK_ORDER = :WK_ORDER20)
           AND  P1.PICK_ORDER_QTY > 0   
           AND P2.PICK_STATUS IN ('OP','DA')
           AND (P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE1
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE2
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE3
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE4
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE5)
           AND (P2.PICK_PRIORITY = :WK_PRIORITY1 
                OR P2.PICK_PRIORITY = :WK_PRIORITY2
                OR P2.PICK_PRIORITY = :WK_PRIORITY3
                OR P2.PICK_PRIORITY = :WK_PRIORITY4
                OR P2.PICK_PRIORITY = :WK_PRIORITY5)
           GROUP BY P1.PICK_ORDER
           ORDER BY P2.PICK_PRIORITY, P2.WIP_ORDERING, P1.WIP_PRELOCN_ORDERING, P1.PICK_LOCATION, P1.WIP_POSTLOCN_ORDERING 
         INTO :WK_ORDER 
      DO
      BEGIN
         SUSPEND;
      END
   END
   EXIT;
END ^

ALTER PROCEDURE PICK_MODE_P2 (WK_ORDER_TYPES VARCHAR(255) CHARACTER SET NONE,
WK_ORDER_MODES VARCHAR(255) CHARACTER SET NONE,
WK_ORDERS VARCHAR(255) CHARACTER SET NONE,
WK_ORDER_STATUSES VARCHAR(255) CHARACTER SET NONE,
WK_ORDER_PRIORITYS VARCHAR(255) CHARACTER SET NONE,
WK_PARAM_IDS VARCHAR(255) CHARACTER SET NONE)
RETURNS (WK_ORDER VARCHAR(15) CHARACTER SET NONE)
AS 
 
 
DECLARE VARIABLE WK_DELIM CHAR(1);
DECLARE VARIABLE WK_FOUND INTEGER;
DECLARE VARIABLE WK_ORDER_TYPE1 VARCHAR(10);
DECLARE VARIABLE WK_ORDER_TYPE2 VARCHAR(10);
DECLARE VARIABLE WK_ORDER_TYPE3 VARCHAR(10);
DECLARE VARIABLE WK_ORDER_TYPE4 VARCHAR(10);
DECLARE VARIABLE WK_ORDER_TYPE5 VARCHAR(10);
DECLARE VARIABLE WK_TYPE_CNT INTEGER;
DECLARE VARIABLE WK_ORDER_STATUS1 VARCHAR(10);
DECLARE VARIABLE WK_ORDER_STATUS2 VARCHAR(10);
DECLARE VARIABLE WK_ORDER_STATUS3 VARCHAR(10);
DECLARE VARIABLE WK_ORDER_STATUS4 VARCHAR(10);
DECLARE VARIABLE WK_ORDER_STATUS5 VARCHAR(10);
DECLARE VARIABLE WK_STATUS_CNT INTEGER;
DECLARE VARIABLE WK_PRIORITY1 INTEGER;
DECLARE VARIABLE WK_PRIORITY2 INTEGER;
DECLARE VARIABLE WK_PRIORITY3 INTEGER;
DECLARE VARIABLE WK_PRIORITY4 INTEGER;
DECLARE VARIABLE WK_PRIORITY5 INTEGER;
DECLARE VARIABLE WK_PRIORITY_CNT INTEGER;
DECLARE VARIABLE WK_ORDER_CNT INTEGER;
DECLARE VARIABLE WK_IDX INTEGER;
DECLARE VARIABLE WK_COND VARCHAR(35);
DECLARE VARIABLE WK_ORDER1 VARCHAR(15);
DECLARE VARIABLE WK_ORDER2 VARCHAR(15);
DECLARE VARIABLE WK_ORDER3 VARCHAR(15);
DECLARE VARIABLE WK_ORDER4 VARCHAR(15);
DECLARE VARIABLE WK_ORDER5 VARCHAR(15);
DECLARE VARIABLE WK_ORDER6 VARCHAR(15);
DECLARE VARIABLE WK_ORDER7 VARCHAR(15);
DECLARE VARIABLE WK_ORDER8 VARCHAR(15);
DECLARE VARIABLE WK_ORDER9 VARCHAR(15);
DECLARE VARIABLE WK_ORDER10 VARCHAR(15);
DECLARE VARIABLE WK_ORDER11 VARCHAR(15);
DECLARE VARIABLE WK_ORDER12 VARCHAR(15);
DECLARE VARIABLE WK_ORDER13 VARCHAR(15);
DECLARE VARIABLE WK_ORDER14 VARCHAR(15);
DECLARE VARIABLE WK_ORDER15 VARCHAR(15);
DECLARE VARIABLE WK_ORDER16 VARCHAR(15);
DECLARE VARIABLE WK_ORDER17 VARCHAR(15);
DECLARE VARIABLE WK_ORDER18 VARCHAR(15);
DECLARE VARIABLE WK_ORDER19 VARCHAR(15);
DECLARE VARIABLE WK_ORDER20 VARCHAR(15);

BEGIN
   WK_DELIM = '|';
   WK_ORDER_TYPE1 = '';
   WK_ORDER_TYPE2 = '';
   WK_ORDER_TYPE3 = '';
   WK_ORDER_TYPE4 = '';
   WK_ORDER_TYPE5 = '';
   WK_ORDER_STATUS1 = '';
   WK_ORDER_STATUS2 = '';
   WK_ORDER_STATUS3 = '';
   WK_ORDER_STATUS4 = '';
   WK_ORDER_STATUS5 = '';
   WK_ORDER1 = '';
   WK_ORDER2 = '';
   WK_ORDER3 = '';
   WK_ORDER4 = '';
   WK_ORDER5 = '';
   WK_ORDER6 = '';
   WK_ORDER7 = '';
   WK_ORDER8 = '';
   WK_ORDER9 = '';
   WK_ORDER10 = '';
   WK_ORDER11 = '';
   WK_ORDER12 = '';
   WK_ORDER13 = '';
   WK_ORDER14 = '';
   WK_ORDER15 = '';
   WK_ORDER16 = '';
   WK_ORDER17 = '';
   WK_ORDER18 = '';
   WK_ORDER19 = '';
   WK_ORDER20 = '';
   WK_PRIORITY1 = -32000;
   WK_PRIORITY2 = -32000;
   WK_PRIORITY3 = -32000;
   WK_PRIORITY4 = -32000;
   WK_PRIORITY5 = -32000;
   /* normally only one order type but glen wants several or GETALL */
   IF (WK_ORDER_TYPES = 'GETALL') THEN
   BEGIN
      WK_ORDER_TYPE1 = 'GETALL';
      WK_TYPE_CNT = 1;
   END
   ELSE
   BEGIN
      /* allow up to 5 types */
      WK_TYPE_CNT = 0;
      WK_IDX = 1;
      WK_COND = ALLTRIM(PARSE(:WK_ORDER_TYPES,:WK_DELIM,:WK_IDX));
      WHILE (WK_COND <> 'Token to long in parse') DO 
      BEGIN
         WK_TYPE_CNT = WK_TYPE_CNT + 1;
         IF (WK_TYPE_CNT = 1) THEN
            WK_ORDER_TYPE1 = WK_COND;
         ELSE
         IF (WK_TYPE_CNT = 2) THEN
            WK_ORDER_TYPE2 = WK_COND;
         ELSE
         IF (WK_TYPE_CNT = 3) THEN
            WK_ORDER_TYPE3 = WK_COND;
         ELSE
         IF (WK_TYPE_CNT = 4) THEN
            WK_ORDER_TYPE4 = WK_COND;
         ELSE
         IF (WK_TYPE_CNT = 5) THEN
            WK_ORDER_TYPE5 = WK_COND;
         /* get next type */
         WK_IDX = WK_IDX + 1;
         WK_COND = ALLTRIM(PARSE(:WK_ORDER_TYPES,:WK_DELIM,:WK_IDX));
      END
   END

   /* normally GETALL in the mode - unused field */

   /* order statuses - why this ?? - must be confirmed lines OP or UP */
   IF (WK_ORDER_STATUSES = 'GETALL') THEN
   BEGIN
      WK_ORDER_STATUS1 = 'GETALL';
      WK_STATUS_CNT = 1;
   END
   ELSE
   BEGIN
      /* allow up to 5 STATUSs */
      WK_STATUS_CNT = 0;
      WK_IDX = 1;
      WK_COND = ALLTRIM(PARSE(:WK_ORDER_STATUSES,:WK_DELIM,:WK_IDX));
      WHILE (WK_COND <> 'Token to long in parse') DO 
      BEGIN
         WK_STATUS_CNT = WK_STATUS_CNT + 1;
         IF (WK_STATUS_CNT = 1) THEN
            WK_ORDER_STATUS1 = WK_COND;
         ELSE
         IF (WK_STATUS_CNT = 2) THEN
            WK_ORDER_STATUS2 = WK_COND;
         ELSE
         IF (WK_STATUS_CNT = 3) THEN
            WK_ORDER_STATUS3 = WK_COND;
         ELSE
         IF (WK_STATUS_CNT = 4) THEN
            WK_ORDER_STATUS4 = WK_COND;
         ELSE
         IF (WK_STATUS_CNT = 5) THEN
            WK_ORDER_STATUS5 = WK_COND;
         /* get next STATUS */
         WK_IDX = WK_IDX + 1;
         WK_COND = ALLTRIM(PARSE(:WK_ORDER_STATUSES,:WK_DELIM,:WK_IDX));
      END
   END

   /* ordno is a list of orders or GETALL */
   /* orders are length 9 or 10 for internal */
   /* so can have a maximum of 255 = (1 + n*10) */   
   /* thus n = 25 */
   /* calc orders 1 - 25 */
   /* but only allow upto 20 */
   IF (WK_ORDERS = 'GETALL') THEN
   BEGIN
      WK_ORDER1 = 'GETALL';
      WK_ORDER_CNT = 1;
   END
   ELSE
   BEGIN
      WK_ORDER_CNT = 0;
      WK_IDX = 1;
      WK_COND = ALLTRIM(PARSE(:WK_ORDERS,:WK_DELIM,:WK_IDX));
      WHILE (WK_COND <> 'Token to long in parse') DO 
      BEGIN
         WK_ORDER_CNT = WK_ORDER_CNT + 1;
         IF (WK_ORDER_CNT = 1) THEN
            WK_ORDER1 = WK_COND;
         ELSE
         IF (WK_ORDER_CNT = 2) THEN
            WK_ORDER2 = WK_COND;
         ELSE
         IF (WK_ORDER_CNT = 3) THEN
            WK_ORDER3 = WK_COND;
         ELSE
         IF (WK_ORDER_CNT = 4) THEN
            WK_ORDER4 = WK_COND;
         ELSE
         IF (WK_ORDER_CNT = 5) THEN
            WK_ORDER5 = WK_COND;
         ELSE
         IF (WK_ORDER_CNT = 6) THEN
            WK_ORDER6 = WK_COND;
         ELSE
         IF (WK_ORDER_CNT = 7) THEN
            WK_ORDER7 = WK_COND;
         ELSE
         IF (WK_ORDER_CNT = 8) THEN
            WK_ORDER8 = WK_COND;
         ELSE
         IF (WK_ORDER_CNT = 9) THEN
            WK_ORDER9 = WK_COND;
         ELSE
         IF (WK_ORDER_CNT = 10) THEN
            WK_ORDER10 = WK_COND;
         ELSE
         IF (WK_ORDER_CNT = 11) THEN
            WK_ORDER11 = WK_COND;
         ELSE
         IF (WK_ORDER_CNT = 12) THEN
            WK_ORDER12 = WK_COND;
         ELSE
         IF (WK_ORDER_CNT = 13) THEN
            WK_ORDER13 = WK_COND;
         ELSE
         IF (WK_ORDER_CNT = 14) THEN
            WK_ORDER14 = WK_COND;
         ELSE
         IF (WK_ORDER_CNT = 15) THEN
            WK_ORDER15 = WK_COND;
         ELSE
         IF (WK_ORDER_CNT = 16) THEN
            WK_ORDER16 = WK_COND;
         ELSE
         IF (WK_ORDER_CNT = 17) THEN
            WK_ORDER17 = WK_COND;
         ELSE
         IF (WK_ORDER_CNT = 18) THEN
            WK_ORDER18 = WK_COND;
         ELSE
         IF (WK_ORDER_CNT = 19) THEN
            WK_ORDER19 = WK_COND;
         ELSE
         IF (WK_ORDER_CNT = 20) THEN
            WK_ORDER20 = WK_COND;
         /* get next order */
         WK_IDX = WK_IDX + 1;
         WK_COND = ALLTRIM(PARSE(:WK_ORDERS,:WK_DELIM,:WK_IDX));
      END
   END

   /* order priorities 0 = GETALL or a specific priority */
   /* priorities are small int - range -32768 - +32767 */
   /* but really 0 - 9 and -9 - -1 since a 1 char display */
   /* so a max of 19 */
   /* but only allow upto 2 */

   IF (WK_ORDER_PRIORITYS = 'GETALL') THEN
   BEGIN
      WK_PRIORITY1 = 0;
      WK_STATUS_CNT = 1;
   END
   ELSE
   BEGIN
      /* allow up to 2 Prioritys */
      WK_PRIORITY_CNT = 0;
      WK_IDX = 1;
      WK_COND = ALLTRIM(PARSE(:WK_ORDER_PRIORITYS,:WK_DELIM,:WK_IDX));
      WHILE (WK_COND <> 'Token to long in parse') DO 
      BEGIN
         WK_PRIORITY_CNT = WK_PRIORITY_CNT + 1;
         IF (WK_PRIORITY_CNT = 1) THEN
            WK_PRIORITY1 = WK_COND;
         ELSE
         IF (WK_PRIORITY_CNT = 2) THEN
            WK_PRIORITY2 = WK_COND;
         ELSE
         IF (WK_PRIORITY_CNT = 3) THEN
            WK_PRIORITY3 = WK_COND;
         ELSE
         IF (WK_PRIORITY_CNT = 4) THEN
            WK_PRIORITY4 = WK_COND;
         ELSE
         IF (WK_PRIORITY_CNT = 5) THEN
            WK_PRIORITY5 = WK_COND;
         /* get next Priority */
         WK_IDX = WK_IDX + 1;
         WK_COND = ALLTRIM(PARSE(:WK_ORDER_PRIORITYS,:WK_DELIM,:WK_IDX));
      END
   END

   /* parms for a specifiy procedure either GETALL or a LIST */
   /* for P1 this is GETALL */
   /* only want single line orders */

   IF ((WK_ORDER1 = 'GETALL') AND
       (WK_ORDER_TYPE1 = 'GETALL') AND
       (WK_ORDER_STATUS1 = 'GETALL') AND
       (WK_PRIORITY1 = 0)) THEN
   BEGIN
      FOR 
         SELECT P1.PICK_ORDER 
         FROM PICK_ITEM P1 
             JOIN PICK_ORDER P2 ON P2.PICK_ORDER = P1.PICK_ORDER 
         WHERE P1.PICK_LINE_STATUS IN ('OP','UP') 
           AND  P1.PICK_ORDER_QTY > 0   
           AND P2.PICK_STATUS IN ('OP','DA')
           GROUP BY P1.PICK_ORDER
           HAVING COUNT(*) = 1
           ORDER BY P2.PICK_PRIORITY, P2.WIP_ORDERING, P1.WIP_PRELOCN_ORDERING, P1.PICK_LOCATION, P1.WIP_POSTLOCN_ORDERING 
         INTO :WK_ORDER 
      DO
      BEGIN
         SUSPEND;
      END
   END
   ELSE
   IF ((WK_ORDER1 = 'GETALL') AND
       (WK_ORDER_TYPE1 = 'GETALL') AND
       (WK_ORDER_STATUS1 = 'GETALL') AND
       (WK_PRIORITY_CNT > 0)) THEN
   BEGIN
      FOR 
         SELECT P1.PICK_ORDER 
         FROM PICK_ITEM P1 
             JOIN PICK_ORDER P2 ON P2.PICK_ORDER = P1.PICK_ORDER 
         WHERE P1.PICK_LINE_STATUS IN ('OP','UP') 
           AND  P1.PICK_ORDER_QTY > 0   
           AND P2.PICK_STATUS IN ('OP','DA')
           AND (P2.PICK_PRIORITY = :WK_PRIORITY1 
                OR P2.PICK_PRIORITY = :WK_PRIORITY2
                OR P2.PICK_PRIORITY = :WK_PRIORITY3
                OR P2.PICK_PRIORITY = :WK_PRIORITY4
                OR P2.PICK_PRIORITY = :WK_PRIORITY5)
           GROUP BY P1.PICK_ORDER
           HAVING COUNT(*) = 1
           ORDER BY P2.PICK_PRIORITY, P2.WIP_ORDERING, P1.WIP_PRELOCN_ORDERING, P1.PICK_LOCATION, P1.WIP_POSTLOCN_ORDERING 
         INTO :WK_ORDER 
      DO
      BEGIN
         SUSPEND;
      END
   END
   ELSE
   IF ((WK_ORDER1 = 'GETALL') AND
       (WK_ORDER_TYPE1 = 'GETALL') AND
       (WK_STATUS_CNT > 0) AND
       (WK_PRIORITY1 = 0)) THEN
   BEGIN
      FOR 
         SELECT P1.PICK_ORDER 
         FROM PICK_ITEM P1 
             JOIN PICK_ORDER P2 ON P2.PICK_ORDER = P1.PICK_ORDER 
         WHERE (P1.PICK_LINE_STATUS = :WK_ORDER_STATUS1 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS2 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS3 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS4 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS5) 
           AND  P1.PICK_ORDER_QTY > 0   
           AND P2.PICK_STATUS IN ('OP','DA')
           GROUP BY P1.PICK_ORDER
           HAVING COUNT(*) = 1
           ORDER BY P2.PICK_PRIORITY, P2.WIP_ORDERING, P1.WIP_PRELOCN_ORDERING, P1.PICK_LOCATION, P1.WIP_POSTLOCN_ORDERING 
         INTO :WK_ORDER 
      DO
      BEGIN
         SUSPEND;
      END
   END
   ELSE
   IF ((WK_ORDER1 = 'GETALL') AND
       (WK_ORDER_TYPE1 = 'GETALL') AND
       (WK_STATUS_CNT > 0) AND
       (WK_PRIORITY_CNT > 0)) THEN
   BEGIN
      FOR 
         SELECT P1.PICK_ORDER 
         FROM PICK_ITEM P1 
             JOIN PICK_ORDER P2 ON P2.PICK_ORDER = P1.PICK_ORDER 
         WHERE (P1.PICK_LINE_STATUS = :WK_ORDER_STATUS1 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS2 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS3 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS4 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS5) 
           AND  P1.PICK_ORDER_QTY > 0   
           AND P2.PICK_STATUS IN ('OP','DA')
           AND (P2.PICK_PRIORITY = :WK_PRIORITY1 
                OR P2.PICK_PRIORITY = :WK_PRIORITY2
                OR P2.PICK_PRIORITY = :WK_PRIORITY3
                OR P2.PICK_PRIORITY = :WK_PRIORITY4
                OR P2.PICK_PRIORITY = :WK_PRIORITY5)
           GROUP BY P1.PICK_ORDER
           HAVING COUNT(*) = 1
           ORDER BY P2.PICK_PRIORITY, P2.WIP_ORDERING, P1.WIP_PRELOCN_ORDERING, P1.PICK_LOCATION, P1.WIP_POSTLOCN_ORDERING 
         INTO :WK_ORDER 
      DO
      BEGIN
         SUSPEND;
      END
   END
   ELSE
   IF ((WK_ORDER1 = 'GETALL') AND
       (WK_TYPE_CNT > 0) AND
       (WK_ORDER_STATUS1 = 'GETALL') AND
       (WK_PRIORITY1 = 0)) THEN
   BEGIN
      FOR 
         SELECT P1.PICK_ORDER 
         FROM PICK_ITEM P1 
             JOIN PICK_ORDER P2 ON P2.PICK_ORDER = P1.PICK_ORDER 
         WHERE P1.PICK_LINE_STATUS IN ('OP','UP') 
           AND  P1.PICK_ORDER_QTY > 0   
           AND P2.PICK_STATUS IN ('OP','DA')
           AND (P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE1
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE2
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE3
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE4
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE5)
           GROUP BY P1.PICK_ORDER
           HAVING COUNT(*) = 1
           ORDER BY P2.PICK_PRIORITY, P2.WIP_ORDERING, P1.WIP_PRELOCN_ORDERING, P1.PICK_LOCATION, P1.WIP_POSTLOCN_ORDERING 
         INTO :WK_ORDER 
      DO
      BEGIN
         SUSPEND;
      END
   END
   ELSE
   IF ((WK_ORDER1 = 'GETALL') AND
       (WK_TYPE_CNT > 0) AND
       (WK_ORDER_STATUS1 = 'GETALL') AND
       (WK_PRIORITY_CNT > 0)) THEN
   BEGIN
      FOR 
         SELECT P1.PICK_ORDER 
         FROM PICK_ITEM P1 
             JOIN PICK_ORDER P2 ON P2.PICK_ORDER = P1.PICK_ORDER 
         WHERE P1.PICK_LINE_STATUS IN ('OP','UP') 
           AND  P1.PICK_ORDER_QTY > 0   
           AND P2.PICK_STATUS IN ('OP','DA')
           AND (P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE1
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE2
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE3
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE4
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE5)
           AND (P2.PICK_PRIORITY = :WK_PRIORITY1 
                OR P2.PICK_PRIORITY = :WK_PRIORITY2
                OR P2.PICK_PRIORITY = :WK_PRIORITY3
                OR P2.PICK_PRIORITY = :WK_PRIORITY4
                OR P2.PICK_PRIORITY = :WK_PRIORITY5)
           GROUP BY P1.PICK_ORDER
           HAVING COUNT(*) = 1
           ORDER BY P2.PICK_PRIORITY, P2.WIP_ORDERING, P1.WIP_PRELOCN_ORDERING, P1.PICK_LOCATION, P1.WIP_POSTLOCN_ORDERING 
         INTO :WK_ORDER 
      DO
      BEGIN
         SUSPEND;
      END
   END
   ELSE
   IF ((WK_ORDER1 = 'GETALL') AND
       (WK_TYPE_CNT > 0) AND
       (WK_STATUS_CNT > 0) AND
       (WK_PRIORITY1 = 0)) THEN
   BEGIN
      FOR 
         SELECT P1.PICK_ORDER 
         FROM PICK_ITEM P1 
             JOIN PICK_ORDER P2 ON P2.PICK_ORDER = P1.PICK_ORDER 
         WHERE (P1.PICK_LINE_STATUS = :WK_ORDER_STATUS1 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS2 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS3 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS4 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS5) 
           AND  P1.PICK_ORDER_QTY > 0   
           AND P2.PICK_STATUS IN ('OP','DA')
           AND (P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE1
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE2
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE3
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE4
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE5)
           GROUP BY P1.PICK_ORDER
           HAVING COUNT(*) = 1
           ORDER BY P2.PICK_PRIORITY, P2.WIP_ORDERING, P1.WIP_PRELOCN_ORDERING, P1.PICK_LOCATION, P1.WIP_POSTLOCN_ORDERING 
         INTO :WK_ORDER 
      DO
      BEGIN
         SUSPEND;
      END
   END
   ELSE
   IF ((WK_ORDER1 = 'GETALL') AND
       (WK_TYPE_CNT > 0) AND
       (WK_STATUS_CNT > 0) AND
       (WK_PRIORITY_CNT > 0)) THEN
   BEGIN
      FOR 
         SELECT P1.PICK_ORDER 
         FROM PICK_ITEM P1 
             JOIN PICK_ORDER P2 ON P2.PICK_ORDER = P1.PICK_ORDER 
         WHERE (P1.PICK_LINE_STATUS = :WK_ORDER_STATUS1 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS2 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS3 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS4 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS5) 
           AND  P1.PICK_ORDER_QTY > 0   
           AND P2.PICK_STATUS IN ('OP','DA')
           AND (P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE1
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE2
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE3
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE4
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE5)
           AND (P2.PICK_PRIORITY = :WK_PRIORITY1 
                OR P2.PICK_PRIORITY = :WK_PRIORITY2
                OR P2.PICK_PRIORITY = :WK_PRIORITY3
                OR P2.PICK_PRIORITY = :WK_PRIORITY4
                OR P2.PICK_PRIORITY = :WK_PRIORITY5)
           GROUP BY P1.PICK_ORDER
           HAVING COUNT(*) = 1
           ORDER BY P2.PICK_PRIORITY, P2.WIP_ORDERING, P1.WIP_PRELOCN_ORDERING, P1.PICK_LOCATION, P1.WIP_POSTLOCN_ORDERING 
         INTO :WK_ORDER 
      DO
      BEGIN
         SUSPEND;
      END
   END
   ELSE
   IF ((WK_ORDER_CNT > 0) AND
       (WK_ORDER_TYPE1 = 'GETALL') AND
       (WK_ORDER_STATUS1 = 'GETALL') AND
       (WK_PRIORITY1 = 0)) THEN
   BEGIN
      FOR 
         SELECT P1.PICK_ORDER 
         FROM PICK_ITEM P1 
             JOIN PICK_ORDER P2 ON P2.PICK_ORDER = P1.PICK_ORDER 
         WHERE P1.PICK_LINE_STATUS IN ('OP','UP') 
           AND  P1.PICK_ORDER_QTY > 0   
           AND (P1.PICK_ORDER = :WK_ORDER1
                OR P1.PICK_ORDER = :WK_ORDER2
                OR P1.PICK_ORDER = :WK_ORDER3
                OR P1.PICK_ORDER = :WK_ORDER4
                OR P1.PICK_ORDER = :WK_ORDER5
                OR P1.PICK_ORDER = :WK_ORDER6
                OR P1.PICK_ORDER = :WK_ORDER7
                OR P1.PICK_ORDER = :WK_ORDER8
                OR P1.PICK_ORDER = :WK_ORDER9
                OR P1.PICK_ORDER = :WK_ORDER10
                OR P1.PICK_ORDER = :WK_ORDER11
                OR P1.PICK_ORDER = :WK_ORDER12
                OR P1.PICK_ORDER = :WK_ORDER13
                OR P1.PICK_ORDER = :WK_ORDER14
                OR P1.PICK_ORDER = :WK_ORDER15
                OR P1.PICK_ORDER = :WK_ORDER16
                OR P1.PICK_ORDER = :WK_ORDER17
                OR P1.PICK_ORDER = :WK_ORDER18
                OR P1.PICK_ORDER = :WK_ORDER19
                OR P1.PICK_ORDER = :WK_ORDER20)
           AND P2.PICK_STATUS IN ('OP','DA')
           GROUP BY P1.PICK_ORDER
           HAVING COUNT(*) = 1
           ORDER BY P2.PICK_PRIORITY, P2.WIP_ORDERING, P1.WIP_PRELOCN_ORDERING, P1.PICK_LOCATION, P1.WIP_POSTLOCN_ORDERING 
         INTO :WK_ORDER 
      DO
      BEGIN
         SUSPEND;
      END
   END
   ELSE
   IF ((WK_ORDER_CNT > 0) AND
       (WK_ORDER_TYPE1 = 'GETALL') AND
       (WK_ORDER_STATUS1 = 'GETALL') AND
       (WK_PRIORITY_CNT > 0)) THEN
   BEGIN
      FOR 
         SELECT P1.PICK_ORDER 
         FROM PICK_ITEM P1 
             JOIN PICK_ORDER P2 ON P2.PICK_ORDER = P1.PICK_ORDER 
         WHERE P1.PICK_LINE_STATUS IN ('OP','UP') 
           AND (P1.PICK_ORDER = :WK_ORDER1
                OR P1.PICK_ORDER = :WK_ORDER2
                OR P1.PICK_ORDER = :WK_ORDER3
                OR P1.PICK_ORDER = :WK_ORDER4
                OR P1.PICK_ORDER = :WK_ORDER5
                OR P1.PICK_ORDER = :WK_ORDER6
                OR P1.PICK_ORDER = :WK_ORDER7
                OR P1.PICK_ORDER = :WK_ORDER8
                OR P1.PICK_ORDER = :WK_ORDER9
                OR P1.PICK_ORDER = :WK_ORDER10
                OR P1.PICK_ORDER = :WK_ORDER11
                OR P1.PICK_ORDER = :WK_ORDER12
                OR P1.PICK_ORDER = :WK_ORDER13
                OR P1.PICK_ORDER = :WK_ORDER14
                OR P1.PICK_ORDER = :WK_ORDER15
                OR P1.PICK_ORDER = :WK_ORDER16
                OR P1.PICK_ORDER = :WK_ORDER17
                OR P1.PICK_ORDER = :WK_ORDER18
                OR P1.PICK_ORDER = :WK_ORDER19
                OR P1.PICK_ORDER = :WK_ORDER20)
           AND  P1.PICK_ORDER_QTY > 0   
           AND P2.PICK_STATUS IN ('OP','DA')
           AND (P2.PICK_PRIORITY = :WK_PRIORITY1 
                OR P2.PICK_PRIORITY = :WK_PRIORITY2
                OR P2.PICK_PRIORITY = :WK_PRIORITY3
                OR P2.PICK_PRIORITY = :WK_PRIORITY4
                OR P2.PICK_PRIORITY = :WK_PRIORITY5)
           GROUP BY P1.PICK_ORDER
           HAVING COUNT(*) = 1
           ORDER BY P2.PICK_PRIORITY, P2.WIP_ORDERING, P1.WIP_PRELOCN_ORDERING, P1.PICK_LOCATION, P1.WIP_POSTLOCN_ORDERING 
         INTO :WK_ORDER 
      DO
      BEGIN
         SUSPEND;
      END
   END
   ELSE
   IF ((WK_ORDER_CNT > 0) AND
       (WK_ORDER_TYPE1 = 'GETALL') AND
       (WK_STATUS_CNT > 0) AND
       (WK_PRIORITY1 = 0)) THEN
   BEGIN
      FOR 
         SELECT P1.PICK_ORDER 
         FROM PICK_ITEM P1 
             JOIN PICK_ORDER P2 ON P2.PICK_ORDER = P1.PICK_ORDER 
         WHERE (P1.PICK_LINE_STATUS = :WK_ORDER_STATUS1 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS2 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS3 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS4 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS5) 
           AND (P1.PICK_ORDER = :WK_ORDER1
                OR P1.PICK_ORDER = :WK_ORDER2
                OR P1.PICK_ORDER = :WK_ORDER3
                OR P1.PICK_ORDER = :WK_ORDER4
                OR P1.PICK_ORDER = :WK_ORDER5
                OR P1.PICK_ORDER = :WK_ORDER6
                OR P1.PICK_ORDER = :WK_ORDER7
                OR P1.PICK_ORDER = :WK_ORDER8
                OR P1.PICK_ORDER = :WK_ORDER9
                OR P1.PICK_ORDER = :WK_ORDER10
                OR P1.PICK_ORDER = :WK_ORDER11
                OR P1.PICK_ORDER = :WK_ORDER12
                OR P1.PICK_ORDER = :WK_ORDER13
                OR P1.PICK_ORDER = :WK_ORDER14
                OR P1.PICK_ORDER = :WK_ORDER15
                OR P1.PICK_ORDER = :WK_ORDER16
                OR P1.PICK_ORDER = :WK_ORDER17
                OR P1.PICK_ORDER = :WK_ORDER18
                OR P1.PICK_ORDER = :WK_ORDER19
                OR P1.PICK_ORDER = :WK_ORDER20)
           AND  P1.PICK_ORDER_QTY > 0   
           AND P2.PICK_STATUS IN ('OP','DA')
           GROUP BY P1.PICK_ORDER
           HAVING COUNT(*) = 1
           ORDER BY P2.PICK_PRIORITY, P2.WIP_ORDERING, P1.WIP_PRELOCN_ORDERING, P1.PICK_LOCATION, P1.WIP_POSTLOCN_ORDERING 
         INTO :WK_ORDER 
      DO
      BEGIN
         SUSPEND;
      END
   END
   ELSE
   IF ((WK_ORDER_CNT > 0) AND
       (WK_ORDER_TYPE1 = 'GETALL') AND
       (WK_STATUS_CNT > 0) AND
       (WK_PRIORITY_CNT > 0)) THEN
   BEGIN
      FOR 
         SELECT P1.PICK_ORDER 
         FROM PICK_ITEM P1 
             JOIN PICK_ORDER P2 ON P2.PICK_ORDER = P1.PICK_ORDER 
         WHERE (P1.PICK_LINE_STATUS = :WK_ORDER_STATUS1 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS2 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS3 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS4 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS5) 
           AND (P1.PICK_ORDER = :WK_ORDER1
                OR P1.PICK_ORDER = :WK_ORDER2
                OR P1.PICK_ORDER = :WK_ORDER3
                OR P1.PICK_ORDER = :WK_ORDER4
                OR P1.PICK_ORDER = :WK_ORDER5
                OR P1.PICK_ORDER = :WK_ORDER6
                OR P1.PICK_ORDER = :WK_ORDER7
                OR P1.PICK_ORDER = :WK_ORDER8
                OR P1.PICK_ORDER = :WK_ORDER9
                OR P1.PICK_ORDER = :WK_ORDER10
                OR P1.PICK_ORDER = :WK_ORDER11
                OR P1.PICK_ORDER = :WK_ORDER12
                OR P1.PICK_ORDER = :WK_ORDER13
                OR P1.PICK_ORDER = :WK_ORDER14
                OR P1.PICK_ORDER = :WK_ORDER15
                OR P1.PICK_ORDER = :WK_ORDER16
                OR P1.PICK_ORDER = :WK_ORDER17
                OR P1.PICK_ORDER = :WK_ORDER18
                OR P1.PICK_ORDER = :WK_ORDER19
                OR P1.PICK_ORDER = :WK_ORDER20)
           AND  P1.PICK_ORDER_QTY > 0   
           AND P2.PICK_STATUS IN ('OP','DA')
           AND (P2.PICK_PRIORITY = :WK_PRIORITY1 
                OR P2.PICK_PRIORITY = :WK_PRIORITY2
                OR P2.PICK_PRIORITY = :WK_PRIORITY3
                OR P2.PICK_PRIORITY = :WK_PRIORITY4
                OR P2.PICK_PRIORITY = :WK_PRIORITY5)
           GROUP BY P1.PICK_ORDER
           HAVING COUNT(*) = 1
           ORDER BY P2.PICK_PRIORITY, P2.WIP_ORDERING, P1.WIP_PRELOCN_ORDERING, P1.PICK_LOCATION, P1.WIP_POSTLOCN_ORDERING 
         INTO :WK_ORDER 
      DO
      BEGIN
         SUSPEND;
      END
   END
   ELSE
   IF ((WK_ORDER_CNT > 0) AND
       (WK_TYPE_CNT > 0) AND
       (WK_ORDER_STATUS1 = 'GETALL') AND
       (WK_PRIORITY1 = 0)) THEN
   BEGIN
      FOR 
         SELECT P1.PICK_ORDER 
         FROM PICK_ITEM P1 
             JOIN PICK_ORDER P2 ON P2.PICK_ORDER = P1.PICK_ORDER 
         WHERE P1.PICK_LINE_STATUS IN ('OP','UP') 
           AND (P1.PICK_ORDER = :WK_ORDER1
                OR P1.PICK_ORDER = :WK_ORDER2
                OR P1.PICK_ORDER = :WK_ORDER3
                OR P1.PICK_ORDER = :WK_ORDER4
                OR P1.PICK_ORDER = :WK_ORDER5
                OR P1.PICK_ORDER = :WK_ORDER6
                OR P1.PICK_ORDER = :WK_ORDER7
                OR P1.PICK_ORDER = :WK_ORDER8
                OR P1.PICK_ORDER = :WK_ORDER9
                OR P1.PICK_ORDER = :WK_ORDER10
                OR P1.PICK_ORDER = :WK_ORDER11
                OR P1.PICK_ORDER = :WK_ORDER12
                OR P1.PICK_ORDER = :WK_ORDER13
                OR P1.PICK_ORDER = :WK_ORDER14
                OR P1.PICK_ORDER = :WK_ORDER15
                OR P1.PICK_ORDER = :WK_ORDER16
                OR P1.PICK_ORDER = :WK_ORDER17
                OR P1.PICK_ORDER = :WK_ORDER18
                OR P1.PICK_ORDER = :WK_ORDER19
                OR P1.PICK_ORDER = :WK_ORDER20)
           AND  P1.PICK_ORDER_QTY > 0   
           AND P2.PICK_STATUS IN ('OP','DA')
           AND (P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE1
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE2
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE3
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE4
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE5)
           GROUP BY P1.PICK_ORDER
           HAVING COUNT(*) = 1
           ORDER BY P2.PICK_PRIORITY, P2.WIP_ORDERING, P1.WIP_PRELOCN_ORDERING, P1.PICK_LOCATION, P1.WIP_POSTLOCN_ORDERING 
         INTO :WK_ORDER 
      DO
      BEGIN
         SUSPEND;
      END
   END
   ELSE
   IF ((WK_ORDER_CNT > 0) AND
       (WK_TYPE_CNT > 0) AND
       (WK_ORDER_STATUS1 = 'GETALL') AND
       (WK_PRIORITY_CNT > 0)) THEN
   BEGIN
      FOR 
         SELECT P1.PICK_ORDER 
         FROM PICK_ITEM P1 
             JOIN PICK_ORDER P2 ON P2.PICK_ORDER = P1.PICK_ORDER 
         WHERE P1.PICK_LINE_STATUS IN ('OP','UP') 
           AND (P1.PICK_ORDER = :WK_ORDER1
                OR P1.PICK_ORDER = :WK_ORDER2
                OR P1.PICK_ORDER = :WK_ORDER3
                OR P1.PICK_ORDER = :WK_ORDER4
                OR P1.PICK_ORDER = :WK_ORDER5
                OR P1.PICK_ORDER = :WK_ORDER6
                OR P1.PICK_ORDER = :WK_ORDER7
                OR P1.PICK_ORDER = :WK_ORDER8
                OR P1.PICK_ORDER = :WK_ORDER9
                OR P1.PICK_ORDER = :WK_ORDER10
                OR P1.PICK_ORDER = :WK_ORDER11
                OR P1.PICK_ORDER = :WK_ORDER12
                OR P1.PICK_ORDER = :WK_ORDER13
                OR P1.PICK_ORDER = :WK_ORDER14
                OR P1.PICK_ORDER = :WK_ORDER15
                OR P1.PICK_ORDER = :WK_ORDER16
                OR P1.PICK_ORDER = :WK_ORDER17
                OR P1.PICK_ORDER = :WK_ORDER18
                OR P1.PICK_ORDER = :WK_ORDER19
                OR P1.PICK_ORDER = :WK_ORDER20)
           AND  P1.PICK_ORDER_QTY > 0   
           AND P2.PICK_STATUS IN ('OP','DA')
           AND (P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE1
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE2
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE3
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE4
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE5)
           AND (P2.PICK_PRIORITY = :WK_PRIORITY1 
                OR P2.PICK_PRIORITY = :WK_PRIORITY2
                OR P2.PICK_PRIORITY = :WK_PRIORITY3
                OR P2.PICK_PRIORITY = :WK_PRIORITY4
                OR P2.PICK_PRIORITY = :WK_PRIORITY5)
           GROUP BY P1.PICK_ORDER
           HAVING COUNT(*) = 1
           ORDER BY P2.PICK_PRIORITY, P2.WIP_ORDERING, P1.WIP_PRELOCN_ORDERING, P1.PICK_LOCATION, P1.WIP_POSTLOCN_ORDERING 
         INTO :WK_ORDER 
      DO
      BEGIN
         SUSPEND;
      END
   END
   ELSE
   IF ((WK_ORDER_CNT > 0) AND
       (WK_TYPE_CNT > 0) AND
       (WK_STATUS_CNT > 0) AND
       (WK_PRIORITY1 = 0)) THEN
   BEGIN
      FOR 
         SELECT P1.PICK_ORDER 
         FROM PICK_ITEM P1 
             JOIN PICK_ORDER P2 ON P2.PICK_ORDER = P1.PICK_ORDER 
         WHERE (P1.PICK_LINE_STATUS = :WK_ORDER_STATUS1 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS2 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS3 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS4 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS5) 
           AND (P1.PICK_ORDER = :WK_ORDER1
                OR P1.PICK_ORDER = :WK_ORDER2
                OR P1.PICK_ORDER = :WK_ORDER3
                OR P1.PICK_ORDER = :WK_ORDER4
                OR P1.PICK_ORDER = :WK_ORDER5
                OR P1.PICK_ORDER = :WK_ORDER6
                OR P1.PICK_ORDER = :WK_ORDER7
                OR P1.PICK_ORDER = :WK_ORDER8
                OR P1.PICK_ORDER = :WK_ORDER9
                OR P1.PICK_ORDER = :WK_ORDER10
                OR P1.PICK_ORDER = :WK_ORDER11
                OR P1.PICK_ORDER = :WK_ORDER12
                OR P1.PICK_ORDER = :WK_ORDER13
                OR P1.PICK_ORDER = :WK_ORDER14
                OR P1.PICK_ORDER = :WK_ORDER15
                OR P1.PICK_ORDER = :WK_ORDER16
                OR P1.PICK_ORDER = :WK_ORDER17
                OR P1.PICK_ORDER = :WK_ORDER18
                OR P1.PICK_ORDER = :WK_ORDER19
                OR P1.PICK_ORDER = :WK_ORDER20)
           AND  P1.PICK_ORDER_QTY > 0   
           AND P2.PICK_STATUS IN ('OP','DA')
           AND (P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE1
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE2
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE3
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE4
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE5)
           GROUP BY P1.PICK_ORDER
           HAVING COUNT(*) = 1
           ORDER BY P2.PICK_PRIORITY, P2.WIP_ORDERING, P1.WIP_PRELOCN_ORDERING, P1.PICK_LOCATION, P1.WIP_POSTLOCN_ORDERING 
         INTO :WK_ORDER 
      DO
      BEGIN
         SUSPEND;
      END
   END
   ELSE
   IF ((WK_ORDER_CNT > 0) AND
       (WK_TYPE_CNT > 0) AND
       (WK_STATUS_CNT > 0) AND
       (WK_PRIORITY_CNT > 0)) THEN
   BEGIN
      FOR 
         SELECT P1.PICK_ORDER 
         FROM PICK_ITEM P1 
             JOIN PICK_ORDER P2 ON P2.PICK_ORDER = P1.PICK_ORDER 
         WHERE (P1.PICK_LINE_STATUS = :WK_ORDER_STATUS1 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS2 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS3 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS4 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS5) 
           AND (P1.PICK_ORDER = :WK_ORDER1
                OR P1.PICK_ORDER = :WK_ORDER2
                OR P1.PICK_ORDER = :WK_ORDER3
                OR P1.PICK_ORDER = :WK_ORDER4
                OR P1.PICK_ORDER = :WK_ORDER5
                OR P1.PICK_ORDER = :WK_ORDER6
                OR P1.PICK_ORDER = :WK_ORDER7
                OR P1.PICK_ORDER = :WK_ORDER8
                OR P1.PICK_ORDER = :WK_ORDER9
                OR P1.PICK_ORDER = :WK_ORDER10
                OR P1.PICK_ORDER = :WK_ORDER11
                OR P1.PICK_ORDER = :WK_ORDER12
                OR P1.PICK_ORDER = :WK_ORDER13
                OR P1.PICK_ORDER = :WK_ORDER14
                OR P1.PICK_ORDER = :WK_ORDER15
                OR P1.PICK_ORDER = :WK_ORDER16
                OR P1.PICK_ORDER = :WK_ORDER17
                OR P1.PICK_ORDER = :WK_ORDER18
                OR P1.PICK_ORDER = :WK_ORDER19
                OR P1.PICK_ORDER = :WK_ORDER20)
           AND  P1.PICK_ORDER_QTY > 0   
           AND P2.PICK_STATUS IN ('OP','DA')
           AND (P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE1
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE2
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE3
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE4
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE5)
           AND (P2.PICK_PRIORITY = :WK_PRIORITY1 
                OR P2.PICK_PRIORITY = :WK_PRIORITY2
                OR P2.PICK_PRIORITY = :WK_PRIORITY3
                OR P2.PICK_PRIORITY = :WK_PRIORITY4
                OR P2.PICK_PRIORITY = :WK_PRIORITY5)
           GROUP BY P1.PICK_ORDER
           HAVING COUNT(*) = 1
           ORDER BY P2.PICK_PRIORITY, P2.WIP_ORDERING, P1.WIP_PRELOCN_ORDERING, P1.PICK_LOCATION, P1.WIP_POSTLOCN_ORDERING 
         INTO :WK_ORDER 
      DO
      BEGIN
         SUSPEND;
      END
   END
   EXIT;
END ^

ALTER PROCEDURE PICK_MODE_P3 (WK_ORDER_TYPES VARCHAR(255) CHARACTER SET NONE,
WK_ORDER_MODES VARCHAR(255) CHARACTER SET NONE,
WK_ORDERS VARCHAR(255) CHARACTER SET NONE,
WK_ORDER_STATUSES VARCHAR(255) CHARACTER SET NONE,
WK_ORDER_PRIORITYS VARCHAR(255) CHARACTER SET NONE,
WK_PARAM_IDS VARCHAR(255) CHARACTER SET NONE)
RETURNS (WK_ORDER VARCHAR(15) CHARACTER SET NONE)
AS 
 
 
DECLARE VARIABLE WK_DELIM CHAR(1);
DECLARE VARIABLE WK_FOUND INTEGER;
DECLARE VARIABLE WK_ORDER_TYPE1 VARCHAR(10);
DECLARE VARIABLE WK_ORDER_TYPE2 VARCHAR(10);
DECLARE VARIABLE WK_ORDER_TYPE3 VARCHAR(10);
DECLARE VARIABLE WK_ORDER_TYPE4 VARCHAR(10);
DECLARE VARIABLE WK_ORDER_TYPE5 VARCHAR(10);
DECLARE VARIABLE WK_TYPE_CNT INTEGER;
DECLARE VARIABLE WK_ORDER_STATUS1 VARCHAR(10);
DECLARE VARIABLE WK_ORDER_STATUS2 VARCHAR(10);
DECLARE VARIABLE WK_ORDER_STATUS3 VARCHAR(10);
DECLARE VARIABLE WK_ORDER_STATUS4 VARCHAR(10);
DECLARE VARIABLE WK_ORDER_STATUS5 VARCHAR(10);
DECLARE VARIABLE WK_STATUS_CNT INTEGER;
DECLARE VARIABLE WK_PRIORITY1 INTEGER;
DECLARE VARIABLE WK_PRIORITY2 INTEGER;
DECLARE VARIABLE WK_PRIORITY3 INTEGER;
DECLARE VARIABLE WK_PRIORITY4 INTEGER;
DECLARE VARIABLE WK_PRIORITY5 INTEGER;
DECLARE VARIABLE WK_PRIORITY_CNT INTEGER;
DECLARE VARIABLE WK_ORDER_CNT INTEGER;
DECLARE VARIABLE WK_IDX INTEGER;
DECLARE VARIABLE WK_COND VARCHAR(35);
DECLARE VARIABLE WK_ORDER1 VARCHAR(15);
DECLARE VARIABLE WK_ORDER2 VARCHAR(15);
DECLARE VARIABLE WK_ORDER3 VARCHAR(15);
DECLARE VARIABLE WK_ORDER4 VARCHAR(15);
DECLARE VARIABLE WK_ORDER5 VARCHAR(15);
DECLARE VARIABLE WK_ORDER6 VARCHAR(15);
DECLARE VARIABLE WK_ORDER7 VARCHAR(15);
DECLARE VARIABLE WK_ORDER8 VARCHAR(15);
DECLARE VARIABLE WK_ORDER9 VARCHAR(15);
DECLARE VARIABLE WK_ORDER10 VARCHAR(15);
DECLARE VARIABLE WK_ORDER11 VARCHAR(15);
DECLARE VARIABLE WK_ORDER12 VARCHAR(15);
DECLARE VARIABLE WK_ORDER13 VARCHAR(15);
DECLARE VARIABLE WK_ORDER14 VARCHAR(15);
DECLARE VARIABLE WK_ORDER15 VARCHAR(15);
DECLARE VARIABLE WK_ORDER16 VARCHAR(15);
DECLARE VARIABLE WK_ORDER17 VARCHAR(15);
DECLARE VARIABLE WK_ORDER18 VARCHAR(15);
DECLARE VARIABLE WK_ORDER19 VARCHAR(15);
DECLARE VARIABLE WK_ORDER20 VARCHAR(15);

BEGIN
   WK_DELIM = '|';
   WK_ORDER_TYPE1 = '';
   WK_ORDER_TYPE2 = '';
   WK_ORDER_TYPE3 = '';
   WK_ORDER_TYPE4 = '';
   WK_ORDER_TYPE5 = '';
   WK_ORDER_STATUS1 = '';
   WK_ORDER_STATUS2 = '';
   WK_ORDER_STATUS3 = '';
   WK_ORDER_STATUS4 = '';
   WK_ORDER_STATUS5 = '';
   WK_ORDER1 = '';
   WK_ORDER2 = '';
   WK_ORDER3 = '';
   WK_ORDER4 = '';
   WK_ORDER5 = '';
   WK_ORDER6 = '';
   WK_ORDER7 = '';
   WK_ORDER8 = '';
   WK_ORDER9 = '';
   WK_ORDER10 = '';
   WK_ORDER11 = '';
   WK_ORDER12 = '';
   WK_ORDER13 = '';
   WK_ORDER14 = '';
   WK_ORDER15 = '';
   WK_ORDER16 = '';
   WK_ORDER17 = '';
   WK_ORDER18 = '';
   WK_ORDER19 = '';
   WK_ORDER20 = '';
   WK_PRIORITY1 = -32000;
   WK_PRIORITY2 = -32000;
   WK_PRIORITY3 = -32000;
   WK_PRIORITY4 = -32000;
   WK_PRIORITY5 = -32000;
   /* normally only one order type but glen wants several or GETALL */
   IF (WK_ORDER_TYPES = 'GETALL') THEN
   BEGIN
      WK_ORDER_TYPE1 = 'GETALL';
      WK_TYPE_CNT = 1;
   END
   ELSE
   BEGIN
      /* allow up to 5 types */
      WK_TYPE_CNT = 0;
      WK_IDX = 1;
      WK_COND = ALLTRIM(PARSE(:WK_ORDER_TYPES,:WK_DELIM,:WK_IDX));
      WHILE (WK_COND <> 'Token to long in parse') DO 
      BEGIN
         WK_TYPE_CNT = WK_TYPE_CNT + 1;
         IF (WK_TYPE_CNT = 1) THEN
            WK_ORDER_TYPE1 = WK_COND;
         ELSE
         IF (WK_TYPE_CNT = 2) THEN
            WK_ORDER_TYPE2 = WK_COND;
         ELSE
         IF (WK_TYPE_CNT = 3) THEN
            WK_ORDER_TYPE3 = WK_COND;
         ELSE
         IF (WK_TYPE_CNT = 4) THEN
            WK_ORDER_TYPE4 = WK_COND;
         ELSE
         IF (WK_TYPE_CNT = 5) THEN
            WK_ORDER_TYPE5 = WK_COND;
         /* get next type */
         WK_IDX = WK_IDX + 1;
         WK_COND = ALLTRIM(PARSE(:WK_ORDER_TYPES,:WK_DELIM,:WK_IDX));
      END
   END

   /* normally GETALL in the mode - unused field */

   /* order statuses - why this ?? - must be confirmed lines OP or UP */
   IF (WK_ORDER_STATUSES = 'GETALL') THEN
   BEGIN
      WK_ORDER_STATUS1 = 'GETALL';
      WK_STATUS_CNT = 1;
   END
   ELSE
   BEGIN
      /* allow up to 5 STATUSs */
      WK_STATUS_CNT = 0;
      WK_IDX = 1;
      WK_COND = ALLTRIM(PARSE(:WK_ORDER_STATUSES,:WK_DELIM,:WK_IDX));
      WHILE (WK_COND <> 'Token to long in parse') DO 
      BEGIN
         WK_STATUS_CNT = WK_STATUS_CNT + 1;
         IF (WK_STATUS_CNT = 1) THEN
            WK_ORDER_STATUS1 = WK_COND;
         ELSE
         IF (WK_STATUS_CNT = 2) THEN
            WK_ORDER_STATUS2 = WK_COND;
         ELSE
         IF (WK_STATUS_CNT = 3) THEN
            WK_ORDER_STATUS3 = WK_COND;
         ELSE
         IF (WK_STATUS_CNT = 4) THEN
            WK_ORDER_STATUS4 = WK_COND;
         ELSE
         IF (WK_STATUS_CNT = 5) THEN
            WK_ORDER_STATUS5 = WK_COND;
         /* get next STATUS */
         WK_IDX = WK_IDX + 1;
         WK_COND = ALLTRIM(PARSE(:WK_ORDER_STATUSES,:WK_DELIM,:WK_IDX));
      END
   END

   /* ordno is a list of orders or GETALL */
   /* orders are length 9 or 10 for internal */
   /* so can have a maximum of 255 = (1 + n*10) */   
   /* thus n = 25 */
   /* calc orders 1 - 25 */
   /* but only allow upto 20 */
   IF (WK_ORDERS = 'GETALL') THEN
   BEGIN
      WK_ORDER1 = 'GETALL';
      WK_ORDER_CNT = 1;
   END
   ELSE
   BEGIN
      WK_ORDER_CNT = 0;
      WK_IDX = 1;
      WK_COND = ALLTRIM(PARSE(:WK_ORDERS,:WK_DELIM,:WK_IDX));
      WHILE (WK_COND <> 'Token to long in parse') DO 
      BEGIN
         WK_ORDER_CNT = WK_ORDER_CNT + 1;
         IF (WK_ORDER_CNT = 1) THEN
            WK_ORDER1 = WK_COND;
         ELSE
         IF (WK_ORDER_CNT = 2) THEN
            WK_ORDER2 = WK_COND;
         ELSE
         IF (WK_ORDER_CNT = 3) THEN
            WK_ORDER3 = WK_COND;
         ELSE
         IF (WK_ORDER_CNT = 4) THEN
            WK_ORDER4 = WK_COND;
         ELSE
         IF (WK_ORDER_CNT = 5) THEN
            WK_ORDER5 = WK_COND;
         ELSE
         IF (WK_ORDER_CNT = 6) THEN
            WK_ORDER6 = WK_COND;
         ELSE
         IF (WK_ORDER_CNT = 7) THEN
            WK_ORDER7 = WK_COND;
         ELSE
         IF (WK_ORDER_CNT = 8) THEN
            WK_ORDER8 = WK_COND;
         ELSE
         IF (WK_ORDER_CNT = 9) THEN
            WK_ORDER9 = WK_COND;
         ELSE
         IF (WK_ORDER_CNT = 10) THEN
            WK_ORDER10 = WK_COND;
         ELSE
         IF (WK_ORDER_CNT = 11) THEN
            WK_ORDER11 = WK_COND;
         ELSE
         IF (WK_ORDER_CNT = 12) THEN
            WK_ORDER12 = WK_COND;
         ELSE
         IF (WK_ORDER_CNT = 13) THEN
            WK_ORDER13 = WK_COND;
         ELSE
         IF (WK_ORDER_CNT = 14) THEN
            WK_ORDER14 = WK_COND;
         ELSE
         IF (WK_ORDER_CNT = 15) THEN
            WK_ORDER15 = WK_COND;
         ELSE
         IF (WK_ORDER_CNT = 16) THEN
            WK_ORDER16 = WK_COND;
         ELSE
         IF (WK_ORDER_CNT = 17) THEN
            WK_ORDER17 = WK_COND;
         ELSE
         IF (WK_ORDER_CNT = 18) THEN
            WK_ORDER18 = WK_COND;
         ELSE
         IF (WK_ORDER_CNT = 19) THEN
            WK_ORDER19 = WK_COND;
         ELSE
         IF (WK_ORDER_CNT = 20) THEN
            WK_ORDER20 = WK_COND;
         /* get next order */
         WK_IDX = WK_IDX + 1;
         WK_COND = ALLTRIM(PARSE(:WK_ORDERS,:WK_DELIM,:WK_IDX));
      END
   END

   /* order priorities 0 = GETALL or a specific priority */
   /* priorities are small int - range -32768 - +32767 */
   /* but really 0 - 9 and -9 - -1 since a 1 char display */
   /* so a max of 19 */
   /* but only allow upto 2 */

   IF (WK_ORDER_PRIORITYS = 'GETALL') THEN
   BEGIN
      WK_PRIORITY1 = 0;
      WK_STATUS_CNT = 1;
   END
   ELSE
   BEGIN
      /* allow up to 2 Prioritys */
      WK_PRIORITY_CNT = 0;
      WK_IDX = 1;
      WK_COND = ALLTRIM(PARSE(:WK_ORDER_PRIORITYS,:WK_DELIM,:WK_IDX));
      WHILE (WK_COND <> 'Token to long in parse') DO 
      BEGIN
         WK_PRIORITY_CNT = WK_PRIORITY_CNT + 1;
         IF (WK_PRIORITY_CNT = 1) THEN
            WK_PRIORITY1 = WK_COND;
         ELSE
         IF (WK_PRIORITY_CNT = 2) THEN
            WK_PRIORITY2 = WK_COND;
         ELSE
         IF (WK_PRIORITY_CNT = 3) THEN
            WK_PRIORITY3 = WK_COND;
         ELSE
         IF (WK_PRIORITY_CNT = 4) THEN
            WK_PRIORITY4 = WK_COND;
         ELSE
         IF (WK_PRIORITY_CNT = 5) THEN
            WK_PRIORITY5 = WK_COND;
         /* get next Priority */
         WK_IDX = WK_IDX + 1;
         WK_COND = ALLTRIM(PARSE(:WK_ORDER_PRIORITYS,:WK_DELIM,:WK_IDX));
      END
   END

   /* parms for a specifiy procedure either GETALL or a LIST */
   /* for P1 this is GETALL */
   /* only want multiple line orders */

   IF ((WK_ORDER1 = 'GETALL') AND
       (WK_ORDER_TYPE1 = 'GETALL') AND
       (WK_ORDER_STATUS1 = 'GETALL') AND
       (WK_PRIORITY1 = 0)) THEN
   BEGIN
      FOR 
         SELECT P1.PICK_ORDER 
         FROM PICK_ITEM P1 
             JOIN PICK_ORDER P2 ON P2.PICK_ORDER = P1.PICK_ORDER 
         WHERE P1.PICK_LINE_STATUS IN ('OP','UP') 
           AND  P1.PICK_ORDER_QTY > 0   
           AND P2.PICK_STATUS IN ('OP','DA')
           GROUP BY P1.PICK_ORDER
           HAVING COUNT(*) > 1
           ORDER BY P2.PICK_PRIORITY, P2.WIP_ORDERING, P1.WIP_PRELOCN_ORDERING, P1.PICK_LOCATION, P1.WIP_POSTLOCN_ORDERING 
         INTO :WK_ORDER 
      DO
      BEGIN
         SUSPEND;
      END
   END
   ELSE
   IF ((WK_ORDER1 = 'GETALL') AND
       (WK_ORDER_TYPE1 = 'GETALL') AND
       (WK_ORDER_STATUS1 = 'GETALL') AND
       (WK_PRIORITY_CNT > 0)) THEN
   BEGIN
      FOR 
         SELECT P1.PICK_ORDER 
         FROM PICK_ITEM P1 
             JOIN PICK_ORDER P2 ON P2.PICK_ORDER = P1.PICK_ORDER 
         WHERE P1.PICK_LINE_STATUS IN ('OP','UP') 
           AND  P1.PICK_ORDER_QTY > 0   
           AND P2.PICK_STATUS IN ('OP','DA')
           AND (P2.PICK_PRIORITY = :WK_PRIORITY1 
                OR P2.PICK_PRIORITY = :WK_PRIORITY2
                OR P2.PICK_PRIORITY = :WK_PRIORITY3
                OR P2.PICK_PRIORITY = :WK_PRIORITY4
                OR P2.PICK_PRIORITY = :WK_PRIORITY5)
           GROUP BY P1.PICK_ORDER
           HAVING COUNT(*) > 1
           ORDER BY P2.PICK_PRIORITY, P2.WIP_ORDERING, P1.WIP_PRELOCN_ORDERING, P1.PICK_LOCATION, P1.WIP_POSTLOCN_ORDERING 
         INTO :WK_ORDER 
      DO
      BEGIN
         SUSPEND;
      END
   END
   ELSE
   IF ((WK_ORDER1 = 'GETALL') AND
       (WK_ORDER_TYPE1 = 'GETALL') AND
       (WK_STATUS_CNT > 0) AND
       (WK_PRIORITY1 = 0)) THEN
   BEGIN
      FOR 
         SELECT P1.PICK_ORDER 
         FROM PICK_ITEM P1 
             JOIN PICK_ORDER P2 ON P2.PICK_ORDER = P1.PICK_ORDER 
         WHERE (P1.PICK_LINE_STATUS = :WK_ORDER_STATUS1 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS2 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS3 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS4 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS5) 
           AND  P1.PICK_ORDER_QTY > 0   
           AND P2.PICK_STATUS IN ('OP','DA')
           GROUP BY P1.PICK_ORDER
           HAVING COUNT(*) > 1
           ORDER BY P2.PICK_PRIORITY, P2.WIP_ORDERING, P1.WIP_PRELOCN_ORDERING, P1.PICK_LOCATION, P1.WIP_POSTLOCN_ORDERING 
         INTO :WK_ORDER 
      DO
      BEGIN
         SUSPEND;
      END
   END
   ELSE
   IF ((WK_ORDER1 = 'GETALL') AND
       (WK_ORDER_TYPE1 = 'GETALL') AND
       (WK_STATUS_CNT > 0) AND
       (WK_PRIORITY_CNT > 0)) THEN
   BEGIN
      FOR 
         SELECT P1.PICK_ORDER 
         FROM PICK_ITEM P1 
             JOIN PICK_ORDER P2 ON P2.PICK_ORDER = P1.PICK_ORDER 
         WHERE (P1.PICK_LINE_STATUS = :WK_ORDER_STATUS1 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS2 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS3 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS4 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS5) 
           AND  P1.PICK_ORDER_QTY > 0   
           AND P2.PICK_STATUS IN ('OP','DA')
           AND (P2.PICK_PRIORITY = :WK_PRIORITY1 
                OR P2.PICK_PRIORITY = :WK_PRIORITY2
                OR P2.PICK_PRIORITY = :WK_PRIORITY3
                OR P2.PICK_PRIORITY = :WK_PRIORITY4
                OR P2.PICK_PRIORITY = :WK_PRIORITY5)
           GROUP BY P1.PICK_ORDER
           HAVING COUNT(*) > 1
           ORDER BY P2.PICK_PRIORITY, P2.WIP_ORDERING, P1.WIP_PRELOCN_ORDERING, P1.PICK_LOCATION, P1.WIP_POSTLOCN_ORDERING 
         INTO :WK_ORDER 
      DO
      BEGIN
         SUSPEND;
      END
   END
   ELSE
   IF ((WK_ORDER1 = 'GETALL') AND
       (WK_TYPE_CNT > 0) AND
       (WK_ORDER_STATUS1 = 'GETALL') AND
       (WK_PRIORITY1 = 0)) THEN
   BEGIN
      FOR 
         SELECT P1.PICK_ORDER 
         FROM PICK_ITEM P1 
             JOIN PICK_ORDER P2 ON P2.PICK_ORDER = P1.PICK_ORDER 
         WHERE P1.PICK_LINE_STATUS IN ('OP','UP') 
           AND  P1.PICK_ORDER_QTY > 0   
           AND P2.PICK_STATUS IN ('OP','DA')
           AND (P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE1
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE2
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE3
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE4
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE5)
           GROUP BY P1.PICK_ORDER
           HAVING COUNT(*) > 1
           ORDER BY P2.PICK_PRIORITY, P2.WIP_ORDERING, P1.WIP_PRELOCN_ORDERING, P1.PICK_LOCATION, P1.WIP_POSTLOCN_ORDERING 
         INTO :WK_ORDER 
      DO
      BEGIN
         SUSPEND;
      END
   END
   ELSE
   IF ((WK_ORDER1 = 'GETALL') AND
       (WK_TYPE_CNT > 0) AND
       (WK_ORDER_STATUS1 = 'GETALL') AND
       (WK_PRIORITY_CNT > 0)) THEN
   BEGIN
      FOR 
         SELECT P1.PICK_ORDER 
         FROM PICK_ITEM P1 
             JOIN PICK_ORDER P2 ON P2.PICK_ORDER = P1.PICK_ORDER 
         WHERE P1.PICK_LINE_STATUS IN ('OP','UP') 
           AND  P1.PICK_ORDER_QTY > 0   
           AND P2.PICK_STATUS IN ('OP','DA')
           AND (P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE1
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE2
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE3
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE4
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE5)
           AND (P2.PICK_PRIORITY = :WK_PRIORITY1 
                OR P2.PICK_PRIORITY = :WK_PRIORITY2
                OR P2.PICK_PRIORITY = :WK_PRIORITY3
                OR P2.PICK_PRIORITY = :WK_PRIORITY4
                OR P2.PICK_PRIORITY = :WK_PRIORITY5)
           GROUP BY P1.PICK_ORDER
           HAVING COUNT(*) > 1
           ORDER BY P2.PICK_PRIORITY, P2.WIP_ORDERING, P1.WIP_PRELOCN_ORDERING, P1.PICK_LOCATION, P1.WIP_POSTLOCN_ORDERING 
         INTO :WK_ORDER 
      DO
      BEGIN
         SUSPEND;
      END
   END
   ELSE
   IF ((WK_ORDER1 = 'GETALL') AND
       (WK_TYPE_CNT > 0) AND
       (WK_STATUS_CNT > 0) AND
       (WK_PRIORITY1 = 0)) THEN
   BEGIN
      FOR 
         SELECT P1.PICK_ORDER 
         FROM PICK_ITEM P1 
             JOIN PICK_ORDER P2 ON P2.PICK_ORDER = P1.PICK_ORDER 
         WHERE (P1.PICK_LINE_STATUS = :WK_ORDER_STATUS1 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS2 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS3 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS4 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS5) 
           AND  P1.PICK_ORDER_QTY > 0   
           AND P2.PICK_STATUS IN ('OP','DA')
           AND (P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE1
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE2
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE3
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE4
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE5)
           GROUP BY P1.PICK_ORDER
           HAVING COUNT(*) > 1
           ORDER BY P2.PICK_PRIORITY, P2.WIP_ORDERING, P1.WIP_PRELOCN_ORDERING, P1.PICK_LOCATION, P1.WIP_POSTLOCN_ORDERING 
         INTO :WK_ORDER 
      DO
      BEGIN
         SUSPEND;
      END
   END
   ELSE
   IF ((WK_ORDER1 = 'GETALL') AND
       (WK_TYPE_CNT > 0) AND
       (WK_STATUS_CNT > 0) AND
       (WK_PRIORITY_CNT > 0)) THEN
   BEGIN
      FOR 
         SELECT P1.PICK_ORDER 
         FROM PICK_ITEM P1 
             JOIN PICK_ORDER P2 ON P2.PICK_ORDER = P1.PICK_ORDER 
         WHERE (P1.PICK_LINE_STATUS = :WK_ORDER_STATUS1 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS2 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS3 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS4 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS5) 
           AND  P1.PICK_ORDER_QTY > 0   
           AND P2.PICK_STATUS IN ('OP','DA')
           AND (P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE1
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE2
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE3
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE4
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE5)
           AND (P2.PICK_PRIORITY = :WK_PRIORITY1 
                OR P2.PICK_PRIORITY = :WK_PRIORITY2
                OR P2.PICK_PRIORITY = :WK_PRIORITY3
                OR P2.PICK_PRIORITY = :WK_PRIORITY4
                OR P2.PICK_PRIORITY = :WK_PRIORITY5)
           GROUP BY P1.PICK_ORDER
           HAVING COUNT(*) > 1
           ORDER BY P2.PICK_PRIORITY, P2.WIP_ORDERING, P1.WIP_PRELOCN_ORDERING, P1.PICK_LOCATION, P1.WIP_POSTLOCN_ORDERING 
         INTO :WK_ORDER 
      DO
      BEGIN
         SUSPEND;
      END
   END
   ELSE
   IF ((WK_ORDER_CNT > 0) AND
       (WK_ORDER_TYPE1 = 'GETALL') AND
       (WK_ORDER_STATUS1 = 'GETALL') AND
       (WK_PRIORITY1 = 0)) THEN
   BEGIN
      FOR 
         SELECT P1.PICK_ORDER 
         FROM PICK_ITEM P1 
             JOIN PICK_ORDER P2 ON P2.PICK_ORDER = P1.PICK_ORDER 
         WHERE P1.PICK_LINE_STATUS IN ('OP','UP') 
           AND  P1.PICK_ORDER_QTY > 0   
           AND (P1.PICK_ORDER = :WK_ORDER1
                OR P1.PICK_ORDER = :WK_ORDER2
                OR P1.PICK_ORDER = :WK_ORDER3
                OR P1.PICK_ORDER = :WK_ORDER4
                OR P1.PICK_ORDER = :WK_ORDER5
                OR P1.PICK_ORDER = :WK_ORDER6
                OR P1.PICK_ORDER = :WK_ORDER7
                OR P1.PICK_ORDER = :WK_ORDER8
                OR P1.PICK_ORDER = :WK_ORDER9
                OR P1.PICK_ORDER = :WK_ORDER10
                OR P1.PICK_ORDER = :WK_ORDER11
                OR P1.PICK_ORDER = :WK_ORDER12
                OR P1.PICK_ORDER = :WK_ORDER13
                OR P1.PICK_ORDER = :WK_ORDER14
                OR P1.PICK_ORDER = :WK_ORDER15
                OR P1.PICK_ORDER = :WK_ORDER16
                OR P1.PICK_ORDER = :WK_ORDER17
                OR P1.PICK_ORDER = :WK_ORDER18
                OR P1.PICK_ORDER = :WK_ORDER19
                OR P1.PICK_ORDER = :WK_ORDER20)
           AND P2.PICK_STATUS IN ('OP','DA')
           GROUP BY P1.PICK_ORDER
           HAVING COUNT(*) > 1
           ORDER BY P2.PICK_PRIORITY, P2.WIP_ORDERING, P1.WIP_PRELOCN_ORDERING, P1.PICK_LOCATION, P1.WIP_POSTLOCN_ORDERING 
         INTO :WK_ORDER 
      DO
      BEGIN
         SUSPEND;
      END
   END
   ELSE
   IF ((WK_ORDER_CNT > 0) AND
       (WK_ORDER_TYPE1 = 'GETALL') AND
       (WK_ORDER_STATUS1 = 'GETALL') AND
       (WK_PRIORITY_CNT > 0)) THEN
   BEGIN
      FOR 
         SELECT P1.PICK_ORDER 
         FROM PICK_ITEM P1 
             JOIN PICK_ORDER P2 ON P2.PICK_ORDER = P1.PICK_ORDER 
         WHERE P1.PICK_LINE_STATUS IN ('OP','UP') 
           AND (P1.PICK_ORDER = :WK_ORDER1
                OR P1.PICK_ORDER = :WK_ORDER2
                OR P1.PICK_ORDER = :WK_ORDER3
                OR P1.PICK_ORDER = :WK_ORDER4
                OR P1.PICK_ORDER = :WK_ORDER5
                OR P1.PICK_ORDER = :WK_ORDER6
                OR P1.PICK_ORDER = :WK_ORDER7
                OR P1.PICK_ORDER = :WK_ORDER8
                OR P1.PICK_ORDER = :WK_ORDER9
                OR P1.PICK_ORDER = :WK_ORDER10
                OR P1.PICK_ORDER = :WK_ORDER11
                OR P1.PICK_ORDER = :WK_ORDER12
                OR P1.PICK_ORDER = :WK_ORDER13
                OR P1.PICK_ORDER = :WK_ORDER14
                OR P1.PICK_ORDER = :WK_ORDER15
                OR P1.PICK_ORDER = :WK_ORDER16
                OR P1.PICK_ORDER = :WK_ORDER17
                OR P1.PICK_ORDER = :WK_ORDER18
                OR P1.PICK_ORDER = :WK_ORDER19
                OR P1.PICK_ORDER = :WK_ORDER20)
           AND  P1.PICK_ORDER_QTY > 0   
           AND P2.PICK_STATUS IN ('OP','DA')
           AND (P2.PICK_PRIORITY = :WK_PRIORITY1 
                OR P2.PICK_PRIORITY = :WK_PRIORITY2
                OR P2.PICK_PRIORITY = :WK_PRIORITY3
                OR P2.PICK_PRIORITY = :WK_PRIORITY4
                OR P2.PICK_PRIORITY = :WK_PRIORITY5)
           GROUP BY P1.PICK_ORDER
           HAVING COUNT(*) > 1
           ORDER BY P2.PICK_PRIORITY, P2.WIP_ORDERING, P1.WIP_PRELOCN_ORDERING, P1.PICK_LOCATION, P1.WIP_POSTLOCN_ORDERING 
         INTO :WK_ORDER 
      DO
      BEGIN
         SUSPEND;
      END
   END
   ELSE
   IF ((WK_ORDER_CNT > 0) AND
       (WK_ORDER_TYPE1 = 'GETALL') AND
       (WK_STATUS_CNT > 0) AND
       (WK_PRIORITY1 = 0)) THEN
   BEGIN
      FOR 
         SELECT P1.PICK_ORDER 
         FROM PICK_ITEM P1 
             JOIN PICK_ORDER P2 ON P2.PICK_ORDER = P1.PICK_ORDER 
         WHERE (P1.PICK_LINE_STATUS = :WK_ORDER_STATUS1 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS2 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS3 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS4 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS5) 
           AND (P1.PICK_ORDER = :WK_ORDER1
                OR P1.PICK_ORDER = :WK_ORDER2
                OR P1.PICK_ORDER = :WK_ORDER3
                OR P1.PICK_ORDER = :WK_ORDER4
                OR P1.PICK_ORDER = :WK_ORDER5
                OR P1.PICK_ORDER = :WK_ORDER6
                OR P1.PICK_ORDER = :WK_ORDER7
                OR P1.PICK_ORDER = :WK_ORDER8
                OR P1.PICK_ORDER = :WK_ORDER9
                OR P1.PICK_ORDER = :WK_ORDER10
                OR P1.PICK_ORDER = :WK_ORDER11
                OR P1.PICK_ORDER = :WK_ORDER12
                OR P1.PICK_ORDER = :WK_ORDER13
                OR P1.PICK_ORDER = :WK_ORDER14
                OR P1.PICK_ORDER = :WK_ORDER15
                OR P1.PICK_ORDER = :WK_ORDER16
                OR P1.PICK_ORDER = :WK_ORDER17
                OR P1.PICK_ORDER = :WK_ORDER18
                OR P1.PICK_ORDER = :WK_ORDER19
                OR P1.PICK_ORDER = :WK_ORDER20)
           AND  P1.PICK_ORDER_QTY > 0   
           AND P2.PICK_STATUS IN ('OP','DA')
           GROUP BY P1.PICK_ORDER
           HAVING COUNT(*) > 1
           ORDER BY P2.PICK_PRIORITY, P2.WIP_ORDERING, P1.WIP_PRELOCN_ORDERING, P1.PICK_LOCATION, P1.WIP_POSTLOCN_ORDERING 
         INTO :WK_ORDER 
      DO
      BEGIN
         SUSPEND;
      END
   END
   ELSE
   IF ((WK_ORDER_CNT > 0) AND
       (WK_ORDER_TYPE1 = 'GETALL') AND
       (WK_STATUS_CNT > 0) AND
       (WK_PRIORITY_CNT > 0)) THEN
   BEGIN
      FOR 
         SELECT P1.PICK_ORDER 
         FROM PICK_ITEM P1 
             JOIN PICK_ORDER P2 ON P2.PICK_ORDER = P1.PICK_ORDER 
         WHERE (P1.PICK_LINE_STATUS = :WK_ORDER_STATUS1 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS2 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS3 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS4 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS5) 
           AND (P1.PICK_ORDER = :WK_ORDER1
                OR P1.PICK_ORDER = :WK_ORDER2
                OR P1.PICK_ORDER = :WK_ORDER3
                OR P1.PICK_ORDER = :WK_ORDER4
                OR P1.PICK_ORDER = :WK_ORDER5
                OR P1.PICK_ORDER = :WK_ORDER6
                OR P1.PICK_ORDER = :WK_ORDER7
                OR P1.PICK_ORDER = :WK_ORDER8
                OR P1.PICK_ORDER = :WK_ORDER9
                OR P1.PICK_ORDER = :WK_ORDER10
                OR P1.PICK_ORDER = :WK_ORDER11
                OR P1.PICK_ORDER = :WK_ORDER12
                OR P1.PICK_ORDER = :WK_ORDER13
                OR P1.PICK_ORDER = :WK_ORDER14
                OR P1.PICK_ORDER = :WK_ORDER15
                OR P1.PICK_ORDER = :WK_ORDER16
                OR P1.PICK_ORDER = :WK_ORDER17
                OR P1.PICK_ORDER = :WK_ORDER18
                OR P1.PICK_ORDER = :WK_ORDER19
                OR P1.PICK_ORDER = :WK_ORDER20)
           AND  P1.PICK_ORDER_QTY > 0   
           AND P2.PICK_STATUS IN ('OP','DA')
           AND (P2.PICK_PRIORITY = :WK_PRIORITY1 
                OR P2.PICK_PRIORITY = :WK_PRIORITY2
                OR P2.PICK_PRIORITY = :WK_PRIORITY3
                OR P2.PICK_PRIORITY = :WK_PRIORITY4
                OR P2.PICK_PRIORITY = :WK_PRIORITY5)
           GROUP BY P1.PICK_ORDER
           HAVING COUNT(*) > 1
           ORDER BY P2.PICK_PRIORITY, P2.WIP_ORDERING, P1.WIP_PRELOCN_ORDERING, P1.PICK_LOCATION, P1.WIP_POSTLOCN_ORDERING 
         INTO :WK_ORDER 
      DO
      BEGIN
         SUSPEND;
      END
   END
   ELSE
   IF ((WK_ORDER_CNT > 0) AND
       (WK_TYPE_CNT > 0) AND
       (WK_ORDER_STATUS1 = 'GETALL') AND
       (WK_PRIORITY1 = 0)) THEN
   BEGIN
      FOR 
         SELECT P1.PICK_ORDER 
         FROM PICK_ITEM P1 
             JOIN PICK_ORDER P2 ON P2.PICK_ORDER = P1.PICK_ORDER 
         WHERE P1.PICK_LINE_STATUS IN ('OP','UP') 
           AND (P1.PICK_ORDER = :WK_ORDER1
                OR P1.PICK_ORDER = :WK_ORDER2
                OR P1.PICK_ORDER = :WK_ORDER3
                OR P1.PICK_ORDER = :WK_ORDER4
                OR P1.PICK_ORDER = :WK_ORDER5
                OR P1.PICK_ORDER = :WK_ORDER6
                OR P1.PICK_ORDER = :WK_ORDER7
                OR P1.PICK_ORDER = :WK_ORDER8
                OR P1.PICK_ORDER = :WK_ORDER9
                OR P1.PICK_ORDER = :WK_ORDER10
                OR P1.PICK_ORDER = :WK_ORDER11
                OR P1.PICK_ORDER = :WK_ORDER12
                OR P1.PICK_ORDER = :WK_ORDER13
                OR P1.PICK_ORDER = :WK_ORDER14
                OR P1.PICK_ORDER = :WK_ORDER15
                OR P1.PICK_ORDER = :WK_ORDER16
                OR P1.PICK_ORDER = :WK_ORDER17
                OR P1.PICK_ORDER = :WK_ORDER18
                OR P1.PICK_ORDER = :WK_ORDER19
                OR P1.PICK_ORDER = :WK_ORDER20)
           AND  P1.PICK_ORDER_QTY > 0   
           AND P2.PICK_STATUS IN ('OP','DA')
           AND (P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE1
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE2
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE3
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE4
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE5)
           GROUP BY P1.PICK_ORDER
           HAVING COUNT(*) > 1
           ORDER BY P2.PICK_PRIORITY, P2.WIP_ORDERING, P1.WIP_PRELOCN_ORDERING, P1.PICK_LOCATION, P1.WIP_POSTLOCN_ORDERING 
         INTO :WK_ORDER 
      DO
      BEGIN
         SUSPEND;
      END
   END
   ELSE
   IF ((WK_ORDER_CNT > 0) AND
       (WK_TYPE_CNT > 0) AND
       (WK_ORDER_STATUS1 = 'GETALL') AND
       (WK_PRIORITY_CNT > 0)) THEN
   BEGIN
      FOR 
         SELECT P1.PICK_ORDER 
         FROM PICK_ITEM P1 
             JOIN PICK_ORDER P2 ON P2.PICK_ORDER = P1.PICK_ORDER 
         WHERE P1.PICK_LINE_STATUS IN ('OP','UP') 
           AND (P1.PICK_ORDER = :WK_ORDER1
                OR P1.PICK_ORDER = :WK_ORDER2
                OR P1.PICK_ORDER = :WK_ORDER3
                OR P1.PICK_ORDER = :WK_ORDER4
                OR P1.PICK_ORDER = :WK_ORDER5
                OR P1.PICK_ORDER = :WK_ORDER6
                OR P1.PICK_ORDER = :WK_ORDER7
                OR P1.PICK_ORDER = :WK_ORDER8
                OR P1.PICK_ORDER = :WK_ORDER9
                OR P1.PICK_ORDER = :WK_ORDER10
                OR P1.PICK_ORDER = :WK_ORDER11
                OR P1.PICK_ORDER = :WK_ORDER12
                OR P1.PICK_ORDER = :WK_ORDER13
                OR P1.PICK_ORDER = :WK_ORDER14
                OR P1.PICK_ORDER = :WK_ORDER15
                OR P1.PICK_ORDER = :WK_ORDER16
                OR P1.PICK_ORDER = :WK_ORDER17
                OR P1.PICK_ORDER = :WK_ORDER18
                OR P1.PICK_ORDER = :WK_ORDER19
                OR P1.PICK_ORDER = :WK_ORDER20)
           AND  P1.PICK_ORDER_QTY > 0   
           AND P2.PICK_STATUS IN ('OP','DA')
           AND (P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE1
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE2
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE3
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE4
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE5)
           AND (P2.PICK_PRIORITY = :WK_PRIORITY1 
                OR P2.PICK_PRIORITY = :WK_PRIORITY2
                OR P2.PICK_PRIORITY = :WK_PRIORITY3
                OR P2.PICK_PRIORITY = :WK_PRIORITY4
                OR P2.PICK_PRIORITY = :WK_PRIORITY5)
           GROUP BY P1.PICK_ORDER
           HAVING COUNT(*) > 1
           ORDER BY P2.PICK_PRIORITY, P2.WIP_ORDERING, P1.WIP_PRELOCN_ORDERING, P1.PICK_LOCATION, P1.WIP_POSTLOCN_ORDERING 
         INTO :WK_ORDER 
      DO
      BEGIN
         SUSPEND;
      END
   END
   ELSE
   IF ((WK_ORDER_CNT > 0) AND
       (WK_TYPE_CNT > 0) AND
       (WK_STATUS_CNT > 0) AND
       (WK_PRIORITY1 = 0)) THEN
   BEGIN
      FOR 
         SELECT P1.PICK_ORDER 
         FROM PICK_ITEM P1 
             JOIN PICK_ORDER P2 ON P2.PICK_ORDER = P1.PICK_ORDER 
         WHERE (P1.PICK_LINE_STATUS = :WK_ORDER_STATUS1 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS2 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS3 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS4 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS5) 
           AND (P1.PICK_ORDER = :WK_ORDER1
                OR P1.PICK_ORDER = :WK_ORDER2
                OR P1.PICK_ORDER = :WK_ORDER3
                OR P1.PICK_ORDER = :WK_ORDER4
                OR P1.PICK_ORDER = :WK_ORDER5
                OR P1.PICK_ORDER = :WK_ORDER6
                OR P1.PICK_ORDER = :WK_ORDER7
                OR P1.PICK_ORDER = :WK_ORDER8
                OR P1.PICK_ORDER = :WK_ORDER9
                OR P1.PICK_ORDER = :WK_ORDER10
                OR P1.PICK_ORDER = :WK_ORDER11
                OR P1.PICK_ORDER = :WK_ORDER12
                OR P1.PICK_ORDER = :WK_ORDER13
                OR P1.PICK_ORDER = :WK_ORDER14
                OR P1.PICK_ORDER = :WK_ORDER15
                OR P1.PICK_ORDER = :WK_ORDER16
                OR P1.PICK_ORDER = :WK_ORDER17
                OR P1.PICK_ORDER = :WK_ORDER18
                OR P1.PICK_ORDER = :WK_ORDER19
                OR P1.PICK_ORDER = :WK_ORDER20)
           AND  P1.PICK_ORDER_QTY > 0   
           AND P2.PICK_STATUS IN ('OP','DA')
           AND (P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE1
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE2
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE3
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE4
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE5)
           GROUP BY P1.PICK_ORDER
           HAVING COUNT(*) > 1
           ORDER BY P2.PICK_PRIORITY, P2.WIP_ORDERING, P1.WIP_PRELOCN_ORDERING, P1.PICK_LOCATION, P1.WIP_POSTLOCN_ORDERING 
         INTO :WK_ORDER 
      DO
      BEGIN
         SUSPEND;
      END
   END
   ELSE
   IF ((WK_ORDER_CNT > 0) AND
       (WK_TYPE_CNT > 0) AND
       (WK_STATUS_CNT > 0) AND
       (WK_PRIORITY_CNT > 0)) THEN
   BEGIN
      FOR 
         SELECT P1.PICK_ORDER 
         FROM PICK_ITEM P1 
             JOIN PICK_ORDER P2 ON P2.PICK_ORDER = P1.PICK_ORDER 
         WHERE (P1.PICK_LINE_STATUS = :WK_ORDER_STATUS1 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS2 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS3 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS4 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS5) 
           AND (P1.PICK_ORDER = :WK_ORDER1
                OR P1.PICK_ORDER = :WK_ORDER2
                OR P1.PICK_ORDER = :WK_ORDER3
                OR P1.PICK_ORDER = :WK_ORDER4
                OR P1.PICK_ORDER = :WK_ORDER5
                OR P1.PICK_ORDER = :WK_ORDER6
                OR P1.PICK_ORDER = :WK_ORDER7
                OR P1.PICK_ORDER = :WK_ORDER8
                OR P1.PICK_ORDER = :WK_ORDER9
                OR P1.PICK_ORDER = :WK_ORDER10
                OR P1.PICK_ORDER = :WK_ORDER11
                OR P1.PICK_ORDER = :WK_ORDER12
                OR P1.PICK_ORDER = :WK_ORDER13
                OR P1.PICK_ORDER = :WK_ORDER14
                OR P1.PICK_ORDER = :WK_ORDER15
                OR P1.PICK_ORDER = :WK_ORDER16
                OR P1.PICK_ORDER = :WK_ORDER17
                OR P1.PICK_ORDER = :WK_ORDER18
                OR P1.PICK_ORDER = :WK_ORDER19
                OR P1.PICK_ORDER = :WK_ORDER20)
           AND  P1.PICK_ORDER_QTY > 0   
           AND P2.PICK_STATUS IN ('OP','DA')
           AND (P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE1
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE2
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE3
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE4
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE5)
           AND (P2.PICK_PRIORITY = :WK_PRIORITY1 
                OR P2.PICK_PRIORITY = :WK_PRIORITY2
                OR P2.PICK_PRIORITY = :WK_PRIORITY3
                OR P2.PICK_PRIORITY = :WK_PRIORITY4
                OR P2.PICK_PRIORITY = :WK_PRIORITY5)
           GROUP BY P1.PICK_ORDER
           HAVING COUNT(*) > 1
           ORDER BY P2.PICK_PRIORITY, P2.WIP_ORDERING, P1.WIP_PRELOCN_ORDERING, P1.PICK_LOCATION, P1.WIP_POSTLOCN_ORDERING 
         INTO :WK_ORDER 
      DO
      BEGIN
         SUSPEND;
      END
   END
   EXIT;
END ^

ALTER PROCEDURE PICK_MODE_P4 (WK_ORDER_TYPES VARCHAR(255) CHARACTER SET NONE,
WK_ORDER_MODES VARCHAR(255) CHARACTER SET NONE,
WK_ORDERS VARCHAR(255) CHARACTER SET NONE,
WK_ORDER_STATUSES VARCHAR(255) CHARACTER SET NONE,
WK_ORDER_PRIORITYS VARCHAR(255) CHARACTER SET NONE,
WK_PARAM_IDS VARCHAR(255) CHARACTER SET NONE)
RETURNS (WK_ORDER VARCHAR(15) CHARACTER SET NONE)
AS 
 
 
DECLARE VARIABLE WK_DELIM CHAR(1);
DECLARE VARIABLE WK_FOUND INTEGER;
DECLARE VARIABLE WK_ORDER_TYPE1 VARCHAR(10);
DECLARE VARIABLE WK_TYPE_CNT INTEGER;
DECLARE VARIABLE WK_ORDER_STATUS1 VARCHAR(10);
DECLARE VARIABLE WK_STATUS_CNT INTEGER;
DECLARE VARIABLE WK_PRIORITY1 INTEGER;
DECLARE VARIABLE WK_PRIORITY_CNT INTEGER;
DECLARE VARIABLE WK_ORDER_CNT INTEGER;
DECLARE VARIABLE WK_IDX INTEGER;
DECLARE VARIABLE WK_COND VARCHAR(35);
DECLARE VARIABLE WK_ORDER1 VARCHAR(15);
DECLARE VARIABLE WK_PROD_CNT INTEGER;
DECLARE VARIABLE WK_PROD1 VARCHAR(30);
DECLARE VARIABLE WK_PROD2 VARCHAR(30);
DECLARE VARIABLE WK_PROD3 VARCHAR(30);
DECLARE VARIABLE WK_PROD4 VARCHAR(30);
DECLARE VARIABLE WK_PROD5 VARCHAR(30);
DECLARE VARIABLE WK_PROD6 VARCHAR(30);
DECLARE VARIABLE WK_PROD7 VARCHAR(30);
DECLARE VARIABLE WK_PROD8 VARCHAR(30);
DECLARE VARIABLE WK_PROD9 VARCHAR(30);
DECLARE VARIABLE WK_PROD10 VARCHAR(30);
DECLARE VARIABLE WK_PROD11 VARCHAR(30);
DECLARE VARIABLE WK_PROD12 VARCHAR(30);
DECLARE VARIABLE WK_PROD13 VARCHAR(30);
DECLARE VARIABLE WK_PROD14 VARCHAR(30);
DECLARE VARIABLE WK_PROD15 VARCHAR(30);
DECLARE VARIABLE WK_PROD16 VARCHAR(30);
DECLARE VARIABLE WK_PROD17 VARCHAR(30);
DECLARE VARIABLE WK_PROD18 VARCHAR(30);
DECLARE VARIABLE WK_PROD19 VARCHAR(30);
DECLARE VARIABLE WK_PROD20 VARCHAR(30);

BEGIN
   WK_DELIM = '|';
   WK_ORDER_TYPE1 = '';
   WK_ORDER_STATUS1 = '';
   WK_ORDER1 = '';
   WK_PRIORITY1 = -32000;
   WK_PROD1 = '';
   WK_PROD2 = '';
   WK_PROD3 = '';
   WK_PROD4 = '';
   WK_PROD5 = '';
   WK_PROD6 = '';
   WK_PROD7 = '';
   WK_PROD8 = '';
   WK_PROD9 = '';
   WK_PROD10 = '';
   WK_PROD11 = '';
   WK_PROD12 = '';
   WK_PROD13 = '';
   WK_PROD14 = '';
   WK_PROD15 = '';
   WK_PROD16 = '';
   WK_PROD17 = '';
   WK_PROD18 = '';
   WK_PROD19 = '';
   WK_PROD20 = '';
   /* normally only one order type but glen wants several or GETALL */
   /* IF (WK_ORDER_TYPES = 'GETALL') THEN */
   BEGIN
      WK_ORDER_TYPE1 = 'GETALL';
      WK_TYPE_CNT = 1;
   END

   /* normally GETALL in the mode - unused field */

   /* order statuses - why this ?? - must be confirmed lines OP or UP */
   /* IF (WK_ORDER_STATUSES = 'GETALL') THEN */
   BEGIN
      WK_ORDER_STATUS1 = 'GETALL';
      WK_STATUS_CNT = 1;
   END

   /* ordno is a list of orders or GETALL */
   /* orders are length 9 or 10 for internal */
   /* so can have a maximum of 255 = (1 + n*10) */   
   /* thus n = 25 */
   /* calc orders 1 - 25 */
   /* but only allow upto 20 */
   /* IF (WK_ORDERS = 'GETALL') THEN */
   BEGIN
      WK_ORDER1 = 'GETALL';
      WK_ORDER_CNT = 1;
   END

   /* order priorities 0 = GETALL or a specific priority */
   /* priorities are small int - range -32768 - +32767 */
   /* but really 0 - 9 and -9 - -1 since a 1 char display */
   /* so a max of 19 */
   /* but only allow upto 2 */

   /* IF (WK_ORDER_PRIORITYS = 'GETALL') THEN */
   BEGIN
      WK_PRIORITY1 = 0;
      WK_STATUS_CNT = 1;
   END

   /* parms for a specifiy procedure either GETALL or a LIST */
   /* for P4 this is GETALL */
   /* pre pack orders ie kits only */
   /* so can have a maximum of 255 = (1 + n*14) */   
   /* thus n = 18 */
   /* calc prods 1 - 18 */
   /* but only allow upto 20 */
   IF (WK_PARAM_IDS = 'GETALL') THEN
   BEGIN
      WK_PROD1 = 'GETALL';
      WK_PROD_CNT = 1;
   END
   ELSE
   BEGIN
      WK_PROD_CNT = 0;
      WK_IDX = 1;
      WK_COND = ALLTRIM(PARSE(:WK_PARAM_IDS,:WK_DELIM,:WK_IDX));
      WHILE (WK_COND <> 'Token to long in parse') DO 
      BEGIN
         WK_PROD_CNT = WK_PROD_CNT + 1;
         IF (WK_PROD_CNT = 1) THEN
            WK_PROD1 = WK_COND;
         ELSE
         IF (WK_PROD_CNT = 2) THEN
            WK_PROD2 = WK_COND;
         ELSE
         IF (WK_PROD_CNT = 3) THEN
            WK_PROD3 = WK_COND;
         ELSE
         IF (WK_PROD_CNT = 4) THEN
            WK_PROD4 = WK_COND;
         ELSE
         IF (WK_PROD_CNT = 5) THEN
            WK_PROD5 = WK_COND;
         ELSE
         IF (WK_PROD_CNT = 6) THEN
            WK_PROD6 = WK_COND;
         ELSE
         IF (WK_PROD_CNT = 7) THEN
            WK_PROD7 = WK_COND;
         ELSE
         IF (WK_PROD_CNT = 8) THEN
            WK_PROD8 = WK_COND;
         ELSE
         IF (WK_PROD_CNT = 9) THEN
            WK_PROD9 = WK_COND;
         ELSE
         IF (WK_PROD_CNT = 10) THEN
            WK_PROD10 = WK_COND;
         ELSE
         IF (WK_PROD_CNT = 11) THEN
            WK_PROD11 = WK_COND;
         ELSE
         IF (WK_PROD_CNT = 12) THEN
            WK_PROD12 = WK_COND;
         ELSE
         IF (WK_PROD_CNT = 13) THEN
            WK_PROD13 = WK_COND;
         ELSE
         IF (WK_PROD_CNT = 14) THEN
            WK_PROD14 = WK_COND;
         ELSE
         IF (WK_PROD_CNT = 15) THEN
            WK_PROD15 = WK_COND;
         ELSE
         IF (WK_PROD_CNT = 16) THEN
            WK_PROD16 = WK_COND;
         ELSE
         IF (WK_PROD_CNT = 17) THEN
            WK_PROD17 = WK_COND;
         ELSE
         IF (WK_PROD_CNT = 18) THEN
            WK_PROD18 = WK_COND;
         ELSE
         IF (WK_PROD_CNT = 19) THEN
            WK_PROD19 = WK_COND;
         ELSE
         IF (WK_PROD_CNT = 20) THEN
            WK_PROD20 = WK_COND;
         /* get next PROD */
         WK_IDX = WK_IDX + 1;
         WK_COND = ALLTRIM(PARSE(:WK_PARAM_IDS,:WK_DELIM,:WK_IDX));
      END
   END

   IF ((WK_ORDER1 = 'GETALL') AND
       (WK_ORDER_TYPE1 = 'GETALL') AND
       (WK_ORDER_STATUS1 = 'GETALL') AND
       (WK_PRIORITY1 = 0) AND
       (WK_PROD1 = 'GETALL')) THEN
   BEGIN
      FOR 
         /*  GROUP BY P1.PICK_ORDER */
         SELECT DISTINCT(P1.PICK_ORDER) 
         FROM PICK_ITEM P1 
             JOIN PICK_ORDER P2 ON P2.PICK_ORDER = P1.PICK_ORDER 
             JOIN KIT P3 ON P3.KIT_ID = P1.PROD_ID 
         WHERE P1.PICK_LINE_STATUS IN ('OP','UP') 
           AND  P1.PICK_ORDER_QTY > 0   
           AND P2.PICK_STATUS IN ('OP','DA')
           ORDER BY P2.PICK_PRIORITY, P2.WIP_ORDERING, P1.WIP_PRELOCN_ORDERING, P1.PICK_LOCATION, P1.WIP_POSTLOCN_ORDERING 
         INTO :WK_ORDER 
      DO
      BEGIN
         /* OK now have orders with at least 1 kitted product */
         WK_FOUND = 0;
         SELECT 1 
         FROM PICK_ITEM P1
         LEFT OUTER JOIN KIT P3 ON P3.KIT_ID = P1.PROD_ID 
         WHERE P1.PICK_ORDER = :WK_ORDER
         GROUP BY P1.PICK_ORDER
         HAVING COUNT(*) = COUNT(P3.KIT_ID)
         INTO :WK_FOUND;
         IF (WK_FOUND = 1) THEN
         BEGIN
            /* ok have only kitted products here */
            SUSPEND;
         END
      END
   END
   ELSE
   IF ((WK_ORDER1 = 'GETALL') AND
       (WK_ORDER_TYPE1 = 'GETALL') AND
       (WK_ORDER_STATUS1 = 'GETALL') AND
       (WK_PRIORITY1 = 0) AND
       (WK_PROD_CNT > 0)) THEN
   BEGIN
      FOR 
         /*  GROUP BY P1.PICK_ORDER */
         SELECT DISTINCT(P1.PICK_ORDER) 
         FROM PICK_ITEM P1 
             JOIN PICK_ORDER P2 ON P2.PICK_ORDER = P1.PICK_ORDER 
             JOIN KIT P3 ON P3.KIT_ID = P1.PROD_ID 
         WHERE P1.PICK_LINE_STATUS IN ('OP','UP') 
           AND  P1.PICK_ORDER_QTY > 0   
           AND (P1.PROD_ID = :WK_PROD1
                OR P1.PROD_ID = :WK_PROD2
                OR P1.PROD_ID = :WK_PROD3
                OR P1.PROD_ID = :WK_PROD4
                OR P1.PROD_ID = :WK_PROD5
                OR P1.PROD_ID = :WK_PROD6
                OR P1.PROD_ID = :WK_PROD7
                OR P1.PROD_ID = :WK_PROD8
                OR P1.PROD_ID = :WK_PROD9
                OR P1.PROD_ID = :WK_PROD10
                OR P1.PROD_ID = :WK_PROD11
                OR P1.PROD_ID = :WK_PROD12
                OR P1.PROD_ID = :WK_PROD13
                OR P1.PROD_ID = :WK_PROD14
                OR P1.PROD_ID = :WK_PROD15
                OR P1.PROD_ID = :WK_PROD16
                OR P1.PROD_ID = :WK_PROD17
                OR P1.PROD_ID = :WK_PROD18
                OR P1.PROD_ID = :WK_PROD19
                OR P1.PROD_ID = :WK_PROD20)
           AND P2.PICK_STATUS IN ('OP','DA')
           ORDER BY P2.PICK_PRIORITY, P2.WIP_ORDERING, P1.WIP_PRELOCN_ORDERING, P1.PICK_LOCATION, P1.WIP_POSTLOCN_ORDERING 
         INTO :WK_ORDER 
      DO
      BEGIN
         /* OK now have orders for the named product */
         WK_FOUND = 0;
         SELECT 1 
         FROM PICK_ITEM P1
         LEFT OUTER JOIN KIT P3 ON P3.KIT_ID = P1.PROD_ID 
         WHERE P1.PICK_ORDER = :WK_ORDER
         GROUP BY P1.PICK_ORDER
         HAVING COUNT(*) = COUNT(P3.KIT_ID)
         INTO :WK_FOUND;
         IF (WK_FOUND = 1) THEN
         BEGIN
            /* ok have only kitted products here */
            SUSPEND;
         END
      END
   END
   EXIT;
END ^

ALTER PROCEDURE PICK_MODE_P5 (WK_ORDER_TYPES VARCHAR(255) CHARACTER SET NONE,
WK_ORDER_MODES VARCHAR(255) CHARACTER SET NONE,
WK_ORDERS VARCHAR(255) CHARACTER SET NONE,
WK_ORDER_STATUSES VARCHAR(255) CHARACTER SET NONE,
WK_ORDER_PRIORITYS VARCHAR(255) CHARACTER SET NONE,
WK_PARAM_IDS VARCHAR(255) CHARACTER SET NONE)
RETURNS (WK_ORDER VARCHAR(15) CHARACTER SET NONE)
AS 
 
 
 
DECLARE VARIABLE WK_DELIM CHAR(1);
DECLARE VARIABLE WK_FOUND INTEGER;
DECLARE VARIABLE WK_ORDER_TYPE1 VARCHAR(10);
DECLARE VARIABLE WK_TYPE_CNT INTEGER;
DECLARE VARIABLE WK_ORDER_STATUS1 VARCHAR(10);
DECLARE VARIABLE WK_STATUS_CNT INTEGER;
DECLARE VARIABLE WK_PRIORITY1 INTEGER;
DECLARE VARIABLE WK_PRIORITY_CNT INTEGER;
DECLARE VARIABLE WK_ORDER_CNT INTEGER;
DECLARE VARIABLE WK_IDX INTEGER;
DECLARE VARIABLE WK_COND VARCHAR(35);
DECLARE VARIABLE WK_ORDER1 VARCHAR(15);
DECLARE VARIABLE WK_GROUP_CNT INTEGER;
DECLARE VARIABLE WK_GROUP1 VARCHAR(15);
DECLARE VARIABLE WK_GROUP2 VARCHAR(15);
DECLARE VARIABLE WK_GROUP3 VARCHAR(15);
DECLARE VARIABLE WK_GROUP4 VARCHAR(15);
DECLARE VARIABLE WK_GROUP5 VARCHAR(15);
DECLARE VARIABLE WK_GROUP6 VARCHAR(15);
DECLARE VARIABLE WK_GROUP7 VARCHAR(15);
DECLARE VARIABLE WK_GROUP8 VARCHAR(15);
DECLARE VARIABLE WK_GROUP9 VARCHAR(15);
DECLARE VARIABLE WK_GROUP10 VARCHAR(15);
DECLARE VARIABLE WK_GROUP11 VARCHAR(15);
DECLARE VARIABLE WK_GROUP12 VARCHAR(15);
DECLARE VARIABLE WK_GROUP13 VARCHAR(15);
DECLARE VARIABLE WK_GROUP14 VARCHAR(15);
DECLARE VARIABLE WK_GROUP15 VARCHAR(15);
DECLARE VARIABLE WK_GROUP16 VARCHAR(15);
DECLARE VARIABLE WK_GROUP17 VARCHAR(15);
DECLARE VARIABLE WK_GROUP18 VARCHAR(15);
DECLARE VARIABLE WK_GROUP19 VARCHAR(15);
DECLARE VARIABLE WK_GROUP20 VARCHAR(15);

BEGIN
   WK_DELIM = '|';
   WK_ORDER_TYPE1 = '';
   WK_ORDER_STATUS1 = '';
   WK_ORDER1 = '';
   WK_GROUP1 = '';
   WK_GROUP2 = '';
   WK_GROUP3 = '';
   WK_GROUP4 = '';
   WK_GROUP5 = '';
   WK_GROUP6 = '';
   WK_GROUP7 = '';
   WK_GROUP8 = '';
   WK_GROUP9 = '';
   WK_GROUP10 = '';
   WK_GROUP11 = '';
   WK_GROUP12 = '';
   WK_GROUP13 = '';
   WK_GROUP14 = '';
   WK_GROUP15 = '';
   WK_GROUP16 = '';
   WK_GROUP17 = '';
   WK_GROUP18 = '';
   WK_GROUP19 = '';
   WK_GROUP20 = '';
   WK_PRIORITY1 = -32000;
   /* only allow all -> GETALL */
   /* IF (WK_ORDER_TYPES = 'GETALL') THEN */
   BEGIN
      WK_ORDER_TYPE1 = 'GETALL';
      WK_TYPE_CNT = 1;
   END

   /* normally GETALL in the mode - unused field */

   /* order statuses - why this ?? - must be confirmed lines OP or UP */
   /* only allow all */
   /* IF (WK_ORDER_STATUSES = 'GETALL') THEN */
   BEGIN
      WK_ORDER_STATUS1 = 'GETALL';
      WK_STATUS_CNT = 1;
   END

   /* ordno is GETALL */
   /* IF (WK_ORDERS = 'GETALL') THEN */
   BEGIN
      WK_ORDER1 = 'GETALL';
      WK_ORDER_CNT = 1;
   END

   /* order priorities 0 = GETALL or a specific priority */
   /* but only allow 0 */

   /* IF (WK_ORDER_PRIORITYS = 'GETALL') THEN */
   BEGIN
      WK_PRIORITY1 = 0;
      WK_STATUS_CNT = 1;
   END

   /* parms for a specifiy procedure either GETALL or a LIST */
   /* for P5 this is GETALL or a list of GROUPS */

   /* groups are upto 10 say 2 - 10 */
   /* so can have a maximum of 255 = (1 + n*3) or (1 + n*11) */   
   /* thus n = 84 to 23 */
   /* but only allow upto 20 */
   IF (WK_PARAM_IDS = 'GETALL') THEN
   BEGIN
      WK_GROUP1 = 'GETALL';
      WK_GROUP_CNT = 1;
   END
   ELSE
   BEGIN
      WK_GROUP_CNT = 0;
      WK_IDX = 1;
      WK_COND = ALLTRIM(PARSE(:WK_PARAM_IDS,:WK_DELIM,:WK_IDX));
      WHILE (WK_COND <> 'Token to long in parse') DO 
      BEGIN
         WK_GROUP_CNT = WK_GROUP_CNT + 1;
         IF (WK_GROUP_CNT = 1) THEN
            WK_GROUP1 = WK_COND;
         ELSE
         IF (WK_GROUP_CNT = 2) THEN
            WK_GROUP2 = WK_COND;
         ELSE
         IF (WK_GROUP_CNT = 3) THEN
            WK_GROUP3 = WK_COND;
         ELSE
         IF (WK_GROUP_CNT = 4) THEN
            WK_GROUP4 = WK_COND;
         ELSE
         IF (WK_GROUP_CNT = 5) THEN
            WK_GROUP5 = WK_COND;
         ELSE
         IF (WK_GROUP_CNT = 6) THEN
            WK_GROUP6 = WK_COND;
         ELSE
         IF (WK_GROUP_CNT = 7) THEN
            WK_GROUP7 = WK_COND;
         ELSE
         IF (WK_GROUP_CNT = 8) THEN
            WK_GROUP8 = WK_COND;
         ELSE
         IF (WK_GROUP_CNT = 9) THEN
            WK_GROUP9 = WK_COND;
         ELSE
         IF (WK_GROUP_CNT = 10) THEN
            WK_GROUP10 = WK_COND;
         ELSE
         IF (WK_GROUP_CNT = 11) THEN
            WK_GROUP11 = WK_COND;
         ELSE
         IF (WK_GROUP_CNT = 12) THEN
            WK_GROUP12 = WK_COND;
         ELSE
         IF (WK_GROUP_CNT = 13) THEN
            WK_GROUP13 = WK_COND;
         ELSE
         IF (WK_GROUP_CNT = 14) THEN
            WK_GROUP14 = WK_COND;
         ELSE
         IF (WK_GROUP_CNT = 15) THEN
            WK_GROUP15 = WK_COND;
         ELSE
         IF (WK_GROUP_CNT = 16) THEN
            WK_GROUP16 = WK_COND;
         ELSE
         IF (WK_GROUP_CNT = 17) THEN
            WK_GROUP17 = WK_COND;
         ELSE
         IF (WK_GROUP_CNT = 18) THEN
            WK_GROUP18 = WK_COND;
         ELSE
         IF (WK_GROUP_CNT = 19) THEN
            WK_GROUP19 = WK_COND;
         ELSE
         IF (WK_GROUP_CNT = 20) THEN
            WK_GROUP20 = WK_COND;
         /* get next GROUP */
         WK_IDX = WK_IDX + 1;
         WK_COND = ALLTRIM(PARSE(:WK_PARAM_IDS,:WK_DELIM,:WK_IDX));
      END
   END

   /* only want group orders */

   IF ((WK_ORDER1 = 'GETALL') AND
       (WK_ORDER_TYPE1 = 'GETALL') AND
       (WK_ORDER_STATUS1 = 'GETALL') AND
       (WK_PRIORITY1 = 0) AND
       (WK_GROUP1 = 'GETALL')) THEN
   BEGIN
      /*   GROUP BY P1.PICK_ORDER */
      FOR 
         SELECT DISTINCT(P1.PICK_ORDER) 
         FROM PICK_ITEM P1 
             JOIN PICK_ORDER P2 ON P2.PICK_ORDER = P1.PICK_ORDER 
             JOIN PICK_ORDER_GROUP P3 ON P3.PICK_ORDER = P1.PICK_ORDER 
         WHERE P1.PICK_LINE_STATUS IN ('OP','UP') 
           AND  P1.PICK_ORDER_QTY > 0   
           AND P2.PICK_STATUS IN ('OP','DA')
           AND P3.STATUS = 'OK'
           ORDER BY P2.PICK_PRIORITY, P2.WIP_ORDERING, P1.WIP_PRELOCN_ORDERING, P1.PICK_LOCATION, P1.WIP_POSTLOCN_ORDERING 
         INTO :WK_ORDER 
      DO
      BEGIN
         SUSPEND;
      END
   END
   ELSE
   IF ((WK_ORDER1 = 'GETALL') AND
       (WK_ORDER_TYPE1 = 'GETALL') AND
       (WK_ORDER_STATUS1 = 'GETALL') AND
       (WK_PRIORITY1 = 0) AND
       (WK_GROUP_CNT > 0)) THEN
   BEGIN
      /*   GROUP BY P1.PICK_ORDER */
      FOR 
         SELECT DISTINCT(P1.PICK_ORDER) 
         FROM PICK_ITEM P1 
             JOIN PICK_ORDER P2 ON P2.PICK_ORDER = P1.PICK_ORDER 
             JOIN PICK_ORDER_GROUP P3 ON P3.PICK_ORDER = P1.PICK_ORDER 
         WHERE P1.PICK_LINE_STATUS IN ('OP','UP') 
           AND  P1.PICK_ORDER_QTY > 0   
           AND P2.PICK_STATUS IN ('OP','DA')
           AND P3.STATUS = 'OK'
           AND (P3.ORDER_GROUP_ID = :WK_GROUP1
                OR P3.ORDER_GROUP_ID = :WK_GROUP2
                OR P3.ORDER_GROUP_ID = :WK_GROUP3
                OR P3.ORDER_GROUP_ID = :WK_GROUP4
                OR P3.ORDER_GROUP_ID = :WK_GROUP5
                OR P3.ORDER_GROUP_ID = :WK_GROUP6
                OR P3.ORDER_GROUP_ID = :WK_GROUP7
                OR P3.ORDER_GROUP_ID = :WK_GROUP8
                OR P3.ORDER_GROUP_ID = :WK_GROUP9
                OR P3.ORDER_GROUP_ID = :WK_GROUP10
                OR P3.ORDER_GROUP_ID = :WK_GROUP11
                OR P3.ORDER_GROUP_ID = :WK_GROUP12
                OR P3.ORDER_GROUP_ID = :WK_GROUP13
                OR P3.ORDER_GROUP_ID = :WK_GROUP14
                OR P3.ORDER_GROUP_ID = :WK_GROUP15
                OR P3.ORDER_GROUP_ID = :WK_GROUP16
                OR P3.ORDER_GROUP_ID = :WK_GROUP17
                OR P3.ORDER_GROUP_ID = :WK_GROUP18
                OR P3.ORDER_GROUP_ID = :WK_GROUP19
                OR P3.ORDER_GROUP_ID = :WK_GROUP20)
           ORDER BY P2.PICK_PRIORITY, P2.WIP_ORDERING, P1.WIP_PRELOCN_ORDERING, P1.PICK_LOCATION, P1.WIP_POSTLOCN_ORDERING 
         INTO :WK_ORDER 
      DO
      BEGIN
         SUSPEND;
      END
   END

   EXIT;
END ^

ALTER PROCEDURE PICK_MODE_P8 (WK_ORDER_TYPES VARCHAR(255) CHARACTER SET NONE,
WK_ORDER_MODES VARCHAR(255) CHARACTER SET NONE,
WK_ORDERS VARCHAR(255) CHARACTER SET NONE,
WK_ORDER_STATUSES VARCHAR(255) CHARACTER SET NONE,
WK_ORDER_PRIORITYS VARCHAR(255) CHARACTER SET NONE,
WK_PARAM_IDS VARCHAR(255) CHARACTER SET NONE)
RETURNS (WK_ORDER VARCHAR(15) CHARACTER SET NONE)
AS 
 
 
DECLARE VARIABLE WK_DELIM CHAR(1);
DECLARE VARIABLE WK_FOUND INTEGER;
DECLARE VARIABLE WK_ORDER_TYPE1 VARCHAR(10);
DECLARE VARIABLE WK_ORDER_TYPE2 VARCHAR(10);
DECLARE VARIABLE WK_ORDER_TYPE3 VARCHAR(10);
DECLARE VARIABLE WK_ORDER_TYPE4 VARCHAR(10);
DECLARE VARIABLE WK_ORDER_TYPE5 VARCHAR(10);
DECLARE VARIABLE WK_TYPE_CNT INTEGER;
DECLARE VARIABLE WK_ORDER_STATUS1 VARCHAR(10);
DECLARE VARIABLE WK_ORDER_STATUS2 VARCHAR(10);
DECLARE VARIABLE WK_ORDER_STATUS3 VARCHAR(10);
DECLARE VARIABLE WK_ORDER_STATUS4 VARCHAR(10);
DECLARE VARIABLE WK_ORDER_STATUS5 VARCHAR(10);
DECLARE VARIABLE WK_STATUS_CNT INTEGER;
DECLARE VARIABLE WK_PRIORITY1 INTEGER;
DECLARE VARIABLE WK_PRIORITY2 INTEGER;
DECLARE VARIABLE WK_PRIORITY3 INTEGER;
DECLARE VARIABLE WK_PRIORITY4 INTEGER;
DECLARE VARIABLE WK_PRIORITY5 INTEGER;
DECLARE VARIABLE WK_PRIORITY_CNT INTEGER;
DECLARE VARIABLE WK_ORDER_CNT INTEGER;
DECLARE VARIABLE WK_IDX INTEGER;
DECLARE VARIABLE WK_COND VARCHAR(35);
DECLARE VARIABLE WK_ORDER1 VARCHAR(15);
DECLARE VARIABLE WK_ORDER2 VARCHAR(15);
DECLARE VARIABLE WK_ORDER3 VARCHAR(15);
DECLARE VARIABLE WK_ORDER4 VARCHAR(15);
DECLARE VARIABLE WK_ORDER5 VARCHAR(15);
DECLARE VARIABLE WK_ORDER6 VARCHAR(15);
DECLARE VARIABLE WK_ORDER7 VARCHAR(15);
DECLARE VARIABLE WK_ORDER8 VARCHAR(15);
DECLARE VARIABLE WK_ORDER9 VARCHAR(15);
DECLARE VARIABLE WK_ORDER10 VARCHAR(15);
DECLARE VARIABLE WK_ORDER11 VARCHAR(15);
DECLARE VARIABLE WK_ORDER12 VARCHAR(15);
DECLARE VARIABLE WK_ORDER13 VARCHAR(15);
DECLARE VARIABLE WK_ORDER14 VARCHAR(15);
DECLARE VARIABLE WK_ORDER15 VARCHAR(15);
DECLARE VARIABLE WK_ORDER16 VARCHAR(15);
DECLARE VARIABLE WK_ORDER17 VARCHAR(15);
DECLARE VARIABLE WK_ORDER18 VARCHAR(15);
DECLARE VARIABLE WK_ORDER19 VARCHAR(15);
DECLARE VARIABLE WK_ORDER20 VARCHAR(15);

BEGIN
   WK_DELIM = '|';
   WK_ORDER_TYPE1 = '';
   WK_ORDER_TYPE2 = '';
   WK_ORDER_TYPE3 = '';
   WK_ORDER_TYPE4 = '';
   WK_ORDER_TYPE5 = '';
   WK_ORDER_STATUS1 = '';
   WK_ORDER_STATUS2 = '';
   WK_ORDER_STATUS3 = '';
   WK_ORDER_STATUS4 = '';
   WK_ORDER_STATUS5 = '';
   WK_ORDER1 = '';
   WK_ORDER2 = '';
   WK_ORDER3 = '';
   WK_ORDER4 = '';
   WK_ORDER5 = '';
   WK_ORDER6 = '';
   WK_ORDER7 = '';
   WK_ORDER8 = '';
   WK_ORDER9 = '';
   WK_ORDER10 = '';
   WK_ORDER11 = '';
   WK_ORDER12 = '';
   WK_ORDER13 = '';
   WK_ORDER14 = '';
   WK_ORDER15 = '';
   WK_ORDER16 = '';
   WK_ORDER17 = '';
   WK_ORDER18 = '';
   WK_ORDER19 = '';
   WK_ORDER20 = '';
   WK_PRIORITY1 = -32000;
   WK_PRIORITY2 = -32000;
   WK_PRIORITY3 = -32000;
   WK_PRIORITY4 = -32000;
   WK_PRIORITY5 = -32000;
   /* normally only one order type but glen wants several or GETALL */
   IF (WK_ORDER_TYPES = 'GETALL') THEN
   BEGIN
      WK_ORDER_TYPE1 = 'GETALL';
      WK_TYPE_CNT = 1;
   END
   ELSE
   BEGIN
      /* allow up to 5 types */
      WK_TYPE_CNT = 0;
      WK_IDX = 1;
      WK_COND = ALLTRIM(PARSE(:WK_ORDER_TYPES,:WK_DELIM,:WK_IDX));
      WHILE (WK_COND <> 'Token to long in parse') DO 
      BEGIN
         WK_TYPE_CNT = WK_TYPE_CNT + 1;
         IF (WK_TYPE_CNT = 1) THEN
            WK_ORDER_TYPE1 = WK_COND;
         ELSE
         IF (WK_TYPE_CNT = 2) THEN
            WK_ORDER_TYPE2 = WK_COND;
         ELSE
         IF (WK_TYPE_CNT = 3) THEN
            WK_ORDER_TYPE3 = WK_COND;
         ELSE
         IF (WK_TYPE_CNT = 4) THEN
            WK_ORDER_TYPE4 = WK_COND;
         ELSE
         IF (WK_TYPE_CNT = 5) THEN
            WK_ORDER_TYPE5 = WK_COND;
         /* get next type */
         WK_IDX = WK_IDX + 1;
         WK_COND = ALLTRIM(PARSE(:WK_ORDER_TYPES,:WK_DELIM,:WK_IDX));
      END
   END

   /* normally GETALL in the mode - unused field */

   /* order statuses - why this ?? - must be confirmed lines OP or UP */
   IF (WK_ORDER_STATUSES = 'GETALL') THEN
   BEGIN
      WK_ORDER_STATUS1 = 'GETALL';
      WK_STATUS_CNT = 1;
   END
   ELSE
   BEGIN
      /* allow up to 5 STATUSs */
      WK_STATUS_CNT = 0;
      WK_IDX = 1;
      WK_COND = ALLTRIM(PARSE(:WK_ORDER_STATUSES,:WK_DELIM,:WK_IDX));
      WHILE (WK_COND <> 'Token to long in parse') DO 
      BEGIN
         WK_STATUS_CNT = WK_STATUS_CNT + 1;
         IF (WK_STATUS_CNT = 1) THEN
            WK_ORDER_STATUS1 = WK_COND;
         ELSE
         IF (WK_STATUS_CNT = 2) THEN
            WK_ORDER_STATUS2 = WK_COND;
         ELSE
         IF (WK_STATUS_CNT = 3) THEN
            WK_ORDER_STATUS3 = WK_COND;
         ELSE
         IF (WK_STATUS_CNT = 4) THEN
            WK_ORDER_STATUS4 = WK_COND;
         ELSE
         IF (WK_STATUS_CNT = 5) THEN
            WK_ORDER_STATUS5 = WK_COND;
         /* get next STATUS */
         WK_IDX = WK_IDX + 1;
         WK_COND = ALLTRIM(PARSE(:WK_ORDER_STATUSES,:WK_DELIM,:WK_IDX));
      END
   END

   /* ordno is a list of orders or GETALL */
   /* orders are length 9 or 10 for internal */
   /* so can have a maximum of 255 = (1 + n*10) */   
   /* thus n = 25 */
   /* calc orders 1 - 25 */
   /* but only allow upto 20 */
   IF (WK_ORDERS = 'GETALL') THEN
   BEGIN
      WK_ORDER1 = 'GETALL';
      WK_ORDER_CNT = 1;
   END
   ELSE
   BEGIN
      WK_ORDER_CNT = 0;
      WK_IDX = 1;
      WK_COND = ALLTRIM(PARSE(:WK_ORDERS,:WK_DELIM,:WK_IDX));
      WHILE (WK_COND <> 'Token to long in parse') DO 
      BEGIN
         WK_ORDER_CNT = WK_ORDER_CNT + 1;
         IF (WK_ORDER_CNT = 1) THEN
            WK_ORDER1 = WK_COND;
         ELSE
         IF (WK_ORDER_CNT = 2) THEN
            WK_ORDER2 = WK_COND;
         ELSE
         IF (WK_ORDER_CNT = 3) THEN
            WK_ORDER3 = WK_COND;
         ELSE
         IF (WK_ORDER_CNT = 4) THEN
            WK_ORDER4 = WK_COND;
         ELSE
         IF (WK_ORDER_CNT = 5) THEN
            WK_ORDER5 = WK_COND;
         ELSE
         IF (WK_ORDER_CNT = 6) THEN
            WK_ORDER6 = WK_COND;
         ELSE
         IF (WK_ORDER_CNT = 7) THEN
            WK_ORDER7 = WK_COND;
         ELSE
         IF (WK_ORDER_CNT = 8) THEN
            WK_ORDER8 = WK_COND;
         ELSE
         IF (WK_ORDER_CNT = 9) THEN
            WK_ORDER9 = WK_COND;
         ELSE
         IF (WK_ORDER_CNT = 10) THEN
            WK_ORDER10 = WK_COND;
         ELSE
         IF (WK_ORDER_CNT = 11) THEN
            WK_ORDER11 = WK_COND;
         ELSE
         IF (WK_ORDER_CNT = 12) THEN
            WK_ORDER12 = WK_COND;
         ELSE
         IF (WK_ORDER_CNT = 13) THEN
            WK_ORDER13 = WK_COND;
         ELSE
         IF (WK_ORDER_CNT = 14) THEN
            WK_ORDER14 = WK_COND;
         ELSE
         IF (WK_ORDER_CNT = 15) THEN
            WK_ORDER15 = WK_COND;
         ELSE
         IF (WK_ORDER_CNT = 16) THEN
            WK_ORDER16 = WK_COND;
         ELSE
         IF (WK_ORDER_CNT = 17) THEN
            WK_ORDER17 = WK_COND;
         ELSE
         IF (WK_ORDER_CNT = 18) THEN
            WK_ORDER18 = WK_COND;
         ELSE
         IF (WK_ORDER_CNT = 19) THEN
            WK_ORDER19 = WK_COND;
         ELSE
         IF (WK_ORDER_CNT = 20) THEN
            WK_ORDER20 = WK_COND;
         /* get next order */
         WK_IDX = WK_IDX + 1;
         WK_COND = ALLTRIM(PARSE(:WK_ORDERS,:WK_DELIM,:WK_IDX));
      END
   END

   /* order priorities 0 = GETALL or a specific priority */
   /* priorities are small int - range -32768 - +32767 */
   /* but really 0 - 9 and -9 - -1 since a 1 char display */
   /* so a max of 19 */
   /* but only allow upto 2 */

   IF (WK_ORDER_PRIORITYS = 'GETALL') THEN
   BEGIN
      WK_PRIORITY1 = 0;
      WK_STATUS_CNT = 1;
   END
   ELSE
   BEGIN
      /* allow up to 2 Prioritys */
      WK_PRIORITY_CNT = 0;
      WK_IDX = 1;
      WK_COND = ALLTRIM(PARSE(:WK_ORDER_PRIORITYS,:WK_DELIM,:WK_IDX));
      WHILE (WK_COND <> 'Token to long in parse') DO 
      BEGIN
         WK_PRIORITY_CNT = WK_PRIORITY_CNT + 1;
         IF (WK_PRIORITY_CNT = 1) THEN
            WK_PRIORITY1 = WK_COND;
         ELSE
         IF (WK_PRIORITY_CNT = 2) THEN
            WK_PRIORITY2 = WK_COND;
         ELSE
         IF (WK_PRIORITY_CNT = 3) THEN
            WK_PRIORITY3 = WK_COND;
         ELSE
         IF (WK_PRIORITY_CNT = 4) THEN
            WK_PRIORITY4 = WK_COND;
         ELSE
         IF (WK_PRIORITY_CNT = 5) THEN
            WK_PRIORITY5 = WK_COND;
         /* get next Priority */
         WK_IDX = WK_IDX + 1;
         WK_COND = ALLTRIM(PARSE(:WK_ORDER_PRIORITYS,:WK_DELIM,:WK_IDX));
      END
   END

   /* parms for a specifiy procedure either GETALL or a LIST */
   /* for P8 this is GETALL */
   /* orders for cover letters and supplier lists only */

   IF ((WK_ORDER1 = 'GETALL') AND
       (WK_ORDER_TYPE1 = 'GETALL') AND
       (WK_ORDER_STATUS1 = 'GETALL') AND
       (WK_PRIORITY1 = 0)) THEN
   BEGIN
      FOR 
         SELECT P1.PICK_ORDER 
         FROM PICK_ITEM P1 
             JOIN PICK_ORDER P2 ON P2.PICK_ORDER = P1.PICK_ORDER 
         WHERE P1.PICK_LINE_STATUS IN ('OP','UP') 
           AND  P1.PICK_ORDER_QTY > 0   
           AND  P1.PROD_ID = 'NOPROD'   
           AND P2.PICK_STATUS IN ('OP','DA')
           AND P2.SUPPLIER_LIST = 'T'
           GROUP BY P1.PICK_ORDER
           ORDER BY P2.PICK_PRIORITY, P2.WIP_ORDERING, P1.WIP_PRELOCN_ORDERING, P1.PICK_LOCATION, P1.WIP_POSTLOCN_ORDERING 
         INTO :WK_ORDER 
      DO
      BEGIN
         SUSPEND;
      END
   END
   ELSE
   IF ((WK_ORDER1 = 'GETALL') AND
       (WK_ORDER_TYPE1 = 'GETALL') AND
       (WK_ORDER_STATUS1 = 'GETALL') AND
       (WK_PRIORITY_CNT > 0)) THEN
   BEGIN
      FOR 
         SELECT P1.PICK_ORDER 
         FROM PICK_ITEM P1 
             JOIN PICK_ORDER P2 ON P2.PICK_ORDER = P1.PICK_ORDER 
         WHERE P1.PICK_LINE_STATUS IN ('OP','UP') 
           AND  P1.PICK_ORDER_QTY > 0   
           AND  P1.PROD_ID = 'NOPROD'   
           AND P2.PICK_STATUS IN ('OP','DA')
           AND P2.SUPPLIER_LIST = 'T'
           AND (P2.PICK_PRIORITY = :WK_PRIORITY1 
                OR P2.PICK_PRIORITY = :WK_PRIORITY2
                OR P2.PICK_PRIORITY = :WK_PRIORITY3
                OR P2.PICK_PRIORITY = :WK_PRIORITY4
                OR P2.PICK_PRIORITY = :WK_PRIORITY5)
           GROUP BY P1.PICK_ORDER
           ORDER BY P2.PICK_PRIORITY, P2.WIP_ORDERING, P1.WIP_PRELOCN_ORDERING, P1.PICK_LOCATION, P1.WIP_POSTLOCN_ORDERING 
         INTO :WK_ORDER 
      DO
      BEGIN
         SUSPEND;
      END
   END
   ELSE
   IF ((WK_ORDER1 = 'GETALL') AND
       (WK_ORDER_TYPE1 = 'GETALL') AND
       (WK_STATUS_CNT > 0) AND
       (WK_PRIORITY1 = 0)) THEN
   BEGIN
      FOR 
         SELECT P1.PICK_ORDER 
         FROM PICK_ITEM P1 
             JOIN PICK_ORDER P2 ON P2.PICK_ORDER = P1.PICK_ORDER 
         WHERE (P1.PICK_LINE_STATUS = :WK_ORDER_STATUS1 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS2 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS3 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS4 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS5) 
           AND  P1.PICK_ORDER_QTY > 0   
           AND  P1.PROD_ID = 'NOPROD'   
           AND P2.PICK_STATUS IN ('OP','DA')
           AND P2.SUPPLIER_LIST = 'T'
           GROUP BY P1.PICK_ORDER
           ORDER BY P2.PICK_PRIORITY, P2.WIP_ORDERING, P1.WIP_PRELOCN_ORDERING, P1.PICK_LOCATION, P1.WIP_POSTLOCN_ORDERING 
         INTO :WK_ORDER 
      DO
      BEGIN
         SUSPEND;
      END
   END
   ELSE
   IF ((WK_ORDER1 = 'GETALL') AND
       (WK_ORDER_TYPE1 = 'GETALL') AND
       (WK_STATUS_CNT > 0) AND
       (WK_PRIORITY_CNT > 0)) THEN
   BEGIN
      FOR 
         SELECT P1.PICK_ORDER 
         FROM PICK_ITEM P1 
             JOIN PICK_ORDER P2 ON P2.PICK_ORDER = P1.PICK_ORDER 
         WHERE (P1.PICK_LINE_STATUS = :WK_ORDER_STATUS1 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS2 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS3 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS4 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS5) 
           AND  P1.PICK_ORDER_QTY > 0   
           AND  P1.PROD_ID = 'NOPROD'   
           AND P2.PICK_STATUS IN ('OP','DA')
           AND P2.SUPPLIER_LIST = 'T'
           AND (P2.PICK_PRIORITY = :WK_PRIORITY1 
                OR P2.PICK_PRIORITY = :WK_PRIORITY2
                OR P2.PICK_PRIORITY = :WK_PRIORITY3
                OR P2.PICK_PRIORITY = :WK_PRIORITY4
                OR P2.PICK_PRIORITY = :WK_PRIORITY5)
           GROUP BY P1.PICK_ORDER
           ORDER BY P2.PICK_PRIORITY, P2.WIP_ORDERING, P1.WIP_PRELOCN_ORDERING, P1.PICK_LOCATION, P1.WIP_POSTLOCN_ORDERING 
         INTO :WK_ORDER 
      DO
      BEGIN
         SUSPEND;
      END
   END
   ELSE
   IF ((WK_ORDER1 = 'GETALL') AND
       (WK_TYPE_CNT > 0) AND
       (WK_ORDER_STATUS1 = 'GETALL') AND
       (WK_PRIORITY1 = 0)) THEN
   BEGIN
      FOR 
         SELECT P1.PICK_ORDER 
         FROM PICK_ITEM P1 
             JOIN PICK_ORDER P2 ON P2.PICK_ORDER = P1.PICK_ORDER 
         WHERE P1.PICK_LINE_STATUS IN ('OP','UP') 
           AND  P1.PICK_ORDER_QTY > 0   
           AND  P1.PROD_ID = 'NOPROD'   
           AND P2.PICK_STATUS IN ('OP','DA')
           AND P2.SUPPLIER_LIST = 'T'
           AND (P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE1
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE2
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE3
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE4
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE5)
           GROUP BY P1.PICK_ORDER
           ORDER BY P2.PICK_PRIORITY, P2.WIP_ORDERING, P1.WIP_PRELOCN_ORDERING, P1.PICK_LOCATION, P1.WIP_POSTLOCN_ORDERING 
         INTO :WK_ORDER 
      DO
      BEGIN
         SUSPEND;
      END
   END
   ELSE
   IF ((WK_ORDER1 = 'GETALL') AND
       (WK_TYPE_CNT > 0) AND
       (WK_ORDER_STATUS1 = 'GETALL') AND
       (WK_PRIORITY_CNT > 0)) THEN
   BEGIN
      FOR 
         SELECT P1.PICK_ORDER 
         FROM PICK_ITEM P1 
             JOIN PICK_ORDER P2 ON P2.PICK_ORDER = P1.PICK_ORDER 
         WHERE P1.PICK_LINE_STATUS IN ('OP','UP') 
           AND  P1.PICK_ORDER_QTY > 0   
           AND  P1.PROD_ID = 'NOPROD'   
           AND P2.PICK_STATUS IN ('OP','DA')
           AND P2.SUPPLIER_LIST = 'T'
           AND (P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE1
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE2
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE3
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE4
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE5)
           AND (P2.PICK_PRIORITY = :WK_PRIORITY1 
                OR P2.PICK_PRIORITY = :WK_PRIORITY2
                OR P2.PICK_PRIORITY = :WK_PRIORITY3
                OR P2.PICK_PRIORITY = :WK_PRIORITY4
                OR P2.PICK_PRIORITY = :WK_PRIORITY5)
           GROUP BY P1.PICK_ORDER
           ORDER BY P2.PICK_PRIORITY, P2.WIP_ORDERING, P1.WIP_PRELOCN_ORDERING, P1.PICK_LOCATION, P1.WIP_POSTLOCN_ORDERING 
         INTO :WK_ORDER 
      DO
      BEGIN
         SUSPEND;
      END
   END
   ELSE
   IF ((WK_ORDER1 = 'GETALL') AND
       (WK_TYPE_CNT > 0) AND
       (WK_STATUS_CNT > 0) AND
       (WK_PRIORITY1 = 0)) THEN
   BEGIN
      FOR 
         SELECT P1.PICK_ORDER 
         FROM PICK_ITEM P1 
             JOIN PICK_ORDER P2 ON P2.PICK_ORDER = P1.PICK_ORDER 
         WHERE (P1.PICK_LINE_STATUS = :WK_ORDER_STATUS1 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS2 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS3 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS4 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS5) 
           AND  P1.PICK_ORDER_QTY > 0   
           AND  P1.PROD_ID = 'NOPROD'   
           AND P2.PICK_STATUS IN ('OP','DA')
           AND P2.SUPPLIER_LIST = 'T'
           AND (P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE1
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE2
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE3
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE4
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE5)
           GROUP BY P1.PICK_ORDER
           ORDER BY P2.PICK_PRIORITY, P2.WIP_ORDERING, P1.WIP_PRELOCN_ORDERING, P1.PICK_LOCATION, P1.WIP_POSTLOCN_ORDERING 
         INTO :WK_ORDER 
      DO
      BEGIN
         SUSPEND;
      END
   END
   ELSE
   IF ((WK_ORDER1 = 'GETALL') AND
       (WK_TYPE_CNT > 0) AND
       (WK_STATUS_CNT > 0) AND
       (WK_PRIORITY_CNT > 0)) THEN
   BEGIN
      FOR 
         SELECT P1.PICK_ORDER 
         FROM PICK_ITEM P1 
             JOIN PICK_ORDER P2 ON P2.PICK_ORDER = P1.PICK_ORDER 
         WHERE (P1.PICK_LINE_STATUS = :WK_ORDER_STATUS1 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS2 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS3 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS4 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS5) 
           AND  P1.PICK_ORDER_QTY > 0   
           AND  P1.PROD_ID = 'NOPROD'   
           AND P2.PICK_STATUS IN ('OP','DA')
           AND P2.SUPPLIER_LIST = 'T'
           AND (P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE1
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE2
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE3
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE4
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE5)
           AND (P2.PICK_PRIORITY = :WK_PRIORITY1 
                OR P2.PICK_PRIORITY = :WK_PRIORITY2
                OR P2.PICK_PRIORITY = :WK_PRIORITY3
                OR P2.PICK_PRIORITY = :WK_PRIORITY4
                OR P2.PICK_PRIORITY = :WK_PRIORITY5)
           GROUP BY P1.PICK_ORDER
           ORDER BY P2.PICK_PRIORITY, P2.WIP_ORDERING, P1.WIP_PRELOCN_ORDERING, P1.PICK_LOCATION, P1.WIP_POSTLOCN_ORDERING 
         INTO :WK_ORDER 
      DO
      BEGIN
         SUSPEND;
      END
   END
   ELSE
   IF ((WK_ORDER_CNT > 0) AND
       (WK_ORDER_TYPE1 = 'GETALL') AND
       (WK_ORDER_STATUS1 = 'GETALL') AND
       (WK_PRIORITY1 = 0)) THEN
   BEGIN
      FOR 
         SELECT P1.PICK_ORDER 
         FROM PICK_ITEM P1 
             JOIN PICK_ORDER P2 ON P2.PICK_ORDER = P1.PICK_ORDER 
         WHERE P1.PICK_LINE_STATUS IN ('OP','UP') 
           AND  P1.PICK_ORDER_QTY > 0   
           AND  P1.PROD_ID = 'NOPROD'   
           AND (P1.PICK_ORDER = :WK_ORDER1
                OR P1.PICK_ORDER = :WK_ORDER2
                OR P1.PICK_ORDER = :WK_ORDER3
                OR P1.PICK_ORDER = :WK_ORDER4
                OR P1.PICK_ORDER = :WK_ORDER5
                OR P1.PICK_ORDER = :WK_ORDER6
                OR P1.PICK_ORDER = :WK_ORDER7
                OR P1.PICK_ORDER = :WK_ORDER8
                OR P1.PICK_ORDER = :WK_ORDER9
                OR P1.PICK_ORDER = :WK_ORDER10
                OR P1.PICK_ORDER = :WK_ORDER11
                OR P1.PICK_ORDER = :WK_ORDER12
                OR P1.PICK_ORDER = :WK_ORDER13
                OR P1.PICK_ORDER = :WK_ORDER14
                OR P1.PICK_ORDER = :WK_ORDER15
                OR P1.PICK_ORDER = :WK_ORDER16
                OR P1.PICK_ORDER = :WK_ORDER17
                OR P1.PICK_ORDER = :WK_ORDER18
                OR P1.PICK_ORDER = :WK_ORDER19
                OR P1.PICK_ORDER = :WK_ORDER20)
           AND P2.PICK_STATUS IN ('OP','DA')
           AND P2.SUPPLIER_LIST = 'T'
           GROUP BY P1.PICK_ORDER
           ORDER BY P2.PICK_PRIORITY, P2.WIP_ORDERING, P1.WIP_PRELOCN_ORDERING, P1.PICK_LOCATION, P1.WIP_POSTLOCN_ORDERING 
         INTO :WK_ORDER 
      DO
      BEGIN
         SUSPEND;
      END
   END
   ELSE
   IF ((WK_ORDER_CNT > 0) AND
       (WK_ORDER_TYPE1 = 'GETALL') AND
       (WK_ORDER_STATUS1 = 'GETALL') AND
       (WK_PRIORITY_CNT > 0)) THEN
   BEGIN
      FOR 
         SELECT P1.PICK_ORDER 
         FROM PICK_ITEM P1 
             JOIN PICK_ORDER P2 ON P2.PICK_ORDER = P1.PICK_ORDER 
         WHERE P1.PICK_LINE_STATUS IN ('OP','UP') 
           AND (P1.PICK_ORDER = :WK_ORDER1
                OR P1.PICK_ORDER = :WK_ORDER2
                OR P1.PICK_ORDER = :WK_ORDER3
                OR P1.PICK_ORDER = :WK_ORDER4
                OR P1.PICK_ORDER = :WK_ORDER5
                OR P1.PICK_ORDER = :WK_ORDER6
                OR P1.PICK_ORDER = :WK_ORDER7
                OR P1.PICK_ORDER = :WK_ORDER8
                OR P1.PICK_ORDER = :WK_ORDER9
                OR P1.PICK_ORDER = :WK_ORDER10
                OR P1.PICK_ORDER = :WK_ORDER11
                OR P1.PICK_ORDER = :WK_ORDER12
                OR P1.PICK_ORDER = :WK_ORDER13
                OR P1.PICK_ORDER = :WK_ORDER14
                OR P1.PICK_ORDER = :WK_ORDER15
                OR P1.PICK_ORDER = :WK_ORDER16
                OR P1.PICK_ORDER = :WK_ORDER17
                OR P1.PICK_ORDER = :WK_ORDER18
                OR P1.PICK_ORDER = :WK_ORDER19
                OR P1.PICK_ORDER = :WK_ORDER20)
           AND  P1.PICK_ORDER_QTY > 0   
           AND  P1.PROD_ID = 'NOPROD'   
           AND P2.PICK_STATUS IN ('OP','DA')
           AND P2.SUPPLIER_LIST = 'T'
           AND (P2.PICK_PRIORITY = :WK_PRIORITY1 
                OR P2.PICK_PRIORITY = :WK_PRIORITY2
                OR P2.PICK_PRIORITY = :WK_PRIORITY3
                OR P2.PICK_PRIORITY = :WK_PRIORITY4
                OR P2.PICK_PRIORITY = :WK_PRIORITY5)
           GROUP BY P1.PICK_ORDER
           ORDER BY P2.PICK_PRIORITY, P2.WIP_ORDERING, P1.WIP_PRELOCN_ORDERING, P1.PICK_LOCATION, P1.WIP_POSTLOCN_ORDERING 
         INTO :WK_ORDER 
      DO
      BEGIN
         SUSPEND;
      END
   END
   ELSE
   IF ((WK_ORDER_CNT > 0) AND
       (WK_ORDER_TYPE1 = 'GETALL') AND
       (WK_STATUS_CNT > 0) AND
       (WK_PRIORITY1 = 0)) THEN
   BEGIN
      FOR 
         SELECT P1.PICK_ORDER 
         FROM PICK_ITEM P1 
             JOIN PICK_ORDER P2 ON P2.PICK_ORDER = P1.PICK_ORDER 
         WHERE (P1.PICK_LINE_STATUS = :WK_ORDER_STATUS1 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS2 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS3 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS4 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS5) 
           AND (P1.PICK_ORDER = :WK_ORDER1
                OR P1.PICK_ORDER = :WK_ORDER2
                OR P1.PICK_ORDER = :WK_ORDER3
                OR P1.PICK_ORDER = :WK_ORDER4
                OR P1.PICK_ORDER = :WK_ORDER5
                OR P1.PICK_ORDER = :WK_ORDER6
                OR P1.PICK_ORDER = :WK_ORDER7
                OR P1.PICK_ORDER = :WK_ORDER8
                OR P1.PICK_ORDER = :WK_ORDER9
                OR P1.PICK_ORDER = :WK_ORDER10
                OR P1.PICK_ORDER = :WK_ORDER11
                OR P1.PICK_ORDER = :WK_ORDER12
                OR P1.PICK_ORDER = :WK_ORDER13
                OR P1.PICK_ORDER = :WK_ORDER14
                OR P1.PICK_ORDER = :WK_ORDER15
                OR P1.PICK_ORDER = :WK_ORDER16
                OR P1.PICK_ORDER = :WK_ORDER17
                OR P1.PICK_ORDER = :WK_ORDER18
                OR P1.PICK_ORDER = :WK_ORDER19
                OR P1.PICK_ORDER = :WK_ORDER20)
           AND  P1.PICK_ORDER_QTY > 0   
           AND  P1.PROD_ID = 'NOPROD'   
           AND P2.PICK_STATUS IN ('OP','DA')
           AND P2.SUPPLIER_LIST = 'T'
           GROUP BY P1.PICK_ORDER
           ORDER BY P2.PICK_PRIORITY, P2.WIP_ORDERING, P1.WIP_PRELOCN_ORDERING, P1.PICK_LOCATION, P1.WIP_POSTLOCN_ORDERING 
         INTO :WK_ORDER 
      DO
      BEGIN
         SUSPEND;
      END
   END
   ELSE
   IF ((WK_ORDER_CNT > 0) AND
       (WK_ORDER_TYPE1 = 'GETALL') AND
       (WK_STATUS_CNT > 0) AND
       (WK_PRIORITY_CNT > 0)) THEN
   BEGIN
      FOR 
         SELECT P1.PICK_ORDER 
         FROM PICK_ITEM P1 
             JOIN PICK_ORDER P2 ON P2.PICK_ORDER = P1.PICK_ORDER 
         WHERE (P1.PICK_LINE_STATUS = :WK_ORDER_STATUS1 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS2 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS3 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS4 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS5) 
           AND (P1.PICK_ORDER = :WK_ORDER1
                OR P1.PICK_ORDER = :WK_ORDER2
                OR P1.PICK_ORDER = :WK_ORDER3
                OR P1.PICK_ORDER = :WK_ORDER4
                OR P1.PICK_ORDER = :WK_ORDER5
                OR P1.PICK_ORDER = :WK_ORDER6
                OR P1.PICK_ORDER = :WK_ORDER7
                OR P1.PICK_ORDER = :WK_ORDER8
                OR P1.PICK_ORDER = :WK_ORDER9
                OR P1.PICK_ORDER = :WK_ORDER10
                OR P1.PICK_ORDER = :WK_ORDER11
                OR P1.PICK_ORDER = :WK_ORDER12
                OR P1.PICK_ORDER = :WK_ORDER13
                OR P1.PICK_ORDER = :WK_ORDER14
                OR P1.PICK_ORDER = :WK_ORDER15
                OR P1.PICK_ORDER = :WK_ORDER16
                OR P1.PICK_ORDER = :WK_ORDER17
                OR P1.PICK_ORDER = :WK_ORDER18
                OR P1.PICK_ORDER = :WK_ORDER19
                OR P1.PICK_ORDER = :WK_ORDER20)
           AND  P1.PICK_ORDER_QTY > 0   
           AND  P1.PROD_ID = 'NOPROD'   
           AND P2.PICK_STATUS IN ('OP','DA')
           AND P2.SUPPLIER_LIST = 'T'
           AND (P2.PICK_PRIORITY = :WK_PRIORITY1 
                OR P2.PICK_PRIORITY = :WK_PRIORITY2
                OR P2.PICK_PRIORITY = :WK_PRIORITY3
                OR P2.PICK_PRIORITY = :WK_PRIORITY4
                OR P2.PICK_PRIORITY = :WK_PRIORITY5)
           GROUP BY P1.PICK_ORDER
           ORDER BY P2.PICK_PRIORITY, P2.WIP_ORDERING, P1.WIP_PRELOCN_ORDERING, P1.PICK_LOCATION, P1.WIP_POSTLOCN_ORDERING 
         INTO :WK_ORDER 
      DO
      BEGIN
         SUSPEND;
      END
   END
   ELSE
   IF ((WK_ORDER_CNT > 0) AND
       (WK_TYPE_CNT > 0) AND
       (WK_ORDER_STATUS1 = 'GETALL') AND
       (WK_PRIORITY1 = 0)) THEN
   BEGIN
      FOR 
         SELECT P1.PICK_ORDER 
         FROM PICK_ITEM P1 
             JOIN PICK_ORDER P2 ON P2.PICK_ORDER = P1.PICK_ORDER 
         WHERE P1.PICK_LINE_STATUS IN ('OP','UP') 
           AND (P1.PICK_ORDER = :WK_ORDER1
                OR P1.PICK_ORDER = :WK_ORDER2
                OR P1.PICK_ORDER = :WK_ORDER3
                OR P1.PICK_ORDER = :WK_ORDER4
                OR P1.PICK_ORDER = :WK_ORDER5
                OR P1.PICK_ORDER = :WK_ORDER6
                OR P1.PICK_ORDER = :WK_ORDER7
                OR P1.PICK_ORDER = :WK_ORDER8
                OR P1.PICK_ORDER = :WK_ORDER9
                OR P1.PICK_ORDER = :WK_ORDER10
                OR P1.PICK_ORDER = :WK_ORDER11
                OR P1.PICK_ORDER = :WK_ORDER12
                OR P1.PICK_ORDER = :WK_ORDER13
                OR P1.PICK_ORDER = :WK_ORDER14
                OR P1.PICK_ORDER = :WK_ORDER15
                OR P1.PICK_ORDER = :WK_ORDER16
                OR P1.PICK_ORDER = :WK_ORDER17
                OR P1.PICK_ORDER = :WK_ORDER18
                OR P1.PICK_ORDER = :WK_ORDER19
                OR P1.PICK_ORDER = :WK_ORDER20)
           AND  P1.PICK_ORDER_QTY > 0   
           AND  P1.PROD_ID = 'NOPROD'   
           AND P2.PICK_STATUS IN ('OP','DA')
           AND P2.SUPPLIER_LIST = 'T'
           AND (P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE1
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE2
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE3
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE4
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE5)
           GROUP BY P1.PICK_ORDER
           ORDER BY P2.PICK_PRIORITY, P2.WIP_ORDERING, P1.WIP_PRELOCN_ORDERING, P1.PICK_LOCATION, P1.WIP_POSTLOCN_ORDERING 
         INTO :WK_ORDER 
      DO
      BEGIN
         SUSPEND;
      END
   END
   ELSE
   IF ((WK_ORDER_CNT > 0) AND
       (WK_TYPE_CNT > 0) AND
       (WK_ORDER_STATUS1 = 'GETALL') AND
       (WK_PRIORITY_CNT > 0)) THEN
   BEGIN
      FOR 
         SELECT P1.PICK_ORDER 
         FROM PICK_ITEM P1 
             JOIN PICK_ORDER P2 ON P2.PICK_ORDER = P1.PICK_ORDER 
         WHERE P1.PICK_LINE_STATUS IN ('OP','UP') 
           AND (P1.PICK_ORDER = :WK_ORDER1
                OR P1.PICK_ORDER = :WK_ORDER2
                OR P1.PICK_ORDER = :WK_ORDER3
                OR P1.PICK_ORDER = :WK_ORDER4
                OR P1.PICK_ORDER = :WK_ORDER5
                OR P1.PICK_ORDER = :WK_ORDER6
                OR P1.PICK_ORDER = :WK_ORDER7
                OR P1.PICK_ORDER = :WK_ORDER8
                OR P1.PICK_ORDER = :WK_ORDER9
                OR P1.PICK_ORDER = :WK_ORDER10
                OR P1.PICK_ORDER = :WK_ORDER11
                OR P1.PICK_ORDER = :WK_ORDER12
                OR P1.PICK_ORDER = :WK_ORDER13
                OR P1.PICK_ORDER = :WK_ORDER14
                OR P1.PICK_ORDER = :WK_ORDER15
                OR P1.PICK_ORDER = :WK_ORDER16
                OR P1.PICK_ORDER = :WK_ORDER17
                OR P1.PICK_ORDER = :WK_ORDER18
                OR P1.PICK_ORDER = :WK_ORDER19
                OR P1.PICK_ORDER = :WK_ORDER20)
           AND  P1.PICK_ORDER_QTY > 0   
           AND  P1.PROD_ID = 'NOPROD'   
           AND P2.PICK_STATUS IN ('OP','DA')
           AND P2.SUPPLIER_LIST = 'T'
           AND (P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE1
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE2
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE3
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE4
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE5)
           AND (P2.PICK_PRIORITY = :WK_PRIORITY1 
                OR P2.PICK_PRIORITY = :WK_PRIORITY2
                OR P2.PICK_PRIORITY = :WK_PRIORITY3
                OR P2.PICK_PRIORITY = :WK_PRIORITY4
                OR P2.PICK_PRIORITY = :WK_PRIORITY5)
           GROUP BY P1.PICK_ORDER
           ORDER BY P2.PICK_PRIORITY, P2.WIP_ORDERING, P1.WIP_PRELOCN_ORDERING, P1.PICK_LOCATION, P1.WIP_POSTLOCN_ORDERING 
         INTO :WK_ORDER 
      DO
      BEGIN
         SUSPEND;
      END
   END
   ELSE
   IF ((WK_ORDER_CNT > 0) AND
       (WK_TYPE_CNT > 0) AND
       (WK_STATUS_CNT > 0) AND
       (WK_PRIORITY1 = 0)) THEN
   BEGIN
      FOR 
         SELECT P1.PICK_ORDER 
         FROM PICK_ITEM P1 
             JOIN PICK_ORDER P2 ON P2.PICK_ORDER = P1.PICK_ORDER 
         WHERE (P1.PICK_LINE_STATUS = :WK_ORDER_STATUS1 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS2 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS3 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS4 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS5) 
           AND (P1.PICK_ORDER = :WK_ORDER1
                OR P1.PICK_ORDER = :WK_ORDER2
                OR P1.PICK_ORDER = :WK_ORDER3
                OR P1.PICK_ORDER = :WK_ORDER4
                OR P1.PICK_ORDER = :WK_ORDER5
                OR P1.PICK_ORDER = :WK_ORDER6
                OR P1.PICK_ORDER = :WK_ORDER7
                OR P1.PICK_ORDER = :WK_ORDER8
                OR P1.PICK_ORDER = :WK_ORDER9
                OR P1.PICK_ORDER = :WK_ORDER10
                OR P1.PICK_ORDER = :WK_ORDER11
                OR P1.PICK_ORDER = :WK_ORDER12
                OR P1.PICK_ORDER = :WK_ORDER13
                OR P1.PICK_ORDER = :WK_ORDER14
                OR P1.PICK_ORDER = :WK_ORDER15
                OR P1.PICK_ORDER = :WK_ORDER16
                OR P1.PICK_ORDER = :WK_ORDER17
                OR P1.PICK_ORDER = :WK_ORDER18
                OR P1.PICK_ORDER = :WK_ORDER19
                OR P1.PICK_ORDER = :WK_ORDER20)
           AND  P1.PICK_ORDER_QTY > 0   
           AND  P1.PROD_ID = 'NOPROD'   
           AND P2.PICK_STATUS IN ('OP','DA')
           AND P2.SUPPLIER_LIST = 'T'
           AND (P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE1
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE2
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE3
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE4
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE5)
           GROUP BY P1.PICK_ORDER
           ORDER BY P2.PICK_PRIORITY, P2.WIP_ORDERING, P1.WIP_PRELOCN_ORDERING, P1.PICK_LOCATION, P1.WIP_POSTLOCN_ORDERING 
         INTO :WK_ORDER 
      DO
      BEGIN
         SUSPEND;
      END
   END
   ELSE
   IF ((WK_ORDER_CNT > 0) AND
       (WK_TYPE_CNT > 0) AND
       (WK_STATUS_CNT > 0) AND
       (WK_PRIORITY_CNT > 0)) THEN
   BEGIN
      FOR 
         SELECT P1.PICK_ORDER 
         FROM PICK_ITEM P1 
             JOIN PICK_ORDER P2 ON P2.PICK_ORDER = P1.PICK_ORDER 
         WHERE (P1.PICK_LINE_STATUS = :WK_ORDER_STATUS1 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS2 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS3 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS4 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS5) 
           AND (P1.PICK_ORDER = :WK_ORDER1
                OR P1.PICK_ORDER = :WK_ORDER2
                OR P1.PICK_ORDER = :WK_ORDER3
                OR P1.PICK_ORDER = :WK_ORDER4
                OR P1.PICK_ORDER = :WK_ORDER5
                OR P1.PICK_ORDER = :WK_ORDER6
                OR P1.PICK_ORDER = :WK_ORDER7
                OR P1.PICK_ORDER = :WK_ORDER8
                OR P1.PICK_ORDER = :WK_ORDER9
                OR P1.PICK_ORDER = :WK_ORDER10
                OR P1.PICK_ORDER = :WK_ORDER11
                OR P1.PICK_ORDER = :WK_ORDER12
                OR P1.PICK_ORDER = :WK_ORDER13
                OR P1.PICK_ORDER = :WK_ORDER14
                OR P1.PICK_ORDER = :WK_ORDER15
                OR P1.PICK_ORDER = :WK_ORDER16
                OR P1.PICK_ORDER = :WK_ORDER17
                OR P1.PICK_ORDER = :WK_ORDER18
                OR P1.PICK_ORDER = :WK_ORDER19
                OR P1.PICK_ORDER = :WK_ORDER20)
           AND  P1.PICK_ORDER_QTY > 0   
           AND  P1.PROD_ID = 'NOPROD'   
           AND P2.PICK_STATUS IN ('OP','DA')
           AND P2.SUPPLIER_LIST = 'T'
           AND (P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE1
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE2
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE3
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE4
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE5)
           AND (P2.PICK_PRIORITY = :WK_PRIORITY1 
                OR P2.PICK_PRIORITY = :WK_PRIORITY2
                OR P2.PICK_PRIORITY = :WK_PRIORITY3
                OR P2.PICK_PRIORITY = :WK_PRIORITY4
                OR P2.PICK_PRIORITY = :WK_PRIORITY5)
           GROUP BY P1.PICK_ORDER
           ORDER BY P2.PICK_PRIORITY, P2.WIP_ORDERING, P1.WIP_PRELOCN_ORDERING, P1.PICK_LOCATION, P1.WIP_POSTLOCN_ORDERING 
         INTO :WK_ORDER 
      DO
      BEGIN
         SUSPEND;
      END
   END
   EXIT;
END ^

ALTER PROCEDURE PICK_MODE_P9 (WK_ORDER_TYPES VARCHAR(255) CHARACTER SET NONE,
WK_ORDER_MODES VARCHAR(255) CHARACTER SET NONE,
WK_ORDERS VARCHAR(255) CHARACTER SET NONE,
WK_ORDER_STATUSES VARCHAR(255) CHARACTER SET NONE,
WK_ORDER_PRIORITYS VARCHAR(255) CHARACTER SET NONE,
WK_PARAM_IDS VARCHAR(255) CHARACTER SET NONE)
RETURNS (WK_ORDER VARCHAR(15) CHARACTER SET NONE)
AS 
 
 
DECLARE VARIABLE WK_DELIM CHAR(1);
DECLARE VARIABLE WK_FOUND INTEGER;
DECLARE VARIABLE WK_ORDER_TYPE1 VARCHAR(10);
DECLARE VARIABLE WK_ORDER_TYPE2 VARCHAR(10);
DECLARE VARIABLE WK_ORDER_TYPE3 VARCHAR(10);
DECLARE VARIABLE WK_ORDER_TYPE4 VARCHAR(10);
DECLARE VARIABLE WK_ORDER_TYPE5 VARCHAR(10);
DECLARE VARIABLE WK_TYPE_CNT INTEGER;
DECLARE VARIABLE WK_ORDER_STATUS1 VARCHAR(10);
DECLARE VARIABLE WK_ORDER_STATUS2 VARCHAR(10);
DECLARE VARIABLE WK_ORDER_STATUS3 VARCHAR(10);
DECLARE VARIABLE WK_ORDER_STATUS4 VARCHAR(10);
DECLARE VARIABLE WK_ORDER_STATUS5 VARCHAR(10);
DECLARE VARIABLE WK_STATUS_CNT INTEGER;
DECLARE VARIABLE WK_PRIORITY1 INTEGER;
DECLARE VARIABLE WK_PRIORITY2 INTEGER;
DECLARE VARIABLE WK_PRIORITY3 INTEGER;
DECLARE VARIABLE WK_PRIORITY4 INTEGER;
DECLARE VARIABLE WK_PRIORITY5 INTEGER;
DECLARE VARIABLE WK_PRIORITY_CNT INTEGER;
DECLARE VARIABLE WK_ORDER_CNT INTEGER;
DECLARE VARIABLE WK_IDX INTEGER;
DECLARE VARIABLE WK_COND VARCHAR(35);
DECLARE VARIABLE WK_ORDER1 VARCHAR(15);
DECLARE VARIABLE WK_ORDER2 VARCHAR(15);
DECLARE VARIABLE WK_ORDER3 VARCHAR(15);
DECLARE VARIABLE WK_ORDER4 VARCHAR(15);
DECLARE VARIABLE WK_ORDER5 VARCHAR(15);
DECLARE VARIABLE WK_ORDER6 VARCHAR(15);
DECLARE VARIABLE WK_ORDER7 VARCHAR(15);
DECLARE VARIABLE WK_ORDER8 VARCHAR(15);
DECLARE VARIABLE WK_ORDER9 VARCHAR(15);
DECLARE VARIABLE WK_ORDER10 VARCHAR(15);
DECLARE VARIABLE WK_ORDER11 VARCHAR(15);
DECLARE VARIABLE WK_ORDER12 VARCHAR(15);
DECLARE VARIABLE WK_ORDER13 VARCHAR(15);
DECLARE VARIABLE WK_ORDER14 VARCHAR(15);
DECLARE VARIABLE WK_ORDER15 VARCHAR(15);
DECLARE VARIABLE WK_ORDER16 VARCHAR(15);
DECLARE VARIABLE WK_ORDER17 VARCHAR(15);
DECLARE VARIABLE WK_ORDER18 VARCHAR(15);
DECLARE VARIABLE WK_ORDER19 VARCHAR(15);
DECLARE VARIABLE WK_ORDER20 VARCHAR(15);

BEGIN
   WK_DELIM = '|';
   WK_ORDER_TYPE1 = '';
   WK_ORDER_TYPE2 = '';
   WK_ORDER_TYPE3 = '';
   WK_ORDER_TYPE4 = '';
   WK_ORDER_TYPE5 = '';
   WK_ORDER_STATUS1 = '';
   WK_ORDER_STATUS2 = '';
   WK_ORDER_STATUS3 = '';
   WK_ORDER_STATUS4 = '';
   WK_ORDER_STATUS5 = '';
   WK_ORDER1 = '';
   WK_ORDER2 = '';
   WK_ORDER3 = '';
   WK_ORDER4 = '';
   WK_ORDER5 = '';
   WK_ORDER6 = '';
   WK_ORDER7 = '';
   WK_ORDER8 = '';
   WK_ORDER9 = '';
   WK_ORDER10 = '';
   WK_ORDER11 = '';
   WK_ORDER12 = '';
   WK_ORDER13 = '';
   WK_ORDER14 = '';
   WK_ORDER15 = '';
   WK_ORDER16 = '';
   WK_ORDER17 = '';
   WK_ORDER18 = '';
   WK_ORDER19 = '';
   WK_ORDER20 = '';
   WK_PRIORITY1 = -32000;
   WK_PRIORITY2 = -32000;
   WK_PRIORITY3 = -32000;
   WK_PRIORITY4 = -32000;
   WK_PRIORITY5 = -32000;
   /* normally only one order type but glen wants several or GETALL */
   IF (WK_ORDER_TYPES = 'GETALL') THEN
   BEGIN
      WK_ORDER_TYPE1 = 'GETALL';
      WK_TYPE_CNT = 1;
   END
   ELSE
   BEGIN
      /* allow up to 5 types */
      WK_TYPE_CNT = 0;
      WK_IDX = 1;
      WK_COND = ALLTRIM(PARSE(:WK_ORDER_TYPES,:WK_DELIM,:WK_IDX));
      WHILE (WK_COND <> 'Token to long in parse') DO 
      BEGIN
         WK_TYPE_CNT = WK_TYPE_CNT + 1;
         IF (WK_TYPE_CNT = 1) THEN
            WK_ORDER_TYPE1 = WK_COND;
         ELSE
         IF (WK_TYPE_CNT = 2) THEN
            WK_ORDER_TYPE2 = WK_COND;
         ELSE
         IF (WK_TYPE_CNT = 3) THEN
            WK_ORDER_TYPE3 = WK_COND;
         ELSE
         IF (WK_TYPE_CNT = 4) THEN
            WK_ORDER_TYPE4 = WK_COND;
         ELSE
         IF (WK_TYPE_CNT = 5) THEN
            WK_ORDER_TYPE5 = WK_COND;
         /* get next type */
         WK_IDX = WK_IDX + 1;
         WK_COND = ALLTRIM(PARSE(:WK_ORDER_TYPES,:WK_DELIM,:WK_IDX));
      END
   END

   /* normally GETALL in the mode - unused field */

   /* order statuses - why this ?? - must be confirmed lines OP or UP */
   IF (WK_ORDER_STATUSES = 'GETALL') THEN
   BEGIN
      WK_ORDER_STATUS1 = 'GETALL';
      WK_STATUS_CNT = 1;
   END
   ELSE
   BEGIN
      /* allow up to 5 STATUSs */
      WK_STATUS_CNT = 0;
      WK_IDX = 1;
      WK_COND = ALLTRIM(PARSE(:WK_ORDER_STATUSES,:WK_DELIM,:WK_IDX));
      WHILE (WK_COND <> 'Token to long in parse') DO 
      BEGIN
         WK_STATUS_CNT = WK_STATUS_CNT + 1;
         IF (WK_STATUS_CNT = 1) THEN
            WK_ORDER_STATUS1 = WK_COND;
         ELSE
         IF (WK_STATUS_CNT = 2) THEN
            WK_ORDER_STATUS2 = WK_COND;
         ELSE
         IF (WK_STATUS_CNT = 3) THEN
            WK_ORDER_STATUS3 = WK_COND;
         ELSE
         IF (WK_STATUS_CNT = 4) THEN
            WK_ORDER_STATUS4 = WK_COND;
         ELSE
         IF (WK_STATUS_CNT = 5) THEN
            WK_ORDER_STATUS5 = WK_COND;
         /* get next STATUS */
         WK_IDX = WK_IDX + 1;
         WK_COND = ALLTRIM(PARSE(:WK_ORDER_STATUSES,:WK_DELIM,:WK_IDX));
      END
   END

   /* ordno is a list of orders or GETALL */
   /* orders are length 9 or 10 for internal */
   /* so can have a maximum of 255 = (1 + n*10) */   
   /* thus n = 25 */
   /* calc orders 1 - 25 */
   /* but only allow upto 20 */
   IF (WK_ORDERS = 'GETALL') THEN
   BEGIN
      WK_ORDER1 = 'GETALL';
      WK_ORDER_CNT = 1;
   END
   ELSE
   BEGIN
      WK_ORDER_CNT = 0;
      WK_IDX = 1;
      WK_COND = ALLTRIM(PARSE(:WK_ORDERS,:WK_DELIM,:WK_IDX));
      WHILE (WK_COND <> 'Token to long in parse') DO 
      BEGIN
         WK_ORDER_CNT = WK_ORDER_CNT + 1;
         IF (WK_ORDER_CNT = 1) THEN
            WK_ORDER1 = WK_COND;
         ELSE
         IF (WK_ORDER_CNT = 2) THEN
            WK_ORDER2 = WK_COND;
         ELSE
         IF (WK_ORDER_CNT = 3) THEN
            WK_ORDER3 = WK_COND;
         ELSE
         IF (WK_ORDER_CNT = 4) THEN
            WK_ORDER4 = WK_COND;
         ELSE
         IF (WK_ORDER_CNT = 5) THEN
            WK_ORDER5 = WK_COND;
         ELSE
         IF (WK_ORDER_CNT = 6) THEN
            WK_ORDER6 = WK_COND;
         ELSE
         IF (WK_ORDER_CNT = 7) THEN
            WK_ORDER7 = WK_COND;
         ELSE
         IF (WK_ORDER_CNT = 8) THEN
            WK_ORDER8 = WK_COND;
         ELSE
         IF (WK_ORDER_CNT = 9) THEN
            WK_ORDER9 = WK_COND;
         ELSE
         IF (WK_ORDER_CNT = 10) THEN
            WK_ORDER10 = WK_COND;
         ELSE
         IF (WK_ORDER_CNT = 11) THEN
            WK_ORDER11 = WK_COND;
         ELSE
         IF (WK_ORDER_CNT = 12) THEN
            WK_ORDER12 = WK_COND;
         ELSE
         IF (WK_ORDER_CNT = 13) THEN
            WK_ORDER13 = WK_COND;
         ELSE
         IF (WK_ORDER_CNT = 14) THEN
            WK_ORDER14 = WK_COND;
         ELSE
         IF (WK_ORDER_CNT = 15) THEN
            WK_ORDER15 = WK_COND;
         ELSE
         IF (WK_ORDER_CNT = 16) THEN
            WK_ORDER16 = WK_COND;
         ELSE
         IF (WK_ORDER_CNT = 17) THEN
            WK_ORDER17 = WK_COND;
         ELSE
         IF (WK_ORDER_CNT = 18) THEN
            WK_ORDER18 = WK_COND;
         ELSE
         IF (WK_ORDER_CNT = 19) THEN
            WK_ORDER19 = WK_COND;
         ELSE
         IF (WK_ORDER_CNT = 20) THEN
            WK_ORDER20 = WK_COND;
         /* get next order */
         WK_IDX = WK_IDX + 1;
         WK_COND = ALLTRIM(PARSE(:WK_ORDERS,:WK_DELIM,:WK_IDX));
      END
   END

   /* order priorities 0 = GETALL or a specific priority */
   /* priorities are small int - range -32768 - +32767 */
   /* but really 0 - 9 and -9 - -1 since a 1 char display */
   /* so a max of 19 */
   /* but only allow upto 2 */

   IF (WK_ORDER_PRIORITYS = 'GETALL') THEN
   BEGIN
      WK_PRIORITY1 = 0;
      WK_STATUS_CNT = 1;
   END
   ELSE
   BEGIN
      /* allow up to 2 Prioritys */
      WK_PRIORITY_CNT = 0;
      WK_IDX = 1;
      WK_COND = ALLTRIM(PARSE(:WK_ORDER_PRIORITYS,:WK_DELIM,:WK_IDX));
      WHILE (WK_COND <> 'Token to long in parse') DO 
      BEGIN
         WK_PRIORITY_CNT = WK_PRIORITY_CNT + 1;
         IF (WK_PRIORITY_CNT = 1) THEN
            WK_PRIORITY1 = WK_COND;
         ELSE
         IF (WK_PRIORITY_CNT = 2) THEN
            WK_PRIORITY2 = WK_COND;
         ELSE
         IF (WK_PRIORITY_CNT = 3) THEN
            WK_PRIORITY3 = WK_COND;
         ELSE
         IF (WK_PRIORITY_CNT = 4) THEN
            WK_PRIORITY4 = WK_COND;
         ELSE
         IF (WK_PRIORITY_CNT = 5) THEN
            WK_PRIORITY5 = WK_COND;
         /* get next Priority */
         WK_IDX = WK_IDX + 1;
         WK_COND = ALLTRIM(PARSE(:WK_ORDER_PRIORITYS,:WK_DELIM,:WK_IDX));
      END
   END

   /* parms for a specifiy procedure either GETALL or a LIST */
   /* for P9 this is GETALL */
   /* orders for cover letters only */

   IF ((WK_ORDER1 = 'GETALL') AND
       (WK_ORDER_TYPE1 = 'GETALL') AND
       (WK_ORDER_STATUS1 = 'GETALL') AND
       (WK_PRIORITY1 = 0)) THEN
   BEGIN
      FOR 
         SELECT P1.PICK_ORDER 
         FROM PICK_ITEM P1 
             JOIN PICK_ORDER P2 ON P2.PICK_ORDER = P1.PICK_ORDER 
         WHERE P1.PICK_LINE_STATUS IN ('OP','UP') 
           AND  P1.PICK_ORDER_QTY > 0   
           AND  P1.PROD_ID = 'NOPROD'   
           AND P2.PICK_STATUS IN ('OP','DA')
           GROUP BY P1.PICK_ORDER
           ORDER BY P2.PICK_PRIORITY, P2.WIP_ORDERING, P1.WIP_PRELOCN_ORDERING, P1.PICK_LOCATION, P1.WIP_POSTLOCN_ORDERING 
         INTO :WK_ORDER 
      DO
      BEGIN
         SUSPEND;
      END
   END
   ELSE
   IF ((WK_ORDER1 = 'GETALL') AND
       (WK_ORDER_TYPE1 = 'GETALL') AND
       (WK_ORDER_STATUS1 = 'GETALL') AND
       (WK_PRIORITY_CNT > 0)) THEN
   BEGIN
      FOR 
         SELECT P1.PICK_ORDER 
         FROM PICK_ITEM P1 
             JOIN PICK_ORDER P2 ON P2.PICK_ORDER = P1.PICK_ORDER 
         WHERE P1.PICK_LINE_STATUS IN ('OP','UP') 
           AND  P1.PICK_ORDER_QTY > 0   
           AND  P1.PROD_ID = 'NOPROD'   
           AND P2.PICK_STATUS IN ('OP','DA')
           AND (P2.PICK_PRIORITY = :WK_PRIORITY1 
                OR P2.PICK_PRIORITY = :WK_PRIORITY2
                OR P2.PICK_PRIORITY = :WK_PRIORITY3
                OR P2.PICK_PRIORITY = :WK_PRIORITY4
                OR P2.PICK_PRIORITY = :WK_PRIORITY5)
           GROUP BY P1.PICK_ORDER
           ORDER BY P2.PICK_PRIORITY, P2.WIP_ORDERING, P1.WIP_PRELOCN_ORDERING, P1.PICK_LOCATION, P1.WIP_POSTLOCN_ORDERING 
         INTO :WK_ORDER 
      DO
      BEGIN
         SUSPEND;
      END
   END
   ELSE
   IF ((WK_ORDER1 = 'GETALL') AND
       (WK_ORDER_TYPE1 = 'GETALL') AND
       (WK_STATUS_CNT > 0) AND
       (WK_PRIORITY1 = 0)) THEN
   BEGIN
      FOR 
         SELECT P1.PICK_ORDER 
         FROM PICK_ITEM P1 
             JOIN PICK_ORDER P2 ON P2.PICK_ORDER = P1.PICK_ORDER 
         WHERE (P1.PICK_LINE_STATUS = :WK_ORDER_STATUS1 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS2 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS3 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS4 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS5) 
           AND  P1.PICK_ORDER_QTY > 0   
           AND  P1.PROD_ID = 'NOPROD'   
           AND P2.PICK_STATUS IN ('OP','DA')
           GROUP BY P1.PICK_ORDER
           ORDER BY P2.PICK_PRIORITY, P2.WIP_ORDERING, P1.WIP_PRELOCN_ORDERING, P1.PICK_LOCATION, P1.WIP_POSTLOCN_ORDERING 
         INTO :WK_ORDER 
      DO
      BEGIN
         SUSPEND;
      END
   END
   ELSE
   IF ((WK_ORDER1 = 'GETALL') AND
       (WK_ORDER_TYPE1 = 'GETALL') AND
       (WK_STATUS_CNT > 0) AND
       (WK_PRIORITY_CNT > 0)) THEN
   BEGIN
      FOR 
         SELECT P1.PICK_ORDER 
         FROM PICK_ITEM P1 
             JOIN PICK_ORDER P2 ON P2.PICK_ORDER = P1.PICK_ORDER 
         WHERE (P1.PICK_LINE_STATUS = :WK_ORDER_STATUS1 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS2 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS3 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS4 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS5) 
           AND  P1.PICK_ORDER_QTY > 0   
           AND  P1.PROD_ID = 'NOPROD'   
           AND P2.PICK_STATUS IN ('OP','DA')
           AND (P2.PICK_PRIORITY = :WK_PRIORITY1 
                OR P2.PICK_PRIORITY = :WK_PRIORITY2
                OR P2.PICK_PRIORITY = :WK_PRIORITY3
                OR P2.PICK_PRIORITY = :WK_PRIORITY4
                OR P2.PICK_PRIORITY = :WK_PRIORITY5)
           GROUP BY P1.PICK_ORDER
           ORDER BY P2.PICK_PRIORITY, P2.WIP_ORDERING, P1.WIP_PRELOCN_ORDERING, P1.PICK_LOCATION, P1.WIP_POSTLOCN_ORDERING 
         INTO :WK_ORDER 
      DO
      BEGIN
         SUSPEND;
      END
   END
   ELSE
   IF ((WK_ORDER1 = 'GETALL') AND
       (WK_TYPE_CNT > 0) AND
       (WK_ORDER_STATUS1 = 'GETALL') AND
       (WK_PRIORITY1 = 0)) THEN
   BEGIN
      FOR 
         SELECT P1.PICK_ORDER 
         FROM PICK_ITEM P1 
             JOIN PICK_ORDER P2 ON P2.PICK_ORDER = P1.PICK_ORDER 
         WHERE P1.PICK_LINE_STATUS IN ('OP','UP') 
           AND  P1.PICK_ORDER_QTY > 0   
           AND  P1.PROD_ID = 'NOPROD'   
           AND P2.PICK_STATUS IN ('OP','DA')
           AND (P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE1
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE2
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE3
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE4
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE5)
           GROUP BY P1.PICK_ORDER
           ORDER BY P2.PICK_PRIORITY, P2.WIP_ORDERING, P1.WIP_PRELOCN_ORDERING, P1.PICK_LOCATION, P1.WIP_POSTLOCN_ORDERING 
         INTO :WK_ORDER 
      DO
      BEGIN
         SUSPEND;
      END
   END
   ELSE
   IF ((WK_ORDER1 = 'GETALL') AND
       (WK_TYPE_CNT > 0) AND
       (WK_ORDER_STATUS1 = 'GETALL') AND
       (WK_PRIORITY_CNT > 0)) THEN
   BEGIN
      FOR 
         SELECT P1.PICK_ORDER 
         FROM PICK_ITEM P1 
             JOIN PICK_ORDER P2 ON P2.PICK_ORDER = P1.PICK_ORDER 
         WHERE P1.PICK_LINE_STATUS IN ('OP','UP') 
           AND  P1.PICK_ORDER_QTY > 0   
           AND  P1.PROD_ID = 'NOPROD'   
           AND P2.PICK_STATUS IN ('OP','DA')
           AND (P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE1
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE2
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE3
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE4
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE5)
           AND (P2.PICK_PRIORITY = :WK_PRIORITY1 
                OR P2.PICK_PRIORITY = :WK_PRIORITY2
                OR P2.PICK_PRIORITY = :WK_PRIORITY3
                OR P2.PICK_PRIORITY = :WK_PRIORITY4
                OR P2.PICK_PRIORITY = :WK_PRIORITY5)
           GROUP BY P1.PICK_ORDER
           ORDER BY P2.PICK_PRIORITY, P2.WIP_ORDERING, P1.WIP_PRELOCN_ORDERING, P1.PICK_LOCATION, P1.WIP_POSTLOCN_ORDERING 
         INTO :WK_ORDER 
      DO
      BEGIN
         SUSPEND;
      END
   END
   ELSE
   IF ((WK_ORDER1 = 'GETALL') AND
       (WK_TYPE_CNT > 0) AND
       (WK_STATUS_CNT > 0) AND
       (WK_PRIORITY1 = 0)) THEN
   BEGIN
      FOR 
         SELECT P1.PICK_ORDER 
         FROM PICK_ITEM P1 
             JOIN PICK_ORDER P2 ON P2.PICK_ORDER = P1.PICK_ORDER 
         WHERE (P1.PICK_LINE_STATUS = :WK_ORDER_STATUS1 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS2 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS3 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS4 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS5) 
           AND  P1.PICK_ORDER_QTY > 0   
           AND  P1.PROD_ID = 'NOPROD'   
           AND P2.PICK_STATUS IN ('OP','DA')
           AND (P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE1
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE2
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE3
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE4
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE5)
           GROUP BY P1.PICK_ORDER
           ORDER BY P2.PICK_PRIORITY, P2.WIP_ORDERING, P1.WIP_PRELOCN_ORDERING, P1.PICK_LOCATION, P1.WIP_POSTLOCN_ORDERING 
         INTO :WK_ORDER 
      DO
      BEGIN
         SUSPEND;
      END
   END
   ELSE
   IF ((WK_ORDER1 = 'GETALL') AND
       (WK_TYPE_CNT > 0) AND
       (WK_STATUS_CNT > 0) AND
       (WK_PRIORITY_CNT > 0)) THEN
   BEGIN
      FOR 
         SELECT P1.PICK_ORDER 
         FROM PICK_ITEM P1 
             JOIN PICK_ORDER P2 ON P2.PICK_ORDER = P1.PICK_ORDER 
         WHERE (P1.PICK_LINE_STATUS = :WK_ORDER_STATUS1 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS2 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS3 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS4 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS5) 
           AND  P1.PICK_ORDER_QTY > 0   
           AND  P1.PROD_ID = 'NOPROD'   
           AND P2.PICK_STATUS IN ('OP','DA')
           AND (P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE1
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE2
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE3
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE4
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE5)
           AND (P2.PICK_PRIORITY = :WK_PRIORITY1 
                OR P2.PICK_PRIORITY = :WK_PRIORITY2
                OR P2.PICK_PRIORITY = :WK_PRIORITY3
                OR P2.PICK_PRIORITY = :WK_PRIORITY4
                OR P2.PICK_PRIORITY = :WK_PRIORITY5)
           GROUP BY P1.PICK_ORDER
           ORDER BY P2.PICK_PRIORITY, P2.WIP_ORDERING, P1.WIP_PRELOCN_ORDERING, P1.PICK_LOCATION, P1.WIP_POSTLOCN_ORDERING 
         INTO :WK_ORDER 
      DO
      BEGIN
         SUSPEND;
      END
   END
   ELSE
   IF ((WK_ORDER_CNT > 0) AND
       (WK_ORDER_TYPE1 = 'GETALL') AND
       (WK_ORDER_STATUS1 = 'GETALL') AND
       (WK_PRIORITY1 = 0)) THEN
   BEGIN
      FOR 
         SELECT P1.PICK_ORDER 
         FROM PICK_ITEM P1 
             JOIN PICK_ORDER P2 ON P2.PICK_ORDER = P1.PICK_ORDER 
         WHERE P1.PICK_LINE_STATUS IN ('OP','UP') 
           AND  P1.PICK_ORDER_QTY > 0   
           AND  P1.PROD_ID = 'NOPROD'   
           AND (P1.PICK_ORDER = :WK_ORDER1
                OR P1.PICK_ORDER = :WK_ORDER2
                OR P1.PICK_ORDER = :WK_ORDER3
                OR P1.PICK_ORDER = :WK_ORDER4
                OR P1.PICK_ORDER = :WK_ORDER5
                OR P1.PICK_ORDER = :WK_ORDER6
                OR P1.PICK_ORDER = :WK_ORDER7
                OR P1.PICK_ORDER = :WK_ORDER8
                OR P1.PICK_ORDER = :WK_ORDER9
                OR P1.PICK_ORDER = :WK_ORDER10
                OR P1.PICK_ORDER = :WK_ORDER11
                OR P1.PICK_ORDER = :WK_ORDER12
                OR P1.PICK_ORDER = :WK_ORDER13
                OR P1.PICK_ORDER = :WK_ORDER14
                OR P1.PICK_ORDER = :WK_ORDER15
                OR P1.PICK_ORDER = :WK_ORDER16
                OR P1.PICK_ORDER = :WK_ORDER17
                OR P1.PICK_ORDER = :WK_ORDER18
                OR P1.PICK_ORDER = :WK_ORDER19
                OR P1.PICK_ORDER = :WK_ORDER20)
           AND P2.PICK_STATUS IN ('OP','DA')
           GROUP BY P1.PICK_ORDER
           ORDER BY P2.PICK_PRIORITY, P2.WIP_ORDERING, P1.WIP_PRELOCN_ORDERING, P1.PICK_LOCATION, P1.WIP_POSTLOCN_ORDERING 
         INTO :WK_ORDER 
      DO
      BEGIN
         SUSPEND;
      END
   END
   ELSE
   IF ((WK_ORDER_CNT > 0) AND
       (WK_ORDER_TYPE1 = 'GETALL') AND
       (WK_ORDER_STATUS1 = 'GETALL') AND
       (WK_PRIORITY_CNT > 0)) THEN
   BEGIN
      FOR 
         SELECT P1.PICK_ORDER 
         FROM PICK_ITEM P1 
             JOIN PICK_ORDER P2 ON P2.PICK_ORDER = P1.PICK_ORDER 
         WHERE P1.PICK_LINE_STATUS IN ('OP','UP') 
           AND (P1.PICK_ORDER = :WK_ORDER1
                OR P1.PICK_ORDER = :WK_ORDER2
                OR P1.PICK_ORDER = :WK_ORDER3
                OR P1.PICK_ORDER = :WK_ORDER4
                OR P1.PICK_ORDER = :WK_ORDER5
                OR P1.PICK_ORDER = :WK_ORDER6
                OR P1.PICK_ORDER = :WK_ORDER7
                OR P1.PICK_ORDER = :WK_ORDER8
                OR P1.PICK_ORDER = :WK_ORDER9
                OR P1.PICK_ORDER = :WK_ORDER10
                OR P1.PICK_ORDER = :WK_ORDER11
                OR P1.PICK_ORDER = :WK_ORDER12
                OR P1.PICK_ORDER = :WK_ORDER13
                OR P1.PICK_ORDER = :WK_ORDER14
                OR P1.PICK_ORDER = :WK_ORDER15
                OR P1.PICK_ORDER = :WK_ORDER16
                OR P1.PICK_ORDER = :WK_ORDER17
                OR P1.PICK_ORDER = :WK_ORDER18
                OR P1.PICK_ORDER = :WK_ORDER19
                OR P1.PICK_ORDER = :WK_ORDER20)
           AND  P1.PICK_ORDER_QTY > 0   
           AND  P1.PROD_ID = 'NOPROD'   
           AND P2.PICK_STATUS IN ('OP','DA')
           AND (P2.PICK_PRIORITY = :WK_PRIORITY1 
                OR P2.PICK_PRIORITY = :WK_PRIORITY2
                OR P2.PICK_PRIORITY = :WK_PRIORITY3
                OR P2.PICK_PRIORITY = :WK_PRIORITY4
                OR P2.PICK_PRIORITY = :WK_PRIORITY5)
           GROUP BY P1.PICK_ORDER
           ORDER BY P2.PICK_PRIORITY, P2.WIP_ORDERING, P1.WIP_PRELOCN_ORDERING, P1.PICK_LOCATION, P1.WIP_POSTLOCN_ORDERING 
         INTO :WK_ORDER 
      DO
      BEGIN
         SUSPEND;
      END
   END
   ELSE
   IF ((WK_ORDER_CNT > 0) AND
       (WK_ORDER_TYPE1 = 'GETALL') AND
       (WK_STATUS_CNT > 0) AND
       (WK_PRIORITY1 = 0)) THEN
   BEGIN
      FOR 
         SELECT P1.PICK_ORDER 
         FROM PICK_ITEM P1 
             JOIN PICK_ORDER P2 ON P2.PICK_ORDER = P1.PICK_ORDER 
         WHERE (P1.PICK_LINE_STATUS = :WK_ORDER_STATUS1 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS2 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS3 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS4 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS5) 
           AND (P1.PICK_ORDER = :WK_ORDER1
                OR P1.PICK_ORDER = :WK_ORDER2
                OR P1.PICK_ORDER = :WK_ORDER3
                OR P1.PICK_ORDER = :WK_ORDER4
                OR P1.PICK_ORDER = :WK_ORDER5
                OR P1.PICK_ORDER = :WK_ORDER6
                OR P1.PICK_ORDER = :WK_ORDER7
                OR P1.PICK_ORDER = :WK_ORDER8
                OR P1.PICK_ORDER = :WK_ORDER9
                OR P1.PICK_ORDER = :WK_ORDER10
                OR P1.PICK_ORDER = :WK_ORDER11
                OR P1.PICK_ORDER = :WK_ORDER12
                OR P1.PICK_ORDER = :WK_ORDER13
                OR P1.PICK_ORDER = :WK_ORDER14
                OR P1.PICK_ORDER = :WK_ORDER15
                OR P1.PICK_ORDER = :WK_ORDER16
                OR P1.PICK_ORDER = :WK_ORDER17
                OR P1.PICK_ORDER = :WK_ORDER18
                OR P1.PICK_ORDER = :WK_ORDER19
                OR P1.PICK_ORDER = :WK_ORDER20)
           AND  P1.PICK_ORDER_QTY > 0   
           AND  P1.PROD_ID = 'NOPROD'   
           AND P2.PICK_STATUS IN ('OP','DA')
           GROUP BY P1.PICK_ORDER
           ORDER BY P2.PICK_PRIORITY, P2.WIP_ORDERING, P1.WIP_PRELOCN_ORDERING, P1.PICK_LOCATION, P1.WIP_POSTLOCN_ORDERING 
         INTO :WK_ORDER 
      DO
      BEGIN
         SUSPEND;
      END
   END
   ELSE
   IF ((WK_ORDER_CNT > 0) AND
       (WK_ORDER_TYPE1 = 'GETALL') AND
       (WK_STATUS_CNT > 0) AND
       (WK_PRIORITY_CNT > 0)) THEN
   BEGIN
      FOR 
         SELECT P1.PICK_ORDER 
         FROM PICK_ITEM P1 
             JOIN PICK_ORDER P2 ON P2.PICK_ORDER = P1.PICK_ORDER 
         WHERE (P1.PICK_LINE_STATUS = :WK_ORDER_STATUS1 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS2 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS3 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS4 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS5) 
           AND (P1.PICK_ORDER = :WK_ORDER1
                OR P1.PICK_ORDER = :WK_ORDER2
                OR P1.PICK_ORDER = :WK_ORDER3
                OR P1.PICK_ORDER = :WK_ORDER4
                OR P1.PICK_ORDER = :WK_ORDER5
                OR P1.PICK_ORDER = :WK_ORDER6
                OR P1.PICK_ORDER = :WK_ORDER7
                OR P1.PICK_ORDER = :WK_ORDER8
                OR P1.PICK_ORDER = :WK_ORDER9
                OR P1.PICK_ORDER = :WK_ORDER10
                OR P1.PICK_ORDER = :WK_ORDER11
                OR P1.PICK_ORDER = :WK_ORDER12
                OR P1.PICK_ORDER = :WK_ORDER13
                OR P1.PICK_ORDER = :WK_ORDER14
                OR P1.PICK_ORDER = :WK_ORDER15
                OR P1.PICK_ORDER = :WK_ORDER16
                OR P1.PICK_ORDER = :WK_ORDER17
                OR P1.PICK_ORDER = :WK_ORDER18
                OR P1.PICK_ORDER = :WK_ORDER19
                OR P1.PICK_ORDER = :WK_ORDER20)
           AND  P1.PICK_ORDER_QTY > 0   
           AND  P1.PROD_ID = 'NOPROD'   
           AND P2.PICK_STATUS IN ('OP','DA')
           AND (P2.PICK_PRIORITY = :WK_PRIORITY1 
                OR P2.PICK_PRIORITY = :WK_PRIORITY2
                OR P2.PICK_PRIORITY = :WK_PRIORITY3
                OR P2.PICK_PRIORITY = :WK_PRIORITY4
                OR P2.PICK_PRIORITY = :WK_PRIORITY5)
           GROUP BY P1.PICK_ORDER
           ORDER BY P2.PICK_PRIORITY, P2.WIP_ORDERING, P1.WIP_PRELOCN_ORDERING, P1.PICK_LOCATION, P1.WIP_POSTLOCN_ORDERING 
         INTO :WK_ORDER 
      DO
      BEGIN
         SUSPEND;
      END
   END
   ELSE
   IF ((WK_ORDER_CNT > 0) AND
       (WK_TYPE_CNT > 0) AND
       (WK_ORDER_STATUS1 = 'GETALL') AND
       (WK_PRIORITY1 = 0)) THEN
   BEGIN
      FOR 
         SELECT P1.PICK_ORDER 
         FROM PICK_ITEM P1 
             JOIN PICK_ORDER P2 ON P2.PICK_ORDER = P1.PICK_ORDER 
         WHERE P1.PICK_LINE_STATUS IN ('OP','UP') 
           AND (P1.PICK_ORDER = :WK_ORDER1
                OR P1.PICK_ORDER = :WK_ORDER2
                OR P1.PICK_ORDER = :WK_ORDER3
                OR P1.PICK_ORDER = :WK_ORDER4
                OR P1.PICK_ORDER = :WK_ORDER5
                OR P1.PICK_ORDER = :WK_ORDER6
                OR P1.PICK_ORDER = :WK_ORDER7
                OR P1.PICK_ORDER = :WK_ORDER8
                OR P1.PICK_ORDER = :WK_ORDER9
                OR P1.PICK_ORDER = :WK_ORDER10
                OR P1.PICK_ORDER = :WK_ORDER11
                OR P1.PICK_ORDER = :WK_ORDER12
                OR P1.PICK_ORDER = :WK_ORDER13
                OR P1.PICK_ORDER = :WK_ORDER14
                OR P1.PICK_ORDER = :WK_ORDER15
                OR P1.PICK_ORDER = :WK_ORDER16
                OR P1.PICK_ORDER = :WK_ORDER17
                OR P1.PICK_ORDER = :WK_ORDER18
                OR P1.PICK_ORDER = :WK_ORDER19
                OR P1.PICK_ORDER = :WK_ORDER20)
           AND  P1.PICK_ORDER_QTY > 0   
           AND  P1.PROD_ID = 'NOPROD'   
           AND P2.PICK_STATUS IN ('OP','DA')
           AND (P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE1
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE2
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE3
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE4
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE5)
           GROUP BY P1.PICK_ORDER
           ORDER BY P2.PICK_PRIORITY, P2.WIP_ORDERING, P1.WIP_PRELOCN_ORDERING, P1.PICK_LOCATION, P1.WIP_POSTLOCN_ORDERING 
         INTO :WK_ORDER 
      DO
      BEGIN
         SUSPEND;
      END
   END
   ELSE
   IF ((WK_ORDER_CNT > 0) AND
       (WK_TYPE_CNT > 0) AND
       (WK_ORDER_STATUS1 = 'GETALL') AND
       (WK_PRIORITY_CNT > 0)) THEN
   BEGIN
      FOR 
         SELECT P1.PICK_ORDER 
         FROM PICK_ITEM P1 
             JOIN PICK_ORDER P2 ON P2.PICK_ORDER = P1.PICK_ORDER 
         WHERE P1.PICK_LINE_STATUS IN ('OP','UP') 
           AND (P1.PICK_ORDER = :WK_ORDER1
                OR P1.PICK_ORDER = :WK_ORDER2
                OR P1.PICK_ORDER = :WK_ORDER3
                OR P1.PICK_ORDER = :WK_ORDER4
                OR P1.PICK_ORDER = :WK_ORDER5
                OR P1.PICK_ORDER = :WK_ORDER6
                OR P1.PICK_ORDER = :WK_ORDER7
                OR P1.PICK_ORDER = :WK_ORDER8
                OR P1.PICK_ORDER = :WK_ORDER9
                OR P1.PICK_ORDER = :WK_ORDER10
                OR P1.PICK_ORDER = :WK_ORDER11
                OR P1.PICK_ORDER = :WK_ORDER12
                OR P1.PICK_ORDER = :WK_ORDER13
                OR P1.PICK_ORDER = :WK_ORDER14
                OR P1.PICK_ORDER = :WK_ORDER15
                OR P1.PICK_ORDER = :WK_ORDER16
                OR P1.PICK_ORDER = :WK_ORDER17
                OR P1.PICK_ORDER = :WK_ORDER18
                OR P1.PICK_ORDER = :WK_ORDER19
                OR P1.PICK_ORDER = :WK_ORDER20)
           AND  P1.PICK_ORDER_QTY > 0   
           AND  P1.PROD_ID = 'NOPROD'   
           AND P2.PICK_STATUS IN ('OP','DA')
           AND (P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE1
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE2
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE3
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE4
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE5)
           AND (P2.PICK_PRIORITY = :WK_PRIORITY1 
                OR P2.PICK_PRIORITY = :WK_PRIORITY2
                OR P2.PICK_PRIORITY = :WK_PRIORITY3
                OR P2.PICK_PRIORITY = :WK_PRIORITY4
                OR P2.PICK_PRIORITY = :WK_PRIORITY5)
           GROUP BY P1.PICK_ORDER
           ORDER BY P2.PICK_PRIORITY, P2.WIP_ORDERING, P1.WIP_PRELOCN_ORDERING, P1.PICK_LOCATION, P1.WIP_POSTLOCN_ORDERING 
         INTO :WK_ORDER 
      DO
      BEGIN
         SUSPEND;
      END
   END
   ELSE
   IF ((WK_ORDER_CNT > 0) AND
       (WK_TYPE_CNT > 0) AND
       (WK_STATUS_CNT > 0) AND
       (WK_PRIORITY1 = 0)) THEN
   BEGIN
      FOR 
         SELECT P1.PICK_ORDER 
         FROM PICK_ITEM P1 
             JOIN PICK_ORDER P2 ON P2.PICK_ORDER = P1.PICK_ORDER 
         WHERE (P1.PICK_LINE_STATUS = :WK_ORDER_STATUS1 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS2 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS3 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS4 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS5) 
           AND (P1.PICK_ORDER = :WK_ORDER1
                OR P1.PICK_ORDER = :WK_ORDER2
                OR P1.PICK_ORDER = :WK_ORDER3
                OR P1.PICK_ORDER = :WK_ORDER4
                OR P1.PICK_ORDER = :WK_ORDER5
                OR P1.PICK_ORDER = :WK_ORDER6
                OR P1.PICK_ORDER = :WK_ORDER7
                OR P1.PICK_ORDER = :WK_ORDER8
                OR P1.PICK_ORDER = :WK_ORDER9
                OR P1.PICK_ORDER = :WK_ORDER10
                OR P1.PICK_ORDER = :WK_ORDER11
                OR P1.PICK_ORDER = :WK_ORDER12
                OR P1.PICK_ORDER = :WK_ORDER13
                OR P1.PICK_ORDER = :WK_ORDER14
                OR P1.PICK_ORDER = :WK_ORDER15
                OR P1.PICK_ORDER = :WK_ORDER16
                OR P1.PICK_ORDER = :WK_ORDER17
                OR P1.PICK_ORDER = :WK_ORDER18
                OR P1.PICK_ORDER = :WK_ORDER19
                OR P1.PICK_ORDER = :WK_ORDER20)
           AND  P1.PICK_ORDER_QTY > 0   
           AND  P1.PROD_ID = 'NOPROD'   
           AND P2.PICK_STATUS IN ('OP','DA')
           AND (P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE1
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE2
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE3
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE4
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE5)
           GROUP BY P1.PICK_ORDER
           ORDER BY P2.PICK_PRIORITY, P2.WIP_ORDERING, P1.WIP_PRELOCN_ORDERING, P1.PICK_LOCATION, P1.WIP_POSTLOCN_ORDERING 
         INTO :WK_ORDER 
      DO
      BEGIN
         SUSPEND;
      END
   END
   ELSE
   IF ((WK_ORDER_CNT > 0) AND
       (WK_TYPE_CNT > 0) AND
       (WK_STATUS_CNT > 0) AND
       (WK_PRIORITY_CNT > 0)) THEN
   BEGIN
      FOR 
         SELECT P1.PICK_ORDER 
         FROM PICK_ITEM P1 
             JOIN PICK_ORDER P2 ON P2.PICK_ORDER = P1.PICK_ORDER 
         WHERE (P1.PICK_LINE_STATUS = :WK_ORDER_STATUS1 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS2 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS3 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS4 
            OR P1.PICK_LINE_STATUS = :WK_ORDER_STATUS5) 
           AND (P1.PICK_ORDER = :WK_ORDER1
                OR P1.PICK_ORDER = :WK_ORDER2
                OR P1.PICK_ORDER = :WK_ORDER3
                OR P1.PICK_ORDER = :WK_ORDER4
                OR P1.PICK_ORDER = :WK_ORDER5
                OR P1.PICK_ORDER = :WK_ORDER6
                OR P1.PICK_ORDER = :WK_ORDER7
                OR P1.PICK_ORDER = :WK_ORDER8
                OR P1.PICK_ORDER = :WK_ORDER9
                OR P1.PICK_ORDER = :WK_ORDER10
                OR P1.PICK_ORDER = :WK_ORDER11
                OR P1.PICK_ORDER = :WK_ORDER12
                OR P1.PICK_ORDER = :WK_ORDER13
                OR P1.PICK_ORDER = :WK_ORDER14
                OR P1.PICK_ORDER = :WK_ORDER15
                OR P1.PICK_ORDER = :WK_ORDER16
                OR P1.PICK_ORDER = :WK_ORDER17
                OR P1.PICK_ORDER = :WK_ORDER18
                OR P1.PICK_ORDER = :WK_ORDER19
                OR P1.PICK_ORDER = :WK_ORDER20)
           AND  P1.PICK_ORDER_QTY > 0   
           AND  P1.PROD_ID = 'NOPROD'   
           AND P2.PICK_STATUS IN ('OP','DA')
           AND (P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE1
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE2
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE3
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE4
                OR P2.PICK_ORDER_TYPE = :WK_ORDER_TYPE5)
           AND (P2.PICK_PRIORITY = :WK_PRIORITY1 
                OR P2.PICK_PRIORITY = :WK_PRIORITY2
                OR P2.PICK_PRIORITY = :WK_PRIORITY3
                OR P2.PICK_PRIORITY = :WK_PRIORITY4
                OR P2.PICK_PRIORITY = :WK_PRIORITY5)
           GROUP BY P1.PICK_ORDER
           ORDER BY P2.PICK_PRIORITY, P2.WIP_ORDERING, P1.WIP_PRELOCN_ORDERING, P1.PICK_LOCATION, P1.WIP_POSTLOCN_ORDERING 
         INTO :WK_ORDER 
      DO
      BEGIN
         SUSPEND;
      END
   END
   EXIT;
END ^

ALTER PROCEDURE PICK_PERSON_TEMP AS 
 

DECLARE VARIABLE WK_FOUND INTEGER;
DECLARE VARIABLE WK_H_PERSON_ID VARCHAR(10); 
DECLARE VARIABLE WK_P_PERSON_TYPE CHAR(2);
DECLARE VARIABLE WK_P_FIRST_NAME VARCHAR(50); 
DECLARE VARIABLE WK_P_LAST_NAME VARCHAR(50); 
DECLARE VARIABLE WK_P_ADDRESS_LINE1 VARCHAR(100); 
DECLARE VARIABLE WK_P_ADDRESS_LINE2 VARCHAR(50); 
DECLARE VARIABLE WK_P_CITY VARCHAR(25); 
DECLARE VARIABLE WK_P_STATE VARCHAR(15); 
DECLARE VARIABLE WK_P_POST_CODE VARCHAR(10); 
DECLARE VARIABLE WK_P_COUNTRY VARCHAR(25);
DECLARE VARIABLE WK_H_PICK_ORDER  VARCHAR(15);
DECLARE VARIABLE WK_H_PERSON_TYPE CHAR(2);
DECLARE VARIABLE WK_H_FIRST_NAME VARCHAR(50); 
DECLARE VARIABLE WK_H_LAST_NAME VARCHAR(50); 
DECLARE VARIABLE WK_H_ADDRESS_LINE1 VARCHAR(100); 
DECLARE VARIABLE WK_H_ADDRESS_LINE2 VARCHAR(50); 
DECLARE VARIABLE WK_H_CITY VARCHAR(25); 
DECLARE VARIABLE WK_H_STATE VARCHAR(15); 
DECLARE VARIABLE WK_H_POST_CODE VARCHAR(10); 
DECLARE VARIABLE WK_H_COUNTRY VARCHAR(25);

BEGIN
   FOR SELECT 
      PICK_ORDER.PICK_ORDER, PP.PERSON_TYPE, PP.FIRST_NAME, PP.LAST_NAME, PP.ADDRESS_LINE1, PP.ADDRESS_LINE2, PP.CITY, PP.STATE, PP.POST_CODE, PP.COUNTRY,
      PICK_ORDER.P_PERSON_TYPE, PICK_ORDER.P_FIRST_NAME, PICK_ORDER.P_LAST_NAME, PICK_ORDER.P_ADDRESS_LINE1, PICK_ORDER.P_ADDRESS_LINE2, PICK_ORDER.P_CITY, PICK_ORDER.P_STATE, PICK_ORDER.P_POST_CODE, PICK_ORDER.P_COUNTRY
      FROM PICK_ORDER JOIN PERSON PP ON PP.PERSON_ID = PICK_ORDER.PERSON_ID
       INTO :WK_H_PICK_ORDER,
            :WK_P_PERSON_TYPE,
            :WK_P_FIRST_NAME,
            :WK_P_LAST_NAME,
            :WK_P_ADDRESS_LINE1,
            :WK_P_ADDRESS_LINE2,
            :WK_P_CITY,
            :WK_P_STATE,
            :WK_P_POST_CODE,
            :WK_P_COUNTRY,
            :WK_H_PERSON_TYPE,
            :WK_H_FIRST_NAME,
            :WK_H_LAST_NAME,
            :WK_H_ADDRESS_LINE1,
            :WK_H_ADDRESS_LINE2,
            :WK_H_CITY,
            :WK_H_STATE,
            :WK_H_POST_CODE,
            :WK_H_COUNTRY
   DO
   BEGIN
      IF (WK_H_PERSON_TYPE IS NULL) THEN
      BEGIN
         UPDATE PICK_ORDER SET 
            P_PERSON_TYPE = :WK_P_PERSON_TYPE 
         WHERE PICK_ORDER = :WK_H_PICK_ORDER;
      END
      IF (WK_H_FIRST_NAME IS NULL) THEN
      BEGIN
         UPDATE PICK_ORDER SET 
            P_FIRST_NAME = :WK_P_FIRST_NAME 
         WHERE PICK_ORDER = :WK_H_PICK_ORDER;
      END
      IF (WK_H_LAST_NAME IS NULL) THEN
      BEGIN
         UPDATE PICK_ORDER SET 
            P_LAST_NAME = :WK_P_LAST_NAME 
         WHERE PICK_ORDER = :WK_H_PICK_ORDER;
      END
      IF (WK_H_ADDRESS_LINE1 IS NULL) THEN
      BEGIN
         UPDATE PICK_ORDER SET 
            P_ADDRESS_LINE1 = :WK_P_ADDRESS_LINE1 
         WHERE PICK_ORDER = :WK_H_PICK_ORDER;
      END
      IF (WK_H_ADDRESS_LINE2 IS NULL) THEN
      BEGIN
         UPDATE PICK_ORDER SET 
            P_ADDRESS_LINE2 = :WK_P_ADDRESS_LINE2 
         WHERE PICK_ORDER = :WK_H_PICK_ORDER;
      END
      IF (WK_H_CITY IS NULL) THEN
      BEGIN
         UPDATE PICK_ORDER SET 
            P_CITY = :WK_P_CITY 
         WHERE PICK_ORDER = :WK_H_PICK_ORDER;
      END
      IF (WK_H_STATE IS NULL) THEN
      BEGIN
         UPDATE PICK_ORDER SET 
            P_STATE = :WK_P_STATE 
         WHERE PICK_ORDER = :WK_H_PICK_ORDER;
      END
      IF (WK_H_POST_CODE IS NULL) THEN
      BEGIN
         UPDATE PICK_ORDER SET 
            P_POST_CODE = :WK_P_POST_CODE 
         WHERE PICK_ORDER = :WK_H_PICK_ORDER;
      END
      IF (WK_H_COUNTRY IS NULL) THEN
      BEGIN
         UPDATE PICK_ORDER SET 
            P_COUNTRY = :WK_P_COUNTRY 
         WHERE PICK_ORDER = :WK_H_PICK_ORDER;
      END
   END
END ^

ALTER PROCEDURE PINPOINT_PICKS_ONDEVICE (IN_STATUS VARCHAR(2) CHARACTER SET NONE)
AS 
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_DEVICE CHAR(2);
DECLARE VARIABLE WK_PO_ORDER VARCHAR(15);
DECLARE VARIABLE WK_PI_LABEL_NO VARCHAR(10);
DECLARE VARIABLE WK_PI_PICK_ORDER VARCHAR(15);
DECLARE VARIABLE WK_PI_STATUS     VARCHAR(2);
DECLARE VARIABLE WK_PI_QTY_TOPICK  INTEGER; 
DECLARE VARIABLE WK_PID_DETAIL_ID INTEGER ;
DECLARE VARIABLE WK_PID_DEVICE_ID VARCHAR(2);
DECLARE VARIABLE WK_PID_SSN_ID VARCHAR(20);
DECLARE VARIABLE WK_PID_STATUS  VARCHAR(2);
DECLARE VARIABLE WK_PID_LABEL_NO VARCHAR(10);
DECLARE VARIABLE WK_PID_PICK_ORDER VARCHAR(15);
DECLARE VARIABLE WK_PL_WH_ID VARCHAR(2);
DECLARE VARIABLE WK_PL_LOCN_ID VARCHAR(10);
DECLARE VARIABLE WK_PL_RECORD_ID INTEGER ;
DECLARE VARIABLE WK_PL_STATUS    VARCHAR(2);
DECLARE VARIABLE WK_IS_LOCN_ID VARCHAR(10);
DECLARE VARIABLE WK_IS_WH_ID VARCHAR(2);
DECLARE VARIABLE WK_IS_SSN_ID VARCHAR(20);
DECLARE VARIABLE WK_IS_QTY INTEGER; 
DECLARE VARIABLE WK_IS_STATUS VARCHAR(2);
DECLARE VARIABLE WK_REFERENCE VARCHAR(255);

BEGIN
/* move OP or DS status pick_location to the block */
   FOR SELECT P1.PICK_ORDER,P3.DEVICE_ID,P4.WH_ID,P4.LOCN_ID,P3.SSN_ID
      FROM PICK_ORDER P1
      JOIN PICK_ITEM P2 ON  P2.PICK_ORDER = P1.PICK_ORDER
      JOIN PICK_ITEM_DETAIL P3 ON P3.PICK_LABEL_NO = P2.PICK_LABEL_NO
      JOIN ISSN I1 ON I1.SSN_ID=P3.SSN_ID
      LEFT OUTER JOIN PICK_LOCATION P4 ON P4.PICK_ORDER = P1.PICK_ORDER
      JOIN CONTROL C1 ON C1.RECORD_ID = 1
      WHERE  P1.PICK_STATUS IN ('OP','DA')
      AND    P2.PICK_LINE_STATUS IN  ('PL')
      AND P3.PICK_DETAIL_STATUS  IN ('PL')
      AND ( I1.WH_ID<>C1.DEFAULT_WH_ID )
      AND P4.PICK_LOCATION_STATUS IN ('OP','DS')
      AND (P3.QTY_PICKED IS NOT NULL) 
      AND (P3.QTY_PICKED > 0)
      GROUP BY   P1.PICK_ORDER,P3.DEVICE_ID,P4.WH_ID,P4.LOCN_ID,P3.SSN_ID
      INTO :WK_PO_ORDER,:WK_PID_DEVICE_ID,:WK_PL_WH_ID,:WK_PL_LOCN_ID,:WK_PID_SSN_ID
   DO
   BEGIN
      UPDATE ISSN 
      SET WH_ID = :WK_PL_WH_ID, 
          LOCN_ID = :WK_PL_LOCN_ID
      WHERE SSN_ID = :WK_PID_SSN_ID;
   END

/* failed to do the PKIL */
   FOR  SELECT PICK_ITEM_DETAIL.PICK_LABEL_NO, PICK_ITEM_DETAIL.SSN_ID, PICK_ITEM_DETAIL.PICK_DETAIL_ID,
               PICK_ITEM.PICK_ORDER, PICK_ITEM.PICK_LINE_STATUS, 
               PICK_LOCATION.PICK_LOCATION_STATUS, PICK_LOCATION.RECORD_ID, PICK_LOCATION.LOCN_ID, PICK_LOCATION.WH_ID
        FROM PICK_ITEM_DETAIL
        JOIN PICK_ITEM ON PICK_ITEM.PICK_LABEL_NO = PICK_ITEM_DETAIL.PICK_LABEL_NO
        JOIN PICK_LOCATION ON PICK_LOCATION.PICK_ORDER = PICK_ITEM.PICK_ORDER AND PICK_LOCATION.PICK_LOCATION_STATUS IN ('OP','DS')
        WHERE PICK_ITEM_DETAIL.DEVICE_ID = 'C1' AND 
              PICK_ITEM_DETAIL.PICK_DETAIL_STATUS = 'PL' AND
              PICK_ITEM_DETAIL.QTY_PICKED > 0 AND
              PICK_ITEM_DETAIL.DESPATCH_LOCATION IS NULL
        INTO :WK_PID_LABEL_NO, :WK_PID_SSN_ID, :WK_PID_DETAIL_ID,
             :WK_PI_PICK_ORDER, :WK_PI_STATUS,
             :WK_PL_STATUS, :WK_PL_RECORD_ID, :WK_PL_LOCN_ID, :WK_PL_WH_ID
   DO
   BEGIN
      UPDATE PICK_ITEM_DETAIL
      SET DESPATCH_LOCATION = :WK_PL_LOCN_ID
      WHERE PICK_DETAIL_ID = :WK_PID_DETAIL_ID;
   END

   FOR  SELECT PICK_ITEM_DETAIL.PICK_LABEL_NO, PICK_ITEM_DETAIL.SSN_ID, PICK_ITEM_DETAIL.PICK_DETAIL_ID,
               PICK_ITEM.PICK_ORDER, PICK_ITEM.PICK_LINE_STATUS, 
               PICK_LOCATION.PICK_LOCATION_STATUS, PICK_LOCATION.RECORD_ID, PICK_LOCATION.LOCN_ID, PICK_LOCATION.WH_ID
        FROM PICK_ITEM_DETAIL
        JOIN PICK_ITEM ON PICK_ITEM.PICK_LABEL_NO = PICK_ITEM_DETAIL.PICK_LABEL_NO
        JOIN PICK_LOCATION ON PICK_LOCATION.PICK_ORDER = PICK_ITEM.PICK_ORDER AND PICK_LOCATION.PICK_LOCATION_STATUS IN ('OP','DS')
        WHERE PICK_ITEM_DETAIL.DEVICE_ID = 'CE' AND 
              PICK_ITEM_DETAIL.PICK_DETAIL_STATUS = 'PL' AND
              PICK_ITEM_DETAIL.QTY_PICKED > 0 AND
              PICK_ITEM_DETAIL.DESPATCH_LOCATION IS NULL
        INTO :WK_PID_LABEL_NO, :WK_PID_SSN_ID, :WK_PID_DETAIL_ID,
             :WK_PI_PICK_ORDER, :WK_PI_STATUS,
             :WK_PL_STATUS, :WK_PL_RECORD_ID, :WK_PL_LOCN_ID, :WK_PL_WH_ID
   DO
   BEGIN
      UPDATE PICK_ITEM_DETAIL
      SET DESPATCH_LOCATION = :WK_PL_LOCN_ID
      WHERE PICK_DETAIL_ID = :WK_PID_DETAIL_ID;
   END

   FOR  SELECT PICK_ITEM_DETAIL.PICK_LABEL_NO, PICK_ITEM_DETAIL.SSN_ID, PICK_ITEM_DETAIL.PICK_DETAIL_ID,
               PICK_ITEM.PICK_ORDER, PICK_ITEM.PICK_LINE_STATUS, 
               PICK_LOCATION.PICK_LOCATION_STATUS, PICK_LOCATION.RECORD_ID, PICK_LOCATION.LOCN_ID, PICK_LOCATION.WH_ID
        FROM PICK_ITEM_DETAIL
        JOIN PICK_ITEM ON PICK_ITEM.PICK_LABEL_NO = PICK_ITEM_DETAIL.PICK_LABEL_NO
        LEFT OUTER JOIN PICK_LOCATION ON PICK_LOCATION.PICK_ORDER = PICK_ITEM.PICK_ORDER AND PICK_LOCATION.PICK_LOCATION_STATUS IN ('OP','DS')
        WHERE PICK_ITEM_DETAIL.DEVICE_ID = 'C1' AND 
              PICK_ITEM_DETAIL.PICK_DETAIL_STATUS = 'PL' AND
              PICK_ITEM_DETAIL.QTY_PICKED > 0 AND
              PICK_ITEM_DETAIL.DESPATCH_LOCATION IS NULL
        INTO :WK_PID_LABEL_NO, :WK_PID_SSN_ID, :WK_PID_DETAIL_ID,
             :WK_PI_PICK_ORDER, :WK_PI_STATUS,
             :WK_PL_STATUS, :WK_PL_RECORD_ID, :WK_PL_LOCN_ID, :WK_PL_WH_ID
   DO
   BEGIN
      IF (WK_PL_RECORD_ID IS NULL) THEN
      BEGIN
         /* need to use a free location  and put into the wk-pl_locn_id */
         SELECT FIRST 1  L1.WH_ID, L1.LOCN_ID    
         FROM  LOCATION L1   
         LEFT OUTER JOIN PICK_LOCATION PL ON L1.WH_ID = PL.WH_ID AND L1.LOCN_ID = PL.LOCN_ID AND PL.PICK_LOCATION_STATUS IN ('OP','DS')   
         WHERE L1.MOVEABLE_LOCN = 'T' 
         AND   PL.RECORD_ID IS NULL 
         ORDER  BY L1.WH_ID, L1.LOCN_ID DESC 
         INTO :WK_PL_WH_ID, WK_PL_LOCN_ID;
         /* do a poal for it */
           EXECUTE PROCEDURE ADD_TRAN(
                    :WK_PL_WH_ID,
                    :WK_PL_LOCN_ID,
                    :WK_PI_PICK_ORDER,
                    'POAL',
                    'O',
                    'NOW',
                    'BDCS|C1|add location for no despatch ',
                    0,
                    'F',
                    '',
                    'MASTER',
                    0,
                    'T1',
                    'SSSSSSSSS',
                    'BDCS',
                    'C1');
         UPDATE PICK_ITEM_DETAIL
         SET DESPATCH_LOCATION = :WK_PL_LOCN_ID
         WHERE PICK_DETAIL_ID = :WK_PID_DETAIL_ID;
         UPDATE ISSN SET WH_ID = :WK_PL_WH_ID, LOCN_ID = :WK_PL_LOCN_ID
         WHERE SSN_ID = :WK_PID_SSN_ID;
      END
   END
   FOR  SELECT PICK_ITEM_DETAIL.PICK_LABEL_NO, PICK_ITEM_DETAIL.SSN_ID, PICK_ITEM_DETAIL.PICK_DETAIL_ID,
               PICK_ITEM.PICK_ORDER, PICK_ITEM.PICK_LINE_STATUS, 
               PICK_LOCATION.PICK_LOCATION_STATUS, PICK_LOCATION.RECORD_ID, PICK_LOCATION.LOCN_ID, PICK_LOCATION.WH_ID
        FROM PICK_ITEM_DETAIL
        JOIN PICK_ITEM ON PICK_ITEM.PICK_LABEL_NO = PICK_ITEM_DETAIL.PICK_LABEL_NO
        LEFT OUTER JOIN PICK_LOCATION ON PICK_LOCATION.PICK_ORDER = PICK_ITEM.PICK_ORDER AND PICK_LOCATION.PICK_LOCATION_STATUS IN ('OP','DS')
        WHERE PICK_ITEM_DETAIL.DEVICE_ID = 'CE' AND 
              PICK_ITEM_DETAIL.PICK_DETAIL_STATUS = 'PL' AND
              PICK_ITEM_DETAIL.QTY_PICKED > 0 AND
              PICK_ITEM_DETAIL.DESPATCH_LOCATION IS NULL
        INTO :WK_PID_LABEL_NO, :WK_PID_SSN_ID, :WK_PID_DETAIL_ID,
             :WK_PI_PICK_ORDER, :WK_PI_STATUS,
             :WK_PL_STATUS, :WK_PL_RECORD_ID, :WK_PL_LOCN_ID, :WK_PL_WH_ID
   DO
   BEGIN
      IF (WK_PL_RECORD_ID IS NULL) THEN
      BEGIN
         /* need to use a free location  and put into the wk-pl_locn_id */
         SELECT FIRST 1  L1.WH_ID, L1.LOCN_ID    
         FROM  LOCATION L1   
         LEFT OUTER JOIN PICK_LOCATION PL ON L1.WH_ID = PL.WH_ID AND L1.LOCN_ID = PL.LOCN_ID AND PL.PICK_LOCATION_STATUS IN ('OP','DS')   
         WHERE L1.MOVEABLE_LOCN = 'T' 
         AND   PL.RECORD_ID IS NULL 
         ORDER  BY L1.WH_ID, L1.LOCN_ID DESC 
         INTO :WK_PL_WH_ID, WK_PL_LOCN_ID;
         /* do a poal for it */
           EXECUTE PROCEDURE ADD_TRAN(
                    :WK_PL_WH_ID,
                    :WK_PL_LOCN_ID,
                    :WK_PI_PICK_ORDER,
                    'POAL',
                    'O',
                    'NOW',
                    'BDCS|CE|add location for no despatch ',
                    0,
                    'F',
                    '',
                    'MASTER',
                    0,
                    'T1',
                    'SSSSSSSSS',
                    'BDCS',
                    'CE');
         UPDATE PICK_ITEM_DETAIL
         SET DESPATCH_LOCATION = :WK_PL_LOCN_ID
         WHERE PICK_DETAIL_ID = :WK_PID_DETAIL_ID;
         UPDATE ISSN SET WH_ID = :WK_PL_WH_ID, LOCN_ID = :WK_PL_LOCN_ID
         WHERE SSN_ID = :WK_PID_SSN_ID;
      END
   END
   UPDATE ISSN SET WH_ID='XX',LOCN_ID='00000000' WHERE WH_ID = 'SY' and ISSN_STATUS='ST' AND CURRENT_QTY = 0;
   UPDATE ISSN SET WH_ID='RZ',LOCN_ID='RC010000' WHERE WH_ID = 'SY' and ISSN_STATUS='ST' AND CURRENT_QTY > 0;
   UPDATE ISSN SET WH_ID='XX',LOCN_ID='00000000' WHERE WH_ID = 'SY' and ISSN_STATUS='PA' AND CURRENT_QTY = 0;
   UPDATE ISSN SET WH_ID='RZ',LOCN_ID='RC010000' WHERE WH_ID = 'SY' and ISSN_STATUS='PA' AND CURRENT_QTY > 0;
   UPDATE ISSN SET WH_ID='XD',LOCN_ID='00000000' WHERE WH_ID = 'SY' and ISSN_STATUS='DX' ;
   UPDATE ISSN SET WH_ID='XD',LOCN_ID='00000000' WHERE WH_ID = 'RZ' and ISSN_STATUS='DX' ;
   UPDATE ISSN SET WH_ID='XX',LOCN_ID='00000000' WHERE WH_ID = 'RZ' and ISSN_STATUS='PA' AND CURRENT_QTY = 0;
   UPDATE ISSN SET WH_ID='XX',LOCN_ID='00000000' WHERE WH_ID = 'RZ' and ISSN_STATUS='ST' AND CURRENT_QTY = 0;
/* unpick CN status pick_location */
/*
   FOR SELECT P1.PICK_ORDER,P3.DEVICE_ID
      FROM PICK_ORDER P1
      JOIN PICK_ITEM P2 ON  P2.PICK_ORDER = P1.PICK_ORDER
      JOIN PICK_ITEM_DETAIL P3 ON P3.PICK_LABEL_NO = P2.PICK_LABEL_NO
      JOIN ISSN I1 ON I1.SSN_ID=P3.SSN_ID
      JOIN PICK_LOCATION P4 ON P4.PICK_ORDER = P1.PICK_ORDER
      JOIN CONTROL C1 ON C1.RECORD_ID = 1
      WHERE  P1.PICK_STATUS IN ('OP','DA')
      AND    P2.PICK_LINE_STATUS IN  ('PL')
      AND P3.PICK_DETAIL_STATUS  IN ('PL')
      AND ( I1.WH_ID<>C1.DEFAULT_WH_ID )
      AND P4.PICK_LOCATION_STATUS = 'CN'
      GROUP BY   P1.PICK_ORDER,P3.DEVICE_ID
      INTO :WK_PO_ORDER,:WK_PID_DEVICE_ID
   DO
   BEGIN
           EXECUTE PROCEDURE ADD_TRAN(
                    '  ',
                    '        ',
                    :WK_PO_ORDER,
                    'PKCO',
                    'D',
                    'NOW',
                    'UNPICK FOR UNALLOCATE ON DEVICE',
                    0,
                    'F',
                    '',
                    'MASTER',
                    0,
                    '          ',
                    'SSSSSSSSS',
                    'BDCS',
                    :WK_PID_DEVICE_ID);
   END
*/

   FOR SELECT P1.PICK_ORDER ,
       P2.PICK_LABEL_NO ,P3.SSN_ID ,(P2.PICK_ORDER_QTY - COALESCE(P2.PICKED_QTY,0)),P3.DEVICE_ID  ,P4.LOCN_ID ,P4.RECORD_ID, ISSN.LOCN_ID 
       FROM PICK_ORDER P1 
       JOIN PICK_ITEM P2 ON P1.PICK_ORDER=P2.PICK_ORDER AND P2.PICK_LINE_STATUS NOT IN ('DX','DI','DC')
       LEFT OUTER JOIN PICK_ITEM_DETAIL P3 ON P2.PICK_LABEL_NO = P3.PICK_LABEL_NO AND  
            P3.PICK_DETAIL_STATUS NOT IN ('XX','CN') AND  P3.QTY_PICKED > 0
       LEFT OUTER JOIN PICK_LOCATION P4 ON  P1.PICK_ORDER = P4.PICK_ORDER AND P4.PICK_LOCATION_STATUS IN ('OP','DS')
       LEFT OUTER JOIN ISSN ON P3.SSN_ID = ISSN.SSN_ID
       WHERE (P1.PICK_STATUS  IN ('DA','OP'))
       AND P4.RECORD_ID IS NULL AND P2.PICK_LINE_STATUS='PL' AND P3.PICK_DETAIL_STATUS='PL'
       AND P1.CREATE_DATE < 'TODAY'
        INTO :WK_PI_PICK_ORDER, :WK_PI_LABEL_NO, :WK_PID_SSN_ID, :WK_PI_QTY_TOPICK, :WK_PID_DEVICE_ID, :WK_PL_LOCN_ID, :WK_PL_RECORD_ID , :WK_IS_LOCN_ID 
   DO
   BEGIN
      IF (WK_PL_RECORD_ID IS NULL) THEN
      BEGIN
         /* need to use a free location  and put into the wk-pl_locn_id */
         SELECT FIRST 1  L1.WH_ID, L1.LOCN_ID    
         FROM  LOCATION L1   
         LEFT OUTER JOIN PICK_LOCATION PL ON L1.WH_ID = PL.WH_ID AND L1.LOCN_ID = PL.LOCN_ID AND PL.PICK_LOCATION_STATUS IN ('OP','DS')   
         WHERE L1.MOVEABLE_LOCN = 'T' 
         AND   PL.RECORD_ID IS NULL 
         ORDER  BY L1.WH_ID, L1.LOCN_ID DESC 
         INTO :WK_PL_WH_ID, WK_PL_LOCN_ID;
         /* do a poal for it */
           WK_REFERENCE = 'BDCS|' || :WK_PID_DEVICE_ID || '|add location for device';
           EXECUTE PROCEDURE ADD_TRAN(
                    :WK_PL_WH_ID,
                    :WK_PL_LOCN_ID,
                    :WK_PI_PICK_ORDER,
                    'POAL',
                    'O',
                    'NOW',
                    WK_REFERENCE ,
                    0,
                    'F',
                    '',
                    'MASTER',
                    0,
                    'T1',
                    'SSSSSSSSS',
                    'BDCS',
                    :WK_PID_DEVICE_ID);
         UPDATE PICK_ITEM_DETAIL
         SET DESPATCH_LOCATION = :WK_PL_LOCN_ID
         WHERE PICK_DETAIL_ID = :WK_PID_DETAIL_ID;
         UPDATE ISSN SET WH_ID = :WK_PL_WH_ID, LOCN_ID = :WK_PL_LOCN_ID
         WHERE SSN_ID = :WK_PID_SSN_ID;
      END
   END

/* look for issns not in the correct block */
   FOR SELECT I1.WH_ID ,
       I1.LOCN_ID,I1.SSN_ID, I1.CURRENT_QTY, I1.ISSN_STATUS, 
       P3.DEVICE_ID,P3.PICK_DETAIL_STATUS , P3.PICK_ORDER, 
       P4.LOCN_ID , P4.WH_ID, P4.RECORD_ID
       FROM ISSN I1
       JOIN LOCATION L1 ON I1.WH_ID=L1.WH_ID AND I1.LOCN_ID = L1.LOCN_ID
       JOIN PICK_ITEM_DETAIL P3 ON P3.SSN_ID = I1.SSN_ID  AND P3.QTY_PICKED > 0 AND (PICK_DETAIL_STATUS NOT IN ('XX','CN','DX'))
       JOIN PICK_LOCATION P4 ON P3.PICK_ORDER = P4.PICK_ORDER AND P4.PICK_LOCATION_STATUS IN ('OP','DS')
       WHERE L1.MOVEABLE_LOCN = 'T'
    INTO :WK_IS_WH_ID, :WK_IS_LOCN_ID, :WK_IS_SSN_ID, :WK_IS_QTY, :WK_IS_STATUS,
         :WK_PID_DEVICE_ID, :WK_PID_STATUS, :WK_PID_PICK_ORDER,
         :WK_PL_LOCN_ID, :WK_PL_WH_ID, :WK_PL_RECORD_ID
   DO
   BEGIN
      IF (WK_PL_RECORD_ID IS NOT NULL) THEN
      BEGIN
         UPDATE ISSN SET WH_ID = :WK_PL_WH_ID, LOCN_ID = :WK_PL_LOCN_ID
         WHERE SSN_ID = :WK_IS_SSN_ID;
      END
   END

END ^

ALTER PROCEDURE PRN_REQUEST_ARCHIVE AS 
BEGIN
  
  /* Add record to PRN_REQUESTS_ARCHIVE table first */

  INSERT INTO PRINT_REQUESTS_ARCHIVE 
     (MESSAGE_ID, DEVICE_ID, PRN_TYPE, PRN_COPY, BASE_FILE_NAME, PRN_DATA, 
      PRN_DATE, PERSON_ID, REQUEST_STATUS,  ERROR_TEXT, SEND_COPY )
       
  SELECT MESSAGE_ID, DEVICE_ID, PRN_TYPE, PRN_COPY, BASE_FILE_NAME, PRN_DATA, 
      PRN_DATE, PERSON_ID, REQUEST_STATUS,  ERROR_TEXT , SEND_COPY
  FROM PRINT_REQUESTS
  WHERE REQUEST_STATUS = 'XP'
     OR REQUEST_STATUS STARTING 'E';
  
  /* Delete records from PRINT_REQUESTS table with COMPLETE is True */
  DELETE FROM PRINT_REQUESTS
  WHERE REQUEST_STATUS = 'XP'
     OR REQUEST_STATUS STARTING 'E';
  
END ^

ALTER PROCEDURE PRN_REQUEST_CP_STOP AS 
BEGIN
  /* Send event to stop the CP processing */
  POST_EVENT 'PRN_REQUEST_CP_END'; 
END ^

ALTER PROCEDURE PRN_REQUEST_NP_STOP AS 
BEGIN
  /* Send event to stop the NP processing */
  POST_EVENT 'PRN_REQUEST_NP_END'; 
END ^

ALTER PROCEDURE PROCESS_TEST_RESULTS (CATEGORY VARCHAR(1) CHARACTER SET NONE,
SSNID VARCHAR(20) CHARACTER SET NONE)
AS 
 
 
 DECLARE VARIABLE STRPASSCRITERIA VARCHAR(6);
 DECLARE VARIABLE STRPASSFAIL VARCHAR(6);
 DECLARE VARIABLE INTTESTID INTEGER;
 DECLARE VARIABLE PROCESS_PASSED VARCHAR(20);
 DECLARE VARIABLE PROCESS_FAILED VARCHAR(20);
 DECLARE VARIABLE STRRESPONSE VARCHAR(50);
 DECLARE VARIABLE STRTEXTRESPONSE VARCHAR(30);
 DECLARE VARIABLE NUMNUMRESPONSE FLOAT;
 DECLARE VARIABLE DATEDATERESPONSE TIMESTAMP;
 DECLARE VARIABLE NUMFIELDTYPE INTEGER;
 DECLARE VARIABLE STRRESULT CHAR(1);
 DECLARE VARIABLE WK_QUESTION INTEGER;
 DECLARE VARIABLE WKORIGINAL VARCHAR(1);
 DECLARE VARIABLE WK_TEST_EXISTS INTEGER;
 DECLARE VARIABLE WK_TEST_ID INTEGER;
 DECLARE VARIABLE WKTESTID  INTEGER;
 DECLARE VARIABLE WKTESTID2  INTEGER;
 DECLARE VARIABLE WK_WHEN  TIMESTAMP;
 DECLARE VARIABLE STRDESC VARCHAR(30);
 DECLARE VARIABLE WK_DUMMY CHAR(1);
 DECLARE VARIABLE WK_FAIL_STATUS VARCHAR(2);
 DECLARE VARIABLE WK_HAVE_FAIL VARCHAR(2);
 DECLARE VARIABLE WK_ALLOWED_STATUS VARCHAR(40);
DECLARE VARIABLE WK_DO_UASL CHAR(1);
 DECLARE VARIABLE WK_TEST_PROD VARCHAR(30);
BEGIN
  STRPASSFAIL = 'PASSED';
  /* REMOVE THIS SSN FROM THE INCOMLETE TEST LIST */
     DELETE FROM RESUME_TEST WHERE SSN_ID = :SSNID;

     PROCESS_PASSED = ',';
     PROCESS_FAILED = ',';
     WKTESTID = -1;
     /* AND INSPECT_CATEGORY = :CATEGORY */
     FOR SELECT
          INSPECT_PASS_CRITERIA,
          SSN_TEST_ID,
          RESPONSE,
          TEXT_RESPONSE,
          NUMBER_RESPONSE,
          DATE_RESPONSE,
          FIELD_TYPE,
          ORIGINAL_TEST,
          TEST_ID,
          TIME_STAMP,
          INSPECT_CATEGORY
          FROM
          SSN_TEST_RESULTS
          WHERE
          SSN_ID = :SSNID
          AND PROCESSED = 'O'
          ORDER BY  INSPECT_CATEGORY 
        INTO
          :STRPASSCRITERIA, 
          :INTTESTID, 
          :STRRESPONSE, 
          :STRTEXTRESPONSE, 
          :NUMNUMRESPONSE, 
          :DATEDATERESPONSE, 
          :NUMFIELDTYPE , 
          :WKORIGINAL, 
          :WKTESTID2, 
          :WK_WHEN,
          :CATEGORY
     DO 
     BEGIN
        IF (WKTESTID = -1) THEN
        BEGIN
          WK_TEST_EXISTS = 0;
          SELECT 1, TEST_ID FROM SSN_TEST
              WHERE SSN_ID = :SSNID AND
                    STATUS_TEST = 'OP'
              INTO :WK_TEST_EXISTS, :WK_TEST_ID;
          IF (WK_TEST_EXISTS = 0) THEN
          BEGIN
              DELETE FROM PRODUCT_COND_STATUS 
              WHERE SSN_ID = :SSNID
              AND ORIGINAL_TEST = 'S';
              /* MUST GET THE NEXT TEST ID */
              WK_TEST_ID = GEN_ID(TEST_ID, 1);
              INSERT INTO SSN_TEST(TEST_ID, SSN_ID, START_DATE, STATUS_TEST)
                     VALUES (:WK_TEST_ID, :SSNID, :WK_WHEN, 'OP');
          END 
          WKTESTID = WK_TEST_ID;
        END 
/*
        IF (NUMFIELDTYPE = 1) THEN
        BEGIN
  -* MEMO TYPE *-
        END
*/
        IF (NUMFIELDTYPE = 2) THEN
        BEGIN
  /* NUMBER TYPE */
  STRRESPONSE = NUMNUMRESPONSE;
        END
        IF (NUMFIELDTYPE = 3) THEN
        BEGIN
  /* DATE TYPE */
  STRRESPONSE = CAST(:DATEDATERESPONSE AS CHAR(22));
        END
        IF (NUMFIELDTYPE = 4) THEN
        BEGIN
  /* TEXT TYPE */
  STRRESPONSE = STRTEXTRESPONSE;
        END

        IF (CATEGORY = 'E') THEN 
        BEGIN
              UPDATE SSN
              SET OTHER5 = :STRRESPONSE
              WHERE SSN_ID = :SSNID;
        END
        ELSE
        BEGIN
            IF (STRPASSCRITERIA = 'FAILED') THEN 
            BEGIN
                STRPASSFAIL = 'FAILED';
                IF (WKORIGINAL = 'O') THEN
                BEGIN
                    EXECUTE PROCEDURE ADD_PROD_COND_STATUS_TEST :SSNID, :CATEGORY, :STRRESPONSE, 'S' 
                      RETURNING_VALUES :STRRESULT;
                END
                EXECUTE PROCEDURE ADD_PROD_COND_STATUS_TEST :SSNID, :CATEGORY, :STRRESPONSE, :WKORIGINAL 
                  RETURNING_VALUES :STRRESULT;
                /* FOUND AT LEAST ON RECORD */
                IF (POS(PROCESS_FAILED, CATEGORY, 0, 1) > -1) THEN
                BEGIN
                   /* already have a fail for this category */ 
                   WK_DUMMY = '';
                END
                ELSE
                BEGIN
                   /* category not in there yet so add it */
                   PROCESS_FAILED = PROCESS_FAILED || CATEGORY || ',';
                END
            END
            ELSE
            BEGIN
                IF (STRPASSCRITERIA = 'PASSED') THEN 
                BEGIN
                    /* FOUND AT LEAST ON RECORD */
                    IF (POS(PROCESS_PASSED, CATEGORY, 0, 1) > -1) THEN
                    BEGIN
                       /* already have a pass for this category */ 
                       WK_DUMMY = '';
                    END
                    ELSE
                    BEGIN
                       /* category not in there yet so add it */
                       PROCESS_PASSED = PROCESS_PASSED || CATEGORY || ',';
                    END
                END
            END
        END
          
        UPDATE SSN_TEST_RESULTS SET PROCESSED = 'P', TEST_ID = :WKTESTID
        WHERE SSN_TEST_ID = :INTTESTID;
        /* WKTESTID = -1; */
     END
     
     WK_HAVE_FAIL = 'F';
     IF (POS(PROCESS_FAILED, 'A', 0, 1) > -1) THEN
     BEGIN
        /* have a failure */
        EXECUTE PROCEDURE GET_GLOBAL_CONDITION 1, 'F' RETURNING_VALUES :STRDESC;
        UPDATE SSN
        /*SET OTHER1 = 'NOT NEW CONDITION'*/
        SET OTHER1 = :STRDESC
        WHERE SSN_ID = :SSNID;
        WK_HAVE_FAIL = 'T';
     END
     ELSE
     BEGIN
        IF (POS(PROCESS_PASSED, 'A', 0, 1) > -1) THEN
        BEGIN
           /* all passed */
           EXECUTE PROCEDURE GET_GLOBAL_CONDITION 1, 'P' RETURNING_VALUES :STRDESC;
           UPDATE SSN
           /*SET OTHER1 = 'AS NEW CONDITION'*/
           SET OTHER1 = :STRDESC
           WHERE SSN_ID = :SSNID;
        END
     END
     IF (POS(PROCESS_FAILED, 'B', 0, 1) > -1) THEN
     BEGIN
        /* have a failure */
        EXECUTE PROCEDURE GET_GLOBAL_CONDITION 2, 'F' RETURNING_VALUES :STRDESC;
        UPDATE SSN
        /*SET OTHER2 = 'TESTED - FAULTY'*/
        SET OTHER2 = :STRDESC
        WHERE SSN_ID = :SSNID;
        WK_HAVE_FAIL = 'T';
     END
     ELSE
     BEGIN
        IF (POS(PROCESS_PASSED, 'B', 0, 1) > -1) THEN
        BEGIN
           /* all passed */
           EXECUTE PROCEDURE GET_GLOBAL_CONDITION 2, 'P' RETURNING_VALUES :STRDESC;
           UPDATE SSN
           /*SET OTHER2 = 'TESTED - OK'*/
           SET OTHER2 = :STRDESC
           WHERE SSN_ID = :SSNID;
        END
     END
     IF (POS(PROCESS_FAILED, 'C', 0, 1) > -1) THEN
     BEGIN
        /* have a failure */
        EXECUTE PROCEDURE GET_GLOBAL_CONDITION 3, 'F' RETURNING_VALUES :STRDESC;
        UPDATE SSN
        /*SET OTHER3 = 'INCOMPLETE'*/
        SET OTHER3 = :STRDESC
        WHERE SSN_ID = :SSNID;
        WK_HAVE_FAIL = 'T';
     END
     ELSE
     BEGIN
        IF (POS(PROCESS_PASSED, 'C', 0, 1) > -1) THEN
        BEGIN
           /* all passed */
           EXECUTE PROCEDURE GET_GLOBAL_CONDITION 3, 'P' RETURNING_VALUES :STRDESC;
           UPDATE SSN
           /*SET OTHER3 = 'COMPLETE'*/
           SET OTHER3 = :STRDESC
           WHERE SSN_ID = :SSNID;
        END
     END
     IF (POS(PROCESS_FAILED, 'D', 0, 1) > -1) THEN
     BEGIN
        /* have a failure */
        EXECUTE PROCEDURE GET_GLOBAL_CONDITION 4, 'F' RETURNING_VALUES :STRDESC;
        UPDATE SSN
        /*SET OTHER4 = 'SERVICE PROVIDED'*/
        SET OTHER4 = :STRDESC
        WHERE SSN_ID = :SSNID;
        WK_HAVE_FAIL = 'T';
     END
     ELSE
     BEGIN
        IF (POS(PROCESS_PASSED, 'D', 0, 1) > -1) THEN
        BEGIN
           /* all passed */
           EXECUTE PROCEDURE GET_GLOBAL_CONDITION 4, 'P' RETURNING_VALUES :STRDESC;
           UPDATE SSN
           /*SET OTHER4 = 'NO SERVICE'*/
           SET OTHER4 = :STRDESC
           WHERE SSN_ID = :SSNID;
        END
     END
     /* MUST UPDATE PASSED SSN ANSWER_ID = NULL
     QUESTION_ID = SEQUENCE 0 QUESTION FOR TYPE
     */
     /* GET SEQ 0 QUESTION */
     SELECT TQ.QUESTION_ID
     FROM SSN SN 
     JOIN TEST_QUESTIONS TQ ON TQ.SSN_TYPE = SN.SSN_TYPE
     WHERE SN.SSN_ID = :SSNID
     AND TQ.SEQUENCE = 0
     INTO :WK_QUESTION;
     IF ( WK_HAVE_FAIL = 'F') THEN
     BEGIN
        UPDATE SSN SET ANSWER_ID = NULL,QUESTION_ID=:WK_QUESTION, STATUS_SSN ='PA' WHERE SSN_ID = :SSNID;
        /* UPDATE ISSN SET ISSN_STATUS ='PA' WHERE SSN_ID = :SSNID; */
        /* UPDATE ISSN SET ISSN_STATUS ='PA' WHERE ORIGINAL_SSN = :SSNID; */
        SELECT TEST_FROM_ALLOWED_SSN_STATUS,
               SEND_UASL_V4 
        FROM CONTROL 
        INTO :WK_ALLOWED_STATUS,
             :WK_DO_UASL;
        UPDATE ISSN SET ISSN_STATUS = 'PA' 
        WHERE ORIGINAL_SSN = :SSNID
        AND (WH_ID < 'X' OR WH_ID > 'X~') 
        AND (POS(:WK_ALLOWED_STATUS,ISSN.ISSN_STATUS,0,1) > -1);
 /* cannot update issns in 'X' wh_ids 
           or status starting 'Q' 'D' 'A' 'X' 
                     'P' (except 'PA')
        */
        IF (WK_DO_UASL = 'T') THEN
        BEGIN
           WK_TEST_PROD = '';
           SELECT PROD_ID FROM ISSN WHERE SSN_ID = :SSNID
           INTO :WK_TEST_PROD;
           IF (WK_TEST_PROD IS NOT NULL) THEN
           BEGIN
              EXECUTE PROCEDURE SEND_PICKABLE_STOCK (:WK_TEST_PROD,
                 'BDCS',
                 'XX',
                 'NOW');
           END
        END
     END
     ELSE
     BEGIN
        SELECT TEST_FAIL_STATUS FROM CONTROL INTO :WK_FAIL_STATUS;
        UPDATE SSN SET ANSWER_ID = NULL,QUESTION_ID=:WK_QUESTION, STATUS_SSN =:WK_FAIL_STATUS WHERE SSN_ID = :SSNID;
        /* UPDATE ISSN SET ISSN_STATUS =:WK_FAIL_STATUS WHERE SSN_ID = :SSNID; */
        SELECT TEST_FROM_ALLOWED_SSN_STATUS 
        FROM CONTROL 
        INTO :WK_ALLOWED_STATUS;
        UPDATE ISSN SET ISSN_STATUS = :WK_FAIL_STATUS 
        WHERE ORIGINAL_SSN = :SSNID
        AND (WH_ID < 'X' OR WH_ID > 'X~') 
        AND (POS(:WK_ALLOWED_STATUS,ISSN.ISSN_STATUS,0,1) > -1);
 /* cannot update issns in 'X' wh_ids 
           or status starting 'Q' 'D' 'A' 'X' 
                     'P' (except 'PA')
        */
     END
     UPDATE SSN_TEST SET STATUS_TEST = 'CL',END_DATE='NOW' 
     WHERE SSN_ID=:SSNID AND STATUS_TEST = 'OP';

END ^

ALTER PROCEDURE PRODUCT_COMPANY_GRN_STOCK (PROD_ID VARCHAR(30) CHARACTER SET NONE,
COMPANY_IDS VARCHAR(1100) CHARACTER SET NONE,
USER_ID VARCHAR(10) CHARACTER SET NONE)
RETURNS (WH_ID CHAR(2) CHARACTER SET NONE,
COMPANY_ID VARCHAR(20) CHARACTER SET NONE,
SUPPLIER_ID VARCHAR(10) CHARACTER SET NONE,
SSN_TYPE VARCHAR(40) CHARACTER SET NONE,
GENERIC VARCHAR(40) CHARACTER SET NONE,
BRAND VARCHAR(40) CHARACTER SET NONE,
RECEIVE_DATE TIMESTAMP,
AVAILABLE_QTY INTEGER)
AS 
DECLARE VARIABLE IMPORTSTATUS VARCHAR(40);
DECLARE VARIABLE WK_ORDER_QTY INTEGER;
DECLARE VARIABLE WK_PICKED_QTY INTEGER;
DECLARE VARIABLE WK_CURRENT_QTY INTEGER;
DECLARE VARIABLE WK_CURRENT_SSN VARCHAR(20);
DECLARE VARIABLE WK_SYS_COMPANY VARCHAR(20);
DECLARE VARIABLE WK_USER_COMPANY VARCHAR(20);
DECLARE VARIABLE WK_USER_ADMIN CHAR(1);
DECLARE VARIABLE WK_USER_INVENTORY_OP CHAR(1);
DECLARE VARIABLE WK_CURRENT_WH CHAR(2);
DECLARE VARIABLE WK_CURRENT_COMPANY VARCHAR(20);
BEGIN

/*Frank Leih 10 OCT 2007
I have made the company_id a '|' or ';' or ',' delimited set of selected company's
if the company_id is null -> use all available for that user
most sites have say 10 or 20 wh's
but allow for 100
*/

   SELECT CONTROL.PICK_IMPORT_SSN_STATUS,
   CONTROL.COMPANY_ID
   FROM CONTROL
   INTO :IMPORTSTATUS,
        :WK_SYS_COMPANY;

   SELECT SYS_ADMIN, COMPANY_ID, INVENTORY_OPERATOR
   FROM SYS_USER
   WHERE USER_ID = :USER_ID
   INTO :WK_USER_ADMIN,
   :WK_USER_COMPANY,
   :WK_USER_INVENTORY_OP;
 
   IF (WK_USER_ADMIN IS NULL) THEN
   BEGIN
      WK_USER_ADMIN = 'F';
   END
   IF (WK_USER_INVENTORY_OP IS NULL) THEN
   BEGIN
      WK_USER_INVENTORY_OP = 'F';
   END

   IF (COMPANY_IDS IS NULL) THEN
   BEGIN
      COMPANY_IDS = '';
   END
   IF (COMPANY_IDS = '') THEN
   BEGIN
      IF ((WK_USER_ADMIN = 'T') OR (WK_USER_INVENTORY_OP = 'T')) THEN
      BEGIN
         FOR SELECT COMPANY_ID FROM COMPANY INTO :WK_CURRENT_COMPANY
         DO
         BEGIN
            COMPANY_IDS = COMPANY_IDS || '|' || :WK_CURRENT_COMPANY;
         END
      END
      ELSE
      BEGIN
         FOR SELECT COMPANY_ID FROM ACCESS_COMPANY WHERE USER_ID = :USER_ID INTO :WK_CURRENT_COMPANY
         DO
         BEGIN
            COMPANY_IDS = COMPANY_IDS || '|' || :WK_CURRENT_COMPANY;
         END
      END
   END

   FOR SELECT SUM( ISSN.CURRENT_QTY ), ISSN.COMPANY_ID, ISSN.WH_ID, SSN.SSN_TYPE, SSN.GENERIC, SSN.BRAND , ZEROTIME(GRN.GRN_DATE), GRN.RETURN_ID
           FROM ISSN
           JOIN SSN ON SSN.SSN_ID = ISSN.ORIGINAL_SSN 
           LEFT OUTER JOIN GRN ON GRN.GRN = SSN.GRN 
           WHERE ISSN.PROD_ID = :PROD_ID
           AND (POS(:COMPANY_IDS,ISSN.COMPANY_ID,0,1) > -1)
           AND (POS(:IMPORTSTATUS,ISSN.ISSN_STATUS,0,1) > -1)
           GROUP BY ISSN.WH_ID, ISSN.COMPANY_ID, GRN.RETURN_ID, ZEROTIME(GRN.GRN_DATE), SSN.SSN_TYPE, SSN.GENERIC, SSN.BRAND 
        INTO :AVAILABLE_QTY, :COMPANY_ID, :WH_ID, :SSN_TYPE, :GENERIC, :BRAND, :RECEIVE_DATE, :SUPPLIER_ID
   DO
   BEGIN
       IF (AVAILABLE_QTY IS NULL) THEN
       BEGIN
            AVAILABLE_QTY = 0;
       END

       SUSPEND;
   END


END ^

ALTER PROCEDURE PRODUCT_COMPANY_STOCK (PROD_ID VARCHAR(30) CHARACTER SET NONE,
COMPANY_ID VARCHAR(20) CHARACTER SET NONE)
RETURNS (AVAILABLE_QTY INTEGER,
RESERVED_QTY INTEGER,
ONSITE_QTY INTEGER,
UNPICKED_ORDER_QTY INTEGER,
BACK_ORDER_QTY INTEGER,
CANCELLED_ORDER_QTY INTEGER,
TEST_QTY INTEGER)
AS 
 
 

DECLARE VARIABLE IMPORTSTATUS VARCHAR(40);
DECLARE VARIABLE RESERVEDSTATUS VARCHAR(40);
DECLARE VARIABLE UNPICKEDSTATUS VARCHAR(40);
DECLARE VARIABLE WK_ORDER_QTY INTEGER;
DECLARE VARIABLE WK_PICKED_QTY INTEGER;
BEGIN
   /*
    RETURNS ALL PRODUCTS THAT ARE AVAILABLE FOR PICKING
   */
   SELECT CONTROL.PICK_IMPORT_SSN_STATUS,
   CONTROL.PICK_RESERVED_SSN_STATUS,
   CONTROL.PICK_UNPICKED_ITEM_STATUS
   FROM CONTROL
   INTO :IMPORTSTATUS, 
        :RESERVEDSTATUS,
        :UNPICKEDSTATUS;
   
   SELECT SUM( ISSN.CURRENT_QTY ) 
           FROM ISSN
           WHERE ISSN.PROD_ID = :PROD_ID
           AND ISSN.COMPANY_ID = :COMPANY_ID
           AND (POS(:IMPORTSTATUS,ISSN.ISSN_STATUS,0,1) > -1)
           GROUP BY ISSN.PROD_ID
        INTO :AVAILABLE_QTY;
   
   SELECT SUM( ISSN.CURRENT_QTY ) 
           FROM ISSN
           WHERE ISSN.PROD_ID = :PROD_ID
           AND ISSN.COMPANY_ID = :COMPANY_ID
           AND (POS(:RESERVEDSTATUS,ISSN.ISSN_STATUS,0,1) > -1)
           GROUP BY ISSN.PROD_ID
        INTO :RESERVED_QTY;
   
   SELECT SUM( ISSN.CURRENT_QTY ) 
           FROM ISSN
           WHERE ISSN.PROD_ID = :PROD_ID
           AND ISSN.COMPANY_ID = :COMPANY_ID
           AND ISSN.ISSN_STATUS <> 'DX'
           AND ISSN.ISSN_STATUS <> 'DI'
           AND (ISSN.ISSN_STATUS < 'X' OR ISSN.ISSN_STATUS > 'X~')
           AND (ISSN.WH_ID < 'X' OR ISSN.WH_ID > 'X~')
           GROUP BY ISSN.PROD_ID
        INTO :ONSITE_QTY;
   
   WK_PICKED_QTY = 0;
   WK_ORDER_QTY = 0;
   SELECT SUM( PICK_ITEM.PICK_ORDER_QTY ), 
          SUM( PICK_ITEM.PICKED_QTY ) 
           FROM PICK_ITEM
           JOIN PICK_ORDER ON PICK_ORDER.PICK_ORDER = PICK_ITEM.PICK_ORDER
           WHERE PICK_ITEM.PROD_ID = :PROD_ID
           AND PICK_ORDER.COMPANY_ID = :COMPANY_ID
           AND (POS(:UNPICKEDSTATUS,PICK_ITEM.PICK_LINE_STATUS,0,1) > -1)
           GROUP BY PICK_ITEM.PROD_ID
        INTO :WK_ORDER_QTY, :WK_PICKED_QTY;
   IF (WK_ORDER_QTY IS NULL) THEN
   BEGIN
      WK_ORDER_QTY = 0;
   END
   IF (WK_PICKED_QTY IS NULL) THEN
   BEGIN
      WK_PICKED_QTY = 0;
   END
   UNPICKED_ORDER_QTY = WK_ORDER_QTY - WK_PICKED_QTY;
   WK_PICKED_QTY = 0;
   WK_ORDER_QTY = 0;
   SELECT SUM( PICK_ITEM.PICK_ORDER_QTY ), 
          SUM( PICK_ITEM.PICKED_QTY ) 
           FROM PICK_ITEM
           JOIN PICK_ORDER ON PICK_ORDER.PICK_ORDER = PICK_ITEM.PICK_ORDER
           WHERE PICK_ITEM.PROD_ID = :PROD_ID
           AND PICK_ORDER.COMPANY_ID = :COMPANY_ID
           AND PICK_ITEM.PICK_LINE_STATUS = 'HD'
           GROUP BY PICK_ITEM.PROD_ID
        INTO :WK_ORDER_QTY, :WK_PICKED_QTY;
   IF (WK_ORDER_QTY IS NULL) THEN
   BEGIN
      WK_ORDER_QTY = 0;
   END
   IF (WK_PICKED_QTY IS NULL) THEN
   BEGIN
      WK_PICKED_QTY = 0;
   END
   BACK_ORDER_QTY = WK_ORDER_QTY - WK_PICKED_QTY;
   WK_PICKED_QTY = 0;
   WK_ORDER_QTY = 0;
   SELECT SUM( PICK_ITEM.PICK_ORDER_QTY ), 
          SUM( PICK_ITEM.PICKED_QTY ) 
           FROM PICK_ITEM
           JOIN PICK_ORDER ON PICK_ORDER.PICK_ORDER = PICK_ITEM.PICK_ORDER
           WHERE PICK_ITEM.PROD_ID = :PROD_ID
           AND PICK_ORDER.COMPANY_ID = :COMPANY_ID
           AND PICK_ITEM.PICK_LINE_STATUS = 'CN'
           GROUP BY PICK_ITEM.PROD_ID
        INTO :WK_ORDER_QTY, :WK_PICKED_QTY;
   IF (WK_ORDER_QTY IS NULL) THEN
   BEGIN
      WK_ORDER_QTY = 0;
   END
   IF (WK_PICKED_QTY IS NULL) THEN
   BEGIN
      WK_PICKED_QTY = 0;
   END
   CANCELLED_ORDER_QTY = WK_ORDER_QTY - WK_PICKED_QTY;
        
   SELECT SUM( ISSN.CURRENT_QTY ) 
           FROM ISSN
           WHERE ISSN.PROD_ID = :PROD_ID
           AND ISSN.COMPANY_ID = :COMPANY_ID
           AND ISSN.ISSN_STATUS = 'TS'
           GROUP BY ISSN.PROD_ID
        INTO :TEST_QTY;
   
   SUSPEND;
END ^

ALTER PROCEDURE PRODUCT_COMPANY_WH_GRN_STOCK (PROD_ID VARCHAR(30) CHARACTER SET NONE,
COMPANY_IDS VARCHAR(1100) CHARACTER SET NONE,
WH_IDS VARCHAR(300) CHARACTER SET NONE,
USER_ID VARCHAR(10) CHARACTER SET NONE)
RETURNS (WH_ID CHAR(2) CHARACTER SET NONE,
COMPANY_ID VARCHAR(20) CHARACTER SET NONE,
SUPPLIER_ID VARCHAR(10) CHARACTER SET NONE,
SSN_TYPE VARCHAR(40) CHARACTER SET NONE,
GENERIC VARCHAR(40) CHARACTER SET NONE,
BRAND VARCHAR(40) CHARACTER SET NONE,
RECEIVE_DATE TIMESTAMP,
AVAILABLE_QTY INTEGER,
SSN_ID VARCHAR(20) CHARACTER SET NONE)
AS 
DECLARE VARIABLE IMPORTSTATUS VARCHAR(40);
DECLARE VARIABLE WK_ORDER_QTY INTEGER;
DECLARE VARIABLE WK_PICKED_QTY INTEGER;
DECLARE VARIABLE WK_CURRENT_QTY INTEGER;
DECLARE VARIABLE WK_CURRENT_SSN VARCHAR(20);
DECLARE VARIABLE WK_SYS_COMPANY VARCHAR(20);
DECLARE VARIABLE WK_USER_COMPANY VARCHAR(20);
DECLARE VARIABLE WK_USER_ADMIN CHAR(1);
DECLARE VARIABLE WK_USER_INVENTORY_OP CHAR(1);
DECLARE VARIABLE WK_CURRENT_WH CHAR(2);
DECLARE VARIABLE WK_CURRENT_COMPANY VARCHAR(20);
BEGIN

/*Frank Leih 10 OCT 2007
I have made the company_id a '|' or ';' or ',' delimited set of selected company's
if the company_id is null -> use all available for that user
most sites have say 10 or 20 wh's
but allow for 100
similarly for the wh_id's
*/

   SELECT CONTROL.PICK_IMPORT_SSN_STATUS,
   CONTROL.COMPANY_ID
   FROM CONTROL
   INTO :IMPORTSTATUS,
        :WK_SYS_COMPANY;

   SELECT SYS_ADMIN, COMPANY_ID, INVENTORY_OPERATOR
   FROM SYS_USER
   WHERE USER_ID = :USER_ID
   INTO :WK_USER_ADMIN,
   :WK_USER_COMPANY,
   :WK_USER_INVENTORY_OP;
 
   IF (WK_USER_ADMIN IS NULL) THEN
   BEGIN
      WK_USER_ADMIN = 'F';
   END
   IF (WK_USER_INVENTORY_OP IS NULL) THEN
   BEGIN
      WK_USER_INVENTORY_OP = 'F';
   END

   IF (WH_IDS IS NULL) THEN
   BEGIN
      WH_IDS = '';
   END
   IF (WH_IDS = '') THEN
   BEGIN
      IF (WK_USER_ADMIN = 'T') THEN
      BEGIN
         FOR SELECT WH_ID FROM WAREHOUSE INTO :WK_CURRENT_WH
         DO
         BEGIN
            WH_IDS = WH_IDS || '|' || :WK_CURRENT_WH;
         END
      END
      ELSE
      BEGIN
         FOR SELECT WH_ID FROM ACCESS_USER WHERE USER_ID = :USER_ID INTO :WK_CURRENT_WH
         DO
         BEGIN
            WH_IDS = WH_IDS || '|' || :WK_CURRENT_WH;
         END
      END
   END
   IF (COMPANY_IDS IS NULL) THEN
   BEGIN
      COMPANY_IDS = '';
   END
   IF (COMPANY_IDS = '') THEN
   BEGIN
      IF ((WK_USER_ADMIN = 'T') OR (WK_USER_INVENTORY_OP = 'T')) THEN
      BEGIN
         FOR SELECT COMPANY_ID FROM COMPANY INTO :WK_CURRENT_COMPANY
         DO
         BEGIN
            COMPANY_IDS = COMPANY_IDS || '|' || :WK_CURRENT_COMPANY;
         END
      END
      ELSE
      BEGIN
         FOR SELECT COMPANY_ID FROM ACCESS_COMPANY WHERE USER_ID = :USER_ID INTO :WK_CURRENT_COMPANY
         DO
         BEGIN
            COMPANY_IDS = COMPANY_IDS || '|' || :WK_CURRENT_COMPANY;
         END
      END
   END

   FOR SELECT  ISSN.CURRENT_QTY, ISSN.SSN_ID,  ISSN.COMPANY_ID, ISSN.WH_ID, SSN.SSN_TYPE, SSN.GENERIC, SSN.BRAND , GRN.GRN_DATE, GRN.RETURN_ID
           FROM ISSN
           JOIN SSN ON SSN.SSN_ID = ISSN.ORIGINAL_SSN 
           LEFT OUTER JOIN GRN ON GRN.GRN = SSN.GRN 
           WHERE ISSN.PROD_ID = :PROD_ID
           AND (POS(:WH_IDS,ISSN.WH_ID,0,1) > -1)
           AND (POS(:COMPANY_IDS,ISSN.COMPANY_ID,0,1) > -1)
           AND (POS(:IMPORTSTATUS,ISSN.ISSN_STATUS,0,1) > -1)
        INTO :AVAILABLE_QTY, :SSN_ID,  :COMPANY_ID, :WH_ID, :SSN_TYPE, :GENERIC, :BRAND, :RECEIVE_DATE, :SUPPLIER_ID
   DO
   BEGIN
       IF (AVAILABLE_QTY IS NULL) THEN
       BEGIN
            AVAILABLE_QTY = 0;
       END

       SUSPEND;
   END


END ^

ALTER PROCEDURE PRODUCT_COMPANY_WH_STOCK_STATUS (IN_PROD_ID VARCHAR(50) CHARACTER SET NONE,
COMPANY_ID VARCHAR(1100) CHARACTER SET NONE,
WH_ID VARCHAR(300) CHARACTER SET NONE,
USER_ID VARCHAR(10) CHARACTER SET NONE)
RETURNS (AVAILABLE_QTY INTEGER,
RESERVED_QTY INTEGER,
ONSITE_QTY INTEGER,
UNPICKED_ORDER_QTY INTEGER,
BACK_ORDER_QTY INTEGER,
CANCELLED_ORDER_QTY INTEGER,
PO_ON_ORDER_QTY INTEGER,
TEST_QTY INTEGER,
AVAILABLE1_QTY INTEGER,
AVAILABLE1_SSN VARCHAR(20) CHARACTER SET NONE,
AVAILABLE2_QTY INTEGER,
AVAILABLE2_SSN VARCHAR(20) CHARACTER SET NONE,
AVAILABLE3_QTY INTEGER,
AVAILABLE3_SSN VARCHAR(20) CHARACTER SET NONE,
PO_ON_ORDER1_NO VARCHAR(10) CHARACTER SET NONE,
PO_ON_ORDER1_QTY INTEGER,
PO_ON_ORDER1_DUE_DATE TIMESTAMP,
PROD_ID VARCHAR(30) CHARACTER SET NONE)
AS 
DECLARE VARIABLE IMPORTSTATUS VARCHAR(40);
DECLARE VARIABLE RESERVEDSTATUS VARCHAR(40);
DECLARE VARIABLE UNPICKEDSTATUS VARCHAR(40);
DECLARE VARIABLE WK_ORDER_QTY INTEGER;
DECLARE VARIABLE WK_PICKED_QTY INTEGER;
DECLARE VARIABLE WK_CURRENT_QTY INTEGER;
DECLARE VARIABLE WK_CURRENT_SSN VARCHAR(20);
DECLARE VARIABLE WK_COUNT INTEGER;
DECLARE VARIABLE WK_SYS_COMPANY VARCHAR(20);
DECLARE VARIABLE WK_USER_COMPANY VARCHAR(20);
DECLARE VARIABLE WK_USER_ADMIN CHAR(1);
DECLARE VARIABLE WK_USER_INVENTORY_OP CHAR(1);
DECLARE VARIABLE WK_CURRENT_WH CHAR(2);
DECLARE VARIABLE WK_CURRENT_COMPANY VARCHAR(20);
DECLARE VARIABLE WK_SYS_CONFIRM_NOPROD CHAR(1);
DECLARE VARIABLE WK_LOG_FILENAME VARCHAR(200);
DECLARE VARIABLE WK_LOG_RESULT   INTEGER;
BEGIN

/* DATE: 17TH JUN 2007
SUMEER SHOREE
THERE WERE A COUPLE OF ISSUES - ADDED WH_ID TO ALL THE QUERIES.
SECOND IMPROVEMENT IS WITH CHECKING OF NULLS FOR AVAILABLE QTY, RESERVED_QTY AND ONSITE_QTY
I WOULD HAVE LIKED TO USE THE LIKE OPERATOR FOR COMPANY_ID AND WH_ID
THAT WOULD HAVE ALLOWED A SITUATION WHERE WE WANT A REPORT FOR ALL COMPANIES BUT A SINGLE WAREHOUSE
OR MANY WAHREHOUSES FOR A SINGLE COMPANY.

 */
/*Frank Leih 06 OCT 2007
I have made the wh_id and company_id a '|' or ';' or ',' delimited set of selected wh's or company's
Glen wanted the first 3 qty's in order of qty for the available_qty
I called these available1_ssn ... ,available1_qty ...
also want to add user_id incase want all for that user
if the wh_id is null -> use all available for that user
most sites have say 10 or 20 wh's
but allow for 100
similarly for company_id
allow for 100
*/
   WK_LOG_FILENAME = '/tmp/productstock.log';
   WK_SYS_CONFIRM_NOPROD = 'F';
   SELECT CONTROL.PICK_IMPORT_SSN_STATUS,
   CONTROL.PICK_RESERVED_SSN_STATUS,
   CONTROL.PICK_UNPICKED_ITEM_STATUS,
   CONTROL.COMPANY_ID,
   CONTROL.CONFIRM_WITH_NO_PROD
   FROM CONTROL
   INTO :IMPORTSTATUS,
        :RESERVEDSTATUS,
        :UNPICKEDSTATUS,
        :WK_SYS_COMPANY,
        :WK_SYS_CONFIRM_NOPROD;
    IF (WK_SYS_CONFIRM_NOPROD IS NULL) THEN
    BEGIN
       WK_SYS_CONFIRM_NOPROD = 'F';
    END

   SELECT SYS_ADMIN, COMPANY_ID, INVENTORY_OPERATOR
   FROM SYS_USER
   WHERE USER_ID = :USER_ID
   INTO :WK_USER_ADMIN,
   :WK_USER_COMPANY,
   :WK_USER_INVENTORY_OP;
 
   IF (WK_USER_ADMIN IS NULL) THEN
   BEGIN
      WK_USER_ADMIN = 'F';
   END
   IF (WK_USER_INVENTORY_OP IS NULL) THEN
   BEGIN
      WK_USER_INVENTORY_OP = 'F';
   END

   IF (WH_ID IS NULL) THEN
   BEGIN
      WH_ID = '';
   END
   IF (WH_ID = '') THEN
   BEGIN
      IF (WK_USER_ADMIN = 'T') THEN
      BEGIN
         FOR SELECT WH_ID FROM WAREHOUSE INTO :WK_CURRENT_WH
         DO
         BEGIN
            WH_ID = WH_ID || '|' || :WK_CURRENT_WH;
         END
      END
      ELSE
      BEGIN
         FOR SELECT WH_ID FROM ACCESS_USER WHERE USER_ID = :USER_ID INTO :WK_CURRENT_WH
         DO
         BEGIN
            WH_ID = WH_ID || '|' || :WK_CURRENT_WH;
         END
      END
   END
   IF (COMPANY_ID IS NULL) THEN
   BEGIN
      COMPANY_ID = '';
   END
   IF (COMPANY_ID = '') THEN
   BEGIN
      IF ((WK_USER_ADMIN = 'T') OR (WK_USER_INVENTORY_OP = 'T')) THEN
      BEGIN
         FOR SELECT COMPANY_ID FROM COMPANY INTO :WK_CURRENT_COMPANY
         DO
         BEGIN
            COMPANY_ID = COMPANY_ID || '|' || :WK_CURRENT_COMPANY;
         END
      END
      ELSE
      BEGIN
         FOR SELECT COMPANY_ID FROM ACCESS_COMPANY WHERE USER_ID = :USER_ID INTO :WK_CURRENT_COMPANY
         DO
         BEGIN
            COMPANY_ID = COMPANY_ID || '|' || :WK_CURRENT_COMPANY;
         END
      END
   END

   /* PROD_ID = IN_PROD_ID; */
   FOR SELECT PROD_ID
       FROM PROD_PROFILE
       WHERE PROD_ID LIKE :IN_PROD_ID
             OR SHORT_DESC LIKE :IN_PROD_ID 
       INTO :PROD_ID
   DO
   BEGIN
      AVAILABLE_QTY = NULL; 
      RESERVED_QTY = NULL;
      ONSITE_QTY = NULL;
      UNPICKED_ORDER_QTY = NULL;
      BACK_ORDER_QTY = NULL;
      CANCELLED_ORDER_QTY = NULL;
      PO_ON_ORDER_QTY = NULL;
      TEST_QTY = NULL;
      PO_ON_ORDER1_NO = NULL;
   
   /*
              AND ISSN.COMPANY_ID = :COMPANY_ID
              AND ISSN.WH_ID = :WH_ID
   */
      SELECT SUM( ISSN.CURRENT_QTY )
              FROM ISSN
              WHERE ISSN.PROD_ID = :PROD_ID
              AND (V4POS(:COMPANY_ID,ISSN.COMPANY_ID,0,1) > -1)
              AND (POS(:WH_ID,ISSN.WH_ID,0,1) > -1)
              AND (POS(:IMPORTSTATUS,ISSN.ISSN_STATUS,0,1) > -1)
              GROUP BY ISSN.PROD_ID
           INTO :AVAILABLE_QTY;
   
      IF (AVAILABLE_QTY IS NULL) THEN
      BEGIN
         AVAILABLE_QTY = 0;
      END
   /*
           IF (WK_SYS_CONFIRM_NOPROD = 'T') THEN
           BEGIN
              AVAILABLE_QTY = 999999999 ;
           END
   */
   
      WK_COUNT = 0;
      AVAILABLE1_QTY = 0;
      AVAILABLE1_SSN = '';
      AVAILABLE2_QTY = 0;
      AVAILABLE2_SSN = '';
      AVAILABLE3_QTY = 0;
      AVAILABLE3_SSN = '';
      PO_ON_ORDER1_QTY = 0;
      PO_ON_ORDER1_DUE_DATE = NULL;
   /*
              AND ISSN.COMPANY_ID = :COMPANY_ID
              AND ISSN.WH_ID = :WH_ID
   */
      FOR SELECT FIRST 3 ISSN.CURRENT_QTY,ISSN.SSN_ID
              FROM ISSN
              WHERE ISSN.PROD_ID = :PROD_ID
              AND (V4POS(:COMPANY_ID,ISSN.COMPANY_ID,0,1) > -1)
              AND (POS(:WH_ID,ISSN.WH_ID,0,1) > -1)
              AND (POS(:IMPORTSTATUS,ISSN.ISSN_STATUS,0,1) > -1)
              ORDER BY ISSN.CURRENT_QTY
              INTO :WK_CURRENT_QTY, :WK_CURRENT_SSN
      DO
      BEGIN
         WK_COUNT = WK_COUNT + 1;
         IF (WK_COUNT = 1) THEN
         BEGIN
            AVAILABLE1_QTY = WK_CURRENT_QTY;
            AVAILABLE1_SSN = WK_CURRENT_SSN;
         END
         ELSE
         IF (WK_COUNT = 2) THEN
         BEGIN
            AVAILABLE2_QTY = WK_CURRENT_QTY;
            AVAILABLE2_SSN = WK_CURRENT_SSN;
         END
         ELSE
         IF (WK_COUNT = 3) THEN
         BEGIN
            AVAILABLE3_QTY = WK_CURRENT_QTY;
            AVAILABLE3_SSN = WK_CURRENT_SSN;
         END
      END
   
      IF (AVAILABLE1_QTY IS NULL) THEN
      BEGIN
         AVAILABLE1_QTY = 0;
      END
      IF (AVAILABLE2_QTY IS NULL) THEN
      BEGIN
         AVAILABLE2_QTY = 0;
      END
      IF (AVAILABLE3_QTY IS NULL) THEN
      BEGIN
         AVAILABLE3_QTY = 0;
      END
   
   /*
              AND ISSN.COMPANY_ID = :COMPANY_ID
              AND ISSN.WH_ID = :WH_ID
   */
      SELECT SUM( ISSN.CURRENT_QTY )
              FROM ISSN
              WHERE ISSN.PROD_ID = :PROD_ID
              AND (V4POS(:COMPANY_ID,ISSN.COMPANY_ID,0,1) > -1)
              AND (POS(:WH_ID,ISSN.WH_ID,0,1) > -1)
              AND (POS(:RESERVEDSTATUS,ISSN.ISSN_STATUS,0,1) > -1)
              GROUP BY ISSN.PROD_ID
           INTO :RESERVED_QTY;
   
      IF (RESERVED_QTY IS NULL) THEN
      BEGIN
         RESERVED_QTY = 0;
      END
   
   /*
              AND ISSN.COMPANY_ID = :COMPANY_ID
              AND ISSN.WH_ID = :WH_ID
   */
      SELECT SUM( ISSN.CURRENT_QTY )
              FROM ISSN
              WHERE ISSN.PROD_ID = :PROD_ID
              AND (V4POS(:COMPANY_ID,ISSN.COMPANY_ID,0,1) > -1)
              AND (POS(:WH_ID,ISSN.WH_ID,0,1) > -1)
              AND ISSN.ISSN_STATUS <> 'DX'
              AND ISSN.ISSN_STATUS <> 'DI'
              AND (ISSN.ISSN_STATUS < 'X' OR ISSN.ISSN_STATUS > 'X~')
              AND (ISSN.WH_ID < 'X' OR ISSN.WH_ID > 'X~')
              GROUP BY ISSN.PROD_ID
           INTO :ONSITE_QTY;
   
      IF (ONSITE_QTY IS NULL) THEN
      BEGIN
         ONSITE_QTY = 0;
      END
   
      WK_PICKED_QTY = 0;
      WK_ORDER_QTY = 0;
   /*
              AND PICK_ORDER.COMPANY_ID = :COMPANY_ID
              AND PICK_ORDER.WH_ID = :WH_ID
   */
      SELECT SUM( PICK_ITEM.PICK_ORDER_QTY ),
             SUM( PICK_ITEM.PICKED_QTY )
              FROM PICK_ITEM JOIN PICK_ORDER
              ON PICK_ITEM.PICK_ORDER = PICK_ORDER.PICK_ORDER
              WHERE PICK_ITEM.PROD_ID = :PROD_ID
              AND (V4POS(:COMPANY_ID,PICK_ORDER.COMPANY_ID,0,1) > -1)
              AND (POS(:WH_ID,PICK_ORDER.WH_ID,0,1) > -1)
              AND (POS(:UNPICKEDSTATUS,PICK_ITEM.PICK_LINE_STATUS,0,1) > -1)
              GROUP BY PICK_ITEM.PROD_ID /* WHY DO WE NEED A GROUP BY CLAUSE HERE? */
           INTO :WK_ORDER_QTY, :WK_PICKED_QTY;
      IF (WK_ORDER_QTY IS NULL) THEN
      BEGIN
         WK_ORDER_QTY = 0;
      END
      IF (WK_PICKED_QTY IS NULL) THEN
      BEGIN
         WK_PICKED_QTY = 0;
      END
      UNPICKED_ORDER_QTY = WK_ORDER_QTY - WK_PICKED_QTY;
      WK_PICKED_QTY = 0;
      WK_ORDER_QTY = 0;

   /*
              AND PICK_ORDER.COMPANY_ID = :COMPANY_ID
              AND PICK_ORDER.WH_ID = :WH_ID
   */
      SELECT SUM( PICK_ITEM.PICK_ORDER_QTY ),
             SUM( PICK_ITEM.PICKED_QTY )
              FROM PICK_ITEM JOIN PICK_ORDER
              ON PICK_ITEM.PICK_ORDER = PICK_ORDER.PICK_ORDER
              WHERE PICK_ITEM.PROD_ID = :PROD_ID
              AND (V4POS(:COMPANY_ID,PICK_ORDER.COMPANY_ID,0,1) > -1)
              AND (POS(:WH_ID,PICK_ORDER.WH_ID,0,1) > -1)
              AND PICK_ITEM.PICK_LINE_STATUS IN ( 'HD', 'AS')
              GROUP BY PICK_ITEM.PROD_ID /* WHY DO WE NEED A GROUP BY CLAUSE HERE? */
           INTO :WK_ORDER_QTY, :WK_PICKED_QTY;
      IF (WK_ORDER_QTY IS NULL) THEN
      BEGIN
         WK_ORDER_QTY = 0;
      END
      IF (WK_PICKED_QTY IS NULL) THEN
      BEGIN
         WK_PICKED_QTY = 0;
      END
      BACK_ORDER_QTY = WK_ORDER_QTY - WK_PICKED_QTY;
      WK_PICKED_QTY = 0;
      WK_ORDER_QTY = 0;
   /*
              AND PICK_ORDER.COMPANY_ID = :COMPANY_ID
              AND PICK_ORDER.WH_ID = :WH_ID
   */
      SELECT SUM( PICK_ITEM.PICK_ORDER_QTY ),
             SUM( PICK_ITEM.PICKED_QTY )
              FROM PICK_ITEM JOIN PICK_ORDER
              ON PICK_ITEM.PICK_ORDER = PICK_ORDER.PICK_ORDER
              WHERE PICK_ITEM.PROD_ID = :PROD_ID
              AND (V4POS(:COMPANY_ID,PICK_ORDER.COMPANY_ID,0,1) > -1)
              AND (POS(:WH_ID,PICK_ORDER.WH_ID,0,1) > -1)
              AND PICK_ITEM.PICK_LINE_STATUS = 'CN'
              GROUP BY PICK_ITEM.PROD_ID
           INTO :WK_ORDER_QTY, :WK_PICKED_QTY;
      IF (WK_ORDER_QTY IS NULL) THEN
      BEGIN
         WK_ORDER_QTY = 0;
      END
      IF (WK_PICKED_QTY IS NULL) THEN
      BEGIN
         WK_PICKED_QTY = 0;
      END
      CANCELLED_ORDER_QTY = WK_ORDER_QTY - WK_PICKED_QTY;
   
   /* po qtys */
      SELECT SUM( PURCHASE_ORDER_LINE.PO_LINE_QTY )
              FROM PURCHASE_ORDER_LINE JOIN PURCHASE_ORDER
              ON PURCHASE_ORDER_LINE.PURCHASE_ORDER = PURCHASE_ORDER.PURCHASE_ORDER
              WHERE PURCHASE_ORDER_LINE.PROD_ID = :PROD_ID
              AND (V4POS(:COMPANY_ID,PURCHASE_ORDER.COMPANY_ID,0,1) > -1)
              AND (POS(:WH_ID,PURCHASE_ORDER.PO_RECEIVE_WH_ID,0,1) > -1)
              AND PURCHASE_ORDER_LINE.PO_LINE_STATUS IN ( 'CF', 'OP')
              AND PURCHASE_ORDER.PO_STATUS IN ( 'CF', 'OP')
              GROUP BY PURCHASE_ORDER_LINE.PROD_ID
           INTO :WK_ORDER_QTY ;
      IF (WK_ORDER_QTY IS NULL) THEN
      BEGIN
         WK_ORDER_QTY = 0;
      END
      PO_ON_ORDER_QTY = WK_ORDER_QTY ;
      WK_PICKED_QTY = 0;
      WK_ORDER_QTY = 0;
   
      SELECT FIRST 1 PURCHASE_ORDER_LINE.PURCHASE_ORDER, PURCHASE_ORDER.PO_DUE_DATE, PURCHASE_ORDER_LINE.PO_LINE_QTY
              FROM PURCHASE_ORDER_LINE JOIN PURCHASE_ORDER
              ON PURCHASE_ORDER_LINE.PURCHASE_ORDER = PURCHASE_ORDER.PURCHASE_ORDER
              WHERE PURCHASE_ORDER_LINE.PROD_ID = :PROD_ID
              AND (V4POS(:COMPANY_ID,PURCHASE_ORDER.COMPANY_ID,0,1) > -1)
              AND (POS(:WH_ID,PURCHASE_ORDER.PO_RECEIVE_WH_ID,0,1) > -1)
              AND PURCHASE_ORDER_LINE.PO_LINE_STATUS IN ( 'CF', 'OP')
              AND PURCHASE_ORDER.PO_STATUS IN ( 'CF', 'OP')
              ORDER BY PURCHASE_ORDER.PO_DUE_DATE
              INTO :PO_ON_ORDER1_NO,
                   :PO_ON_ORDER1_DUE_DATE,
                   :PO_ON_ORDER1_QTY;
   
   /*
              AND ISSN.COMPANY_ID = :COMPANY_ID
              AND ISSN.WH_ID = :WH_ID
   */
      SELECT SUM( ISSN.CURRENT_QTY )
              FROM ISSN
              WHERE ISSN.PROD_ID = :PROD_ID
              AND ISSN.ISSN_STATUS = 'TS'
              AND (V4POS(:COMPANY_ID,ISSN.COMPANY_ID,0,1) > -1)
              AND (POS(:WH_ID,ISSN.WH_ID,0,1) > -1)
              GROUP BY ISSN.PROD_ID
           INTO :TEST_QTY;
   
      IF (TEST_QTY IS NULL) THEN
      BEGIN
         TEST_QTY = 0;
      END

      SUSPEND;
   END


END ^

ALTER PROCEDURE PRODUCT_MOVEMENT_AGE RETURNS (PROD_ID VARCHAR(30) CHARACTER SET NONE,
SHORT_DESC VARCHAR(50) CHARACTER SET NONE,
SSN_ID VARCHAR(20) CHARACTER SET NONE,
LAST_MOVEMENT_DATE TIMESTAMP,
CURRENT_QTY INTEGER)
AS 
 
 

DECLARE VARIABLE WK_WH_QTY INTEGER;
DECLARE VARIABLE WK_UNPICKED_QTY INTEGER;
DECLARE VARIABLE WK_LAST_DATE TIMESTAMP;
DECLARE VARIABLE IMPORTSTATUS VARCHAR(40);
DECLARE VARIABLE WK_WH_ID CHAR(2);
DECLARE VARIABLE WK_HAVE_SSN CHAR(1);
BEGIN
/*
have a procedure to report 
by last stockadjust or pick date for the product
the current ssns
the total qty for the product in available status 
first those products with no movements (TRIL or TRLI or PKOL)

*/
   SELECT PICK_IMPORT_SSN_STATUS, DEFAULT_WH_ID
   FROM CONTROL
   INTO :IMPORTSTATUS, :WK_WH_ID; 
   FOR SELECT PROD_ID ,SHORT_DESC
   FROM PROD_PROFILE
   INTO :PROD_ID , :SHORT_DESC
   DO
   BEGIN
      SELECT AVAILABLE_QTY ,UNPICKED_ORDER_QTY
      FROM PRODUCT_STOCK_STATUS(:PROD_ID) 
      INTO :WK_WH_QTY, :WK_UNPICKED_QTY;
      IF (WK_WH_QTY IS NULL) THEN
      BEGIN
         WK_WH_QTY = 0;
      END
      IF (WK_UNPICKED_QTY IS NULL) THEN
      BEGIN
         WK_UNPICKED_QTY = 0;
      END
      /* IF (WK_WH_QTY > 0) THEN */
      BEGIN
         /* ok have some stock of this prod */
         CURRENT_QTY = WK_WH_QTY;
         /* UNPICKED_ORDER_QTY = WK_UNPICKED_QTY; */
         LAST_MOVEMENT_DATE = NULL;
         SSN_ID = NULL;
   
         SELECT MAX( SSN_HIST.TRN_DATE ) 
            FROM ISSN
            JOIN SSN_HIST ON ISSN.SSN_ID = SSN_HIST.SSN_ID
            WHERE  ISSN.PROD_ID = :PROD_ID
            AND  ((SSN_HIST.TRN_TYPE IN ('PKOL','STPA'))
            OR    (SSN_HIST.TRN_TYPE = 'TRIL'
            AND    SSN_HIST.REFERENCE STARTING 'Completing SSN Adjustment'))
            INTO :LAST_MOVEMENT_DATE;
         IF (LAST_MOVEMENT_DATE IS NULL) THEN
         BEGIN
            LAST_MOVEMENT_DATE = CAST('01-01-1980' AS TIMESTAMP);
         END
         WK_HAVE_SSN = 'F';
         FOR SELECT SSN_ID 
            FROM ISSN
            WHERE ISSN.PROD_ID = :PROD_ID
            AND WH_ID = :WK_WH_ID
            AND (POS(:IMPORTSTATUS,ISSN.ISSN_STATUS,0,1) > -1)
            INTO :SSN_ID
         DO
         BEGIN
            WK_HAVE_SSN = 'T';
            SUSPEND;
         END
         IF (WK_HAVE_SSN = 'F') THEN
         BEGIN
            SSN_ID = '';
            SUSPEND;
         END
      END
   END 
END ^

ALTER PROCEDURE PRODUCT_QTYS RETURNS (PROD_ID VARCHAR(30) CHARACTER SET NONE,
ALTERNATE_ID VARCHAR(30) CHARACTER SET NONE,
PICKFACE_QTY INTEGER,
LOCN_ID VARCHAR(10) CHARACTER SET NONE,
AVAILABLE_QTY INTEGER,
VARIANCE_QTY_1 INTEGER,
COMPANY_ID_1 VARCHAR(20) CHARACTER SET NONE,
VARIANCE_QTY_2 INTEGER,
COMPANY_ID_2 VARCHAR(20) CHARACTER SET NONE)
AS 
 
 

DECLARE VARIABLE WK_PROD_ID VARCHAR(30);
DECLARE VARIABLE WK_ALTERNATE_ID VARCHAR(30);
DECLARE VARIABLE WK_COMPANY_ID1 VARCHAR(20);
DECLARE VARIABLE WK_COMPANY_ID2 VARCHAR(20);
DECLARE VARIABLE WK_CURRENT_QTY INTEGER;
DECLARE VARIABLE WK_LEGACY_QTY1 INTEGER;
DECLARE VARIABLE WK_LEGACY_QTY2 INTEGER;
DECLARE VARIABLE WK_LOCN_ID VARCHAR(10);
DECLARE VARIABLE WK_PICKFACE_QTY INTEGER;
DECLARE VARIABLE WK_IMPORT_STATUS VARCHAR(70);
BEGIN
   SELECT CONTROL.PICK_IMPORT_SSN_STATUS
   FROM CONTROL
   INTO :WK_IMPORT_STATUS;
   FOR SELECT PP.PROD_ID, PP.ALTERNATE_ID, PP.COMPANY_ID, PP.ALTERNATE_COMPANY_ID 
   FROM CONTROL 
   JOIN PROD_PROFILE PP ON PP.COMPANY_ID = CONTROL.COMPANY_ID
   INTO :WK_PROD_ID, 
        :WK_ALTERNATE_ID,
        :WK_COMPANY_ID1,
        :WK_COMPANY_ID2
   DO
   BEGIN
      SELECT AVAILABLE_QTY 
      FROM PRODUCT_STOCK_STATUS(:WK_ALTERNATE_ID) 
      INTO :WK_CURRENT_QTY;
      IF (WK_CURRENT_QTY IS NULL) THEN
      BEGIN
         WK_CURRENT_QTY = 0;
      END
      SELECT LEGACY_QTY
      FROM VARIANCE
      WHERE RUN_DATE = (SELECT MAX(V2.RUN_DATE) FROM VARIANCE V2 WHERE V2.PROD_ID = :WK_PROD_ID AND V2.COMPANY_ID = :WK_COMPANY_ID1)
      AND PROD_ID = :WK_PROD_ID
      AND COMPANY_ID = :WK_COMPANY_ID1
      INTO :WK_LEGACY_QTY1;
      IF (WK_LEGACY_QTY1 IS NULL) THEN
      BEGIN
         WK_LEGACY_QTY1 = 0;
      END
      SELECT LEGACY_QTY
      FROM VARIANCE
      WHERE RUN_DATE = (SELECT MAX(V2.RUN_DATE) FROM VARIANCE V2 WHERE V2.PROD_ID = :WK_ALTERNATE_ID AND V2.COMPANY_ID = :WK_COMPANY_ID2)
      AND PROD_ID = :WK_ALTERNATE_ID
      AND COMPANY_ID = :WK_COMPANY_ID2
      INTO :WK_LEGACY_QTY2;
      IF (WK_LEGACY_QTY2 IS NULL) THEN
      BEGIN
         WK_LEGACY_QTY2 = 0;
      END

      FOR SELECT ISSN.LOCN_ID, SUM(ISSN.CURRENT_QTY)
      FROM ISSN
      JOIN LOCATION ON LOCATION.WH_ID = ISSN.WH_ID AND LOCATION.LOCN_ID = ISSN.LOCN_ID 
      JOIN ZONE ON LOCATION.ZONE_C = ZONE.CODE 
      WHERE ISSN.PROD_ID = :WK_ALTERNATE_ID
      AND (POS(:WK_IMPORT_STATUS,ISSN.ISSN_STATUS,0,1) > -1)
      AND (ZONE.DEFAULT_DEVICE_ID IS NOT NULL )
      AND (ZONE.COMPANY_ID IS NULL) 
      GROUP BY ISSN.LOCN_ID
      INTO :WK_LOCN_ID, :WK_PICKFACE_QTY
      DO
      BEGIN
         ALTERNATE_ID = WK_PROD_ID;
         PROD_ID = WK_ALTERNATE_ID;
         PICKFACE_QTY = WK_PICKFACE_QTY;
         LOCN_ID = WK_LOCN_ID;
         AVAILABLE_QTY = WK_CURRENT_QTY; 
         VARIANCE_QTY_1 = WK_LEGACY_QTY1;
         VARIANCE_QTY_2 = WK_LEGACY_QTY2;
         COMPANY_ID_1 = WK_COMPANY_ID1;
         COMPANY_ID_2 = WK_COMPANY_ID2;
         SUSPEND;
      END
   END
   
END ^

ALTER PROCEDURE PRODUCT_STOCK_STATUS (PROD_ID VARCHAR(30) CHARACTER SET NONE)
RETURNS (AVAILABLE_QTY INTEGER,
RESERVED_QTY INTEGER,
ONSITE_QTY INTEGER,
UNPICKED_ORDER_QTY INTEGER,
BACK_ORDER_QTY INTEGER,
CANCELLED_ORDER_QTY INTEGER,
TEST_QTY INTEGER)
AS 
 
 

DECLARE VARIABLE IMPORTSTATUS VARCHAR(40);
DECLARE VARIABLE RESERVEDSTATUS VARCHAR(40);
DECLARE VARIABLE UNPICKEDSTATUS VARCHAR(40);
DECLARE VARIABLE WK_ORDER_QTY INTEGER;
DECLARE VARIABLE WK_PICKED_QTY INTEGER;
BEGIN
   /*
    RETURNS ALL PRODUCTS THAT ARE AVAILABLE FOR PICKING
   */
   SELECT CONTROL.PICK_IMPORT_SSN_STATUS,
   CONTROL.PICK_RESERVED_SSN_STATUS,
   CONTROL.PICK_UNPICKED_ITEM_STATUS
   FROM CONTROL
   INTO :IMPORTSTATUS, 
        :RESERVEDSTATUS,
        :UNPICKEDSTATUS;
   
   SELECT SUM( ISSN.CURRENT_QTY ) 
           FROM ISSN
           WHERE ISSN.PROD_ID = :PROD_ID
           AND (POS(:IMPORTSTATUS,ISSN.ISSN_STATUS,0,1) > -1)
           GROUP BY ISSN.PROD_ID
        INTO :AVAILABLE_QTY;
   
   SELECT SUM( ISSN.CURRENT_QTY ) 
           FROM ISSN
           WHERE ISSN.PROD_ID = :PROD_ID
           AND (POS(:RESERVEDSTATUS,ISSN.ISSN_STATUS,0,1) > -1)
           GROUP BY ISSN.PROD_ID
        INTO :RESERVED_QTY;
   
   SELECT SUM( ISSN.CURRENT_QTY ) 
           FROM ISSN
           WHERE ISSN.PROD_ID = :PROD_ID
           AND ISSN.ISSN_STATUS <> 'DX'
           AND ISSN.ISSN_STATUS <> 'DI'
           AND (ISSN.ISSN_STATUS < 'X' OR ISSN.ISSN_STATUS > 'X~')
           AND (ISSN.WH_ID < 'X' OR ISSN.WH_ID > 'X~')
           GROUP BY ISSN.PROD_ID
        INTO :ONSITE_QTY;
   
   WK_PICKED_QTY = 0;
   WK_ORDER_QTY = 0;
   SELECT SUM( PICK_ITEM.PICK_ORDER_QTY ), 
          SUM( PICK_ITEM.PICKED_QTY ) 
           FROM PICK_ITEM
           WHERE PICK_ITEM.PROD_ID = :PROD_ID
           AND (POS(:UNPICKEDSTATUS,PICK_ITEM.PICK_LINE_STATUS,0,1) > -1)
           GROUP BY PICK_ITEM.PROD_ID
        INTO :WK_ORDER_QTY, :WK_PICKED_QTY;
   IF (WK_ORDER_QTY IS NULL) THEN
   BEGIN
      WK_ORDER_QTY = 0;
   END
   IF (WK_PICKED_QTY IS NULL) THEN
   BEGIN
      WK_PICKED_QTY = 0;
   END
   UNPICKED_ORDER_QTY = WK_ORDER_QTY - WK_PICKED_QTY;
   WK_PICKED_QTY = 0;
   WK_ORDER_QTY = 0;
   SELECT SUM( PICK_ITEM.PICK_ORDER_QTY ), 
          SUM( PICK_ITEM.PICKED_QTY ) 
           FROM PICK_ITEM
           WHERE PICK_ITEM.PROD_ID = :PROD_ID
           AND PICK_ITEM.PICK_LINE_STATUS = 'HD'
           GROUP BY PICK_ITEM.PROD_ID
        INTO :WK_ORDER_QTY, :WK_PICKED_QTY;
   IF (WK_ORDER_QTY IS NULL) THEN
   BEGIN
      WK_ORDER_QTY = 0;
   END
   IF (WK_PICKED_QTY IS NULL) THEN
   BEGIN
      WK_PICKED_QTY = 0;
   END
   BACK_ORDER_QTY = WK_ORDER_QTY - WK_PICKED_QTY;
   WK_PICKED_QTY = 0;
   WK_ORDER_QTY = 0;
   SELECT SUM( PICK_ITEM.PICK_ORDER_QTY ), 
          SUM( PICK_ITEM.PICKED_QTY ) 
           FROM PICK_ITEM
           WHERE PICK_ITEM.PROD_ID = :PROD_ID
           AND PICK_ITEM.PICK_LINE_STATUS = 'CN'
           GROUP BY PICK_ITEM.PROD_ID
        INTO :WK_ORDER_QTY, :WK_PICKED_QTY;
   IF (WK_ORDER_QTY IS NULL) THEN
   BEGIN
      WK_ORDER_QTY = 0;
   END
   IF (WK_PICKED_QTY IS NULL) THEN
   BEGIN
      WK_PICKED_QTY = 0;
   END
   CANCELLED_ORDER_QTY = WK_ORDER_QTY - WK_PICKED_QTY;
        
   SELECT SUM( ISSN.CURRENT_QTY ) 
           FROM ISSN
           WHERE ISSN.PROD_ID = :PROD_ID
           AND ISSN.ISSN_STATUS = 'TS'
           GROUP BY ISSN.PROD_ID
        INTO :TEST_QTY;
   
   SUSPEND;
END ^

ALTER PROCEDURE REPLENISH_LOCN RETURNS (PROD_ID VARCHAR(30) CHARACTER SET NONE,
TO_WH_ID CHAR(2) CHARACTER SET NONE,
TO_LOCN_ID VARCHAR(10) CHARACTER SET NONE,
TRN_PRIORITY SMALLINT,
REQUIRED_QTY INTEGER,
CURRENT_QTY INTEGER,
WH_QTY INTEGER,
UNPICKED_ORDER_QTY INTEGER)
AS 
 
 

DECLARE VARIABLE WK_MIN_QTY INTEGER;
DECLARE VARIABLE WK_MAX_QTY INTEGER;
DECLARE VARIABLE WK_REORDER_QTY INTEGER;
DECLARE VARIABLE WK_CURRENT_QTY INTEGER;
DECLARE VARIABLE WK_WH_QTY INTEGER;
DECLARE VARIABLE WK_UNPICKED_QTY INTEGER;
DECLARE VARIABLE IMPORTSTATUS VARCHAR(40);
BEGIN
/*
have a procedure to report the current transfer request 
for locations with
 replenish flag 'T'
 and prod_id populated

 get current stock of that product in the location
 if current stock < reorder_level
 begin
  if current stock <= min level
  begin
   priority is High
  end
  else
  begin
   priority is default
  end
  qty to get is the max_level - current level
 end
change on 210706
only include prods where have some stock in the warehouse
change on 250706
include warehouse and locn totals
change on 260706
include unpicked totals
*/
   SELECT CONTROL.PICK_IMPORT_SSN_STATUS
   FROM CONTROL
   INTO :IMPORTSTATUS; 
   FOR SELECT PROD_ID, WH_ID, LOCN_ID, MIN_QTY, MAX_QTY, REORDER_QTY
   FROM LOCATION
   WHERE REPLENISH = 'T'
   AND (PROD_ID IS NOT NULL)
   AND (REORDER_QTY IS NOT NULL)
   AND (MAX_QTY IS NOT NULL)
   INTO :PROD_ID, 
        :TO_WH_ID,
        :TO_LOCN_ID,
        :WK_MIN_QTY,
        :WK_MAX_QTY,
        :WK_REORDER_QTY
   DO
   BEGIN
      IF (WK_MIN_QTY IS NULL) THEN
      BEGIN
         WK_MIN_QTY = 0;
      END
      SELECT AVAILABLE_QTY ,UNPICKED_ORDER_QTY
      FROM PRODUCT_STOCK_STATUS(:PROD_ID) 
      INTO :WK_WH_QTY, :WK_UNPICKED_QTY;
      IF (WK_WH_QTY IS NULL) THEN
      BEGIN
         WK_WH_QTY = 0;
      END
      IF (WK_UNPICKED_QTY IS NULL) THEN
      BEGIN
         WK_UNPICKED_QTY = 0;
      END
      IF (WK_WH_QTY > 0) THEN
      BEGIN
         WH_QTY = WK_WH_QTY;
         UNPICKED_ORDER_QTY = WK_UNPICKED_QTY;
   
         SELECT SUM( ISSN.CURRENT_QTY ) 
            FROM ISSN
            WHERE ISSN.PROD_ID = :PROD_ID
            AND WH_ID = :TO_WH_ID
            AND LOCN_ID = :TO_LOCN_ID
            /* AND (POS(:IMPORTSTATUS,ISSN.ISSN_STATUS,0,1) > -1) */
            INTO :WK_CURRENT_QTY;
         IF (WK_CURRENT_QTY IS NULL) THEN
         BEGIN
            WK_CURRENT_QTY = 0;
         END
         IF (WK_CURRENT_QTY < WK_REORDER_QTY) THEN
         BEGIN
            IF (WK_CURRENT_QTY < WK_MIN_QTY) THEN
            BEGIN
               TRN_PRIORITY = 5;
            END
            ELSE
            BEGIN
               TRN_PRIORITY = 10;
            END
            REQUIRED_QTY = WK_MAX_QTY - WK_CURRENT_QTY;
            CURRENT_QTY = WK_CURRENT_QTY;
            SUSPEND;
         END
      END
   END
   
END ^

ALTER PROCEDURE RERUN_TRANSACTION_ISIZ AS 

DECLARE VARIABLE WK_DEVICE CHAR(2);
DECLARE VARIABLE WK_USER VARCHAR(10);
DECLARE VARIABLE WK_RECORD INTEGER;
DECLARE VARIABLE WK_NEW_RECORD INTEGER;
DECLARE VARIABLE WK_WH_ID CHAR(2);
DECLARE VARIABLE WK_LOCN_ID VARCHAR(10);
DECLARE VARIABLE WK_OBJECT VARCHAR(30);
DECLARE VARIABLE WK_REFERENCE VARCHAR(40);
DECLARE VARIABLE WK_QTY INTEGER;
DECLARE VARIABLE WK_TRN_TYPE VARCHAR(4);
DECLARE VARIABLE WK_TRN_CODE CHAR(1);
DECLARE VARIABLE WK_DATE TIMESTAMP;
DECLARE VARIABLE WK_SUB_LOCN VARCHAR(10);
DECLARE VARIABLE WK_ERROR VARCHAR(70);
DECLARE VARIABLE WK_INSTANCE CHAR(10);
DECLARE VARIABLE WK_EXPORTED INTEGER;
DECLARE VARIABLE WK_SOURCE VARCHAR(10);
DECLARE VARIABLE WK_RES INTEGER;


BEGIN
  FOR SELECT RECORD_ID, WH_ID, LOCN_ID, OBJECT, TRN_TYPE, TRN_CODE, TRN_DATE, REFERENCE,
      QTY, ERROR_TEXT, INSTANCE_ID, EXPORTED, SUB_LOCN_ID, INPUT_SOURCE,
      PERSON_ID, DEVICE_ID 
  FROM TRANSACTIONS
  WHERE TRN_TYPE = 'ISIZ' AND COMPLETE = 'F'  
  INTO :WK_RECORD, :WK_WH_ID, :WK_LOCN_ID, :WK_OBJECT, :WK_TRN_TYPE, :WK_TRN_CODE, :WK_DATE, :WK_REFERENCE, 
   :WK_QTY, :WK_ERROR, :WK_INSTANCE, :WK_EXPORTED, :WK_SUB_LOCN, :WK_SOURCE,
   :WK_USER, :WK_DEVICE
  DO
  BEGIN
     WK_NEW_RECORD = GEN_ID(TRANSACTION_ID, 1);    
     /* WK_RES = FILE_WRITELN('isiz.txt','transaction');  */
     INSERT INTO TRANSACTIONS ( RECORD_ID, WH_ID, LOCN_ID, OBJECT, TRN_TYPE, TRN_CODE, TRN_DATE, REFERENCE,
      QTY, ERROR_TEXT, INSTANCE_ID, EXPORTED, SUB_LOCN_ID, INPUT_SOURCE,
      PERSON_ID, DEVICE_ID) 
      VALUES ( :WK_NEW_RECORD, :WK_WH_ID, :WK_LOCN_ID, :WK_OBJECT, :WK_TRN_TYPE, :WK_TRN_CODE, :WK_DATE, :WK_REFERENCE, 
   :WK_QTY, :WK_ERROR, :WK_INSTANCE, :WK_EXPORTED, :WK_SUB_LOCN, :WK_SOURCE,
   :WK_USER, :WK_DEVICE);
     UPDATE TRANSACTIONS SET COMPLETE = 'R' WHERE RECORD_ID = :WK_RECORD;
  END
END ^

ALTER PROCEDURE RPT_ARCHIVE_DATA (THISWHID VARCHAR(2) CHARACTER SET NONE)
RETURNS (WH_ID VARCHAR(2) CHARACTER SET NONE,
LOCN_ID VARCHAR(10) CHARACTER SET NONE,
PROD_ID VARCHAR(30) CHARACTER SET NONE,
CURRENT_QTY VARCHAR(10) CHARACTER SET NONE,
SHORT_DESC VARCHAR(50) CHARACTER SET NONE,
MOVE_STAT VARCHAR(2) CHARACTER SET NONE,
NAME VARCHAR(50) CHARACTER SET NONE)
AS 

BEGIN

      FOR SELECT ISSN.WH_ID, ISSN.LOCN_ID,ISSN.PROD_ID,ISSN.CURRENT_QTY,PROD_PROFILE.SHORT_DESC, LOCATION.MOVE_STAT , COMPANY.NAME
          FROM ISSN
          LEFT OUTER JOIN PROD_PROFILE ON ISSN.PROD_ID = PROD_PROFILE.PROD_ID
          LEFT OUTER JOIN LOCATION ON ISSN.WH_ID = LOCATION.WH_ID AND ISSN.LOCN_ID = LOCATION.LOCN_ID
          LEFT OUTER JOIN COMPANY ON ISSN.COMPANY_ID = COMPANY.COMPANY_ID
          WHERE (ISSN.WH_ID = :THISWHID ) AND
                ((LOCATION.MOVE_STAT = 'AR') OR
                 (ISSN.ISSN_STATUS = 'AR')) 
          ORDER BY ISSN.LOCN_ID, ISSN.PROD_ID

      INTO
      :WH_ID,
    :LOCN_ID,
    :PROD_ID,
    :CURRENT_QTY,
    :SHORT_DESC,
    :MOVE_STAT,
    :NAME

      DO
      BEGIN
         SUSPEND;
      END

END ^

ALTER PROCEDURE RPT_BUSINESS_MONTHLY_1_DATA (THISCOMPANY VARCHAR(20) CHARACTER SET NONE,
THISSTART TIMESTAMP,
THISEND TIMESTAMP)
RETURNS (PROD_ID VARCHAR(30) CHARACTER SET NONE,
SHORT_DESC VARCHAR(50) CHARACTER SET NONE,
THISCOMPANY_ID VARCHAR(20) CHARACTER SET NONE,
CURRENT_QTY INTEGER)
AS 

BEGIN
  /* PROCEDURE BODY */
  FOR
SELECT ISSN.PROD_ID, PROD_PROFILE.SHORT_DESC,PROD_PROFILE.COMPANY_ID , SUM(ISSN.ORIGINAL_QTY)
FROM GRN
JOIN SSN ON SSN.GRN = GRN.GRN
JOIN ISSN ON ISSN.SSN_ID = SSN.SSN_ID
JOIN PROD_PROFILE ON PROD_PROFILE.PROD_ID = ISSN.PROD_ID
WHERE (GRN.GRN_DATE BETWEEN ZEROTIME(:THISSTART) AND MAXTIME(:THISEND)) AND
   PROD_PROFILE.COMPANY_ID = :THISCOMPANY 
GROUP BY PROD_PROFILE.COMPANY_ID, ISSN.PROD_ID, PROD_PROFILE.SHORT_DESC

  INTO
          :PROD_ID,
          :SHORT_DESC,
          :THISCOMPANY_ID,
          :CURRENT_QTY
  DO
  BEGIN
  SUSPEND;
  END
END ^

ALTER PROCEDURE RPT_BUSINESS_MONTHLY_2_DATA (THISCOMPANY VARCHAR(20) CHARACTER SET NONE,
THISSTART TIMESTAMP,
THISEND TIMESTAMP)
RETURNS (WH_ID1 VARCHAR(30) CHARACTER SET NONE,
LOCN_ID1 VARCHAR(30) CHARACTER SET NONE,
LOC_QTY_1 INTEGER,
WH_ID2 VARCHAR(30) CHARACTER SET NONE,
LOCN_ID2 VARCHAR(30) CHARACTER SET NONE,
LOC_QTY_2 INTEGER,
PROD_ID VARCHAR(30) CHARACTER SET NONE,
DESCRIPTION VARCHAR(50) CHARACTER SET NONE)
AS 

   DECLARE VARIABLE    WK_WH_ID    CHAR(2);
   DECLARE VARIABLE    WK_LOCN_ID  VARCHAR(10);
   DECLARE VARIABLE    WK_SSN_ID   VARCHAR(30); 
   DECLARE VARIABLE    WK_QTY      INTEGER;
   DECLARE VARIABLE    WK_PROD_ID  VARCHAR(30);
   DECLARE VARIABLE    WK_DESC1    VARCHAR(50);
   DECLARE VARIABLE    WK_DESC2    VARCHAR(50);
   DECLARE VARIABLE    WK_TRNTYPE  VARCHAR(4);
   DECLARE VARIABLE    WK_TRNCODE  CHAR(1);
   DECLARE VARIABLE    WK_HAVE_DATA  CHAR(1);
   DECLARE VARIABLE    WK_FIRST_DATA  CHAR(1);
   DECLARE VARIABLE    WK_CURRENT_FROM_WH_ID  CHAR(2);
   DECLARE VARIABLE    WK_CURRENT_FROM_LOCN_ID  VARCHAR(10);
   DECLARE VARIABLE    WK_CURRENT_PROD_ID  VARCHAR(30);
   DECLARE VARIABLE    WK_CURRENT_DESC  VARCHAR(50);
   DECLARE VARIABLE    WK_CURRENT_TO_WH_ID  CHAR(2);
   DECLARE VARIABLE    WK_CURRENT_TO_LOCN_ID  VARCHAR(10);
   DECLARE VARIABLE    WK_CURRENT_FROM_QTY  INTEGER;
   DECLARE VARIABLE    WK_CURRENT_TO_QTY  INTEGER;
   DECLARE VARIABLE    WK_COMP1  VARCHAR(20);
   DECLARE VARIABLE    WK_COMP2  VARCHAR(20);
   DECLARE VARIABLE    WK_SSN_ID2  VARCHAR(20);
   DECLARE VARIABLE    WK_PROD_ID2  VARCHAR(30);
   DECLARE VARIABLE    WK_PROD_ID3  VARCHAR(30);
   DECLARE VARIABLE    WK_CHANGE  VARCHAR(10);
   DECLARE VARIABLE    WK_DUMMY  CHAR(1);
   DECLARE VARIABLE    WK_DEVICE  VARCHAR(3);
   DECLARE VARIABLE    WK_LAST_FROM_WH_ID  CHAR(2);
   DECLARE VARIABLE    WK_LAST_FROM_LOCN_ID  VARCHAR(10);
   DECLARE VARIABLE    WK_LAST_TO_WH_ID  CHAR(2);
   DECLARE VARIABLE    WK_LAST_TO_LOCN_ID  VARCHAR(10);
   DECLARE VARIABLE    WK_LAST_FROM_QTY  INTEGER;
   DECLARE VARIABLE    WK_LAST_TO_QTY  INTEGER;
   DECLARE VARIABLE    WK_TRANSFER_QTY      INTEGER;
   DECLARE VARIABLE    WK_REC_ID      INTEGER;
   DECLARE VARIABLE    WK_FOUND      INTEGER;

BEGIN
  /* PROCEDURE BODY */
  WK_HAVE_DATA = 'N';
  WK_FIRST_DATA = 'Y';
  PROD_ID = '';
  WH_ID1 = '';
  LOCN_ID1 = '';
  LOC_QTY_1 = 0;
  WH_ID2 = '';
  LOCN_ID2 = '';
  LOC_QTY_2 = 0;
  DESCRIPTION = '';
  WK_CURRENT_PROD_ID = '';
  WK_CURRENT_FROM_QTY = 0;
  WK_CURRENT_FROM_WH_ID = '';
  WK_CURRENT_FROM_LOCN_ID = '';
  WK_CURRENT_TO_QTY = 0;
  WK_CURRENT_TO_WH_ID = '';
  WK_CURRENT_TO_LOCN_ID = '';
  WK_LAST_FROM_QTY = 0;
  WK_LAST_FROM_WH_ID = '';
  WK_LAST_FROM_LOCN_ID = '';
  WK_LAST_TO_QTY = 0;
  WK_LAST_TO_WH_ID = '';
  WK_LAST_TO_LOCN_ID = '';
  WK_REC_ID = GEN_ID(TRANSACTION_ID, 1);    
  /*  LEFT OUTER JOIN PROD_PROFILE P2 ON P2.PROD_ID = SSN_HIST.SSN_ID 
       P2.SHORT_DESC,
       P2.COMPANY_ID,
       P2.PROD_ID,
     (P2.COMPANY_ID = :THISCOMPANY AND P2.COMPANY_ID IS NOT NULL) ) */
  FOR
    SELECT SSN_HIST.TRN_TYPE, 
       SSN_HIST.TRN_CODE,
       SSN_HIST.WH_ID ,
       SSN_HIST.LOCN_ID ,
       SSN_HIST.SSN_ID , 
       ISSN.CURRENT_QTY,
       ISSN.PROD_ID,
       P1.SHORT_DESC,
       P1.COMPANY_ID,
       ISSN.SSN_ID,
       P1.PROD_ID,
       SSN_HIST.DEVICE_ID,
       SSN_HIST.QTY
    FROM SSN_HIST
    LEFT OUTER JOIN ISSN ON ISSN.SSN_ID = SSN_HIST.SSN_ID 
    LEFT OUTER JOIN PROD_PROFILE P1 ON P1.PROD_ID = ISSN.PROD_ID
    WHERE SSN_HIST.TRN_TYPE IN ('TROL','TRLO','TRIL','TRLI') AND
    SSN_HIST.TRN_CODE IN ('A','P') AND 
    (SSN_HIST.TRN_DATE BETWEEN ZEROTIME(:THISSTART) AND MAXTIME(:THISEND)) AND
    (P1.COMPANY_ID = :THISCOMPANY AND P1.COMPANY_ID IS NOT NULL) 

    ORDER BY SSN_HIST.DEVICE_ID, ISSN.PROD_ID, ISSN.ORIGINAL_SSN, SSN_HIST.TRN_DATE 
/* need sorting by prod, device and date 
   ie device before ssn_hist.ssn_id except when ssn_id is a product 
   so must use the transactions_work for this
*/

  INTO
:WK_TRNTYPE,
:WK_TRNCODE,
:WK_WH_ID,
:WK_LOCN_ID,
:WK_SSN_ID,
:WK_QTY,
:WK_PROD_ID,
:WK_DESC1,
:WK_COMP1,
:WK_SSN_ID2,
:WK_PROD_ID2,
:WK_DEVICE,
:WK_TRANSFER_QTY
 
  DO
  BEGIN
/*
    insert into log(description) values ('WH' || :WK_WH_ID || 'LOCN' || :WK_LOCN_ID || ' type ' || :WK_TRNTYPE || ' code ' || :WK_TRNCODE || ' ssn ' || :WK_SSN_ID || ' device ' || :WK_DEVICE);
    insert into log(description) values ('comp' || :WK_COMP1);
    insert into log(description) values ('comp2' || :WK_COMP2);
    insert into log(description) values ('ssn2' || :WK_SSN_ID2);
    insert into log(description) values ('prod2' || :WK_PROD_ID);
    insert into log(description) values ('prod3' || :WK_PROD_ID2);
    insert into log(description) values ('prod4' || :WK_PROD_ID3);
*/
     /* needs
     on change of product set from and to wh & locn = ''
     if either is '' at a suspend stage must not write yet
     */
     /* IF (WK_COMP1 = :THISCOMPANY OR WK_COMP2 = :THISCOMPANY) THEN */
     BEGIN
        WK_HAVE_DATA = 'Y';

        IF (WK_TRNTYPE = 'TROL' OR WK_TRNTYPE = 'TRLO') THEN
        BEGIN
           WK_LAST_FROM_WH_ID = WK_CURRENT_FROM_WH_ID;
           WK_LAST_FROM_LOCN_ID = WK_CURRENT_FROM_LOCN_ID;
           WK_LAST_FROM_QTY = WK_CURRENT_FROM_QTY;
           WK_CURRENT_FROM_WH_ID = WK_WH_ID;
           WK_CURRENT_FROM_LOCN_ID = WK_LOCN_ID;
           WK_CURRENT_FROM_QTY = WK_CURRENT_FROM_QTY + WK_TRANSFER_QTY;
           WK_CHANGE = 'FROM';
           WK_LAST_TO_WH_ID = WK_CURRENT_TO_WH_ID;
           WK_LAST_TO_LOCN_ID = WK_CURRENT_TO_LOCN_ID;
           WK_LAST_TO_QTY = WK_CURRENT_TO_QTY;
           WK_CURRENT_TO_WH_ID = '';
           WK_CURRENT_TO_LOCN_ID = '';
           WK_CURRENT_TO_QTY = 0;
    /* insert into log(description) values ('changed from'); */

        END
        IF (WK_TRNTYPE = 'TRIL' OR WK_TRNTYPE = 'TRLI') THEN
        BEGIN
           WK_LAST_TO_WH_ID = WK_CURRENT_TO_WH_ID;
           WK_LAST_TO_LOCN_ID = WK_CURRENT_TO_LOCN_ID;
           WK_LAST_TO_QTY = WK_CURRENT_TO_QTY;
           WK_CURRENT_TO_WH_ID = WK_WH_ID;
           WK_CURRENT_TO_LOCN_ID = WK_LOCN_ID;
           WK_CURRENT_TO_QTY = WK_CURRENT_TO_QTY + WK_TRANSFER_QTY;
           WK_CHANGE = 'TO';
    /* insert into log(description) values ('changed to'); */
        END
/*
        IF (WK_TRNTYPE = 'TROL' AND WK_TRNCODE = 'P') THEN
        BEGIN
           -* here the ssn_id is the product *-
           WK_CURRENT_PROD_ID = WK_SSN_ID;
           WK_CURRENT_DESC = WK_DESC2;
        END
        ELSE
*/
        BEGIN
           /* here the ssn_id is the issns ssn */
           WK_CURRENT_PROD_ID = WK_PROD_ID;
           WK_CURRENT_DESC = WK_DESC1;
        END
        IF (WK_FIRST_DATA  = 'Y') THEN
        BEGIN
           PROD_ID = WK_CURRENT_PROD_ID;
           WH_ID1 = WK_CURRENT_FROM_WH_ID;
           LOCN_ID1 = WK_CURRENT_FROM_LOCN_ID;
           WH_ID2 = WK_CURRENT_TO_WH_ID;
           LOCN_ID2 = WK_CURRENT_TO_LOCN_ID;
           DESCRIPTION = WK_CURRENT_DESC;
           LOC_QTY_1 = 0;
           LOC_QTY_2 = 0;
           WK_FIRST_DATA = 'N';
    /* insert into log(description) values ('first data'); */
        END
        IF ((WK_CURRENT_PROD_ID <> PROD_ID) OR 
            (WK_CURRENT_FROM_WH_ID <> WH_ID1) OR 
            (WK_CURRENT_FROM_LOCN_ID <> LOCN_ID1) OR 
            (WK_CURRENT_TO_WH_ID <> WH_ID2) OR 
            (WK_CURRENT_TO_LOCN_ID <> LOCN_ID2))  THEN
        BEGIN
    /* insert into log(description) values ('differences'); */
           IF (WK_CHANGE = 'FROM') THEN
           BEGIN
              LOC_QTY_1 = WK_LAST_FROM_QTY;
              LOC_QTY_2 = WK_LAST_TO_QTY;
              WH_ID1 = WK_LAST_FROM_WH_ID;
              LOCN_ID1 = WK_LAST_FROM_LOCN_ID;
              WH_ID2 = WK_LAST_TO_WH_ID;
              LOCN_ID2 = WK_LAST_TO_LOCN_ID;
              WK_HAVE_DATA = 'N';
              /* SUSPEND; */
              WK_FOUND = 0;
              SELECT 1
              FROM TRANSACTIONS_WORK 
              WHERE RECORD_ID = :WK_REC_ID
                AND OBJECT = :PROD_ID
                AND WH_ID = :WK_LAST_FROM_WH_ID
                AND LOCN_ID = :WK_LAST_FROM_LOCN_ID
                AND WH_ID2 = :WK_LAST_TO_WH_ID
                AND LOCN_ID2 = :WK_LAST_TO_LOCN_ID
              INTO :WK_FOUND;
              IF (WK_FOUND = 0) THEN
              BEGIN
                 INSERT INTO TRANSACTIONS_WORK(RECORD_ID, OBJECT, DESCRIPTION, WH_ID, LOCN_ID, QTY, WH_ID2, LOCN_ID2, QTY2)
                 VALUES (:WK_REC_ID, :PROD_ID, :DESCRIPTION, :WK_LAST_FROM_WH_ID, :WK_LAST_FROM_LOCN_ID, :WK_LAST_FROM_QTY, :WK_LAST_TO_WH_ID, :WK_LAST_TO_LOCN_ID, :WK_LAST_TO_QTY);
              END
              ELSE
              BEGIN
                 UPDATE TRANSACTIONS_WORK
                    SET QTY = QTY + :WK_LAST_FROM_QTY,
                        QTY2 = QTY2 + :WK_LAST_TO_QTY
                 WHERE RECORD_ID = :WK_REC_ID
                   AND OBJECT = :PROD_ID
                   AND WH_ID = :WK_LAST_FROM_WH_ID
                   AND LOCN_ID = :WK_LAST_FROM_LOCN_ID
                   AND WH_ID2 = :WK_LAST_TO_WH_ID
                   AND LOCN_ID2 = :WK_LAST_TO_LOCN_ID;
              END
    /* insert into log(description) values ('suspended'); */
           END
           IF (WK_CURRENT_PROD_ID <> PROD_ID) THEN
           BEGIN
    /* insert into log(description) values ('prod changed'); */
              PROD_ID = WK_CURRENT_PROD_ID;
              DESCRIPTION = WK_CURRENT_DESC;
           END
           WH_ID1 = WK_CURRENT_FROM_WH_ID;
           LOCN_ID1 = WK_CURRENT_FROM_LOCN_ID;
           WH_ID2 = WK_CURRENT_TO_WH_ID;
           LOCN_ID2 = WK_CURRENT_TO_LOCN_ID;
           LOC_QTY_1 = 0;
           LOC_QTY_2 = 0;
           IF (WK_HAVE_DATA = 'N') THEN
           BEGIN
              IF (WK_CHANGE = 'FROM') THEN
              BEGIN
                 WK_CURRENT_FROM_QTY = WK_CURRENT_FROM_QTY - WK_LAST_FROM_QTY; 
                 WK_CURRENT_TO_QTY = 0;
              END
              ELSE
              BEGIN
                 WK_CURRENT_FROM_QTY = 0;
                 WK_CURRENT_TO_QTY = WK_CURRENT_TO_QTY - WK_LAST_TO_QTY;
              END
    /* insert into log(description) values ('qtys reset'); */
           END
        END
     END
  END
  IF (WK_HAVE_DATA = 'Y') THEN
  BEGIN
     LOC_QTY_1 = WK_CURRENT_FROM_QTY;
     LOC_QTY_2 = WK_CURRENT_TO_QTY;
     /* SUSPEND; */
    /* insert into log(description) values ('final record'); */
     WK_FOUND = 0;
     SELECT 1
     FROM TRANSACTIONS_WORK 
     WHERE RECORD_ID = :WK_REC_ID
       AND OBJECT = :PROD_ID
       AND WH_ID = :WK_CURRENT_FROM_WH_ID
       AND LOCN_ID = :WK_CURRENT_FROM_LOCN_ID
       AND WH_ID2 = :WK_CURRENT_TO_WH_ID
       AND LOCN_ID2 = :WK_CURRENT_TO_LOCN_ID
     INTO :WK_FOUND;
     IF (WK_FOUND = 0) THEN
     BEGIN
        INSERT INTO TRANSACTIONS_WORK(RECORD_ID, OBJECT, DESCRIPTION, WH_ID, LOCN_ID, QTY, WH_ID2, LOCN_ID2, QTY2)
        VALUES (:WK_REC_ID, :PROD_ID, :DESCRIPTION, :WK_CURRENT_FROM_WH_ID, :WK_CURRENT_FROM_LOCN_ID, :WK_CURRENT_FROM_QTY, :WK_CURRENT_TO_WH_ID, :WK_CURRENT_TO_LOCN_ID, :WK_CURRENT_TO_QTY);
     END
     ELSE
     BEGIN
        UPDATE TRANSACTIONS_WORK
           SET QTY = QTY + :WK_CURRENT_FROM_QTY,
               QTY2 = QTY2 + :WK_CURRENT_TO_QTY
        WHERE RECORD_ID = :WK_REC_ID
          AND OBJECT = :PROD_ID
          AND WH_ID = :WK_CURRENT_FROM_WH_ID
          AND LOCN_ID = :WK_CURRENT_FROM_LOCN_ID
          AND WH_ID2 = :WK_CURRENT_TO_WH_ID
          AND LOCN_ID2 = :WK_CURRENT_TO_LOCN_ID;
     END
  END
  FOR SELECT OBJECT,
    DESCRIPTION,
    WH_ID,
    LOCN_ID,
    QTY,
    WH_ID2,
    LOCN_ID2,
    QTY2 
  FROM TRANSACTIONS_WORK 
  WHERE RECORD_ID = :WK_REC_ID
  ORDER BY RECORD_ID,
    DESCRIPTION,
    WH_ID,
    LOCN_ID,
    WH_ID2,
    LOCN_ID2 
  INTO :PROD_ID,
       :DESCRIPTION,
       :WH_ID1,
       :LOCN_ID1,
       :LOC_QTY_1,
       :WH_ID2,
       :LOCN_ID2,
       :LOC_QTY_2
  DO
  BEGIN
     SUSPEND;
  END
  
END ^

ALTER PROCEDURE RPT_BUSINESS_MONTHLY_3_DATA (THISCOMPANY VARCHAR(20) CHARACTER SET NONE,
THISSTART TIMESTAMP,
THISEND TIMESTAMP)
RETURNS (PROD_ID VARCHAR(30) CHARACTER SET NONE,
SHORT_DESC VARCHAR(50) CHARACTER SET NONE,
QTY INTEGER,
COMPANY_ID VARCHAR(30) CHARACTER SET NONE)
AS 

BEGIN
  /* PROCEDURE BODY */
  FOR
 SELECT PROD_PROFILE.PROD_ID, PROD_PROFILE.SHORT_DESC, SUM(ISSN.PREV_QTY), PROD_PROFILE.COMPANY_ID 
FROM ISSN
   INNER JOIN PROD_PROFILE ON ISSN.PROD_ID = PROD_PROFILE.PROD_ID
   WHERE PROD_PROFILE.COMPANY_ID = :THISCOMPANY
   AND (ISSN.DESPATCHED_DATE BETWEEN ZEROTIME(:THISSTART) AND MAXTIME(:THISEND))
   GROUP BY PROD_PROFILE.COMPANY_ID, PROD_PROFILE.PROD_ID,PROD_PROFILE.SHORT_DESC
  INTO
:PROD_ID,
:SHORT_DESC,
:QTY,
:COMPANY_ID
  DO
  BEGIN
  SUSPEND;
  END
END ^

ALTER PROCEDURE RPT_CANCELLED_DATA (THISPICK_ORDER VARCHAR(50) CHARACTER SET NONE)
RETURNS (PICK_ORDER VARCHAR(50) CHARACTER SET NONE,
SHORT_DESC VARCHAR(50) CHARACTER SET NONE,
PROD_ID VARCHAR(50) CHARACTER SET NONE,
PICK_LABEL_NO VARCHAR(50) CHARACTER SET NONE)
AS 

BEGIN
  /* PROCEDURE BODY */
  FOR
 SELECT PICK_ITEM.PICK_ORDER, PROD_PROFILE.SHORT_DESC, PICK_ITEM.PROD_ID, PICK_ITEM.PICK_LABEL_NO
FROM PICK_ITEM
 INNER JOIN PICK_ITEM_DETAIL ON PICK_ITEM.PICK_LABEL_NO = PICK_ITEM_DETAIL.PICK_LABEL_NO
 LEFT OUTER JOIN PROD_PROFILE ON PROD_PROFILE.PROD_ID = PICK_ITEM.PROD_ID
 WHERE PICK_DETAIL_STATUS = 'XX' AND PICK_ITEM.PICK_ORDER = :THISPICK_ORDER
ORDER BY PICK_ITEM.PROD_ID

  INTO
:PICK_ORDER,
:SHORT_DESC ,
:PROD_ID,
:PICK_LABEL_NO 

  DO
  BEGIN
  SUSPEND;
  END
END ^

ALTER PROCEDURE RPT_CANCEL_ORDER_DATA (THISPICK_LABEL_NO VARCHAR(50) CHARACTER SET NONE)
RETURNS (FROM_LOCN_ID VARCHAR(50) CHARACTER SET NONE,
QTYSUM INTEGER,
FROM_WH_ID VARCHAR(50) CHARACTER SET NONE)
AS 

BEGIN
  /* PROCEDURE BODY */
  FOR
  SELECT  DISTINCT(FROM_LOCN_ID), SUM(QTY_PICKED) ,FROM_WH_ID 
  FROM PICK_ITEM_DETAIL
  WHERE  PICK_ITEM_DETAIL.PICK_LABEL_NO = :THISPICK_LABEL_NO AND  
         QTY_PICKED > 0
  GROUP BY FROM_WH_ID, FROM_LOCN_ID

  INTO
:FROM_LOCN_ID,
:QTYSUM,
:FROM_WH_ID
  DO
  BEGIN
  SUSPEND;
  END
END ^

ALTER PROCEDURE RPT_DAILY_1_A_DATA (THISSTART TIMESTAMP,
THISEND TIMESTAMP)
RETURNS (THISCOUNT INTEGER)
AS 

BEGIN
  /* PROCEDURE BODY */
  SELECT COUNT(DISTINCT REFERENCE) FROM TRANSACTIONS_ARCHIVE
  WHERE   TRN_TYPE = 'DSDX'
   AND (TRN_DATE BETWEEN ZEROTIME(:THISSTART) AND MAXTIME(:THISEND))
   AND COMPLETE IS NULL
  INTO
  :THISCOUNT;
  SUSPEND;
END ^

ALTER PROCEDURE RPT_DAILY_1_B_DATA (THISSTART TIMESTAMP,
THISEND TIMESTAMP)
RETURNS (THISCOUNT INTEGER)
AS 

BEGIN
  /* PROCEDURE BODY */
  FOR SELECT COUNT(*) FROM PICK_ORDER
  WHERE   PICK_STATUS = 'CN'
   AND (ORDER_CANCELLED BETWEEN ZEROTIME(:THISSTART) AND MAXTIME(:THISEND))
  INTO
  :THISCOUNT
  DO
  BEGIN
  SUSPEND;
  END
END ^

ALTER PROCEDURE RPT_DAILY_2_A_DATA (THISSTART TIMESTAMP,
THISEND TIMESTAMP)
RETURNS (QTYTOTAL INTEGER,
PROD_ID VARCHAR(50) CHARACTER SET NONE,
SHORT_DESC VARCHAR(50) CHARACTER SET NONE)
AS 
 

BEGIN
  /* PROCEDURE BODY */
  FOR

 SELECT SUM(ISSN.PREV_QTY), ISSN.PROD_ID, PROD_PROFILE.SHORT_DESC
 FROM ISSN
 LEFT OUTER  JOIN PROD_PROFILE ON ISSN.PROD_ID = PROD_PROFILE.PROD_ID
 WHERE (ISSN.DESPATCHED_DATE BETWEEN ZEROTIME(:THISSTART) AND MAXTIME(:THISEND))
 GROUP BY ISSN.PROD_ID,PROD_PROFILE.SHORT_DESC

  INTO
  :QTYTOTAL,
  :PROD_ID,
  :SHORT_DESC
  DO
  BEGIN
  SUSPEND;
  END
END ^

ALTER PROCEDURE RPT_DAILY_2_B_DATA (THISSTART TIMESTAMP,
THISEND TIMESTAMP)
RETURNS (QTYTOTAL INTEGER,
PROD_ID VARCHAR(50) CHARACTER SET NONE,
SHORT_DESC VARCHAR(50) CHARACTER SET NONE)
AS 
 

BEGIN
  /* PROCEDURE BODY */
  FOR
 SELECT SUM(PICK_ITEM_CANCEL.PICK_ORDER_QTY), PICK_ITEM_CANCEL.PROD_ID, PROD_PROFILE.SHORT_DESC
 FROM PICK_ITEM_CANCEL
 LEFT OUTER  JOIN PROD_PROFILE ON PICK_ITEM_CANCEL.PROD_ID = PROD_PROFILE.PROD_ID
 WHERE (PICK_ITEM_CANCEL.LAST_UPDATE_DATE BETWEEN ZEROTIME(:THISSTART) AND MAXTIME(:THISEND))
 AND PICK_ITEM_CANCEL.CANCEL_METHOD='O'
 GROUP BY PICK_ITEM_CANCEL.PROD_ID,PROD_PROFILE.SHORT_DESC
  INTO
  :QTYTOTAL,
  :PROD_ID,
  :SHORT_DESC
  DO
  BEGIN
  SUSPEND;
  END
END ^

ALTER PROCEDURE RPT_DAILY_3_DATA (THISSTART TIMESTAMP,
THISEND TIMESTAMP)
RETURNS (THISCOUNT INTEGER)
AS 
 

BEGIN
  /* PROCEDURE BODY */
  /* pick was started after the too date */
  THISCOUNT = 0;
  /* OR (PICK_ITEM.PICK_STARTED IS NULL)) */
  SELECT COUNT(DISTINCT PICK_ITEM.PICK_ORDER) 
  FROM PICK_ITEM
  LEFT OUTER JOIN PICK_ORDER ON PICK_ORDER.PICK_ORDER = PICK_ITEM.PICK_ORDER
  WHERE   ((PICK_ITEM.PICK_STARTED > MAXTIME(:THISEND))
  OR ((PICK_ITEM.PICK_STARTED IS NULL ) AND (PICK_ORDER.ORDER_CANCELLED IS NULL))
  OR ((PICK_ITEM.PICK_STARTED IS NULL ) AND (PICK_ORDER.ORDER_CANCELLED > MAXTIME(:THISEND))))
  AND (PICK_ITEM.CREATE_DATE <= MAXTIME(:THISEND))
  INTO
  :THISCOUNT;
  SUSPEND;
END ^

ALTER PROCEDURE RPT_DAILY_4_A_DATA (THISSTART TIMESTAMP,
THISEND TIMESTAMP)
RETURNS (QTYTOTAL INTEGER,
PROD_ID VARCHAR(50) CHARACTER SET NONE,
SHORT_DESC VARCHAR(50) CHARACTER SET NONE)
AS 
 
DECLARE VARIABLE WK_RESULT INTEGER;

BEGIN
  /* PROCEDURE BODY */
   WK_RESULT = FILE_WRITE('d:/tmp/daily4a.log', 'log4a');
/*
 SELECT COUNT(*) AS QTYTOTAL,PICK_ITEM.PROD_ID,PROD_PROFILE.SHORT_DESC  FROM TRANSACTIONS_ARCHIVE
LEFT OUTER  JOIN PICK_ITEM ON TRANSACTIONS_ARCHIVE.OBJECT = PICK_ITEM.PICK_ORDER
LEFT OUTER  JOIN PROD_PROFILE ON PICK_ITEM.PROD_ID = PROD_PROFILE.PROD_ID
WHERE TRN_TYPE = 'PKAL'
GROUP BY PICK_ITEM.PROD_ID,PROD_PROFILE.SHORT_DESC
*/
/*
  OR (PICK_ITEM.PICK_STARTED IS NULL))
*/
  FOR
  SELECT SUM(PICK_ITEM.PICK_ORDER_QTY), PICK_ITEM.PROD_ID ,PROD_PROFILE.SHORT_DESC  
  FROM PICK_ITEM
  LEFT OUTER  JOIN PROD_PROFILE ON PICK_ITEM.PROD_ID = PROD_PROFILE.PROD_ID
  LEFT OUTER JOIN PICK_ORDER ON PICK_ORDER.PICK_ORDER = PICK_ITEM.PICK_ORDER
  WHERE   ((PICK_ITEM.PICK_STARTED > MAXTIME(:THISEND))
  OR ((PICK_ITEM.PICK_STARTED IS NULL ) AND (PICK_ORDER.ORDER_CANCELLED IS NULL))
  OR ((PICK_ITEM.PICK_STARTED IS NULL ) AND (PICK_ORDER.ORDER_CANCELLED > MAXTIME(:THISEND))))
  AND (PICK_ITEM.CREATE_DATE <= MAXTIME(:THISEND))
  GROUP BY PICK_ITEM.PROD_ID,PROD_PROFILE.SHORT_DESC

  INTO
  :QTYTOTAL,
  :PROD_ID,
  :SHORT_DESC
  DO
  BEGIN
  SUSPEND;
  END
END ^

ALTER PROCEDURE RPT_DAILY_4_B_DATA (THISSTART TIMESTAMP,
THISEND TIMESTAMP)
RETURNS (QTYTOTAL INTEGER,
PROD_ID VARCHAR(50) CHARACTER SET NONE,
SHORT_DESC VARCHAR(50) CHARACTER SET NONE)
AS 
 
DECLARE VARIABLE WK_RESULT INTEGER;

BEGIN
  /* PROCEDURE BODY */
   WK_RESULT = FILE_WRITE('d:/tmp/daily4b.log', 'log4b');
  FOR

 SELECT COUNT(*) AS QTYTOTAL,PICK_ITEM.PROD_ID,PROD_PROFILE.SHORT_DESC  FROM TRANSACTIONS_ARCHIVE
LEFT OUTER  JOIN PICK_ITEM ON TRANSACTIONS_ARCHIVE.OBJECT = PICK_ITEM.PICK_ORDER
LEFT OUTER  JOIN PROD_PROFILE ON PICK_ITEM.PROD_ID = PROD_PROFILE.PROD_ID
WHERE TRN_TYPE = 'PKAL'
/* --AND (TRN_DATE >= :THISSTART AND TRN_DATE <= :THISEND) */
GROUP BY PICK_ITEM.PROD_ID,PROD_PROFILE.SHORT_DESC

  INTO
  :QTYTOTAL,
  :PROD_ID,
  :SHORT_DESC
  DO
  BEGIN
  SUSPEND;
  END
END ^

ALTER PROCEDURE RPT_DAILY_4_DATA (THISSTART TIMESTAMP,
THISEND TIMESTAMP)
RETURNS (THISCOUNT INTEGER)
AS 

BEGIN
  /* PROCEDURE BODY */
/*
  FOR SELECT COUNT(*) AS THISCOUNT  FROM TRANSACTIONS_ARCHIVE
  WHERE   TRN_TYPE = 'PKAL' AND (TRN_DATE >= :THISSTART AND TRN_DATE <= :THISEND)
  INTO
  :THISCOUNT
  DO
  BEGIN
  SUSPEND;
  END
*/
END ^

ALTER PROCEDURE RPT_DAILY_5_DATA (THISSTART TIMESTAMP,
THISEND TIMESTAMP)
RETURNS (THISCOUNT INTEGER)
AS 

BEGIN
  /* PROCEDURE BODY */
  /* the total orders picking in progress */
SELECT  COUNT(DISTINCT(PICK_ITEM.PICK_ORDER))
FROM PICK_ITEM 
WHERE PICK_ITEM.PICK_LINE_STATUS IN ('AL','PG','PL') 
AND (PICK_ITEM.DESPATCH_LOCATION IS NULL)
AND (PICK_ITEM.PICK_STARTED <= MAXTIME(:THISSTART) )
  INTO
  :THISCOUNT;
  SUSPEND;
END ^

ALTER PROCEDURE RPT_DAILY_6_DATA (THISSTART TIMESTAMP,
THISEND TIMESTAMP)
RETURNS (THISCOUNT INTEGER)
AS 

BEGIN
  /* PROCEDURE BODY */
  /* the total orders picked but not despatched */
  FOR
SELECT  COUNT(DISTINCT(PICK_ITEM.PICK_ORDER))
FROM PICK_ITEM 
WHERE PICK_ITEM.PICK_LINE_STATUS IN ('PL','DS') AND
      (PICK_ITEM.DESPATCH_LOCATION IS NOT NULL) 
AND (PICK_ITEM.PICK_STARTED <= MAXTIME(:THISSTART) )
  INTO
  :THISCOUNT
  DO
  BEGIN
  SUSPEND;
  END
/*
SELECT  COUNT(DISTINCT(PICK_ITEM.PICK_ORDER))
FROM PICK_ITEM 
LEFT OUTER JOIN PICK_ITEM P2 ON P2.PICK_ORDER = PICK_ITEM.PICK_ORDER
AND P2.PICK_LABEL_NO <> PICK_ITEM.PICK_LABEL_NO
AND P2.PICK_LINE_STATUS IN ('AL','PG','PL')
AND P2.DESPATCH_LOCATION IS NULL
WHERE PICK_ITEM.PICK_LINE_STATUS IN ('PL','DS') AND
      (PICK_ITEM.DESPATCH_LOCATION IS NOT NULL) AND
      (P2.PICK_LABEL_NO IS NULL)
*/
/*
SELECT  COUNT(DISTINCT(PICK_ITEM.PICK_ORDER))
FROM PICK_ORDER
INNER JOIN PICK_ITEM ON PICK_ORDER.PICK_ORDER = PICK_ITEM.PICK_ORDER
INNER JOIN SYS_USER ON PICK_ITEM.USER_ID = SYS_USER.USER_ID
WHERE (PICK_ORDER.ASSEMBLY_STARTED BETWEEN ZEROTIME(:THISSTART) AND MAXTIME(:THISEND))
  INTO
  :THISCOUNT
  DO
  BEGIN
  SUSPEND;
  END
*/
END ^

ALTER PROCEDURE RPT_PRODUCT_LEVELS_DATA (THISWHID VARCHAR(4) CHARACTER SET NONE)
RETURNS (LOCN_ID VARCHAR(50) CHARACTER SET NONE,
PROD_ID VARCHAR(50) CHARACTER SET NONE,
CURRENT_QTY INTEGER,
SHORT_DES VARCHAR(50) CHARACTER SET NONE,
THISSTATUS VARCHAR(40) CHARACTER SET NONE)
AS 

BEGIN
  /* PROCEDURE BODY */
  FOR
   SELECT ISSN.LOCN_ID,ISSN.PROD_ID,ISSN.CURRENT_QTY,PROD_PROFILE.SHORT_DESC, ISSN.ISSN_STATUS 

   FROM ISSN
   LEFT OUTER JOIN PROD_PROFILE ON ISSN.PROD_ID = PROD_PROFILE.PROD_ID
   WHERE ISSN.WH_ID = :THISWHID
   ORDER BY ISSN.LOCN_ID, ISSN.PROD_ID

  INTO
  :LOCN_ID,
  :PROD_ID,
  :CURRENT_QTY,
  :SHORT_DES,
  :THISSTATUS
  DO
  BEGIN
  SUSPEND;
  END
END ^

ALTER PROCEDURE RPT_PRODUCT_RECEIPT_DATA (THISPROD_ID VARCHAR(30) CHARACTER SET NONE,
THISMODE INTEGER,
THISSTART TIMESTAMP,
THISEND TIMESTAMP)
RETURNS (PROD VARCHAR(30) CHARACTER SET NONE,
QTY INTEGER,
TRN_DATE TIMESTAMP,
THISGRN VARCHAR(30) CHARACTER SET NONE,
LOCN_ID VARCHAR(30) CHARACTER SET NONE,
SHORT_DESC VARCHAR(50) CHARACTER SET NONE)
AS 
 

BEGIN
  /* PROCEDURE BODY */
   IF (THISMODE = 0) THEN
   BEGIN
      FOR
      SELECT TRANSACTIONS_ARCHIVE.OBJECT , SUM(TRANSACTIONS_ARCHIVE.QTY), ZEROTIME(TRANSACTIONS_ARCHIVE.TRN_DATE), TRANSACTIONS_ARCHIVE.SUB_LOCN_ID , TRANSACTIONS_ARCHIVE.LOCN_ID,PROD_PROFILE.SHORT_DESC
      FROM TRANSACTIONS_ARCHIVE
      JOIN PROD_PROFILE ON TRANSACTIONS_ARCHIVE.OBJECT = PROD_PROFILE.PROD_ID
      WHERE TRANSACTIONS_ARCHIVE.TRN_TYPE = 'GRNV' AND 
         TRANSACTIONS_ARCHIVE.TRN_CODE IN  ('P','Q') AND 
         TRANSACTIONS_ARCHIVE.OBJECT = :THISPROD_ID AND
         (TRANSACTIONS_ARCHIVE.TRN_DATE BETWEEN ZEROTIME(:THISSTART) AND MAXTIME(:THISEND))
       GROUP BY TRANSACTIONS_ARCHIVE.OBJECT, ZEROTIME(TRANSACTIONS_ARCHIVE.TRN_DATE),TRANSACTIONS_ARCHIVE.LOCN_ID,TRANSACTIONS_ARCHIVE.SUB_LOCN_ID,PROD_PROFILE.SHORT_DESC
      INTO
      :PROD,
      :QTY,
      :TRN_DATE,
      :THISGRN,
      :LOCN_ID,
      :SHORT_DESC
      DO
      BEGIN
         SUSPEND;
      END
   END
END ^

ALTER PROCEDURE RPT_PRODUCT_RECEIPT_GRN_DATA (THISPROD_LIST VARCHAR(1240) CHARACTER SET NONE,
THISSTART TIMESTAMP,
THISEND TIMESTAMP)
RETURNS (PROD VARCHAR(30) CHARACTER SET NONE,
QTY INTEGER,
TRN_DATE TIMESTAMP,
THISGRN VARCHAR(30) CHARACTER SET NONE,
LOCN_ID VARCHAR(30) CHARACTER SET NONE,
SHORT_DESC VARCHAR(50) CHARACTER SET NONE)
AS 

BEGIN
  /* PROCEDURE BODY */
   IF ((THISPROD_LIST IS NULL) OR (THISPROD_LIST = '')) THEN
   BEGIN
      FOR
      SELECT TRANSACTIONS_ARCHIVE.OBJECT , SUM(TRANSACTIONS_ARCHIVE.QTY), ZEROTIME(TRANSACTIONS_ARCHIVE.TRN_DATE), TRANSACTIONS_ARCHIVE.SUB_LOCN_ID , TRANSACTIONS_ARCHIVE.LOCN_ID,PROD_PROFILE.SHORT_DESC
      FROM TRANSACTIONS_ARCHIVE
      JOIN PROD_PROFILE ON TRANSACTIONS_ARCHIVE.OBJECT = PROD_PROFILE.PROD_ID
      WHERE TRANSACTIONS_ARCHIVE.TRN_TYPE = 'GRNV' AND 
         TRANSACTIONS_ARCHIVE.TRN_CODE IN  ('P','Q') AND 
         (TRANSACTIONS_ARCHIVE.TRN_DATE BETWEEN ZEROTIME(:THISSTART) AND MAXTIME(:THISEND))
       GROUP BY TRANSACTIONS_ARCHIVE.SUB_LOCN_ID, TRANSACTIONS_ARCHIVE.OBJECT, TRANSACTIONS_ARCHIVE.LOCN_ID, ZEROTIME(TRANSACTIONS_ARCHIVE.TRN_DATE), PROD_PROFILE.SHORT_DESC
      INTO
      :PROD,
      :QTY,
      :TRN_DATE,
      :THISGRN,
      :LOCN_ID,
      :SHORT_DESC
      DO
      BEGIN
         SUSPEND;
      END
   END
   ELSE
   BEGIN
      FOR
      SELECT TRANSACTIONS_ARCHIVE.OBJECT , SUM(TRANSACTIONS_ARCHIVE.QTY), ZEROTIME(TRANSACTIONS_ARCHIVE.TRN_DATE), TRANSACTIONS_ARCHIVE.SUB_LOCN_ID , TRANSACTIONS_ARCHIVE.LOCN_ID,PROD_PROFILE.SHORT_DESC
      FROM TRANSACTIONS_ARCHIVE
      JOIN PROD_PROFILE ON TRANSACTIONS_ARCHIVE.OBJECT = PROD_PROFILE.PROD_ID
      WHERE TRANSACTIONS_ARCHIVE.TRN_TYPE = 'GRNV' AND 
         TRANSACTIONS_ARCHIVE.TRN_CODE IN  ('P','Q') AND 
         (V4POS(:THISPROD_LIST,TRANSACTIONS_ARCHIVE.OBJECT,0,1) > -1) AND
         (TRANSACTIONS_ARCHIVE.TRN_DATE BETWEEN ZEROTIME(:THISSTART) AND MAXTIME(:THISEND))
       GROUP BY TRANSACTIONS_ARCHIVE.SUB_LOCN_ID, TRANSACTIONS_ARCHIVE.OBJECT, TRANSACTIONS_ARCHIVE.LOCN_ID, ZEROTIME(TRANSACTIONS_ARCHIVE.TRN_DATE), PROD_PROFILE.SHORT_DESC
      INTO
      :PROD,
      :QTY,
      :TRN_DATE,
      :THISGRN,
      :LOCN_ID,
      :SHORT_DESC
      DO
      BEGIN
         SUSPEND;
      END
   END
END ^

ALTER PROCEDURE RPT_PRODUCT_RECEIPT_PROD_DATA (THISPROD_LIST VARCHAR(1240) CHARACTER SET NONE,
THISSTART TIMESTAMP,
THISEND TIMESTAMP)
RETURNS (PROD VARCHAR(30) CHARACTER SET NONE,
QTY INTEGER,
TRN_DATE TIMESTAMP,
THISGRN VARCHAR(30) CHARACTER SET NONE,
LOCN_ID VARCHAR(30) CHARACTER SET NONE,
SHORT_DESC VARCHAR(50) CHARACTER SET NONE)
AS 

BEGIN
  /* PROCEDURE BODY */
   IF ((THISPROD_LIST IS NULL) OR (THISPROD_LIST = '')) THEN
   BEGIN
      FOR
      SELECT TRANSACTIONS_ARCHIVE.OBJECT , 
         SUM(TRANSACTIONS_ARCHIVE.QTY), 
         ZEROTIME(TRANSACTIONS_ARCHIVE.TRN_DATE), 
         TRANSACTIONS_ARCHIVE.SUB_LOCN_ID , 
         TRANSACTIONS_ARCHIVE.LOCN_ID,
         PROD_PROFILE.SHORT_DESC
      FROM TRANSACTIONS_ARCHIVE
      JOIN PROD_PROFILE ON TRANSACTIONS_ARCHIVE.OBJECT = PROD_PROFILE.PROD_ID
      WHERE TRANSACTIONS_ARCHIVE.TRN_TYPE = 'GRNV' AND
         TRANSACTIONS_ARCHIVE.TRN_CODE IN  ('P','Q') AND 
         (TRANSACTIONS_ARCHIVE.TRN_DATE BETWEEN 
         ZEROTIME(:THISSTART) AND MAXTIME(:THISEND))
       GROUP BY TRANSACTIONS_ARCHIVE.OBJECT, 
          ZEROTIME(TRANSACTIONS_ARCHIVE.TRN_DATE), 
          TRANSACTIONS_ARCHIVE.LOCN_ID, 
          TRANSACTIONS_ARCHIVE.SUB_LOCN_ID, 
          PROD_PROFILE.SHORT_DESC
      INTO
      :PROD,
      :QTY,
      :TRN_DATE,
      :THISGRN,
      :LOCN_ID,
      :SHORT_DESC
      DO
      BEGIN
         SUSPEND;
      END
   END
   ELSE
   BEGIN
      FOR
      SELECT TRANSACTIONS_ARCHIVE.OBJECT , 
         SUM(TRANSACTIONS_ARCHIVE.QTY), 
         ZEROTIME(TRANSACTIONS_ARCHIVE.TRN_DATE), 
         TRANSACTIONS_ARCHIVE.SUB_LOCN_ID , 
         TRANSACTIONS_ARCHIVE.LOCN_ID,PROD_PROFILE.SHORT_DESC
      FROM TRANSACTIONS_ARCHIVE
      JOIN PROD_PROFILE ON TRANSACTIONS_ARCHIVE.OBJECT = PROD_PROFILE.PROD_ID
      WHERE TRANSACTIONS_ARCHIVE.TRN_TYPE = 'GRNV' AND
         TRANSACTIONS_ARCHIVE.TRN_CODE IN  ('P','Q') AND 
         (V4POS(:THISPROD_LIST,TRANSACTIONS_ARCHIVE.OBJECT,0,1) > -1) AND
         (TRANSACTIONS_ARCHIVE.TRN_DATE BETWEEN 
          ZEROTIME(:THISSTART) AND MAXTIME(:THISEND))
       GROUP BY TRANSACTIONS_ARCHIVE.OBJECT, 
          ZEROTIME(TRANSACTIONS_ARCHIVE.TRN_DATE), 
          TRANSACTIONS_ARCHIVE.LOCN_ID, 
          TRANSACTIONS_ARCHIVE.SUB_LOCN_ID, 
          PROD_PROFILE.SHORT_DESC
      INTO
      :PROD,
      :QTY,
      :TRN_DATE,
      :THISGRN,
      :LOCN_ID,
      :SHORT_DESC
      DO
      BEGIN
         SUSPEND;
      END
   END
END ^

ALTER PROCEDURE RPT_SAFETY_CALIBRATION_EXPIRY (WK_DAYS INTEGER)
RETURNS (SN_SSN_TYPE VARCHAR(40) CHARACTER SET NONE,
SN_SSN_ID VARCHAR(20) CHARACTER SET NONE,
SN_WH_ID CHAR(2) CHARACTER SET NONE,
SN_LOCN_ID VARCHAR(10) CHARACTER SET NONE,
SN_SSN_DESCRIPTION VARCHAR(80) CHARACTER SET NONE,
SN_LAST_CALIBRATE_CHECK_DATE TIMESTAMP,
SN_CALIBRATE_PERIOD CHAR(1) CHARACTER SET NONE,
SN_CALIBRATE_PERIOD_NO INTEGER,
WK_CALIBRATE_DAYS_SINCE_CHECK INTEGER,
WK_CALIBRATE_EXPIRY_DATE TIMESTAMP,
SN_CALIBRATE_CHECK CHAR(1) CHARACTER SET NONE,
WK_CALIBRATE_DAYS_TO_CHECK INTEGER,
WK_CALIBRATE_PERIOD_DAY INTEGER,
WK_CALIBRATE_PERIOD_DAYS INTEGER,
SN_LAST_SAFETY_CHECK_DATE TIMESTAMP,
SN_SAFETY_PERIOD CHAR(1) CHARACTER SET NONE,
SN_SAFETY_PERIOD_NO INTEGER,
WK_SAFETY_DAYS_SINCE_CHECK INTEGER,
WK_SAFETY_EXPIRY_DATE TIMESTAMP,
SN_SAFETY_CHECK CHAR(1) CHARACTER SET NONE,
WK_SAFETY_DAYS_TO_CHECK INTEGER,
WK_SAFETY_PERIOD_DAY INTEGER,
WK_SAFETY_PERIOD_DAYS INTEGER,
WK_TEST_DATE TIMESTAMP,
WK_DAYS_USED INTEGER)
AS 
BEGIN
   WK_DAYS_USED = WK_DAYS;
   WK_TEST_DATE = MAKEDATE(MER_YEAR('TODAY'), MER_MONTH('TODAY'), MER_DAY('TODAY') + WK_DAYS, 0, 0, 0);
   FOR
      SELECT SSN.SSN_TYPE , 
      SSN.SSN_ID , 
      SSN.SSN_DESCRIPTION ,  
      SSN.LOAN_LAST_CALIBRATE_CHECK_DATE , 
      SSN.LOAN_LAST_SAFETY_CHECK_DATE , 
      SSN.WH_ID , 
      SSN.LOCN_ID,
      O2.CODE,
      O4.CODE,
      SSN.LOAN_CALIBRATE_CHECK,
      SSN.LOAN_SAFETY_CHECK,
      SSN.LOAN_CALIBRATE_PERIOD , 
      SSN.LOAN_CALIBRATE_PERIOD_NO , 
      SSN.LOAN_SAFETY_PERIOD , 
      SSN.LOAN_SAFETY_PERIOD_NO  
      FROM SSN 
      LEFT OUTER JOIN OPTIONS O1 ON O1.GROUP_CODE='SAFE_CALIB' AND SSN.LOAN_CALIBRATE_PERIOD = O1.CODE
      LEFT OUTER JOIN OPTIONS O2 ON O2.GROUP_CODE='LOAN_DAYS' AND O1.DESCRIPTION = O2.DESCRIPTION
      LEFT OUTER JOIN OPTIONS O3 ON O3.GROUP_CODE='SAFE_CALIB' AND SSN.LOAN_SAFETY_PERIOD = O3.CODE
      LEFT OUTER JOIN OPTIONS O4 ON O4.GROUP_CODE='LOAN_DAYS' AND O3.DESCRIPTION = O4.DESCRIPTION
      WHERE  LOAN_CALIBRATE_CHECK = 'T'
      OR     LOAN_SAFETY_CHECK = 'T'
      ORDER BY SSN.SSN_TYPE, SSN.WH_ID,SSN.LOCN_ID,SSN.SSN_ID
      INTO :SN_SSN_TYPE,
           :SN_SSN_ID,
           :SN_SSN_DESCRIPTION,
           :SN_LAST_CALIBRATE_CHECK_DATE,
           :SN_LAST_SAFETY_CHECK_DATE,
           :SN_WH_ID,
           :SN_LOCN_ID,
           :WK_CALIBRATE_PERIOD_DAY,
           :WK_SAFETY_PERIOD_DAY,
           :SN_CALIBRATE_CHECK,
           :SN_SAFETY_CHECK,
           :SN_CALIBRATE_PERIOD,
           :SN_CALIBRATE_PERIOD_NO,
           :SN_SAFETY_PERIOD,
           :SN_SAFETY_PERIOD_NO
   DO
   BEGIN
   
      WK_CALIBRATE_PERIOD_DAYS = NULL;
      WK_CALIBRATE_EXPIRY_DATE = NULL;
      WK_CALIBRATE_DAYS_SINCE_CHECK  = NULL;
      WK_CALIBRATE_DAYS_TO_CHECK  = NULL;
      WK_SAFETY_PERIOD_DAYS = NULL;
      WK_SAFETY_EXPIRY_DATE = NULL;
      WK_SAFETY_DAYS_SINCE_CHECK  = NULL;
      WK_SAFETY_DAYS_TO_CHECK  = NULL;
      IF (SN_CALIBRATE_CHECK = 'T') THEN
      BEGIN
         WK_CALIBRATE_DAYS_SINCE_CHECK  = 0;
         WK_CALIBRATE_DAYS_TO_CHECK  = 0;
         IF (SN_LAST_CALIBRATE_CHECK_DATE IS NOT NULL) THEN
         BEGIN
            IF (SN_LAST_CALIBRATE_CHECK_DATE > MAXTIME(WK_TEST_DATE)) THEN
            BEGIN
               WK_CALIBRATE_DAYS_SINCE_CHECK = 0 - DIFFDATE(WK_TEST_DATE, SN_LAST_CALIBRATE_CHECK_DATE, 4);
            END
            ELSE
            BEGIN
               WK_CALIBRATE_DAYS_SINCE_CHECK = DIFFDATE(SN_LAST_CALIBRATE_CHECK_DATE, WK_TEST_DATE, 4);
            END
            IF ((WK_CALIBRATE_PERIOD_DAY IS NOT NULL)  AND (SN_CALIBRATE_PERIOD_NO IS NOT NULL)) THEN
            BEGIN
               /* calculate days for period */
               WK_CALIBRATE_PERIOD_DAYS = WK_CALIBRATE_PERIOD_DAY * SN_CALIBRATE_PERIOD_NO;
               /* calculate expiry date */
               WK_CALIBRATE_EXPIRY_DATE = MAKEDATE(MER_YEAR(SN_LAST_CALIBRATE_CHECK_DATE), MER_MONTH(SN_LAST_CALIBRATE_CHECK_DATE), MER_DAY(SN_LAST_CALIBRATE_CHECK_DATE) + WK_CALIBRATE_PERIOD_DAYS, 0, 0, 0);
               IF (WK_CALIBRATE_EXPIRY_DATE > MAXTIME(WK_TEST_DATE)) THEN
               BEGIN
                  WK_CALIBRATE_DAYS_TO_CHECK = 0 - DIFFDATE(WK_TEST_DATE, WK_CALIBRATE_EXPIRY_DATE, 4);
               END
               ELSE
               BEGIN
                  WK_CALIBRATE_DAYS_TO_CHECK = DIFFDATE(WK_CALIBRATE_EXPIRY_DATE, WK_TEST_DATE, 4);
               END
            END
         END
      END
      IF (SN_SAFETY_CHECK = 'T') THEN
      BEGIN
         WK_SAFETY_DAYS_SINCE_CHECK  = 0;
         WK_SAFETY_DAYS_TO_CHECK  = 0;
         IF (SN_LAST_SAFETY_CHECK_DATE IS NOT NULL) THEN
         BEGIN
            IF (SN_LAST_SAFETY_CHECK_DATE > MAXTIME(WK_TEST_DATE)) THEN
            BEGIN
               WK_SAFETY_DAYS_SINCE_CHECK = 0 - DIFFDATE(WK_TEST_DATE, SN_LAST_SAFETY_CHECK_DATE, 4);
            END
            ELSE
            BEGIN
               WK_SAFETY_DAYS_SINCE_CHECK = DIFFDATE(SN_LAST_SAFETY_CHECK_DATE, WK_TEST_DATE, 4);
            END
            IF ((WK_SAFETY_PERIOD_DAY IS NOT NULL)  AND (SN_SAFETY_PERIOD_NO IS NOT NULL)) THEN
            BEGIN
               /* calculate days for period */
               WK_SAFETY_PERIOD_DAYS = WK_SAFETY_PERIOD_DAY * SN_SAFETY_PERIOD_NO;
               /* calculate expiry date */
               WK_SAFETY_EXPIRY_DATE = MAKEDATE(MER_YEAR(SN_LAST_SAFETY_CHECK_DATE), MER_MONTH(SN_LAST_SAFETY_CHECK_DATE), MER_DAY(SN_LAST_SAFETY_CHECK_DATE) + WK_SAFETY_PERIOD_DAYS, 0, 0, 0);
               IF (WK_SAFETY_EXPIRY_DATE > MAXTIME(WK_TEST_DATE)) THEN
               BEGIN
                  WK_SAFETY_DAYS_TO_CHECK = 0 - DIFFDATE(WK_TEST_DATE, WK_SAFETY_EXPIRY_DATE, 4);
               END
               ELSE
               BEGIN
                  WK_SAFETY_DAYS_TO_CHECK = DIFFDATE(WK_SAFETY_EXPIRY_DATE, WK_TEST_DATE, 4);
               END
            END
         END
      END
      IF ((WK_CALIBRATE_DAYS_TO_CHECK >= 0) OR (WK_SAFETY_DAYS_TO_CHECK >= 0)) THEN
      BEGIN
         SUSPEND;
      END
   END
END ^

ALTER PROCEDURE SEND_PICKABLE_STOCK (PROD_ID VARCHAR(30) CHARACTER SET NONE,
USER_ID VARCHAR(10) CHARACTER SET NONE,
DEVICE_ID CHAR(2) CHARACTER SET NONE,
TRN_DATE TIMESTAMP)
AS 
 
 
DECLARE VARIABLE WK_DO_UASL CHAR(1);
DECLARE VARIABLE WK_GM_MESSAGE VARCHAR(10);
DECLARE VARIABLE WK_T4_DELIM CHAR(1);
DECLARE VARIABLE WK_T4_TRAN_DATA VARCHAR(1024);
DECLARE VARIABLE WK_T4_SOURCE VARCHAR(512);
DECLARE VARIABLE WK_NEW_RECORD INTEGER;
DECLARE VARIABLE WK_CN_PRIORITY SMALLINT;
DECLARE VARIABLE WK_IMPORTSTATUS VARCHAR(40);
DECLARE VARIABLE WK_AVAILABLE_QTY INTEGER;
DECLARE VARIABLE WK_PROD VARCHAR(30);
DECLARE VARIABLE WK_EXTENSION VARCHAR(6);
DECLARE VARIABLE WK_PICKED_QTY INTEGER;
DECLARE VARIABLE WK_ORDER_QTY INTEGER;
DECLARE VARIABLE UNPICKED_ORDER_QTY INTEGER;
DECLARE VARIABLE UNPICKEDSTATUS VARCHAR(40);

BEGIN          
   SELECT SEND_UASL_V4 FROM CONTROL INTO :WK_DO_UASL;
   IF (WK_DO_UASL = 'T') THEN
   BEGIN      
      WK_CN_PRIORITY = 0;
      SELECT DEFAULT_PICK_PRIORITY, PICK_IMPORT_SSN_STATUS
      FROM CONTROL INTO :WK_CN_PRIORITY, :WK_IMPORTSTATUS; 
      /* get pickable qty of this product */
   
      IF (PROD_ID != 'NOPROD') THEN
      BEGIN
         SELECT SUM( ISSN.CURRENT_QTY ) 
               FROM ISSN
               WHERE ISSN.PROD_ID = :PROD_ID
               AND (POS(:WK_IMPORTSTATUS,ISSN.ISSN_STATUS,0,1) > -1)
               GROUP BY ISSN.PROD_ID
            INTO :WK_AVAILABLE_QTY;
         IF (WK_AVAILABLE_QTY IS NULL) THEN
         BEGIN
            WK_AVAILABLE_QTY = 0;
         END
         /* now must get qty on order not picked */
         SELECT CONTROL.PICK_UNPICKED_ITEM_STATUS
         FROM CONTROL
         INTO :UNPICKEDSTATUS;
         
         WK_PICKED_QTY = 0;
         WK_ORDER_QTY = 0;
         SELECT SUM( PICK_ITEM.PICK_ORDER_QTY ), 
                SUM( PICK_ITEM.PICKED_QTY ) 
                 FROM PICK_ITEM
                 WHERE PICK_ITEM.PROD_ID = :PROD_ID
                 AND (POS(:UNPICKEDSTATUS,PICK_ITEM.PICK_LINE_STATUS,0,1) > -1)
                 GROUP BY PICK_ITEM.PROD_ID
              INTO :WK_ORDER_QTY, :WK_PICKED_QTY;
         IF (WK_ORDER_QTY IS NULL) THEN
         BEGIN
            WK_ORDER_QTY = 0;
         END
         IF (WK_PICKED_QTY IS NULL) THEN
         BEGIN
            WK_PICKED_QTY = 0;
         END
         UNPICKED_ORDER_QTY = WK_ORDER_QTY - WK_PICKED_QTY;
         WK_AVAILABLE_QTY = WK_AVAILABLE_QTY - UNPICKED_ORDER_QTY;

         SELECT PROD_EAN, PROD_EAN_EXTENSION FROM PROD_EAN 
         WHERE PROD_ID = :PROD_ID
         INTO :WK_PROD, :WK_EXTENSION;
         IF (WK_EXTENSION IS NULL) THEN
         BEGIN
            WK_EXTENSION = '';
         END
         IF (PROD_ID IS NOT NULL) THEN
         BEGIN
            WK_GM_MESSAGE = '';
            SELECT MESSAGE_ID 
            FROM GET_NEXT_MESSAGE 
            INTO :WK_GM_MESSAGE;
            WK_T4_DELIM = '|';
            WK_T4_TRAN_DATA = USER_ID || WK_T4_DELIM ;
            WK_T4_TRAN_DATA = WK_T4_TRAN_DATA || DEVICE_ID || WK_T4_DELIM ;
            WK_T4_TRAN_DATA = WK_T4_TRAN_DATA || WK_GM_MESSAGE || WK_T4_DELIM ;
            WK_T4_TRAN_DATA = WK_T4_TRAN_DATA || '<EANNumber>' || PROD_ID || WK_T4_DELIM ;
            WK_T4_TRAN_DATA = WK_T4_TRAN_DATA || '<StockLevel>' || WK_AVAILABLE_QTY || WK_T4_DELIM ;
            IF (WK_EXTENSION > '') THEN
            BEGIN
               WK_T4_TRAN_DATA = WK_T4_TRAN_DATA || '<EANextension>' || WK_EXTENSION || WK_T4_DELIM ;
            END
            WK_T4_TRAN_DATA = WK_T4_TRAN_DATA || '<LiteratureStockStatus>ST' || WK_T4_DELIM ;
            WK_T4_TRAN_DATA = WK_T4_TRAN_DATA || '<UpdateDateTime>' || MER_YEAR(TRN_DATE) || '-' || LPAD(MER_MONTH(TRN_DATE),'0',2) || '-' || LPAD(MER_DAY(TRN_DATE),'0',2) || 'T' || LPAD(MER_HOUR(TRN_DATE),'0',2) || ':' || LPAD(MER_MINUTE(TRN_DATE),'0',2) || ':' || LPAD(SEC(TRN_DATE),'0',2) || WK_T4_DELIM ;
            /* WK_T4_TRAN_DATA = WK_T4_TRAN_DATA || '<UpdateDateTime>' || MER_YEAR(TRN_DATE) || '/' || MER_MONTH(TRN_DATE) || '/' || MER_DAY(TRN_DATE) || 'T' || MER_HOUR(TRN_DATE) || ':' || MER_MINUTE(TRN_DATE) || ':' || SEC(TRN_DATE) || WK_T4_DELIM ; */
            WK_T4_SOURCE = 'SSSSSSSS' ;
            SELECT REC_ID FROM ADD_TRAN_V4 ( 'V4', 'UASL','S',
               :TRN_DATE,
               :WK_T4_DELIM,
               :USER_ID,
               :DEVICE_ID,
               :WK_GM_MESSAGE,
               :WK_T4_TRAN_DATA,
               'F','','MASTER',0,
               :WK_T4_SOURCE)
            INTO :WK_NEW_RECORD;
            EXECUTE PROCEDURE ADD_MESSAGE_V4 ( 
               :WK_GM_MESSAGE,
              'V4', 'UASL','S',
               :TRN_DATE,
               :USER_ID,
               :DEVICE_ID,
               :WK_CN_PRIORITY,
               'WS','',NULL);
         END
      END
 
   END
                
END ^

ALTER PROCEDURE SEND_USER_EVENT (EVENT_NAME VARCHAR(127) CHARACTER SET NONE)
AS 
BEGIN
   POST_EVENT EVENT_NAME;
END ^

ALTER PROCEDURE SO_PICK_LOCATIONS (PICK_ORDER VARCHAR(15) CHARACTER SET NONE)
RETURNS (WH_ID CHAR(2) CHARACTER SET NONE,
LOCN_ID VARCHAR(10) CHARACTER SET NONE,
WH_ID2 CHAR(2) CHARACTER SET NONE,
LOCN_ID2 VARCHAR(10) CHARACTER SET NONE,
DESCRIPTION VARCHAR(80) CHARACTER SET NONE,
PICK_ORDER2 VARCHAR(15) CHARACTER SET NONE,
PICK_LABEL_NO VARCHAR(7) CHARACTER SET NONE,
SSN_ID VARCHAR(20) CHARACTER SET NONE,
PROD_ID VARCHAR(30) CHARACTER SET NONE,
PICK_ORDER_QTY INTEGER,
PICK_ALLOCATED_QTY INTEGER,
PICKED_QTY INTEGER,
PICK_LINE_DUE_DATE TIMESTAMP,
PICK_ORDER_LINE_NO CHAR(4) CHARACTER SET NONE)
AS 
 
 

DECLARE VARIABLE WK_ORIGINAL VARCHAR(20);
DECLARE VARIABLE WK_PI_WH CHAR(2);
DECLARE VARIABLE WK_PI_LOCN VARCHAR(10);
DECLARE VARIABLE WK_PROD_CNT INTEGER;
BEGIN
   /*
   first get fields from pick_item
   */
   /* ORDER BY PICK_ORDER_LINE_NO, PICK_LABEL_NO */

   FOR SELECT PICK_ITEM.PICK_ORDER,
          PICK_ITEM.PICK_LABEL_NO,
          PICK_ITEM.SSN_ID, 
          PICK_ITEM.PROD_ID, 
          PICK_ITEM.PICK_ORDER_QTY,
          PICK_ITEM.PICK_ORDER_LINE_NO,
          PICK_ITEM.PICK_ALLOCATED_QTY,
          PICK_ITEM.PICKED_QTY,
          PICK_ITEM.PICK_LINE_DUE_DATE
   FROM PICK_ITEM
   LEFT OUTER JOIN ISSN ON ISSN.SSN_ID = PICK_ITEM.SSN_ID
   WHERE PICK_ITEM.PICK_ORDER = :PICK_ORDER
   AND (PICK_ITEM.PICK_LINE_STATUS IN ('OP','UP'))
   ORDER BY PICK_ITEM.WIP_PRELOCN_ORDERING, ISSN.LOCN_ID, PICK_ITEM.PICK_LOCATION, PICK_ITEM.WIP_POSTLOCN_ORDERING 
   INTO :PICK_ORDER2, :PICK_LABEL_NO, :SSN_ID, :PROD_ID, :PICK_ORDER_QTY, :PICK_ORDER_LINE_NO, :PICK_ALLOCATED_QTY, :PICKED_QTY, :PICK_LINE_DUE_DATE 
   DO
   BEGIN
      IF (SSN_ID IS NULL) THEN
      BEGIN
         /* a product */
         WK_PROD_CNT = 0;
         /*  AND ISSN.ISSN_STATUS IN ('ST','PA','OP','AL','PG','PL') */
         FOR
         SELECT FIRST 2 ISSN.WH_ID, ISSN.LOCN_ID, PROD_PROFILE.SHORT_DESC 
         FROM ISSN 
              JOIN PROD_PROFILE ON PROD_PROFILE.PROD_ID = ISSN.PROD_ID
              JOIN CONTROL ON CONTROL.RECORD_ID = 1
         WHERE ISSN.PROD_ID = :PROD_ID 
           AND (WH_ID < 'X '
           OR WH_ID > 'X~')
           AND (POS(CONTROL.PICK_IMPORT_SSN_STATUS, ISSN.ISSN_STATUS, 0, 1) > -1)
         GROUP BY ISSN.WH_ID, ISSN.LOCN_ID, PROD_PROFILE.SHORT_DESC 
         INTO :WK_PI_WH, :WK_PI_LOCN, :DESCRIPTION  
         DO
         BEGIN
            IF (WK_PROD_CNT = 0) THEN
            BEGIN
               WH_ID = WK_PI_WH;
               LOCN_ID = WK_PI_LOCN;
            END
            IF (WK_PROD_CNT = 1) THEN
            BEGIN
               WH_ID2 = WK_PI_WH;
               LOCN_ID2 = WK_PI_LOCN;
            END
            WK_PROD_CNT = WK_PROD_CNT + 1;
         END
         IF (DESCRIPTION IS NULL) THEN
         BEGIN
            SELECT SHORT_DESC 
            FROM PROD_PROFILE 
            WHERE PROD_ID = :PROD_ID 
            INTO :DESCRIPTION;
         END
      END
      ELSE
      BEGIN
      /*
      now if for an ssn get the ssn details
      */
         SELECT ISSN.WH_ID, ISSN.LOCN_ID, SSN.SSN_DESCRIPTION, ISSN.ORIGINAL_SSN
         FROM ISSN
         JOIN SSN ON SSN.SSN_ID = ISSN.ORIGINAL_SSN
         WHERE ISSN.SSN_ID = :SSN_ID
         INTO :WH_ID, :LOCN_ID, :DESCRIPTION, :WK_ORIGINAL;
      /* get 2nd issn for ssn */
         SELECT FIRST 1 ISSN.WH_ID, ISSN.LOCN_ID 
         FROM ISSN
         WHERE ORIGINAL_SSN = :WK_ORIGINAL
         AND SSN_ID <> :SSN_ID
         AND (WH_ID < 'X '
         OR WH_ID > 'X~')
         AND (WH_ID <> :WH_ID 
         OR LOCN_ID <> :LOCN_ID)
         INTO :WH_ID2, :LOCN_ID2 ;
      END
      SUSPEND;
   END
END ^

ALTER PROCEDURE SO_PICK_LOCATIONS_ORDERSLIST (ORDER_LIST VARCHAR(32760) CHARACTER SET NONE)
RETURNS (WH_ID CHAR(2) CHARACTER SET NONE,
LOCN_ID VARCHAR(10) CHARACTER SET NONE,
WH_ID2 CHAR(2) CHARACTER SET NONE,
LOCN_ID2 VARCHAR(10) CHARACTER SET NONE,
DESCRIPTION VARCHAR(80) CHARACTER SET NONE,
SSN_ID VARCHAR(20) CHARACTER SET NONE,
PROD_ID VARCHAR(30) CHARACTER SET NONE,
PICK_ORDER_QTY INTEGER,
PICK_ALLOCATED_QTY INTEGER,
PICKED_QTY INTEGER)
AS 
 
 
DECLARE VARIABLE WK_ORIGINAL VARCHAR(20);
DECLARE VARIABLE WK_PI_WH CHAR(2);
DECLARE VARIABLE WK_PI_LOCN VARCHAR(10);
DECLARE VARIABLE WK_PROD_CNT INTEGER;
BEGIN
   /*
   first get fields from pick_item
   */
   /* ORDER BY PICK_ORDER_LINE_NO, PICK_LABEL_NO */

   FOR SELECT 
          PICK_ITEM.SSN_ID, 
          PICK_ITEM.PROD_ID, 
          SUM(PICK_ITEM.PICK_ORDER_QTY),
          SUM(PICK_ITEM.PICK_ALLOCATED_QTY),
          SUM(PICK_ITEM.PICKED_QTY)
   FROM PICK_ITEM
   WHERE (V4POS(:ORDER_LIST, PICK_ITEM.PICK_ORDER, 0, 1) > -1)
   AND (PICK_ITEM.PICK_LINE_STATUS IN ('OP','UP'))
   GROUP BY PICK_ITEM.SSN_ID, PICK_ITEM.PROD_ID
   INTO :SSN_ID, :PROD_ID, :PICK_ORDER_QTY, :PICK_ALLOCATED_QTY, :PICKED_QTY  
   DO
   BEGIN
      IF (SSN_ID IS NULL) THEN
      BEGIN
         /* a product */
         WK_PROD_CNT = 0;
         /*  AND ISSN.ISSN_STATUS IN ('ST','PA','OP','AL','PG','PL') */
         FOR
         SELECT FIRST 2 ISSN.WH_ID, ISSN.LOCN_ID, PROD_PROFILE.SHORT_DESC 
         FROM ISSN 
              JOIN PROD_PROFILE ON PROD_PROFILE.PROD_ID = ISSN.PROD_ID
              JOIN CONTROL ON CONTROL.RECORD_ID = 1
         WHERE ISSN.PROD_ID = :PROD_ID 
           AND (WH_ID < 'X '
           OR WH_ID > 'X~')
           AND (POS(CONTROL.PICK_IMPORT_SSN_STATUS, ISSN.ISSN_STATUS, 0, 1) > -1)
         GROUP BY ISSN.WH_ID, ISSN.LOCN_ID, PROD_PROFILE.SHORT_DESC 
         INTO :WK_PI_WH, :WK_PI_LOCN, :DESCRIPTION  
         DO
         BEGIN
            IF (WK_PROD_CNT = 0) THEN
            BEGIN
               WH_ID = WK_PI_WH;
               LOCN_ID = WK_PI_LOCN;
            END
            IF (WK_PROD_CNT = 1) THEN
            BEGIN
               WH_ID2 = WK_PI_WH;
               LOCN_ID2 = WK_PI_LOCN;
            END
            WK_PROD_CNT = WK_PROD_CNT + 1;
         END
         IF (DESCRIPTION IS NULL) THEN
         BEGIN
            SELECT SHORT_DESC 
            FROM PROD_PROFILE 
            WHERE PROD_ID = :PROD_ID 
            INTO :DESCRIPTION;
         END
      END
      ELSE
      BEGIN
      /*
      now if for an ssn get the ssn details
      */
         SELECT ISSN.WH_ID, ISSN.LOCN_ID, SSN.SSN_DESCRIPTION, ISSN.ORIGINAL_SSN
         FROM ISSN
         JOIN SSN ON SSN.SSN_ID = ISSN.ORIGINAL_SSN
         WHERE ISSN.SSN_ID = :SSN_ID
         INTO :WH_ID, :LOCN_ID, :DESCRIPTION, :WK_ORIGINAL;
      /* get 2nd issn for ssn */
         SELECT FIRST 1 ISSN.WH_ID, ISSN.LOCN_ID 
         FROM ISSN
         WHERE ORIGINAL_SSN = :WK_ORIGINAL
         AND SSN_ID <> :SSN_ID
         AND (WH_ID < 'X '
         OR WH_ID > 'X~')
         AND (WH_ID <> :WH_ID 
         OR LOCN_ID <> :LOCN_ID)
         INTO :WH_ID2, :LOCN_ID2 ;
      END
      SUSPEND;
   END
END ^

ALTER PROCEDURE TRAN4_ARCHIVE AS 
 
      
BEGIN
  
  /* Add record to TRANSACTIONS4_ARCHIVE table first */

  INSERT INTO TRANSACTIONS4_ARCHIVE 
     (TRN_VERSION, TRN_TYPE, TRN_CLASS, TRN_DATE, TRN_DELIMITER,
      PERSON_ID, DEVICE_ID, MESSAGE_ID, TRN_DATA, COMPLETE, 
      ERROR_TEXT, INSTANCE_ID, EXPORTED, INPUT_SOURCE)
       
  SELECT TRN_VERSION, TRN_TYPE, TRN_CLASS, TRN_DATE, TRN_DELIMITER,
      PERSON_ID, DEVICE_ID, MESSAGE_ID, TRN_DATA, COMPLETE, 
      ERROR_TEXT, INSTANCE_ID, EXPORTED, INPUT_SOURCE
  FROM TRANSACTIONS4
  WHERE COMPLETE = 'T';
  
  /* Delete records from TRANSACTIONS4 table with COMPLETE is True */
  DELETE FROM TRANSACTIONS4
  WHERE COMPLETE = 'T'; 
  
END ^

ALTER PROCEDURE TRAN_ARCHIVE AS 
BEGIN
  
  /* Add record to TRANSACTIONS_ARCHIVE table first */

  INSERT INTO TRANSACTIONS_WORK    
     (RECORD_ID, WH_ID, LOCN_ID, TRN_DATE, ERROR_TEXT )
       
  SELECT RECORD_ID, 'XX', 'TRANSACT', TRN_DATE, ERROR_TEXT 
  FROM TRANSACTIONS
  WHERE COMPLETE = 'T';
  
  INSERT INTO TRANSACTIONS_ARCHIVE 
     (WH_ID, LOCN_ID, OBJECT, TRN_TYPE, TRN_CODE, TRN_DATE, REFERENCE,
      QTY, ERROR_TEXT, INSTANCE_ID, EXPORTED, SUB_LOCN_ID, INPUT_SOURCE,
      PERSON_ID, DEVICE_ID)
       
  SELECT WH_ID, LOCN_ID, OBJECT, TRN_TYPE, TRN_CODE, TRN_DATE, REFERENCE,
      QTY, ERROR_TEXT, INSTANCE_ID, EXPORTED, SUB_LOCN_ID, INPUT_SOURCE,
      PERSON_ID, DEVICE_ID 
  FROM TRANSACTIONS
  WHERE COMPLETE = 'T';
  
  /* Delete records from TRANSACTIONS table with COMPLETE is True */
  DELETE FROM TRANSACTIONS
  WHERE COMPLETE = 'T'; 
  
END ^

ALTER PROCEDURE UPDATE_GRN (OBJECT VARCHAR(30) CHARACTER SET NONE,
TRN_TYPE VARCHAR(4) CHARACTER SET NONE,
QTY INTEGER,
REFERENCE VARCHAR(40) CHARACTER SET NONE)
AS 
DECLARE VARIABLE PACK_CRATE_OWNER VARCHAR(10);
DECLARE VARIABLE PACK_CRATE_TYPE CHAR(2);
DECLARE VARIABLE CONTAINER_TYPE CHAR(2);
DECLARE VARIABLE CONTAINER_NO VARCHAR(20);


BEGIN
 IF (:TRN_TYPE = 'UGON') THEN      /* Update Owner */
    BEGIN
      UPDATE GRN
      SET OWNER_ID = SUBSTR(:REFERENCE,1,10)
      WHERE GRN = :OBJECT;
    END
 IF (:TRN_TYPE = 'UGRI') THEN      /* Update Return - Supplier */
    BEGIN
      UPDATE GRN
      SET RETURN_ID = :REFERENCE
      WHERE GRN = :OBJECT;
    END
 IF (:TRN_TYPE = 'UGCA') THEN      /* Update Carrier */
    BEGIN
      UPDATE GRN
      SET CARRIER = :REFERENCE
      WHERE GRN = :OBJECT;
    END
 IF (:TRN_TYPE = 'UGCN') THEN      /* Update Connote */
    BEGIN
      UPDATE GRN
      SET AWB_CONSIGNMENT_NO = :REFERENCE
      WHERE GRN = :OBJECT;
    END

 IF (:TRN_TYPE = 'UGHP') THEN      /* Update Pallets */
    BEGIN
      UPDATE GRN
      SET PALLETS_YN = :REFERENCE,
      GRN_PALLET_QTY = :QTY
      WHERE GRN = :OBJECT;
    END
 IF (:TRN_TYPE = 'UGHC') THEN      /* Update Crate */
    BEGIN
   EXECUTE PROCEDURE GET_REFERENCE_FIELD :REFERENCE, 1  RETURNING_VALUES :PACK_CRATE_OWNER ;
   EXECUTE PROCEDURE GET_REFERENCE_FIELD :REFERENCE, 2  RETURNING_VALUES :PACK_CRATE_TYPE ;
      UPDATE GRN
      SET PACK_CRATE_OWNER = :PACK_CRATE_OWNER,
      PACK_CRATE_TYPE = :PACK_CRATE_TYPE,
      PACK_CRATE_QTY = :QTY
      WHERE GRN = :OBJECT;
    END
 IF (:TRN_TYPE = 'UGSN') THEN      /* Update Container */
    BEGIN
   EXECUTE PROCEDURE GET_REFERENCE_FIELD :REFERENCE, 1  RETURNING_VALUES :CONTAINER_NO ;
   EXECUTE PROCEDURE GET_REFERENCE_FIELD :REFERENCE, 2  RETURNING_VALUES :CONTAINER_TYPE ;
      UPDATE GRN
      SET CONTAINER_NO = :CONTAINER_NO,
      CONTAINER_TYPE = :CONTAINER_TYPE
      WHERE GRN = :OBJECT;
    END
 IF (:TRN_TYPE = 'UGLT') THEN      /* Update Lot */
    BEGIN
      UPDATE GRN
      SET LAST_LOT_NO = :REFERENCE
      WHERE GRN = :OBJECT;
    END
END ^

ALTER PROCEDURE UPDATE_ISSN (OBJECT VARCHAR(30) CHARACTER SET NONE,
TRN_TYPE VARCHAR(4) CHARACTER SET NONE,
TRN_CODE CHAR(1) CHARACTER SET NONE,
FIELD_VALUE VARCHAR(40) CHARACTER SET NONE,
TRN_DATE TIMESTAMP,
PERSON_ID VARCHAR(10) CHARACTER SET NONE,
QTY INTEGER)
RETURNS (ISSN_RESPONSE_TEXT VARCHAR(255) CHARACTER SET NONE)
AS 
DECLARE VARIABLE strOTHER1 VARCHAR(50);
DECLARE VARIABLE strPREV_PROD_ID VARCHAR(30);
DECLARE VARIABLE strPREV_PREV_PROD_ID VARCHAR(30);
DECLARE VARIABLE WK_GRN VARCHAR(10);
DECLARE VARIABLE WK_AUDIT_DESC VARCHAR(50);
/*
DECLARE VARIABLE WK_LAST_LINE_NO_STRING VARCHAR(2);
*/


/* i COPIED ALL THESE VARIABLES FROM GRNV TRANSACTION */
/* DECLARE VARIABLE ORIGINAL_SSN_ID INTEGER; */
DECLARE VARIABLE ORIGINAL_SSN_ID VARCHAR(20);
DECLARE VARIABLE WK_ISSN_ID VARCHAR(20);
DECLARE VARIABLE WK_WH_ID CHAR(2);
DECLARE VARIABLE WK_LOCN_ID VARCHAR(10);

DECLARE VARIABLE SSN_ID INTEGER;
DECLARE VARIABLE P_SSN_ID INTEGER;
DECLARE VARIABLE W_SSN_ID VARCHAR(20);
DECLARE VARIABLE I_SSN_ID VARCHAR(20);
DECLARE VARIABLE LEN_SSN_ID INTEGER;
DECLARE VARIABLE I_LEN_SSN_ID INTEGER;
DECLARE VARIABLE SSN_LENGTH INTEGER;
DECLARE VARIABLE LABEL_NO INTEGER;
DECLARE VARIABLE WK_LABEL_CURQTY INTEGER;
DECLARE VARIABLE WK_SSN_CURQTY INTEGER;
DECLARE VARIABLE WK_ISSN_STATUS CHAR(2);
DECLARE VARIABLE WK_PROD_ID VARCHAR(30);
DECLARE VARIABLE WK_COMPANY_ID VARCHAR(20);
DECLARE VARIABLE WK_DIVISION_ID VARCHAR(20);
DECLARE VARIABLE WK_SERIAL_NUMBER VARCHAR(30);
DECLARE VARIABLE WK_OTHER1 VARCHAR(50);
DECLARE VARIABLE WK_OTHER2 VARCHAR(50);
DECLARE VARIABLE WK_OTHER3 VARCHAR(255);
DECLARE VARIABLE WK_ISSN_PACKAGE_TYPE CHAR(2);

DECLARE VARIABLE WK_LAST_LINE_NO INTEGER;
DECLARE VARIABLE WK_LAST_PALLET_NO INTEGER;
DECLARE VARIABLE WK_LAST_LINE_NO_STRING VARCHAR(2);
DECLARE VARIABLE WK_LAST_PALLET_NO_STRING VARCHAR(3);
DECLARE VARIABLE WK_GENERATE_SSN_METHOD VARCHAR(25);
  DECLARE VARIABLE WK_SUBSTR_START INTEGER;
  DECLARE VARIABLE WK_SUBSTR_END INTEGER;


  DECLARE VARIABLE WK_FILENAME VARCHAR(75);
  DECLARE VARIABLE WK_RESULT INTEGER;
  DECLARE VARIABLE WK_LOG VARCHAR(75);
DECLARE VARIABLE WK_CURRENT_LINE_NO INTEGER;
DECLARE VARIABLE WK_COMP_PFX VARCHAR(2);
DECLARE VARIABLE WK_GRN_TYPE VARCHAR(2);
DECLARE VARIABLE WK_GRN_ORDER VARCHAR(15);
DECLARE VARIABLE WK_GRN_LOT VARCHAR(30);
DECLARE VARIABLE WK_OWNER_GRN VARCHAR(10);
DECLARE VARIABLE WK_LAST_LOT_PALLET_NO INTEGER;

BEGIN
WK_AUDIT_DESC = '';
WK_GRN = '';
WK_LAST_PALLET_NO_STRING = '';
WK_LAST_LINE_NO_STRING = '';
 IF (:TRN_TYPE = 'UIO1') THEN      /* Update Type */
    BEGIN
      UPDATE ISSN
      SET OTHER1 = :FIELD_VALUE
      WHERE SSN_ID = :OBJECT;
    END
    
     IF (:TRN_TYPE = 'UIO2') THEN      /* Update Type */
    BEGIN
      UPDATE ISSN
      SET OTHER2 = :FIELD_VALUE
      WHERE SSN_ID = :OBJECT;
    END
    
     IF (:TRN_TYPE = 'UIO3') THEN      /* Update Type */
    BEGIN
      UPDATE ISSN
      SET OTHER3 = :FIELD_VALUE
      WHERE SSN_ID = :OBJECT;
    END
    
     IF (:TRN_TYPE = 'UIO4') THEN      /* Update Type */
    BEGIN
      UPDATE ISSN
      SET OTHER4 = :FIELD_VALUE
      WHERE SSN_ID = :OBJECT;
    END
    
    IF (:TRN_TYPE = 'UICO') THEN
    BEGIN
      UPDATE ISSN
      SET COMPANY_ID = :FIELD_VALUE
      WHERE SSN_ID = :OBJECT;
    END

    IF (:TRN_TYPE = 'UIDI') THEN
    BEGIN
      UPDATE ISSN
      SET DIVISION_ID = :FIELD_VALUE
      WHERE SSN_ID = :OBJECT;
    END

    IF (:TRN_TYPE = 'UISN') THEN
    BEGIN
      UPDATE ISSN
      SET SERIAL_NUMBER = :FIELD_VALUE
      WHERE SSN_ID = :OBJECT;
    END

    IF (:TRN_TYPE = 'UISC') THEN
    BEGIN
      UPDATE ISSN
      SET STATUS_CODE = :FIELD_VALUE
      WHERE SSN_ID = :OBJECT;
    END

    IF (:TRN_TYPE = 'UIKT') THEN
    BEGIN
      UPDATE ISSN
      SET KITTED = :FIELD_VALUE
      WHERE SSN_ID = :OBJECT;
    END

    IF (:TRN_TYPE = 'UIPC') THEN
    BEGIN
      UPDATE ISSN
      SET PREV_PREV_PROD_ID = PREV_PROD_ID,
      PREV_PREV_PROD_ID_UPDATE = CASE WHEN PREV_PROD_ID IS NULL THEN PREV_PREV_PROD_ID_UPDATE ELSE 'NOW' END
       WHERE SSN_ID = :OBJECT;
       
       UPDATE ISSN
      SET PREV_PROD_ID = PROD_ID,
      PREV_PROD_ID_UPDATE = CASE WHEN PROD_ID IS NULL THEN PREV_PROD_ID_UPDATE ELSE 'NOW' END
       WHERE SSN_ID = :OBJECT;

       
      UPDATE ISSN
      SET PROD_ID = :FIELD_VALUE,
      PROD_ID_UPDATE = 'NOW'
      WHERE SSN_ID = :OBJECT;
    END
    
    IF (:TRN_TYPE = 'UIST') THEN
    BEGIN
      UPDATE ISSN
      SET ISSN_STATUS = :FIELD_VALUE
      WHERE SSN_ID = :OBJECT;
    END
    
   IF (:TRN_TYPE = 'UIPT') THEN
   BEGIN
      UPDATE ISSN
      SET ISSN_PREV_PACKAGE_TYPE = ISSN_PACKAGE_TYPE
      WHERE SSN_ID = :OBJECT;

      UPDATE ISSN
      SET ISSN_PACKAGE_TYPE = :FIELD_VALUE
      WHERE SSN_ID = :OBJECT;

   END

   IF (:TRN_TYPE = 'UILD') THEN
   BEGIN
      UPDATE ISSN
      SET LABEL_DATE = :TRN_DATE
      WHERE SSN_ID = :OBJECT;

   END
   
   IF (:TRN_TYPE = 'UICQ') THEN
   BEGIN
      UPDATE ISSN
      SET PREV_QTY = CURRENT_QTY
      WHERE SSN_ID = :OBJECT;

      UPDATE ISSN
      SET CURRENT_QTY = :QTY
      WHERE SSN_ID = :OBJECT;
      
      UPDATE ISSN
      SET PREV_DATE = :TRN_DATE
      WHERE SSN_ID = :OBJECT;

   END
   
   IF (:TRN_TYPE = 'UISS') THEN /* SPLIT */
   BEGIN
WK_FILENAME='/tmp/uiss.log';
      SELECT ORIGINAL_SSN, WH_ID, LOCN_ID, ISSN_STATUS, PROD_ID, OTHER1, OTHER2, OTHER3, COMPANY_ID, DIVISION_ID, SERIAL_NUMBER, ISSN_PACKAGE_TYPE FROM ISSN
      WHERE SSN_ID = :OBJECT
      INTO :ORIGINAL_SSN_ID, :WK_WH_ID, :WK_LOCN_ID, :WK_ISSN_STATUS, :WK_PROD_ID, :WK_OTHER1, :WK_OTHER2, :WK_OTHER3, :WK_COMPANY_ID, :WK_DIVISION_ID, :WK_SERIAL_NUMBER, :WK_ISSN_PACKAGE_TYPE ;
   
      IF (WK_OTHER1 IS NULL) THEN
      BEGIN
         WK_OTHER1 = '';
      END
      IF (WK_OTHER2 IS NULL) THEN
      BEGIN
         WK_OTHER2 = '';
      END
      IF (WK_OTHER3 IS NULL) THEN
      BEGIN
         WK_OTHER3 = '';
      END
      SELECT GRN FROM SSN
      WHERE SSN_ID = :ORIGINAL_SSN_ID
      INTO :WK_GRN;
      /* Get length for Barcode */
      /*
      EXECUTE PROCEDURE GET_BARCODE_LENGTH RETURNING_VALUES SSN_LENGTH;
      */
   
     SELECT GENERATE_SSN_METHOD FROM CONTROL INTO :WK_GENERATE_SSN_METHOD;
  
     /* IF ((WK_GENERATE_SSN_METHOD IS NULL) OR (WK_GENERATE_SSN_METHOD <> '|GRN=4|LINE=2|SUFFIX=2,3|')) THEN */
     IF ((WK_GENERATE_SSN_METHOD IS NULL) OR ((WK_GENERATE_SSN_METHOD <> '|GRN=4|LINE=2|SUFFIX=2,3|') AND 
        (WK_GENERATE_SSN_METHOD <> 'CMP=2|GRN=6|LINE=2|SFX=2' ))) THEN
     BEGIN
      SSN_ID = GEN_ID(ISSN_SSN_ID, 1);
      P_SSN_ID = SSN_ID - 1;
      LEN_SSN_ID = STRLEN(P_SSN_ID);
         
      W_SSN_ID = '';
         /* Padding leading with 0 */
      WHILE (LEN_SSN_ID < :SSN_LENGTH) DO
      BEGIN
          W_SSN_ID = W_SSN_ID || '0';
          LEN_SSN_ID = LEN_SSN_ID + 1;
       END
       W_SSN_ID = W_SSN_ID || P_SSN_ID;

       WK_ISSN_ID = W_SSN_ID ;

     END
   
   

     IF (WK_GENERATE_SSN_METHOD = '|GRN=4|LINE=2|SUFFIX=2,3|' ) THEN
     BEGIN

        /* THIS TIME THE LAST LINE NUMBER WILL REMAIN THE SAME. ONLY PALLET NO WILL KEEP CHANGING FOR NEW ISSNS */
        /* WK_LAST_PALLET_NO HAS ALREADY BEEN INITIALIZED TO ZERO */
        /* P_LAST_LINE_NO CONTAINS THE LAST VALUE OF WK_LAST_LINE_NO */
        /* W_SSN_ID CONTAINS THE ORIGINAL VALUE OF SSN. */


           /* DURING UPDATES THIS UPDATE WILL BE WITHIN A SESSION. THERE IS A MINOR CHANCE OF TWO PALLETS HAVING THE SAME NUMBER AS THIS CHANGE CANNOT BE COMMITTED IN A TRIGGER */
           SELECT LAST_LINE_NO, LAST_PALLET_NO FROM GRN WHERE GRN = :WK_GRN INTO :WK_LAST_LINE_NO, :WK_LAST_PALLET_NO;
           WK_LAST_PALLET_NO = WK_LAST_PALLET_NO + 1;
           UPDATE GRN SET LAST_PALLET_NO = :WK_LAST_PALLET_NO WHERE GRN = :WK_GRN;
           
           /* I WAS AMAZED TO FIND ALL LINE NUMBERS BEING ZERO FOR EVERY GRN
           OBVIOUSLY GRNV P TRANSACTION IS NOT BEING USED . PROGRAMMERS ARE PASSING LINE NUMBERS
           TO GRNV P AND HENCE THE TRIGGER IS NOT UPDATING LINE NUMBERS. THATS A PITY. CONSEQUENTLY I AM FORCED TO USE THE LINE NUMBER IN THE OBJECT FIELD. */
           
           /*WK_LAST_LINE_NO = SUBSTRING(:OBJECT,4,2);*/



           IF (WK_LAST_PALLET_NO < 10) THEN
           BEGIN
              WK_LAST_PALLET_NO_STRING = '0' || WK_LAST_PALLET_NO;
           END
           ELSE
           BEGIN
             WK_LAST_PALLET_NO_STRING = WK_LAST_PALLET_NO;
           END



             WK_CURRENT_LINE_NO = SUBSTR(OBJECT,5,6);
             /* WK_LAST_LINE_NO_STRING = '99'; */
             IF (TRN_CODE = 'B') THEN
             BEGIN
                WK_LAST_LINE_NO = 50 + WK_CURRENT_LINE_NO;
             END
             ELSE
             BEGIN
                WK_LAST_LINE_NO = WK_CURRENT_LINE_NO;
             END
             IF (WK_LAST_LINE_NO < 10) THEN
             BEGIN
                WK_LAST_LINE_NO_STRING = '0' || WK_LAST_LINE_NO;
             END
             ELSE
             BEGIN
               WK_LAST_LINE_NO_STRING = WK_LAST_LINE_NO;
             END
             
          IF (STRLEN(WK_GRN_LOT) > 0) THEN
          BEGIN
             WK_OWNER_GRN = SUBSTR(OBJECT,1, 4);
             WK_LAST_LINE_NO_STRING = SUBSTR(OBJECT,5, 6);
          END


          WK_ISSN_ID = WK_GRN || WK_LAST_LINE_NO_STRING || WK_LAST_PALLET_NO_STRING ;

         /* WK_ISSN_ID = WK_GRN || WK_LAST_LINE_NO_STRING || WK_LAST_PALLET_NO_STRING; */
          /* check that this issn dosnt exist */

/*
After Receiving Glen's email: 27/2/2008. Updating GRN is the correct option.
*/
     END /* if ssn method is GRN=4LINE=2|SUFFIX=2,3| */

     IF (WK_GENERATE_SSN_METHOD = 'CMP=2|GRN=6|LINE=2|SFX=2' ) THEN
     BEGIN

        /* THIS TIME THE LAST LINE NUMBER WILL REMAIN THE SAME. ONLY PALLET NO WILL KEEP CHANGING FOR NEW ISSNS */
        /* WK_LAST_PALLET_NO HAS ALREADY BEEN INITIALIZED TO ZERO */
        /* P_LAST_LINE_NO CONTAINS THE LAST VALUE OF WK_LAST_LINE_NO */
        /* W_SSN_ID CONTAINS THE ORIGINAL VALUE OF SSN. */

        WK_GRN_TYPE = '';
        WK_GRN_ORDER = '';
        WK_GRN_LOT = '';
        SELECT GRN_TYPE, ORDER_NO, LAST_LOT_NO
        FROM GRN
        WHERE GRN = :WK_GRN
        INTO :WK_GRN_TYPE, :WK_GRN_ORDER, :WK_GRN_LOT;
        IF (WK_GRN_TYPE IS NULL) THEN
        BEGIN
           WK_GRN_TYPE = 'LD';
        END
        IF (WK_GRN_ORDER IS NULL) THEN
        BEGIN
           WK_GRN_ORDER = '';
        END
        IF (WK_GRN_LOT IS NULL) THEN
        BEGIN
           WK_GRN_LOT = '';
        END
        WK_COMP_PFX = '';
        IF ((WK_GRN_TYPE = 'PO') OR
            (WK_GRN_TYPE = 'RA') OR  
            (WK_GRN_TYPE = 'TR') OR
            (WK_GRN_TYPE = 'WO')) THEN
        BEGIN
           SELECT PO_LEGACY_OWNER_ID 
           FROM PURCHASE_ORDER 
           WHERE PURCHASE_ORDER = :WK_GRN_ORDER
           INTO :WK_COMP_PFX;
           IF (WK_COMP_PFX IS NULL) THEN
           BEGIN
              WK_COMP_PFX = '';
           END
        END
        IF (WK_COMP_PFX = '') THEN
        BEGIN
           SELECT COMPANY_ID_PREFIX
           FROM COMPANY
           WHERE COMPANY_ID = :WK_COMPANY_ID
           INTO :WK_COMP_PFX;
        END
        IF (WK_COMP_PFX IS NULL) THEN
        BEGIN
           WK_COMP_PFX = '';
        END
        LEN_SSN_ID = STRLEN(WK_COMP_PFX);
      	WHILE (LEN_SSN_ID < 2) DO
        BEGIN
           WK_COMP_PFX = '0' || WK_COMP_PFX;
           LEN_SSN_ID = LEN_SSN_ID + 1;
        END
        LEN_SSN_ID = STRLEN(WK_GRN);
        WK_OWNER_GRN = WK_GRN;
      	WHILE (LEN_SSN_ID < 6) DO
        BEGIN
           WK_OWNER_GRN = '0' || WK_OWNER_GRN;
           LEN_SSN_ID = LEN_SSN_ID + 1;
        END
           /* DURING UPDATES THIS UPDATE WILL BE WITHIN A SESSION. THERE IS A MINOR CHANCE OF TWO PALLETS HAVING THE SAME NUMBER AS THIS CHANGE CANNOT BE COMMITTED IN A TRIGGER */
           SELECT LAST_LINE_NO, LAST_PALLET_NO FROM GRN WHERE GRN = :WK_GRN INTO :WK_LAST_LINE_NO, :WK_LAST_PALLET_NO;
           IF (STRLEN(WK_GRN_LOT) > 0) THEN
           BEGIN
              WK_LAST_LOT_PALLET_NO = 0;
              /* SELECT MAX(LAST_PALLET_NO) FROM GRN WHERE LAST_LOT_NO = :WK_GRN_LOT INTO :WK_LAST_LOT_PALLET_NO; */
              SELECT MAX(LAST_PALLET_NO) FROM GRN WHERE LAST_LOT_NO STARTING SUBSTR(:WK_GRN_LOT,1,8) INTO :WK_LAST_LOT_PALLET_NO;
              IF (WK_LAST_LOT_PALLET_NO IS NULL) THEN
              BEGIN
                 WK_LAST_LOT_PALLET_NO = WK_LAST_PALLET_NO;
              END
              IF (WK_LAST_LOT_PALLET_NO > WK_LAST_PALLET_NO) THEN
              BEGIN
                 WK_LAST_PALLET_NO = WK_LAST_LOT_PALLET_NO;
              END
           END
           WK_LAST_PALLET_NO = WK_LAST_PALLET_NO + 1;
           UPDATE GRN SET LAST_PALLET_NO = :WK_LAST_PALLET_NO WHERE GRN = :WK_GRN;
           
           /* I WAS AMAZED TO FIND ALL LINE NUMBERS BEING ZERO FOR EVERY GRN
           OBVIOUSLY GRNV P TRANSACTION IS NOT BEING USED . PROGRAMMERS ARE PASSING LINE NUMBERS
           TO GRNV P AND HENCE THE TRIGGER IS NOT UPDATING LINE NUMBERS. THATS A PITY. CONSEQUENTLY I AM FORCED TO USE THE LINE NUMBER IN THE OBJECT FIELD. */
           
           /*WK_LAST_LINE_NO = SUBSTRING(:OBJECT,4,2);*/



           IF (WK_LAST_PALLET_NO < 10) THEN
           BEGIN
              WK_LAST_PALLET_NO_STRING = '0' || WK_LAST_PALLET_NO;
           END
           ELSE
           BEGIN
             WK_LAST_PALLET_NO_STRING = WK_LAST_PALLET_NO;
           END

             WK_CURRENT_LINE_NO = SUBSTR(OBJECT,9,10);
             /* WK_LAST_LINE_NO_STRING = '99'; */
             IF (TRN_CODE = 'B') THEN
             BEGIN
                WK_LAST_LINE_NO = 50 + WK_CURRENT_LINE_NO;
             END
             ELSE
             BEGIN
                WK_LAST_LINE_NO = WK_CURRENT_LINE_NO;
             END
             IF (WK_LAST_LINE_NO < 10) THEN
             BEGIN
                WK_LAST_LINE_NO_STRING = '0' || WK_LAST_LINE_NO;
             END
             ELSE
             BEGIN
               WK_LAST_LINE_NO_STRING = WK_LAST_LINE_NO;
             END
             
          IF (STRLEN(WK_GRN_LOT) > 0) THEN
          BEGIN
             WK_COMP_PFX = SUBSTR(OBJECT, 1, 2);
             WK_OWNER_GRN = SUBSTR(OBJECT,3, 8);
             WK_LAST_LINE_NO_STRING = SUBSTR(OBJECT,9, 10);
          END

          /* WK_ISSN_ID = WK_COMP_PFX || WK_GRN || WK_LAST_LINE_NO_STRING || WK_LAST_PALLET_NO_STRING ; */
          WK_ISSN_ID = WK_COMP_PFX || WK_OWNER_GRN || WK_LAST_LINE_NO_STRING || WK_LAST_PALLET_NO_STRING ;

         /* WK_ISSN_ID = WK_GRN || WK_LAST_LINE_NO_STRING || WK_LAST_PALLET_NO_STRING; */
          /* check that this issn dosnt exist */

/*
After Receiving Glen's email: 27/2/2008. Updating GRN is the correct option.
*/
     END /* if ssn method is 'CMP=2|GRN=6|LINE=2|SFX=2' */

/*
, OTHER2, OTHER3, ISSN_PACKAGE_TYPE, DIVISION_ID, COMPANY_ID, SERIAL_NUMBER
, :WK_OTHER1, :WK_OTHER2, :WK_OTHER3, :WK_ISSN_PACKAGE_TYPE, :WK_DIVISION_ID, :WK_COMPANY_ID, :WK_SERIAL_NUMBER
*/

           IF (TRN_CODE = 'B') THEN
           BEGIN
              UPDATE SSN
              SET CURRENT_QTY = CURRENT_QTY - :QTY
              WHERE SSN_ID = :ORIGINAL_SSN_ID;
              /* create an ssn from the original */
              INSERT INTO SSN( SSN_ID, PARENT_SSN_ID, WH_ID, LOCN_ID, CURRENT_QTY, ORIGINAL_QTY, COMPANY_ID, PROD_ID, INTO_DATE, CREATE_DATE, CREATED_BY, LABEL_DATE,
PREV_LOCN_ID, PARENT_LOCN_ID, HOME_LOCN_ID, SSN_DESCRIPTION, ALT_NAME, SSN_TYPE,
GENERIC, BRAND, MODEL, COST_CENTER, DEPARTMENT_ID, RETICULATION, PRODUCT, SERIAL_NUMBER,
DIVISION_ID, STORAGE_UOM, NET_WEIGHT, USE_BY_DATE,
LOT_BATCH_NO, LAST_UPDATE_DATE, LAST_UPDATE_BY, LAST_UPDATE_DEVICE_ID, 
STATUS_SSN, STATUS_SSN_DATE, STATUS_CODE, STATUS_CODE_DATE, OLD_SSN_ID, PREV_WH_ID, LEGACY_ID,
AUDITED, AUDIT_DATE, AUDITED_QTY, AUDITED_BY, AUDIT_RECOUNT_DATE, AUDIT_RECOUNT_QTY, AUDIT_RECOUNT_BY,
SUPPLIER_ID, PURCHASE_DATE, PURCHASE_PRICE, PURCHASE_QTY, PO_RECEIVE_DATE, PO_ORDER, PO_LINE,
GRN, LICENCE_NUMBER, SSN_GROUP, LABEL_LOCN, ACCESSION, DT_PREV_INTO,
PREV_LOCN_DATE, PDF_DESCRIPTION, NOTES, OTHER1, OTHER2, OTHER3, OTHER4, OTHER5, OTHER6,
OTHER7, OTHER8, OTHER9, OTHER10, OTHER11, OTHER12, OTHER13, OTHER14, OTHER15_DATE, OTHER16_DATE,
OTHER17_QTY, OTHER18_QTY, OTHER19, OTHER20, COLLECTION_NAME, COLLECTION_TYPE, FILE_NUMBER,
HAZARD_STATUS, HAZARD_WARNING, HAZARD_IMAGE1, HAZARD_IMAGE2, HAZARD_IMAGE3, OBJECT_NAME,
OBJECT_NUMBER, OBJECT_IMAGE1, OBJECT_IMAGE2, OBJECT_IMAGE3, OBJECT_STATUS, LOAN_STATUS,
LOAN_PERIOD_NO, LOAN_PERIOD, LOAN_SAFETY_CHECK, LOAN_LAST_SAFETY_CHECK_DATE, LOAN_SAFETY_PERIOD_NO, 
LOAN_SAFETY_PERIOD, LOAN_CALIBRATE_CHECK, LOAN_LAST_CALIBRATE_CHECK_DATE, LOAN_CALIBRATE_PERIOD_NO,
LOAN_CALIBRATE_PERIOD, ACQUISITION_COST, LIFE_PERIODS1, LIFE_PERIODS2, LIFE_UNITS_USED,
LIFE_UNITS, LEASED, LEASE_EXPIRY_DATE, LEASOR, IP_ADDRESS, WARRANTY_EXPIRY_DATE, INSURED_VALUE,
VERSION, VERSION_DATE, FREEZE_VALUE1, FREEZE_VALUE2, FREEZE_VALUE3, FREEZE_DATE, DEPSTART_PERIOD1,
DEPSTART_PERIOD2, DEPEND_PERIOD1, DEPEND_PERIOD2, DISPOSED, DISPOSAL_COST, DISPOSAL_PRICE,
DISPOSAL_DATE, DISPOSAL_NOTES, COMMISSIONED_DATE, GOV_TAX, DEPRECIATE_DATE, DEPRECIATE,
BOOK_VALUE1, BOOK_VALUE2, BOOK_VALUE3, DEPRECIATION_LIMIT, DEPRECIATED_VALUE1, DEPRECIATED_VALUE2,
DEPRECIATED_VALUE3, TERMINATION_VALUE, QUESTION_ID, ANSWER_ID, PRINTED_BY, NET_WEIGHT_UOM,
DEPRECIATE_METHOD1, DEPRECIATE_METHOD2, DEPRECIATE_METHOD3, SSN_SUB_TYPE, SSN_TAX_APPLICABLE,
SSN_SALE_PRICE, SSN_SALE_UOM)
                 SELECT :WK_ISSN_ID, :ORIGINAL_SSN_ID, :WK_WH_ID, :WK_LOCN_ID, :QTY, 0, :WK_COMPANY_ID, :WK_PROD_ID, 'NOW', 'NOW', :PERSON_ID, 'NOW',
 PREV_LOCN_ID, PARENT_LOCN_ID, HOME_LOCN_ID, SSN_DESCRIPTION, ALT_NAME, SSN_TYPE,
GENERIC, BRAND, MODEL, COST_CENTER, DEPARTMENT_ID, RETICULATION, PRODUCT, SERIAL_NUMBER,
DIVISION_ID, STORAGE_UOM, NET_WEIGHT, USE_BY_DATE,
LOT_BATCH_NO, LAST_UPDATE_DATE, LAST_UPDATE_BY, LAST_UPDATE_DEVICE_ID, 
STATUS_SSN, STATUS_SSN_DATE, STATUS_CODE, STATUS_CODE_DATE, OLD_SSN_ID, PREV_WH_ID, LEGACY_ID,
AUDITED, AUDIT_DATE, AUDITED_QTY, AUDITED_BY, AUDIT_RECOUNT_DATE, AUDIT_RECOUNT_QTY, AUDIT_RECOUNT_BY,
SUPPLIER_ID, PURCHASE_DATE, PURCHASE_PRICE, PURCHASE_QTY, PO_RECEIVE_DATE, PO_ORDER, PO_LINE,
GRN, LICENCE_NUMBER, SSN_GROUP, LABEL_LOCN, ACCESSION, DT_PREV_INTO,
PREV_LOCN_DATE, PDF_DESCRIPTION, NOTES, OTHER1, OTHER2, OTHER3, OTHER4, OTHER5, OTHER6,
OTHER7, OTHER8, OTHER9, OTHER10, OTHER11, OTHER12, OTHER13, OTHER14, OTHER15_DATE, OTHER16_DATE,
OTHER17_QTY, OTHER18_QTY, OTHER19, OTHER20, COLLECTION_NAME, COLLECTION_TYPE, FILE_NUMBER,
HAZARD_STATUS, HAZARD_WARNING, HAZARD_IMAGE1, HAZARD_IMAGE2, HAZARD_IMAGE3, OBJECT_NAME,
OBJECT_NUMBER, OBJECT_IMAGE1, OBJECT_IMAGE2, OBJECT_IMAGE3, OBJECT_STATUS, LOAN_STATUS,
LOAN_PERIOD_NO, LOAN_PERIOD, LOAN_SAFETY_CHECK, LOAN_LAST_SAFETY_CHECK_DATE, LOAN_SAFETY_PERIOD_NO, 
LOAN_SAFETY_PERIOD, LOAN_CALIBRATE_CHECK, LOAN_LAST_CALIBRATE_CHECK_DATE, LOAN_CALIBRATE_PERIOD_NO,
LOAN_CALIBRATE_PERIOD, ACQUISITION_COST, LIFE_PERIODS1, LIFE_PERIODS2, LIFE_UNITS_USED,
LIFE_UNITS, LEASED, LEASE_EXPIRY_DATE, LEASOR, IP_ADDRESS, WARRANTY_EXPIRY_DATE, INSURED_VALUE,
VERSION, VERSION_DATE, FREEZE_VALUE1, FREEZE_VALUE2, FREEZE_VALUE3, FREEZE_DATE, DEPSTART_PERIOD1,
DEPSTART_PERIOD2, DEPEND_PERIOD1, DEPEND_PERIOD2, DISPOSED, DISPOSAL_COST, DISPOSAL_PRICE,
DISPOSAL_DATE, DISPOSAL_NOTES, COMMISSIONED_DATE, GOV_TAX, DEPRECIATE_DATE, DEPRECIATE,
BOOK_VALUE1, BOOK_VALUE2, BOOK_VALUE3, DEPRECIATION_LIMIT, DEPRECIATED_VALUE1, DEPRECIATED_VALUE2,
DEPRECIATED_VALUE3, TERMINATION_VALUE, QUESTION_ID, ANSWER_ID, PRINTED_BY, NET_WEIGHT_UOM,
DEPRECIATE_METHOD1, DEPRECIATE_METHOD2, DEPRECIATE_METHOD3, SSN_SUB_TYPE, SSN_TAX_APPLICABLE,
SSN_SALE_PRICE, SSN_SALE_UOM
                 FROM SSN 
                 WHERE SSN_ID = :ORIGINAL_SSN_ID;
              ORIGINAL_SSN_ID = WK_ISSN_ID;
           END

           /* WK_OTHER3 = :WK_OTHER3 || '|' || :FIELD_VALUE || :OBJECT; */
           IF (STRLEN(WK_OTHER3) > 0) THEN
           BEGIN
              WK_OTHER3 = :WK_OTHER3 || '|' || :OBJECT ;
           END
           ELSE
           BEGIN
              WK_OTHER3 = :WK_OTHER3 || '|' || :FIELD_VALUE ;
           END
           INSERT INTO ISSN (SSN_ID, ORIGINAL_SSN, WH_ID, LOCN_ID, CURRENT_QTY,ISSN_STATUS, PROD_ID, LABEL_DATE, COMPANY_ID, ORIGINAL_QTY, CREATE_DATE,USER_ID, INTO_DATE, OTHER1, OTHER2, OTHER3, ISSN_PACKAGE_TYPE, DIVISION_ID, SERIAL_NUMBER)
           VALUES (:WK_ISSN_ID, :ORIGINAL_SSN_ID, :WK_WH_ID, :WK_LOCN_ID, :QTY, :WK_ISSN_STATUS, :WK_PROD_ID, 'NOW', :WK_COMPANY_ID, 0, :TRN_DATE, :PERSON_ID, :TRN_DATE, :WK_OTHER1, :WK_OTHER2, :WK_OTHER3, :WK_ISSN_PACKAGE_TYPE, :WK_DIVISION_ID, :WK_SERIAL_NUMBER);
           

           /* I AM SURPRISED THAT WHEN I INCLUDE THE COLUMN COMPANY_ID IN INSERT, THINGS DONT WORK. HENCE UPDATE STATEMENT - STRANGE BEHAVIOUR  */
           UPDATE ISSN
           SET COMPANY_ID = :WK_COMPANY_ID
           WHERE SSN_ID = :WK_ISSN_ID;
           
           UPDATE ISSN
           SET PREV_QTY = CURRENT_QTY
           WHERE SSN_ID = :OBJECT;

/*
           UPDATE ISSN
           SET CURRENT_QTY = CURRENT_QTY - :QTY
           WHERE SSN_ID = :OBJECT;

           UPDATE ISSN
           SET PREV_DATE = :TRN_DATE
           WHERE SSN_ID = :OBJECT;
*/
           
           WK_AUDIT_DESC = 'SPLIT FROM' || :OBJECT;
           

          EXECUTE PROCEDURE ADD_SSN_HIST(:WK_WH_ID, :WK_LOCN_ID, :WK_ISSN_ID, :TRN_TYPE, '', :TRN_DATE,
                                              :OBJECT , :FIELD_VALUE, :QTY, :PERSON_ID, '');

           WK_AUDIT_DESC = 'SPLIT TO' || :WK_ISSN_ID;
           

          EXECUTE PROCEDURE ADD_SSN_HIST(:WK_WH_ID, :WK_LOCN_ID, :OBJECT, :TRN_TYPE, '', :TRN_DATE,
                                              :WK_ISSN_ID , :FIELD_VALUE, :QTY, :PERSON_ID, '');

                                              
              ISSN_RESPONSE_TEXT = WK_ISSN_ID;

   END /* UISS */

   /* Read Reference field to get Label No */

END ^

ALTER PROCEDURE UPDATE_LEGACY_PRODUCT AS 
DECLARE VARIABLE WK_SSN_ID VARCHAR(20);
DECLARE VARIABLE WK_FIELD VARCHAR(50);
DECLARE VARIABLE WK_PROD_TYPE VARCHAR(40);
DECLARE VARIABLE WK_STATUS CHAR(2);
DECLARE VARIABLE WK_WH_ID CHAR(2);
DECLARE VARIABLE WK_PROD VARCHAR(30);
DECLARE VARIABLE WK_NEW_PROD VARCHAR(60);
DECLARE VARIABLE WK_NEW_PROD2 VARCHAR(60);
DECLARE VARIABLE WK_PROD_LENGTH INTEGER;
DECLARE VARIABLE WK_GRN_TYPE CHAR(2);

BEGIN    
    
    /* Get SSN to update */
   /* FOR SELECT SSN.SSN_ID, SSN.STATUS_SSN, SSN.WH_ID, NONULL(SSN.PROD_ID), NONULL(GRN.GRN_TYPE) */
   FOR SELECT SSN.SSN_ID, SSN.STATUS_SSN, SSN.WH_ID, SSN.PROD_ID, GRN.GRN_TYPE 
   FROM SSN
   LEFT OUTER JOIN GRN ON GRN.GRN = SSN.GRN
   INTO :WK_SSN_ID, :WK_STATUS, :WK_WH_ID, :WK_PROD, :WK_GRN_TYPE
   DO
   BEGIN
      IF (WK_PROD IS NULL) THEN
      BEGIN
         WK_PROD = '';
      END
      IF (WK_GRN_TYPE IS NULL) THEN
      BEGIN
         WK_GRN_TYPE = '';
      END
      IF ((WK_STATUS = 'PA' OR WK_STATUS = 'ST' OR WK_STATUS = 'TS')
         AND WK_WH_ID <> 'XX' AND WK_GRN_TYPE <> 'PO') THEN
      BEGIN
         WK_NEW_PROD2 = '';
         FOR SELECT CODE, LEGACY_LENGTH     
             FROM PRODUCT_LAYOUT
             ORDER BY SEQUENCE
             INTO :WK_PROD_TYPE, :WK_PROD_LENGTH
         DO
         BEGIN
            IF (WK_PROD_TYPE = 'SSN_TYPE') THEN
            BEGIN
               /* SELECT NONULL(SSN_TYPE.LEGACY_CODE) */
               SELECT SSN_TYPE.LEGACY_CODE 
               FROM SSN LEFT OUTER JOIN SSN_TYPE ON 
               SSN.SSN_TYPE = SSN_TYPE.CODE
               WHERE SSN.SSN_ID = :WK_SSN_ID
               INTO :WK_FIELD;
               IF (WK_FIELD IS NULL) THEN
               BEGIN
                  WK_FIELD = '';
               END
               WK_FIELD = WK_FIELD || '    ';
               WK_NEW_PROD2 = WK_NEW_PROD2 || SUBSTR(WK_FIELD,1,WK_PROD_LENGTH);
            END
            IF (WK_PROD_TYPE = 'GENERIC') THEN
            BEGIN
               /* SELECT NONULL(GENERIC.LEGACY_CODE) */
               SELECT GENERIC.LEGACY_CODE 
               FROM SSN LEFT OUTER JOIN GENERIC ON 
               SSN.GENERIC = GENERIC.CODE
               WHERE SSN.SSN_ID = :WK_SSN_ID
               INTO :WK_FIELD;
               IF (WK_FIELD IS NULL) THEN
               BEGIN
                  WK_FIELD = '';
               END
               WK_FIELD = WK_FIELD || '    ';
               WK_NEW_PROD2 = WK_NEW_PROD2 || SUBSTR(WK_FIELD,1,WK_PROD_LENGTH);
            END
            IF (WK_PROD_TYPE = 'BRAND') THEN
            BEGIN
               /* SELECT NONULL(BRAND.LEGACY_CODE)  */
               SELECT BRAND.LEGACY_CODE 
               FROM SSN LEFT OUTER JOIN BRAND ON 
               SSN.BRAND = BRAND.CODE
               WHERE SSN.SSN_ID = :WK_SSN_ID
               INTO :WK_FIELD;
               IF (WK_FIELD IS NULL) THEN
               BEGIN
                  WK_FIELD = '';
               END
               WK_FIELD = WK_FIELD || '    ';
               WK_NEW_PROD2 = WK_NEW_PROD2 || SUBSTR(WK_FIELD,1,WK_PROD_LENGTH);
            END
            IF (WK_PROD_TYPE = 'MODEL') THEN
            BEGIN
               /* SELECT NONULL(MODEL.LEGACY_CODE)  */
               SELECT MODEL.LEGACY_CODE 
               FROM SSN LEFT OUTER JOIN MODEL ON 
               SSN.MODEL = MODEL.CODE
               WHERE SSN.SSN_ID = :WK_SSN_ID
               INTO :WK_FIELD;
               IF (WK_FIELD IS NULL) THEN
               BEGIN
                  WK_FIELD = '';
               END
               WK_FIELD = WK_FIELD || '    ';
               WK_NEW_PROD2 = WK_NEW_PROD2 || SUBSTR(WK_FIELD,1,WK_PROD_LENGTH);
            END
            IF (WK_PROD_TYPE = 'OTHER1') THEN
            BEGIN
               /* SELECT NONULL(GLOBAL_CONDITIONS.LEGACY_CODE) */
               SELECT GLOBAL_CONDITIONS.LEGACY_CODE 
               FROM SSN LEFT OUTER JOIN GLOBAL_CONDITIONS ON 
               SSN.OTHER1 = GLOBAL_CONDITIONS.DESCRIPTION AND
               1 = GLOBAL_CONDITIONS.OTHER_NO AND
               GLOBAL_CONDITIONS.MATCH_OPERATOR IS NULL
               WHERE SSN.SSN_ID = :WK_SSN_ID
               INTO :WK_FIELD;
               IF (WK_FIELD IS NULL) THEN
               BEGIN
                  WK_FIELD = '';
               END
               WK_FIELD = WK_FIELD || '    ';
               WK_NEW_PROD2 = WK_NEW_PROD2 || SUBSTR(WK_FIELD,1,WK_PROD_LENGTH);
            END
            IF (WK_PROD_TYPE = 'OTHER2') THEN
            BEGIN
               /* SELECT NONULL(GLOBAL_CONDITIONS.LEGACY_CODE)  */
               SELECT GLOBAL_CONDITIONS.LEGACY_CODE 
               FROM SSN LEFT OUTER JOIN GLOBAL_CONDITIONS ON 
               SSN.OTHER2 = GLOBAL_CONDITIONS.DESCRIPTION AND
               2 = GLOBAL_CONDITIONS.OTHER_NO AND
               GLOBAL_CONDITIONS.MATCH_OPERATOR IS NULL
               WHERE SSN.SSN_ID = :WK_SSN_ID
               INTO :WK_FIELD;
               IF (WK_FIELD IS NULL) THEN
               BEGIN
                  WK_FIELD = '';
               END
               WK_FIELD = WK_FIELD || '    ';
               WK_NEW_PROD2 = WK_NEW_PROD2 || SUBSTR(WK_FIELD,1,WK_PROD_LENGTH);
            END
            IF (WK_PROD_TYPE = 'OTHER3') THEN
            BEGIN
               /* SELECT NONULL(GLOBAL_CONDITIONS.LEGACY_CODE)  */
               SELECT GLOBAL_CONDITIONS.LEGACY_CODE 
               FROM SSN LEFT OUTER JOIN GLOBAL_CONDITIONS ON 
               SSN.OTHER3 = GLOBAL_CONDITIONS.DESCRIPTION AND
               3 = GLOBAL_CONDITIONS.OTHER_NO AND
               GLOBAL_CONDITIONS.MATCH_OPERATOR IS NULL
               WHERE SSN.SSN_ID = :WK_SSN_ID
               INTO :WK_FIELD;
               IF (WK_FIELD IS NULL) THEN
               BEGIN
                  WK_FIELD = '';
               END
               WK_FIELD = WK_FIELD || '    ';
               WK_NEW_PROD2 = WK_NEW_PROD2 || SUBSTR(WK_FIELD,1,WK_PROD_LENGTH);
            END
            IF (WK_PROD_TYPE = 'OTHER4') THEN
            BEGIN
               /* SELECT NONULL(GLOBAL_CONDITIONS.LEGACY_CODE)  */
               SELECT GLOBAL_CONDITIONS.LEGACY_CODE 
               FROM SSN LEFT OUTER JOIN GLOBAL_CONDITIONS ON 
               SSN.OTHER4 = GLOBAL_CONDITIONS.DESCRIPTION AND
               4 = GLOBAL_CONDITIONS.OTHER_NO AND
               GLOBAL_CONDITIONS.MATCH_OPERATOR IS NULL
               WHERE SSN.SSN_ID = :WK_SSN_ID
               INTO :WK_FIELD;
               IF (WK_FIELD IS NULL) THEN
               BEGIN
                  WK_FIELD = '';
               END
               WK_FIELD = WK_FIELD || '    ';
               WK_NEW_PROD2 = WK_NEW_PROD2 || SUBSTR(WK_FIELD,1,WK_PROD_LENGTH);
            END
            IF (WK_PROD_TYPE = 'OTHER6') THEN
            BEGIN
               /* SELECT NONULL(PRODUCT_DESCRIPTION.LEGACY_CODE)  */
               SELECT PRODUCT_DESCRIPTION.LEGACY_CODE 
               FROM SSN LEFT OUTER JOIN PRODUCT_DESCRIPTION ON 
               SSN.SSN_TYPE = PRODUCT_DESCRIPTION.TYPE_CODE AND
               '1' = PRODUCT_DESCRIPTION.FIELD_CODE AND
               SSN.OTHER6 = PRODUCT_DESCRIPTION.DESCRIPTION 
               WHERE SSN.SSN_ID = :WK_SSN_ID
               INTO :WK_FIELD;
               IF (WK_FIELD IS NULL) THEN
               BEGIN
                  WK_FIELD = '';
               END
               WK_FIELD = WK_FIELD || '    ';
               WK_NEW_PROD2 = WK_NEW_PROD2 || SUBSTR(WK_FIELD,1,WK_PROD_LENGTH);
            END
            IF (WK_PROD_TYPE = 'OTHER7') THEN
            BEGIN
               /* SELECT NONULL(PRODUCT_DESCRIPTION.LEGACY_CODE)  */
               SELECT PRODUCT_DESCRIPTION.LEGACY_CODE 
               FROM SSN LEFT OUTER JOIN PRODUCT_DESCRIPTION ON 
               SSN.SSN_TYPE = PRODUCT_DESCRIPTION.TYPE_CODE AND
               '2' = PRODUCT_DESCRIPTION.FIELD_CODE AND
               SSN.OTHER7 = PRODUCT_DESCRIPTION.DESCRIPTION 
               WHERE SSN.SSN_ID = :WK_SSN_ID
               INTO :WK_FIELD;
               IF (WK_FIELD IS NULL) THEN
               BEGIN
                  WK_FIELD = '';
               END
               WK_FIELD = WK_FIELD || '    ';
               WK_NEW_PROD2 = WK_NEW_PROD2 || SUBSTR(WK_FIELD,1,WK_PROD_LENGTH);
            END
            IF (WK_PROD_TYPE = 'OTHER8') THEN
            BEGIN
               /* SELECT NONULL(PRODUCT_DESCRIPTION.LEGACY_CODE)  */
               SELECT PRODUCT_DESCRIPTION.LEGACY_CODE 
               FROM SSN LEFT OUTER JOIN PRODUCT_DESCRIPTION ON 
               SSN.SSN_TYPE = PRODUCT_DESCRIPTION.TYPE_CODE AND
               '3' = PRODUCT_DESCRIPTION.FIELD_CODE AND
               SSN.OTHER8 = PRODUCT_DESCRIPTION.DESCRIPTION 
               WHERE SSN.SSN_ID = :WK_SSN_ID
               INTO :WK_FIELD;
               IF (WK_FIELD IS NULL) THEN
               BEGIN
                  WK_FIELD = '';
               END
               WK_FIELD = WK_FIELD || '    ';
               WK_NEW_PROD2 = WK_NEW_PROD2 || SUBSTR(WK_FIELD,1,WK_PROD_LENGTH);
            END
            IF (WK_PROD_TYPE = 'OTHER9') THEN
            BEGIN
               /* SELECT NONULL(PRODUCT_DESCRIPTION.LEGACY_CODE)  */
               SELECT PRODUCT_DESCRIPTION.LEGACY_CODE 
               FROM SSN LEFT OUTER JOIN PRODUCT_DESCRIPTION ON 
               SSN.SSN_TYPE = PRODUCT_DESCRIPTION.TYPE_CODE AND
               '4' = PRODUCT_DESCRIPTION.FIELD_CODE AND
               SSN.OTHER9 = PRODUCT_DESCRIPTION.DESCRIPTION 
               WHERE SSN.SSN_ID = :WK_SSN_ID
               INTO :WK_FIELD;
               IF (WK_FIELD IS NULL) THEN
               BEGIN
                  WK_FIELD = '';
               END
               WK_FIELD = WK_FIELD || '    ';
               WK_NEW_PROD2 = WK_NEW_PROD2 || SUBSTR(WK_FIELD,1,WK_PROD_LENGTH);
            END
            IF (WK_PROD_TYPE = 'OTHER10') THEN
            BEGIN
               /* SELECT NONULL(PRODUCT_DESCRIPTION.LEGACY_CODE)  */
               SELECT PRODUCT_DESCRIPTION.LEGACY_CODE 
               FROM SSN LEFT OUTER JOIN PRODUCT_DESCRIPTION ON 
               SSN.SSN_TYPE = PRODUCT_DESCRIPTION.TYPE_CODE AND
               '5' = PRODUCT_DESCRIPTION.FIELD_CODE AND
               SSN.OTHER10 = PRODUCT_DESCRIPTION.DESCRIPTION 
               WHERE SSN.SSN_ID = :WK_SSN_ID
               INTO :WK_FIELD;
               IF (WK_FIELD IS NULL) THEN
               BEGIN
                  WK_FIELD = '';
               END
               WK_FIELD = WK_FIELD || '    ';
               WK_NEW_PROD2 = WK_NEW_PROD2 || SUBSTR(WK_FIELD,1,WK_PROD_LENGTH);
            END
            IF (WK_PROD_TYPE = 'OTHER19') THEN
            BEGIN
               /* SELECT NONULL(PRODUCT_DESCRIPTION.LEGACY_CODE)  */
               SELECT PRODUCT_DESCRIPTION.LEGACY_CODE 
               FROM SSN LEFT OUTER JOIN PRODUCT_DESCRIPTION ON 
               SSN.SSN_TYPE = PRODUCT_DESCRIPTION.TYPE_CODE AND
               'C' = PRODUCT_DESCRIPTION.FIELD_CODE AND
               SSN.OTHER19 = PRODUCT_DESCRIPTION.DESCRIPTION 
               WHERE SSN.SSN_ID = :WK_SSN_ID
               INTO :WK_FIELD;
               IF (WK_FIELD IS NULL) THEN
               BEGIN
                  WK_FIELD = '';
               END
               WK_FIELD = WK_FIELD || '    ';
               WK_NEW_PROD2 = WK_NEW_PROD2 || SUBSTR(WK_FIELD,1,WK_PROD_LENGTH);
            END
         END
         WK_NEW_PROD = LEFTS(WK_NEW_PROD2 , 30); 
         IF (WK_PROD <> WK_NEW_PROD) THEN
         BEGIN      
           /* Update SSN Description */
           UPDATE SSN SET PROD_ID = :WK_NEW_PROD
           WHERE SSN_ID = :WK_SSN_ID;
           UPDATE ISSN SET PROD_ID = :WK_NEW_PROD
           WHERE ORIGINAL_SSN = :WK_SSN_ID;
         END                     
      END                     
   END
END ^

ALTER PROCEDURE UPDATE_SALE_ORDER_STATUS (PICK_ORDER VARCHAR(10) CHARACTER SET NONE,
STATUS_SSN CHAR(2) CHARACTER SET NONE,
PICK_STATUS CHAR(2) CHARACTER SET NONE,
APPROVED_BY VARCHAR(10) CHARACTER SET NONE)
RETURNS (VALID_SO CHAR(1) CHARACTER SET NONE)
AS 
DECLARE VARIABLE SSSN VARCHAR(20);
DECLARE VARIABLE SPROD_ID VARCHAR(30);
DECLARE VARIABLE ICOUNT INTEGER;
DECLARE VARIABLE SWH CHAR(2);
DECLARE VARIABLE SLOCN VARCHAR(10);
DECLARE VARIABLE SPICKLABELNO VARCHAR(7);
DECLARE VARIABLE IMPORTSTATUS VARCHAR(40);
DECLARE VARIABLE RESERVEDSTATUS VARCHAR(40);
DECLARE VARIABLE WK_FOUND INTEGER;
DECLARE VARIABLE WK_SSNID VARCHAR(20);
DECLARE VARIABLE WK_NOCONFIRM CHAR(1);
DECLARE VARIABLE WK_HELD_STATUS CHAR(1);
DECLARE VARIABLE WK_ORDER_STATUS CHAR(2);
DECLARE VARIABLE WK_LOG_FILENAME VARCHAR(255);
DECLARE VARIABLE WK_LOG_RESULT INTEGER;
DECLARE VARIABLE WK_SO_WH_ID VARCHAR(2);
DECLARE VARIABLE WK_SO_COMPANY_ID VARCHAR(20);
DECLARE VARIABLE WK_ISSN_ID VARCHAR(20);
BEGIN
    ICOUNT = 0;
    VALID_SO = 'T';    
    WK_NOCONFIRM = 'F';    
    WK_HELD_STATUS = '';    
    WK_LOG_FILENAME = '/tmp/confirm.log';
    
    /* WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, 'start confirm '); */
    /* WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, 'order:' || PICK_ORDER || ' STATUS_SSN:' || STATUS_SSN || ' PICK_STATUS:' || PICK_STATUS || ' Approved by:' || APPROVED_BY); */
    
    /* CHECK SALE ORDER LINES FIRST */
    SELECT COUNT(*)
    FROM PICK_ITEM
    WHERE PICK_ORDER = :PICK_ORDER               
    INTO :ICOUNT;
    
/*
    SELECT WH_ID, COMPANY_ID
    FROM PICK_ORDER
    WHERE PICK_ORDER = :PICK_ORDER               
    INTO :WK_SO_WH_ID, :WK_SO_COMPANY_ID;
    IF (WK_SO_WH_ID IS NULL) THEN
    BEGIN
       WK_SO_WH_ID = '';
    END
    IF (WK_SO_COMPANY_ID IS NULL) THEN
    BEGIN
       WK_SO_COMPANY_ID = '';
    END
*/
    IF (:ICOUNT = 0) THEN
    BEGIN
        VALID_SO = 'F';
        SUSPEND;
        EXIT;
    END
    /* GET VALID STATUSES */
    SELECT CONTROL.PICK_IMPORT_SSN_STATUS,CONTROL.PICK_RESERVED_SSN_STATUS,CONFIRM_WITH_NO_PROD
    FROM CONTROL
    INTO :IMPORTSTATUS, :RESERVEDSTATUS, :WK_NOCONFIRM;

    IF (WK_NOCONFIRM IS NULL) THEN
    BEGIN
       WK_NOCONFIRM = 'F';
    END
    IF (PICK_STATUS = 'HD') THEN
    BEGIN
       /* hold lines */
       WK_HELD_STATUS = 'HD';

       SELECT OPTIONS.DESCRIPTION, PICK_ORDER.PICK_STATUS
       FROM PICK_ORDER
       LEFT OUTER JOIN OPTIONS ON OPTIONS.GROUP_CODE = 'CMPPKHELD' AND OPTIONS.CODE = (PICK_ORDER.COMPANY_ID || '|' || PICK_ORDER.P_COUNTRY)
       WHERE PICK_ORDER.PICK_ORDER = :PICK_ORDER
       INTO :WK_HELD_STATUS, :WK_ORDER_STATUS;
       IF (WK_HELD_STATUS IS NULL) THEN
       BEGIN
          SELECT OPTIONS.DESCRIPTION, PICK_ORDER.PICK_STATUS
          FROM PICK_ORDER
          LEFT OUTER JOIN OPTIONS ON OPTIONS.GROUP_CODE = 'CMPPKHELD' AND OPTIONS.CODE = PICK_ORDER.COMPANY_ID 
          WHERE PICK_ORDER.PICK_ORDER = :PICK_ORDER
          INTO :WK_HELD_STATUS, :WK_ORDER_STATUS;
       END
       IF (WK_HELD_STATUS IS NULL) THEN
       BEGIN
          WK_HELD_STATUS = 'HD';
       END
       UPDATE PICK_ITEM
              SET PICK_LINE_STATUS = :WK_HELD_STATUS
              WHERE PICK_ORDER = :PICK_ORDER
              AND PICK_LINE_STATUS IN ('OP','UP','UC');
    END
    ELSE
    BEGIN
       IF (PICK_STATUS = 'UC' ) THEN
       BEGIN
          /* unhold lines */
          UPDATE PICK_ITEM
                 SET PICK_LINE_STATUS = :PICK_STATUS
                 WHERE PICK_ORDER = :PICK_ORDER
                 AND PICK_LINE_STATUS IN ('HD', 'AS');
       END
       ELSE
       BEGIN
          /* this is treated as a 'CF' */
          /* UPDATE PICK ITEM STATUS */
          FOR 
            SELECT PICK_LABEL_NO, SSN_ID, PROD_ID
            FROM PICK_ITEM
            WHERE PICK_ORDER = :PICK_ORDER
            AND ((PICK_ITEM.PICK_LINE_STATUS IS NULL) OR (PICK_ITEM.PICK_LINE_STATUS = 'UC'))
            INTO :SPICKLABELNO, :SSSN, :SPROD_ID
          DO
          BEGIN
            IF (:SSSN IS NOT NULL) THEN
            BEGIN
               SSSN = ALLTRIM(SSSN);
               IF (SSSN = '') THEN
               BEGIN
                  SSSN = NULL;
               END
            END
            IF (:SPROD_ID IS NOT NULL) THEN
            BEGIN
               SPROD_ID = ALLTRIM(SPROD_ID);
               IF (SPROD_ID = '') THEN
               BEGIN
                  SPROD_ID = NULL;
               END
            END
            IF (:SSSN IS NOT NULL) THEN 
            BEGIN
                    WK_FOUND = 0;
                    /* CHECK TO FIND AN ISSN THAT CAN BE RESERVED */
                    /* what about matching the company and wh_id to that in the order !! */
                    /* WHERE ISSN.ORIGINAL_SSN = :SSSN */
                    /* AND (ISSN.PICK_ORDER IS NULL OR ISSN.PICK_ORDER = :SPICKLABELNO) */
                    SELECT FIRST 1 1, ORIGINAL_SSN, WH_ID, LOCN_ID 
                    FROM ISSN
                    WHERE ISSN.SSN_ID = :SSSN
                    AND (POS(:IMPORTSTATUS,ISSN.ISSN_STATUS,0,1) > -1)
                    AND (ISSN.PICK_ORDER IS NULL OR ISSN.PICK_ORDER = :SPICKLABELNO OR ISSN.PICK_ORDER = '')
                    INTO :WK_FOUND, :WK_SSNID, :SWH, :SLOCN;
                    IF (WK_FOUND = 1) THEN 
                    BEGIN
                       /* UPDATE ISSN STATUS*/
                       /* WHERE SSN_ID = :WK_SSNID */
                       UPDATE ISSN
                       SET ISSN_STATUS = :STATUS_SSN,
                           PICK_ORDER = :SPICKLABELNO
                       WHERE SSN_ID = :SSSN;
                       /* UPDATE SSN STATUS*/
                       IF (SSSN = WK_SSNID) THEN
                       BEGIN
                          UPDATE SSN
                          SET STATUS_SSN = :STATUS_SSN
                          WHERE SSN_ID = :SSSN;
                       END
                       IF (:PICK_STATUS = 'CF') THEN
                       BEGIN
                         /* UPDATE WH, LOCATION IN PICK ITEM */
                         UPDATE PICK_ITEM
                         SET WH_ID = :SWH,
                             PICK_LOCATION = :SLOCN,
                             PICK_LINE_STATUS = :PICK_STATUS,
                             PICK_ITEM.REASON = ''
                         WHERE PICK_LABEL_NO = :SPICKLABELNO;
                       END
                    END
                    ELSE 
                    BEGIN
                       WK_FOUND = 0;
                       /* CHECK TO FIND AN ISSN THAT CAN BE RESERVED */
                       /* WHERE ISSN.ORIGINAL_SSN = :SSSN */
                       SELECT FIRST 1 1, ORIGINAL_SSN, WH_ID, LOCN_ID, SSN_ID 
                       FROM ISSN
                       WHERE ISSN.ORIGINAL_SSN = :SSSN
                       AND (POS(:IMPORTSTATUS,ISSN.ISSN_STATUS,0,1) > -1)
                       AND (ISSN.PICK_ORDER IS NULL OR ISSN.PICK_ORDER = :SPICKLABELNO OR ISSN.PICK_ORDER = '')
                       INTO :WK_FOUND, :WK_SSNID, :SWH, :SLOCN, :WK_ISSN_ID;
                       IF (WK_FOUND = 1) THEN 
                       BEGIN
                          /* UPDATE ISSN STATUS*/
                          /* WHERE SSN_ID = :WK_SSNID */
                          /*  cannot update the issn  since dont know which will be taken
                          UPDATE ISSN
                          SET ISSN_STATUS = :STATUS_SSN,
                              PICK_ORDER = :SPICKLABELNO
                          WHERE SSN_ID = :WK_ISSN_ID;
                          */
                          IF (SSSN = WK_SSNID) THEN
                          BEGIN
                             UPDATE SSN
                             SET STATUS_SSN = :STATUS_SSN
                             WHERE SSN_ID = :SSSN;
                          END
                          IF (:PICK_STATUS = 'CF') THEN
                          BEGIN
                            /* UPDATE WH, LOCATION IN PICK ITEM */
                            UPDATE PICK_ITEM
                            SET WH_ID = :SWH,
                                PICK_LOCATION = :SLOCN,
                                PICK_LINE_STATUS = :PICK_STATUS,
                                PICK_ITEM.REASON = ''
                            WHERE PICK_LABEL_NO = :SPICKLABELNO;
                          END
                       END
                       ELSE 
                       BEGIN
                          IF (WK_NOCONFIRM = 'F') THEN
                          BEGIN
                             VALID_SO = 'F';
                             UPDATE PICK_ITEM
                             SET PICK_ITEM.REASON = 'NO ITEM FOUND TO RESERVE'
                             WHERE PICK_LABEL_NO = :SPICKLABELNO;
                          END
                          ELSE 
                          BEGIN
                             /* here doing a confirm without ssn !!!! */
                             /* so stop this
                             IF (:PICK_STATUS = 'CF') THEN
                             BEGIN
                                -* UPDATE WH, LOCATION IN PICK ITEM *-
                                UPDATE PICK_ITEM
                                SET PICK_LINE_STATUS = :PICK_STATUS,
                                PICK_ITEM.REASON = ''
                                WHERE PICK_LABEL_NO = :SPICKLABELNO;
                             END
                             */
                             VALID_SO = 'F';
                             UPDATE PICK_ITEM
                             SET PICK_ITEM.REASON = 'NO ITEM FOUND TO RESERVE'
                             WHERE PICK_LABEL_NO = :SPICKLABELNO;
                          END
                       END
                    END
            END
            ELSE 
            BEGIN
               WK_FOUND = 0;
               IF (WK_NOCONFIRM = 'F') THEN
               BEGIN
                  /* CHECK TO FIND AN ISSN THAT CAN BE RESERVED */
                    /* what about matching the company and wh_id to that in the order !! */
                  SELECT FIRST 1 1, SSN_ID, WH_ID, LOCN_ID FROM ISSN
                  WHERE ISSN.PROD_ID = :SPROD_ID
                  AND (POS(:IMPORTSTATUS,ISSN.ISSN_STATUS,0,1) > -1)
                  INTO :WK_FOUND, :WK_SSNID, :SWH, :SLOCN;
                  IF (WK_FOUND = 1) THEN 
                  BEGIN
                     IF (:PICK_STATUS = 'CF') THEN
                     BEGIN
                       /* UPDATE WH, LOCATION IN PICK ITEM */
                       UPDATE PICK_ITEM
                       SET WH_ID = :SWH,
                           PICK_LOCATION = :SLOCN,
                           PICK_LINE_STATUS = :PICK_STATUS,
                           PICK_ITEM.REASON = ''
                       WHERE PICK_LABEL_NO = :SPICKLABELNO;
                     END
                  END
                  ELSE 
                  BEGIN
                     VALID_SO = 'F';
                     UPDATE PICK_ITEM
                     SET PICK_ITEM.REASON = 'NO PRODUCT ITEM FOUND TO RESERVE'
                     WHERE PICK_LABEL_NO = :SPICKLABELNO;
                  END
               END
               ELSE
               BEGIN
                  /* here doing a confirm without product  */
                  IF (:PICK_STATUS = 'CF') THEN
                  BEGIN
                    /* UPDATE WH, LOCATION IN PICK ITEM */
                    UPDATE PICK_ITEM
                    SET PICK_LINE_STATUS = :PICK_STATUS,
                        PICK_ITEM.REASON = ''
                    WHERE PICK_LABEL_NO = :SPICKLABELNO;
                  END
               END
            END
          END
       END /* else from unhold */
    END /* else from hold */
    
    /* UPDATE PICK ORDER STATUS */
    IF (VALID_SO = 'T') THEN 
    BEGIN
       IF (:PICK_STATUS = 'OP') THEN
       BEGIN
          UPDATE PICK_ORDER
          SET PICK_STATUS = :PICK_STATUS,
              APPROVED_DATE = 'NOW',
              APPROVED_BY = :APPROVED_BY
          WHERE PICK_ORDER = :PICK_ORDER;
       END
       ELSE
       BEGIN
          IF (:PICK_STATUS = 'HD') THEN
          BEGIN
             IF (WK_HELD_STATUS = 'HD') THEN
             BEGIN
                UPDATE PICK_ORDER
                SET PICK_STATUS = :PICK_STATUS
                WHERE PICK_ORDER = :PICK_ORDER;
             END
          END
          ELSE
          BEGIN
             UPDATE PICK_ORDER
             SET PICK_STATUS = :PICK_STATUS
             WHERE PICK_ORDER = :PICK_ORDER;
          END
       END
    END
    /* WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, 'end confirm ' || VALID_SO); */
    SUSPEND;
END ^

ALTER PROCEDURE UPDATE_SSN (OBJECT VARCHAR(30) CHARACTER SET NONE,
TRN_TYPE VARCHAR(4) CHARACTER SET NONE,
FIELD_VALUE VARCHAR(40) CHARACTER SET NONE)
AS 
DECLARE VARIABLE strCODE VARCHAR(40);       
  DECLARE VARIABLE strTYPE VARCHAR(40);
  DECLARE VARIABLE strGENERIC VARCHAR(40);
  DECLARE VARIABLE strBRAND VARCHAR(40);
  DECLARE VARIABLE strMODEL VARCHAR(40);
  DECLARE VARIABLE strPROD_ID VARCHAR(30);
  DECLARE VARIABLE strSUPPLIER VARCHAR(40);
  DECLARE VARIABLE strOTHER6 VARCHAR(50);
  DECLARE VARIABLE strOTHER7 VARCHAR(50);
  DECLARE VARIABLE strOTHER8 VARCHAR(50);
  DECLARE VARIABLE strOTHER9 VARCHAR(50);
  DECLARE VARIABLE strOTHER10 VARCHAR(50);
  DECLARE VARIABLE strDESCRIPTION VARCHAR(50);  
  DECLARE VARIABLE WK_CODE VARCHAR(50);  
  
BEGIN
    /* Update SSN table */   
    IF (:TRN_TYPE = 'NITP') THEN      /* Update Type */
    BEGIN
      UPDATE SSN
      SET SSN_TYPE = :FIELD_VALUE
      WHERE SSN_ID = :OBJECT;
    END
    ELSE IF (:TRN_TYPE = 'NIOB') THEN  /* Update Generic */
    BEGIN
      UPDATE SSN
      SET GENERIC = :FIELD_VALUE
      WHERE SSN_ID = :OBJECT;
    END
    ELSE IF (:TRN_TYPE = 'NIBC') THEN  /* Update Brand */
    BEGIN
      UPDATE SSN
      SET BRAND = :FIELD_VALUE
      WHERE SSN_ID = :OBJECT;
    END
    ELSE IF (:TRN_TYPE = 'NIMO') THEN  /* Update Model */
    BEGIN
      UPDATE SSN
      SET MODEL = :FIELD_VALUE
      WHERE SSN_ID = :OBJECT;
    END
    ELSE IF (:TRN_TYPE = 'PSRF') THEN  /* Update GRN */
    BEGIN
      UPDATE SSN
      SET GRN = :FIELD_VALUE
      WHERE SSN_ID = :OBJECT;
    END
    ELSE IF (:TRN_TYPE = 'NISN') THEN  /* Update Serial Number */
    BEGIN
      UPDATE SSN
      SET SERIAL_NUMBER = :FIELD_VALUE
      WHERE SSN_ID = :OBJECT;
      UPDATE ISSN
      SET SERIAL_NUMBER = :FIELD_VALUE
      WHERE SSN_ID = :OBJECT;
    END
    ELSE IF (:TRN_TYPE = 'NICC') THEN  /* Update Cost Center */
    BEGIN
      UPDATE SSN
      SET COST_CENTER = :FIELD_VALUE
      WHERE SSN_ID = :OBJECT;
    END
    ELSE IF (:TRN_TYPE = 'NIO1') THEN  /* Update Other1 */ 
    BEGIN
      UPDATE SSN
      SET OTHER1 = :FIELD_VALUE
      WHERE SSN_ID = :OBJECT;
    END
    ELSE IF (:TRN_TYPE = 'NIO2') THEN  /* Update Other2 */
    BEGIN
      UPDATE SSN
      SET OTHER2 = :FIELD_VALUE
      WHERE SSN_ID = :OBJECT;
    END
    ELSE IF (:TRN_TYPE = 'NIO3') THEN  /* Update Other3 */
    BEGIN
      UPDATE SSN
      SET OTHER3 = :FIELD_VALUE
      WHERE SSN_ID = :OBJECT;
    END
    ELSE IF (:TRN_TYPE = 'NIO4') THEN  /* Update Other4 */ 
    BEGIN
      UPDATE SSN
      SET OTHER4 = :FIELD_VALUE
      WHERE SSN_ID = :OBJECT;
    END
    ELSE IF (:TRN_TYPE = 'NIO5') THEN  /* Update Other5 */
    BEGIN
      UPDATE SSN
      SET OTHER5 = :FIELD_VALUE
      WHERE SSN_ID = :OBJECT;
    END
    ELSE IF (:TRN_TYPE = 'NIO6') THEN  /* Update Other6 */
    BEGIN
      UPDATE SSN
      SET OTHER6 = :FIELD_VALUE
      WHERE SSN_ID = :OBJECT;
    END
    ELSE IF (:TRN_TYPE = 'NIO7') THEN  /* Update Other7 */
    BEGIN
      UPDATE SSN
      SET OTHER7 = :FIELD_VALUE
      WHERE SSN_ID = :OBJECT;
    END
    ELSE IF (:TRN_TYPE = 'NIO8') THEN  /* Update Other8 */
    BEGIN
      UPDATE SSN
      SET OTHER8 = :FIELD_VALUE
      WHERE SSN_ID = :OBJECT;
    END
    ELSE IF (:TRN_TYPE = 'NIO9') THEN  /* Update Other9 */
    BEGIN
      UPDATE SSN
      SET OTHER9 = :FIELD_VALUE
      WHERE SSN_ID = :OBJECT;
    END
    ELSE IF (:TRN_TYPE = 'NIOA') THEN  /* Update Other10 */
    BEGIN
      UPDATE SSN
      SET OTHER10 = :FIELD_VALUE
      WHERE SSN_ID = :OBJECT;
    END
    ELSE IF (:TRN_TYPE = 'NILG') THEN  /* Update LegacyID */
    BEGIN
      UPDATE SSN
      SET LEGACY_ID = :FIELD_VALUE
      WHERE SSN_ID = :OBJECT;
    END
    ELSE IF (:TRN_TYPE = 'NIST') THEN  /* Update Status Code */
    BEGIN
          UPDATE SSN
          SET STATUS_CODE = :FIELD_VALUE
          WHERE SSN_ID = :OBJECT;
    END
    ELSE IF (:TRN_TYPE = 'NILX') THEN  /* Update Label Location */
    BEGIN
          UPDATE SSN
          SET LABEL_LOCN = :FIELD_VALUE
          WHERE SSN_ID = :OBJECT;
    END
    ELSE IF (:TRN_TYPE = 'NIOK') THEN  /* Update Other19 */
    BEGIN
          UPDATE SSN
          SET OTHER19 = :FIELD_VALUE
          WHERE SSN_ID = :OBJECT;
    END
    ELSE IF (:TRN_TYPE = 'NIPC') THEN  /* Update Product */
    BEGIN
          UPDATE SSN
          SET PROD_ID = :FIELD_VALUE
          WHERE SSN_ID = :OBJECT;
          UPDATE ISSN
          SET PROD_ID = :FIELD_VALUE
          WHERE ORIGINAL_SSN = :OBJECT;
    END
    ELSE IF (:TRN_TYPE = 'NIOL') THEN  /* Update Other20 */
    BEGIN
          UPDATE SSN
          SET OTHER20 = :FIELD_VALUE
          WHERE SSN_ID = :OBJECT;
    END
    ELSE IF (:TRN_TYPE = 'NI11') THEN  /* Update Other11 */
    BEGIN
          UPDATE SSN
          SET OTHER11 = :FIELD_VALUE
          WHERE SSN_ID = :OBJECT;
    END
    ELSE IF (:TRN_TYPE = 'NI12') THEN  /* Update Other12 */
    BEGIN
          UPDATE SSN
          SET OTHER12 = :FIELD_VALUE
          WHERE SSN_ID = :OBJECT;
    END
    ELSE IF (:TRN_TYPE = 'NI13') THEN  /* Update Other13 */
    BEGIN
          UPDATE SSN
          SET OTHER13 = :FIELD_VALUE
          WHERE SSN_ID = :OBJECT;
    END
    ELSE IF (:TRN_TYPE = 'NI14') THEN  /* Update Other14 */
    BEGIN
          UPDATE SSN
          SET OTHER14 = :FIELD_VALUE
          WHERE SSN_ID = :OBJECT;
    END
    ELSE IF (:TRN_TYPE = 'NI15') THEN  /* Update Other15 */
    BEGIN
          UPDATE SSN
          SET OTHER15_DATE = CAST(:FIELD_VALUE AS TIMESTAMP)
          WHERE SSN_ID = :OBJECT;
    END
    ELSE IF (:TRN_TYPE = 'NI16') THEN  /* Update Other16 */
    BEGIN
          UPDATE SSN
          SET OTHER16_DATE = CAST(:FIELD_VALUE AS TIMESTAMP)
          WHERE SSN_ID = :OBJECT;
    END
    ELSE IF (:TRN_TYPE = 'NI17') THEN  /* Update Other17 */
    BEGIN
          UPDATE SSN
          SET OTHER17_QTY = :FIELD_VALUE 
          WHERE SSN_ID = :OBJECT;
    END
    ELSE IF (:TRN_TYPE = 'NI18') THEN  /* Update Other18 */
    BEGIN
          UPDATE SSN
          SET OTHER18_QTY = :FIELD_VALUE 
          WHERE SSN_ID = :OBJECT;
    END
    ELSE IF (:TRN_TYPE = 'NI19') THEN  /* Update Other19 */
    BEGIN
          UPDATE SSN
          SET OTHER19 = :FIELD_VALUE
          WHERE SSN_ID = :OBJECT;
    END
    ELSE IF (:TRN_TYPE = 'NI20') THEN  /* Update Other20 */
    BEGIN
          UPDATE SSN
          SET OTHER20 = :FIELD_VALUE
          WHERE SSN_ID = :OBJECT;
    END
    ELSE IF (:TRN_TYPE = 'NISU') THEN  /* Update Supplier */
    BEGIN
          UPDATE SSN
          SET SUPPLIER_ID = :FIELD_VALUE
          WHERE SSN_ID = :OBJECT;
    END
    ELSE IF (:TRN_TYPE = 'NIPD') THEN  /* Update Assets Product*/
    BEGIN
          UPDATE SSN
          SET PRODUCT = :FIELD_VALUE
          WHERE SSN_ID = :OBJECT;
    END
    ELSE IF (:TRN_TYPE = 'NID3') THEN  /* Update Assets Sub Type*/
    BEGIN
          UPDATE SSN
          SET SSN_SUB_TYPE = :FIELD_VALUE
          WHERE SSN_ID = :OBJECT;
    END
    ELSE IF (:TRN_TYPE = 'NICI') THEN  /* Update Assets Company*/
    BEGIN
          UPDATE SSN
          SET COMPANY_ID = :FIELD_VALUE
          WHERE SSN_ID = :OBJECT;
          UPDATE ISSN
          SET COMPANY_ID = :FIELD_VALUE
          WHERE ORIGINAL_SSN = :OBJECT;
    END
    ELSE IF (:TRN_TYPE = 'NIGC') THEN  /* Group copy */
    BEGIN
        strTYPE = '';
        strGENERIC = '';
        strBRAND = '';
        strMODEL = '';
        strPROD_ID = '';
        strSUPPLIER = '';
        strOTHER6 = '';
        strOTHER7 = '';
        strOTHER8 = '';
        strOTHER9 = '';
        strOTHER10 = '';
        strDESCRIPTION = '';
        SELECT CODE, SSN_TYPE, GENERIC, BRAND, MODEL, PROD_ID, SUPPLIER_ID, OTHER6, OTHER7, OTHER8, OTHER9, OTHER10, DESCRIPTION 
        FROM GROUP_COPY 
        WHERE CODE = :FIELD_VALUE
        INTO :strCODE, :strTYPE, :strGENERIC, :strBRAND, :strMODEL, :strPROD_ID, :strSUPPLIER, :strOTHER6, :strOTHER7, :strOTHER8, :strOTHER9, :strOTHER10, :strDESCRIPTION; 
    
        IF (strCODE <> '') THEN
        BEGIN 
          EXECUTE PROCEDURE PC_GROUP_COPY :OBJECT, :strTYPE, :strGENERIC, :strBRAND, :strMODEL,  :strPROD_ID, :strSUPPLIER, :strOTHER6, :strOTHER7, :strOTHER8, :strOTHER9, :strOTHER10, :strDESCRIPTION; 
           IF (strTYPE <> '') THEN
           BEGIN
                  EXECUTE PROCEDURE ADD_MASTER_DATA('NITP', 'NOW', :strTYPE); 
           END
           IF (strGENERIC <> '') THEN
           BEGIN
                  WK_CODE = :OBJECT || '|' || :strGENERIC; 
                  EXECUTE PROCEDURE ADD_MASTER_DATA('NIOB', 'NOW', :WK_CODE); 
           END
           IF (strBRAND <> '') THEN
           BEGIN
                  EXECUTE PROCEDURE ADD_MASTER_DATA('NIBC', 'NOW', :strBRAND); 
           END
           IF (strMODEL <> '') THEN
           BEGIN
                  EXECUTE PROCEDURE ADD_MASTER_DATA('NIMO', 'NOW', :strMODEL); 
           END
           IF (strOTHER6 <> '') THEN
           BEGIN
                  EXECUTE PROCEDURE ADD_GROUP_DATA('NIO6', 'NOW', :strOTHER6, :strTYPE); 
           END
           IF (strOTHER7 <> '') THEN
           BEGIN
                  EXECUTE PROCEDURE ADD_GROUP_DATA('NIO7', 'NOW', :strOTHER7, :strTYPE); 
           END
           IF (strOTHER8 <> '') THEN
           BEGIN
                  EXECUTE PROCEDURE ADD_GROUP_DATA('NIO8', 'NOW', :strOTHER8, :strTYPE); 
           END
           IF (strOTHER9 <> '') THEN
           BEGIN
                  EXECUTE PROCEDURE ADD_GROUP_DATA('NIO9', 'NOW', :strOTHER9, :strTYPE); 
           END
           IF (strOTHER10 <> '') THEN
           BEGIN
                  EXECUTE PROCEDURE ADD_GROUP_DATA('NIOA', 'NOW', :strOTHER10, :strTYPE); 
           END
        END
    END
    
END ^

ALTER PROCEDURE UPDATE_SSN_DESC AS 
 
                       

DECLARE VARIABLE sSSN VARCHAR(20);
DECLARE VARIABLE sSSN_DESC VARCHAR(80);

BEGIN    
    
    /* Get SSN to update */
/*
    FOR 
      SELECT SSN_ID, LEFTS(
         ALLTRIM(NONULL(SSN_TYPE)) || ' ' || 
         ALLTRIM(NONULL(GENERIC)) || ' ' || 
         ALLTRIM(NONULL(BRAND)) || ' ' || 
         ALLTRIM(NONULL(MODEL)) || '[' || 
         ALLTRIM(NONULL(SERIAL_NUMBER)) || ']' || 
         ALLTRIM(NONULL(OTHER1) ) || ' ' || 
         ALLTRIM(NONULL(OTHER2) ) || ' ' || 
         ALLTRIM(NONULL(OTHER3) ) || ' ' || 
         ALLTRIM(NONULL(OTHER4) ) || ' ' ||
         ALLTRIM(NONULL(OTHER5) ) || ' ' || 
         ALLTRIM(NONULL(OTHER6) ) || ' ' || 
         ALLTRIM(NONULL(OTHER7) ) || ' ' || 
         ALLTRIM(NONULL(OTHER8) ) || ' ' || 
         ALLTRIM(NONULL(OTHER9) ) || ' ' || 
         ALLTRIM(NONULL(OTHER10)), 80) AS SSN_DESC
      FROM SSN
      WHERE (SSN_DESCRIPTION IS NULL OR SSN_DESCRIPTION = '')
      AND (STATUS_SSN = 'PA' OR STATUS_SSN = 'ST' OR STATUS_SSN = 'TS')
      AND WH_ID <> 'XX'
      INTO :sSSN, :sSSN_DESC
    DO
    BEGIN      
      -* Update SSN Description *-
      UPDATE SSN
      SET SSN_DESCRIPTION = :sSSN_DESC
      WHERE SSN_ID = :sSSN;
              
    END                     
*/
   sSSN = '';
END ^

ALTER PROCEDURE UPDATE_SSN_ISSN_LOCN AS 
 
 

DECLARE VARIABLE WK_SSN VARCHAR(30);
DECLARE VARIABLE WK_WH CHAR(2);
DECLARE VARIABLE WK_LOCN VARCHAR(10);
DECLARE VARIABLE WK_ISSN_WH CHAR(2);
DECLARE VARIABLE WK_ISSN_LOCN VARCHAR(10);

BEGIN 

   FOR SELECT SSN_ID, WH_ID, LOCN_ID 
      FROM SSN 
      INTO :WK_SSN, :WK_WH, :WK_LOCN
   DO
   BEGIN
      IF (SUBSTR(WK_LOCN,1,2) = 'DS') THEN
      BEGIN
         FOR SELECT WH_ID, LOCN_ID
         FROM ISSN
         WHERE SSN_ID = :WK_SSN
         INTO :WK_ISSN_WH, :WK_ISSN_LOCN
         DO
         BEGIN
            IF ((WK_WH <> WK_ISSN_WH) OR (WK_LOCN <> WK_ISSN_LOCN)) THEN
            BEGIN
               UPDATE ISSN SET WH_ID = :WK_WH, 
                  LOCN_ID = :WK_LOCN
                  WHERE SSN_ID = :WK_SSN;
            END
         END
      END
   END
END ^

ALTER PROCEDURE UPDATE_SSN_LOAN_STATUS (SSN_ID VARCHAR(20) CHARACTER SET NONE,
LOAN_STATUS VARCHAR(2) CHARACTER SET NONE)
AS 
                                                        
     
BEGIN
   /* Update SSN Status */   
   UPDATE SSN
   SET LOAN_STATUS = :LOAN_STATUS
   WHERE SSN_ID = :SSN_ID;
            
END ^

ALTER PROCEDURE UPDATE_SSN_PRODUCT_COND_STATUS (SSN_ID VARCHAR(20) CHARACTER SET NONE,
CODE VARCHAR(1) CHARACTER SET NONE,
ORIGINAL VARCHAR(1) CHARACTER SET NONE,
NOFAULT CHAR(1) CHARACTER SET NONE)
AS 
DECLARE VARIABLE REC_EXIST INTEGER;
  DECLARE VARIABLE WK_GLOBAL VARCHAR(30);
BEGIN

  IF (:ORIGINAL = 'S') THEN
  BEGIN
     IF (:CODE = 'A') THEN
     BEGIN
        EXECUTE PROCEDURE GET_GLOBAL_CONDITION 1, :NOFAULT RETURNING_VALUES :WK_GLOBAL;
        UPDATE SSN
        SET OTHER1 = :WK_GLOBAL
        WHERE SSN_ID = :SSN_ID;
     END
     ELSE IF (:CODE = 'B') THEN
     BEGIN
        EXECUTE PROCEDURE GET_GLOBAL_CONDITION 2, :NOFAULT RETURNING_VALUES :WK_GLOBAL;
        UPDATE SSN
        SET OTHER2 = :WK_GLOBAL
        WHERE SSN_ID = :SSN_ID;
     END
     ELSE IF (:CODE = 'C') THEN
     BEGIN
        EXECUTE PROCEDURE GET_GLOBAL_CONDITION 3, :NOFAULT RETURNING_VALUES :WK_GLOBAL;
        UPDATE SSN
        SET OTHER3 = :WK_GLOBAL
        WHERE SSN_ID = :SSN_ID;
     END
     ELSE IF (:CODE = 'D') THEN
     BEGIN
        EXECUTE PROCEDURE GET_GLOBAL_CONDITION 4, :NOFAULT RETURNING_VALUES :WK_GLOBAL;
        UPDATE SSN
        SET OTHER4 = :WK_GLOBAL
        WHERE SSN_ID = :SSN_ID;
     END
     ELSE IF (:CODE = 'E') THEN
     BEGIN
        EXECUTE PROCEDURE GET_GLOBAL_CONDITION 5, :NOFAULT RETURNING_VALUES :WK_GLOBAL;
        UPDATE SSN
        SET OTHER5 = :WK_GLOBAL
        WHERE SSN_ID = :SSN_ID;
     END
  END
END ^

ALTER PROCEDURE UPDATE_SSN_QTY_TROL (OBJECT VARCHAR(30) CHARACTER SET NONE,
QTY INTEGER)
AS 
 
 
                                                      
     
BEGIN
   /* Update CURRENT_QTY in SSN table */   
/*
   UPDATE SSN
   SET CURRENT_QTY = CURRENT_QTY + (:QTY)
   WHERE SSN_ID = :OBJECT;
*/
   UPDATE ISSN
   SET CURRENT_QTY = CURRENT_QTY + (:QTY)
   WHERE SSN_ID = :OBJECT;
         
   SUSPEND;
END ^

ALTER PROCEDURE UPDATE_SSN_STATUS (SSN_ID VARCHAR(20) CHARACTER SET NONE,
STATUS_SSN VARCHAR(2) CHARACTER SET NONE)
AS 
                                                         
     
BEGIN
   /* Update SSN Status */   
   UPDATE SSN
   SET STATUS_SSN = :STATUS_SSN
   WHERE SSN_ID = :SSN_ID;
            
END ^

ALTER PROCEDURE UPDATE_SSN_TRIL_A (OBJECT VARCHAR(30) CHARACTER SET NONE,
WH_ID CHAR(2) CHARACTER SET NONE,
LOCN_ID VARCHAR(10) CHARACTER SET NONE,
TRN_DATE TIMESTAMP,
QTY INTEGER,
TRN_CODE CHAR(1) CHARACTER SET NONE,
SUB_LOCN_ID VARCHAR(10) CHARACTER SET NONE,
DEVICE_ID CHAR(2) CHARACTER SET NONE,
PERSON_ID VARCHAR(10) CHARACTER SET NONE)
AS 
 
                                                       
  DECLARE VARIABLE strORIGINAL_SSN VARCHAR(20);
  DECLARE VARIABLE WK_PROD_IS_NULL INTEGER;
  DECLARE VARIABLE last_date TIMESTAMP;
  DECLARE VARIABLE WK_PROD VARCHAR(30);
  DECLARE VARIABLE WK_DO_UASL CHAR(1);
  DECLARE VARIABLE WK_DO_EXPORT_W CHAR(1);
  DECLARE VARIABLE WK_QTY INTEGER;
     
BEGIN
   /* Update SSN table */   
   WK_PROD = '';      
   SELECT ORIGINAL_SSN, INTO_DATE, PROD_ID FROM ISSN 
      WHERE SSN_ID = :OBJECT
      INTO :strORIGINAL_SSN, :last_date, :WK_PROD;
    IF (last_date IS NULL) THEN
    BEGIN
       last_date = CAST('JAN-01-2000' AS DATE);
    END
   IF (last_date < TRN_DATE) THEN
   BEGIN
      UPDATE ISSN
      SET WH_ID = :WH_ID, LOCN_ID = :LOCN_ID, INTO_DATE = :TRN_DATE,
          CURRENT_QTY = CURRENT_QTY + :QTY
      WHERE SSN_ID = :OBJECT;
      IF (strORIGINAL_SSN = OBJECT) THEN
      BEGIN
         UPDATE SSN
            SET WH_ID = :WH_ID, LOCN_ID = :LOCN_ID, INTO_DATE = :TRN_DATE,
          CURRENT_QTY = CURRENT_QTY + :QTY
         WHERE SSN_ID = :OBJECT;
      END
      /* IF (WK_QTY <> 0) THEN */
      BEGIN
         IF (WK_PROD IS NOT NULL) THEN
         BEGIN
            SELECT SEND_UASL_V4 FROM CONTROL INTO :WK_DO_UASL;
            IF (WK_DO_UASL = 'T') THEN
            BEGIN
               EXECUTE PROCEDURE SEND_PICKABLE_STOCK (:WK_PROD,
                  'BDCS',
                  'XX',
                  :TRN_DATE);
            END
         END
      END
      IF (TRN_CODE = 'W') THEN
      BEGIN
         WK_PROD_IS_NULL = 0;
         SELECT 1 FROM ISSN 
            WHERE SSN_ID = :OBJECT
              AND PROD_ID IS NULL
            INTO :WK_PROD_IS_NULL;
         IF (WK_PROD_IS_NULL = 1) THEN
         BEGIN
            /* an ssn */
            UPDATE SSN_TYPE 
            SET PUTAWAY_LOCATION = :LOCN_ID
            WHERE CODE IN (SELECT SSN_TYPE FROM SSN WHERE SSN_ID = :strORIGINAL_SSN);
         END
         ELSE
         BEGIN
            /* a product */
            UPDATE PROD_PROFILE
            SET HOME_LOCN_ID = :LOCN_ID
            WHERE PROD_ID IN (SELECT PROD_ID FROM ISSN WHERE SSN_ID = :OBJECT);
            SELECT EXPORT_TRIL_W 
            FROM CONTROL 
            INTO :WK_DO_EXPORT_W ;
            IF (WK_DO_EXPORT_W = 'T') THEN
            BEGIN
               INSERT INTO ISSN_PUTAWAY(SSN_ID, PUTAWAY_ID, CREATE_DATE, TRN_DATE, DEVICE_ID, PERSON_ID) VALUES(:OBJECT, :SUB_LOCN_ID, 'TODAY',:TRN_DATE, :DEVICE_ID, :PERSON_ID);
            END
         END
      END
   END
   ELSE
   BEGIN
      EXECUTE PROCEDURE ADD_SSN_HIST(:WH_ID, :LOCN_ID, :strORIGINAL_SSN, '', :TRN_CODE, :TRN_DATE,
      'No Update Prior to INTO Date', '', :QTY,  '', '');
   END
END ^

ALTER PROCEDURE UPDATE_SSN_TROL_A (OBJECT VARCHAR(30) CHARACTER SET NONE,
WH_ID CHAR(2) CHARACTER SET NONE,
LOCN_ID VARCHAR(10) CHARACTER SET NONE,
TRN_DATE TIMESTAMP,
DEVICE_ID CHAR(2) CHARACTER SET NONE)
AS 
 
 
 
                                                      
  DECLARE VARIABLE strORIGINAL_SSN VARCHAR(20);
  DECLARE VARIABLE last_date TIMESTAMP;
     
BEGIN
   /* Update SSN table */   
/*
   UPDATE SSN
   SET PREV_LOCN_ID = :LOCN_ID, LOCN_ID = :DEVICE_ID, WH_ID = :WH_ID,
       DT_PREV_INTO = :TRN_DATE
   WHERE SSN_ID = :OBJECT;
*/
   
   SELECT ORIGINAL_SSN, INTO_DATE FROM ISSN 
      WHERE SSN_ID = :OBJECT
      INTO :strORIGINAL_SSN, :last_date;
   IF (last_date IS NULL) THEN
   BEGIN
      last_date = CAST('JAN-01-2000' AS DATE);
   END
   IF (last_date < TRN_DATE) THEN
   BEGIN
      UPDATE ISSN
      SET PREV_PREV_LOCN_ID = PREV_LOCN_ID, PREV_PREV_WH_ID = PREV_WH_ID, 
          PREV_LOCN_ID = LOCN_ID, PREV_WH_ID = WH_ID, 
          LOCN_ID = :DEVICE_ID, WH_ID = :WH_ID,
          PREV_DATE = :TRN_DATE
      WHERE SSN_ID = :OBJECT;
      IF (strORIGINAL_SSN = OBJECT) THEN
      BEGIN
         UPDATE SSN
         SET PREV_LOCN_ID = LOCN_ID, LOCN_ID = :DEVICE_ID, WH_ID = :WH_ID,
             DT_PREV_INTO = :TRN_DATE
         WHERE SSN_ID = :OBJECT;
         
      END
   END
   ELSE
   BEGIN
      IF (LEN(DEVICE_ID) > 2) THEN
      BEGIN
         EXECUTE PROCEDURE ADD_SSN_HIST(:WH_ID, :DEVICE_ID, :strORIGINAL_SSN, '', '', :TRN_DATE,
         'No Update Prior to INTO Date', '', 0,  '', :LOCN_ID);
      END
      ELSE
      BEGIN
         EXECUTE PROCEDURE ADD_SSN_HIST(:WH_ID, :LOCN_ID, :strORIGINAL_SSN, '', '', :TRN_DATE,
         'No Update Prior to INTO Date', '', 0,  '', :DEVICE_ID);
      END
   END
END ^

ALTER PROCEDURE UPDATE_SSN_TROL_A10 (OBJECT VARCHAR(30) CHARACTER SET NONE,
WH_ID CHAR(2) CHARACTER SET NONE,
LOCN_ID VARCHAR(10) CHARACTER SET NONE,
TRN_DATE TIMESTAMP,
DEVICE_ID VARCHAR(10) CHARACTER SET NONE)
AS 
 
 
                                                      
  DECLARE VARIABLE strORIGINAL_SSN VARCHAR(20);
  DECLARE VARIABLE last_date TIMESTAMP;
     
BEGIN
   /* Update SSN table */   
/*
   UPDATE SSN
   SET PREV_LOCN_ID = :LOCN_ID, LOCN_ID = :DEVICE_ID, WH_ID = :WH_ID,
       DT_PREV_INTO = :TRN_DATE
   WHERE SSN_ID = :OBJECT;
*/
   
   SELECT ORIGINAL_SSN, INTO_DATE FROM ISSN 
      WHERE SSN_ID = :OBJECT
      INTO :strORIGINAL_SSN, :last_date;
   IF (last_date IS NULL) THEN
   BEGIN
      last_date = CAST('JAN-01-2000' AS DATE);
   END
   IF (last_date < TRN_DATE) THEN
   BEGIN
      UPDATE ISSN
      SET PREV_PREV_LOCN_ID = PREV_LOCN_ID, PREV_PREV_WH_ID = PREV_WH_ID, 
          PREV_LOCN_ID = :LOCN_ID, PREV_WH_ID = WH_ID, 
          LOCN_ID = :DEVICE_ID, WH_ID = :WH_ID,
          PREV_DATE = :TRN_DATE
      WHERE SSN_ID = :OBJECT;
      IF (strORIGINAL_SSN = OBJECT) THEN
      BEGIN
         UPDATE SSN
         SET PREV_LOCN_ID = :LOCN_ID, LOCN_ID = :DEVICE_ID, WH_ID = :WH_ID,
             DT_PREV_INTO = :TRN_DATE
         WHERE SSN_ID = :OBJECT;
         
      END
   END
   ELSE
   BEGIN
      IF (LEN(DEVICE_ID) > 2) THEN
      BEGIN
         EXECUTE PROCEDURE ADD_SSN_HIST(:WH_ID, :DEVICE_ID, :strORIGINAL_SSN, '', '', :TRN_DATE,
         'No Update Prior to INTO Date', '', 0,  '', :LOCN_ID);
      END
      ELSE
      BEGIN
         EXECUTE PROCEDURE ADD_SSN_HIST(:WH_ID, :LOCN_ID, :strORIGINAL_SSN, '', '', :TRN_DATE,
         'No Update Prior to INTO Date', '', 0,  '', :DEVICE_ID);
      END
   END
END ^

ALTER PROCEDURE UPDATE_TRAN (RECORD_ID INTEGER,
COMPLETE CHAR(1) CHARACTER SET NONE,
ERROR_TEXT VARCHAR(255) CHARACTER SET NONE)
AS 
BEGIN
    /* Update transactions table */
    UPDATE TRANSACTIONS
    SET COMPLETE = :COMPLETE, ERROR_TEXT = :ERROR_TEXT
    WHERE RECORD_ID = :RECORD_ID;
 
    SUSPEND;
END ^

ALTER PROCEDURE UPDATE_TRAN4 (RECORD_ID INTEGER,
COMPLETE CHAR(1) CHARACTER SET NONE,
ERROR_TEXT VARCHAR(255) CHARACTER SET NONE)
AS 
 
 
 
 
BEGIN
    /* Update transactions4 table */
    UPDATE TRANSACTIONS4
    SET COMPLETE = :COMPLETE, ERROR_TEXT = :ERROR_TEXT
    WHERE RECORD_ID = :RECORD_ID;
 
    SUSPEND;
END ^

ALTER PROCEDURE WEB_REQUEST4_ARCHIVE AS 
 
      
BEGIN
  
  /* Add record to WEB_REQUESTS_ARCHIVE table first */

  INSERT INTO WEB_REQUESTS_ARCHIVE 
     (MESSAGE_ID, TRN_VERSION, TRN_TYPE, TRN_CLASS, TRN_DATE, 
      PERSON_ID, DEVICE_ID, TRN_PRIORITY, TRN_REPLY_DATE, REQUEST_STATUS, 
      ERROR_TEXT )
       
  SELECT MESSAGE_ID, TRN_VERSION, TRN_TYPE, TRN_CLASS, TRN_DATE, 
      PERSON_ID, DEVICE_ID, TRN_PRIORITY, TRN_REPLY_DATE, REQUEST_STATUS, 
      ERROR_TEXT 
  FROM WEB_REQUESTS
  WHERE REQUEST_STATUS = 'SR'
     OR REQUEST_STATUS STARTING 'E';
  
  /* Delete records from WEB_REQUESTS table with COMPLETE is True */
  DELETE FROM WEB_REQUESTS
  WHERE REQUEST_STATUS = 'SR'
     OR REQUEST_STATUS STARTING 'E';
  
END ^

ALTER PROCEDURE WORKTEST AS 
 
      
  DECLARE VARIABLE REC_EXIST INTEGER; 
  DECLARE VARIABLE WK_SSN VARCHAR(20); 
  DECLARE VARIABLE WK_CODE CHAR(1); 
  DECLARE VARIABLE WK_DESC VARCHAR(50); 
BEGIN
  
  /* Check if master record exists */
  FOR SELECT SSN_ID, CODE, DESCRIPTION 
      FROM PRODUCT_COND_STATUS 
      WHERE ORIGINAL_TEST = 'S'
      INTO :WK_SSN, :WK_CODE,:WK_DESC
  DO
  BEGIN
   REC_EXIST = 0;
   SELECT 1
   FROM PRODUCT_COND_STATUS
   WHERE SSN_ID = :WK_SSN
   AND CODE = :WK_CODE
   AND DESCRIPTION = :WK_DESC  
   AND ORIGINAL_TEST = 'O'  
   INTO :REC_EXIST;  
   IF (REC_EXIST = 0) THEN
   BEGIN
      INSERT INTO PRODUCT_COND_STATUS   
          (SSN_ID, CODE, DESCRIPTION, ORIGINAL_TEST)
      VALUES (:WK_SSN, :WK_CODE, :WK_DESC, 'O');             
   END
  END
END ^
SET TERM ; ^
COMMIT WORK ;
SET AUTODDL ON;
SET TERM ^ ;

/* Triggers only will work for SQL triggers */
CREATE TRIGGER BARCODE_CODE_ID FOR BARCODE_CODES 
ACTIVE BEFORE INSERT POSITION 0 
AS
BEGIN
  IF (NEW.RECORD_ID IS NULL) THEN
      NEW.RECORD_ID = GEN_ID(BARCODE_CODE_GEN, 1);
  IF (NEW.RECORD_ID = 0) THEN
      NEW.RECORD_ID = GEN_ID(BARCODE_CODE_GEN, 1);
END ^

CREATE TRIGGER ADD_CARRIER_SERVICE FOR CARRIER_SERVICE 
ACTIVE BEFORE INSERT POSITION 10 
AS
BEGIN
   IF ((NEW.RECORD_ID IS NULL) OR (NEW.RECORD_ID = 0)) THEN
   BEGIN
      NEW.RECORD_ID  = GEN_ID(CARRIER_SERVICE_ID_GEN,1);
   END
   NEW.LAST_UPDATE_DATE = 'NOW';
END ^

CREATE TRIGGER UPD_CARRIER_SERVICE FOR CARRIER_SERVICE 
ACTIVE BEFORE UPDATE POSITION 10 
AS
BEGIN
   IF ((NEW.RECORD_ID IS NULL) OR (NEW.RECORD_ID = 0)) THEN
   BEGIN
      NEW.RECORD_ID  = GEN_ID(CARRIER_SERVICE_ID_GEN,1);
   END
   NEW.LAST_UPDATE_DATE = 'NOW';
END ^

CREATE TRIGGER ADD_CHART_OF_ACCOUNTS FOR CHART_OF_ACCOUNTS 
ACTIVE BEFORE INSERT POSITION 10 
AS
BEGIN
   IF ((NEW.RECORD_ID IS NULL) OR (NEW.RECORD_ID = 0)) THEN
   BEGIN
      NEW.RECORD_ID  = GEN_ID(CHART_ACCOUNTS_ID_GEN,1);
   END
END ^

CREATE TRIGGER UPD_CHART_OF_ACCOUNTS FOR CHART_OF_ACCOUNTS 
ACTIVE BEFORE UPDATE POSITION 10 
AS
BEGIN
   IF ((NEW.RECORD_ID IS NULL) OR (NEW.RECORD_ID = 0)) THEN
   BEGIN
      NEW.RECORD_ID  = GEN_ID(CHART_ACCOUNTS_ID_GEN,1);
   END
END ^

CREATE TRIGGER INSERT_COST_CENTRE FOR COST_CENTRE 
INACTIVE AFTER INSERT POSITION 10 
AS
DECLARE VARIABLE WK_CODE VARCHAR(40);
DECLARE VARIABLE WK_DESC VARCHAR(50);

DECLARE VARIABLE WK_DIRECTORY VARCHAR(80);
DECLARE VARIABLE WK_FILENAME VARCHAR(255);
DECLARE VARIABLE WK_LABEL_LINE VARCHAR(250);
DECLARE VARIABLE WK_RESULT INTEGER;
DECLARE VARIABLE WK_QUOTE CHAR(1);
BEGIN
   WK_QUOTE = chr(39);
   WK_CODE = NEW.CODE;
   WK_DESC = NEW.DESCRIPTION;

   SELECT EMPLOYEE_FTP_DIRECTORY FROM CONTROL INTO :WK_DIRECTORY;
   WK_FILENAME = WK_DIRECTORY || 'newcost.trn';
   WK_LABEL_LINE = WK_QUOTE || WK_CODE || WK_QUOTE || ',' ||
   WK_QUOTE || WK_DESC || WK_QUOTE  ;

   WK_RESULT = FILE_WRITE(WK_FILENAME, WK_LABEL_LINE);
   IF (WK_RESULT <> 0) THEN
   BEGIN
      WK_FILENAME = WK_DIRECTORY || 'newcost.2rn';
      WK_RESULT = FILE_WRITE(WK_FILENAME, WK_LABEL_LINE);
   END

END ^

CREATE TRIGGER UPDATE_COST_CENTRE FOR COST_CENTRE 
INACTIVE AFTER UPDATE POSITION 10 
AS
DECLARE VARIABLE WK_CODE VARCHAR(40);
DECLARE VARIABLE WK_DESC VARCHAR(50);

DECLARE VARIABLE WK_DIRECTORY VARCHAR(80);
DECLARE VARIABLE WK_FILENAME VARCHAR(255);
DECLARE VARIABLE WK_LABEL_LINE VARCHAR(250);
DECLARE VARIABLE WK_RESULT INTEGER;
DECLARE VARIABLE WK_QUOTE CHAR(1);

BEGIN
   WK_QUOTE = chr(39);
   WK_CODE = NEW.CODE;
   WK_DESC = NEW.DESCRIPTION;

   SELECT EMPLOYEE_FTP_DIRECTORY FROM CONTROL INTO :WK_DIRECTORY;
   WK_FILENAME = WK_DIRECTORY || 'updcost.trn';
   WK_LABEL_LINE = WK_QUOTE || WK_CODE || WK_QUOTE || ',' ||
   WK_QUOTE || WK_DESC || WK_QUOTE ;

   WK_RESULT = FILE_WRITE(WK_FILENAME, WK_LABEL_LINE);
   IF (WK_RESULT <> 0) THEN
   BEGIN
      WK_FILENAME = WK_DIRECTORY || 'updcost.2rn';
      WK_RESULT = FILE_WRITE(WK_FILENAME, WK_LABEL_LINE);
   END


END ^

CREATE TRIGGER DELETE_COST_CENTRE FOR COST_CENTRE 
INACTIVE AFTER DELETE POSITION 0 
AS
DECLARE VARIABLE WK_CODE VARCHAR(40);
DECLARE VARIABLE WK_DIRECTORY VARCHAR(80);
DECLARE VARIABLE WK_FILENAME VARCHAR(255);
DECLARE VARIABLE WK_LABEL_LINE VARCHAR(255);
DECLARE VARIABLE WK_RESULT INTEGER;
BEGIN
   WK_CODE = OLD.CODE;
   SELECT EMPLOYEE_FTP_DIRECTORY FROM CONTROL INTO :WK_DIRECTORY;
   WK_FILENAME = WK_DIRECTORY || 'delcost.trn';
   WK_LABEL_LINE = SQUOTEDSTR(WK_CODE) ;
   WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE);
   IF (WK_RESULT <> 0) THEN
   BEGIN
      WK_FILENAME = WK_DIRECTORY || 'delcost.2rn';
      WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE);
   END

END ^

CREATE TRIGGER EMP_SKILL_DEFAULT_TRG FOR EMPLOYEE 
ACTIVE AFTER INSERT POSITION 1 
AS
BEGIN
 EXECUTE PROCEDURE ADD_EMP_SKILL_DEFAULT(NEW.EMPLOYEE_ID); 
END ^

CREATE TRIGGER DELETE_EMPLOYEE FOR EMPLOYEE 
INACTIVE AFTER DELETE POSITION 0 
AS
DECLARE VARIABLE WK_CODE VARCHAR(10);
DECLARE VARIABLE WK_DIRECTORY VARCHAR(80);
DECLARE VARIABLE WK_FILENAME VARCHAR(255);
DECLARE VARIABLE WK_LABEL_LINE VARCHAR(255);
DECLARE VARIABLE WK_RESULT INTEGER;
BEGIN
   WK_CODE = OLD.EMPLOYEE_ID;
   SELECT EMPLOYEE_FTP_DIRECTORY FROM CONTROL INTO :WK_DIRECTORY;
   WK_FILENAME = WK_DIRECTORY || 'delemp.trn';
   WK_LABEL_LINE = SQUOTEDSTR(WK_CODE) ;
   WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE);
   IF (WK_RESULT <> 0) THEN
   BEGIN
      WK_FILENAME = WK_DIRECTORY || 'delemp.2rn';
      WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE);
   END

END ^

CREATE TRIGGER INSERT_SKILLS FOR EMPLOYEE_SKILL 
INACTIVE BEFORE INSERT POSITION 0 
AS
DECLARE VARIABLE WK_PERSON VARCHAR(10);
DECLARE VARIABLE WK_CODE VARCHAR(40);
DECLARE VARIABLE WK_DATE TIMESTAMP;
DECLARE VARIABLE WK_BY VARCHAR(10);
DECLARE VARIABLE WK_LOCN VARCHAR(40);
DECLARE VARIABLE WK_AUTH VARCHAR(50);
DECLARE VARIABLE WK_PASS CHAR(1);
DECLARE VARIABLE WK_TRESULT VARCHAR(20);
DECLARE VARIABLE WK_CERT TIMESTAMP;
DECLARE VARIABLE WK_COMPULSORY CHAR(1) ;
DECLARE VARIABLE WK_FOUND INTEGER;
BEGIN
   WK_PERSON = NEW.EMPLOYEE_ID;
   WK_CODE = NEW.SKILL_CODE;
   WK_DATE = NEW.TRAINING_DATE;
   WK_BY = NEW.TRAINING_BY;
   WK_LOCN = NEW.TRAINING_LOCATION;
   WK_AUTH = NEW.TRAINING_AUTHORITY;
   WK_PASS = NEW.TRAINING_PASS;
   WK_TRESULT = NEW.TRAINING_RESULT;
   WK_CERT = NEW.TRAINING_CERT_PRTD_DATE;
   WK_COMPULSORY = NEW.COMPULSORY_SKILL;
   WK_FOUND = 0;
   SELECT 1 
   FROM TRAINING_SKILL
      WHERE PERSON_ID = :WK_PERSON
        AND TRAINING_CODE = :WK_CODE
        AND TRAINING_DATE = :WK_DATE
   INTO WK_FOUND;
   IF (WK_FOUND = 1) THEN
   BEGIN
      UPDATE TRAINING_SKILL SET
         TRAINING_BY =
                 :WK_BY,
         TRAINING_LOCATION =
                 :WK_LOCN,
         TRAINING_AUTHORITY =
                 :WK_AUTH,
         TRAINING_PASS =
                 :WK_PASS,
         TRAINING_RESULT =
                 :WK_TRESULT,
         TRAINING_CERT_PRINTED =
                 :WK_CERT,
         COMPULSORY_SKILL =
                 :WK_COMPULSORY
      WHERE PERSON_ID = :WK_PERSON
        AND TRAINING_CODE = :WK_CODE
        AND TRAINING_DATE = :WK_DATE;
   END
   ELSE
   BEGIN
      INSERT INTO TRAINING_SKILL(
         PERSON_ID ,
         TRAINING_CODE, 
         TRAINING_DATE, 
         TRAINING_BY ,
         TRAINING_LOCATION ,
         TRAINING_AUTHORITY ,
         TRAINING_PASS ,
         TRAINING_RESULT ,
         TRAINING_CERT_PRINTED ,
         COMPULSORY_SKILL)
         VALUES (:WK_PERSON,
                 :WK_CODE,
                 :WK_DATE,
                 :WK_BY,
                 :WK_LOCN,
                 :WK_AUTH,
                 :WK_PASS,
                 :WK_TRESULT,
                 :WK_CERT,
                 :WK_COMPULSORY);
            
   END

END ^

CREATE TRIGGER UPDATE_SKILLS FOR EMPLOYEE_SKILL 
INACTIVE BEFORE UPDATE POSITION 0 
AS
DECLARE VARIABLE WK_PERSON VARCHAR(10);
DECLARE VARIABLE WK_CODE VARCHAR(40);
DECLARE VARIABLE WK_DATE TIMESTAMP;
DECLARE VARIABLE WK_BY VARCHAR(10);
DECLARE VARIABLE WK_LOCN VARCHAR(40);
DECLARE VARIABLE WK_AUTH VARCHAR(50);
DECLARE VARIABLE WK_PASS CHAR(1);
DECLARE VARIABLE WK_TRESULT VARCHAR(20);
DECLARE VARIABLE WK_CERT TIMESTAMP;
DECLARE VARIABLE WK_COMPULSORY CHAR(1) ;
DECLARE VARIABLE WK_FOUND INTEGER;
BEGIN
   WK_PERSON = NEW.EMPLOYEE_ID;
   WK_CODE = NEW.SKILL_CODE;
   WK_DATE = NEW.TRAINING_DATE;
   WK_BY = NEW.TRAINING_BY;
   WK_LOCN = NEW.TRAINING_LOCATION;
   WK_AUTH = NEW.TRAINING_AUTHORITY;
   WK_PASS = NEW.TRAINING_PASS;
   WK_TRESULT = NEW.TRAINING_RESULT;
   WK_CERT = NEW.TRAINING_CERT_PRTD_DATE;
   WK_COMPULSORY = NEW.COMPULSORY_SKILL;
   WK_FOUND = 0;
   SELECT 1 
   FROM TRAINING_SKILL
      WHERE PERSON_ID = :WK_PERSON
        AND TRAINING_CODE = :WK_CODE
        AND TRAINING_DATE = :WK_DATE
   INTO WK_FOUND;
   IF (WK_FOUND = 1) THEN
   BEGIN
      UPDATE TRAINING_SKILL SET
         TRAINING_BY =
                 :WK_BY,
         TRAINING_LOCATION =
                 :WK_LOCN,
         TRAINING_AUTHORITY =
                 :WK_AUTH,
         TRAINING_PASS =
                 :WK_PASS,
         TRAINING_RESULT =
                 :WK_TRESULT,
         TRAINING_CERT_PRINTED =
                 :WK_CERT,
         COMPULSORY_SKILL =
                 :WK_COMPULSORY
      WHERE PERSON_ID = :WK_PERSON
        AND TRAINING_CODE = :WK_CODE
        AND TRAINING_DATE = :WK_DATE;
   END
   ELSE
   BEGIN
      INSERT INTO TRAINING_SKILL(
         PERSON_ID ,
         TRAINING_CODE, 
         TRAINING_DATE, 
         TRAINING_BY ,
         TRAINING_LOCATION ,
         TRAINING_AUTHORITY ,
         TRAINING_PASS ,
         TRAINING_RESULT ,
         TRAINING_CERT_PRINTED ,
         COMPULSORY_SKILL)
         VALUES (:WK_PERSON,
                 :WK_CODE,
                 :WK_DATE,
                 :WK_BY,
                 :WK_LOCN,
                 :WK_AUTH,
                 :WK_PASS,
                 :WK_TRESULT,
                 :WK_CERT,
                 :WK_COMPULSORY);
            
   END

END ^

CREATE TRIGGER ADD_GENERIC FOR GENERIC 
ACTIVE BEFORE INSERT POSITION 10 
AS
BEGIN
   IF (NEW.CODE IS NOT NULL ) THEN
   BEGIN
      IF (LEN(NEW.CODE) <> LEN(ALLTRIM(NEW.CODE))) THEN
      BEGIN
         NEW.CODE  = ALLTRIM(NEW.CODE);
      END
   END
END ^

CREATE TRIGGER MOD_GENERIC FOR GENERIC 
ACTIVE BEFORE UPDATE POSITION 10 
AS
BEGIN
   IF (NEW.CODE IS NOT NULL ) THEN
   BEGIN
      IF (LEN(NEW.CODE) <> LEN(ALLTRIM(NEW.CODE))) THEN
      BEGIN
         NEW.CODE  = ALLTRIM(NEW.CODE);
      END
   END
END ^

CREATE TRIGGER ADD_GRN_TIME FOR GRN 
ACTIVE BEFORE INSERT POSITION 20 
AS
BEGIN
   NEW.LAST_UPDATE_DATE = 'NOW';
END ^

CREATE TRIGGER UPDATE_GRN_TIME FOR GRN 
ACTIVE BEFORE UPDATE POSITION 20 
AS
BEGIN
   NEW.LAST_UPDATE_DATE = 'NOW';
END ^

CREATE TRIGGER SAVE_GRN FOR GRN 
ACTIVE BEFORE DELETE POSITION 0 
AS
BEGIN
   INSERT INTO GRN_CANCEL (
        GRN  ,
        GRN_TYPE ,
        TOTAL_QTY_PACKS ,
        PACK_EAN_SSCC ,
        CARRIER ,
        VEHICLE_ID ,
        AWB_CONSIGNMENT_NO ,
        GRN_PALLET_QTY ,
        DELIVERY_DOCKET ,
        PALLETS_YN ,
        CONTAINER_NO ,
        COMMENTS ,
        GRN_PRINTED ,
        USER_ID ,
        DEVICE_ID ,
        GRN_DATE ,
        ORDER_NO ,
        ORDER_LINE_NO ,
        RETURN_ID ,
        SHIPPED_DATE ,
        RECEIPT_FLAG ,
        LAST_UPDATE_DATE ,
        OWNER_ID ,
        LAST_LINE_NO ,
        LAST_PALLET_NO ,
        SHIP_CONTAINER_TYPE ,
        PACK_CRATE_OWNER ,
        PACK_CRATE_TYPE ,
        PACK_CRATE_QTY ,
        CONTAINER_TYPE ,
        SHIPPING_CRATE_OWNER ,
        SHIPPING_CRATE_TYPE ,
        SHIPPING_CRATE_QTY ,
        GRN_DUE_DATE ,
        GRN_STATUS ,
        GRN_FREIGHT_FORWARDER ,
        GRN_FREIGHT_ACCOUNT_NO ,
        REASON ,
        CANCEL_DATE ,
        CANCEL_METHOD )
   VALUES (
        OLD.GRN  ,
        OLD.GRN_TYPE ,
        OLD.TOTAL_QTY_PACKS ,
        OLD.PACK_EAN_SSCC ,
        OLD.CARRIER ,
        OLD.VEHICLE_ID ,
        OLD.AWB_CONSIGNMENT_NO ,
        OLD.GRN_PALLET_QTY ,
        OLD.DELIVERY_DOCKET ,
        OLD.PALLETS_YN ,
        OLD.CONTAINER_NO ,
        OLD.COMMENTS ,
        OLD.GRN_PRINTED ,
        OLD.USER_ID ,
        OLD.DEVICE_ID ,
        OLD.GRN_DATE ,
        OLD.ORDER_NO ,
        OLD.ORDER_LINE_NO ,
        OLD.RETURN_ID ,
        OLD.SHIPPED_DATE ,
        OLD.RECEIPT_FLAG ,
        OLD.LAST_UPDATE_DATE ,
        OLD.OWNER_ID ,
        OLD.LAST_LINE_NO ,
        OLD.LAST_PALLET_NO ,
        OLD.SHIP_CONTAINER_TYPE ,
        OLD.PACK_CRATE_OWNER ,
        OLD.PACK_CRATE_TYPE ,
        OLD.PACK_CRATE_QTY ,
        OLD.CONTAINER_TYPE ,
        OLD.SHIPPING_CRATE_OWNER ,
        OLD.SHIPPING_CRATE_TYPE ,
        OLD.SHIPPING_CRATE_QTY ,
        OLD.GRN_DUE_DATE ,
        OLD.GRN_STATUS ,
        OLD.GRN_FREIGHT_FORWARDER ,
        OLD.GRN_FREIGHT_ACCOUNT_NO ,
        'Record Deleted' ,
        'NOW' ,
        'D' );

END ^

CREATE TRIGGER SAVE_GRN_ORDER FOR GRN_ORDER 
ACTIVE BEFORE DELETE POSITION 0 
AS
BEGIN
   INSERT INTO GRN_ORDER_CANCEL (
        GRN  ,
        ORDER_NO ,
        GRN_LABEL_NO  ,
        COMPANY_ID ,
        SUPPLIER_ID ,
        CREATE_DATE ,
        CREATED_BY ,
        LOT_NO ,
        LOT_LINE_NO ,
        REASON ,
        LAST_UPDATE_DATE ,
        CANCEL_METHOD,
        LABEL_EXTENSION,
        GRN_PARENT_LABEL_ID )
   VALUES (
        OLD.GRN  ,
        OLD.ORDER_NO ,
        OLD.GRN_LABEL_NO  ,
        OLD.COMPANY_ID ,
        OLD.SUPPLIER_ID ,
        OLD.CREATE_DATE ,
        OLD.CREATED_BY ,
        OLD.LOT_NO ,
        OLD.LOT_LINE_NO ,
        'Record Deleted' ,
        'NOW' ,
        'D',
        OLD.LABEL_EXTENSION ,
        OLD.GRN_PARENT_LABEL_ID );

END ^

CREATE TRIGGER ADD_IMPORT_MAP FOR IMPORT_MAP 
ACTIVE BEFORE INSERT POSITION 20 
AS
BEGIN
   IF (NEW.RECORD_ID IS NULL OR NEW.RECORD_ID = 0) THEN
   BEGIN
      NEW.RECORD_ID = GEN_ID(IMPORT_MAP_ID_GEN,1);
   END

END ^

CREATE TRIGGER INSERT_ISSN_STATUS FOR ISSN 
ACTIVE BEFORE INSERT POSITION 0 
AS
DECLARE VARIABLE WK_STATUS CHAR(2);
DECLARE VARIABLE WK_COMPANY VARCHAR(20);
BEGIN
   IF (NEW.ISSN_STATUS IS NULL) THEN
   BEGIN
      /* Get the STatus to use for the inserts */
      SELECT NEW_SSN_STATUS FROM CONTROL
      INTO :WK_STATUS;
      NEW.ISSN_STATUS = WK_STATUS;
   END
   IF (NEW.COMPANY_ID IS NULL) THEN
   BEGIN
      /* Get the STatus to use for the inserts */
      SELECT COMPANY_ID FROM CONTROL
      INTO :WK_COMPANY;
      NEW.COMPANY_ID = WK_COMPANY;
   END
   IF (NEW.ORIGINAL_SSN IS NULL) THEN
   BEGIN
      /* Use the ssn id */
      NEW.ORIGINAL_SSN = NEW.SSN_ID;
   END
END ^

CREATE TRIGGER ADD_ISSN_REPLENISH FOR ISSN 
ACTIVE BEFORE INSERT POSITION 10 
AS
/* check replenish of this product in location */
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_DEVICE CHAR(2);
DECLARE VARIABLE WK_RECORD INTEGER;
DECLARE VARIABLE WK_DATE TIMESTAMP;
DECLARE VARIABLE WK_PROD VARCHAR(30);
DECLARE VARIABLE WK_WH_ID CHAR(2);
DECLARE VARIABLE WK_LOCN VARCHAR(10);
DECLARE VARIABLE WK_QTY INTEGER;
DECLARE VARIABLE WK_PROD_ID2 VARCHAR(30);
DECLARE VARIABLE WK_MIN_QTY INTEGER;
DECLARE VARIABLE WK_MAX_QTY INTEGER;
DECLARE VARIABLE WK_REORDER_QTY INTEGER;
DECLARE VARIABLE WK_WH_QTY INTEGER;
DECLARE VARIABLE WK_CURRENT_QTY INTEGER;
DECLARE VARIABLE WK_FOUND INTEGER;
DECLARE VARIABLE WK_TRANSFER_LINE INTEGER;
DECLARE VARIABLE WK_TRANSFER_STATUS CHAR(2);
DECLARE VARIABLE WK_TRANSFER_PRIORITY SMALLINT;
DECLARE VARIABLE IMPORTSTATUS VARCHAR(40);
BEGIN
   WK_WH_ID = NEW.WH_ID;
   WK_LOCN = NEW.LOCN_ID;
   WK_PROD = NEW.PROD_ID;
   WK_QTY = NEW.CURRENT_QTY;
   WK_DATE = 'NOW';
   IF (WK_PROD IS NULL) THEN
   BEGIN
      WK_PROD = '';
   END
   IF (WK_QTY IS NULL) THEN
   BEGIN
      WK_QTY = 0;
   END
   
   IF (WK_PROD <> '') THEN
   BEGIN
      SELECT CONTROL.PICK_IMPORT_SSN_STATUS
      FROM CONTROL
      INTO :IMPORTSTATUS; 
      SELECT PROD_ID, MIN_QTY, MAX_QTY, REORDER_QTY
      FROM LOCATION
      WHERE WH_ID = :WK_WH_ID
      AND LOCN_ID = :WK_LOCN
      AND REPLENISH = 'T'
      AND (PROD_ID IS NOT NULL)
      AND (REORDER_QTY IS NOT NULL)
      AND (MAX_QTY IS NOT NULL)
      INTO :WK_PROD_ID2, 
           :WK_MIN_QTY,
           :WK_MAX_QTY,
           :WK_REORDER_QTY;
      IF (WK_PROD_ID2 IS NULL) THEN
      BEGIN
         WK_PROD_ID2 = '';
      END
      IF (WK_PROD = WK_PROD_ID2) THEN
      BEGIN
         /* ok have a match - and qts not null */
         /*
         SELECT AVAILABLE_QTY 
         FROM PRODUCT_STOCK_STATUS(:WK_PROD) 
         INTO :WK_WH_QTY;
         */
         WK_WH_QTY = 0;
         SELECT FIRST 1 CURRENT_QTY
         FROM ISSN
         JOIN LOCATION L1 ON L1.WH_ID = ISSN.WH_ID AND L1.LOCN_ID = ISSN.LOCN_ID
         WHERE ISSN.PROD_ID = :WK_PROD
         AND CURRENT_QTY > 0
         AND (POS(:IMPORTSTATUS,ISSN.ISSN_STATUS,0,1) > -1)
         AND L1.STORE_AREA <> 'PS'
         INTO :WK_WH_QTY;
         IF (WK_WH_QTY IS NULL) THEN
         BEGIN
            WK_WH_QTY = 0;
         END
         WK_WH_QTY = WK_WH_QTY + WK_QTY;
         IF (WK_WH_QTY > 0) THEN
         BEGIN
            WK_CURRENT_QTY = 0;
            SELECT SUM( ISSN.CURRENT_QTY ) 
               FROM ISSN
               WHERE ISSN.PROD_ID = :WK_PROD
               AND WH_ID = :WK_WH_ID
               AND LOCN_ID = :WK_LOCN
               AND (POS(:IMPORTSTATUS,ISSN.ISSN_STATUS,0,1) > -1)
               INTO :WK_CURRENT_QTY;
            IF (WK_CURRENT_QTY IS NULL) THEN
            BEGIN
               WK_CURRENT_QTY = 0;
            END
            WK_CURRENT_QTY = WK_CURRENT_QTY + WK_QTY;
            IF (WK_CURRENT_QTY < WK_REORDER_QTY) THEN
            BEGIN
               IF (WK_CURRENT_QTY < WK_MIN_QTY) THEN
               BEGIN
                  WK_TRANSFER_PRIORITY = 5;
               END
               ELSE
               BEGIN
                  WK_TRANSFER_PRIORITY = 10;
               END
               /* now get the transfer request to update */
               WK_FOUND = 0;
               SELECT FIRST 1 1, TRN_LINE_NO, TRN_STATUS
               FROM TRANSFER_REQUEST
               WHERE TO_WH_ID = :WK_WH_ID
               AND TO_LOCN_ID = :WK_LOCN
               AND PROD_ID = :WK_PROD
               AND TRN_STATUS IN ( 'OP', 'CN','AL','PL','PG')
               AND QTY IS NULL
               INTO :WK_FOUND, :WK_TRANSFER_LINE, :WK_TRANSFER_STATUS;
               IF (WK_FOUND = 0) THEN
               BEGIN
                  /* insert it */
                  /* only nominate the wh,locn ,product and priority */
                  INSERT INTO TRANSFER_REQUEST (TO_WH_ID, TO_LOCN_ID, PROD_ID, TRN_PRIORITY, TRN_STATUS) VALUES (:WK_WH_ID, :WK_LOCN, :WK_PROD, :WK_TRANSFER_PRIORITY, 'OP'); 
               END
               ELSE
               BEGIN
                  /* update it */
                  IF (WK_TRANSFER_STATUS = 'CN') THEN
                  BEGIN
                     UPDATE TRANSFER_REQUEST
                     SET TRN_STATUS = 'OP',
                     TRN_PRIORITY = :WK_TRANSFER_PRIORITY
                     WHERE TRN_LINE_NO = :WK_TRANSFER_LINE;
                  END
                  ELSE
                  BEGIN
                     IF (WK_TRANSFER_STATUS = 'OP') THEN
                     BEGIN
                        UPDATE TRANSFER_REQUEST
                        SET TRN_PRIORITY = :WK_TRANSFER_PRIORITY
                        WHERE TRN_LINE_NO = :WK_TRANSFER_LINE;
                     END
                     ELSE
                     BEGIN
                        IF (WK_TRANSFER_STATUS = 'AL') THEN
                        BEGIN
                           UPDATE TRANSFER_REQUEST
                           SET TRN_PRIORITY = :WK_TRANSFER_PRIORITY
                           WHERE TRN_LINE_NO = :WK_TRANSFER_LINE;
                        END
                     END
                  END

               END
               
            END            
            ELSE
            BEGIN
               /*
               need to remove / change status for 
               records with no qty that 
               were in the transfer request
               but now the qty is OK
               */
               UPDATE TRANSFER_REQUEST
               SET TRN_STATUS = 'CN'
               WHERE TO_WH_ID = :WK_WH_ID
               AND TO_LOCN_ID = :WK_LOCN
               AND PROD_ID = :WK_PROD
               AND TRN_STATUS = 'OP'
               AND QTY IS NULL;
            END
         END            
      END
      ELSE
      BEGIN
         /* replenish off for prod in location */
         UPDATE TRANSFER_REQUEST
         SET TRN_STATUS = 'CN',
         DEVICE_ID = NULL
         WHERE TO_WH_ID = :WK_WH_ID
         AND TO_LOCN_ID = :WK_LOCN
         AND PROD_ID = :WK_PROD
         AND TRN_STATUS IN ('OP','AL')
         AND QTY IS NULL;
      END
   END
END ^

CREATE TRIGGER ADD_ISSN_TIME FOR ISSN 
ACTIVE BEFORE INSERT POSITION 20 
AS
BEGIN
   NEW.LAST_UPDATE_DATE = 'NOW';
   IF (NEW.CREATE_DATE IS NULL) THEN
   BEGIN
      NEW.CREATE_DATE = 'NOW';
   END
   SELECT CREATE_DATE FROM SSN
   WHERE SSN_ID = NEW.ORIGINAL_SSN
   INTO NEW.ORIGINAL_CREATE_DATE;
END ^

CREATE TRIGGER UPDATE_ISSN_LOCATION FOR ISSN 
ACTIVE BEFORE UPDATE POSITION 0 
AS
                                                       
  DECLARE VARIABLE WK_FROM_STATUS VARCHAR(2);
  DECLARE VARIABLE WK_TO_STATUS VARCHAR(2);
  DECLARE VARIABLE WK_NEW_WH_ID VARCHAR(2);
  DECLARE VARIABLE WK_NEW_LOCN_ID VARCHAR(10);
  DECLARE VARIABLE WK_OLD_WH_ID VARCHAR(2);
  DECLARE VARIABLE WK_OLD_LOCN_ID VARCHAR(10);
  DECLARE VARIABLE WK_IS_OK CHAR(1);
  DECLARE VARIABLE WK_DOIT CHAR(1);
  DECLARE VARIABLE WK_SSN VARCHAR(20);
  DECLARE VARIABLE WK_SSN_QTY INTEGER;
  DECLARE VARIABLE WK_FOUND INTEGER;
  DECLARE VARIABLE WK_PID_FOUND INTEGER;
  DECLARE VARIABLE WK_LABEL_NO VARCHAR(7);
  DECLARE VARIABLE WK_USER VARCHAR(10);
  DECLARE VARIABLE WK_DETAIL_ID INTEGER;
  DECLARE VARIABLE WK_SSN_PICK_ORDER VARCHAR(20);
  DECLARE VARIABLE WK_MOVE_STAT CHAR(2);
     
BEGIN
   /* Update ISSN table */   
         
   WK_NEW_WH_ID = NEW.WH_ID;
   WK_NEW_LOCN_ID = NEW.LOCN_ID;
   WK_OLD_WH_ID = OLD.WH_ID;
   WK_OLD_LOCN_ID = OLD.LOCN_ID;
   WK_USER = NEW.USER_ID;
   IF ( (WK_NEW_WH_ID <> WK_OLD_WH_ID) OR
        (WK_NEW_LOCN_ID <> WK_OLD_LOCN_ID)) THEN
   BEGIN
      /* location changed */
      WK_FROM_STATUS = NEW.ISSN_STATUS;
      WK_SSN = NEW.SSN_ID;
      WK_SSN_QTY = NEW.CURRENT_QTY;
      WK_TO_STATUS = 'ST';
      /* does the new location exist */
      WK_FOUND = 0;
      SELECT 1 FROM LOCATION 
         WHERE WH_ID = :WK_NEW_WH_ID AND LOCN_ID = :WK_NEW_LOCN_ID
         INTO :WK_FOUND;
      IF (WK_FOUND IS NULL) THEN
      BEGIN
         WK_FOUND = 0;
      END
      IF (WK_FOUND = 0) THEN
      BEGIN
         /* location not found - so add it */
         WK_MOVE_STAT = NULL;
         SELECT DESCRIPTION FROM OPTIONS WHERE GROUP_CODE = 'WH_ST_MV' AND  CODE = :WK_NEW_WH_ID INTO :WK_MOVE_STAT;
         INSERT INTO LOCATION (WH_ID, LOCN_ID, LOCN_NAME, MOVE_STAT) VALUES (:WK_NEW_WH_ID, :WK_NEW_LOCN_ID, :WK_NEW_LOCN_ID, :WK_MOVE_STAT);
      END

      SELECT MOVE_STAT FROM LOCATION 
         WHERE WH_ID = :WK_NEW_WH_ID AND LOCN_ID = :WK_NEW_LOCN_ID
         INTO :WK_TO_STATUS;
      IF (WK_FROM_STATUS <> WK_TO_STATUS) THEN
      BEGIN
         /* a change in status possible - so check sys_moves */
         WK_IS_OK = 'N';
         SELECT UPDATE_FLAG FROM SYS_MOVES
            WHERE FROM_STATUS = :WK_FROM_STATUS AND INTO_STATUS = :WK_TO_STATUS
            INTO :WK_IS_OK;
         IF (WK_IS_OK = 'T') THEN
         BEGIN
            NEW.ISSN_STATUS = WK_TO_STATUS;
            IF (WK_FROM_STATUS = 'DI') THEN
            BEGIN
               /* move from Despatch on loan
                  so remove from confimation of previous order */
               NEW.PREV_PREV_PICK_ORDER = OLD.PREV_PICK_ORDER;
               NEW.PREV_PICK_ORDER = OLD.PICK_ORDER;
               NEW.PICK_ORDER = NULL;
               NEW.PREV_PREV_PACK_ID = OLD.PREV_PACK_ID;
               NEW.PREV_PACK_ID = OLD.PACK_ID;
               NEW.PACK_ID = NULL;
               NEW.PREV_PREV_DESPATCH_ID = OLD.PREV_DESPATCH_ID;
               NEW.PREV_DESPATCH_ID = OLD.DESPATCH_ID;
               NEW.DESPATCH_ID = NULL;
            END
            IF (WK_TO_STATUS = 'DS') THEN
            BEGIN
               WK_SSN_PICK_ORDER = NEW.PICK_ORDER;
               WK_DOIT = 'N';
               IF (WK_FROM_STATUS = 'PA') THEN
               BEGIN
                  WK_DOIT = 'Y';
               END
               IF (WK_FROM_STATUS = 'ST') THEN
               BEGIN
                  WK_DOIT = 'Y';
               END
               IF (WK_FROM_STATUS = 'RS') THEN
               BEGIN
                  WK_DOIT = 'Y';
               END
               IF (WK_FROM_STATUS = 'OP') THEN
               BEGIN
                  WK_DOIT = 'Y';
               END
               IF (WK_DOIT = 'Y') THEN
               BEGIN
                 WK_FOUND = 0;
                  /* AND (PICK_ITEM.SSN_CONFIRM = 'T' OR PICK_ITEM.SSN_CONFIRM IS NULL) */
                 /* if we do confirm of order
                    then 
                         want to match the correct line in issn versus pick_item
                    else
                         we import order as confirmed
                         but nothing in issns pick_order
                         so can only take the 1st pick_item for this issn
                 */
                 SELECT FIRST 1 1, PICK_ITEM.PICK_LABEL_NO 
                        FROM PICK_ITEM
                        JOIN PICK_ORDER ON PICK_ORDER.PICK_ORDER = PICK_ITEM.PICK_ORDER
                  WHERE PICK_ITEM.SSN_ID = :WK_SSN
                  AND   PICK_ITEM.PICK_LABEL_NO = :WK_SSN_PICK_ORDER 
                  AND (PICK_ITEM.SSN_CONFIRM = 'T' OR PICK_ITEM.SSN_CONFIRM = 'I' OR PICK_ITEM.SSN_CONFIRM IS NULL)
                  AND (PICK_ITEM.PICK_LINE_STATUS IN ('OP','UP','RS'))
                  AND (PICK_ORDER.PICK_STATUS IN ('OP','DA'))
                        INTO :WK_FOUND,
                             :WK_LABEL_NO;
                  IF (WK_FOUND IS NULL) THEN
                  BEGIN
                     WK_FOUND = 0;
                  END
                  /* disable using the older method - until someone wants to 
                     pick by transfer an unconfirmed order */
                  IF (WK_FOUND = 2) THEN
                  BEGIN
                     /* no pick item for this issn that is confirmed */
                     /* old method */
                     SELECT FIRST 1 1, PICK_ITEM.PICK_LABEL_NO 
                        FROM PICK_ITEM
                        JOIN PICK_ORDER ON PICK_ORDER.PICK_ORDER = PICK_ITEM.PICK_ORDER
                     WHERE PICK_ITEM.SSN_ID = :WK_SSN
                     AND (PICK_ITEM.SSN_CONFIRM = 'T' OR PICK_ITEM.SSN_CONFIRM = 'I' OR PICK_ITEM.SSN_CONFIRM IS NULL)
                     AND (PICK_ITEM.PICK_LINE_STATUS IN ('OP','UP','RS'))
                     AND (PICK_ORDER.PICK_STATUS IN ('OP','DA'))
                        INTO :WK_FOUND,
                             :WK_LABEL_NO;
                  END
                  IF (WK_FOUND = 1) THEN
                  BEGIN
                     UPDATE PICK_ITEM 
                     SET PICK_LINE_STATUS = 'DS',
                         PICKED_QTY = :WK_SSN_QTY,
                         DESPATCH_LOCATION = :WK_NEW_LOCN_ID 
                     WHERE SSN_ID = :WK_SSN
                     AND PICK_LABEL_NO = :WK_LABEL_NO;
                     WK_PID_FOUND = 0;
                     SELECT 1, PICK_DETAIL_ID 
                            FROM PICK_ITEM_DETAIL
                            WHERE PICK_LABEL_NO = :WK_LABEL_NO
                            AND SSN_ID = :WK_SSN
                            INTO :WK_PID_FOUND, :WK_DETAIL_ID;
                     IF (WK_PID_FOUND = 0) THEN
                     BEGIN
                        /* no detail record */
                        INSERT INTO PICK_ITEM_DETAIL 
                            (PICK_LABEL_NO, 
                             SSN_ID, 
                             PICK_DETAIL_STATUS, 
                             DESPATCH_LOCATION,
                             QTY_PICKED,
                             USER_ID, 
                             CREATE_DATE)
                        VALUES (:WK_LABEL_NO, 
                             :WK_SSN,
                             'DS',
                             :WK_NEW_LOCN_ID ,
                             :WK_SSN_QTY,
                             :WK_USER,
                             'NOW');
                     END
                     ELSE
                     BEGIN
                        UPDATE PICK_ITEM_DETAIL 
                        SET  PICK_DETAIL_STATUS =
                             'DS',
                             QTY_PICKED =
                             :WK_SSN_QTY ,
                             DESPATCH_LOCATION =
                             :WK_NEW_LOCN_ID ,
                             USER_ID =
                             :WK_USER
                        WHERE PICK_DETAIL_ID = :WK_DETAIL_ID;
                     END
                  END
               END
            END
            IF (WK_TO_STATUS = 'ST') THEN
            BEGIN
               IF (NEW.PROD_ID IS NOT NULL) THEN
               BEGIN
                  UPDATE PICK_ITEM
                  SET PICK_LINE_STATUS = 'OP'
                  WHERE PICK_ITEM.PROD_ID = NEW.PROD_ID 
                  AND   PICK_ITEM.PICK_LINE_STATUS = 'AS';
               END
            END
            IF (WK_FROM_STATUS = 'DS' AND WK_TO_STATUS = 'ST') THEN
            BEGIN
               /* move from Despatch location back to stock
                  so remove from confimation of previous order */
               NEW.PREV_PREV_PICK_ORDER = OLD.PREV_PICK_ORDER;
               NEW.PREV_PICK_ORDER = OLD.PICK_ORDER;
               NEW.PICK_ORDER = NULL;
               NEW.PREV_PREV_PACK_ID = OLD.PREV_PACK_ID;
               NEW.PREV_PACK_ID = OLD.PACK_ID;
               NEW.PACK_ID = NULL;
               NEW.PREV_PREV_DESPATCH_ID = OLD.PREV_DESPATCH_ID;
               NEW.PREV_DESPATCH_ID = OLD.DESPATCH_ID;
               NEW.DESPATCH_ID = NULL;
            END
         END
      END
   END
END ^

CREATE TRIGGER UPDATE_ISSN_REPLENISH FOR ISSN 
ACTIVE BEFORE UPDATE POSITION 10 
AS
/* check replenish of this product in location */
/*
this trigger updates the transfer_requests product based
for issn updates INTO a location
20-10-06
must amend to include updates OUT of a location
*/
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_DEVICE CHAR(2);
DECLARE VARIABLE WK_RECORD INTEGER;
DECLARE VARIABLE WK_DATE TIMESTAMP;
DECLARE VARIABLE WK_PROD VARCHAR(30);
DECLARE VARIABLE WK_WH_ID CHAR(2);
DECLARE VARIABLE WK_FROM_WH_ID CHAR(2);
DECLARE VARIABLE WK_LOCN VARCHAR(10);
DECLARE VARIABLE WK_FROM_LOCN VARCHAR(10);
DECLARE VARIABLE WK_QTY INTEGER;
DECLARE VARIABLE WK_OLD_QTY INTEGER;
DECLARE VARIABLE WK_PROD_ID2 VARCHAR(30);
DECLARE VARIABLE WK_MIN_QTY INTEGER;
DECLARE VARIABLE WK_MAX_QTY INTEGER;
DECLARE VARIABLE WK_REORDER_QTY INTEGER;
DECLARE VARIABLE WK_WH_QTY INTEGER;
DECLARE VARIABLE WK_CURRENT_QTY INTEGER;
DECLARE VARIABLE WK_FOUND INTEGER;
DECLARE VARIABLE WK_TRANSFER_LINE INTEGER;
DECLARE VARIABLE WK_TRANSFER_STATUS CHAR(2);
DECLARE VARIABLE WK_TRANSFER_PRIORITY SMALLINT;
DECLARE VARIABLE IMPORTSTATUS VARCHAR(40);
DECLARE VARIABLE WK_DUMMY INTEGER;
BEGIN
   WK_WH_ID = NEW.WH_ID;
   WK_FROM_WH_ID = OLD.WH_ID;
   WK_LOCN = NEW.LOCN_ID;
   WK_FROM_LOCN = OLD.LOCN_ID;
   WK_PROD = NEW.PROD_ID;
   WK_QTY = NEW.CURRENT_QTY;
   WK_OLD_QTY = OLD.CURRENT_QTY;
   WK_DATE = 'NOW';
   IF (WK_PROD IS NULL) THEN
   BEGIN
      WK_PROD = '';
   END
   IF (WK_QTY IS NULL) THEN
   BEGIN
      WK_QTY = 0;
   END
   IF (WK_OLD_QTY IS NULL) THEN
   BEGIN
      WK_OLD_QTY = 0;
   END
   
   IF (WK_PROD <> '') THEN
   BEGIN
      SELECT CONTROL.PICK_IMPORT_SSN_STATUS
      FROM CONTROL
      INTO :IMPORTSTATUS; 
      SELECT PROD_ID, MIN_QTY, MAX_QTY, REORDER_QTY
      FROM LOCATION
      WHERE WH_ID = :WK_WH_ID
      AND LOCN_ID = :WK_LOCN
      AND REPLENISH = 'T'
      AND (PROD_ID IS NOT NULL)
      AND (REORDER_QTY IS NOT NULL)
      AND (MAX_QTY IS NOT NULL)
      INTO :WK_PROD_ID2, 
           :WK_MIN_QTY,
           :WK_MAX_QTY,
           :WK_REORDER_QTY;
      IF (WK_PROD_ID2 IS NULL) THEN
      BEGIN
         WK_PROD_ID2 = '';
      END
      IF (WK_PROD = WK_PROD_ID2) THEN
      BEGIN
         /* ok have a match - iand qts not null */
         /*
         SELECT AVAILABLE_QTY 
         FROM PRODUCT_STOCK_STATUS(:WK_PROD) 
         INTO :WK_WH_QTY;
         */
         /*
         SELECT FIRST 1 CURRENT_QTY
         FROM ISSN
         WHERE ISSN.PROD_ID = :WK_PROD
         AND CURRENT_QTY > 0
         AND (POS(:IMPORTSTATUS,ISSN.ISSN_STATUS,0,1) > -1)
         */
         WK_WH_QTY = 0;
         SELECT FIRST 1 CURRENT_QTY
         FROM ISSN
         JOIN LOCATION L1 ON L1.WH_ID = ISSN.WH_ID AND L1.LOCN_ID = ISSN.LOCN_ID
         WHERE ISSN.PROD_ID = :WK_PROD
         AND CURRENT_QTY > 0
         AND (POS(:IMPORTSTATUS,ISSN.ISSN_STATUS,0,1) > -1)
         AND L1.STORE_AREA <> 'PS'
         INTO :WK_WH_QTY;
         IF (WK_WH_QTY IS NULL) THEN
         BEGIN
            WK_WH_QTY = 0;
         END
         IF (WK_WH_QTY > 0) THEN
         BEGIN
            WK_CURRENT_QTY = 0;
            SELECT SUM( ISSN.CURRENT_QTY ) 
               FROM ISSN
               WHERE ISSN.PROD_ID = :WK_PROD
               AND WH_ID = :WK_WH_ID
               AND LOCN_ID = :WK_LOCN
               /* AND (POS(:IMPORTSTATUS,ISSN.ISSN_STATUS,0,1) > -1) */
               INTO :WK_CURRENT_QTY;
            IF (WK_CURRENT_QTY IS NULL) THEN
            BEGIN
               WK_CURRENT_QTY = 0;
            END
            IF ((WK_WH_ID = WK_FROM_WH_ID) AND (WK_LOCN = WK_FROM_LOCN)) THEN
            BEGIN
               /* if was already in this location */
               WK_DUMMY = 1;
            END
            ELSE
            BEGIN
               /* if was in a different location or warehouse */
               WK_OLD_QTY = 0;
            END
            WK_CURRENT_QTY = WK_CURRENT_QTY + WK_QTY - WK_OLD_QTY;

            IF (WK_CURRENT_QTY < WK_REORDER_QTY) THEN
            BEGIN
               IF (WK_CURRENT_QTY < WK_MIN_QTY) THEN
               BEGIN
                  WK_TRANSFER_PRIORITY = 5;
               END
               ELSE
               BEGIN
                  WK_TRANSFER_PRIORITY = 10;
               END
               /* now get the transfer request to update */
               WK_FOUND = 0;
               SELECT FIRST 1 1, TRN_LINE_NO, TRN_STATUS
               FROM TRANSFER_REQUEST
               WHERE TO_WH_ID = :WK_WH_ID
               AND TO_LOCN_ID = :WK_LOCN
               AND PROD_ID = :WK_PROD
               AND TRN_STATUS IN ( 'OP', 'CN','AL','PG','PL')
               AND QTY IS NULL
               INTO :WK_FOUND, :WK_TRANSFER_LINE, :WK_TRANSFER_STATUS;
               IF (WK_FOUND = 0) THEN
               BEGIN
                  /* insert it */
                  /* only nominate the wh,locn ,product and priority */
                  INSERT INTO TRANSFER_REQUEST (TO_WH_ID, TO_LOCN_ID, PROD_ID, TRN_PRIORITY, TRN_STATUS) VALUES (:WK_WH_ID, :WK_LOCN, :WK_PROD, :WK_TRANSFER_PRIORITY, 'OP'); 
               END
               ELSE
               BEGIN
                  /* update it */
                  IF (WK_TRANSFER_STATUS = 'CN') THEN
                  BEGIN
                     UPDATE TRANSFER_REQUEST
                     SET TRN_STATUS = 'OP',
                     TRN_PRIORITY = :WK_TRANSFER_PRIORITY
                     WHERE TRN_LINE_NO = :WK_TRANSFER_LINE;
                  END
                  ELSE
                  BEGIN
                     IF (WK_TRANSFER_STATUS = 'OP') THEN
                     BEGIN
                        UPDATE TRANSFER_REQUEST
                        SET TRN_PRIORITY = :WK_TRANSFER_PRIORITY
                        WHERE TRN_LINE_NO = :WK_TRANSFER_LINE;
                     END
                     ELSE
                     BEGIN
                        IF (WK_TRANSFER_STATUS = 'AL') THEN
                        BEGIN
                           UPDATE TRANSFER_REQUEST
                           SET TRN_PRIORITY = :WK_TRANSFER_PRIORITY
                           WHERE TRN_LINE_NO = :WK_TRANSFER_LINE;
                        END
                     END
                  END
               END
            END            
            ELSE
            BEGIN
               /*
               need to remove / change status for 
               records with no qty that 
               were in the transfer request
               but now the qty is OK
               */
               UPDATE TRANSFER_REQUEST
               SET TRN_STATUS = 'CN'
               WHERE TO_WH_ID = :WK_WH_ID
               AND TO_LOCN_ID = :WK_LOCN
               AND PROD_ID = :WK_PROD
               AND TRN_STATUS = 'OP'
               AND QTY IS NULL;
            END
         END            
         ELSE
         BEGIN
            /*
            no qty in warehouse available 
            so  cancel request
            */
            UPDATE TRANSFER_REQUEST
            SET TRN_STATUS = 'CN',
            DEVICE_ID = NULL
            WHERE TO_WH_ID = :WK_WH_ID
            AND TO_LOCN_ID = :WK_LOCN
            AND PROD_ID = :WK_PROD
            AND TRN_STATUS IN ('OP','AL')
            AND QTY IS NULL;
         END
      END
      ELSE
      BEGIN
         /* replenish off for prod in location */
         UPDATE TRANSFER_REQUEST
         SET TRN_STATUS = 'CN',
         DEVICE_ID = NULL
         WHERE TO_WH_ID = :WK_WH_ID
         AND TO_LOCN_ID = :WK_LOCN
         AND PROD_ID = :WK_PROD
         AND TRN_STATUS IN ('OP','AL')
         AND QTY IS NULL;
      END
   END
END ^

CREATE TRIGGER UPDATE_ISSN_LOCN_LOG FOR ISSN 
ACTIVE BEFORE UPDATE POSITION 20 
AS
                                                       
  DECLARE VARIABLE WK_NEW_WH_ID VARCHAR(2);
  DECLARE VARIABLE WK_NEW_LOCN_ID VARCHAR(10);
  DECLARE VARIABLE WK_OLD_WH_ID VARCHAR(2);
  DECLARE VARIABLE WK_OLD_LOCN_ID VARCHAR(10);
  DECLARE VARIABLE WK_USER VARCHAR(10);
  DECLARE VARIABLE WK_ORIGINAL VARCHAR(20);
  DECLARE VARIABLE WK_BUFFER VARCHAR(512);
     
BEGIN
   /* Update ISSN table */   
         
   WK_NEW_WH_ID = NEW.WH_ID;
   WK_NEW_LOCN_ID = NEW.LOCN_ID;
   WK_OLD_WH_ID = OLD.WH_ID;
   WK_OLD_LOCN_ID = OLD.LOCN_ID;
   WK_ORIGINAL = NEW.ORIGINAL_SSN;
   WK_USER = NEW.USER_ID;
   IF (WK_USER IS NULL) THEN
      WK_USER = '';
   IF (WK_NEW_WH_ID IS NULL) THEN
      WK_NEW_WH_ID = '';
   IF (WK_NEW_LOCN_ID IS NULL) THEN
      WK_NEW_LOCN_ID = '';
   IF (WK_OLD_WH_ID IS NULL) THEN
      WK_OLD_WH_ID = '';
   IF (WK_OLD_LOCN_ID IS NULL) THEN
      WK_OLD_LOCN_ID = '';
   IF (WK_ORIGINAL IS NULL) THEN
      WK_ORIGINAL = '';
   IF ( (WK_NEW_WH_ID <> WK_OLD_WH_ID) OR
        (WK_NEW_LOCN_ID <> WK_OLD_LOCN_ID)) THEN
   BEGIN
      /* location changed */
      WK_BUFFER = NEW.SSN_ID || ' ISSN orig ' || WK_ORIGINAL || ' ISSN Location changed from ' || WK_OLD_WH_ID || '-' || WK_OLD_LOCN_ID;
      WK_BUFFER = WK_BUFFER || ' to ' || WK_NEW_WH_ID || '-' || WK_NEW_LOCN_ID;
      WK_BUFFER = WK_BUFFER || ' by ' || WK_USER;
      INSERT INTO LOG(DESCRIPTION) VALUES (:WK_BUFFER);
   END
END ^

CREATE TRIGGER UPDATE_ISSN_REPLENISH_FROM FOR ISSN 
ACTIVE BEFORE UPDATE POSITION 20 
AS
/* check replenish of this product in location */
/*
this trigger updates the transfer_requests product based
for issn updates OUT of a location
*/
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_DEVICE CHAR(2);
DECLARE VARIABLE WK_RECORD INTEGER;
DECLARE VARIABLE WK_DATE TIMESTAMP;
DECLARE VARIABLE WK_PROD VARCHAR(30);
DECLARE VARIABLE WK_WH_ID CHAR(2);
DECLARE VARIABLE WK_TO_WH_ID CHAR(2);
DECLARE VARIABLE WK_LOCN VARCHAR(10);
DECLARE VARIABLE WK_TO_LOCN VARCHAR(10);
DECLARE VARIABLE WK_QTY INTEGER;
DECLARE VARIABLE WK_OLD_QTY INTEGER;
DECLARE VARIABLE WK_PROD_ID2 VARCHAR(30);
DECLARE VARIABLE WK_MIN_QTY INTEGER;
DECLARE VARIABLE WK_MAX_QTY INTEGER;
DECLARE VARIABLE WK_REORDER_QTY INTEGER;
DECLARE VARIABLE WK_WH_QTY INTEGER;
DECLARE VARIABLE WK_CURRENT_QTY INTEGER;
DECLARE VARIABLE WK_FOUND INTEGER;
DECLARE VARIABLE WK_TRANSFER_LINE INTEGER;
DECLARE VARIABLE WK_TRANSFER_STATUS CHAR(2);
DECLARE VARIABLE WK_TRANSFER_PRIORITY SMALLINT;
DECLARE VARIABLE IMPORTSTATUS VARCHAR(40);
DECLARE VARIABLE WK_DUMMY INTEGER;
BEGIN
   WK_WH_ID = OLD.WH_ID;
   WK_TO_WH_ID = NEW.WH_ID;
   WK_LOCN = OLD.LOCN_ID;
   WK_TO_LOCN = NEW.LOCN_ID;
   WK_PROD = NEW.PROD_ID;
   WK_QTY = NEW.CURRENT_QTY;
   WK_OLD_QTY = OLD.CURRENT_QTY;
   WK_DATE = 'NOW';
   IF (WK_PROD IS NULL) THEN
   BEGIN
      WK_PROD = '';
   END
   IF (WK_QTY IS NULL) THEN
   BEGIN
      WK_QTY = 0;
   END
   IF (WK_OLD_QTY IS NULL) THEN
   BEGIN
      WK_OLD_QTY = 0;
   END
   
   WK_DUMMY = 0;
   IF ((WK_WH_ID = WK_TO_WH_ID) AND (WK_LOCN = WK_TO_LOCN)) THEN
   BEGIN
      /* if was already in this location */
      WK_DUMMY = 1;
      /* replenish done by the into location proc */
   END
   IF ((WK_PROD <> '') AND (WK_DUMMY = 0)) THEN
   BEGIN
      SELECT CONTROL.PICK_IMPORT_SSN_STATUS
      FROM CONTROL
      INTO :IMPORTSTATUS; 
      SELECT PROD_ID, MIN_QTY, MAX_QTY, REORDER_QTY
      FROM LOCATION
      WHERE WH_ID = :WK_WH_ID
      AND LOCN_ID = :WK_LOCN
      AND REPLENISH = 'T'
      AND (PROD_ID IS NOT NULL)
      AND (REORDER_QTY IS NOT NULL)
      AND (MAX_QTY IS NOT NULL)
      INTO :WK_PROD_ID2, 
           :WK_MIN_QTY,
           :WK_MAX_QTY,
           :WK_REORDER_QTY;
      IF (WK_PROD_ID2 IS NULL) THEN
      BEGIN
         WK_PROD_ID2 = '';
      END
      IF (WK_PROD = WK_PROD_ID2) THEN
      BEGIN
         /* ok have a match - iand qts not null */
         /*
         SELECT AVAILABLE_QTY 
         FROM PRODUCT_STOCK_STATUS(:WK_PROD) 
         INTO :WK_WH_QTY;
         */
         /*
         SELECT FIRST 1 CURRENT_QTY
         FROM ISSN
         WHERE ISSN.PROD_ID = :WK_PROD
         AND CURRENT_QTY > 0
         AND (POS(:IMPORTSTATUS,ISSN.ISSN_STATUS,0,1) > -1)
         */
         WK_WH_QTY = 0;
         SELECT FIRST 1 CURRENT_QTY
         FROM ISSN
         JOIN LOCATION L1 ON L1.WH_ID = ISSN.WH_ID AND L1.LOCN_ID = ISSN.LOCN_ID
         WHERE ISSN.PROD_ID = :WK_PROD
         AND CURRENT_QTY > 0
         AND (POS(:IMPORTSTATUS,ISSN.ISSN_STATUS,0,1) > -1)
         AND L1.STORE_AREA <> 'PS'
         INTO :WK_WH_QTY;
         IF (WK_WH_QTY IS NULL) THEN
         BEGIN
            WK_WH_QTY = 0;
         END
         IF (WK_WH_QTY > 0) THEN
         BEGIN
            WK_CURRENT_QTY = 0;
            SELECT SUM( ISSN.CURRENT_QTY ) 
               FROM ISSN
               WHERE ISSN.PROD_ID = :WK_PROD
               AND WH_ID = :WK_WH_ID
               AND LOCN_ID = :WK_LOCN
               /* AND (POS(:IMPORTSTATUS,ISSN.ISSN_STATUS,0,1) > -1) */
               INTO :WK_CURRENT_QTY;
            IF (WK_CURRENT_QTY IS NULL) THEN
            BEGIN
               WK_CURRENT_QTY = 0;
            END
            BEGIN
               /* if was in a different location or warehouse */
               WK_QTY = 0;
            END
            WK_CURRENT_QTY = WK_CURRENT_QTY + WK_QTY - WK_OLD_QTY;
            IF (WK_CURRENT_QTY < WK_REORDER_QTY) THEN
            BEGIN
               IF (WK_CURRENT_QTY < WK_MIN_QTY) THEN
               BEGIN
                  WK_TRANSFER_PRIORITY = 5;
               END
               ELSE
               BEGIN
                  WK_TRANSFER_PRIORITY = 10;
               END
               /* now get the transfer request to update */
               WK_FOUND = 0;
               /* include the part replenished records */
               SELECT FIRST 1 1, TRN_LINE_NO, TRN_STATUS
               FROM TRANSFER_REQUEST
               WHERE TO_WH_ID = :WK_WH_ID
               AND TO_LOCN_ID = :WK_LOCN
               AND PROD_ID = :WK_PROD
               AND TRN_STATUS IN ( 'OP', 'CN','AL','PG','PL')
               AND QTY IS NULL
               INTO :WK_FOUND, :WK_TRANSFER_LINE, :WK_TRANSFER_STATUS;
               IF (WK_FOUND = 0) THEN
               BEGIN
                  /* insert it */
                  /* only nominate the wh,locn ,product and priority */
                  INSERT INTO TRANSFER_REQUEST (TO_WH_ID, TO_LOCN_ID, PROD_ID, TRN_PRIORITY, TRN_STATUS) VALUES (:WK_WH_ID, :WK_LOCN, :WK_PROD, :WK_TRANSFER_PRIORITY, 'OP'); 
               END
               ELSE
               BEGIN
                  /* update it */
                  IF (WK_TRANSFER_STATUS = 'CN') THEN
                  BEGIN
                     UPDATE TRANSFER_REQUEST
                     SET TRN_STATUS = 'OP',
                     TRN_PRIORITY = :WK_TRANSFER_PRIORITY
                     WHERE TRN_LINE_NO = :WK_TRANSFER_LINE;
                  END
                  ELSE
                  BEGIN
                     IF (WK_TRANSFER_STATUS = 'OP') THEN
                     BEGIN
                        UPDATE TRANSFER_REQUEST
                        SET TRN_PRIORITY = :WK_TRANSFER_PRIORITY
                        WHERE TRN_LINE_NO = :WK_TRANSFER_LINE;
                     END
                     ELSE
                     BEGIN
                        IF (WK_TRANSFER_STATUS = 'AL') THEN
                        BEGIN
                           UPDATE TRANSFER_REQUEST
                           SET TRN_PRIORITY = :WK_TRANSFER_PRIORITY
                           WHERE TRN_LINE_NO = :WK_TRANSFER_LINE;
                        END
                     END
                  END
               END
            END            
            ELSE
            BEGIN
               /*
               greater than or equal to reorder qty
               need to remove / change status for 
               records with no qty that 
               were in the transfer request
               but now the qty is OK
               */
               UPDATE TRANSFER_REQUEST
               SET TRN_STATUS = 'CN'
               WHERE TO_WH_ID = :WK_WH_ID
               AND TO_LOCN_ID = :WK_LOCN
               AND PROD_ID = :WK_PROD
               AND TRN_STATUS = 'OP'
               AND QTY IS NULL;
            END
         END            
         ELSE
         BEGIN
            /*
            no qty in warehouse available 
            so  cancel request
            */
            UPDATE TRANSFER_REQUEST
            SET TRN_STATUS = 'CN',
            DEVICE_ID = NULL
            WHERE TO_WH_ID = :WK_WH_ID
            AND TO_LOCN_ID = :WK_LOCN
            AND PROD_ID = :WK_PROD
            AND TRN_STATUS IN ('OP','AL')
            AND QTY IS NULL;
         END
      END
      ELSE
      BEGIN
         /* replenish off for prod in location */
         UPDATE TRANSFER_REQUEST
         SET TRN_STATUS = 'CN',
         DEVICE_ID = NULL
         WHERE TO_WH_ID = :WK_WH_ID
         AND TO_LOCN_ID = :WK_LOCN
         AND PROD_ID = :WK_PROD
         AND TRN_STATUS IN ('OP','AL')
         AND QTY IS NULL;
      END
   END
END ^

CREATE TRIGGER UPDATE_ISSN_TIME FOR ISSN 
ACTIVE BEFORE UPDATE POSITION 20 
AS
BEGIN
   NEW.LAST_UPDATE_DATE = 'NOW';
END ^

CREATE TRIGGER UPDATE_ISSN_SSNSTATUS FOR ISSN 
ACTIVE AFTER UPDATE POSITION 10 
AS                       

DECLARE VARIABLE WK_FOUND INTEGER;
DECLARE VARIABLE WK_SSN VARCHAR(20);
DECLARE VARIABLE WK_ORIG_SSN VARCHAR(20);
DECLARE VARIABLE WK_STATUS CHAR(2);
DECLARE VARIABLE WK_OLD_STATUS CHAR(2);
DECLARE VARIABLE WK_SSN_STATUS CHAR(2);
DECLARE VARIABLE WK_WH CHAR(2);
DECLARE VARIABLE WK_LOCN VARCHAR(10);
DECLARE VARIABLE WK_OLD_WH CHAR(2);
DECLARE VARIABLE WK_OLD_LOCN VARCHAR(10);
DECLARE VARIABLE WK_SSN_WH CHAR(2);
DECLARE VARIABLE WK_SSN_LOCN VARCHAR(10);

BEGIN    
    
    /* Get SSN to update */
   WK_SSN = NEW.SSN_ID;
   WK_ORIG_SSN = NEW.ORIGINAL_SSN;
   IF (WK_ORIG_SSN = WK_SSN) THEN
   BEGIN
      WK_STATUS = NEW.ISSN_STATUS;
      WK_OLD_STATUS = OLD.ISSN_STATUS;
      WK_LOCN = NEW.LOCN_ID;
      WK_OLD_LOCN = OLD.LOCN_ID;
      WK_WH = NEW.WH_ID;
      WK_OLD_WH = OLD.WH_ID;
      IF (WK_STATUS <> WK_OLD_STATUS) THEN
      BEGIN
         WK_FOUND = 0;
         SELECT 1, STATUS_SSN
            FROM SSN
            WHERE SSN_ID = :WK_SSN
            INTO :WK_FOUND, :WK_SSN_STATUS;
         IF (WK_FOUND = 1) THEN
         BEGIN
            IF (WK_SSN_STATUS <> WK_STATUS) THEN
            BEGIN
               UPDATE SSN 
                  SET STATUS_SSN = :WK_STATUS
                  WHERE SSN_ID = :WK_SSN;
            END
         END
      END
      IF ((WK_LOCN <> WK_OLD_LOCN) OR
          (WK_WH <> WK_OLD_WH)) THEN
      BEGIN
         WK_FOUND = 0;
         SELECT 1, WH_ID, LOCN_ID
            FROM SSN
            WHERE SSN_ID = :WK_SSN
            INTO :WK_FOUND, :WK_SSN_WH, :WK_SSN_LOCN;
         IF (WK_FOUND = 1) THEN
         BEGIN
            IF ((WK_SSN_LOCN <> WK_LOCN) OR
                (WK_SSN_WH <> WK_WH)) THEN
            BEGIN
               UPDATE SSN 
                  SET WH_ID = :WK_WH,
                  LOCN_ID = :WK_LOCN
                  WHERE SSN_ID = :WK_SSN;
            END
         END
      END
   END
END ^

CREATE TRIGGER ADD_SSN_FROM_LEGACY FOR LEGACY 
ACTIVE BEFORE INSERT POSITION 0 
AS
DECLARE VARIABLE WK_FOUND INTEGER;
DECLARE VARIABLE WK_LEGACY_ID VARCHAR(20); 
DECLARE VARIABLE WK_NEW_LEGACY VARCHAR(20); 
DECLARE VARIABLE WK_LEGACY_DESC VARCHAR(202);
DECLARE VARIABLE WK_TYPE VARCHAR(40); 
DECLARE VARIABLE WK_GENERIC VARCHAR(40); 
DECLARE VARIABLE WK_BRAND VARCHAR(40); 
DECLARE VARIABLE WK_MODEL VARCHAR(40); 
DECLARE VARIABLE WK_SERIAL VARCHAR(30); 
DECLARE VARIABLE WK_OTHER1 VARCHAR(50); 
DECLARE VARIABLE WK_OTHER2 VARCHAR(50); 
DECLARE VARIABLE WK_OTHER3 VARCHAR(40); 
DECLARE VARIABLE WK_OTHER4 VARCHAR(40); 
DECLARE VARIABLE WK_OTHER5 VARCHAR(40); 
DECLARE VARIABLE WK_OTHER6 VARCHAR(50); 
DECLARE VARIABLE WK_OTHER7 VARCHAR(50); 
DECLARE VARIABLE WK_OTHER8 VARCHAR(50); 
DECLARE VARIABLE WK_OTHER9 VARCHAR(50); 
DECLARE VARIABLE WK_OTHER10 VARCHAR(50); 
DECLARE VARIABLE WK_STATUS CHAR(2); 
DECLARE VARIABLE WK_NEWSSN_STATUS CHAR(2); 
DECLARE VARIABLE WK_P_DATE TIMESTAMP; 
DECLARE VARIABLE WK_P_PRICE FLOAT; 
DECLARE VARIABLE WK_C_DATE TIMESTAMP;
DECLARE VARIABLE WK_A_COST  FLOAT;
DECLARE VARIABLE WK_CC  VARCHAR(40);
DECLARE VARIABLE WK_WH_ID  CHAR(2);
DECLARE VARIABLE WK_LOCN_ID  VARCHAR(10);
DECLARE VARIABLE WK_GRN  INTEGER;
DECLARE VARIABLE WK_LOAD  VARCHAR(10);
DECLARE VARIABLE WK_IDX  INTEGER;
DECLARE VARIABLE WK_COND_DONE  INTEGER;
DECLARE VARIABLE WK_COND_RESULT  CHAR(1);
DECLARE VARIABLE WK_COND  VARCHAR(200);
DECLARE VARIABLE WK_1PASS_DESC VARCHAR(30);
DECLARE VARIABLE WK_1FAIL_DESC VARCHAR(30);
DECLARE VARIABLE WK_2PASS_DESC VARCHAR(30);
DECLARE VARIABLE WK_2FAIL_DESC VARCHAR(30);
DECLARE VARIABLE WK_3PASS_DESC VARCHAR(30);
DECLARE VARIABLE WK_3FAIL_DESC VARCHAR(30);
DECLARE VARIABLE WK_4PASS_DESC VARCHAR(30);
DECLARE VARIABLE WK_4FAIL_DESC VARCHAR(30);
DECLARE VARIABLE WK_TEST_DESC VARCHAR(32);
DECLARE VARIABLE WK_TEST_LEN INTEGER;
DECLARE VARIABLE WK_OPERATOR VARCHAR(5);
DECLARE VARIABLE WK_CLASS CHAR(1);
DECLARE VARIABLE WK_CLASS_NO INTEGER;
DECLARE VARIABLE WK_DO_IMPORT INTEGER;
DECLARE VARIABLE WK_SSN_DATA_TYPE CHAR(1);
DECLARE VARIABLE WK_LOCN_LENGTH INTEGER;
DECLARE VARIABLE WK_COMPANY VARCHAR(20);
DECLARE VARIABLE WK_DEP_METHOD VARCHAR(10); 

BEGIN
   /* 150605 if new status is TS then dont populate other 1-5 */
   WK_LEGACY_ID  = NEW.LEGACY_ID;
   WK_LEGACY_DESC = ',' || ALLTRIM(NEW.LEGACY_DESCRIPTION) || ',';
   WK_TYPE = UPPER(NEW.SSN_TYPE);
   WK_GENERIC = UPPER(NEW.GENERIC);
   /* WK_BRAND = UPPER(NEW.BRAND); */
   IF ((NEW.BRAND) IS NULL) THEN
   BEGIN
      WK_BRAND = 'NO VALUES';
   END
   ELSE
   BEGIN
      WK_BRAND = UPPER(NEW.BRAND);
      IF (WK_BRAND = '') THEN
      BEGIN
         WK_BRAND = 'NO VALUES';
      END
   END
   /* WK_MODEL = UPPER(NEW.MODEL); */
   IF ((NEW.MODEL) IS NULL) THEN
   BEGIN
      WK_MODEL = 'NO VALUES';
   END
   ELSE
   BEGIN
      WK_MODEL = UPPER(NEW.MODEL);
      IF (WK_MODEL = '') THEN
      BEGIN
         WK_MODEL = 'NO VALUES';
      END
   END
   /* must ensure that no values exists in the brand and model tables */
   WK_FOUND = 0;
   SELECT 1 FROM BRAND WHERE CODE = :WK_BRAND INTO :WK_FOUND;
   IF (WK_FOUND = 0) THEN
   BEGIN
      INSERT INTO BRAND(CODE, DESCRIPTION) VALUES (:WK_BRAND, :WK_BRAND);
   END
   WK_FOUND = 0;
   SELECT 1 FROM MODEL WHERE CODE = :WK_MODEL INTO :WK_FOUND;
   IF (WK_FOUND = 0) THEN
   BEGIN
      INSERT INTO MODEL(CODE, DESCRIPTION) VALUES (:WK_BRAND, :WK_BRAND);
   END
   WK_SERIAL = NEW.SERIAL_NUMBER;
   WK_OTHER1 = UPPER(NEW.OTHER1);
   WK_OTHER2 = UPPER(NEW.OTHER2);
   WK_OTHER3 = UPPER(NEW.OTHER3);
   WK_OTHER4 = UPPER(NEW.OTHER4);
   WK_OTHER5 = '';
   WK_OTHER6 = UPPER(NEW.OTHER6);
   WK_OTHER7 = UPPER(NEW.OTHER7);
   WK_OTHER8 = UPPER(NEW.OTHER8);
   WK_OTHER9 = UPPER(NEW.OTHER9);
   WK_OTHER10 = UPPER(NEW.OTHER10);
   WK_STATUS = NEW.STATUS;
   WK_P_DATE = NEW.PURCHASE_DATE;
   WK_P_PRICE = NEW.PURCHASE_PRICE;
   WK_C_DATE = NEW.COMMISSIONED_DATE;
   WK_A_COST = NEW.ACQUISITION_COST;
   WK_CC = NEW.COST_CENTER;
   WK_WH_ID = NEW.WH_ID;
   WK_LOCN_ID = NEW.LOCN_ID;
   IF (WK_LOCN_ID IS NULL) THEN
   BEGIN
      WK_LOCN_ID = 'INTRANST';
   END
   SELECT MAX_LENGTH 
   FROM PARAM 
   WHERE DATA_ID = 'LOCATION'
   INTO :WK_LOCN_LENGTH;
   WK_LOCN_LENGTH = WK_LOCN_LENGTH - 2; /* remove wh */
   IF (LEN(WK_LOCN_ID) < WK_LOCN_LENGTH) THEN
   BEGIN
      WK_LOCN_ID = WK_LOCN_ID || SUBSTR('          ',1,WK_LOCN_LENGTH - LEN(WK_LOCN_ID));
   END
   WK_GRN = NEW.GRN;
   WK_LOAD = NEW.LOAD_NO;

   WK_DO_IMPORT = GEN_ID(IMPORT_SSN_FROM_LEGACY,0);
   SELECT NEW_SSN_STATUS, COMPANY_ID 
   FROM CONTROL
   INTO :WK_NEWSSN_STATUS, :WK_COMPANY ;

   /* Check SSN */
   WK_SSN_DATA_TYPE = '0';
   SELECT DATA_TYPE
   FROM PARAM 
   WHERE DATA_ID = 'BARCODE'
   INTO :WK_SSN_DATA_TYPE;
   IF (WK_SSN_DATA_TYPE = '1') THEN
   BEGIN
      SELECT WK_NEW_CODE
      FROM GET_NUMERIC(:WK_LEGACY_ID)
      INTO :WK_NEW_LEGACY;
      WK_LEGACY_ID = WK_NEW_LEGACY;
   END
   ELSE
   IF (WK_SSN_DATA_TYPE = '2') THEN
   BEGIN
      SELECT WK_NEW_CODE
      FROM GET_ALPHA(:WK_LEGACY_ID)
      INTO :WK_NEW_LEGACY;
      WK_LEGACY_ID = WK_NEW_LEGACY;
   END
   ELSE
   IF (WK_SSN_DATA_TYPE = '3') THEN
   BEGIN
      SELECT WK_NEW_CODE
      FROM GET_ALPHA_NUMERIC(:WK_LEGACY_ID)
      INTO :WK_NEW_LEGACY;
      WK_LEGACY_ID = WK_NEW_LEGACY;
   END


   WK_FOUND = 0;
   SELECT 1 FROM SSN 
      WHERE SSN_ID = :WK_LEGACY_ID
      INTO :WK_FOUND;
   IF (WK_DO_IMPORT = 0) THEN
   BEGIN
      WK_FOUND = 1;
   END
   IF (WK_FOUND = 0) THEN
   BEGIN
      /* no ssn so insert it */

      IF (WK_NEWSSN_STATUS = 'TS') THEN
      BEGIN
         WK_FOUND = 0;
      END
      ELSE
      BEGIN
         /* calculate other 1 to 4 */
       
         EXECUTE PROCEDURE GET_GLOBAL_CONDITION 1, 'P' RETURNING_VALUES :WK_1PASS_DESC;
         EXECUTE PROCEDURE GET_GLOBAL_CONDITION 1, 'F' RETURNING_VALUES :WK_1FAIL_DESC;
         WK_TEST_DESC = ',' || WK_1PASS_DESC || ',';
         /*IF (POS(WK_LEGACY_DESC,',AS NEW CONDITION,',0,1) = -1) THEN*/
         IF (POS(WK_LEGACY_DESC,WK_TEST_DESC,0,1) = -1) THEN
         BEGIN
            /*WK_OTHER1 = 'NOT NEW CONDITION';*/
            WK_OTHER1 = WK_1FAIL_DESC;
         END
         ELSE
         BEGIN
            /*WK_OTHER1 = 'AS NEW CONDITION';*/
            WK_OTHER1 = WK_1PASS_DESC;
         END
         EXECUTE PROCEDURE GET_GLOBAL_CONDITION 2, 'P' RETURNING_VALUES :WK_2PASS_DESC;
         EXECUTE PROCEDURE GET_GLOBAL_CONDITION 2, 'F' RETURNING_VALUES :WK_2FAIL_DESC;
         WK_TEST_DESC = ',' || WK_2PASS_DESC || ',';
         /*IF (POS(WK_LEGACY_DESC,',TESTED - OK,',0,1) = -1) THEN*/
         IF (POS(WK_LEGACY_DESC,WK_TEST_DESC,0,1) = -1) THEN
         BEGIN
            /*WK_OTHER2 = 'TESTED - FAULTY';*/
            WK_OTHER2 = WK_2FAIL_DESC;
         END
         ELSE
         BEGIN
            /*WK_OTHER2 = 'TESTED - OK';*/
            WK_OTHER2 = WK_2PASS_DESC;
         END
         EXECUTE PROCEDURE GET_GLOBAL_CONDITION 3, 'P' RETURNING_VALUES :WK_3PASS_DESC;
         EXECUTE PROCEDURE GET_GLOBAL_CONDITION 3, 'F' RETURNING_VALUES :WK_3FAIL_DESC;
         WK_TEST_DESC = ',' || WK_3PASS_DESC || ',';
         /*IF (POS(WK_LEGACY_DESC,',COMPLETE,',0,1) = -1) THEN*/
         IF (POS(WK_LEGACY_DESC,WK_TEST_DESC,0,1) = -1) THEN
         BEGIN
            /*WK_OTHER3 = 'INCOMPLETE';*/
            WK_OTHER3 = WK_3FAIL_DESC;
         END
         ELSE
         BEGIN
            /*WK_OTHER3 = 'COMPLETE';*/
            WK_OTHER3 = WK_3PASS_DESC;
         END
         EXECUTE PROCEDURE GET_GLOBAL_CONDITION 4, 'P' RETURNING_VALUES :WK_4PASS_DESC;
         EXECUTE PROCEDURE GET_GLOBAL_CONDITION 4, 'F' RETURNING_VALUES :WK_4FAIL_DESC;
         WK_TEST_DESC = ',' || WK_4PASS_DESC || ',';
         /*IF (POS(WK_LEGACY_DESC,',NO SERVICE,',0,1) = -1) THEN*/
         IF (POS(WK_LEGACY_DESC,WK_TEST_DESC,0,1) = -1) THEN
         BEGIN
            /*WK_OTHER4 = 'SERVICE PROVIDED';*/
            WK_OTHER4 = WK_4FAIL_DESC;
         END
         ELSE
         BEGIN
            /*WK_OTHER4 = 'NO SERVICE';*/
            WK_OTHER4 = WK_4PASS_DESC;
         END
         /* now must get the list of conditions - to find other 5 */
         WK_IDX = 1;
         WK_COND = ALLTRIM(PARSE(WK_LEGACY_DESC,',',:WK_IDX));
         WHILE (WK_COND <> 'Token to long in parse') DO 
         BEGIN
            WK_COND_DONE = 0;
            IF (LEN(WK_COND) = 0) THEN
            BEGIN
               WK_COND_DONE = 1;
            END
            /*IF (WK_COND = 'AS NEW CONDITION') THEN*/
            IF (WK_COND = WK_1PASS_DESC) THEN
            BEGIN
               WK_COND_DONE = 1;
            END
            IF (WK_COND_DONE = 0) THEN
            BEGIN
               /*IF (WK_COND = 'TESTED - OK') THEN*/
               IF (WK_COND = WK_2PASS_DESC) THEN
               BEGIN
                  WK_COND_DONE = 1;
               END
            END
            IF (WK_COND_DONE = 0) THEN
            BEGIN
               /*IF (WK_COND = 'COMPLETE') THEN*/
               IF (WK_COND = WK_3PASS_DESC) THEN
               BEGIN
                  WK_COND_DONE = 1;
               END
            END
            IF (WK_COND_DONE = 0) THEN
            BEGIN
               /*IF (WK_COND = 'NO SERVICE') THEN*/
               IF (WK_COND = WK_4PASS_DESC) THEN
               BEGIN
                  WK_COND_DONE = 1;
               END
            END
            FOR SELECT DESCRIPTION, MATCH_OPERATOR, OTHER_NO 
            FROM GLOBAL_CONDITIONS 
            WHERE OTHER_NO IN (4,3,2,1)
              AND RESULT = 'C'
            ORDER BY OTHER_NO DESC
             INTO :WK_TEST_DESC, :WK_OPERATOR, :WK_CLASS_NO
            DO
            BEGIN
               IF (WK_CLASS_NO = 1) THEN
                  WK_CLASS = 'A';
               IF (WK_CLASS_NO = 2) THEN
                  WK_CLASS = 'B';
               IF (WK_CLASS_NO = 3) THEN
                  WK_CLASS = 'C';
               IF (WK_CLASS_NO = 4) THEN
                  WK_CLASS = 'D';
               IF (WK_COND_DONE = 0) THEN
               BEGIN
                  IF (WK_OPERATOR = 'START') THEN
                  BEGIN
                     WK_TEST_LEN = STRLEN(WK_TEST_DESC);
                     IF (SUBSTR(WK_COND,1,WK_TEST_LEN) = WK_TEST_DESC) THEN
                     BEGIN
                        /* add to prod cond */
                        EXECUTE PROCEDURE ADD_PROD_COND_STATUS_TEST :WK_LEGACY_ID, :WK_CLASS, :WK_COND , 'O'
                           RETURNING_VALUES :WK_COND_RESULT;
                        EXECUTE PROCEDURE ADD_PROD_COND_STATUS_TEST :WK_LEGACY_ID, :WK_CLASS, :WK_COND , 'S'
                           RETURNING_VALUES :WK_COND_RESULT;
                        WK_COND_DONE = 1;
                     END
                  END
                  IF (WK_OPERATOR = 'EQUAL') THEN
                  BEGIN
                     IF (WK_COND = WK_TEST_DESC) THEN
                     BEGIN
                        /* add to prod cond */
                        EXECUTE PROCEDURE ADD_PROD_COND_STATUS_TEST :WK_LEGACY_ID, :WK_CLASS, :WK_COND , 'O'
                           RETURNING_VALUES :WK_COND_RESULT;
                        EXECUTE PROCEDURE ADD_PROD_COND_STATUS_TEST :WK_LEGACY_ID, :WK_CLASS, :WK_COND , 'S'
                           RETURNING_VALUES :WK_COND_RESULT;
                        WK_COND_DONE = 1;
                     END
                  END
                  IF (WK_OPERATOR = 'ANY') THEN
                  BEGIN
                     IF (POS(WK_COND,WK_TEST_DESC,0,1) > -1) THEN
                     BEGIN
                        /* add to prod cond */
                        EXECUTE PROCEDURE ADD_PROD_COND_STATUS_TEST :WK_LEGACY_ID, :WK_CLASS, :WK_COND , 'O'
                           RETURNING_VALUES :WK_COND_RESULT;
                        EXECUTE PROCEDURE ADD_PROD_COND_STATUS_TEST :WK_LEGACY_ID, :WK_CLASS, :WK_COND , 'S'
                           RETURNING_VALUES :WK_COND_RESULT;
                        WK_COND_DONE = 1;
                     END
                  END
                  IF (WK_OPERATOR = 'END') THEN
                  BEGIN
                     WK_TEST_LEN = STRLEN(WK_TEST_DESC);
                     IF (RIGHTS(WK_COND,WK_TEST_LEN) = WK_TEST_DESC) THEN
                     BEGIN
                        /* add to prod cond */
                        EXECUTE PROCEDURE ADD_PROD_COND_STATUS_TEST :WK_LEGACY_ID, :WK_CLASS, :WK_COND , 'O'
                           RETURNING_VALUES :WK_COND_RESULT;
                        EXECUTE PROCEDURE ADD_PROD_COND_STATUS_TEST :WK_LEGACY_ID, :WK_CLASS, :WK_COND , 'S'
                           RETURNING_VALUES :WK_COND_RESULT;
                        WK_COND_DONE = 1;
                     END
                  END
               END
            END
            FOR SELECT DESCRIPTION, MATCH_OPERATOR, OTHER_NO 
            FROM GLOBAL_CONDITIONS 
            WHERE OTHER_NO = 5
              AND RESULT = 'C'
             INTO :WK_TEST_DESC, :WK_OPERATOR, :WK_CLASS_NO
            DO
            BEGIN
               WK_CLASS = 'E';
               IF (WK_COND_DONE = 0) THEN
               BEGIN
                  IF (WK_OPERATOR = 'START') THEN
                  BEGIN
                     WK_TEST_LEN = STRLEN(WK_TEST_DESC);
                     IF (SUBSTR(WK_COND,1,WK_TEST_LEN) = WK_TEST_DESC) THEN
                     BEGIN
                        /* other 5 */
                        WK_OTHER5 = WK_COND;
                        WK_COND_DONE = 1;
                     END
                  END
                  IF (WK_OPERATOR = 'EQUAL') THEN
                  BEGIN
                     IF (WK_COND = WK_TEST_DESC) THEN
                     BEGIN
                        /* other 5 */
                        WK_OTHER5 = WK_COND;
                        WK_COND_DONE = 1;
                     END
                  END
                  IF (WK_OPERATOR = 'ANY') THEN
                  BEGIN
                     IF (POS(WK_COND,WK_TEST_DESC,0,1) > -1) THEN
                     BEGIN
                        /* other 5 */
                        WK_OTHER5 = WK_COND;
                        WK_COND_DONE = 1;
                     END
                  END
                  IF (WK_OPERATOR = 'END') THEN
                  BEGIN
                     WK_TEST_LEN = STRLEN(WK_TEST_DESC);
                     IF (RIGHTS(WK_COND,WK_TEST_LEN) = WK_TEST_DESC) THEN
                     BEGIN
                        /* other 5 */
                        WK_OTHER5 = WK_COND;
                        WK_COND_DONE = 1;
                     END
                  END
               END
            END
   
            IF (WK_COND_DONE = 0) THEN
            BEGIN
               BEGIN
                  /* no matches so add to prod cond class A */
                  EXECUTE PROCEDURE ADD_PROD_COND_STATUS_TEST :WK_LEGACY_ID, 'A', :WK_COND , 'O'
                     RETURNING_VALUES :WK_COND_RESULT;
                  EXECUTE PROCEDURE ADD_PROD_COND_STATUS_TEST :WK_LEGACY_ID, 'A', :WK_COND , 'S'
                     RETURNING_VALUES :WK_COND_RESULT;
                  WK_COND_DONE = 1;
               END
            END
            WK_IDX = WK_IDX + 1;
            WK_COND = ALLTRIM(PARSE(WK_LEGACY_DESC,',',:WK_IDX));
         END /* while */
      END /* status not test */

/*
      VALUES (:WK_LEGACY_ID, :WK_WH_ID, 'INTRANST', :WK_GRN, 'TS', 1, 1,
*/
      INSERT INTO SSN (SSN_ID, WH_ID, LOCN_ID, GRN, STATUS_SSN, 
             ORIGINAL_QTY, CURRENT_QTY, PO_ORDER, 
             PO_RECEIVE_DATE, SSN_TYPE, GENERIC, BRAND, MODEL, 
             SERIAL_NUMBER, OTHER6, OTHER7, OTHER8, OTHER9, OTHER10,
             STORAGE_UOM, OTHER1, OTHER2, OTHER3, OTHER4, OTHER5, LEGACY_ID,
             PURCHASE_DATE, PURCHASE_PRICE, COMMISSIONED_DATE,
             ACQUISITION_COST, COST_CENTER ,
             OTHER11, OTHER12, OTHER13, OTHER14, OTHER15_DATE, OTHER16_DATE,
             OTHER17_QTY, OTHER18_QTY, OTHER19, OTHER20,
             STATUS_CODE, DEPRECIATE_METHOD1, DEPRECIATE_METHOD2, DEPRECIATE_METHOD3,
             DEPRECIATED_VALUE1, DEPRECIATED_VALUE2, DEPRECIATED_VALUE3,
             BOOK_VALUE1, BOOK_VALUE2, BOOK_VALUE3, COMPANY_ID )
      VALUES (:WK_LEGACY_ID, :WK_WH_ID, :WK_LOCN_ID, :WK_GRN, :WK_NEWSSN_STATUS, 1, 1,
              :WK_LOAD, 'NOW', :WK_TYPE, :WK_GENERIC, :WK_BRAND, 
              :WK_MODEL, :WK_SERIAL, :WK_OTHER6, :WK_OTHER7, :WK_OTHER8,
              :WK_OTHER9, :WK_OTHER10, 'EA' , :WK_OTHER1, :WK_OTHER2, :WK_OTHER3, :WK_OTHER4, :WK_OTHER5, NEW.LEGACY_ID,
              :WK_P_DATE, :WK_P_PRICE, :WK_C_DATE,
              :WK_A_COST, :WK_CC,
              NEW.OTHER11, NEW.OTHER12, NEW.OTHER13, NEW.OTHER14, NEW.OTHER15_DATE, NEW.OTHER16_DATE,
              NEW.OTHER17_QTY, NEW.OTHER18_QTY, NEW.OTHER19, NEW.OTHER20, 
              NEW.STATUS_CODE, NEW.DEPRECIATE_METHOD1, NEW.DEPRECIATE_METHOD2, NEW.DEPRECIATE_METHOD3,
              NEW.DEPRECIATED_VALUE1, NEW.DEPRECIATED_VALUE2, NEW.DEPRECIATED_VALUE3,
              NEW.ACCUM_DEPREC_VALUE1, NEW.ACCUM_DEPREC_VALUE2, NEW.ACCUM_DEPREC_VALUE3, :WK_COMPANY );
      NEW.STATUS = 'T'; 
      /* does dep_methods exist */
      IF (NEW.DEPRECIATE_METHOD1 IS NOT NULL) THEN
      BEGIN
         WK_FOUND = 0;
         SELECT 1 
         FROM DEP_METHODS 
         WHERE METHOD_CODE = NEW.DEPRECIATE_METHOD1 
         INTO :WK_FOUND;
         IF (WK_FOUND = 0) THEN
         BEGIN
            IF (NEW.DEP_METHODS_METHOD1 IS NULL) THEN
            BEGIN
               WK_DEP_METHOD = 'STR';
            END
            ELSE
            BEGIN
               WK_DEP_METHOD = NEW.DEP_METHODS_METHOD1;
            END
            INSERT INTO DEP_METHODS(METHOD_CODE,
                                    METHOD,
                                    USE_RATE,
                                    LOWEST_LIMIT,
                                    DEPRECIATION_RATE,
                                    NAME,
                                    DEPRECIATION_YEAR)
            VALUES( NEW.DEPRECIATE_METHOD1,
                    :WK_DEP_METHOD,
                    'T',
                    0,
                    NEW.DEPRECIATED_RATE1,
                    NEW.DEPRECIATE_METHOD1,
                    0);
         END
         ELSE
         BEGIN
            UPDATE DEP_METHODS 
            SET DEPRECIATION_RATE = NEW.DEPRECIATED_RATE1 
            WHERE METHOD_CODE = NEW.DEPRECIATE_METHOD1;
         END
      END
      IF (NEW.DEPRECIATE_METHOD2 IS NOT NULL) THEN
      BEGIN
         WK_FOUND = 0;
         SELECT 1 
         FROM DEP_METHODS 
         WHERE METHOD_CODE = NEW.DEPRECIATE_METHOD2 
         INTO :WK_FOUND;
         IF (WK_FOUND = 0) THEN
         BEGIN
            IF (NEW.DEP_METHODS_METHOD2 IS NULL) THEN
            BEGIN
               WK_DEP_METHOD = 'STR';
            END
            ELSE
            BEGIN
               WK_DEP_METHOD = NEW.DEP_METHODS_METHOD2;
            END
            INSERT INTO DEP_METHODS(METHOD_CODE,
                                    METHOD,
                                    USE_RATE,
                                    LOWEST_LIMIT,
                                    DEPRECIATION_RATE,
                                    NAME,
                                    DEPRECIATION_YEAR)
            VALUES( NEW.DEPRECIATE_METHOD2,
                    :WK_DEP_METHOD,
                    'T',
                    0,
                    NEW.DEPRECIATED_RATE2,
                    NEW.DEPRECIATE_METHOD2,
                    0);
         END
         ELSE
         BEGIN
            UPDATE DEP_METHODS 
            SET DEPRECIATION_RATE = NEW.DEPRECIATED_RATE2 
            WHERE METHOD_CODE = NEW.DEPRECIATE_METHOD2;
         END
      END
      IF (NEW.DEPRECIATE_METHOD3 IS NOT NULL) THEN
      BEGIN
         WK_FOUND = 0;
         SELECT 1 
         FROM DEP_METHODS 
         WHERE METHOD_CODE = NEW.DEPRECIATE_METHOD3 
         INTO :WK_FOUND;
         IF (WK_FOUND = 0) THEN
         BEGIN
            IF (NEW.DEP_METHODS_METHOD3 IS NULL) THEN
            BEGIN
               WK_DEP_METHOD = 'STR';
            END
            ELSE
            BEGIN
               WK_DEP_METHOD = NEW.DEP_METHODS_METHOD3;
            END
            INSERT INTO DEP_METHODS(METHOD_CODE,
                                    METHOD,
                                    USE_RATE,
                                    LOWEST_LIMIT,
                                    DEPRECIATION_RATE,
                                    NAME,
                                    DEPRECIATION_YEAR)
            VALUES( NEW.DEPRECIATE_METHOD3,
                    :WK_DEP_METHOD,
                    'T',
                    0,
                    NEW.DEPRECIATED_RATE3,
                    NEW.DEPRECIATE_METHOD3,
                    0);
         END
         ELSE
         BEGIN
            UPDATE DEP_METHODS 
            SET DEPRECIATION_RATE = NEW.DEPRECIATED_RATE3 
            WHERE METHOD_CODE = NEW.DEPRECIATE_METHOD3;
         END
      END
   END
   IF (WK_DO_IMPORT > 0) THEN
   BEGIN
      /* Check issn */
      WK_FOUND = 0;
      SELECT 1 FROM ISSN
         WHERE SSN_ID = :WK_LEGACY_ID
         INTO :WK_FOUND;
      IF (WK_FOUND = 0) THEN
      BEGIN
         /* no issn so insert it */
/*
         VALUES (:WK_LEGACY_ID, :WK_LEGACY_ID, :WK_WH_ID, 'INTRANST', 1, 'TS'); 
*/
         INSERT INTO ISSN (SSN_ID, ORIGINAL_SSN, WH_ID, LOCN_ID, CURRENT_QTY,ISSN_STATUS, SERIAL_NUMBER, COMPANY_ID)
         VALUES (:WK_LEGACY_ID, :WK_LEGACY_ID, :WK_WH_ID, :WK_LOCN_ID, 1, :WK_NEWSSN_STATUS, :WK_SERIAL, :WK_COMPANY); 
      END
      ELSE
      BEGIN
         UPDATE ISSN SET 
           ORIGINAL_SSN = :WK_LEGACY_ID 
         WHERE SSN_ID = :WK_LEGACY_ID;
      END
      /* Check warehouse */
      WK_FOUND = 0;
      SELECT 1 FROM WAREHOUSE
         WHERE WH_ID = :WK_WH_ID
         INTO :WK_FOUND;
      IF (WK_FOUND = 0) THEN
      BEGIN
         /* no warehouse so insert it */
         INSERT INTO WAREHOUSE (WH_ID, DESCRIPTION )
         VALUES (:WK_WH_ID, :WK_WH_ID ); 
      END
      /* Check location */
      WK_FOUND = 0;
      SELECT 1 FROM LOCATION
         WHERE WH_ID = :WK_WH_ID
         AND LOCN_ID = :WK_LOCN_ID
         INTO :WK_FOUND;
      IF (WK_FOUND = 0) THEN
      BEGIN
         /* no location so insert it */
         INSERT INTO LOCATION (WH_ID, LOCN_ID, LOCN_NAME)
         VALUES (:WK_WH_ID, :WK_LOCN_ID, :WK_LOCN_ID ); 
      END
   END
END ^

CREATE TRIGGER UPD_SSN_FROM_LEGACY_ADD FOR LEGACY 
ACTIVE AFTER INSERT POSITION 10 
AS
DECLARE VARIABLE WK_FOUND INTEGER;
DECLARE VARIABLE WK_LEGACY_ID VARCHAR(20); 
DECLARE VARIABLE WK_NEW_LEGACY VARCHAR(20); 
DECLARE VARIABLE WK_SSN_UPDATE CHAR(1);
DECLARE VARIABLE WK_SSN_DATA_TYPE CHAR(1);
DECLARE VARIABLE WK_DO_IMPORT INTEGER;

BEGIN
   WK_LEGACY_ID  = NEW.LEGACY_ID;

   WK_DO_IMPORT = GEN_ID(IMPORT_SSN_FROM_LEGACY,0);
   SELECT IMPORT_SSN_AUTO_UPDATE 
   FROM CONTROL
   INTO :WK_SSN_UPDATE;
   IF (WK_SSN_UPDATE IS NULL) THEN
   BEGIN
      WK_SSN_UPDATE = 'F';
   END

   /* Check SSN */
   WK_SSN_DATA_TYPE = '0';
   SELECT DATA_TYPE
   FROM PARAM 
   WHERE DATA_ID = 'BARCODE'
   INTO :WK_SSN_DATA_TYPE;
   IF (WK_SSN_DATA_TYPE = '1') THEN
   BEGIN
      SELECT WK_NEW_CODE
      FROM GET_NUMERIC(:WK_LEGACY_ID)
      INTO :WK_NEW_LEGACY;
      WK_LEGACY_ID = WK_NEW_LEGACY;
   END
   ELSE
   IF (WK_SSN_DATA_TYPE = '2') THEN
   BEGIN
      SELECT WK_NEW_CODE
      FROM GET_ALPHA(:WK_LEGACY_ID)
      INTO :WK_NEW_LEGACY;
      WK_LEGACY_ID = WK_NEW_LEGACY;
   END
   ELSE
   IF (WK_SSN_DATA_TYPE = '3') THEN
   BEGIN
      SELECT WK_NEW_CODE
      FROM GET_ALPHA_NUMERIC(:WK_LEGACY_ID)
      INTO :WK_NEW_LEGACY;
      WK_LEGACY_ID = WK_NEW_LEGACY;
   END

   WK_FOUND = 0;
   SELECT 1 FROM SSN 
      WHERE SSN_ID = :WK_LEGACY_ID
      INTO :WK_FOUND;
   IF (WK_DO_IMPORT = 0) THEN
   BEGIN
      WK_FOUND = 2;
   END
   IF (WK_FOUND = 1) THEN
   BEGIN
      /* have ssn so update it */

      IF (WK_SSN_UPDATE = 'T') THEN
      BEGIN
         UPDATE SSN SET ANSWER_ID = 0
         WHERE SSN_ID = :WK_LEGACY_ID;
         UPDATE SSN SET ANSWER_ID = NULL
         WHERE SSN_ID = :WK_LEGACY_ID;
      END
   END
END ^

CREATE TRIGGER ADD_LEGACY_ADJUSTMENT FOR LEGACY_ADJUSTMENT 
ACTIVE BEFORE INSERT POSITION 10 
AS
BEGIN
    IF ((NEW.RECORD_ID IS NULL) OR (NEW.RECORD_ID = 0)) THEN
    BEGIN
       NEW.RECORD_ID  = GEN_ID(STOCKTAKE_ID_GEN,1);
    END
END ^

CREATE TRIGGER ADD_LOAN_RATE FOR LOAN_RATE 
ACTIVE BEFORE INSERT POSITION 10 
AS
BEGIN
    IF ((NEW.RECORD_ID IS NULL) OR (NEW.RECORD_ID = 0)) THEN
    BEGIN
       NEW.RECORD_ID  = GEN_ID(LOAN_RATE_ID_GEN,1);
    END
END ^

CREATE TRIGGER ADD_LOCATION_DEFAULT FOR LOCATION 
ACTIVE BEFORE INSERT POSITION 1 
AS
       
BEGIN
  
   IF (NEW.MOVEABLE_LOCN IS NULL) THEN
   BEGIN
      NEW.MOVEABLE_LOCN = 'F';
   END
       
END ^

CREATE TRIGGER ADD_LOCATION_TIME FOR LOCATION 
ACTIVE BEFORE INSERT POSITION 20 
AS
BEGIN
   NEW.LAST_UPDATE_DATE = 'NOW';
END ^

CREATE TRIGGER UPDATE_LOCATION_DEFAULT FOR LOCATION 
ACTIVE BEFORE UPDATE POSITION 1 
AS
       
BEGIN
  
   IF (NEW.MOVEABLE_LOCN IS NULL) THEN
   BEGIN
      NEW.MOVEABLE_LOCN = 'F';
   END
       
END ^

CREATE TRIGGER UPDATE_LOCATION_TIME FOR LOCATION 
ACTIVE BEFORE UPDATE POSITION 20 
AS
BEGIN
   NEW.LAST_UPDATE_DATE = 'NOW';
END ^

CREATE TRIGGER LOG_ID FOR LOG 
ACTIVE BEFORE INSERT POSITION 0 
AS
BEGIN
  IF (NEW.SEQ IS NULL) THEN
      NEW.SEQ = GEN_ID(LOG_GEN, 1);
  NEW.CREATE_DATE = 'NOW';
END ^

CREATE TRIGGER DEL_ORDER_GROUP FOR ORDER_GROUP 
ACTIVE BEFORE DELETE POSITION 1 
AS
DECLARE VARIABLE WK_CAMPAIGN VARCHAR(10);
DECLARE VARIABLE WK_FOUND INTEGER;
BEGIN
   WK_CAMPAIGN = OLD.ORDER_GROUP_ID;
   DELETE FROM PICK_ORDER_GROUP
   WHERE ORDER_GROUP_ID = :WK_CAMPAIGN;
END ^

CREATE TRIGGER ADD_PACK_ID_TIME FOR PACK_ID 
ACTIVE BEFORE INSERT POSITION 20 
AS
BEGIN
   NEW.LAST_UPDATE_DATE = 'NOW';
END ^

CREATE TRIGGER UPDATE_PACK_ID_TIME FOR PACK_ID 
ACTIVE BEFORE UPDATE POSITION 20 
AS
BEGIN
   NEW.LAST_UPDATE_DATE = 'NOW';
END ^

CREATE TRIGGER DELETE_PERSON FOR PERSON 
INACTIVE AFTER DELETE POSITION 0 
AS
DECLARE VARIABLE WK_CODE VARCHAR(10);
DECLARE VARIABLE WK_DIRECTORY VARCHAR(80);
DECLARE VARIABLE WK_FILENAME VARCHAR(255);
DECLARE VARIABLE WK_LABEL_LINE VARCHAR(255);
DECLARE VARIABLE WK_RESULT INTEGER;
BEGIN
   WK_CODE = OLD.PERSON_ID;
   SELECT EMPLOYEE_FTP_DIRECTORY FROM CONTROL INTO :WK_DIRECTORY;
   WK_FILENAME = WK_DIRECTORY || 'delperson.trn';
   WK_LABEL_LINE = SQUOTEDSTR(WK_CODE) ;
   WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE);
   IF (WK_RESULT <> 0) THEN
   BEGIN
      WK_FILENAME = WK_DIRECTORY || 'delperson.2rn';
      WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE);
   END

END ^

CREATE TRIGGER AI_PERSON_ADDRESS_RECORD_ID FOR PERSON_ADDRESS 
ACTIVE BEFORE INSERT POSITION 0 
AS
BEGIN
  IF (NEW.RECORD_ID IS NULL) THEN
      NEW.RECORD_ID = GEN_ID(ADDR_GEN, 1);
  IF (NEW.RECORD_ID = 0) THEN
      NEW.RECORD_ID = GEN_ID(ADDR_GEN, 1);
END ^

CREATE TRIGGER AI_PERSON_COMPANY_RECORD_ID FOR PERSON_COMPANY 
ACTIVE BEFORE INSERT POSITION 0 
AS
BEGIN
  IF (NEW.RECORD_ID IS NULL) THEN
      NEW.RECORD_ID = GEN_ID(ADDR_GEN, 1);
END ^

CREATE TRIGGER ADD_PICK_DESPATCH_TIME FOR PICK_DESPATCH 
ACTIVE BEFORE INSERT POSITION 20 
AS
BEGIN
   NEW.LAST_UPDATE_DATE = 'NOW';
END ^

CREATE TRIGGER UPD_PICK_DESPATCH_TIME FOR PICK_DESPATCH 
ACTIVE BEFORE UPDATE POSITION 20 
AS
DECLARE VARIABLE WK_FOUND INTEGER;
BEGIN
   NEW.LAST_UPDATE_DATE = 'NOW';
   IF (NEW.PICKD_MANIFEST_ID IS NOT NULL) THEN
   BEGIN
      IF (NEW.PICKD_MANIFEST_ID <> '') THEN
      BEGIN
         WK_FOUND = 0;
         SELECT 1 FROM PICK_MANIFEST
         WHERE MANIFEST_ID = NEW.PICKD_MANIFEST_ID
         INTO :WK_FOUND;
         IF (WK_FOUND IS NULL) THEN
         BEGIN
            WK_FOUND = 0;
         END
         IF (WK_FOUND = 0 ) THEN
         BEGIN
            INSERT INTO PICK_MANIFEST (MANIFEST_ID, 
                   PICKM_DATE,
                   CREATE_DATE,
                   USER_ID,
                   LAST_UPDATE_DATE,
                   DEVICE_ID,
                   PICKM_STATUS)
            VALUES (NEW.PICKD_MANIFEST_ID,
                    'NOW',
                    'NOW',
                    NEW.USER_ID,
                    'NOW',
                    NEW.DEVICE_ID,
                    NEW.DESPATCH_STATUS);
         END
         ELSE
         BEGIN
            UPDATE PICK_MANIFEST SET PICKM_STATUS = NEW.DESPATCH_STATUS,
                   LAST_UPDATE_DATE = 'NOW',
                   USER_ID = NEW.USER_ID,
                   DEVICE_ID = NEW.DEVICE_ID  
            WHERE MANIFEST_ID = NEW.PICKD_MANIFEST_ID; 
         END
      END
   END
END ^

CREATE TRIGGER ADD_PICK_INVOICE FOR PICK_INVOICE 
ACTIVE BEFORE INSERT POSITION 10 
AS
BEGIN
   IF ((NEW.INVOICE_ID IS NULL) OR (NEW.INVOICE_ID = 0)) THEN
   BEGIN
      NEW.INVOICE_ID  = GEN_ID(PICK_INVOICE_ID_GEN,1);
   END
   NEW.LAST_UPDATE_DATE = 'NOW';
   NEW.CREATE_DATE = 'NOW';
END ^

CREATE TRIGGER UPD_PICK_INVOICE FOR PICK_INVOICE 
ACTIVE BEFORE UPDATE POSITION 10 
AS
BEGIN
   IF ((NEW.INVOICE_ID IS NULL) OR (NEW.INVOICE_ID = 0)) THEN
   BEGIN
      NEW.INVOICE_ID  = GEN_ID(PICK_INVOICE_ID_GEN,1);
   END
   NEW.LAST_UPDATE_DATE = 'NOW';
END ^

CREATE TRIGGER ADD_PICK_INVOICE_LINE FOR PICK_INVOICE_LINE 
ACTIVE BEFORE INSERT POSITION 10 
AS
BEGIN
   IF ((NEW.INVLINE_LINE_ID IS NULL) OR (NEW.INVLINE_LINE_ID = 0)) THEN
   BEGIN
      NEW.INVLINE_LINE_ID  = GEN_ID(PICK_INVOICE_LINE_ID_GEN,1);
   END
   NEW.INVLINE_UPDATE_DATE = 'NOW';
   NEW.INVLINE_CREATED_DATE = 'NOW';
END ^

CREATE TRIGGER UPD_PICK_INVOICE_LINE FOR PICK_INVOICE_LINE 
ACTIVE BEFORE UPDATE POSITION 10 
AS
BEGIN
   IF ((NEW.INVLINE_LINE_ID IS NULL) OR (NEW.INVLINE_LINE_ID = 0)) THEN
   BEGIN
      NEW.INVLINE_LINE_ID  = GEN_ID(PICK_INVOICE_LINE_ID_GEN,1);
   END
   NEW.INVLINE_UPDATE_DATE = 'NOW';
END ^

CREATE TRIGGER PICK_ITEM_BI FOR PICK_ITEM 
ACTIVE BEFORE INSERT POSITION 0 
AS
DECLARE VARIABLE LABEL_NO VARCHAR(7);
BEGIN
   IF (NEW.PICK_LABEL_NO IS NULL) THEN
   BEGIN
      EXECUTE PROCEDURE NEXT_PICK_LABEL RETURNING_VALUES :LABEL_NO;
      NEW.PICK_LABEL_NO = LABEL_NO;
   END
END ^

CREATE TRIGGER ADD_WIP_ITEM_ORDERING FOR PICK_ITEM 
ACTIVE BEFORE INSERT POSITION 5 
AS
DECLARE VARIABLE WK_ORDER_METHOD CHAR(4);
DECLARE VARIABLE WK_WH_ID CHAR(2);
DECLARE VARIABLE WK_LOCN_ID VARCHAR(10);
BEGIN
   SELECT PICK_WIP_ITEM_POSTLOCN_METHOD 
   FROM CONTROL
   INTO :WK_ORDER_METHOD ;
   NEW.WIP_PRELOCN_ORDERING = '~';
   NEW.WIP_POSTLOCN_ORDERING = '~';
   IF (WK_ORDER_METHOD = 'TYPE') THEN
   BEGIN
      IF (NEW.SSN_ID IS NULL) THEN
      BEGIN
         IF (NEW.PROD_ID IS NULL) THEN
         BEGIN
            NEW.WIP_POSTLOCN_ORDERING = '~';
         END
         ELSE
         BEGIN
            /* a product */
            NEW.WIP_POSTLOCN_ORDERING = NEW.PROD_ID;
         END
      END
      ELSE
      BEGIN
         /* an ssn */
         NEW.WIP_POSTLOCN_ORDERING = NEW.SSN_ID;
      END
   END
END ^

CREATE TRIGGER ADD_PICK_ITEM_TIME FOR PICK_ITEM 
ACTIVE BEFORE INSERT POSITION 20 
AS
DECLARE VARIABLE WK_DO_CHART CHAR(1);
DECLARE VARIABLE WK_LEGACY_CODE VARCHAR(50);
DECLARE VARIABLE WK_LEGACY_LEDGER_CODE VARCHAR(50);
DECLARE VARIABLE WK_PROD_LEDGER_CODE VARCHAR(50);
DECLARE VARIABLE WK_SSN_LEDGER_CODE VARCHAR(50);
DECLARE VARIABLE WK_FOUND  INTEGER;
DECLARE VARIABLE WK_SSN_PROD_ID VARCHAR(30);
DECLARE VARIABLE WK_ISSN_ORIGINAL_SSN VARCHAR(20);
DECLARE VARIABLE WK_SO_COUNTRY  VARCHAR(35);
DECLARE VARIABLE WK_SO_TYPE     VARCHAR(2);
DECLARE VARIABLE WK_CN_TAX_RATE DOUBLE PRECISION ;
DECLARE VARIABLE WK_PI_PROD_ID  VARCHAR(30) ;
DECLARE VARIABLE WK_PP_APPLY_TAX CHAR(1) ;
BEGIN
   NEW.LAST_UPDATE_DATE = 'NOW';
   WK_DO_CHART = 'F';
   SELECT LEGACY_LEDGER_ACCOUNTS 
   FROM CONTROL
   INTO :WK_DO_CHART;
   IF (WK_DO_CHART IS NULL) THEN
   BEGIN
      WK_DO_CHART = 'F';
   END
   IF (WK_DO_CHART = 'T') THEN
   BEGIN
      IF ((NEW.LEGACY_LEDGER_SALE_CODE IS NULL) OR (NEW.LEGACY_LEDGER_SALE_CODE = '')) THEN
      BEGIN
         /* no sale account code */
         /* so 1st try one for the product */
         WK_FOUND = 0;
         WK_PROD_LEDGER_CODE  = NULL;
         WK_SSN_LEDGER_CODE  = NULL;
         WK_SSN_PROD_ID  = NULL;
         WK_ISSN_ORIGINAL_SSN  = NULL;
         IF ((NEW.PROD_ID IS NOT NULL) AND (NEW.PROD_ID <> '')) THEN
         BEGIN
            SELECT LEGACY_LEDGER_SALE_CODE
            FROM PROD_PROFILE
            WHERE PROD_PROFILE.PROD_ID = NEW.PROD_ID
            INTO :WK_PROD_LEDGER_CODE ;
         END
         IF ((WK_PROD_LEDGER_CODE IS NULL) OR (WK_PROD_LEDGER_CODE = '')) THEN
         BEGIN
            /* no account via prod_id so try ssn_id as an ssn  - to get prod_id */
            SELECT PROD_ID 
            FROM SSN
            WHERE SSN_ID = NEW.SSN_ID
            INTO :WK_SSN_PROD_ID;
            IF ((WK_SSN_PROD_ID IS NULL) OR (WK_SSN_PROD_ID = ''))  THEN
            BEGIN
               /* no account via ssns prod_id so try ssn_id as an issn  - to get prod_id */
               SELECT PROD_ID 
               FROM ISSN
               WHERE SSN_ID = NEW.SSN_ID
               INTO :WK_SSN_PROD_ID;
            END
            SELECT LEGACY_LEDGER_SALE_CODE
            FROM PROD_PROFILE
            WHERE PROD_PROFILE.PROD_ID = :WK_SSN_PROD_ID
            INTO :WK_PROD_LEDGER_CODE ;
         END
         IF ((WK_PROD_LEDGER_CODE IS NULL) OR (WK_PROD_LEDGER_CODE = '')) THEN
         BEGIN
            /* no account via prod_id so try ssns sale code  */
            SELECT LEGACY_LEDGER_SALE_CODE 
            FROM SSN
            WHERE SSN_ID = NEW.SSN_ID
            INTO :WK_SSN_LEDGER_CODE ;
            IF ((WK_SSN_LEDGER_CODE IS NULL) OR (WK_SSN_LEDGER_CODE = ''))  THEN
            BEGIN
               /* no account via ssn  so try ssn_id as an issn  - to get it  */
               SELECT ORIGINAL_SSN 
               FROM ISSN
               WHERE SSN_ID = NEW.SSN_ID
               INTO :WK_ISSN_ORIGINAL_SSN;
               SELECT LEGACY_LEDGER_SALE_CODE 
               FROM SSN
               WHERE SSN_ID = :WK_ISSN_ORIGINAL_SSN
               INTO :WK_SSN_LEDGER_CODE ;
            END
         END
         IF ((WK_PROD_LEDGER_CODE IS NULL) OR (WK_PROD_LEDGER_CODE = '')) THEN
         BEGIN
               NEW.LEGACY_LEDGER_SALE_CODE = WK_SSN_LEDGER_CODE;
         END
         ELSE
         BEGIN
               NEW.LEGACY_LEDGER_SALE_CODE = WK_PROD_LEDGER_CODE;
         END
      END
   END
   /* IF ((NEW.PICK_LINE_STATUS IS NULL) OR (NEW.PICK_LINE_STATUS IN ('UC','CF','OP'))) THEN */
   BEGIN
      /* now set the gst rate */
      /* SELECT D_COUNTRY, PICK_ORDER_TYPE */
      SELECT P_COUNTRY, PICK_ORDER_TYPE 
      FROM PICK_ORDER
      WHERE PICK_ORDER = NEW.PICK_ORDER
      INTO :WK_SO_COUNTRY, :WK_SO_TYPE;
      IF (WK_SO_COUNTRY IS NULL) THEN
      BEGIN
         WK_SO_COUNTRY = '';
      END
      WK_SO_COUNTRY = UPPER(WK_SO_COUNTRY);
      IF (WK_SO_TYPE IS NULL) THEN
      BEGIN
         WK_SO_TYPE = 'SO';
      END
      IF (NEW.DISCOUNT IS NULL) THEN
      BEGIN
         NEW.DISCOUNT = 0;
      END
      IF (WK_SO_COUNTRY = '' OR WK_SO_COUNTRY = 'AUSTRALIA' OR WK_SO_COUNTRY = 'AU') THEN
      BEGIN
         SELECT DEFAULT_GST_RATE 
         FROM CONTROL
         INTO :WK_CN_TAX_RATE;
         IF (WK_CN_TAX_RATE IS NULL) THEN
         BEGIN
            WK_CN_TAX_RATE = 0;
         END
         WK_PI_PROD_ID = NULL;
         IF (NEW.PROD_ID IS NOT NULL) THEN
         BEGIN
            WK_PI_PROD_ID = NEW.PROD_ID;
            IF (WK_PI_PROD_ID = '') THEN
            BEGIN
               WK_PI_PROD_ID = NULL;
            END
         END
         IF (WK_PI_PROD_ID IS NULL) THEN
         BEGIN
            SELECT FIRST 1 PROD_ID 
            FROM ISSN
            WHERE SSN_ID = NEW.SSN_ID
            OR    ORIGINAL_SSN = NEW.SSN_ID
            INTO :WK_PI_PROD_ID;
         END
         IF (WK_PI_PROD_ID = '') THEN
         BEGIN
            WK_PI_PROD_ID = NULL;
         END
         IF (WK_PI_PROD_ID IS NULL) THEN
         BEGIN
            WK_PP_APPLY_TAX = 'T';
         END
         ELSE
         BEGIN
            SELECT TAX_APPLICABLE
            FROM PROD_PROFILE
            WHERE PROD_ID = :WK_PI_PROD_ID
            INTO :WK_PP_APPLY_TAX;
         END
         IF (WK_PP_APPLY_TAX IS NULL) THEN
         BEGIN
            WK_PP_APPLY_TAX = 'T';
         END
         IF (WK_PP_APPLY_TAX = 'T') THEN
         BEGIN
            NEW.TAX_RATE = WK_CN_TAX_RATE;
         END
         ELSE
         BEGIN
            NEW.TAX_RATE = 0;
         END
         
      END
      ELSE
      BEGIN
         /* not au country */
         /* IF (NEW.TAX_RATE IS NULL) THEN */
            NEW.TAX_RATE = 0;
      END
      IF (WK_SO_TYPE = 'SO') THEN
      BEGIN
         /* calc the line total */
         /* NEW.LINE_TOTAL = COALESCE(NEW.SALE_PRICE, 0.00) * COALESCE(NEW.PICK_ORDER_QTY,0) * (1 - COALESCE(NEW.DISCOUNT, 0.00)/100) ; */
         /* use floor to ensure only 2 digits */
         /* NEW.LINE_TOTAL = FLOOR(COALESCE(NEW.SALE_PRICE, 0.00) * COALESCE(NEW.PICK_ORDER_QTY,0) * (1 - COALESCE(NEW.DISCOUNT, 0.00)/100) * 100) / 100 ; */
         /* use round for rounding */
         NEW.LINE_TOTAL = ROUND(COALESCE(NEW.SALE_PRICE, 0.00) * COALESCE(NEW.PICK_ORDER_QTY,0) * (1 - COALESCE(NEW.DISCOUNT, 0.00)/100), 2) ; 
         /* calc the gst amount */
         /* NEW.TAX_AMOUNT = NEW.LINE_TOTAL * ( COALESCE(NEW.TAX_RATE,0.00)/100); */
         /* NEW.TAX_AMOUNT = FLOOR(NEW.LINE_TOTAL * ( COALESCE(NEW.TAX_RATE,0.00)/100) * 100) / 100; */
         NEW.TAX_AMOUNT = ROUND(NEW.LINE_TOTAL * ( COALESCE(NEW.TAX_RATE,0.00)/100) , 2); 
      END
   END
END ^

CREATE TRIGGER UPDATE_WIP_ITEM_ORDERING FOR PICK_ITEM 
ACTIVE BEFORE UPDATE POSITION 5 
AS
DECLARE VARIABLE WK_ORDER_METHOD CHAR(4);
DECLARE VARIABLE WK_WH_ID CHAR(2);
DECLARE VARIABLE WK_LOCN_ID VARCHAR(10);
BEGIN
   SELECT PICK_WIP_ITEM_POSTLOCN_METHOD 
   FROM CONTROL
   INTO :WK_ORDER_METHOD ;
   NEW.WIP_PRELOCN_ORDERING = '~';
   NEW.WIP_POSTLOCN_ORDERING = '~';
   IF (WK_ORDER_METHOD = 'TYPE') THEN
   BEGIN
      IF (NEW.SSN_ID IS NULL) THEN
      BEGIN
         IF (NEW.PROD_ID IS NULL) THEN
         BEGIN
            NEW.WIP_POSTLOCN_ORDERING = '~';
         END
         ELSE
         BEGIN
            /* a product */
            NEW.WIP_POSTLOCN_ORDERING = NEW.PROD_ID;
         END
      END
      ELSE
      BEGIN
         /* an ssn */
         NEW.WIP_POSTLOCN_ORDERING = NEW.SSN_ID;
      END
   END
END ^

CREATE TRIGGER UPDATE_PICK_ITEM_TIME FOR PICK_ITEM 
ACTIVE BEFORE UPDATE POSITION 20 
AS
DECLARE VARIABLE WK_WH_ID CHAR(2);
DECLARE VARIABLE WK_LEGACY_WH_ID VARCHAR(2);
DECLARE VARIABLE WK_DUMMY INTEGER;
DECLARE VARIABLE WK_ISSN_SSN VARCHAR(20);
DECLARE VARIABLE WK_ISSN_WH CHAR(2);
DECLARE VARIABLE WK_ISSN_LOCN VARCHAR(10);
DECLARE VARIABLE WK_ISSN_QTY INTEGER;
DECLARE VARIABLE WK_REFERENCE VARCHAR(255);
DECLARE VARIABLE WK_COMPANY_ID VARCHAR(20);
DECLARE VARIABLE WK_HELD_STATUS VARCHAR(40);
DECLARE VARIABLE WK_SO_COUNTRY  VARCHAR(35);
DECLARE VARIABLE WK_SO_TYPE     VARCHAR(2);
DECLARE VARIABLE WK_CN_TAX_RATE DOUBLE PRECISION ;
DECLARE VARIABLE WK_PI_PROD_ID  VARCHAR(30) ;
DECLARE VARIABLE WK_PP_APPLY_TAX CHAR(1) ;
DECLARE VARIABLE WK_LOG_RESULT INTEGER;
DECLARE VARIABLE WK_LOG_FILENAME VARCHAR(80);
DECLARE VARIABLE WK_FOUND INTEGER;
DECLARE VARIABLE WK_DO_PL CHAR(1);
BEGIN
   WK_LOG_FILENAME = '/tmp/update.pi.log';
   NEW.LAST_UPDATE_DATE = 'NOW';
  
   /* if not product NOPROD but a product ( and new status DS and zero qty picked then release back as OP) */
  IF ((NEW.PROD_ID IS NOT NULL) AND (NEW.PROD_ID <> 'NOPROD')) THEN
  BEGIN
     IF (NEW.PICK_LINE_STATUS = 'DS' AND NEW.PICKED_QTY = 0) THEN
     BEGIN
        /* 260710 - check whether have a held status
        if do then use that status  rather than OP 
        also dont clear the reason field */
        WK_COMPANY_ID = NULL;
        SELECT COMPANY_ID 
        FROM PICK_ORDER
        WHERE PICK_ORDER = NEW.PICK_ORDER
        INTO :WK_COMPANY_ID;
        WK_HELD_STATUS = NULL;
        SELECT DESCRIPTION
        FROM OPTIONS
        WHERE GROUP_CODE = 'CMPPKHELD'
        AND CODE = :WK_COMPANY_ID
        INTO :WK_HELD_STATUS;
        IF (WK_HELD_STATUS IS NULL) THEN
        BEGIN
           NEW.PICK_LINE_STATUS = 'OP';
        END
        ELSE
        BEGIN
           NEW.PICK_LINE_STATUS = :WK_HELD_STATUS;
        END
        NEW.DEVICE_ID = NULL;
        /* NEW.REASON = ''; */
     END
  END
/*
  WK_WH_ID = NEW.WH_ID;
  SELECT WH_LEGACY_WH_ID FROM WAREHOUSE WHERE WH_ID = :WK_WH_ID INTO :WK_LEGACY_WH_ID;
  IF (WK_LEGACY_WH_ID IS NOT NULL) THEN
  BEGIN
     NEW.WH_ID = :WK_LEGACY_WH_ID;
  END
*/
   /* now if the line is for an ssn
      and the issn.pick_item matches - ie confirmed
      then cannot change the ssn */
   IF (NEW.SSN_ID IS NOT NULL) THEN
   BEGIN
      FOR SELECT SSN_ID, WH_ID, LOCN_ID, CURRENT_QTY
          FROM ISSN
          WHERE ISSN.PICK_ORDER = NEW.PICK_LABEL_NO
          INTO :WK_ISSN_SSN, :WK_ISSN_WH, :WK_ISSN_LOCN, :WK_ISSN_QTY
      DO
      BEGIN
         IF (OLD.SSN_ID IS NULL) THEN
         BEGIN
            /* allow this */
            WK_DUMMY = 1;
         END
         ELSE
         BEGIN
            IF (NEW.SSN_ID <> OLD.SSN_ID) THEN
            BEGIN
               /* cannot change the ssn since its confirmed */
               NEW.SSN_ID = OLD.SSN_ID;
               NEW.REASON = 'Cannot change the ssn on a confirmed line';
            END
         END
      END
   END
   ELSE
   BEGIN
      /* new ssn is null */
      IF (OLD.SSN_ID IS NULL) THEN
      BEGIN
         /* allow this */
         WK_DUMMY = 1;
      END
      ELSE
      BEGIN
         FOR SELECT SSN_ID, WH_ID, LOCN_ID, CURRENT_QTY
             FROM ISSN
             WHERE ISSN.PICK_ORDER = NEW.PICK_LABEL_NO
             INTO :WK_ISSN_SSN, :WK_ISSN_WH, :WK_ISSN_LOCN, :WK_ISSN_QTY
         DO
         BEGIN
            /* cannot change the ssn since its confirmed */
            NEW.SSN_ID = OLD.SSN_ID;
            NEW.REASON = 'Cannot change the ssn on a confirmed line';
         END
      END
   END
   IF (NEW.PICK_LINE_STATUS = 'CN') THEN
   BEGIN
      IF (NEW.SSN_ID IS NOT NULL) THEN
      BEGIN
         FOR SELECT SSN_ID, WH_ID, LOCN_ID, CURRENT_QTY
             FROM ISSN
             WHERE ISSN.PICK_ORDER = NEW.PICK_LABEL_NO
             INTO :WK_ISSN_SSN, :WK_ISSN_WH, :WK_ISSN_LOCN, :WK_ISSN_QTY
         DO
         BEGIN
            /* unconfirm current order line */
            UPDATE ISSN 
               SET PREV_PREV_PICK_ORDER = PREV_PICK_ORDER,
                   PREV_PICK_ORDER = PICK_ORDER,
                   PICK_ORDER = NULL,
                   PREV_PREV_PACK_ID = PREV_PACK_ID,
                   PREV_PACK_ID = PACK_ID,
                   PACK_ID = NULL,
                   PREV_PREV_DESPATCH_ID = PREV_DESPATCH_ID,
                   PREV_DESPATCH_ID = DESPATCH_ID,
                   DESPATCH_ID = NULL 
             WHERE ISSN.SSN_ID = :WK_ISSN_SSN;
             WK_REFERENCE = OLD.PICK_ORDER || ' ' || OLD.PICK_LABEL_NO;
             EXECUTE PROCEDURE ADD_SSN_HIST (:WK_ISSN_WH ,
                     :WK_ISSN_LOCN ,
                     :WK_ISSN_SSN ,
                     '' ,
                     '' ,
                     'NOW',
                     'Unconfirm ISSN on Cancelled Pick Item',
                     :WK_REFERENCE,
                     :WK_ISSN_QTY,
                     '' ,
                     '' );
         END
      END
   END
   IF (NEW.PICK_ORDER_LINE_NO <> OLD.PICK_ORDER_LINE_NO) THEN
   BEGIN
      /* NEW.PREV_PREV_PICK_ORDER_LINE_NO = NEW.PREV_PICK_ORDER_LINE_NO;
      NEW.PREV_PICK_ORDER_LINE_NO = OLD.PICK_ORDER_LINE_NO; */
      /* stop changing the line no */
      NEW.PICK_ORDER_LINE_NO = OLD.PICK_ORDER_LINE_NO;
   END
   IF (NEW.PROD_ID <> OLD.PROD_ID) THEN
   BEGIN
      NEW.PREV_PREV_PROD_ID = NEW.PREV_PROD_ID;
      NEW.PREV_PROD_ID = OLD.PROD_ID ;
   END
   IF (NEW.SSN_ID <> OLD.SSN_ID ) THEN
   BEGIN
      NEW.PREV_PREV_SSN_ID = NEW.PREV_SSN_ID ;
      NEW.PREV_SSN_ID = OLD.SSN_ID ;
   END
   /* IF ((NEW.PICK_LINE_STATUS IS NULL) OR (NEW.PICK_LINE_STATUS IN ('UC','CF','OP'))) THEN */
   BEGIN
      IF (NEW.DISCOUNT IS NULL) THEN
      BEGIN
         NEW.DISCOUNT = 0;
      END
      /* now set the gst rate */
      /* SELECT D_COUNTRY, PICK_ORDER_TYPE */
      SELECT P_COUNTRY, PICK_ORDER_TYPE 
      FROM PICK_ORDER
      WHERE PICK_ORDER = NEW.PICK_ORDER
      INTO :WK_SO_COUNTRY, :WK_SO_TYPE;
      IF (WK_SO_COUNTRY IS NULL) THEN
      BEGIN
         WK_SO_COUNTRY = '';
      END
      WK_SO_COUNTRY = UPPER(WK_SO_COUNTRY);
      IF (WK_SO_TYPE IS NULL) THEN
      BEGIN
         WK_SO_TYPE = 'SO';
      END
      IF (WK_SO_COUNTRY = '' OR WK_SO_COUNTRY = 'AUSTRALIA' OR WK_SO_COUNTRY = 'AU') THEN
      BEGIN
         SELECT DEFAULT_GST_RATE 
         FROM CONTROL
         INTO :WK_CN_TAX_RATE;
         IF (WK_CN_TAX_RATE IS NULL) THEN
         BEGIN
            WK_CN_TAX_RATE = 0;
         END
         WK_PI_PROD_ID = NULL;
         IF (NEW.PROD_ID IS NOT NULL) THEN
         BEGIN
            WK_PI_PROD_ID = NEW.PROD_ID;
            IF (WK_PI_PROD_ID = '') THEN
            BEGIN
               WK_PI_PROD_ID = NULL;
            END
         END
         IF (WK_PI_PROD_ID IS NULL) THEN
         BEGIN
            SELECT FIRST 1 PROD_ID 
            FROM ISSN
            WHERE SSN_ID = NEW.SSN_ID
            OR    ORIGINAL_SSN = NEW.SSN_ID
            INTO :WK_PI_PROD_ID;
         END
         IF (WK_PI_PROD_ID = '') THEN
         BEGIN
            WK_PI_PROD_ID = NULL;
         END
         IF (WK_PI_PROD_ID IS NULL) THEN
         BEGIN
            WK_PP_APPLY_TAX = 'T';
         END
         ELSE
         BEGIN
            SELECT TAX_APPLICABLE
            FROM PROD_PROFILE
            WHERE PROD_ID = :WK_PI_PROD_ID
            INTO :WK_PP_APPLY_TAX;
         END
         IF (WK_PP_APPLY_TAX IS NULL) THEN
         BEGIN
            WK_PP_APPLY_TAX = 'T';
         END
         IF (WK_PP_APPLY_TAX = 'T') THEN
         BEGIN
            NEW.TAX_RATE = WK_CN_TAX_RATE;
         END
         ELSE
         BEGIN
            NEW.TAX_RATE = 0;
         END
      END
      ELSE
      BEGIN
         /* not au country */
         /* IF (NEW.TAX_RATE IS NULL) THEN */
            NEW.TAX_RATE = 0;
      END
      IF (WK_SO_TYPE = 'SO') THEN
      BEGIN
         /* calc the line total */
         /* NEW.LINE_TOTAL = COALESCE(NEW.SALE_PRICE, 0.00) * COALESCE(NEW.PICK_ORDER_QTY,0) * (1 - COALESCE(NEW.DISCOUNT, 0.00)/100) ; */
         /* use floor to ensure only 2 digits */
         /* NEW.LINE_TOTAL = FLOOR(COALESCE(NEW.SALE_PRICE, 0.00) * COALESCE(NEW.PICK_ORDER_QTY,0) * (1 - COALESCE(NEW.DISCOUNT, 0.00)/100) * 100) / 100 ; */
         /* use round for rounding */
         NEW.LINE_TOTAL = ROUND(COALESCE(NEW.SALE_PRICE, 0.00) * COALESCE(NEW.PICK_ORDER_QTY,0) * (1 - COALESCE(NEW.DISCOUNT, 0.00)/100), 2) ; 
         /* calc the gst amount */
         /* NEW.TAX_AMOUNT = NEW.LINE_TOTAL * ( COALESCE(NEW.TAX_RATE,0.00)/100); */
         /* NEW.TAX_AMOUNT = FLOOR(NEW.LINE_TOTAL * ( COALESCE(NEW.TAX_RATE,0.00)/100) * 100) / 100; */
         NEW.TAX_AMOUNT = ROUND(NEW.LINE_TOTAL * ( COALESCE(NEW.TAX_RATE,0.00)/100) , 2); 
      END
   END
   BEGIN
      /*
      if  all lines DX or DC or HD or AS or CN
      then update all the pick_location to be 'DC' that were 'DS'
      */
      WK_DO_PL = 'F';
      IF (NEW.PICK_LINE_STATUS IS NOT NULL) THEN
      BEGIN
         IF (POS(',DX,DC,HD,AS,CN,CR,DI,',NEW.PICK_LINE_STATUS,0,1) > -1) THEN
         BEGIN
            WK_FOUND = 0;
            SELECT FIRST 1 1
            FROM PICK_ITEM P2
            WHERE P2.PICK_ORDER = NEW.PICK_ORDER
            AND P2.PICK_LABEL_NO <> NEW.PICK_LABEL_NO
            AND  (POS(',DX,DC,HD,AS,CN,CR,DI,',P2.PICK_LINE_STATUS,0,1) =  -1) 
            INTO :WK_FOUND;
            IF (WK_FOUND IS NULL) THEN
            BEGIN
               WK_FOUND = 0;
            END
            IF (WK_FOUND = 0) THEN
            BEGIN
               WK_DO_PL = 'T';
               UPDATE PICK_LOCATION
               SET PICK_LOCATION_STATUS = 'DC'
               WHERE PICK_ORDER = NEW.PICK_ORDER
               AND PICK_LOCATION_STATUS IN ( 'DS','OP');
            END
         END
      END
   END
END ^

CREATE TRIGGER SAVE_PICK_ITEM FOR PICK_ITEM 
ACTIVE BEFORE DELETE POSITION 0 
AS
DECLARE VARIABLE WK_SAVE_PICK_ITEM CHAR(1);
DECLARE VARIABLE WK_ISSN_SSN VARCHAR(20);
DECLARE VARIABLE WK_REFERENCE VARCHAR(40);
DECLARE VARIABLE WK_ISSN_WH CHAR(2);
DECLARE VARIABLE WK_ISSN_LOCN VARCHAR(10);
DECLARE VARIABLE WK_ISSN_QTY INTEGER;
BEGIN
   IF (OLD.CANCEL_METHOD IS NULL) THEN
   BEGIN
      WK_SAVE_PICK_ITEM = 'T';
   END
   ELSE
   BEGIN
      WK_SAVE_PICK_ITEM = OLD.CANCEL_METHOD;
   END
   IF (WK_SAVE_PICK_ITEM = '') THEN
   BEGIN
      WK_SAVE_PICK_ITEM = 'T';
   END

   IF (WK_SAVE_PICK_ITEM = 'T') THEN
   BEGIN
      INSERT INTO PICK_ITEM_CANCEL(
        PICK_LABEL_NO ,
        PICK_ORDER ,
        PICK_ORDER_LINE_NO ,
        CONTACT_NAME ,
        PROD_ID ,
        SSN_ID ,
        WARRANTY_TERM ,
        PICK_LABEL_DATE ,
        SPECIAL_INSTRUCTIONS1 ,
        SPECIAL_INSTRUCTIONS2 ,
        SHIP_VIA ,
        PICK_ORDER_QTY ,
        PICK_ALLOCATED_QTY ,
        PICKED_QTY ,
        PICK_LINE_DUE_DATE ,
        PICK_STARTED ,
        DESPATCH_TS ,
        DESPATCH_LOCATION ,
        CREATE_DATE ,
        USER_ID ,
        DEVICE_ID ,
        CHECKIN_START ,
        CHECKIN_FINISH ,
        CHECKIN_USER_ID ,
        PICK_LINE_STATUS ,
        PARTIAL_PICK_ALLOWED ,
        DESPATCH_PALLET_NO ,
        WH_ID ,
        PICK_LOCATION ,
        REASON ,
        SALE_PRICE ,
        DISCOUNT ,
        SSN_CONFIRM,
        CANCEL_METHOD )
      VALUES (
        OLD.PICK_LABEL_NO ,
        OLD.PICK_ORDER ,
        OLD.PICK_ORDER_LINE_NO ,
        OLD.CONTACT_NAME ,
        OLD.PROD_ID ,
        OLD.SSN_ID ,
        OLD.WARRANTY_TERM ,
        OLD.PICK_LABEL_DATE ,
        OLD.SPECIAL_INSTRUCTIONS1 ,
        OLD.SPECIAL_INSTRUCTIONS2 ,
        OLD.SHIP_VIA ,
        OLD.PICK_ORDER_QTY ,
        OLD.PICK_ALLOCATED_QTY ,
        OLD.PICKED_QTY ,
        OLD.PICK_LINE_DUE_DATE ,
        OLD.PICK_STARTED ,
        OLD.DESPATCH_TS ,
        OLD.DESPATCH_LOCATION ,
        OLD.CREATE_DATE ,
        OLD.USER_ID ,
        OLD.DEVICE_ID ,
        OLD.CHECKIN_START ,
        OLD.CHECKIN_FINISH ,
        OLD.CHECKIN_USER_ID ,
        OLD.PICK_LINE_STATUS ,
        OLD.PARTIAL_PICK_ALLOWED ,
        OLD.DESPATCH_PALLET_NO ,
        OLD.WH_ID ,
        OLD.PICK_LOCATION ,
        'Record Deleted' ,
        OLD.SALE_PRICE ,
        OLD.DISCOUNT ,
        OLD.SSN_CONFIRM,
        'l' );
   END
   /* record saved - now if the line is for an ssn
      and the issn.pick_item matches - ie confirmed
      then unconfirm the ssn */
   IF (OLD.SSN_ID IS NOT NULL) THEN
   BEGIN
      FOR SELECT SSN_ID, WH_ID, LOCN_ID, CURRENT_QTY
          FROM ISSN
          WHERE ISSN.PICK_ORDER = OLD.PICK_LABEL_NO
          INTO :WK_ISSN_SSN, :WK_ISSN_WH, :WK_ISSN_LOCN, :WK_ISSN_QTY
      DO
      BEGIN
         /* unconfirm current order line */
         UPDATE ISSN 
            SET PREV_PREV_PICK_ORDER = PREV_PICK_ORDER,
                PREV_PICK_ORDER = PICK_ORDER,
                PICK_ORDER = NULL,
                PREV_PREV_PACK_ID = PREV_PACK_ID,
                PREV_PACK_ID = PACK_ID,
                PACK_ID = NULL,
                PREV_PREV_DESPATCH_ID = PREV_DESPATCH_ID,
                PREV_DESPATCH_ID = DESPATCH_ID,
                DESPATCH_ID = NULL 
          WHERE ISSN.SSN_ID = :WK_ISSN_SSN;
          WK_REFERENCE = OLD.PICK_ORDER || ' ' || OLD.PICK_LABEL_NO;
          EXECUTE PROCEDURE ADD_SSN_HIST (:WK_ISSN_WH ,
                  :WK_ISSN_LOCN ,
                  :WK_ISSN_SSN ,
                  '' ,
                  '' ,
                  'NOW',
                  'Unconfirm ISSN on Deleted Pick Item',
                  :WK_REFERENCE,
                  :WK_ISSN_QTY,
                  '' ,
                  '' );
      END
   END
END ^

CREATE TRIGGER STOP_DELETE_PICK_ITEM FOR PICK_ITEM 
ACTIVE BEFORE DELETE POSITION 0 
AS
DECLARE VARIABLE WK_OK INTEGER;
BEGIN
   IF ((OLD.PICK_LINE_STATUS IS NULL) OR
       (OLD.PICK_LINE_STATUS = 'UC') OR
       (OLD.PICK_LINE_STATUS = 'CF') OR
       (OLD.PICK_LINE_STATUS = 'OP') OR
       (OLD.PICK_LINE_STATUS = 'UP') OR
       (OLD.PICK_LINE_STATUS = 'AS') OR
       (OLD.PICK_LINE_STATUS = 'DX') OR
       (OLD.PICK_LINE_STATUS = 'DI') OR
       (OLD.PICK_LINE_STATUS = 'CR') OR
       (OLD.PICK_LINE_STATUS = 'CN') OR
       (OLD.PICK_LINE_STATUS = 'HD') ) THEN
   BEGIN
      WK_OK = 1;
   END
   ELSE
   BEGIN
      WK_OK = 0;
      EXCEPTION NO_DELETE_SO;
   END
END ^

CREATE TRIGGER ADD_PICK_ITEM_CANCEL_TIME FOR PICK_ITEM_CANCEL 
ACTIVE BEFORE INSERT POSITION 20 
AS
BEGIN
   NEW.LAST_UPDATE_DATE = 'NOW';
END ^

CREATE TRIGGER UPD_PICK_ITEM_CANCEL_TIME FOR PICK_ITEM_CANCEL 
ACTIVE BEFORE UPDATE POSITION 20 
AS
BEGIN
   NEW.LAST_UPDATE_DATE = 'NOW';
END ^

CREATE TRIGGER PICK_DETAIL_DETAIL_ID FOR PICK_ITEM_DETAIL 
ACTIVE BEFORE INSERT POSITION 0 
AS
BEGIN
  IF (NEW.PICK_DETAIL_ID IS NULL) THEN
      NEW.PICK_DETAIL_ID = GEN_ID(PICK_DETAIL_GEN, 1);
END ^

CREATE TRIGGER ADD_PICK_ITEM_DETAIL_TIME FOR PICK_ITEM_DETAIL 
ACTIVE BEFORE INSERT POSITION 20 
AS
BEGIN
   NEW.LAST_UPDATE_DATE = 'NOW';
   IF (NEW.PICK_ORDER IS NULL) THEN
   BEGIN
      SELECT PICK_ORDER 
      FROM PICK_ITEM
      WHERE PICK_LABEL_NO = NEW.PICK_LABEL_NO
      INTO NEW.PICK_ORDER;
   END
END ^

CREATE TRIGGER UPDATE_PICK_ITEM_DETAIL_TIME FOR PICK_ITEM_DETAIL 
ACTIVE BEFORE UPDATE POSITION 20 
AS
DECLARE VARIABLE WK_LEGACY_TRYS INTEGER;
DECLARE VARIABLE WK_PICK_ORDER VARCHAR(15);
DECLARE VARIABLE WK_LEGACY_ID VARCHAR(50);
DECLARE VARIABLE WK_GOTO_DX CHAR(1);
BEGIN
   NEW.LAST_UPDATE_DATE = 'NOW';
   IF (NEW.PICK_ORDER IS NULL) THEN
   BEGIN
      SELECT PICK_ORDER 
      FROM PICK_ITEM
      WHERE PICK_LABEL_NO = NEW.PICK_LABEL_NO
      INTO NEW.PICK_ORDER;
   END
   IF (NEW.PID_LEGACY_TRY IS NULL) THEN
   BEGIN
      NEW.PID_LEGACY_TRY = 0;
   END
   IF (NEW.PICK_DETAIL_STATUS = 'Dl') THEN
   BEGIN
      SELECT LEGACY_TRYS FROM CONTROL INTO :WK_LEGACY_TRYS;
      IF (WK_LEGACY_TRYS IS NULL) THEN
      BEGIN
         WK_LEGACY_TRYS = 0;
      END
      NEW.PID_LEGACY_TRY = NEW.PID_LEGACY_TRY + 1;
      IF (NEW.PID_LEGACY_TRY < :WK_LEGACY_TRYS) THEN
      BEGIN
         NEW.PICK_DETAIL_STATUS = 'DL';
      END
   END
   IF (NEW.PICK_DETAIL_STATUS = 'DL') THEN
   BEGIN
      WK_GOTO_DX = 'F';
      SELECT PICK_ORDER FROM PICK_ITEM
      WHERE  PICK_LABEL_NO = NEW.PICK_LABEL_NO
      INTO :WK_PICK_ORDER;
      SELECT SO_LEGACY_INTERNAL_ID FROM PICK_ORDER
      WHERE PICK_ORDER  = :WK_PICK_ORDER
      INTO :WK_LEGACY_ID;
      IF (WK_LEGACY_ID IS NULL ) THEN
      BEGIN
         WK_GOTO_DX = 'T';
      END
      IF (WK_LEGACY_ID = '') THEN
      BEGIN
         WK_GOTO_DX = 'T';
      END
      IF (WK_GOTO_DX = 'T') THEN
      BEGIN
         NEW.PICK_DETAIL_STATUS = 'DX';
      END
   END
END ^

CREATE TRIGGER ADD_PICK_ITEM_LINE_NO_TIME FOR PICK_ITEM_LINE_NO 
ACTIVE BEFORE INSERT POSITION 20 
AS
BEGIN
   NEW.LAST_UPDATE_DATE = 'NOW';
END ^

CREATE TRIGGER UPD_PICK_ITEM_LINE_NO_TIME FOR PICK_ITEM_LINE_NO 
ACTIVE BEFORE UPDATE POSITION 20 
AS
BEGIN
   NEW.LAST_UPDATE_DATE = 'NOW';
END ^

CREATE TRIGGER ADD_PICK_LOCATION FOR PICK_LOCATION 
ACTIVE BEFORE INSERT POSITION 10 
AS
BEGIN
   IF ((NEW.RECORD_ID IS NULL) OR (NEW.RECORD_ID = 0)) THEN
   BEGIN
      NEW.RECORD_ID  = GEN_ID(PICK_LOCATION_ID_GEN,1);
   END
   NEW.LAST_UPDATE_DATE = 'NOW';
   NEW.CREATED_DATE = 'NOW';
END ^

CREATE TRIGGER UPD_PICK_LOCATION FOR PICK_LOCATION 
ACTIVE BEFORE UPDATE POSITION 10 
AS
BEGIN
   IF ((NEW.RECORD_ID IS NULL) OR (NEW.RECORD_ID = 0)) THEN
   BEGIN
      NEW.RECORD_ID  = GEN_ID(PICK_LOCATION_ID_GEN,1);
   END
   NEW.LAST_UPDATE_DATE = 'NOW';
END ^

CREATE TRIGGER ADD_SALES_ORDER_COMPANY FOR PICK_ORDER 
ACTIVE BEFORE INSERT POSITION 2 
AS
DECLARE VARIABLE WK_ORDER_COMPANY VARCHAR(20);
DECLARE VARIABLE WK_FOUND INTEGER;
DECLARE VARIABLE WK_TEST_COMPANY VARCHAR(20);
DECLARE VARIABLE WK_TEST_COMPANY2 VARCHAR(20);
BEGIN
   WK_ORDER_COMPANY = '';
   SELECT COMPANY_ID 
   FROM CONTROL
   INTO :WK_ORDER_COMPANY ;

   IF (NEW.COMPANY_ID IS NULL) THEN
   BEGIN
      NEW.COMPANY_ID = :WK_ORDER_COMPANY;
   END
   /* now check the company */
   WK_FOUND = 0;
   WK_TEST_COMPANY = NEW.COMPANY_ID;
   SELECT 1
   FROM COMPANY
   WHERE COMPANY_ID = :WK_TEST_COMPANY
   INTO :WK_FOUND;
   IF (WK_FOUND IS NULL) THEN
   BEGIN
      WK_FOUND = 0;
   END
   IF (WK_FOUND = 0) THEN
   BEGIN
      SELECT FIRST 1 1, COMPANY_ID
      FROM COMPANY
      WHERE NAME = :WK_TEST_COMPANY
      INTO :WK_FOUND, WK_TEST_COMPANY2;
      IF (WK_FOUND IS NULL) THEN
      BEGIN
         WK_FOUND = 0;
      END
      IF (WK_FOUND = 1) THEN
      BEGIN
         NEW.COMPANY_ID = WK_TEST_COMPANY2;
      END
   END
   IF (WK_FOUND = 0) THEN
   BEGIN
      NEW.COMPANY_ID = :WK_ORDER_COMPANY;
   END
END ^

CREATE TRIGGER ADD_WIP_ORDER_ORDERING FOR PICK_ORDER 
ACTIVE BEFORE INSERT POSITION 5 
AS
DECLARE VARIABLE WK_ORDER_METHOD CHAR(4);
DECLARE VARIABLE WK_PRIORITY SMALLINT;
DECLARE VARIABLE TRANS_DATE TIMESTAMP;
DECLARE VARIABLE WK_DATE VARCHAR(20);
DECLARE VARIABLE WK_TIME VARCHAR(10);
BEGIN
   SELECT PICK_WIP_ORDER_METHOD, DEFAULT_PICK_PRIORITY 
   FROM CONTROL
   INTO :WK_ORDER_METHOD, :WK_PRIORITY;
   IF (NEW.PICK_PRIORITY IS NULL) THEN
   BEGIN
      NEW.PICK_PRIORITY = :WK_PRIORITY;
   END
   IF (NEW.PICK_PRIORITY = 0) THEN
   BEGIN
      NEW.PICK_PRIORITY = :WK_PRIORITY;
   END
   NEW.WIP_ORDERING = '~';
   IF (WK_ORDER_METHOD = 'ADP') THEN
   BEGIN
      IF (NEW.APPROVED_DESP_DATE IS NULL) THEN
      BEGIN
         IF (NEW.APPROVED_DATE IS NULL) THEN
         BEGIN
            NEW.WIP_ORDERING = '~';
         END
         ELSE
         BEGIN
            TRANS_DATE = NEW.APPROVED_DATE ;
/*
            WK_DATE = CAST(MER_YEAR(TRANS_DATE) AS CHAR(4)) || RTRIM(PADLEFT(MER_MONTH(TRANS_DATE),2)) || RTRIM(PADLEFT(MER_DAY(TRANS_DATE),2)) ;
            WK_TIME = RTRIM(PADLEFT(MER_HOUR(TRANS_DATE),2)) || RTRIM(PADLEFT(MER_MINUTE(TRANS_DATE),2)) ; 
*/
            WK_DATE = MER_YEAR(TRANS_DATE)  || LPAD(MER_MONTH(TRANS_DATE),'0',2) || LPAD(MER_DAY(TRANS_DATE),'0',2) ;
            WK_TIME = LPAD(MER_HOUR(TRANS_DATE),'0',2) || LPAD(MER_MINUTE(TRANS_DATE),'0',2) ;
            WK_DATE = '}' || WK_DATE || ' ' || WK_TIME;
            NEW.WIP_ORDERING = :WK_DATE;
         END
      END
      ELSE
      BEGIN
         TRANS_DATE = NEW.APPROVED_DESP_DATE ;
/*
         WK_DATE = CAST(MER_YEAR(TRANS_DATE) AS CHAR(4)) || RTRIM(PADLEFT(MER_MONTH(TRANS_DATE),2)) || RTRIM(PADLEFT(MER_DAY(TRANS_DATE),2)) ;
         WK_TIME = RTRIM(PADLEFT(MER_HOUR(TRANS_DATE),2)) || RTRIM(PADLEFT(MER_MINUTE(TRANS_DATE),2)) ;
*/
         WK_DATE = MER_YEAR(TRANS_DATE)  || LPAD(MER_MONTH(TRANS_DATE),'0',2) || LPAD(MER_DAY(TRANS_DATE),'0',2) ;
         WK_TIME = LPAD(MER_HOUR(TRANS_DATE),'0',2) || LPAD(MER_MINUTE(TRANS_DATE),'0',2) ;
         WK_DATE = WK_DATE || ' ' || WK_TIME;
         NEW.WIP_ORDERING = :WK_DATE;
      END
   END
END ^

CREATE TRIGGER ADD_PICK_ORDER_TIME FOR PICK_ORDER 
ACTIVE BEFORE INSERT POSITION 20 
AS
DECLARE VARIABLE WK_DUE_DATE TIMESTAMP;
DECLARE VARIABLE WK_DUE_YEAR INTEGER;
DECLARE VARIABLE WK_DUE_MONTH INTEGER;
DECLARE VARIABLE WK_DUE_DAY INTEGER;
DECLARE VARIABLE WK_FILENAME VARCHAR(255);
DECLARE VARIABLE WK_RESULT INTEGER;
DECLARE VARIABLE WK_DO_CHART CHAR(1);
DECLARE VARIABLE WK_LEGACY_CODE VARCHAR(70);
DECLARE VARIABLE WK_LEGACY_LEDGER_CODE VARCHAR(50);
DECLARE VARIABLE WK_FOUND  INTEGER;
DECLARE VARIABLE WK_SO_COUNTRY  VARCHAR(20);
DECLARE VARIABLE WK_SO_TYPE     VARCHAR(2);
DECLARE VARIABLE WK_CN_TAX_RATE DOUBLE PRECISION ;
DECLARE VARIABLE WK_SO_TAXABLE_AMOUNT DOUBLE PRECISION ;
DECLARE VARIABLE WK_SO_TOTAL DOUBLE PRECISION ;
BEGIN
   NEW.LAST_UPDATE_DATE = 'NOW';
   WK_FILENAME = '/tmp/add_so_time.log';
   IF (NEW.CREATE_DATE IS NULL) THEN
   BEGIN
      NEW.CREATE_DATE = 'NOW';
   END
   IF (NEW.PICK_DUE_DATE IS NOT NULL) THEN
   BEGIN
      WK_DUE_DATE = NEW.PICK_DUE_DATE;
      IF (ZEROTIME(WK_DUE_DATE) <> NEW.PICK_DUE_DATE) THEN
      BEGIN
         /* pick_due is a timestamp not a date */
         /* so use the next day */
         WK_DUE_YEAR = MER_YEAR(WK_DUE_DATE);
         WK_DUE_MONTH = MER_MONTH(WK_DUE_DATE);
         WK_DUE_DAY = MER_DAY(WK_DUE_DATE) + 1;
/*
         WK_RESULT = FILE_WRITELN(WK_FILENAME, 'start add pick_order time '); 
         WK_RESULT = FILE_WRITELN(WK_FILENAME, NEW.PICK_ORDER); 
         WK_RESULT = FILE_WRITELN(WK_FILENAME, cast(cast('NOW' as timestamp) as char(22))); 
         WK_RESULT = FILE_WRITELN(WK_FILENAME, cast(wk_due_date as char(22))); 
*/
         NEW.PICK_DUE_DATE = MAKEDATE(:WK_DUE_YEAR, :WK_DUE_MONTH, :WK_DUE_DAY, 0 ,0, 0);
/*
         WK_RESULT = FILE_WRITELN(WK_FILENAME, cast(NEW.PICK_DUE_DATE as char(22))); 
         WK_RESULT = FILE_WRITELN(WK_FILENAME, 'end add pick_order time '); 
*/
      END
   END
   WK_DO_CHART = 'F';
   SELECT LEGACY_LEDGER_ACCOUNTS 
   FROM CONTROL
   INTO :WK_DO_CHART;
   IF (WK_DO_CHART IS NULL) THEN
   BEGIN
      WK_DO_CHART = 'F';
   END
   IF (WK_DO_CHART = 'T') THEN
   BEGIN
      IF ((NEW.LEGACY_LEDGER_ADMIN_FEE_CODE IS NULL) OR (NEW.LEGACY_LEDGER_ADMIN_FEE_CODE = '')) THEN
      BEGIN
         /* no admin fee account code so try ADMIN_FEE_CODE */
         /* WK_LEGACY_CODE = NEW.COMPANY_ID || '|%|ADMIN_FEE'; */
         WK_LEGACY_CODE = NEW.COMPANY_ID || '|ADMIN_FEE_CODE|%';
         WK_LEGACY_LEDGER_CODE = '';
         WK_FOUND = 0;
         FOR SELECT DESCRIPTION 
         FROM OPTIONS
         WHERE GROUP_CODE = 'CMPLGRCODE'
         AND CODE LIKE :WK_LEGACY_CODE 
         INTO :WK_LEGACY_LEDGER_CODE    
         DO
         BEGIN
            IF (WK_FOUND = 0) THEN
            BEGIN
               NEW.LEGACY_LEDGER_ADMIN_FEE_CODE = WK_LEGACY_LEDGER_CODE;
               WK_FOUND = 1;
            END
         END
      END
      IF ((NEW.LEGACY_LEDGER_ADMIN_FEE_CODE IS NULL) OR (NEW.LEGACY_LEDGER_ADMIN_FEE_CODE = '')) THEN
      BEGIN
         /* no admin fee account code so try ADMIN_FEE */
         /* WK_LEGACY_CODE = NEW.COMPANY_ID || '|%|ADMIN_FEE'; */
         WK_LEGACY_CODE = NEW.COMPANY_ID || '|ADMIN_FEE|%';
         WK_LEGACY_LEDGER_CODE = '';
         WK_FOUND = 0;
         FOR SELECT DESCRIPTION 
         FROM OPTIONS
         WHERE GROUP_CODE = 'CMPLGRCODE'
         AND CODE LIKE :WK_LEGACY_CODE 
         INTO :WK_LEGACY_LEDGER_CODE    
         DO
         BEGIN
            IF (WK_FOUND = 0) THEN
            BEGIN
               NEW.LEGACY_LEDGER_ADMIN_FEE_CODE = WK_LEGACY_LEDGER_CODE;
               WK_FOUND = 1;
            END
         END
      END
      IF ((NEW.LEGACY_LEDGER_FREIGHT_CODE IS NULL) OR (NEW.LEGACY_LEDGER_FREIGHT_CODE = '')) THEN
      BEGIN
         /* no freight account code */
         /* WK_LEGACY_CODE = NEW.COMPANY_ID || '|%|FREIGHT_CODE'; */
         WK_LEGACY_CODE = NEW.COMPANY_ID || '|FREIGHT_CODE|%';
         WK_LEGACY_LEDGER_CODE = '';
         WK_FOUND = 0;
         FOR SELECT DESCRIPTION 
         FROM OPTIONS
         WHERE GROUP_CODE = 'CMPLGRCODE'
         AND CODE LIKE :WK_LEGACY_CODE 
         INTO :WK_LEGACY_LEDGER_CODE    
         DO
         BEGIN
            IF (WK_FOUND = 0) THEN
            BEGIN
               NEW.LEGACY_LEDGER_FREIGHT_CODE = WK_LEGACY_LEDGER_CODE;
               WK_FOUND = 1;
            END
         END
      END
      IF ((NEW.LEGACY_LEDGER_DEPOSIT_CODE IS NULL) OR (NEW.LEGACY_LEDGER_DEPOSIT_CODE = '')) THEN
      BEGIN
         /* no freight account code */
         /* WK_LEGACY_CODE = NEW.COMPANY_ID || '|%|DEPOSIT_CODE'; */
         WK_LEGACY_CODE = NEW.COMPANY_ID || '|DEPOSIT_CODE|%';
         WK_LEGACY_LEDGER_CODE = '';
         WK_FOUND = 0;
         FOR SELECT DESCRIPTION 
         FROM OPTIONS
         WHERE GROUP_CODE = 'CMPLGRCODE'
         AND CODE LIKE :WK_LEGACY_CODE 
         INTO :WK_LEGACY_LEDGER_CODE    
         DO
         BEGIN
            IF (WK_FOUND = 0) THEN
            BEGIN
               NEW.LEGACY_LEDGER_DEPOSIT_CODE = WK_LEGACY_LEDGER_CODE;
               WK_FOUND = 1;
            END
         END
      END
   END
   IF ((NEW.PICK_STATUS IS NULL) OR (NEW.PICK_STATUS IN ('UC','CF','OP'))) THEN
   BEGIN
      /* now set the gst rate */
      WK_SO_COUNTRY = NEW.P_COUNTRY;
      WK_SO_TYPE = NEW.PICK_ORDER_TYPE;
      IF (WK_SO_COUNTRY IS NULL) THEN
      BEGIN
         WK_SO_COUNTRY = '';
      END
      WK_SO_COUNTRY = UPPER(WK_SO_COUNTRY);
      IF (WK_SO_TYPE IS NULL) THEN
      BEGIN
         WK_SO_TYPE = 'SO';
      END
      IF (WK_SO_COUNTRY = '' OR WK_SO_COUNTRY = 'AUSTRALIA' OR WK_SO_COUNTRY = 'AU') THEN
      BEGIN
         SELECT DEFAULT_GST_RATE 
         FROM CONTROL
         INTO :WK_CN_TAX_RATE;
         IF (WK_CN_TAX_RATE IS NULL) THEN
         BEGIN
            WK_CN_TAX_RATE = 0;
         END
         NEW.TAX_RATE = WK_CN_TAX_RATE;
      END
      ELSE
      BEGIN
         /* not au country */
         /* IF (NEW.TAX_RATE IS NULL) THEN */
            NEW.TAX_RATE = 0;
      END
      IF (WK_SO_TYPE = 'SO') THEN
      BEGIN
/*
        sub_total_tax = SELECT SUM(LINE_TOTAL * TAX_RATE / 100) FROM PICK_ITEM WHERE PICK_ORDER =  $orderNo;
        sub_total_amount = SELECT SUM(LINE_TOTAL ) FROM PICK_ITEM WHERE PICK_ORDER =  $orderNo;
        taxable_Amount = (FREIGHT + ((sub_Total_Amount + FREIGHT) * ADMIN_FEE_RATE/100) + ADMIN_FEE_AMOUNT + OTHER_NUM1 + OTHER_NUM2);
        tax_Amount = sub_Total_Tax + taxable_Amount * tax_Rate / 100;
        total = sub_Total_Amount + taxable_Amount + tax_Amount;
        due_Amount = total - AMOUNT_PAID;
        freight_Tax_Amount = FREIGHT * tax_Rate / 100;
*/
        SELECT SUM(COALESCE(LINE_TOTAL,0) * COALESCE(TAX_RATE,0) / 100),
               SUM(COALESCE(LINE_TOTAL,0) )
        FROM PICK_ITEM 
        WHERE PICK_ORDER = NEW.PICK_ORDER
        INTO NEW.SUB_TOTAL_TAX, NEW.SUB_TOTAL_AMOUNT;
        WK_SO_TAXABLE_AMOUNT = (COALESCE(NEW.FREIGHT,0) + ((COALESCE(NEW.SUB_TOTAL_AMOUNT,0) + COALESCE(NEW.FREIGHT,0)) * COALESCE(NEW.ADMIN_FEE_RATE,0)/100) + COALESCE(NEW.ADMIN_FEE_AMOUNT,0) + COALESCE(NEW.OTHER_NUM1,0) + COALESCE(NEW.OTHER_NUM2,0));
        NEW.TAX_AMOUNT = COALESCE(NEW.SUB_TOTAL_TAX,0) + COALESCE(WK_SO_TAXABLE_AMOUNT,0) * COALESCE(NEW.TAX_RATE,0) / 100;
        WK_SO_TOTAL = COALESCE(NEW.SUB_TOTAL_AMOUNT,0) + WK_SO_TAXABLE_AMOUNT + NEW.TAX_AMOUNT;
        NEW.DUE_AMOUNT = WK_SO_TOTAL - COALESCE(NEW.AMOUNT_PAID,0);
        NEW.FREIGHT_TAX_AMOUNT = COALESCE(NEW.FREIGHT,0) * COALESCE(NEW.TAX_RATE,0) / 100;
      END
   END

END ^

CREATE TRIGGER TG_ADD_PICK_ITEM_LINE_NO FOR PICK_ORDER 
ACTIVE AFTER INSERT POSITION 0 
AS
BEGIN
 IF (NEW.PICK_ORDER IS NOT NULL OR NEW.PICK_ORDER <> '') THEN
     EXECUTE PROCEDURE ADD_PICK_ITEM_LINE_NO(NEW.PICK_ORDER, 0); 
END ^

CREATE TRIGGER UPDATE_SALES_ORDER_COMPANY FOR PICK_ORDER 
ACTIVE BEFORE UPDATE POSITION 2 
AS
DECLARE VARIABLE WK_ORDER_COMPANY VARCHAR(20);
DECLARE VARIABLE WK_FOUND INTEGER;
DECLARE VARIABLE WK_TEST_COMPANY VARCHAR(20);
DECLARE VARIABLE WK_TEST_COMPANY2 VARCHAR(20);
DECLARE VARIABLE WK_TEST_STATUS CHAR(2);
DECLARE VARIABLE WK_NEW_STATUS CHAR(2);
BEGIN
   WK_ORDER_COMPANY = '';
   SELECT COMPANY_ID 
   FROM CONTROL
   INTO :WK_ORDER_COMPANY ;

   IF (NEW.COMPANY_ID IS NULL) THEN
   BEGIN
      NEW.COMPANY_ID = :WK_ORDER_COMPANY;
   END
   /* now check the company */
   WK_FOUND = 0;
   WK_TEST_COMPANY = NEW.COMPANY_ID;
   SELECT 1
   FROM COMPANY
   WHERE COMPANY_ID = :WK_TEST_COMPANY
   INTO :WK_FOUND;
   IF (WK_FOUND IS NULL) THEN
   BEGIN
      WK_FOUND = 0;
   END
   IF (WK_FOUND = 0) THEN
   BEGIN
      SELECT FIRST 1 1, COMPANY_ID
      FROM COMPANY
      WHERE NAME = :WK_TEST_COMPANY
      INTO :WK_FOUND, WK_TEST_COMPANY2;
      IF (WK_FOUND IS NULL) THEN
      BEGIN
         WK_FOUND = 0;
      END
      IF (WK_FOUND = 1) THEN
      BEGIN
         NEW.COMPANY_ID = WK_TEST_COMPANY2;
      END
   END
   IF (WK_FOUND = 0) THEN
   BEGIN
      NEW.COMPANY_ID = :WK_ORDER_COMPANY;
   END
   /* now if the order status has a replacement then use it */
   IF (NEW.PICK_STATUS IS NULL) THEN
   BEGIN
      NEW.PICK_STATUS='UC';
   END
   WK_FOUND = 0;
   WK_NEW_STATUS = '';
   WK_TEST_STATUS = NEW.PICK_STATUS;
   SELECT 1, DESCRIPTION
   FROM OPTIONS 
   WHERE GROUP_CODE = 'RPLPKSTATU' AND 
         CODE = :WK_TEST_STATUS
   INTO :WK_FOUND, :WK_NEW_STATUS;
   IF (WK_FOUND IS NULL) THEN
   BEGIN
      WK_FOUND = 0;
   END
   IF (WK_FOUND = 1) THEN
   BEGIN
      /* have a replacement status */
      NEW.PICK_STATUS = :WK_NEW_STATUS;
   END
END ^

CREATE TRIGGER UPDATE_WIP_ORDER_ORDERING FOR PICK_ORDER 
ACTIVE BEFORE UPDATE POSITION 5 
AS
DECLARE VARIABLE WK_ORDER_METHOD CHAR(4);
DECLARE VARIABLE WK_PRIORITY SMALLINT;
DECLARE VARIABLE TRANS_DATE TIMESTAMP;
DECLARE VARIABLE WK_DATE VARCHAR(20);
DECLARE VARIABLE WK_TIME VARCHAR(10);
DECLARE VARIABLE WK_REASON VARCHAR(255);
DECLARE VARIABLE WK_REASON2 VARCHAR(255);
DECLARE VARIABLE WK_REASON_ORIG VARCHAR(255);
DECLARE VARIABLE WK_PI_LABEL VARCHAR(7);
DECLARE VARIABLE WK_PI_STATUS CHAR(2);
DECLARE VARIABLE WK_CHECK_APPROVED CHAR(2);
BEGIN
   SELECT PICK_WIP_ORDER_METHOD, DEFAULT_PICK_PRIORITY, CHECK_APPROVED_LINES 
   FROM CONTROL
   INTO :WK_ORDER_METHOD, :WK_PRIORITY, :WK_CHECK_APPROVED;
   IF (NEW.PICK_PRIORITY IS NULL) THEN
   BEGIN
      NEW.PICK_PRIORITY = :WK_PRIORITY;
   END
   IF (NEW.PICK_PRIORITY = 0) THEN
   BEGIN
      NEW.PICK_PRIORITY = :WK_PRIORITY;
   END
   NEW.WIP_ORDERING = '~';
   IF (WK_ORDER_METHOD = 'ADP') THEN
   BEGIN
      IF (NEW.APPROVED_DESP_DATE IS NULL) THEN
      BEGIN
         IF (NEW.APPROVED_DATE IS NULL) THEN
         BEGIN
            NEW.WIP_ORDERING = '~';
         END
         ELSE
         BEGIN
            TRANS_DATE = NEW.APPROVED_DATE ;
/*
            WK_DATE = CAST(MER_YEAR(TRANS_DATE) AS CHAR(4)) || RTRIM(PADLEFT(MER_MONTH(TRANS_DATE),2)) || RTRIM(PADLEFT(MER_DAY(TRANS_DATE),2)) ;
            WK_TIME = RTRIM(PADLEFT(MER_HOUR(TRANS_DATE),2)) || RTRIM(PADLEFT(MER_MINUTE(TRANS_DATE),2)) ;
*/
            WK_DATE = MER_YEAR(TRANS_DATE)  || LPAD(MER_MONTH(TRANS_DATE),'0',2) || LPAD(MER_DAY(TRANS_DATE),'0',2) ;
            WK_TIME = LPAD(MER_HOUR(TRANS_DATE),'0',2) || LPAD(MER_MINUTE(TRANS_DATE),'0',2) ;
            WK_DATE = '}' || WK_DATE || ' ' || WK_TIME;
            NEW.WIP_ORDERING = :WK_DATE;
         END
      END
      ELSE
      BEGIN
         TRANS_DATE = NEW.APPROVED_DESP_DATE ;
/*
         WK_DATE = CAST(MER_YEAR(TRANS_DATE) AS CHAR(4)) || RTRIM(PADLEFT(MER_MONTH(TRANS_DATE),2)) || RTRIM(PADLEFT(MER_DAY(TRANS_DATE),2)) ;
         WK_TIME = RTRIM(PADLEFT(MER_HOUR(TRANS_DATE),2)) || RTRIM(PADLEFT(MER_MINUTE(TRANS_DATE),2)) ;
*/
         WK_DATE = MER_YEAR(TRANS_DATE)  || LPAD(MER_MONTH(TRANS_DATE),'0',2) || LPAD(MER_DAY(TRANS_DATE),'0',2) ;
         WK_TIME = LPAD(MER_HOUR(TRANS_DATE),'0',2) || LPAD(MER_MINUTE(TRANS_DATE),'0',2) ;
         WK_DATE = WK_DATE || ' ' || WK_TIME;
         NEW.WIP_ORDERING = :WK_DATE;
      END
   END
   IF (WK_CHECK_APPROVED = 'T') THEN
   BEGIN
      IF (OLD.APPROVED_DESP_DATE <> NEW.APPROVED_DESP_DATE) THEN
      BEGIN
      /* must check status of lines */
       FOR SELECT PICK_LINE_STATUS, PICK_LABEL_NO, SPECIAL_INSTRUCTIONS2
       FROM PICK_ITEM
       WHERE PICK_ORDER = NEW.PICK_ORDER
       INTO :WK_PI_STATUS, :WK_PI_LABEL, :WK_REASON_ORIG
       DO
       BEGIN
          IF (WK_REASON_ORIG IS NULL) THEN
          BEGIN
             WK_REASON_ORIG = '';
          END
          WK_REASON2 = '';
          IF (WK_PI_STATUS = 'OP') THEN
          BEGIN 
             WK_REASON2 = ' Open but Not Picked yet';
          END
          IF (WK_PI_STATUS = 'AL') THEN
          BEGIN 
             WK_REASON2 = ' Allocated but Not Picked yet';
          END
          IF (WK_PI_STATUS = 'PG') THEN
          BEGIN 
             WK_REASON2 = ' Pick in Progress but Not Picked yet';
          END
          IF (WK_PI_STATUS = 'PL') THEN
          BEGIN 
             WK_REASON2 = ' Picked to temporary Location but Not Picked yet';
          END
          IF (WK_REASON2 > '') THEN
          BEGIN
             IF (LEN(WK_REASON_ORIG) > 205) THEN
             BEGIN
                WK_REASON = RIGHTS( WK_REASON_ORIG, 205) || WK_REASON2;
             END
             ELSE
             BEGIN
                WK_REASON = WK_REASON_ORIG || WK_REASON2;
             END

             UPDATE PICK_ITEM SET SPECIAL_INSTRUCTIONS2 = :WK_REASON
             WHERE PICK_ORDER = NEW.PICK_ORDER
             AND PICK_LABEL_NO = :WK_PI_LABEL;
          END
       END
      END
   END
END ^

CREATE TRIGGER PICK_ORDER_ADDRESS_UPD FOR PICK_ORDER 
ACTIVE BEFORE UPDATE POSITION 10 
AS
/* Transfer of allocated replenish to another handheld */
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_ADDRESS1 VARCHAR(100);
DECLARE VARIABLE WK_ADDRESS2 VARCHAR(100);
DECLARE VARIABLE WK_PERSON VARCHAR(10);
DECLARE VARIABLE WK_FAX_NO VARCHAR(30);
DECLARE VARIABLE WK_INSTR2 VARCHAR(8196);
BEGIN
 WK_AUTORUN = GEN_ID(SO_ADDRESS2,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF ((NEW.P_ADDRESS_LINE2 IS NULL) AND (NEW.P_ADDRESS_LINE1 IS NOT NULL)) THEN
  BEGIN
     WK_ADDRESS2 = '.';
     NEW.P_ADDRESS_LINE2 = WK_ADDRESS2;
  END
  IF (NEW.P_ADDRESS_LINE2 = '') THEN
  BEGIN
     WK_ADDRESS2 = '.';
     NEW.P_ADDRESS_LINE2 = WK_ADDRESS2;
  END
 END
 WK_AUTORUN = GEN_ID(SO_INSTR2_FAX,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF ((NEW.PERSON_ID <> OLD.PERSON_ID) OR (OLD.PERSON_ID IS NULL)) THEN
  BEGIN
     WK_PERSON = NEW.PERSON_ID;
     SELECT FAX_NO 
     FROM PERSON 
     WHERE PERSON_ID = :WK_PERSON 
     INTO :WK_FAX_NO;
     IF (WK_FAX_NO IS NULL) THEN
     BEGIN
        WK_FAX_NO = 'None';
     END
     WK_INSTR2 = NEW.SPECIAL_INSTRUCTIONS1;
     IF (WK_INSTR2 IS NULL) THEN
     BEGIN
        WK_INSTR2 = '';
     END
     NEW.SPECIAL_INSTRUCTIONS1 = 'Fax ' || :WK_FAX_NO || :WK_INSTR2;
  END
 END
END ^

CREATE TRIGGER UPDATE_PICK_ORDER_TIME FOR PICK_ORDER 
ACTIVE BEFORE UPDATE POSITION 20 
AS
DECLARE VARIABLE WK_DUE_DATE TIMESTAMP;
DECLARE VARIABLE WK_DUE_YEAR INTEGER;
DECLARE VARIABLE WK_DUE_MONTH INTEGER;
DECLARE VARIABLE WK_DUE_DAY INTEGER;
DECLARE VARIABLE WK_FILENAME VARCHAR(255);
DECLARE VARIABLE WK_RESULT INTEGER;
DECLARE VARIABLE WK_SO_COUNTRY  VARCHAR(35);
DECLARE VARIABLE WK_SO_TYPE     VARCHAR(2);
DECLARE VARIABLE WK_CN_TAX_RATE DOUBLE PRECISION ;
DECLARE VARIABLE WK_SO_TAXABLE_AMOUNT DOUBLE PRECISION ;
DECLARE VARIABLE WK_SO_TOTAL DOUBLE PRECISION ;
DECLARE VARIABLE WK_SO_ADMIN_AMOUNT DOUBLE PRECISION ;
DECLARE VARIABLE WK_CHANGE_ORDER INTEGER;
BEGIN
   NEW.LAST_UPDATE_DATE = 'NOW';
   WK_FILENAME = '/tmp/upd_so_time.log';
   /* stop changing order no */
   WK_CHANGE_ORDER = GEN_ID(CHANGE_PICK_ORDER,0); 
   IF (WK_CHANGE_ORDER = 0) THEN
   BEGIN
      /* not allowed to change the orders order no */
      IF (NEW.PICK_ORDER <> OLD.PICK_ORDER) THEN
      BEGIN
         NEW.PICK_ORDER = OLD.PICK_ORDER;
      END
   END
   IF (NEW.PICK_DUE_DATE IS NOT NULL) THEN
   BEGIN
      WK_DUE_DATE = NEW.PICK_DUE_DATE;
      IF (ZEROTIME(WK_DUE_DATE) <> NEW.PICK_DUE_DATE) THEN
      BEGIN
         /* pick_due is a timestamp not a date */
         /* so use the next day */
         WK_DUE_YEAR = MER_YEAR(WK_DUE_DATE);
         WK_DUE_MONTH = MER_MONTH(WK_DUE_DATE);
         WK_DUE_DAY = MER_DAY(WK_DUE_DATE) + 1;
/*
         WK_RESULT = FILE_WRITELN(WK_FILENAME, 'start update pick_order time '); 
         WK_RESULT = FILE_WRITELN(WK_FILENAME, NEW.PICK_ORDER); 
         WK_RESULT = FILE_WRITELN(WK_FILENAME, cast(cast('NOW' as timestamp) as char(22))); 
         WK_RESULT = FILE_WRITELN(WK_FILENAME, cast(wk_due_date as char(22))); 
*/
         NEW.PICK_DUE_DATE = MAKEDATE(:WK_DUE_YEAR, :WK_DUE_MONTH, :WK_DUE_DAY, 0 ,0, 0);
/*
         WK_RESULT = FILE_WRITELN(WK_FILENAME, cast(NEW.PICK_DUE_DATE as char(22))); 
         WK_RESULT = FILE_WRITELN(WK_FILENAME, 'end update pick_order time '); 
*/
      END
   END

   /* IF ((NEW.PICK_STATUS IS NULL) OR (NEW.PICK_STATUS IN ('UC','CF','OP'))) THEN */
   BEGIN
      /* now set the gst rate */
      WK_SO_COUNTRY = NEW.P_COUNTRY;
      WK_SO_TYPE = NEW.PICK_ORDER_TYPE;
      IF (WK_SO_COUNTRY IS NULL) THEN
      BEGIN
         WK_SO_COUNTRY = '';
      END
      WK_SO_COUNTRY = UPPER(WK_SO_COUNTRY);
      IF (WK_SO_TYPE IS NULL) THEN
      BEGIN
         WK_SO_TYPE = 'SO';
      END
      IF (WK_SO_COUNTRY = '' OR WK_SO_COUNTRY = 'AUSTRALIA' OR WK_SO_COUNTRY = 'AU') THEN
      BEGIN
         SELECT DEFAULT_GST_RATE 
         FROM CONTROL
         INTO :WK_CN_TAX_RATE;
         IF (WK_CN_TAX_RATE IS NULL) THEN
         BEGIN
            WK_CN_TAX_RATE = 0;
         END
         NEW.TAX_RATE = WK_CN_TAX_RATE;
      END
      ELSE
      BEGIN
         /* not au country */
         /* IF (NEW.TAX_RATE IS NULL) THEN */
            NEW.TAX_RATE = 0;
      END
      IF (WK_SO_TYPE = 'SO') THEN
      BEGIN
/*
        sub_total_tax = SELECT SUM(LINE_TOTAL * TAX_RATE / 100) FROM PICK_ITEM WHERE PICK_ORDER =  $orderNo;
        sub_total_amount = SELECT SUM(LINE_TOTAL ) FROM PICK_ITEM WHERE PICK_ORDER =  $orderNo;
        taxable_Amount = (FREIGHT + ((sub_Total_Amount + FREIGHT) * ADMIN_FEE_RATE/100) + ADMIN_FEE_AMOUNT + OTHER_NUM1 + OTHER_NUM2);
        tax_Amount = sub_Total_Tax + taxable_Amount * tax_Rate / 100;
        total = sub_Total_Amount + taxable_Amount + tax_Amount;
        due_Amount = total - AMOUNT_PAID;
        freight_Tax_Amount = FREIGHT * tax_Rate / 100;
*/
        /*
        SELECT SUM(COALESCE(LINE_TOTAL,0) * COALESCE(TAX_RATE,0) / 100),
               SUM(COALESCE(LINE_TOTAL,0) )
        SELECT FLOOR(SUM(COALESCE(LINE_TOTAL,0) * COALESCE(TAX_RATE,0) / 100) * 100) / 100,
               FLOOR(SUM(COALESCE(LINE_TOTAL,0) ) * 100) / 100
        */
        SELECT ROUND(SUM(COALESCE(LINE_TOTAL,0) * COALESCE(TAX_RATE,0) / 100) , 2),
               ROUND(SUM(COALESCE(LINE_TOTAL,0) ), 2) 
        FROM PICK_ITEM 
        WHERE PICK_ORDER = NEW.PICK_ORDER
        INTO NEW.SUB_TOTAL_TAX, NEW.SUB_TOTAL_AMOUNT;
        /*
        WK_SO_TAXABLE_AMOUNT = (COALESCE(NEW.FREIGHT,0) + ((COALESCE(NEW.SUB_TOTAL_AMOUNT,0) + COALESCE(NEW.FREIGHT,0)) * COALESCE(NEW.ADMIN_FEE_RATE,0)/100) + COALESCE(NEW.ADMIN_FEE_AMOUNT,0) + COALESCE(NEW.OTHER_NUM1,0) + COALESCE(NEW.OTHER_NUM2,0));
	*/
        /* WK_SO_TAXABLE_AMOUNT = FLOOR((COALESCE(NEW.FREIGHT,0) + ((COALESCE(NEW.SUB_TOTAL_AMOUNT,0) + COALESCE(NEW.FREIGHT,0) +  COALESCE(NEW.SUB_TOTAL_TAX,0)) * COALESCE(NEW.ADMIN_FEE_RATE,0)/100) + COALESCE(NEW.ADMIN_FEE_AMOUNT,0) + COALESCE(NEW.OTHER_NUM1,0) + COALESCE(NEW.OTHER_NUM2,0)) * 100 ) / 100; */
        WK_SO_TAXABLE_AMOUNT = ROUND((COALESCE(NEW.FREIGHT,0) + ((COALESCE(NEW.SUB_TOTAL_AMOUNT,0) + COALESCE(NEW.FREIGHT,0) +  COALESCE(NEW.SUB_TOTAL_TAX,0)) * COALESCE(NEW.ADMIN_FEE_RATE,0)/100) + COALESCE(NEW.ADMIN_FEE_AMOUNT,0) + COALESCE(NEW.OTHER_NUM1,0) + COALESCE(NEW.OTHER_NUM2,0)), 2 ) ;
/* .v....1....v....2....v....3....v....4....v....5....v....6....v....7 */
	/* need either admin fee amount or admin fee rate - not both */
        IF (COALESCE(NEW.ADMIN_FEE_AMOUNT, 0) > 0) THEN
        BEGIN
           WK_SO_ADMIN_AMOUNT = COALESCE(NEW.ADMIN_FEE_AMOUNT,0);
        END
        ELSE
        BEGIN
           WK_SO_ADMIN_AMOUNT = ROUND(( ((COALESCE(NEW.SUB_TOTAL_AMOUNT,0) + COALESCE(NEW.FREIGHT,0) +  COALESCE(NEW.SUB_TOTAL_TAX,0)) * COALESCE(NEW.ADMIN_FEE_RATE,0)/100) ) , 2 ) ;
        END
        WK_SO_TAXABLE_AMOUNT = ROUND((COALESCE(NEW.FREIGHT,0) + WK_SO_ADMIN_AMOUNT + COALESCE(NEW.OTHER_NUM1,0) + COALESCE(NEW.OTHER_NUM2,0)), 2 ) ;

        /* NEW.TAX_AMOUNT = COALESCE(NEW.SUB_TOTAL_TAX,0) + COALESCE(WK_SO_TAXABLE_AMOUNT,0) * COALESCE(NEW.TAX_RATE,0) / 100; */
        /* NEW.TAX_AMOUNT = FLOOR( (COALESCE(NEW.SUB_TOTAL_TAX,0) + COALESCE(WK_SO_TAXABLE_AMOUNT,0) * COALESCE(NEW.TAX_RATE,0) / 100 ) * 100 ) / 100; */
        NEW.TAX_AMOUNT = ROUND( (COALESCE(NEW.SUB_TOTAL_TAX,0) + COALESCE(WK_SO_TAXABLE_AMOUNT,0) * COALESCE(NEW.TAX_RATE,0) / 100 ) , 2) ;
        /* WK_SO_TOTAL = COALESCE(NEW.SUB_TOTAL_AMOUNT,0) + WK_SO_TAXABLE_AMOUNT + NEW.TAX_AMOUNT; */
        WK_SO_TOTAL = ROUND(COALESCE(NEW.SUB_TOTAL_AMOUNT,0) + WK_SO_TAXABLE_AMOUNT + NEW.TAX_AMOUNT, 2);
        /* store wk_so_total and wk_so_taxable_amount , wk_so_admin_amount in order */
        /* NEW.DUE_AMOUNT = WK_SO_TOTAL - COALESCE(NEW.AMOUNT_PAID,0); */
        NEW.DUE_AMOUNT = ROUND( WK_SO_TOTAL - COALESCE(NEW.AMOUNT_PAID,0), 2);
        /* NEW.FREIGHT_TAX_AMOUNT = COALESCE(NEW.FREIGHT,0) * COALESCE(NEW.TAX_RATE,0) / 100; */
        /* NEW.FREIGHT_TAX_AMOUNT = FLOOR((COALESCE(NEW.FREIGHT,0) * COALESCE(NEW.TAX_RATE,0) / 100) * 100) / 100; */
        NEW.FREIGHT_TAX_AMOUNT = ROUND((COALESCE(NEW.FREIGHT,0) * COALESCE(NEW.TAX_RATE,0) / 100), 2) ;
      END
   END
END ^

CREATE TRIGGER SAVE_PICK_ORDER FOR PICK_ORDER 
INACTIVE BEFORE DELETE POSITION 0 
AS
BEGIN
   EXCEPTION NO_DELETE_SO;
END ^

CREATE TRIGGER ADD_PICK_FROM_TEMP FOR PICK_ORDER_ITEM_TEMP 
ACTIVE BEFORE INSERT POSITION 0 
AS
DECLARE VARIABLE WK_FOUND INTEGER;
DECLARE VARIABLE WK_H_PERSON_ID VARCHAR(10); 
DECLARE VARIABLE WK_P_PERSON_TYPE CHAR(2);
DECLARE VARIABLE WK_P_FIRST_NAME VARCHAR(50); 
DECLARE VARIABLE WK_P_LAST_NAME VARCHAR(50); 
DECLARE VARIABLE WK_P_ADDRESS_LINE1 VARCHAR(100); 
DECLARE VARIABLE WK_P_ADDRESS_LINE2 VARCHAR(50); 
DECLARE VARIABLE WK_P_ADDRESS_LINE3 VARCHAR(50); 
DECLARE VARIABLE WK_P_ADDRESS_LINE4 VARCHAR(50); 
DECLARE VARIABLE WK_P_ADDRESS_LINE5 VARCHAR(50); 
DECLARE VARIABLE WK_P_CITY VARCHAR(25); 
DECLARE VARIABLE WK_P_STATE VARCHAR(15); 
DECLARE VARIABLE WK_P_POST_CODE VARCHAR(10); 
DECLARE VARIABLE WK_P_COUNTRY VARCHAR(25);
DECLARE VARIABLE WK_P_AUST_POST_4STATE_ID VARCHAR(255);
DECLARE VARIABLE WK_P_NO_PERSON_UPD CHAR(1);
DECLARE VARIABLE WK_H_PICK_ORDER  VARCHAR(15);
DECLARE VARIABLE WK_H_PICK_ORDER_TYPE  CHAR(2);
DECLARE VARIABLE WK_H_CONTACT_NAME  VARCHAR(50);
DECLARE VARIABLE WK_H_CUSTOMER_PO_WO  VARCHAR(20);
DECLARE VARIABLE WK_H_COST_CENTER  VARCHAR(40);
DECLARE VARIABLE WK_H_COMPANY_ID  VARCHAR(20);
DECLARE VARIABLE WK_H_DIVISION_ID  VARCHAR(20);
DECLARE VARIABLE WK_H_PICK_PRIORITY  SMALLINT;
DECLARE VARIABLE WK_H_DELIVERY_RUN_NO  VARCHAR(10);
DECLARE VARIABLE WK_H_PICK_DUE_DATE  TIMESTAMP;
DECLARE VARIABLE WK_H_SPECIAL_INSTRUCTIONS1  VARCHAR(8196);
DECLARE VARIABLE WK_H_SPECIAL_INSTRUCTIONS2  VARCHAR(255);
DECLARE VARIABLE WK_H_INV_WITH_GOODS  CHAR(1);
DECLARE VARIABLE WK_H_SHIP_VIA  VARCHAR(10);
DECLARE VARIABLE WK_H_DESPATCH_LOCATION  VARCHAR(10);
DECLARE VARIABLE WK_H_CREATE_DATE  TIMESTAMP;
DECLARE VARIABLE WK_H_CREATED_BY  VARCHAR(10);
DECLARE VARIABLE WK_H_PICK_STARTED  TIMESTAMP;
DECLARE VARIABLE WK_H_PICK_STATUS  CHAR(2);
DECLARE VARIABLE WK_H_PARTIAL_PICK_ALLOWED  CHAR(1);
DECLARE VARIABLE WK_H_OTHER1  VARCHAR(50);
DECLARE VARIABLE WK_H_OTHER2  VARCHAR(50);
DECLARE VARIABLE WK_H_OTHER3  VARCHAR(50);
DECLARE VARIABLE WK_H_OTHER4  VARCHAR(50);
DECLARE VARIABLE WK_H_OTHER5  VARCHAR(50);
DECLARE VARIABLE WK_H_OTHER6  VARCHAR(50);
DECLARE VARIABLE WK_H_OTHER7  VARCHAR(50);
DECLARE VARIABLE WK_H_OTHER8  VARCHAR(50);
DECLARE VARIABLE WK_H_OTHER9  VARCHAR(50);
DECLARE VARIABLE WK_H_OTHERNUM1  NUMERIC(9,2);
DECLARE VARIABLE WK_H_OTHERNUM2  NUMERIC(9,2);
DECLARE VARIABLE WK_H_REMARK1 VARCHAR(75); 
DECLARE VARIABLE WK_H_REMARK2 VARCHAR(75); 
DECLARE VARIABLE WK_H_REMARK3 VARCHAR(75); 
DECLARE VARIABLE WK_H_REMARK4 VARCHAR(75); 
DECLARE VARIABLE WK_H_REMARK5 VARCHAR(75); 
DECLARE VARIABLE WK_H_REMARK6 VARCHAR(75); 
DECLARE VARIABLE WK_H_FOOTER1 VARCHAR(75); 
DECLARE VARIABLE WK_H_FOOTER2 VARCHAR(75); 
DECLARE VARIABLE WK_H_FOOTER3 VARCHAR(75); 
DECLARE VARIABLE WK_H_FOOTER4 VARCHAR(75); 
DECLARE VARIABLE WK_H_FOOTER5 VARCHAR(75); 
DECLARE VARIABLE WK_L_PICK_LABEL_NO  VARCHAR(7);
DECLARE VARIABLE WK_L_PICK_ORDER  VARCHAR(15);
DECLARE VARIABLE WK_L_PICK_ORDER_LINE_NO  CHAR(4);
DECLARE VARIABLE WK_L_CONTACT_NAME  VARCHAR(50);
DECLARE VARIABLE WK_L_PROD_ID  VARCHAR(30);
DECLARE VARIABLE WK_L_SSN_ID  VARCHAR(20);
DECLARE VARIABLE WK_L_WARRANTY_TERM  VARCHAR(50);
DECLARE VARIABLE WK_L_PICK_LABEL_DATE  TIMESTAMP;
DECLARE VARIABLE WK_L_SPECIAL_INSTRUCTIONS1  VARCHAR(8196);
DECLARE VARIABLE WK_L_SPECIAL_INSTRUCTIONS2  VARCHAR(255);
DECLARE VARIABLE WK_L_SPECIAL_INSTRUCTIONS3  VARCHAR(255);
DECLARE VARIABLE WK_L_SHIP_VIA  VARCHAR(10);
DECLARE VARIABLE WK_L_PICK_ORDER_QTY  INTEGER;
DECLARE VARIABLE WK_L_PICK_ALLOCATED_QTY  INTEGER;
DECLARE VARIABLE WK_L_PICKED_QTY  INTEGER;
DECLARE VARIABLE WK_L_PICK_LINE_DUE_DATE  TIMESTAMP;
DECLARE VARIABLE WK_L_PICK_STARTED  TIMESTAMP;
DECLARE VARIABLE WK_L_DESPATCH_TS  TIMESTAMP;
DECLARE VARIABLE WK_L_DESPATCH_LOCATION  VARCHAR(10);
DECLARE VARIABLE WK_L_CREATE_DATE  TIMESTAMP;
DECLARE VARIABLE WK_L_USER_ID  VARCHAR(10);
DECLARE VARIABLE WK_L_DEVICE_ID  CHAR(2);
DECLARE VARIABLE WK_L_CHECKIN_START  TIMESTAMP;
DECLARE VARIABLE WK_L_CHECKIN_FINISH  TIMESTAMP;
DECLARE VARIABLE WK_L_CHECKIN_USER_ID  VARCHAR(10);
DECLARE VARIABLE WK_L_PICK_LINE_STATUS  CHAR(2);
DECLARE VARIABLE WK_L_PARTIAL_PICK_ALLOWED  CHAR(1);
DECLARE VARIABLE WK_L_SALE_PRICE  NUMERIC(9,3);
DECLARE VARIABLE WK_L_OTHER1  VARCHAR(50);
DECLARE VARIABLE WK_L_OTHER2  VARCHAR(50);
DECLARE VARIABLE WK_L_OTHER3  VARCHAR(50);
DECLARE VARIABLE WK_L_OTHER4  VARCHAR(50);
DECLARE VARIABLE WK_L_OTHER5  VARCHAR(50);
DECLARE VARIABLE WK_L_OTHER6  VARCHAR(50);
DECLARE VARIABLE WK_L_OTHER7  VARCHAR(50);
DECLARE VARIABLE WK_L_OTHER8  VARCHAR(50);
DECLARE VARIABLE WK_L_OTHER9  VARCHAR(50);
DECLARE VARIABLE WK_L_OTHERQTY1  INTEGER;
DECLARE VARIABLE WK_LEN_LABEL_NO INTEGER;
DECLARE VARIABLE WK_PROD_LENGTH INTEGER;
DECLARE VARIABLE WK_L_WH_ID CHAR(2);
DECLARE VARIABLE WK_L_LOCN_ID VARCHAR(10);
DECLARE VARIABLE WK_L_BATCH_LINE  INTEGER;
DECLARE VARIABLE WK_L_ALT_WH_ID CHAR(2);
DECLARE VARIABLE WK_L_ALT_LOCN_ID VARCHAR(10);
DECLARE VARIABLE WK_CURRENT_STATUS  CHAR(2);
DECLARE VARIABLE WK_CURRENT_LINE_DUE_DATE  TIMESTAMP;
DECLARE VARIABLE WK_PICK_STATUS  CHAR(2);
DECLARE VARIABLE WK_PICK_ORDER_STATUS  CHAR(2);
DECLARE VARIABLE WK_PI_STATUS  CHAR(2);
DECLARE VARIABLE WK_DOORDER  CHAR(1);
DECLARE VARIABLE WK_DOITEM  CHAR(1);
DECLARE VARIABLE WK_PICK_SSN_ALLOWED VARCHAR(40);
DECLARE VARIABLE WK_TEST_STATUS VARCHAR(4);
DECLARE VARIABLE WK_SSN_OWNER  CHAR(1);
DECLARE VARIABLE WK_ALLOW_SSN_SUBSTITUTE  CHAR(1);
DECLARE VARIABLE WK_L_RETURN_DATE  TIMESTAMP;
DECLARE VARIABLE WK_H_RETURN_DATE  TIMESTAMP;
DECLARE VARIABLE WK_PROD_FIXED  CHAR(1);
DECLARE VARIABLE WK_PROD_STOCK  CHAR(1);
DECLARE VARIABLE WK_PICK_LABEL  VARCHAR(8);
DECLARE VARIABLE WK_L_TAX_RATE  DOUBLE PRECISION;
DECLARE VARIABLE WK_L_TAX_AMOUNT  NUMERIC(9,2);
DECLARE VARIABLE WK_H_FREIGHT  NUMERIC(9,2);
DECLARE VARIABLE WK_H_AMOUNT_PAID  NUMERIC(9,2);
DECLARE VARIABLE WK_L_DISCOUNT DOUBLE PRECISION;
DECLARE VARIABLE WK_L_LINE_TOTAL  NUMERIC(9,2);
DECLARE VARIABLE WK_H_TERMS  VARCHAR(20);
DECLARE VARIABLE WK_H_PAYMENT_METHOD  VARCHAR(40);
DECLARE VARIABLE WK_H_FREIGHT_TAX_AMOUNT  NUMERIC(9,2);
DECLARE VARIABLE WK_H_TAX_RATE  DOUBLE PRECISION;
DECLARE VARIABLE WK_L_CALC_ZONE_LOCN  CHAR(1);
DECLARE VARIABLE WK_L_OVER_SIZED  CHAR(1);
DECLARE VARIABLE WK_PP_EXPORT_CATEGORY CHAR(1);
DECLARE VARIABLE WK_STATE VARCHAR(15); 
DECLARE VARIABLE WK_H_WH_ID  CHAR(2);
DECLARE VARIABLE WK_USE_PERSON_IDS  VARCHAR(10);
DECLARE VARIABLE WK_L_KIT_PARTS  VARCHAR(10);
DECLARE VARIABLE WK_L_PROD_KITTED  CHAR(1);
DECLARE VARIABLE WK_L_ORIGINAL_PICK_ORDER_QTY INTEGER;
DECLARE VARIABLE WK_L_ORIGINAL_PROD_ID        VARCHAR(30);
DECLARE VARIABLE WK_L_ORIGINAL_PICK_STATUS    VARCHAR(2);
DECLARE VARIABLE WK_PK_PROD_ID                VARCHAR(30);
DECLARE VARIABLE WK_PK_PROD_QTY               INTEGER;
DECLARE VARIABLE WK_L_NO_PICK_LINE_NO         VARCHAR(10);
DECLARE VARIABLE WK_LOG_FILENAME         VARCHAR(80);
DECLARE VARIABLE WK_RESULT               INTEGER;
DECLARE VARIABLE WK_L_EXPORTED_DESPATCH       VARCHAR(1);
DECLARE VARIABLE WK_PID_FOUND                 INTEGER;
DECLARE VARIABLE WK_PID_DETAIL_ID             INTEGER;
DECLARE VARIABLE WK_CNTRL_DEFAULT_PRIORITY    SMALLINT;
DECLARE VARIABLE WK_CNTRL_REIMPORT_BY_PRIORITY CHAR(1) ;
DECLARE VARIABLE WK_PICK_ORDER_PRIORITY       SMALLINT;
DECLARE VARIABLE WK_PICK_ORDER_STARTED        TIMESTAMP;
DECLARE VARIABLE WK_PROD_AVAILABLE_QTY        INTEGER;
BEGIN
   BEGIN
      NEW.RECORD_ID  = GEN_ID(TEMP_ID_GEN ,1);
   END
   WK_LOG_FILENAME = '/tmp/salesimport.log';
   WK_PICK_STATUS = '';
   WK_H_PERSON_ID  = NEW.H_PERSON_ID;
   WK_P_PERSON_TYPE = NEW.P_PERSON_TYPE;
   WK_P_FIRST_NAME = NEW.P_FIRST_NAME;
   WK_P_LAST_NAME = NEW.P_LAST_NAME;
   WK_P_ADDRESS_LINE1 = NEW.P_ADDRESS_LINE1;
   WK_P_ADDRESS_LINE2 = NEW.P_ADDRESS_LINE2;
   WK_P_ADDRESS_LINE3 = NEW.P_ADDRESS_LINE3;
   WK_P_ADDRESS_LINE4 = NEW.P_ADDRESS_LINE4;
   WK_P_ADDRESS_LINE5 = NEW.P_ADDRESS_LINE5;
   WK_P_CITY = NEW.P_CITY;
   WK_P_STATE = NEW.P_STATE;
   WK_P_POST_CODE = NEW.P_POST_CODE;
   WK_P_COUNTRY = NEW.P_COUNTRY;
   WK_P_AUST_POST_4STATE_ID = NEW.P_AUST_POST_4STATE_ID;
   WK_P_NO_PERSON_UPD = NEW.P_NO_PERSON_UPD;
   IF (NEW.P_NO_PERSON_UPD IS NULL) THEN
   BEGIN
      WK_P_NO_PERSON_UPD = 'F';
   END
   /* if set sitewise to stop populating the person */
   SELECT DESCRIPTION
   FROM OPTIONS
   WHERE GROUP_CODE = 'REP_CODE'
   AND   CODE = 'PICK_ORDER_ITEM_TEMP.P_NO_PERSON_UPD'
   INTO :WK_USE_PERSON_IDS;
   IF (WK_USE_PERSON_IDS IS NOT NULL) THEN
   BEGIN
      WK_P_NO_PERSON_UPD = WK_USE_PERSON_IDS;
   END
   /* if set sitewise to turn kits into their parts */
   WK_L_KIT_PARTS = 'F';
   SELECT DESCRIPTION
   FROM OPTIONS
   WHERE GROUP_CODE = 'REP_CODE'
   AND   CODE = 'PICK_ORDER_ITEM_TEMP.L_KIT_PARTS'
   INTO :WK_USE_PERSON_IDS;
   IF (WK_USE_PERSON_IDS IS NOT NULL) THEN
   BEGIN
      WK_L_KIT_PARTS = WK_USE_PERSON_IDS;
   END
   /* if set sitewise to not ket the pick_item by the line no */
   WK_L_NO_PICK_LINE_NO = 'F';
   SELECT DESCRIPTION
   FROM OPTIONS
   WHERE GROUP_CODE = 'REP_CODE'
   AND   CODE = 'PICK_ORDER_ITEM_TEMP.L_NO_PICK_LINE_NO'
   INTO :WK_USE_PERSON_IDS;
   IF (WK_USE_PERSON_IDS IS NOT NULL) THEN
   BEGIN
      WK_L_NO_PICK_LINE_NO = WK_USE_PERSON_IDS;
   END

   WK_H_PICK_ORDER = NEW.H_PICK_ORDER;
   WK_H_PICK_ORDER_TYPE = NEW.H_PICK_ORDER_TYPE;
   IF (WK_H_PICK_ORDER_TYPE IS NULL) THEN
   BEGIN
      WK_H_PICK_ORDER_TYPE = '';
   END
   WK_H_CONTACT_NAME = NEW.H_CONTACT_NAME;
   WK_H_CUSTOMER_PO_WO = NEW.H_CUSTOMER_PO_WO;
   WK_H_COST_CENTER = NEW.H_COST_CENTER;
   WK_H_COMPANY_ID = NEW.H_COMPANY_ID;
   WK_H_DIVISION_ID = NEW.H_DIVISION_ID;
   WK_H_PICK_PRIORITY = NEW.H_PICK_PRIORITY;
   WK_H_DELIVERY_RUN_NO = NEW.H_DELIVERY_RUN_NO;
   WK_H_PICK_DUE_DATE = NEW.H_PICK_DUE_DATE;
   WK_H_SPECIAL_INSTRUCTIONS1 = NEW.H_SPECIAL_INSTRUCTIONS1;
   WK_H_SPECIAL_INSTRUCTIONS2 = NEW.H_SPECIAL_INSTRUCTIONS2;
   WK_H_INV_WITH_GOODS = NEW.H_INV_WITH_GOODS;
   WK_H_SHIP_VIA = NEW.H_SHIP_VIA;
   WK_H_DESPATCH_LOCATION = NEW.H_DESPATCH_LOCATION;
   WK_H_CREATE_DATE = NEW.H_CREATE_DATE;
   WK_H_CREATED_BY = NEW.H_CREATED_BY;
   WK_H_PICK_STARTED = NEW.H_PICK_STARTED;
   WK_H_PICK_STATUS = NEW.H_PICK_STATUS;
   IF (NEW.H_PICK_STATUS IS NULL) THEN 
   BEGIN
     WK_H_PICK_STATUS = 'CF';
   END
   ELSE BEGIN
     WK_H_PICK_STATUS = NEW.H_PICK_STATUS;
   END
   IF (NEW.H_PICK_STATUS = 'P') THEN
   BEGIN
     WK_H_PICK_STATUS = 'DA';
   END
   WK_H_OTHER1 = NEW.H_OTHER1;
   WK_H_OTHER2 = NEW.H_OTHER2;
   WK_H_OTHER3 = NEW.H_OTHER3;
   WK_H_OTHER4 = NEW.H_OTHER4;
   WK_H_OTHER5 = NEW.H_OTHER5;
   WK_H_OTHER6 = NEW.H_OTHER6;
   WK_H_OTHER7 = NEW.H_OTHER7;
   WK_H_OTHER8 = NEW.H_OTHER8;
   WK_H_OTHER9 = NEW.H_OTHER9;
   WK_H_PARTIAL_PICK_ALLOWED = NEW.H_PARTIAL_PICK_ALLOWED;
   WK_H_FREIGHT = NEW.H_FREIGHT;
   IF (WK_H_FREIGHT IS NULL) THEN
   BEGIN
      WK_H_FREIGHT = 0;
      WK_H_FREIGHT_TAX_AMOUNT = 0;
   END
   WK_H_AMOUNT_PAID = NEW.H_AMOUNT_PAID;
   IF (WK_H_AMOUNT_PAID IS NULL) THEN
   BEGIN
      WK_H_AMOUNT_PAID = 0;
   END
   WK_H_OTHERNUM1 = NEW.H_OTHER_NUM1;
   WK_H_OTHERNUM2 = NEW.H_OTHER_NUM2;
   WK_H_REMARK1 = NEW.H_REMARKS1;
   WK_H_REMARK2 = NEW.H_REMARKS2;
   WK_H_REMARK3 = NEW.H_REMARKS3;
   WK_H_REMARK4 = NEW.H_REMARKS4;
   WK_H_REMARK5 = NEW.H_REMARKS5;
   WK_H_REMARK6 = NEW.H_REMARKS6;
   WK_H_FOOTER1 = NEW.H_FOOTER1;
   WK_H_FOOTER2 = NEW.H_FOOTER2;
   WK_H_FOOTER3 = NEW.H_FOOTER3;
   WK_H_FOOTER4 = NEW.H_FOOTER4;
   WK_H_FOOTER5 = NEW.H_FOOTER5;
   WK_H_WH_ID = NEW.H_WH_ID;
   /* check for state replacement */
   IF (WK_P_STATE IS NOT NULL) THEN
   BEGIN
      WK_STATE = '';
      SELECT DESCRIPTION FROM OPTIONS
      WHERE GROUP_CODE = 'STATE_CODE'
      AND CODE = :WK_P_STATE
      INTO :WK_STATE;
      IF (WK_STATE IS NULL) THEN
      BEGIN
         WK_STATE = '';
      END
      IF (WK_STATE = '') THEN
      BEGIN
         WK_FOUND = 0;
      END
      ELSE
      BEGIN
         WK_P_STATE = WK_STATE;
      END
   END
   IF (WK_H_WH_ID IS NULL) THEN
   BEGIN
      SELECT DEFAULT_WH_ID 
      FROM CONTROL 
      INTO :WK_H_WH_ID;
   END
   IF (WK_H_PICK_DUE_DATE IS NULL) THEN
   BEGIN
      WK_H_PICK_DUE_DATE = 'NOW';
   END
   IF (WK_H_CREATED_BY IS NULL) THEN
   BEGIN
      WK_H_CREATED_BY = 'BDCS';
   END
   /* have to check that the ship via is valid */
   WK_FOUND = 0;
   SELECT 1
   FROM CARRIER
   WHERE CARRIER_ID = :WK_H_SHIP_VIA
   INTO :WK_FOUND;
   IF (WK_FOUND IS NULL) THEN
   BEGIN
      WK_FOUND = 0;
   END
   IF (WK_FOUND = 0) THEN
   BEGIN
      SELECT DEFAULT_CARRIER_ID
      FROM CONTROL
      INTO :WK_H_SHIP_VIA;
   END
   WK_L_PICK_LABEL_NO = 'NULL' ;
   WK_L_PICK_ORDER = NEW.H_PICK_ORDER ;
   WK_L_PICK_ORDER_LINE_NO = NEW.L_PICK_ORDER_LINE_NO ;
   IF (WK_L_NO_PICK_LINE_NO = 'T' ) THEN
   BEGIN
      WK_L_PICK_ORDER_LINE_NO = NULL ;
   END
   WK_L_CONTACT_NAME = NEW.L_CONTACT_NAME ;
   WK_L_PROD_ID = NEW.L_PROD_ID ;
   WK_L_SSN_ID = NEW.L_SSN_ID ;
   WK_L_WARRANTY_TERM = NEW.L_WARRANTY_TERM ;
   IF (WK_L_WARRANTY_TERM IS NULL) THEN
   BEGIN
      SELECT DEFAULT_WARRANTY
      FROM CONTROL
      INTO :WK_L_WARRANTY_TERM;
   END
   SELECT PICK_IMPORT_CALC_ZONE_LOCN
   FROM CONTROL
   INTO :WK_L_CALC_ZONE_LOCN;
   IF (WK_L_CALC_ZONE_LOCN IS NULL) THEN
   BEGIN
      WK_L_CALC_ZONE_LOCN = 'F';
   END
   WK_L_PICK_LABEL_DATE = NEW.L_PICK_LABEL_DATE ;
   WK_L_SPECIAL_INSTRUCTIONS1 = NEW.L_SPECIAL_INSTRUCTIONS1 ;
   WK_L_SPECIAL_INSTRUCTIONS2 = NEW.L_SPECIAL_INSTRUCTIONS2 ;
   WK_L_SPECIAL_INSTRUCTIONS3 = NEW.L_SPECIAL_INSTRUCTIONS3;
   WK_L_SHIP_VIA = NEW.L_SHIP_VIA ;
   WK_L_PICK_ORDER_QTY = NEW.L_PICK_ORDER_QTY ;
   WK_L_PICK_ALLOCATED_QTY = NEW.L_PICK_ALLOCATED_QTY ;
   WK_L_PICKED_QTY = NEW.L_PICKED_QTY ;
   WK_L_PICK_LINE_DUE_DATE = NEW.L_PICK_LINE_DUE_DATE ;
   WK_L_PICK_STARTED = NEW.L_PICK_STARTED ;
   WK_L_DESPATCH_TS = NEW.L_DESPATCH_TS ;
   WK_L_DESPATCH_LOCATION = NEW.L_DESPATCH_LOCATION ;
   WK_L_CREATE_DATE = NEW.L_CREATE_DATE ;
   WK_L_USER_ID = NEW.L_USER_ID ;
   WK_L_DEVICE_ID = NEW.L_DEVICE_ID ;
   WK_L_CHECKIN_START = NEW.L_CHECKIN_START ;
   WK_L_CHECKIN_FINISH = NEW.L_CHECKIN_FINISH ;
   WK_L_CHECKIN_USER_ID = NEW.L_CHECKIN_USER_ID ;
   WK_L_BATCH_LINE = NEW.L_BATCH_LINE ;
   IF (NEW.L_ALLOW_SSN_SUBSTITUTE IS NULL) THEN
   BEGIN
      SELECT ALLOW_SSN_SUBSTITUTE_DEFAULT  FROM CONTROL
         INTO :WK_ALLOW_SSN_SUBSTITUTE ;
   END
   ELSE
   BEGIN
      WK_ALLOW_SSN_SUBSTITUTE = NEW.L_ALLOW_SSN_SUBSTITUTE;
   END
   WK_L_RETURN_DATE = NEW.L_RETURN_DATE;
   WK_H_RETURN_DATE = NEW.H_RETURN_DATE;
   WK_L_OTHER1 = NEW.L_OTHER1;
   WK_L_OTHER2 = NEW.L_OTHER2;
   WK_L_OTHER3 = NEW.L_OTHER3;
   WK_L_OTHER4 = NEW.L_OTHER4;
   WK_L_OTHER5 = NEW.L_OTHER5;
   WK_L_OTHER6 = NEW.L_OTHER6;
   WK_L_OTHER7 = NEW.L_OTHER7;
   WK_L_OTHER8 = NEW.L_OTHER8;
   WK_L_OTHER9 = NEW.L_OTHER9;
   WK_L_OTHERQTY1 = NEW.L_OTHER_QTY1;
   WK_L_ALT_WH_ID = '';
   WK_L_ALT_LOCN_ID = '';
   WK_H_TERMS = NEW.H_TERMS;
   IF (NEW.H_TERMS IS NULL) THEN
   BEGIN
      WK_H_TERMS = '' ;
   END
   WK_H_PAYMENT_METHOD = NEW.H_PAYMENT_METHOD;
   IF (NEW.H_PAYMENT_METHOD IS NULL) THEN
   BEGIN
      WK_H_PAYMENT_METHOD = '' ;
   END
   IF (NEW.L_PICK_LINE_STATUS IS NULL) THEN
   BEGIN
      WK_L_PICK_LINE_STATUS = 'OP' ;
      NEW.L_PICK_LINE_STATUS  = 'OP';
   END
   ELSE
   BEGIN
      IF (NEW.L_PICK_LINE_STATUS = '  ') THEN
      BEGIN
         WK_L_PICK_LINE_STATUS = 'OP' ;
      END
      ELSE
      BEGIN
         WK_L_PICK_LINE_STATUS = NEW.L_PICK_LINE_STATUS ; 
      END
   END
   /* is this a kitted product */
   WK_L_PROD_KITTED = 'F';
   IF (WK_L_PROD_ID IS NOT NULL) THEN
   BEGIN
      WK_FOUND = 0;
      SELECT FIRST 1 1
      FROM PRODUCT_KIT
      WHERE KIT_ID = :WK_L_PROD_ID
      AND PRODUCT_KIT.STATUS = 'OP'
      INTO :WK_FOUND;
      IF (WK_FOUND IS NULL) THEN
      BEGIN
         WK_FOUND = 0;
      END
      IF (WK_FOUND = 1) THEN
      BEGIN
         WK_L_PROD_KITTED = 'T';
         WK_L_ORIGINAL_PICK_STATUS = WK_L_PICK_LINE_STATUS;
         WK_L_PICK_LINE_STATUS = 'DX';
         WK_L_PICKED_QTY = WK_L_PICK_ORDER_QTY;
      END
   END

   WK_L_PARTIAL_PICK_ALLOWED = NEW.L_PARTIAL_PICK_ALLOWED ;
   WK_L_SALE_PRICE = NEW.L_SALE_PRICE ;
   WK_L_DISCOUNT = 0.0;
   WK_L_LINE_TOTAL = WK_L_SALE_PRICE * WK_L_PICK_ORDER_QTY * (1.0 - WK_L_DISCOUNT / 100.0);
   WK_L_TAX_RATE = NEW.L_TAX_RATE ;
   WK_L_TAX_AMOUNT = WK_L_TAX_RATE * WK_L_LINE_TOTAL / 100;
   IF (WK_H_SHIP_VIA = '') THEN
   BEGIN
      /* 1st try companys ship via */
      SELECT  DESCRIPTION
      FROM OPTIONS
      WHERE GROUP_CODE = 'CMPSHIPVIA'
      AND CODE = :WK_H_COMPANY_ID
      INTO :WK_H_SHIP_VIA;
      IF ((WK_H_SHIP_VIA IS NULL) OR (WK_H_SHIP_VIA = '')) THEN
      BEGIN
         /* 2nd try system ship via */
         SELECT DEFAULT_CARRIER_ID 
         FROM CONTROL
         INTO :WK_H_SHIP_VIA;
      END
   END
   IF (WK_H_TERMS = '') THEN
   BEGIN
      /* try system terms */
      SELECT DEFAULT_TERM 
      FROM CONTROL
      INTO :WK_H_TERMS;
   END
   IF (WK_H_PAYMENT_METHOD = '') THEN
   BEGIN
      /* try system payment */
      SELECT DEFAULT_PAYMENT_METHOD 
      FROM CONTROL
      INTO :WK_H_PAYMENT_METHOD;
   END
   IF (LEN(WK_H_PAYMENT_METHOD) > 20) THEN
   BEGIN
      WK_H_PAYMENT_METHOD = RIGHTS(WK_H_PAYMENT_METHOD,20);
   END
   BEGIN
      /* get default gst */
      SELECT DEFAULT_GST_RATE 
      FROM CONTROL
      INTO :WK_H_TAX_RATE;
      WK_H_FREIGHT_TAX_AMOUNT = WK_H_FREIGHT * WK_H_TAX_RATE / 100.0;
   END
   BEGIN
      /* get default priority */
      SELECT DEFAULT_PICK_PRIORITY, REIMPORT_PICK_BY_PRIORITY 
      FROM CONTROL
      INTO :WK_CNTRL_DEFAULT_PRIORITY, :WK_CNTRL_REIMPORT_BY_PRIORITY;
      IF (WK_CNTRL_REIMPORT_BY_PRIORITY IS NULL) THEN
      BEGIN
         WK_CNTRL_REIMPORT_BY_PRIORITY = 'F';
      END
   END
   /* CHECK PICK_ORDER */
   WK_DOORDER = '0'   ;
   WK_PICK_ORDER_STATUS = '';
   WK_FOUND = 0;
   SELECT 1,PICK_STATUS, PICK_STARTED, PICK_PRIORITY FROM PICK_ORDER
      WHERE PICK_ORDER = :WK_H_PICK_ORDER
      INTO :WK_FOUND, :WK_PICK_ORDER_STATUS, :WK_PICK_ORDER_STARTED, :WK_PICK_ORDER_PRIORITY;
   IF (WK_FOUND = 0) THEN
   BEGIN
      /* is ok to add */
      WK_DOORDER = '1'   ;
   END
   ELSE
   BEGIN
      IF (WK_PICK_ORDER_STATUS = 'DA') THEN
      BEGIN
         WK_DOORDER = '1';
      END
      IF (WK_PICK_ORDER_STATUS = 'OP') THEN
      BEGIN
         WK_DOORDER = '1';
      END
      IF (WK_PICK_ORDER_STATUS = 'CF') THEN
      BEGIN
         WK_DOORDER = '1';
      END
      IF (WK_PICK_ORDER_STATUS = 'UC') THEN
      BEGIN
         WK_DOORDER = '1';
      END
      IF (WK_PICK_ORDER_STATUS IS NULL) THEN
      BEGIN
         WK_DOORDER = '1';
      END
      IF (WK_PICK_ORDER_STARTED IS NOT NULL) THEN
      BEGIN
         WK_DOORDER = '0';
      END
      IF (WK_CNTRL_REIMPORT_BY_PRIORITY = 'T') THEN
      BEGIN
         /* if orders current priority is null or the default then allow update */
         IF ((WK_PICK_ORDER_PRIORITY IS NOT NULL) AND (WK_PICK_ORDER_PRIORITY <> WK_CNTRL_DEFAULT_PRIORITY)) THEN
         BEGIN
            WK_DOORDER = '0';
         END
      END
   END
   WK_DOITEM = '0'   ;
   /* CHECK PERSON */
   /* IF (WK_P_NO_PERSON_UPD = 'F') THEN */
   IF ((WK_P_NO_PERSON_UPD = 'F') AND (WK_DOORDER = '1')) THEN
   BEGIN
      WK_FOUND = 0;
      SELECT 1 FROM PERSON 
         WHERE PERSON_ID = :WK_H_PERSON_ID
         INTO :WK_FOUND;
      IF (WK_FOUND = 0) THEN
      BEGIN
         /* NO PERSON SO INSERT IT */
         INSERT INTO PERSON (PERSON_ID, 
            PERSON_TYPE, 
            FIRST_NAME, 
            LAST_NAME, 
            ADDRESS_LINE1, 
            ADDRESS_LINE2, 
            ADDRESS_LINE3, 
            ADDRESS_LINE4, 
            ADDRESS_LINE5, 
            CITY, 
            STATE, 
            POST_CODE, 
            COUNTRY,
            AUST_POST_4STATE_ID)
         VALUES (:WK_H_PERSON_ID, 
            :WK_P_PERSON_TYPE, 
            :WK_P_FIRST_NAME, 
            :WK_P_LAST_NAME, 
            :WK_P_ADDRESS_LINE1, 
            :WK_P_ADDRESS_LINE2, 
            :WK_P_ADDRESS_LINE3, 
            :WK_P_ADDRESS_LINE4, 
            :WK_P_ADDRESS_LINE5, 
            :WK_P_CITY, 
            :WK_P_STATE, 
            :WK_P_POST_CODE, 
            :WK_P_COUNTRY,
            :WK_P_AUST_POST_4STATE_ID);
      END
      ELSE
      BEGIN
         UPDATE PERSON  SET PERSON_TYPE = :WK_P_PERSON_TYPE, 
            FIRST_NAME = :WK_P_FIRST_NAME, 
            LAST_NAME = :WK_P_LAST_NAME, 
            ADDRESS_LINE1 = :WK_P_ADDRESS_LINE1, 
            ADDRESS_LINE2 = :WK_P_ADDRESS_LINE2, 
            ADDRESS_LINE3 = :WK_P_ADDRESS_LINE3, 
            ADDRESS_LINE4 = :WK_P_ADDRESS_LINE4, 
            ADDRESS_LINE5 = :WK_P_ADDRESS_LINE5, 
            CITY = :WK_P_CITY, 
            STATE = :WK_P_STATE, 
            POST_CODE = :WK_P_POST_CODE, 
            COUNTRY = :WK_P_COUNTRY, 
            AUST_POST_4STATE_ID = :WK_P_AUST_POST_4STATE_ID 
          WHERE PERSON_ID = :WK_H_PERSON_ID;
      END
   END
END ^

CREATE TRIGGER ADD_PICK_FROM_TEMP2 FOR PICK_ORDER_ITEM_TEMP 
ACTIVE BEFORE INSERT POSITION 20 
AS
DECLARE VARIABLE WK_FOUND INTEGER;
DECLARE VARIABLE WK_H_PERSON_ID VARCHAR(10); 
DECLARE VARIABLE WK_P_PERSON_TYPE CHAR(2);
DECLARE VARIABLE WK_P_FIRST_NAME VARCHAR(50); 
DECLARE VARIABLE WK_P_LAST_NAME VARCHAR(50); 
DECLARE VARIABLE WK_P_ADDRESS_LINE1 VARCHAR(100); 
DECLARE VARIABLE WK_P_ADDRESS_LINE2 VARCHAR(50); 
DECLARE VARIABLE WK_P_ADDRESS_LINE3 VARCHAR(50); 
DECLARE VARIABLE WK_P_ADDRESS_LINE4 VARCHAR(50); 
DECLARE VARIABLE WK_P_ADDRESS_LINE5 VARCHAR(50); 
DECLARE VARIABLE WK_P_CITY VARCHAR(25); 
DECLARE VARIABLE WK_P_STATE VARCHAR(15); 
DECLARE VARIABLE WK_P_POST_CODE VARCHAR(10); 
DECLARE VARIABLE WK_P_COUNTRY VARCHAR(25);
DECLARE VARIABLE WK_P_AUST_POST_4STATE_ID VARCHAR(255);
DECLARE VARIABLE WK_P_NO_PERSON_UPD CHAR(1);
DECLARE VARIABLE WK_H_PICK_ORDER  VARCHAR(15);
DECLARE VARIABLE WK_H_PICK_ORDER_TYPE  CHAR(2);
DECLARE VARIABLE WK_H_CONTACT_NAME  VARCHAR(50);
DECLARE VARIABLE WK_H_CUSTOMER_PO_WO  VARCHAR(20);
DECLARE VARIABLE WK_H_COST_CENTER  VARCHAR(40);
DECLARE VARIABLE WK_H_COMPANY_ID  VARCHAR(20);
DECLARE VARIABLE WK_H_DIVISION_ID  VARCHAR(20);
DECLARE VARIABLE WK_H_PICK_PRIORITY  SMALLINT;
DECLARE VARIABLE WK_H_DELIVERY_RUN_NO  VARCHAR(10);
DECLARE VARIABLE WK_H_PICK_DUE_DATE  TIMESTAMP;
DECLARE VARIABLE WK_H_SPECIAL_INSTRUCTIONS1  VARCHAR(8196);
DECLARE VARIABLE WK_H_SPECIAL_INSTRUCTIONS2  VARCHAR(255);
DECLARE VARIABLE WK_H_INV_WITH_GOODS  CHAR(1);
DECLARE VARIABLE WK_H_SHIP_VIA  VARCHAR(10);
DECLARE VARIABLE WK_H_DESPATCH_LOCATION  VARCHAR(10);
DECLARE VARIABLE WK_H_CREATE_DATE  TIMESTAMP;
DECLARE VARIABLE WK_H_CREATED_BY  VARCHAR(10);
DECLARE VARIABLE WK_H_PICK_STARTED  TIMESTAMP;
DECLARE VARIABLE WK_H_PICK_STATUS  CHAR(2);
DECLARE VARIABLE WK_H_PARTIAL_PICK_ALLOWED  CHAR(1);
DECLARE VARIABLE WK_H_OTHER1  VARCHAR(50);
DECLARE VARIABLE WK_H_OTHER2  VARCHAR(50);
DECLARE VARIABLE WK_H_OTHER3  VARCHAR(50);
DECLARE VARIABLE WK_H_OTHER4  VARCHAR(50);
DECLARE VARIABLE WK_H_OTHER5  VARCHAR(50);
DECLARE VARIABLE WK_H_OTHER6  VARCHAR(50);
DECLARE VARIABLE WK_H_OTHER7  VARCHAR(50);
DECLARE VARIABLE WK_H_OTHER8  VARCHAR(50);
DECLARE VARIABLE WK_H_OTHER9  VARCHAR(50);
DECLARE VARIABLE WK_H_OTHERNUM1  NUMERIC(9,2);
DECLARE VARIABLE WK_H_OTHERNUM2  NUMERIC(9,2);
DECLARE VARIABLE WK_H_REMARK1 VARCHAR(75); 
DECLARE VARIABLE WK_H_REMARK2 VARCHAR(75); 
DECLARE VARIABLE WK_H_REMARK3 VARCHAR(75); 
DECLARE VARIABLE WK_H_REMARK4 VARCHAR(75); 
DECLARE VARIABLE WK_H_REMARK5 VARCHAR(75); 
DECLARE VARIABLE WK_H_REMARK6 VARCHAR(75); 
DECLARE VARIABLE WK_H_FOOTER1 VARCHAR(75); 
DECLARE VARIABLE WK_H_FOOTER2 VARCHAR(75); 
DECLARE VARIABLE WK_H_FOOTER3 VARCHAR(75); 
DECLARE VARIABLE WK_H_FOOTER4 VARCHAR(75); 
DECLARE VARIABLE WK_H_FOOTER5 VARCHAR(75); 
DECLARE VARIABLE WK_L_PICK_LABEL_NO  VARCHAR(7);
DECLARE VARIABLE WK_L_PICK_ORDER  VARCHAR(15);
DECLARE VARIABLE WK_L_PICK_ORDER_LINE_NO  CHAR(4);
DECLARE VARIABLE WK_L_CONTACT_NAME  VARCHAR(50);
DECLARE VARIABLE WK_L_PROD_ID  VARCHAR(30);
DECLARE VARIABLE WK_L_SSN_ID  VARCHAR(20);
DECLARE VARIABLE WK_L_WARRANTY_TERM  VARCHAR(50);
DECLARE VARIABLE WK_L_PICK_LABEL_DATE  TIMESTAMP;
DECLARE VARIABLE WK_L_SPECIAL_INSTRUCTIONS1  VARCHAR(8196);
DECLARE VARIABLE WK_L_SPECIAL_INSTRUCTIONS2  VARCHAR(255);
DECLARE VARIABLE WK_L_SPECIAL_INSTRUCTIONS3  VARCHAR(255);
DECLARE VARIABLE WK_L_SHIP_VIA  VARCHAR(10);
DECLARE VARIABLE WK_L_PICK_ORDER_QTY  INTEGER;
DECLARE VARIABLE WK_L_PICK_ALLOCATED_QTY  INTEGER;
DECLARE VARIABLE WK_L_PICKED_QTY  INTEGER;
DECLARE VARIABLE WK_L_PICK_LINE_DUE_DATE  TIMESTAMP;
DECLARE VARIABLE WK_L_PICK_STARTED  TIMESTAMP;
DECLARE VARIABLE WK_L_DESPATCH_TS  TIMESTAMP;
DECLARE VARIABLE WK_L_DESPATCH_LOCATION  VARCHAR(10);
DECLARE VARIABLE WK_L_CREATE_DATE  TIMESTAMP;
DECLARE VARIABLE WK_L_USER_ID  VARCHAR(10);
DECLARE VARIABLE WK_L_DEVICE_ID  CHAR(2);
DECLARE VARIABLE WK_L_CHECKIN_START  TIMESTAMP;
DECLARE VARIABLE WK_L_CHECKIN_FINISH  TIMESTAMP;
DECLARE VARIABLE WK_L_CHECKIN_USER_ID  VARCHAR(10);
DECLARE VARIABLE WK_L_PICK_LINE_STATUS  CHAR(2);
DECLARE VARIABLE WK_L_PARTIAL_PICK_ALLOWED  CHAR(1);
DECLARE VARIABLE WK_L_SALE_PRICE  NUMERIC(9,3);
DECLARE VARIABLE WK_L_OTHER1  VARCHAR(50);
DECLARE VARIABLE WK_L_OTHER2  VARCHAR(50);
DECLARE VARIABLE WK_L_OTHER3  VARCHAR(50);
DECLARE VARIABLE WK_L_OTHER4  VARCHAR(50);
DECLARE VARIABLE WK_L_OTHER5  VARCHAR(50);
DECLARE VARIABLE WK_L_OTHER6  VARCHAR(50);
DECLARE VARIABLE WK_L_OTHER7  VARCHAR(50);
DECLARE VARIABLE WK_L_OTHER8  VARCHAR(50);
DECLARE VARIABLE WK_L_OTHER9  VARCHAR(50);
DECLARE VARIABLE WK_L_OTHERQTY1  INTEGER;
DECLARE VARIABLE WK_LEN_LABEL_NO INTEGER;
DECLARE VARIABLE WK_PROD_LENGTH INTEGER;
DECLARE VARIABLE WK_L_WH_ID CHAR(2);
DECLARE VARIABLE WK_L_LOCN_ID VARCHAR(10);
DECLARE VARIABLE WK_L_BATCH_LINE  INTEGER;
DECLARE VARIABLE WK_L_ALT_WH_ID CHAR(2);
DECLARE VARIABLE WK_L_ALT_LOCN_ID VARCHAR(10);
DECLARE VARIABLE WK_CURRENT_STATUS  CHAR(2);
DECLARE VARIABLE WK_CURRENT_LINE_DUE_DATE  TIMESTAMP;
DECLARE VARIABLE WK_PICK_STATUS  CHAR(2);
DECLARE VARIABLE WK_PICK_ORDER_STATUS  CHAR(2);
DECLARE VARIABLE WK_PI_STATUS  CHAR(2);
DECLARE VARIABLE WK_DOORDER  CHAR(1);
DECLARE VARIABLE WK_DOITEM  CHAR(1);
DECLARE VARIABLE WK_PICK_SSN_ALLOWED VARCHAR(40);
DECLARE VARIABLE WK_TEST_STATUS VARCHAR(4);
DECLARE VARIABLE WK_SSN_OWNER  CHAR(1);
DECLARE VARIABLE WK_ALLOW_SSN_SUBSTITUTE  CHAR(1);
DECLARE VARIABLE WK_L_RETURN_DATE  TIMESTAMP;
DECLARE VARIABLE WK_H_RETURN_DATE  TIMESTAMP;
DECLARE VARIABLE WK_PROD_FIXED  CHAR(1);
DECLARE VARIABLE WK_PROD_STOCK  CHAR(1);
DECLARE VARIABLE WK_PICK_LABEL  VARCHAR(8);
DECLARE VARIABLE WK_L_TAX_RATE  DOUBLE PRECISION;
DECLARE VARIABLE WK_L_TAX_AMOUNT  NUMERIC(9,2);
DECLARE VARIABLE WK_H_FREIGHT  NUMERIC(9,2);
DECLARE VARIABLE WK_H_AMOUNT_PAID  NUMERIC(9,2);
DECLARE VARIABLE WK_L_DISCOUNT DOUBLE PRECISION;
DECLARE VARIABLE WK_L_LINE_TOTAL  NUMERIC(9,2);
DECLARE VARIABLE WK_H_TERMS  VARCHAR(20);
DECLARE VARIABLE WK_H_PAYMENT_METHOD  VARCHAR(40);
DECLARE VARIABLE WK_H_FREIGHT_TAX_AMOUNT  NUMERIC(9,2);
DECLARE VARIABLE WK_H_TAX_RATE  DOUBLE PRECISION;
DECLARE VARIABLE WK_L_CALC_ZONE_LOCN  CHAR(1);
DECLARE VARIABLE WK_L_OVER_SIZED  CHAR(1);
DECLARE VARIABLE WK_PP_EXPORT_CATEGORY CHAR(1);
DECLARE VARIABLE WK_STATE VARCHAR(15); 
DECLARE VARIABLE WK_H_WH_ID  CHAR(2);
DECLARE VARIABLE WK_USE_PERSON_IDS  VARCHAR(10);
DECLARE VARIABLE WK_L_KIT_PARTS  VARCHAR(10);
DECLARE VARIABLE WK_L_PROD_KITTED  CHAR(1);
DECLARE VARIABLE WK_L_ORIGINAL_PICK_ORDER_QTY INTEGER;
DECLARE VARIABLE WK_L_ORIGINAL_PROD_ID        VARCHAR(30);
DECLARE VARIABLE WK_L_ORIGINAL_PICK_STATUS    VARCHAR(2);
DECLARE VARIABLE WK_PK_PROD_ID                VARCHAR(30);
DECLARE VARIABLE WK_PK_PROD_QTY               INTEGER;
DECLARE VARIABLE WK_L_NO_PICK_LINE_NO         VARCHAR(10);
DECLARE VARIABLE WK_LOG_FILENAME         VARCHAR(80);
DECLARE VARIABLE WK_RESULT               INTEGER;
DECLARE VARIABLE WK_L_EXPORTED_DESPATCH       VARCHAR(1);
DECLARE VARIABLE WK_PID_FOUND                 INTEGER;
DECLARE VARIABLE WK_PID_DETAIL_ID             INTEGER;
DECLARE VARIABLE WK_CNTRL_DEFAULT_PRIORITY    SMALLINT;
DECLARE VARIABLE WK_CNTRL_REIMPORT_BY_PRIORITY CHAR(1) ;
DECLARE VARIABLE WK_PICK_ORDER_PRIORITY       SMALLINT;
DECLARE VARIABLE WK_PICK_ORDER_STARTED        TIMESTAMP;
DECLARE VARIABLE WK_PROD_AVAILABLE_QTY        INTEGER;
BEGIN
   BEGIN
      NEW.RECORD_ID  = GEN_ID(TEMP_ID_GEN ,1);
   END
   WK_LOG_FILENAME = '/tmp/salesimport.log';
   WK_PICK_STATUS = '';
   WK_H_PERSON_ID  = NEW.H_PERSON_ID;
   WK_P_PERSON_TYPE = NEW.P_PERSON_TYPE;
   WK_P_FIRST_NAME = NEW.P_FIRST_NAME;
   WK_P_LAST_NAME = NEW.P_LAST_NAME;
   WK_P_ADDRESS_LINE1 = NEW.P_ADDRESS_LINE1;
   WK_P_ADDRESS_LINE2 = NEW.P_ADDRESS_LINE2;
   WK_P_ADDRESS_LINE3 = NEW.P_ADDRESS_LINE3;
   WK_P_ADDRESS_LINE4 = NEW.P_ADDRESS_LINE4;
   WK_P_ADDRESS_LINE5 = NEW.P_ADDRESS_LINE5;
   WK_P_CITY = NEW.P_CITY;
   WK_P_STATE = NEW.P_STATE;
   WK_P_POST_CODE = NEW.P_POST_CODE;
   WK_P_COUNTRY = NEW.P_COUNTRY;
   WK_P_AUST_POST_4STATE_ID = NEW.P_AUST_POST_4STATE_ID;
   WK_P_NO_PERSON_UPD = NEW.P_NO_PERSON_UPD;
   IF (NEW.P_NO_PERSON_UPD IS NULL) THEN
   BEGIN
      WK_P_NO_PERSON_UPD = 'F';
   END
   /* if set sitewise to stop populating the person */
   SELECT DESCRIPTION
   FROM OPTIONS
   WHERE GROUP_CODE = 'REP_CODE'
   AND   CODE = 'PICK_ORDER_ITEM_TEMP.P_NO_PERSON_UPD'
   INTO :WK_USE_PERSON_IDS;
   IF (WK_USE_PERSON_IDS IS NOT NULL) THEN
   BEGIN
      WK_P_NO_PERSON_UPD = WK_USE_PERSON_IDS;
   END
   /* if set sitewise to turn kits into their parts */
   WK_L_KIT_PARTS = 'F';
   SELECT DESCRIPTION
   FROM OPTIONS
   WHERE GROUP_CODE = 'REP_CODE'
   AND   CODE = 'PICK_ORDER_ITEM_TEMP.L_KIT_PARTS'
   INTO :WK_USE_PERSON_IDS;
   IF (WK_USE_PERSON_IDS IS NOT NULL) THEN
   BEGIN
      WK_L_KIT_PARTS = WK_USE_PERSON_IDS;
   END
   /* if set sitewise to not ket the pick_item by the line no */
   WK_L_NO_PICK_LINE_NO = 'F';
   SELECT DESCRIPTION
   FROM OPTIONS
   WHERE GROUP_CODE = 'REP_CODE'
   AND   CODE = 'PICK_ORDER_ITEM_TEMP.L_NO_PICK_LINE_NO'
   INTO :WK_USE_PERSON_IDS;
   IF (WK_USE_PERSON_IDS IS NOT NULL) THEN
   BEGIN
      WK_L_NO_PICK_LINE_NO = WK_USE_PERSON_IDS;
   END

   WK_H_PICK_ORDER = NEW.H_PICK_ORDER;
   WK_H_PICK_ORDER_TYPE = NEW.H_PICK_ORDER_TYPE;
   IF (WK_H_PICK_ORDER_TYPE IS NULL) THEN
   BEGIN
      WK_H_PICK_ORDER_TYPE = '';
   END
   WK_H_CONTACT_NAME = NEW.H_CONTACT_NAME;
   WK_H_CUSTOMER_PO_WO = NEW.H_CUSTOMER_PO_WO;
   WK_H_COST_CENTER = NEW.H_COST_CENTER;
   WK_H_COMPANY_ID = NEW.H_COMPANY_ID;
   WK_H_DIVISION_ID = NEW.H_DIVISION_ID;
   WK_H_PICK_PRIORITY = NEW.H_PICK_PRIORITY;
   WK_H_DELIVERY_RUN_NO = NEW.H_DELIVERY_RUN_NO;
   WK_H_PICK_DUE_DATE = NEW.H_PICK_DUE_DATE;
   WK_H_SPECIAL_INSTRUCTIONS1 = NEW.H_SPECIAL_INSTRUCTIONS1;
   WK_H_SPECIAL_INSTRUCTIONS2 = NEW.H_SPECIAL_INSTRUCTIONS2;
   WK_H_INV_WITH_GOODS = NEW.H_INV_WITH_GOODS;
   WK_H_SHIP_VIA = NEW.H_SHIP_VIA;
   WK_H_DESPATCH_LOCATION = NEW.H_DESPATCH_LOCATION;
   WK_H_CREATE_DATE = NEW.H_CREATE_DATE;
   WK_H_CREATED_BY = NEW.H_CREATED_BY;
   WK_H_PICK_STARTED = NEW.H_PICK_STARTED;
   WK_H_PICK_STATUS = NEW.H_PICK_STATUS;
   IF (NEW.H_PICK_STATUS IS NULL) THEN 
   BEGIN
     WK_H_PICK_STATUS = 'CF';
   END
   ELSE BEGIN
     WK_H_PICK_STATUS = NEW.H_PICK_STATUS;
   END
   IF (NEW.H_PICK_STATUS = 'P') THEN
   BEGIN
     WK_H_PICK_STATUS = 'DA';
   END
   WK_H_OTHER1 = NEW.H_OTHER1;
   WK_H_OTHER2 = NEW.H_OTHER2;
   WK_H_OTHER3 = NEW.H_OTHER3;
   WK_H_OTHER4 = NEW.H_OTHER4;
   WK_H_OTHER5 = NEW.H_OTHER5;
   WK_H_OTHER6 = NEW.H_OTHER6;
   WK_H_OTHER7 = NEW.H_OTHER7;
   WK_H_OTHER8 = NEW.H_OTHER8;
   WK_H_OTHER9 = NEW.H_OTHER9;
   WK_H_PARTIAL_PICK_ALLOWED = NEW.H_PARTIAL_PICK_ALLOWED;
   WK_H_FREIGHT = NEW.H_FREIGHT;
   IF (WK_H_FREIGHT IS NULL) THEN
   BEGIN
      WK_H_FREIGHT = 0;
      WK_H_FREIGHT_TAX_AMOUNT = 0;
   END
   WK_H_AMOUNT_PAID = NEW.H_AMOUNT_PAID;
   IF (WK_H_AMOUNT_PAID IS NULL) THEN
   BEGIN
      WK_H_AMOUNT_PAID = 0;
   END
   WK_H_OTHERNUM1 = NEW.H_OTHER_NUM1;
   WK_H_OTHERNUM2 = NEW.H_OTHER_NUM2;
   WK_H_REMARK1 = NEW.H_REMARKS1;
   WK_H_REMARK2 = NEW.H_REMARKS2;
   WK_H_REMARK3 = NEW.H_REMARKS3;
   WK_H_REMARK4 = NEW.H_REMARKS4;
   WK_H_REMARK5 = NEW.H_REMARKS5;
   WK_H_REMARK6 = NEW.H_REMARKS6;
   WK_H_FOOTER1 = NEW.H_FOOTER1;
   WK_H_FOOTER2 = NEW.H_FOOTER2;
   WK_H_FOOTER3 = NEW.H_FOOTER3;
   WK_H_FOOTER4 = NEW.H_FOOTER4;
   WK_H_FOOTER5 = NEW.H_FOOTER5;
   WK_H_WH_ID = NEW.H_WH_ID;
   /* check for state replacement */
   IF (WK_P_STATE IS NOT NULL) THEN
   BEGIN
      WK_STATE = '';
      SELECT DESCRIPTION FROM OPTIONS
      WHERE GROUP_CODE = 'STATE_CODE'
      AND CODE = :WK_P_STATE
      INTO :WK_STATE;
      IF (WK_STATE IS NULL) THEN
      BEGIN
         WK_STATE = '';
      END
      IF (WK_STATE = '') THEN
      BEGIN
         WK_FOUND = 0;
      END
      ELSE
      BEGIN
         WK_P_STATE = WK_STATE;
      END
   END
   IF (WK_H_WH_ID IS NULL) THEN
   BEGIN
      SELECT DEFAULT_WH_ID 
      FROM CONTROL 
      INTO :WK_H_WH_ID;
   END
   IF (WK_H_PICK_DUE_DATE IS NULL) THEN
   BEGIN
      WK_H_PICK_DUE_DATE = 'NOW';
   END
   IF (WK_H_CREATED_BY IS NULL) THEN
   BEGIN
      WK_H_CREATED_BY = 'BDCS';
   END
   /* have to check that the ship via is valid */
   WK_FOUND = 0;
   SELECT 1
   FROM CARRIER
   WHERE CARRIER_ID = :WK_H_SHIP_VIA
   INTO :WK_FOUND;
   IF (WK_FOUND IS NULL) THEN
   BEGIN
      WK_FOUND = 0;
   END
   IF (WK_FOUND = 0) THEN
   BEGIN
      SELECT DEFAULT_CARRIER_ID
      FROM CONTROL
      INTO :WK_H_SHIP_VIA;
   END
   WK_L_PICK_LABEL_NO = 'NULL' ;
   WK_L_PICK_ORDER = NEW.H_PICK_ORDER ;
   WK_L_PICK_ORDER_LINE_NO = NEW.L_PICK_ORDER_LINE_NO ;
   IF (WK_L_NO_PICK_LINE_NO = 'T' ) THEN
   BEGIN
      WK_L_PICK_ORDER_LINE_NO = NULL ;
   END
   WK_L_CONTACT_NAME = NEW.L_CONTACT_NAME ;
   WK_L_PROD_ID = NEW.L_PROD_ID ;
   WK_L_SSN_ID = NEW.L_SSN_ID ;
   WK_L_WARRANTY_TERM = NEW.L_WARRANTY_TERM ;
   IF (WK_L_WARRANTY_TERM IS NULL) THEN
   BEGIN
      SELECT DEFAULT_WARRANTY
      FROM CONTROL
      INTO :WK_L_WARRANTY_TERM;
   END
   SELECT PICK_IMPORT_CALC_ZONE_LOCN
   FROM CONTROL
   INTO :WK_L_CALC_ZONE_LOCN;
   IF (WK_L_CALC_ZONE_LOCN IS NULL) THEN
   BEGIN
      WK_L_CALC_ZONE_LOCN = 'F';
   END
   WK_L_PICK_LABEL_DATE = NEW.L_PICK_LABEL_DATE ;
   WK_L_SPECIAL_INSTRUCTIONS1 = NEW.L_SPECIAL_INSTRUCTIONS1 ;
   WK_L_SPECIAL_INSTRUCTIONS2 = NEW.L_SPECIAL_INSTRUCTIONS2 ;
   WK_L_SPECIAL_INSTRUCTIONS3 = NEW.L_SPECIAL_INSTRUCTIONS3;
   WK_L_SHIP_VIA = NEW.L_SHIP_VIA ;
   WK_L_PICK_ORDER_QTY = NEW.L_PICK_ORDER_QTY ;
   WK_L_PICK_ALLOCATED_QTY = NEW.L_PICK_ALLOCATED_QTY ;
   WK_L_PICKED_QTY = NEW.L_PICKED_QTY ;
   WK_L_PICK_LINE_DUE_DATE = NEW.L_PICK_LINE_DUE_DATE ;
   WK_L_PICK_STARTED = NEW.L_PICK_STARTED ;
   WK_L_DESPATCH_TS = NEW.L_DESPATCH_TS ;
   WK_L_DESPATCH_LOCATION = NEW.L_DESPATCH_LOCATION ;
   WK_L_CREATE_DATE = NEW.L_CREATE_DATE ;
   WK_L_USER_ID = NEW.L_USER_ID ;
   WK_L_DEVICE_ID = NEW.L_DEVICE_ID ;
   WK_L_CHECKIN_START = NEW.L_CHECKIN_START ;
   WK_L_CHECKIN_FINISH = NEW.L_CHECKIN_FINISH ;
   WK_L_CHECKIN_USER_ID = NEW.L_CHECKIN_USER_ID ;
   WK_L_BATCH_LINE = NEW.L_BATCH_LINE ;
   IF (NEW.L_ALLOW_SSN_SUBSTITUTE IS NULL) THEN
   BEGIN
      SELECT ALLOW_SSN_SUBSTITUTE_DEFAULT  FROM CONTROL
         INTO :WK_ALLOW_SSN_SUBSTITUTE ;
   END
   ELSE
   BEGIN
      WK_ALLOW_SSN_SUBSTITUTE = NEW.L_ALLOW_SSN_SUBSTITUTE;
   END
   WK_L_RETURN_DATE = NEW.L_RETURN_DATE;
   WK_H_RETURN_DATE = NEW.H_RETURN_DATE;
   WK_L_OTHER1 = NEW.L_OTHER1;
   WK_L_OTHER2 = NEW.L_OTHER2;
   WK_L_OTHER3 = NEW.L_OTHER3;
   WK_L_OTHER4 = NEW.L_OTHER4;
   WK_L_OTHER5 = NEW.L_OTHER5;
   WK_L_OTHER6 = NEW.L_OTHER6;
   WK_L_OTHER7 = NEW.L_OTHER7;
   WK_L_OTHER8 = NEW.L_OTHER8;
   WK_L_OTHER9 = NEW.L_OTHER9;
   WK_L_OTHERQTY1 = NEW.L_OTHER_QTY1;
   WK_L_ALT_WH_ID = '';
   WK_L_ALT_LOCN_ID = '';
   WK_H_TERMS = NEW.H_TERMS;
   IF (NEW.H_TERMS IS NULL) THEN
   BEGIN
      WK_H_TERMS = '' ;
   END
   WK_H_PAYMENT_METHOD = NEW.H_PAYMENT_METHOD;
   IF (NEW.H_PAYMENT_METHOD IS NULL) THEN
   BEGIN
      WK_H_PAYMENT_METHOD = '' ;
   END
   IF (NEW.L_PICK_LINE_STATUS IS NULL) THEN
   BEGIN
      WK_L_PICK_LINE_STATUS = 'OP' ;
      NEW.L_PICK_LINE_STATUS  = 'OP';
   END
   ELSE
   BEGIN
      IF (NEW.L_PICK_LINE_STATUS = '  ') THEN
      BEGIN
         WK_L_PICK_LINE_STATUS = 'OP' ;
      END
      ELSE
      BEGIN
         WK_L_PICK_LINE_STATUS = NEW.L_PICK_LINE_STATUS ; 
      END
   END
   /* is this a kitted product */
   WK_L_PROD_KITTED = 'F';
   IF (WK_L_PROD_ID IS NOT NULL) THEN
   BEGIN
      WK_FOUND = 0;
      SELECT FIRST 1 1
      FROM PRODUCT_KIT
      WHERE KIT_ID = :WK_L_PROD_ID
      AND PRODUCT_KIT.STATUS = 'OP'
      INTO :WK_FOUND;
      IF (WK_FOUND IS NULL) THEN
      BEGIN
         WK_FOUND = 0;
      END
      IF (WK_FOUND = 1) THEN
      BEGIN
         WK_L_PROD_KITTED = 'T';
         WK_L_ORIGINAL_PICK_STATUS = WK_L_PICK_LINE_STATUS;
         WK_L_PICK_LINE_STATUS = 'DX';
         WK_L_PICKED_QTY = WK_L_PICK_ORDER_QTY;
      END
   END

   WK_L_PARTIAL_PICK_ALLOWED = NEW.L_PARTIAL_PICK_ALLOWED ;
   WK_L_SALE_PRICE = NEW.L_SALE_PRICE ;
   WK_L_DISCOUNT = 0.0;
   WK_L_LINE_TOTAL = WK_L_SALE_PRICE * WK_L_PICK_ORDER_QTY * (1.0 - WK_L_DISCOUNT / 100.0);
   WK_L_TAX_RATE = NEW.L_TAX_RATE ;
   WK_L_TAX_AMOUNT = WK_L_TAX_RATE * WK_L_LINE_TOTAL / 100;
   IF (WK_H_SHIP_VIA = '') THEN
   BEGIN
      /* 1st try companys ship via */
      SELECT  DESCRIPTION
      FROM OPTIONS
      WHERE GROUP_CODE = 'CMPSHIPVIA'
      AND CODE = :WK_H_COMPANY_ID
      INTO :WK_H_SHIP_VIA;
      IF ((WK_H_SHIP_VIA IS NULL) OR (WK_H_SHIP_VIA = '')) THEN
      BEGIN
         /* 2nd try system ship via */
         SELECT DEFAULT_CARRIER_ID 
         FROM CONTROL
         INTO :WK_H_SHIP_VIA;
      END
   END
   IF (WK_H_TERMS = '') THEN
   BEGIN
      /* try system terms */
      SELECT DEFAULT_TERM 
      FROM CONTROL
      INTO :WK_H_TERMS;
   END
   IF (WK_H_PAYMENT_METHOD = '') THEN
   BEGIN
      /* try system payment */
      SELECT DEFAULT_PAYMENT_METHOD 
      FROM CONTROL
      INTO :WK_H_PAYMENT_METHOD;
   END
   IF (LEN(WK_H_PAYMENT_METHOD) > 20) THEN
   BEGIN
      WK_H_PAYMENT_METHOD = RIGHTS(WK_H_PAYMENT_METHOD,20);
   END
   BEGIN
      /* get default gst */
      SELECT DEFAULT_GST_RATE 
      FROM CONTROL
      INTO :WK_H_TAX_RATE;
      WK_H_FREIGHT_TAX_AMOUNT = WK_H_FREIGHT * WK_H_TAX_RATE / 100.0;
   END
   BEGIN
      /* get default priority */
      SELECT DEFAULT_PICK_PRIORITY, REIMPORT_PICK_BY_PRIORITY 
      FROM CONTROL
      INTO :WK_CNTRL_DEFAULT_PRIORITY, :WK_CNTRL_REIMPORT_BY_PRIORITY;
      IF (WK_CNTRL_REIMPORT_BY_PRIORITY IS NULL) THEN
      BEGIN
         WK_CNTRL_REIMPORT_BY_PRIORITY = 'F';
      END
   END
   /* CHECK PICK_ORDER */
   WK_DOORDER = '0'   ;
   WK_PICK_ORDER_STATUS = '';
   WK_FOUND = 0;
   SELECT 1,PICK_STATUS, PICK_STARTED, PICK_PRIORITY FROM PICK_ORDER
      WHERE PICK_ORDER = :WK_H_PICK_ORDER
      INTO :WK_FOUND, :WK_PICK_ORDER_STATUS, :WK_PICK_ORDER_STARTED, :WK_PICK_ORDER_PRIORITY;
   IF (WK_FOUND = 0) THEN
   BEGIN
      /* is ok to add */
      WK_DOORDER = '1'   ;
   END
   ELSE
   BEGIN
      IF (WK_PICK_ORDER_STATUS = 'DA') THEN
      BEGIN
         WK_DOORDER = '1';
      END
      IF (WK_PICK_ORDER_STATUS = 'OP') THEN
      BEGIN
         WK_DOORDER = '1';
      END
      IF (WK_PICK_ORDER_STATUS = 'CF') THEN
      BEGIN
         WK_DOORDER = '1';
      END
      IF (WK_PICK_ORDER_STATUS = 'UC') THEN
      BEGIN
         WK_DOORDER = '1';
      END
      IF (WK_PICK_ORDER_STATUS IS NULL) THEN
      BEGIN
         WK_DOORDER = '1';
      END
      IF (WK_PICK_ORDER_STARTED IS NOT NULL) THEN
      BEGIN
         WK_DOORDER = '0';
      END
      IF (WK_CNTRL_REIMPORT_BY_PRIORITY = 'T') THEN
      BEGIN
         /* if orders current priority is null or the default then allow update */
         IF ((WK_PICK_ORDER_PRIORITY IS NOT NULL) AND (WK_PICK_ORDER_PRIORITY <> WK_CNTRL_DEFAULT_PRIORITY)) THEN
         BEGIN
            WK_DOORDER = '0';
         END
      END
   END
   WK_DOITEM = '0'   ;

/* IF ORDER TYPE IS NOT VALID THEN DEFAULT TO SALES ORDER TYPE */
   IF ((WK_H_PICK_ORDER_TYPE <> 'SO') AND (WK_H_PICK_ORDER_TYPE <> 'TO')) THEN
   BEGIN
     WK_H_PICK_ORDER_TYPE = 'SO';
   END
   
   /* CHECK PICK_ORDER */
   IF (WK_DOORDER = '1') THEN
   BEGIN
      WK_FOUND = 0;
      SELECT 1 FROM PICK_ORDER
         WHERE PICK_ORDER = :WK_H_PICK_ORDER
         INTO :WK_FOUND;
      IF (WK_FOUND = 0) THEN
      BEGIN
         /* NO ORDER SO INSERT IT */
         INSERT INTO PICK_ORDER (
           PICK_ORDER ,
           PICK_ORDER_TYPE ,
           PERSON_ID ,
           CONTACT_NAME ,
           CUSTOMER_PO_WO ,
           COST_CENTER ,
           COMPANY_ID ,
           DIVISION_ID ,
           PICK_PRIORITY ,
           DELIVERY_RUN_NO ,
           PICK_DUE_DATE ,
           SPECIAL_INSTRUCTIONS1 ,
           SPECIAL_INSTRUCTIONS2 ,
           INV_WITH_GOODS ,
           SHIP_VIA ,
           DESPATCH_LOCATION ,
           CREATE_DATE ,
           CREATED_BY ,
           PICK_STARTED ,
           PICK_STATUS ,
           PARTIAL_PICK_ALLOWED,
           P_PERSON_TYPE,
           P_FIRST_NAME,
           P_LAST_NAME,
           P_ADDRESS_LINE1,
           P_ADDRESS_LINE2,
           P_ADDRESS_LINE3,
           P_ADDRESS_LINE4,
           P_ADDRESS_LINE5,
           P_CITY,
           P_STATE,
           P_POST_CODE,
           P_COUNTRY,
           RETURN_DATE,
           OTHER1,
           OTHER2,
           OTHER3,
           OTHER4,
           OTHER5,
           OTHER6,
           OTHER7,
           OTHER8,
           OTHER9,
           OTHER_NUM1,
           OTHER_NUM2,
           TERMS,
           PAYMENT_METHOD,
           LAST_UPDATE_DATE,
           P_PERSON_ID,
           FREIGHT,
           AMOUNT_PAID,
           TAX_RATE,
           FREIGHT_TAX_AMOUNT,
           P_AUST_POST_4STATE_ID,
           REMARKS1,
           REMARKS2,
           REMARKS3,
           REMARKS4,
           REMARKS5,
           REMARKS6,
           FOOTER1,
           FOOTER2,
           FOOTER3,
           FOOTER4,
           FOOTER5,
           WH_ID)
         VALUES (
           :WK_H_PICK_ORDER ,
           :WK_H_PICK_ORDER_TYPE ,
           :WK_H_PERSON_ID ,
           :WK_H_CONTACT_NAME ,
           :WK_H_CUSTOMER_PO_WO ,
           :WK_H_COST_CENTER ,
           :WK_H_COMPANY_ID ,
           :WK_H_DIVISION_ID ,
           :WK_H_PICK_PRIORITY ,
           :WK_H_DELIVERY_RUN_NO ,
           :WK_H_PICK_DUE_DATE ,
           :WK_H_SPECIAL_INSTRUCTIONS1 ,
           :WK_H_SPECIAL_INSTRUCTIONS2 ,
           :WK_H_INV_WITH_GOODS ,
           :WK_H_SHIP_VIA ,
           :WK_H_DESPATCH_LOCATION ,
           'NOW' ,
           :WK_H_CREATED_BY ,
           :WK_H_PICK_STARTED ,
           :WK_H_PICK_STATUS ,
           :WK_H_PARTIAL_PICK_ALLOWED,
           :WK_P_PERSON_TYPE,
           :WK_P_FIRST_NAME,
           :WK_P_LAST_NAME,
           :WK_P_ADDRESS_LINE1,
           :WK_P_ADDRESS_LINE2,
           :WK_P_ADDRESS_LINE3,
           :WK_P_ADDRESS_LINE4,
           :WK_P_ADDRESS_LINE5,
           :WK_P_CITY,
           :WK_P_STATE,
           :WK_P_POST_CODE,
           :WK_P_COUNTRY,
           :WK_H_RETURN_DATE,
           :WK_H_OTHER1,
           :WK_H_OTHER2,
           :WK_H_OTHER3,
           :WK_H_OTHER4,
           :WK_H_OTHER5,
           :WK_H_OTHER6,
           :WK_H_OTHER7,
           :WK_H_OTHER8,
           :WK_H_OTHER9,
           :WK_H_OTHERNUM1,
           :WK_H_OTHERNUM2,
           :WK_H_TERMS,
           :WK_H_PAYMENT_METHOD,
           'NOW',
           :WK_H_PERSON_ID,
           :WK_H_FREIGHT,
           :WK_H_AMOUNT_PAID,
           :WK_H_TAX_RATE,
           :WK_H_FREIGHT_TAX_AMOUNT,
           :WK_P_AUST_POST_4STATE_ID,
           :WK_H_REMARK1,
           :WK_H_REMARK2,
           :WK_H_REMARK3,
           :WK_H_REMARK4,
           :WK_H_REMARK5,
           :WK_H_REMARK6,
           :WK_H_FOOTER1,
           :WK_H_FOOTER2,
           :WK_H_FOOTER3,
           :WK_H_FOOTER4,
           :WK_H_FOOTER5,
           :WK_H_WH_ID);
      END
      ELSE
      BEGIN
         UPDATE PICK_ORDER SET 
           PICK_ORDER_TYPE = :WK_H_PICK_ORDER_TYPE ,
           PERSON_ID = :WK_H_PERSON_ID ,
           P_PERSON_ID = :WK_H_PERSON_ID ,
           CONTACT_NAME = :WK_H_CONTACT_NAME ,
           CUSTOMER_PO_WO = :WK_H_CUSTOMER_PO_WO ,
           COST_CENTER = :WK_H_COST_CENTER ,
           COMPANY_ID = :WK_H_COMPANY_ID ,
           DIVISION_ID = :WK_H_DIVISION_ID ,
           PICK_PRIORITY = :WK_H_PICK_PRIORITY ,
           DELIVERY_RUN_NO = :WK_H_DELIVERY_RUN_NO ,
           PICK_DUE_DATE = :WK_H_PICK_DUE_DATE ,
           SPECIAL_INSTRUCTIONS1 = :WK_H_SPECIAL_INSTRUCTIONS1 ,
           SPECIAL_INSTRUCTIONS2 = :WK_H_SPECIAL_INSTRUCTIONS2 ,
           INV_WITH_GOODS = :WK_H_INV_WITH_GOODS ,
           SHIP_VIA = :WK_H_SHIP_VIA ,
           DESPATCH_LOCATION = :WK_H_DESPATCH_LOCATION ,
           CREATE_DATE = 'NOW' ,
           CREATED_BY = :WK_H_CREATED_BY ,
           PICK_STARTED = :WK_H_PICK_STARTED ,
           PICK_STATUS = :WK_H_PICK_STATUS ,
           PARTIAL_PICK_ALLOWED = :WK_H_PARTIAL_PICK_ALLOWED , 
           P_PERSON_TYPE = :WK_P_PERSON_TYPE, 
           P_FIRST_NAME = :WK_P_FIRST_NAME, 
           P_LAST_NAME = :WK_P_LAST_NAME, 
           P_ADDRESS_LINE1 = :WK_P_ADDRESS_LINE1, 
           P_ADDRESS_LINE2 = :WK_P_ADDRESS_LINE2, 
           P_ADDRESS_LINE3 = :WK_P_ADDRESS_LINE3, 
           P_ADDRESS_LINE4 = :WK_P_ADDRESS_LINE4, 
           P_ADDRESS_LINE5 = :WK_P_ADDRESS_LINE5, 
           P_CITY = :WK_P_CITY, 
           P_STATE = :WK_P_STATE, 
           P_POST_CODE = :WK_P_POST_CODE, 
           P_COUNTRY = :WK_P_COUNTRY,
           RETURN_DATE = :WK_H_RETURN_DATE, 
           OTHER1 = :WK_H_OTHER1, 
           OTHER2 = :WK_H_OTHER2, 
           OTHER3 = :WK_H_OTHER3, 
           OTHER4 = :WK_H_OTHER4, 
           OTHER5 = :WK_H_OTHER5, 
           OTHER6 = :WK_H_OTHER6, 
           OTHER7 = :WK_H_OTHER7, 
           OTHER8 = :WK_H_OTHER8, 
           OTHER9 = :WK_H_OTHER9,
           OTHER_NUM1 = :WK_H_OTHERNUM1,
           OTHER_NUM2 = :WK_H_OTHERNUM2,
           TERMS = :WK_H_TERMS,
           PAYMENT_METHOD = :WK_H_PAYMENT_METHOD,
           LAST_UPDATE_DATE = 'NOW',
           FREIGHT = :WK_H_FREIGHT,
           AMOUNT_PAID = :WK_H_AMOUNT_PAID,
           TAX_RATE = :WK_H_TAX_RATE,
           FREIGHT_TAX_AMOUNT = :WK_H_FREIGHT_TAX_AMOUNT, 
           P_AUST_POST_4STATE_ID = :WK_P_AUST_POST_4STATE_ID,
           REMARKS1 = :WK_H_REMARK1,
           REMARKS2 = :WK_H_REMARK2,
           REMARKS3 = :WK_H_REMARK3,
           REMARKS4 = :WK_H_REMARK4,
           REMARKS5 = :WK_H_REMARK5,
           REMARKS6 = :WK_H_REMARK6,
           FOOTER1 = :WK_H_FOOTER1,
           FOOTER2 = :WK_H_FOOTER2,
           FOOTER3 = :WK_H_FOOTER3,
           FOOTER4 = :WK_H_FOOTER4,
           FOOTER5 = :WK_H_FOOTER5,
           WH_ID = :WK_H_WH_ID
    WHERE PICK_ORDER = :WK_H_PICK_ORDER;
      END
   END
END ^

CREATE TRIGGER ADD_PICK_FROM_TEMP3 FOR PICK_ORDER_ITEM_TEMP 
ACTIVE BEFORE INSERT POSITION 30 
AS
DECLARE VARIABLE WK_FOUND INTEGER;
DECLARE VARIABLE WK_H_PERSON_ID VARCHAR(10); 
DECLARE VARIABLE WK_P_PERSON_TYPE CHAR(2);
DECLARE VARIABLE WK_P_FIRST_NAME VARCHAR(50); 
DECLARE VARIABLE WK_P_LAST_NAME VARCHAR(50); 
DECLARE VARIABLE WK_P_ADDRESS_LINE1 VARCHAR(100); 
DECLARE VARIABLE WK_P_ADDRESS_LINE2 VARCHAR(50); 
DECLARE VARIABLE WK_P_ADDRESS_LINE3 VARCHAR(50); 
DECLARE VARIABLE WK_P_ADDRESS_LINE4 VARCHAR(50); 
DECLARE VARIABLE WK_P_ADDRESS_LINE5 VARCHAR(50); 
DECLARE VARIABLE WK_P_CITY VARCHAR(25); 
DECLARE VARIABLE WK_P_STATE VARCHAR(15); 
DECLARE VARIABLE WK_P_POST_CODE VARCHAR(10); 
DECLARE VARIABLE WK_P_COUNTRY VARCHAR(25);
DECLARE VARIABLE WK_P_AUST_POST_4STATE_ID VARCHAR(255);
DECLARE VARIABLE WK_P_NO_PERSON_UPD CHAR(1);
DECLARE VARIABLE WK_H_PICK_ORDER  VARCHAR(15);
DECLARE VARIABLE WK_H_PICK_ORDER_TYPE  CHAR(2);
DECLARE VARIABLE WK_H_CONTACT_NAME  VARCHAR(50);
DECLARE VARIABLE WK_H_CUSTOMER_PO_WO  VARCHAR(20);
DECLARE VARIABLE WK_H_COST_CENTER  VARCHAR(40);
DECLARE VARIABLE WK_H_COMPANY_ID  VARCHAR(20);
DECLARE VARIABLE WK_H_DIVISION_ID  VARCHAR(20);
DECLARE VARIABLE WK_H_PICK_PRIORITY  SMALLINT;
DECLARE VARIABLE WK_H_DELIVERY_RUN_NO  VARCHAR(10);
DECLARE VARIABLE WK_H_PICK_DUE_DATE  TIMESTAMP;
DECLARE VARIABLE WK_H_SPECIAL_INSTRUCTIONS1  VARCHAR(8196);
DECLARE VARIABLE WK_H_SPECIAL_INSTRUCTIONS2  VARCHAR(255);
DECLARE VARIABLE WK_H_INV_WITH_GOODS  CHAR(1);
DECLARE VARIABLE WK_H_SHIP_VIA  VARCHAR(10);
DECLARE VARIABLE WK_H_DESPATCH_LOCATION  VARCHAR(10);
DECLARE VARIABLE WK_H_CREATE_DATE  TIMESTAMP;
DECLARE VARIABLE WK_H_CREATED_BY  VARCHAR(10);
DECLARE VARIABLE WK_H_PICK_STARTED  TIMESTAMP;
DECLARE VARIABLE WK_H_PICK_STATUS  CHAR(2);
DECLARE VARIABLE WK_H_PARTIAL_PICK_ALLOWED  CHAR(1);
DECLARE VARIABLE WK_H_OTHER1  VARCHAR(50);
DECLARE VARIABLE WK_H_OTHER2  VARCHAR(50);
DECLARE VARIABLE WK_H_OTHER3  VARCHAR(50);
DECLARE VARIABLE WK_H_OTHER4  VARCHAR(50);
DECLARE VARIABLE WK_H_OTHER5  VARCHAR(50);
DECLARE VARIABLE WK_H_OTHER6  VARCHAR(50);
DECLARE VARIABLE WK_H_OTHER7  VARCHAR(50);
DECLARE VARIABLE WK_H_OTHER8  VARCHAR(50);
DECLARE VARIABLE WK_H_OTHER9  VARCHAR(50);
DECLARE VARIABLE WK_H_OTHERNUM1  NUMERIC(9,2);
DECLARE VARIABLE WK_H_OTHERNUM2  NUMERIC(9,2);
DECLARE VARIABLE WK_H_REMARK1 VARCHAR(75); 
DECLARE VARIABLE WK_H_REMARK2 VARCHAR(75); 
DECLARE VARIABLE WK_H_REMARK3 VARCHAR(75); 
DECLARE VARIABLE WK_H_REMARK4 VARCHAR(75); 
DECLARE VARIABLE WK_H_REMARK5 VARCHAR(75); 
DECLARE VARIABLE WK_H_REMARK6 VARCHAR(75); 
DECLARE VARIABLE WK_H_FOOTER1 VARCHAR(75); 
DECLARE VARIABLE WK_H_FOOTER2 VARCHAR(75); 
DECLARE VARIABLE WK_H_FOOTER3 VARCHAR(75); 
DECLARE VARIABLE WK_H_FOOTER4 VARCHAR(75); 
DECLARE VARIABLE WK_H_FOOTER5 VARCHAR(75); 
DECLARE VARIABLE WK_L_PICK_LABEL_NO  VARCHAR(7);
DECLARE VARIABLE WK_L_PICK_ORDER  VARCHAR(15);
DECLARE VARIABLE WK_L_PICK_ORDER_LINE_NO  CHAR(4);
DECLARE VARIABLE WK_L_CONTACT_NAME  VARCHAR(50);
DECLARE VARIABLE WK_L_PROD_ID  VARCHAR(30);
DECLARE VARIABLE WK_L_SSN_ID  VARCHAR(20);
DECLARE VARIABLE WK_L_WARRANTY_TERM  VARCHAR(50);
DECLARE VARIABLE WK_L_PICK_LABEL_DATE  TIMESTAMP;
DECLARE VARIABLE WK_L_SPECIAL_INSTRUCTIONS1  VARCHAR(8196);
DECLARE VARIABLE WK_L_SPECIAL_INSTRUCTIONS2  VARCHAR(255);
DECLARE VARIABLE WK_L_SPECIAL_INSTRUCTIONS3  VARCHAR(255);
DECLARE VARIABLE WK_L_SHIP_VIA  VARCHAR(10);
DECLARE VARIABLE WK_L_PICK_ORDER_QTY  INTEGER;
DECLARE VARIABLE WK_L_PICK_ALLOCATED_QTY  INTEGER;
DECLARE VARIABLE WK_L_PICKED_QTY  INTEGER;
DECLARE VARIABLE WK_L_PICK_LINE_DUE_DATE  TIMESTAMP;
DECLARE VARIABLE WK_L_PICK_STARTED  TIMESTAMP;
DECLARE VARIABLE WK_L_DESPATCH_TS  TIMESTAMP;
DECLARE VARIABLE WK_L_DESPATCH_LOCATION  VARCHAR(10);
DECLARE VARIABLE WK_L_CREATE_DATE  TIMESTAMP;
DECLARE VARIABLE WK_L_USER_ID  VARCHAR(10);
DECLARE VARIABLE WK_L_DEVICE_ID  CHAR(2);
DECLARE VARIABLE WK_L_CHECKIN_START  TIMESTAMP;
DECLARE VARIABLE WK_L_CHECKIN_FINISH  TIMESTAMP;
DECLARE VARIABLE WK_L_CHECKIN_USER_ID  VARCHAR(10);
DECLARE VARIABLE WK_L_PICK_LINE_STATUS  CHAR(2);
DECLARE VARIABLE WK_L_PARTIAL_PICK_ALLOWED  CHAR(1);
DECLARE VARIABLE WK_L_SALE_PRICE  NUMERIC(9,3);
DECLARE VARIABLE WK_L_OTHER1  VARCHAR(50);
DECLARE VARIABLE WK_L_OTHER2  VARCHAR(50);
DECLARE VARIABLE WK_L_OTHER3  VARCHAR(50);
DECLARE VARIABLE WK_L_OTHER4  VARCHAR(50);
DECLARE VARIABLE WK_L_OTHER5  VARCHAR(50);
DECLARE VARIABLE WK_L_OTHER6  VARCHAR(50);
DECLARE VARIABLE WK_L_OTHER7  VARCHAR(50);
DECLARE VARIABLE WK_L_OTHER8  VARCHAR(50);
DECLARE VARIABLE WK_L_OTHER9  VARCHAR(50);
DECLARE VARIABLE WK_L_OTHERQTY1  INTEGER;
DECLARE VARIABLE WK_LEN_LABEL_NO INTEGER;
DECLARE VARIABLE WK_PROD_LENGTH INTEGER;
DECLARE VARIABLE WK_L_WH_ID CHAR(2);
DECLARE VARIABLE WK_L_LOCN_ID VARCHAR(10);
DECLARE VARIABLE WK_L_BATCH_LINE  INTEGER;
DECLARE VARIABLE WK_L_ALT_WH_ID CHAR(2);
DECLARE VARIABLE WK_L_ALT_LOCN_ID VARCHAR(10);
DECLARE VARIABLE WK_CURRENT_STATUS  CHAR(2);
DECLARE VARIABLE WK_CURRENT_LINE_DUE_DATE  TIMESTAMP;
DECLARE VARIABLE WK_PICK_STATUS  CHAR(2);
DECLARE VARIABLE WK_PICK_ORDER_STATUS  CHAR(2);
DECLARE VARIABLE WK_PI_STATUS  CHAR(2);
DECLARE VARIABLE WK_DOORDER  CHAR(1);
DECLARE VARIABLE WK_DOITEM  CHAR(1);
DECLARE VARIABLE WK_PICK_SSN_ALLOWED VARCHAR(40);
DECLARE VARIABLE WK_TEST_STATUS VARCHAR(4);
DECLARE VARIABLE WK_SSN_OWNER  CHAR(1);
DECLARE VARIABLE WK_ALLOW_SSN_SUBSTITUTE  CHAR(1);
DECLARE VARIABLE WK_L_RETURN_DATE  TIMESTAMP;
DECLARE VARIABLE WK_H_RETURN_DATE  TIMESTAMP;
DECLARE VARIABLE WK_PROD_FIXED  CHAR(1);
DECLARE VARIABLE WK_PROD_STOCK  CHAR(1);
DECLARE VARIABLE WK_PICK_LABEL  VARCHAR(8);
DECLARE VARIABLE WK_L_TAX_RATE  DOUBLE PRECISION;
DECLARE VARIABLE WK_L_TAX_AMOUNT  NUMERIC(9,2);
DECLARE VARIABLE WK_H_FREIGHT  NUMERIC(9,2);
DECLARE VARIABLE WK_H_AMOUNT_PAID  NUMERIC(9,2);
DECLARE VARIABLE WK_L_DISCOUNT DOUBLE PRECISION;
DECLARE VARIABLE WK_L_LINE_TOTAL  NUMERIC(9,2);
DECLARE VARIABLE WK_H_TERMS  VARCHAR(20);
DECLARE VARIABLE WK_H_PAYMENT_METHOD  VARCHAR(40);
DECLARE VARIABLE WK_H_FREIGHT_TAX_AMOUNT  NUMERIC(9,2);
DECLARE VARIABLE WK_H_TAX_RATE  DOUBLE PRECISION;
DECLARE VARIABLE WK_L_CALC_ZONE_LOCN  CHAR(1);
DECLARE VARIABLE WK_L_OVER_SIZED  CHAR(1);
DECLARE VARIABLE WK_PP_EXPORT_CATEGORY CHAR(1);
DECLARE VARIABLE WK_STATE VARCHAR(15); 
DECLARE VARIABLE WK_H_WH_ID  CHAR(2);
DECLARE VARIABLE WK_USE_PERSON_IDS  VARCHAR(10);
DECLARE VARIABLE WK_L_KIT_PARTS  VARCHAR(10);
DECLARE VARIABLE WK_L_PROD_KITTED  CHAR(1);
DECLARE VARIABLE WK_L_ORIGINAL_PICK_ORDER_QTY INTEGER;
DECLARE VARIABLE WK_L_ORIGINAL_PROD_ID        VARCHAR(30);
DECLARE VARIABLE WK_L_ORIGINAL_PICK_STATUS    VARCHAR(2);
DECLARE VARIABLE WK_PK_PROD_ID                VARCHAR(30);
DECLARE VARIABLE WK_PK_PROD_QTY               INTEGER;
DECLARE VARIABLE WK_L_NO_PICK_LINE_NO         VARCHAR(10);
DECLARE VARIABLE WK_LOG_FILENAME         VARCHAR(80);
DECLARE VARIABLE WK_LOG_RESULT           INTEGER ;
DECLARE VARIABLE WK_RESULT               INTEGER;
DECLARE VARIABLE WK_L_EXPORTED_DESPATCH       VARCHAR(1);
DECLARE VARIABLE WK_PID_FOUND                 INTEGER;
DECLARE VARIABLE WK_PID_DETAIL_ID             INTEGER;
DECLARE VARIABLE WK_CNTRL_DEFAULT_PRIORITY    SMALLINT;
DECLARE VARIABLE WK_CNTRL_REIMPORT_BY_PRIORITY CHAR(1) ;
DECLARE VARIABLE WK_PICK_ORDER_PRIORITY       SMALLINT;
DECLARE VARIABLE WK_PICK_ORDER_STARTED        TIMESTAMP;
DECLARE VARIABLE WK_PROD_AVAILABLE_QTY        INTEGER;
BEGIN
   BEGIN
      NEW.RECORD_ID  = GEN_ID(TEMP_ID_GEN ,1);
   END
   WK_LOG_FILENAME = '/tmp/salesimport.log';
   WK_PICK_STATUS = '';
   WK_H_PERSON_ID  = NEW.H_PERSON_ID;
   WK_P_PERSON_TYPE = NEW.P_PERSON_TYPE;
   WK_P_FIRST_NAME = NEW.P_FIRST_NAME;
   WK_P_LAST_NAME = NEW.P_LAST_NAME;
   WK_P_ADDRESS_LINE1 = NEW.P_ADDRESS_LINE1;
   WK_P_ADDRESS_LINE2 = NEW.P_ADDRESS_LINE2;
   WK_P_ADDRESS_LINE3 = NEW.P_ADDRESS_LINE3;
   WK_P_ADDRESS_LINE4 = NEW.P_ADDRESS_LINE4;
   WK_P_ADDRESS_LINE5 = NEW.P_ADDRESS_LINE5;
   WK_P_CITY = NEW.P_CITY;
   WK_P_STATE = NEW.P_STATE;
   WK_P_POST_CODE = NEW.P_POST_CODE;
   WK_P_COUNTRY = NEW.P_COUNTRY;
   WK_P_AUST_POST_4STATE_ID = NEW.P_AUST_POST_4STATE_ID;
   WK_P_NO_PERSON_UPD = NEW.P_NO_PERSON_UPD;
   IF (NEW.P_NO_PERSON_UPD IS NULL) THEN
   BEGIN
      WK_P_NO_PERSON_UPD = 'F';
   END
   /* if set sitewise to stop populating the person */
   SELECT DESCRIPTION
   FROM OPTIONS
   WHERE GROUP_CODE = 'REP_CODE'
   AND   CODE = 'PICK_ORDER_ITEM_TEMP.P_NO_PERSON_UPD'
   INTO :WK_USE_PERSON_IDS;
   IF (WK_USE_PERSON_IDS IS NOT NULL) THEN
   BEGIN
      WK_P_NO_PERSON_UPD = WK_USE_PERSON_IDS;
   END
   /* if set sitewise to turn kits into their parts */
   WK_L_KIT_PARTS = 'F';
   SELECT DESCRIPTION
   FROM OPTIONS
   WHERE GROUP_CODE = 'REP_CODE'
   AND   CODE = 'PICK_ORDER_ITEM_TEMP.L_KIT_PARTS'
   INTO :WK_USE_PERSON_IDS;
   IF (WK_USE_PERSON_IDS IS NOT NULL) THEN
   BEGIN
      WK_L_KIT_PARTS = WK_USE_PERSON_IDS;
   END
   /* if set sitewise to not ket the pick_item by the line no */
   WK_L_NO_PICK_LINE_NO = 'F';
   SELECT DESCRIPTION
   FROM OPTIONS
   WHERE GROUP_CODE = 'REP_CODE'
   AND   CODE = 'PICK_ORDER_ITEM_TEMP.L_NO_PICK_LINE_NO'
   INTO :WK_USE_PERSON_IDS;
   IF (WK_USE_PERSON_IDS IS NOT NULL) THEN
   BEGIN
      WK_L_NO_PICK_LINE_NO = WK_USE_PERSON_IDS;
   END

   WK_H_PICK_ORDER = NEW.H_PICK_ORDER;
   WK_H_PICK_ORDER_TYPE = NEW.H_PICK_ORDER_TYPE;
   IF (WK_H_PICK_ORDER_TYPE IS NULL) THEN
   BEGIN
      WK_H_PICK_ORDER_TYPE = '';
   END
   WK_H_CONTACT_NAME = NEW.H_CONTACT_NAME;
   WK_H_CUSTOMER_PO_WO = NEW.H_CUSTOMER_PO_WO;
   WK_H_COST_CENTER = NEW.H_COST_CENTER;
   WK_H_COMPANY_ID = NEW.H_COMPANY_ID;
   WK_H_DIVISION_ID = NEW.H_DIVISION_ID;
   WK_H_PICK_PRIORITY = NEW.H_PICK_PRIORITY;
   WK_H_DELIVERY_RUN_NO = NEW.H_DELIVERY_RUN_NO;
   WK_H_PICK_DUE_DATE = NEW.H_PICK_DUE_DATE;
   WK_H_SPECIAL_INSTRUCTIONS1 = NEW.H_SPECIAL_INSTRUCTIONS1;
   WK_H_SPECIAL_INSTRUCTIONS2 = NEW.H_SPECIAL_INSTRUCTIONS2;
   WK_H_INV_WITH_GOODS = NEW.H_INV_WITH_GOODS;
   WK_H_SHIP_VIA = NEW.H_SHIP_VIA;
   WK_H_DESPATCH_LOCATION = NEW.H_DESPATCH_LOCATION;
   WK_H_CREATE_DATE = NEW.H_CREATE_DATE;
   WK_H_CREATED_BY = NEW.H_CREATED_BY;
   WK_H_PICK_STARTED = NEW.H_PICK_STARTED;
   WK_H_PICK_STATUS = NEW.H_PICK_STATUS;
   IF (NEW.H_PICK_STATUS IS NULL) THEN 
   BEGIN
     WK_H_PICK_STATUS = 'CF';
   END
   ELSE BEGIN
     WK_H_PICK_STATUS = NEW.H_PICK_STATUS;
   END
   IF (NEW.H_PICK_STATUS = 'P') THEN
   BEGIN
     WK_H_PICK_STATUS = 'DA';
   END
   WK_H_OTHER1 = NEW.H_OTHER1;
   WK_H_OTHER2 = NEW.H_OTHER2;
   WK_H_OTHER3 = NEW.H_OTHER3;
   WK_H_OTHER4 = NEW.H_OTHER4;
   WK_H_OTHER5 = NEW.H_OTHER5;
   WK_H_OTHER6 = NEW.H_OTHER6;
   WK_H_OTHER7 = NEW.H_OTHER7;
   WK_H_OTHER8 = NEW.H_OTHER8;
   WK_H_OTHER9 = NEW.H_OTHER9;
   WK_H_PARTIAL_PICK_ALLOWED = NEW.H_PARTIAL_PICK_ALLOWED;
   WK_H_FREIGHT = NEW.H_FREIGHT;
   IF (WK_H_FREIGHT IS NULL) THEN
   BEGIN
      WK_H_FREIGHT = 0;
      WK_H_FREIGHT_TAX_AMOUNT = 0;
   END
   WK_H_AMOUNT_PAID = NEW.H_AMOUNT_PAID;
   IF (WK_H_AMOUNT_PAID IS NULL) THEN
   BEGIN
      WK_H_AMOUNT_PAID = 0;
   END
   WK_H_OTHERNUM1 = NEW.H_OTHER_NUM1;
   WK_H_OTHERNUM2 = NEW.H_OTHER_NUM2;
   WK_H_REMARK1 = NEW.H_REMARKS1;
   WK_H_REMARK2 = NEW.H_REMARKS2;
   WK_H_REMARK3 = NEW.H_REMARKS3;
   WK_H_REMARK4 = NEW.H_REMARKS4;
   WK_H_REMARK5 = NEW.H_REMARKS5;
   WK_H_REMARK6 = NEW.H_REMARKS6;
   WK_H_FOOTER1 = NEW.H_FOOTER1;
   WK_H_FOOTER2 = NEW.H_FOOTER2;
   WK_H_FOOTER3 = NEW.H_FOOTER3;
   WK_H_FOOTER4 = NEW.H_FOOTER4;
   WK_H_FOOTER5 = NEW.H_FOOTER5;
   WK_H_WH_ID = NEW.H_WH_ID;
   /* check for state replacement */
   IF (WK_P_STATE IS NOT NULL) THEN
   BEGIN
      WK_STATE = '';
      SELECT DESCRIPTION FROM OPTIONS
      WHERE GROUP_CODE = 'STATE_CODE'
      AND CODE = :WK_P_STATE
      INTO :WK_STATE;
      IF (WK_STATE IS NULL) THEN
      BEGIN
         WK_STATE = '';
      END
      IF (WK_STATE = '') THEN
      BEGIN
         WK_FOUND = 0;
      END
      ELSE
      BEGIN
         WK_P_STATE = WK_STATE;
      END
   END
   IF (WK_H_WH_ID IS NULL) THEN
   BEGIN
      SELECT DEFAULT_WH_ID 
      FROM CONTROL 
      INTO :WK_H_WH_ID;
   END
   IF (WK_H_PICK_DUE_DATE IS NULL) THEN
   BEGIN
      WK_H_PICK_DUE_DATE = 'NOW';
   END
   IF (WK_H_CREATED_BY IS NULL) THEN
   BEGIN
      WK_H_CREATED_BY = 'BDCS';
   END
   /* have to check that the ship via is valid */
   WK_FOUND = 0;
   SELECT 1
   FROM CARRIER
   WHERE CARRIER_ID = :WK_H_SHIP_VIA
   INTO :WK_FOUND;
   IF (WK_FOUND IS NULL) THEN
   BEGIN
      WK_FOUND = 0;
   END
   IF (WK_FOUND = 0) THEN
   BEGIN
      SELECT DEFAULT_CARRIER_ID
      FROM CONTROL
      INTO :WK_H_SHIP_VIA;
   END
   WK_L_PICK_LABEL_NO = 'NULL' ;
   WK_L_PICK_ORDER = NEW.H_PICK_ORDER ;
   WK_L_PICK_ORDER_LINE_NO = NEW.L_PICK_ORDER_LINE_NO ;
   IF (WK_L_NO_PICK_LINE_NO = 'T' ) THEN
   BEGIN
      WK_L_PICK_ORDER_LINE_NO = NULL ;
   END
   WK_L_CONTACT_NAME = NEW.L_CONTACT_NAME ;
   WK_L_PROD_ID = NEW.L_PROD_ID ;
   WK_L_SSN_ID = NEW.L_SSN_ID ;
   WK_L_WARRANTY_TERM = NEW.L_WARRANTY_TERM ;
   IF (WK_L_WARRANTY_TERM IS NULL) THEN
   BEGIN
      SELECT DEFAULT_WARRANTY
      FROM CONTROL
      INTO :WK_L_WARRANTY_TERM;
   END
   SELECT PICK_IMPORT_CALC_ZONE_LOCN
   FROM CONTROL
   INTO :WK_L_CALC_ZONE_LOCN;
   IF (WK_L_CALC_ZONE_LOCN IS NULL) THEN
   BEGIN
      WK_L_CALC_ZONE_LOCN = 'F';
   END
   WK_L_PICK_LABEL_DATE = NEW.L_PICK_LABEL_DATE ;
   WK_L_SPECIAL_INSTRUCTIONS1 = NEW.L_SPECIAL_INSTRUCTIONS1 ;
   WK_L_SPECIAL_INSTRUCTIONS2 = NEW.L_SPECIAL_INSTRUCTIONS2 ;
   WK_L_SPECIAL_INSTRUCTIONS3 = NEW.L_SPECIAL_INSTRUCTIONS3;
   WK_L_SHIP_VIA = NEW.L_SHIP_VIA ;
   WK_L_PICK_ORDER_QTY = NEW.L_PICK_ORDER_QTY ;
   WK_L_PICK_ALLOCATED_QTY = NEW.L_PICK_ALLOCATED_QTY ;
   WK_L_PICKED_QTY = NEW.L_PICKED_QTY ;
   WK_L_PICK_LINE_DUE_DATE = NEW.L_PICK_LINE_DUE_DATE ;
   WK_L_PICK_STARTED = NEW.L_PICK_STARTED ;
   WK_L_DESPATCH_TS = NEW.L_DESPATCH_TS ;
   WK_L_DESPATCH_LOCATION = NEW.L_DESPATCH_LOCATION ;
   WK_L_CREATE_DATE = NEW.L_CREATE_DATE ;
   WK_L_USER_ID = NEW.L_USER_ID ;
   WK_L_DEVICE_ID = NEW.L_DEVICE_ID ;
   WK_L_CHECKIN_START = NEW.L_CHECKIN_START ;
   WK_L_CHECKIN_FINISH = NEW.L_CHECKIN_FINISH ;
   WK_L_CHECKIN_USER_ID = NEW.L_CHECKIN_USER_ID ;
   WK_L_BATCH_LINE = NEW.L_BATCH_LINE ;
   IF (NEW.L_ALLOW_SSN_SUBSTITUTE IS NULL) THEN
   BEGIN
      SELECT ALLOW_SSN_SUBSTITUTE_DEFAULT  FROM CONTROL
         INTO :WK_ALLOW_SSN_SUBSTITUTE ;
   END
   ELSE
   BEGIN
      WK_ALLOW_SSN_SUBSTITUTE = NEW.L_ALLOW_SSN_SUBSTITUTE;
   END
   WK_L_RETURN_DATE = NEW.L_RETURN_DATE;
   WK_H_RETURN_DATE = NEW.H_RETURN_DATE;
   WK_L_OTHER1 = NEW.L_OTHER1;
   WK_L_OTHER2 = NEW.L_OTHER2;
   WK_L_OTHER3 = NEW.L_OTHER3;
   WK_L_OTHER4 = NEW.L_OTHER4;
   WK_L_OTHER5 = NEW.L_OTHER5;
   WK_L_OTHER6 = NEW.L_OTHER6;
   WK_L_OTHER7 = NEW.L_OTHER7;
   WK_L_OTHER8 = NEW.L_OTHER8;
   WK_L_OTHER9 = NEW.L_OTHER9;
   WK_L_OTHERQTY1 = NEW.L_OTHER_QTY1;
   WK_L_ALT_WH_ID = '';
   WK_L_ALT_LOCN_ID = '';
   WK_H_TERMS = NEW.H_TERMS;
   IF (NEW.H_TERMS IS NULL) THEN
   BEGIN
      WK_H_TERMS = '' ;
   END
   WK_H_PAYMENT_METHOD = NEW.H_PAYMENT_METHOD;
   IF (NEW.H_PAYMENT_METHOD IS NULL) THEN
   BEGIN
      WK_H_PAYMENT_METHOD = '' ;
   END
   IF (NEW.L_PICK_LINE_STATUS IS NULL) THEN
   BEGIN
      WK_L_PICK_LINE_STATUS = 'OP' ;
      NEW.L_PICK_LINE_STATUS  = 'OP';
   END
   ELSE
   BEGIN
      IF (NEW.L_PICK_LINE_STATUS = '  ') THEN
      BEGIN
         WK_L_PICK_LINE_STATUS = 'OP' ;
      END
      ELSE
      BEGIN
         WK_L_PICK_LINE_STATUS = NEW.L_PICK_LINE_STATUS ; 
      END
   END
   /* is this a kitted product */
   WK_L_PROD_KITTED = 'F';
   IF (WK_L_PROD_ID IS NOT NULL) THEN
   BEGIN
      WK_FOUND = 0;
      SELECT FIRST 1 1
      FROM PRODUCT_KIT
      WHERE KIT_ID = :WK_L_PROD_ID
      AND PRODUCT_KIT.STATUS = 'OP'
      INTO :WK_FOUND;
      IF (WK_FOUND IS NULL) THEN
      BEGIN
         WK_FOUND = 0;
      END
      IF (WK_FOUND = 1) THEN
      BEGIN
         WK_L_PROD_KITTED = 'T';
         WK_L_ORIGINAL_PICK_STATUS = WK_L_PICK_LINE_STATUS;
         WK_L_PICK_LINE_STATUS = 'DX';
         WK_L_PICKED_QTY = WK_L_PICK_ORDER_QTY;
      END
   END

   WK_L_PARTIAL_PICK_ALLOWED = NEW.L_PARTIAL_PICK_ALLOWED ;
   WK_L_SALE_PRICE = NEW.L_SALE_PRICE ;
   WK_L_DISCOUNT = 0.0;
   WK_L_LINE_TOTAL = WK_L_SALE_PRICE * WK_L_PICK_ORDER_QTY * (1.0 - WK_L_DISCOUNT / 100.0);
   WK_L_TAX_RATE = NEW.L_TAX_RATE ;
   WK_L_TAX_AMOUNT = WK_L_TAX_RATE * WK_L_LINE_TOTAL / 100;
   IF (WK_H_SHIP_VIA = '') THEN
   BEGIN
      /* 1st try companys ship via */
      SELECT  DESCRIPTION
      FROM OPTIONS
      WHERE GROUP_CODE = 'CMPSHIPVIA'
      AND CODE = :WK_H_COMPANY_ID
      INTO :WK_H_SHIP_VIA;
      IF ((WK_H_SHIP_VIA IS NULL) OR (WK_H_SHIP_VIA = '')) THEN
      BEGIN
         /* 2nd try system ship via */
         SELECT DEFAULT_CARRIER_ID 
         FROM CONTROL
         INTO :WK_H_SHIP_VIA;
      END
   END
   IF (WK_H_TERMS = '') THEN
   BEGIN
      /* try system terms */
      SELECT DEFAULT_TERM 
      FROM CONTROL
      INTO :WK_H_TERMS;
   END
   IF (WK_H_PAYMENT_METHOD = '') THEN
   BEGIN
      /* try system payment */
      SELECT DEFAULT_PAYMENT_METHOD 
      FROM CONTROL
      INTO :WK_H_PAYMENT_METHOD;
   END
   IF (LEN(WK_H_PAYMENT_METHOD) > 20) THEN
   BEGIN
      WK_H_PAYMENT_METHOD = RIGHTS(WK_H_PAYMENT_METHOD,20);
   END
   BEGIN
      /* get default gst */
      SELECT DEFAULT_GST_RATE 
      FROM CONTROL
      INTO :WK_H_TAX_RATE;
      WK_H_FREIGHT_TAX_AMOUNT = WK_H_FREIGHT * WK_H_TAX_RATE / 100.0;
   END
   BEGIN
      /* get default priority */
      SELECT DEFAULT_PICK_PRIORITY, REIMPORT_PICK_BY_PRIORITY 
      FROM CONTROL
      INTO :WK_CNTRL_DEFAULT_PRIORITY, :WK_CNTRL_REIMPORT_BY_PRIORITY;
      IF (WK_CNTRL_REIMPORT_BY_PRIORITY IS NULL) THEN
      BEGIN
         WK_CNTRL_REIMPORT_BY_PRIORITY = 'F';
      END
   END
   /* CHECK PICK_ORDER */
   WK_DOORDER = '0'   ;
   WK_PICK_ORDER_STATUS = '';
   WK_FOUND = 0;
   SELECT 1,PICK_STATUS, PICK_STARTED, PICK_PRIORITY FROM PICK_ORDER
      WHERE PICK_ORDER = :WK_H_PICK_ORDER
      INTO :WK_FOUND, :WK_PICK_ORDER_STATUS, :WK_PICK_ORDER_STARTED, :WK_PICK_ORDER_PRIORITY;
   IF (WK_FOUND = 0) THEN
   BEGIN
      /* is ok to add */
      WK_DOORDER = '1'   ;
   END
   ELSE
   BEGIN
      IF (WK_PICK_ORDER_STATUS = 'DA') THEN
      BEGIN
         WK_DOORDER = '1';
      END
      IF (WK_PICK_ORDER_STATUS = 'OP') THEN
      BEGIN
         WK_DOORDER = '1';
      END
      IF (WK_PICK_ORDER_STATUS = 'CF') THEN
      BEGIN
         WK_DOORDER = '1';
      END
      IF (WK_PICK_ORDER_STATUS = 'UC') THEN
      BEGIN
         WK_DOORDER = '1';
      END
      IF (WK_PICK_ORDER_STATUS IS NULL) THEN
      BEGIN
         WK_DOORDER = '1';
      END
      IF (WK_PICK_ORDER_STARTED IS NOT NULL) THEN
      BEGIN
         WK_DOORDER = '0';
      END
      IF (WK_CNTRL_REIMPORT_BY_PRIORITY = 'T') THEN
      BEGIN
         /* if orders current priority is null or the default then allow update */
         IF ((WK_PICK_ORDER_PRIORITY IS NOT NULL) AND (WK_PICK_ORDER_PRIORITY <> WK_CNTRL_DEFAULT_PRIORITY)) THEN
         BEGIN
            WK_DOORDER = '0';
         END
      END
   END
   WK_DOITEM = '0'   ;

/* IF ORDER TYPE IS NOT VALID THEN DEFAULT TO SALES ORDER TYPE */
   IF ((WK_H_PICK_ORDER_TYPE <> 'SO') AND (WK_H_PICK_ORDER_TYPE <> 'TO')) THEN
   BEGIN
     WK_H_PICK_ORDER_TYPE = 'SO';
   END
   
  /* pick item start */
   /* CHECK PICK_ITEM */
  WK_FOUND = 0;
/*
  SELECT 1, PICK_LABEL_NO, PICK_LINE_STATUS, SSN_CONFIRM
      FROM PICK_ITEM
      WHERE PICK_ORDER = :WK_H_PICK_ORDER 
        AND PICK_ORDER_LINE_NO = :WK_L_PICK_ORDER_LINE_NO
      INTO :WK_FOUND, :WK_L_PICK_LABEL_NO, :WK_PICK_STATUS, :WK_SSN_OWNER;
  IF (WK_FOUND = 0) THEN
  BEGIN
     WK_L_PICK_LABEL_NO = 'NULL';
     WK_PICK_STATUS = 'OP';
  END
*/
  IF (WK_SSN_OWNER IS NULL) THEN
  BEGIN
     WK_SSN_OWNER = 'I';
  END
  /* must lookup ssn or prod to get line no land label no */
  IF (WK_L_SSN_ID IS NULL) THEN
  BEGIN
     WK_FOUND = 2;
     IF (WK_L_PROD_ID IS NULL) THEN
     BEGIN
        WK_FOUND = 2;
        /* not an ssn or prod ??? */
     END
     ELSE
     BEGIN
        /* have prod id */
        WK_FOUND = 0;
        SELECT FIRST 1 1,PICK_LABEL_NO, PICK_ORDER_LINE_NO, PICK_LINE_STATUS, SSN_CONFIRM
        FROM PICK_ITEM
        WHERE PICK_ORDER = :WK_H_PICK_ORDER 
           AND PROD_ID = :WK_L_PROD_ID
        INTO :WK_FOUND, :WK_L_PICK_LABEL_NO, :WK_L_PICK_ORDER_LINE_NO, :WK_PICK_STATUS, :WK_SSN_OWNER;
        IF (WK_FOUND = 0) THEN
        BEGIN
           WK_L_PICK_LABEL_NO = 'NULL';
           WK_PICK_STATUS = 'OP';
           IF (NOT NEW.L_PICK_ORDER_LINE_NO IS NULL) THEN
           BEGIN
              WK_L_PICK_ORDER_LINE_NO = NEW.L_PICK_ORDER_LINE_NO;
           END
        END
        IF (WK_SSN_OWNER IS NULL) THEN
        BEGIN
           WK_SSN_OWNER = 'I';
        END
     END
  END
  ELSE
  BEGIN
     /* have ssn id */
     WK_FOUND = 0;
     SELECT FIRST 1 1,PICK_LABEL_NO, PICK_ORDER_LINE_NO, PICK_LINE_STATUS, SSN_CONFIRM
     FROM PICK_ITEM
     WHERE PICK_ORDER = :WK_H_PICK_ORDER 
        AND SSN_ID = :WK_L_SSN_ID
     INTO :WK_FOUND, :WK_L_PICK_LABEL_NO, :WK_L_PICK_ORDER_LINE_NO, :WK_PICK_STATUS, :WK_SSN_OWNER;
     IF (WK_FOUND = 0) THEN
     BEGIN
        WK_L_PICK_LABEL_NO = 'NULL';
        WK_PICK_STATUS = 'OP';
        IF (NOT NEW.L_PICK_ORDER_LINE_NO IS NULL) THEN
        BEGIN
           WK_L_PICK_ORDER_LINE_NO = NEW.L_PICK_ORDER_LINE_NO;
        END
     END
     IF (WK_SSN_OWNER IS NULL) THEN
     BEGIN
        WK_SSN_OWNER = 'I';
     END
  END
  IF (WK_L_PICK_ORDER_LINE_NO IS NULL) THEN
  BEGIN
     /* next line from order */
     SELECT PICK_ORDER_LINE_NO 
     FROM GET_SALE_LINES_NO(:WK_H_PICK_ORDER) 
     INTO :WK_L_PICK_ORDER_LINE_NO;
  END
  IF (WK_L_PICK_LABEL_NO = 'NULL') THEN
  BEGIN
     WK_PICK_LABEL = '';
     SELECT LABEL_NO FROM NEXT_PICK_LABEL
     INTO :WK_PICK_LABEL;
     WK_L_PICK_LABEL_NO = WK_PICK_LABEL;
     SELECT PICK_IMPORT_SSN_STATUS FROM CONTROL INTO :WK_PICK_SSN_ALLOWED ; 
     IF (NEW.L_SSN_ID IS NULL) THEN
     BEGIN
        /* A NULL */
        WK_FOUND = 2;
     END
     ELSE
     BEGIN
        IF (WK_L_SSN_ID > '') THEN
        BEGIN
           SELECT ISSN_STATUS FROM ISSN
              WHERE SSN_ID = :WK_L_SSN_ID
              INTO :WK_PI_STATUS;
           WK_TEST_STATUS = ',' || WK_PI_STATUS || ',';
           IF (WK_L_PICK_LINE_STATUS <> 'UC') THEN
           BEGIN
              IF (POS(WK_PICK_SSN_ALLOWED , WK_TEST_STATUS,0,1) = -1) THEN
              BEGIN
                 IF (WK_SSN_OWNER <> 'T') THEN
                 BEGIN
                    WK_L_PICK_LINE_STATUS = 'NP';
                    WK_SSN_OWNER = 'F';
                 END
              END
              ELSE
              BEGIN
                    WK_SSN_OWNER = 'T';
              END
           END
        END
     END
  END
  IF (WK_PICK_STATUS = 'OP') THEN
  BEGIN
      WK_DOITEM = '1';
  END
/*
  IF (WK_PICK_STATUS = 'CN') THEN
  BEGIN
      WK_DOITEM = '1';
  END
*/
  IF (WK_PICK_STATUS = 'HD') THEN
  BEGIN
      WK_DOITEM = '1';
  END
/*
  IF (WK_PICK_STATUS = 'DX') THEN
  BEGIN
      WK_DOITEM = '0';
  END
*/
  IF (WK_PICK_STATUS = 'AS') THEN
  BEGIN
      WK_DOITEM = '1';
  END

  /* IF (WK_DOITEM = '1') THEN */
  IF ((WK_DOITEM = '1') AND (WK_DOORDER = '1')) THEN
  BEGIN
      WK_L_WH_ID = '';
      WK_L_LOCN_ID = '';
       /* CHECK SSN */
       IF (NEW.L_SSN_ID IS NULL) THEN
       BEGIN
          /* A NULL */
          WK_FOUND = 2;
       END
       ELSE
       BEGIN
          IF (WK_L_SSN_ID > '') THEN
          BEGIN
             IF (WK_L_PICK_LINE_STATUS <> 'NP') THEN
             BEGIN
                SELECT WH_ID, LOCN_ID FROM ISSN
                   WHERE SSN_ID = :WK_L_SSN_ID
                   INTO :WK_L_WH_ID, :WK_L_LOCN_ID;
                IF (WK_SSN_OWNER = 'T') THEN
                BEGIN
                   UPDATE ISSN SET ISSN_STATUS = 'RS',
                      PICK_ORDER = :WK_L_PICK_LABEL_NO  
                      WHERE SSN_ID = :WK_L_SSN_ID;
                END
             END
             ELSE
             BEGIN
                WK_L_LOCN_ID = 'NIL PICK';
             END
          END
       END
    
       /* GET LENGTH FOR PRODUCT */   
       IF (NEW.L_PROD_ID IS NULL) THEN
       BEGIN
          /* A NULL */
          WK_FOUND = 2;
       END
       ELSE
       BEGIN
          IF (WK_L_PROD_ID > '') THEN
          BEGIN
             SELECT MAX_LENGTH, FIXED_LENGTH
             FROM PARAM
             WHERE DATA_ID = 'PROD_INTERNAL'
             INTO :WK_PROD_LENGTH, :WK_PROD_FIXED;
             WK_L_PROD_ID = ALLTRIM(WK_L_PROD_ID) ;     
             WK_LEN_LABEL_NO = STRLEN(WK_L_PROD_ID) ;     
             IF (WK_PROD_FIXED = 'T') THEN
             BEGIN
                /* PADDING LEADING WITH 0 */
                WHILE (WK_LEN_LABEL_NO < :WK_PROD_LENGTH) DO
                BEGIN
                   WK_L_PROD_ID = '0' || WK_L_PROD_ID ;      
                   WK_LEN_LABEL_NO = WK_LEN_LABEL_NO + 1;
                END
             END
             IF (WK_L_WH_ID = '') THEN
             BEGIN
                SELECT FIRST 1 WH_ID, LOCN_ID FROM ISSN
                   WHERE PROD_ID = :WK_L_PROD_ID
                     AND (WH_ID < 'X'
                     OR WH_ID > 'X~')
                   INTO :WK_L_WH_ID, :WK_L_LOCN_ID;
             END
             WK_FOUND = 0;
             SELECT 1, STOCK, EXPORT_CATEGORY
             FROM PROD_PROFILE
             WHERE PROD_ID = :WK_L_PROD_ID
             INTO :WK_FOUND, :WK_PROD_STOCK, :WK_PP_EXPORT_CATEGORY;
             IF (WK_FOUND = 0) THEN
             BEGIN
                /* no product yet - must be added - but stock status for not to use */
                SELECT DEFAULT_PROD_STOCK 
                FROM CONTROL 
                INTO :WK_PROD_STOCK;
                INSERT INTO PROD_PROFILE (PROD_ID, 
                   SHORT_DESC, 
                   LONG_DESC, 
                   STOCK, 
                   COMPANY_ID, 
                   LAST_UPDATE_DATE, 
                   LAST_UPDATE_BY,
                   STANDARD_COST)
                VALUES (:WK_L_PROD_ID,
                   :WK_L_OTHER2,
                   :WK_L_OTHER2,
                   :WK_PROD_STOCK,
                   :WK_H_COMPANY_ID,
                   'NOW',
                   'BDCS',
                   :WK_L_SALE_PRICE);

             END
             IF (WK_PROD_STOCK IS NULL) THEN
             BEGIN
                SELECT DEFAULT_PROD_STOCK 
                FROM CONTROL 
                INTO :WK_PROD_STOCK;
             END
             WK_FOUND = 0;
             SELECT 1
             FROM CONTROL
             WHERE (POS(PROD_STOCK_OK,:WK_PROD_STOCK,0,1) > -1)
             INTO :WK_FOUND;
             IF (WK_FOUND = 0) THEN
             BEGIN
                /* prod_stock not ok */
                WK_L_PICK_LINE_STATUS = 'HD';
             END
             IF (WK_PP_EXPORT_CATEGORY IS NULL) THEN
             BEGIN
                WK_PP_EXPORT_CATEGORY = '';
             END
             ELSE
             BEGIN
                UPDATE PICK_ORDER SET EXPORT_CATEGORY = :WK_PP_EXPORT_CATEGORY
                WHERE PICK_ORDER = :WK_H_PICK_ORDER;
             END
             
          END
       END
    
       WK_L_OVER_SIZED = 'F';
       WK_FOUND = 0;
       IF (WK_L_CALC_ZONE_LOCN = 'T') THEN
       BEGIN
          IF (WK_L_PROD_ID IS NOT NULL) THEN
          BEGIN
             IF (WK_L_PROD_ID > '') THEN
             BEGIN
                WK_L_WH_ID = '';
                WK_L_LOCN_ID = '';
                WK_L_ALT_WH_ID = '';
                WK_L_ALT_LOCN_ID = '';
                SELECT FIRST 1 1,LOCATION.WH_ID, LOCATION.LOCN_ID
                FROM LOCATION
                JOIN ZONE ON ZONE.CODE = LOCATION.ZONE_C
                WHERE LOCATION.PROD_ID = :WK_L_PROD_ID
                AND (ZONE.DEFAULT_DEVICE_ID IS NOT NULL)
                ORDER BY LOCATION.LOCN_SEQ
                INTO :WK_FOUND,:WK_L_WH_ID, :WK_L_LOCN_ID;
                IF (WK_FOUND = 0) THEN
                BEGIN
                   IF (WK_L_PICK_ORDER_QTY > 0) THEN
                   BEGIN
                      WK_L_OVER_SIZED = 'T';
                   END
                   /* not in normal pick zone - so is over sized */
                   /* so which oversized location to use ? */
                   /* have the company from the order */
                   SELECT FIRST 1 1,LOCATION.WH_ID, LOCATION.LOCN_ID
                   FROM ZONE
                   JOIN LOCATION ON ZONE.CODE = LOCATION.ZONE_C
                   WHERE (ZONE.COMPANY_ID = :WK_H_COMPANY_ID)
                   AND ((LOCATION.PROD_ID IS NULL)
                     OR (LOCATION.PROD_ID = ''))
                   ORDER BY LOCATION.LOCN_SEQ
                   INTO :WK_FOUND,:WK_L_ALT_WH_ID, :WK_L_ALT_LOCN_ID;
                   WK_L_WH_ID = WK_L_ALT_WH_ID;
                   WK_L_LOCN_ID = WK_L_ALT_LOCN_ID;
                END
             END
          END
       END
       IF (WK_L_OVER_SIZED = 'T') THEN
       BEGIN
          UPDATE PICK_ORDER SET OVER_SIZED = 'P',OVER_SIZED_REASON='Some Items Over Sized'
          WHERE PICK_ORDER = :WK_H_PICK_ORDER;
       END
       WK_FOUND = 0;
       WK_CURRENT_STATUS = '';
       SELECT 1, PICK_LINE_STATUS, PICK_LINE_DUE_DATE 
          FROM PICK_ITEM
          WHERE PICK_LABEL_NO = :WK_L_PICK_LABEL_NO 
          INTO :WK_FOUND, :WK_CURRENT_STATUS, :WK_CURRENT_LINE_DUE_DATE;
       IF (WK_FOUND = 0) THEN
       BEGIN
          IF (NEW.L_PICK_LINE_STATUS IS NULL) THEN
          BEGIN
             WK_L_PICK_LINE_STATUS = 'OP' ;
          END
          /* check current stock if none */
          IF ((:WK_L_PROD_ID IS NOT NULL)  AND (:WK_L_PROD_ID <> '')) THEN
          BEGIN
             IF (WK_L_PICK_LINE_STATUS = 'OP') THEN
             BEGIN
                SELECT AVAILABLE_QTY 
                FROM PRODUCT_COMPANY_WH_STOCK_STATUS(:WK_L_PROD_ID, '', '','Admin')
                WHERE PROD_ID = :WK_L_PROD_ID
                INTO :WK_PROD_AVAILABLE_QTY;
                IF ((WK_PROD_AVAILABLE_QTY = 0) OR (WK_PROD_AVAILABLE_QTY IS NULL)) THEN
                BEGIN
                   WK_L_PICK_LINE_STATUS = 'AS' ;
                END
             END
          END
          IF (NEW.L_PICK_LINE_DUE_DATE IS NULL) THEN
          BEGIN
             WK_L_PICK_LINE_DUE_DATE = WK_H_PICK_DUE_DATE ;
          END
          /* NO LINE SO INSERT IT */
          INSERT INTO PICK_ITEM (
            PICK_LABEL_NO ,
            PICK_ORDER ,
            PICK_ORDER_LINE_NO ,
            CONTACT_NAME ,
            PROD_ID ,
            SSN_ID ,
            WARRANTY_TERM ,
            PICK_LABEL_DATE ,
            SPECIAL_INSTRUCTIONS1 ,
            SPECIAL_INSTRUCTIONS2 ,
            SPECIAL_INSTRUCTIONS3 ,
            SHIP_VIA ,
            PICK_ORDER_QTY ,
            PICK_ALLOCATED_QTY ,
            PICKED_QTY ,
            PICK_LINE_DUE_DATE ,
            PICK_STARTED ,
            DESPATCH_TS ,
            DESPATCH_LOCATION ,
            CREATE_DATE ,
            USER_ID ,
            DEVICE_ID ,
            CHECKIN_START ,
            CHECKIN_FINISH ,
            CHECKIN_USER_ID ,
            PICK_LINE_STATUS ,
            PARTIAL_PICK_ALLOWED,
            WH_ID,
            PICK_LOCATION,
            SALE_PRICE,
            SSN_CONFIRM,
            ALLOW_SUBSTITUTE,
            RETURN_DATE,
            TAX_RATE,
            TAX_AMOUNT,
            LINE_TOTAL,
            DISCOUNT ,
            LAST_UPDATE_DATE,
            BATCH_LINE,
            OVER_SIZED, 
            OTHER1,
            OTHER2,
            OTHER3,
            OTHER4,
            OTHER5,
            OTHER6,
            OTHER7,
            OTHER8,
            OTHER9,
            OTHER_QTY1,
            ALT_DESPATCH_WH_ID,
            ALT_DESPATCH_LOCN_ID)
          VALUES (
            :WK_L_PICK_LABEL_NO ,
            :WK_L_PICK_ORDER ,
            :WK_L_PICK_ORDER_LINE_NO ,
            :WK_L_CONTACT_NAME ,
            :WK_L_PROD_ID ,
            :WK_L_SSN_ID ,
            :WK_L_WARRANTY_TERM ,
            :WK_L_PICK_LABEL_DATE ,
            :WK_L_SPECIAL_INSTRUCTIONS1 ,
            :WK_L_SPECIAL_INSTRUCTIONS2 ,
            :WK_L_SPECIAL_INSTRUCTIONS3 ,
            :WK_L_SHIP_VIA ,
            :WK_L_PICK_ORDER_QTY ,
            :WK_L_PICK_ALLOCATED_QTY ,
            :WK_L_PICKED_QTY ,
            :WK_L_PICK_LINE_DUE_DATE ,
            :WK_L_PICK_STARTED ,
            :WK_L_DESPATCH_TS ,
            :WK_L_DESPATCH_LOCATION ,
            'NOW' ,
            :WK_L_USER_ID ,
            :WK_L_DEVICE_ID ,
            :WK_L_CHECKIN_START ,
            :WK_L_CHECKIN_FINISH ,
            :WK_L_CHECKIN_USER_ID ,
            :WK_L_PICK_LINE_STATUS ,
            :WK_L_PARTIAL_PICK_ALLOWED,
            :WK_L_WH_ID,
            :WK_L_LOCN_ID ,
            :WK_L_SALE_PRICE,
            :WK_SSN_OWNER,
            :WK_ALLOW_SSN_SUBSTITUTE,
            :WK_L_RETURN_DATE,
            :WK_L_TAX_RATE,
            :WK_L_TAX_AMOUNT,
            :WK_L_LINE_TOTAL,
            :WK_L_DISCOUNT,
            'NOW' ,
            :WK_L_BATCH_LINE,
            :WK_L_OVER_SIZED,
            :WK_L_OTHER1,
            :WK_L_OTHER2,
            :WK_L_OTHER3,
            :WK_L_OTHER4,
            :WK_L_OTHER5,
            :WK_L_OTHER6,
            :WK_L_OTHER7,
            :WK_L_OTHER8,
            :WK_L_OTHER9,
            :WK_L_OTHERQTY1,
            :WK_L_ALT_WH_ID,
            :WK_L_ALT_LOCN_ID);
       END
       ELSE
          BEGIN
             IF (NEW.L_PICK_LINE_STATUS IS NULL) THEN
             BEGIN
                WK_L_PICK_LINE_STATUS = WK_CURRENT_STATUS ;
             END
             /* check current stock if none */
             IF ((:WK_L_PROD_ID IS NOT NULL)  AND (:WK_L_PROD_ID <> '')) THEN
             BEGIN
                IF (WK_L_PICK_LINE_STATUS = 'OP') THEN
                BEGIN
                   SELECT AVAILABLE_QTY 
                   FROM PRODUCT_COMPANY_WH_STOCK_STATUS(:WK_L_PROD_ID, '', '','Admin')
                   WHERE PROD_ID = :WK_L_PROD_ID
                   INTO :WK_PROD_AVAILABLE_QTY;
                   IF ((WK_PROD_AVAILABLE_QTY = 0) OR (WK_PROD_AVAILABLE_QTY IS NULL)) THEN
                   BEGIN
                      WK_L_PICK_LINE_STATUS = 'AS' ;
                   END
                END
             END
             IF (NEW.L_PICK_LINE_DUE_DATE IS NULL) THEN
             BEGIN
                WK_L_PICK_LINE_DUE_DATE = WK_CURRENT_LINE_DUE_DATE ;
             END
             UPDATE PICK_ITEM SET 
               PICK_ORDER = :WK_L_PICK_ORDER ,
               PICK_ORDER_LINE_NO = :WK_L_PICK_ORDER_LINE_NO ,
               CONTACT_NAME = :WK_L_CONTACT_NAME ,
               PROD_ID = :WK_L_PROD_ID ,
               SSN_ID = :WK_L_SSN_ID ,
               WARRANTY_TERM = :WK_L_WARRANTY_TERM ,
               PICK_LABEL_DATE = :WK_L_PICK_LABEL_DATE ,
               SPECIAL_INSTRUCTIONS1 = :WK_L_SPECIAL_INSTRUCTIONS1 ,
               SPECIAL_INSTRUCTIONS2 = :WK_L_SPECIAL_INSTRUCTIONS2 ,
               SPECIAL_INSTRUCTIONS3 = :WK_L_SPECIAL_INSTRUCTIONS3 ,
               SHIP_VIA = :WK_L_SHIP_VIA ,
               PICK_ORDER_QTY = :WK_L_PICK_ORDER_QTY ,
               PICK_ALLOCATED_QTY = :WK_L_PICK_ALLOCATED_QTY ,
               PICKED_QTY = :WK_L_PICKED_QTY ,
               PICK_LINE_DUE_DATE = :WK_L_PICK_LINE_DUE_DATE ,
               PICK_STARTED = :WK_L_PICK_STARTED ,
               DESPATCH_TS = :WK_L_DESPATCH_TS ,
               DESPATCH_LOCATION = :WK_L_DESPATCH_LOCATION ,
               CREATE_DATE = 'NOW' ,
               USER_ID = :WK_L_USER_ID ,
               DEVICE_ID = :WK_L_DEVICE_ID ,
               CHECKIN_START = :WK_L_CHECKIN_START ,
               CHECKIN_FINISH = :WK_L_CHECKIN_FINISH ,
               CHECKIN_USER_ID = :WK_L_CHECKIN_USER_ID ,
               PICK_LINE_STATUS = :WK_L_PICK_LINE_STATUS ,
               PARTIAL_PICK_ALLOWED = :WK_L_PARTIAL_PICK_ALLOWED ,
               WH_ID = :WK_L_WH_ID,
               PICK_LOCATION = :WK_L_LOCN_ID,
               SALE_PRICE = :WK_L_SALE_PRICE,
               SSN_CONFIRM = :WK_SSN_OWNER,
               ALLOW_SUBSTITUTE = :WK_ALLOW_SSN_SUBSTITUTE,
               RETURN_DATE = :WK_L_RETURN_DATE,
               DISCOUNT = :WK_L_DISCOUNT,
               TAX_RATE = :WK_L_TAX_RATE,
               TAX_AMOUNT = :WK_L_TAX_AMOUNT,
               LINE_TOTAL = :WK_L_LINE_TOTAL,
               LAST_UPDATE_DATE = 'NOW',
               BATCH_LINE = :WK_L_BATCH_LINE,
               OVER_SIZED = :WK_L_OVER_SIZED,
               OTHER1 = :WK_L_OTHER1, 
               OTHER2 = :WK_L_OTHER2, 
               OTHER3 = :WK_L_OTHER3, 
               OTHER4 = :WK_L_OTHER4, 
               OTHER5 = :WK_L_OTHER5, 
               OTHER6 = :WK_L_OTHER6, 
               OTHER7 = :WK_L_OTHER7, 
               OTHER8 = :WK_L_OTHER8, 
               OTHER9 = :WK_L_OTHER9, 
               OTHER_QTY1 = :WK_L_OTHERQTY1,
               ALT_DESPATCH_WH_ID = :WK_L_ALT_WH_ID,
               ALT_DESPATCH_LOCN_ID = :WK_L_ALT_LOCN_ID
               WHERE PICK_LABEL_NO = :WK_L_PICK_LABEL_NO ;
          END /* update pick */
   END /* status can update/insert */
   /* calc the orders volume
      since kit parts are ignored in the volume calc
      get current products (with a exported_despatch of F or T) * their pick_order_qty * 
      the products volume
   */
   IF (WK_L_KIT_PARTS = 'T' AND
       WK_L_PROD_KITTED = 'T') THEN
   BEGIN
      /* need to add a pick_item_detail for the added pick_item */
      BEGIN
         WK_PID_FOUND = 0;
         SELECT 1, PICK_DETAIL_ID 
                FROM PICK_ITEM_DETAIL
                WHERE PICK_LABEL_NO = :WK_L_PICK_LABEL_NO
                AND SSN_ID IS NULL
                INTO :WK_PID_FOUND, :WK_PID_DETAIL_ID;
         IF (WK_PID_FOUND = 0) THEN
         BEGIN
            /* no detail record */
            INSERT INTO PICK_ITEM_DETAIL 
                (PICK_LABEL_NO, 
                 SSN_ID,
                 PICK_DETAIL_STATUS, 
                 DESPATCH_LOCATION,
                 QTY_PICKED,
                 USER_ID, 
                 CREATE_DATE)
            VALUES (:WK_L_PICK_LABEL_NO, 
                 'SSN',
                 'DX',
                 :WK_L_DESPATCH_LOCATION ,
                 :WK_L_PICKED_QTY,
                 :WK_H_CREATED_BY,
                 'NOW');
         END
         ELSE
         BEGIN
            UPDATE PICK_ITEM_DETAIL 
            SET  PICK_DETAIL_STATUS = 'DX',
                 QTY_PICKED = :WK_L_PICKED_QTY ,
                 DESPATCH_LOCATION = :WK_L_DESPATCH_LOCATION ,
                 USER_ID = :WK_H_CREATED_BY
            WHERE PICK_DETAIL_ID = :WK_PID_DETAIL_ID;
         END
      END
      /* now add /update the kitted products */
      WK_L_ORIGINAL_PROD_ID = WK_L_PROD_ID;
      WK_L_ORIGINAL_PICK_ORDER_QTY = NEW.L_PICK_ORDER_QTY;
      FOR SELECT PROD_ID, PROD_QTY
          FROM PRODUCT_KIT
          WHERE KIT_ID = :WK_L_ORIGINAL_PROD_ID
          AND PRODUCT_KIT.STATUS = 'OP'
      INTO :WK_PK_PROD_ID, WK_PK_PROD_QTY
      DO
      BEGIN
      WK_L_PROD_ID = WK_PK_PROD_ID;
      WK_L_PICK_ORDER_QTY = WK_PK_PROD_QTY * WK_L_ORIGINAL_PICK_ORDER_QTY;
      WK_L_PICK_LINE_STATUS = WK_L_ORIGINAL_PICK_STATUS ;
      WK_L_PICK_LABEL_NO = NULL;
      WK_L_PICK_ORDER_LINE_NO = NULL ;
      WK_L_SALE_PRICE = 0.0 ;
      WK_L_DISCOUNT = 0.0;
      WK_L_LINE_TOTAL = WK_L_SALE_PRICE * WK_L_PICK_ORDER_QTY * (1.0 - WK_L_DISCOUNT / 100.0);
      WK_L_TAX_RATE = NEW.L_TAX_RATE ;
      WK_L_TAX_AMOUNT = WK_L_TAX_RATE * WK_L_LINE_TOTAL / 100;
      WK_L_EXPORTED_DESPATCH = 'K';
      WK_L_PICKED_QTY = NEW.L_PICKED_QTY;
     /* pick item start */
      /* CHECK PICK_ITEM */
     WK_FOUND = 0;
/*
     SELECT 1, PICK_LABEL_NO, PICK_LINE_STATUS, SSN_CONFIRM
         FROM PICK_ITEM
         WHERE PICK_ORDER = :WK_H_PICK_ORDER 
           AND PICK_ORDER_LINE_NO = :WK_L_PICK_ORDER_LINE_NO
         INTO :WK_FOUND, :WK_L_PICK_LABEL_NO, :WK_PICK_STATUS, :WK_SSN_OWNER;
     IF (WK_FOUND = 0) THEN
     BEGIN
        WK_L_PICK_LABEL_NO = 'NULL';
        WK_PICK_STATUS = 'OP';
     END
*/
     IF (WK_SSN_OWNER IS NULL) THEN
     BEGIN
        WK_SSN_OWNER = 'I';
     END
     /* must lookup ssn or prod to get line no land label no */
     IF (WK_L_SSN_ID IS NULL) THEN
     BEGIN
        WK_FOUND = 2;
        IF (WK_L_PROD_ID IS NULL) THEN
        BEGIN
           WK_FOUND = 2;
           /* not an ssn or prod ??? */
        END
        ELSE
        BEGIN
           /* have prod id */
           WK_FOUND = 0;
           SELECT FIRST 1 1,PICK_LABEL_NO, PICK_ORDER_LINE_NO, PICK_LINE_STATUS, SSN_CONFIRM
           FROM PICK_ITEM
           WHERE PICK_ORDER = :WK_H_PICK_ORDER 
              AND PROD_ID = :WK_L_PROD_ID
           INTO :WK_FOUND, :WK_L_PICK_LABEL_NO, :WK_L_PICK_ORDER_LINE_NO, :WK_PICK_STATUS, :WK_SSN_OWNER;
           IF (WK_FOUND = 0) THEN
           BEGIN
              WK_L_PICK_LABEL_NO = 'NULL';
              WK_PICK_STATUS = 'OP';
              IF (NOT NEW.L_PICK_ORDER_LINE_NO IS NULL) THEN
              BEGIN
                 WK_L_PICK_ORDER_LINE_NO = NEW.L_PICK_ORDER_LINE_NO;
              END
           END
           IF (WK_SSN_OWNER IS NULL) THEN
           BEGIN
              WK_SSN_OWNER = 'I';
           END
        END
     END
     ELSE
     BEGIN
        /* have ssn id */
        WK_FOUND = 0;
        SELECT FIRST 1 1,PICK_LABEL_NO, PICK_ORDER_LINE_NO, PICK_LINE_STATUS, SSN_CONFIRM
        FROM PICK_ITEM
        WHERE PICK_ORDER = :WK_H_PICK_ORDER 
           AND SSN_ID = :WK_L_SSN_ID
        INTO :WK_FOUND, :WK_L_PICK_LABEL_NO, :WK_L_PICK_ORDER_LINE_NO, :WK_PICK_STATUS, :WK_SSN_OWNER;
        IF (WK_FOUND = 0) THEN
        BEGIN
           WK_L_PICK_LABEL_NO = 'NULL';
           WK_PICK_STATUS = 'OP';
           IF (NOT NEW.L_PICK_ORDER_LINE_NO IS NULL) THEN
           BEGIN
              WK_L_PICK_ORDER_LINE_NO = NEW.L_PICK_ORDER_LINE_NO;
           END
        END
        IF (WK_SSN_OWNER IS NULL) THEN
        BEGIN
           WK_SSN_OWNER = 'I';
        END
     END
     IF (WK_L_PICK_ORDER_LINE_NO IS NULL) THEN
     BEGIN
        /* next line from order */
        SELECT PICK_ORDER_LINE_NO 
        FROM GET_SALE_LINES_NO(:WK_H_PICK_ORDER) 
        INTO :WK_L_PICK_ORDER_LINE_NO;
     END
     IF (WK_L_PICK_LABEL_NO = 'NULL') THEN
     BEGIN
        WK_PICK_LABEL = '';
        SELECT LABEL_NO FROM NEXT_PICK_LABEL
        INTO :WK_PICK_LABEL;
        WK_L_PICK_LABEL_NO = WK_PICK_LABEL;
        SELECT PICK_IMPORT_SSN_STATUS FROM CONTROL INTO :WK_PICK_SSN_ALLOWED ; 
        IF (NEW.L_SSN_ID IS NULL) THEN
        BEGIN
           /* A NULL */
           WK_FOUND = 2;
        END
        ELSE
        BEGIN
           IF (WK_L_SSN_ID > '') THEN
           BEGIN
              SELECT ISSN_STATUS FROM ISSN
                 WHERE SSN_ID = :WK_L_SSN_ID
                 INTO :WK_PI_STATUS;
              WK_TEST_STATUS = ',' || WK_PI_STATUS || ',';
              IF (WK_L_PICK_LINE_STATUS <> 'UC') THEN
              BEGIN
                 IF (POS(WK_PICK_SSN_ALLOWED , WK_TEST_STATUS,0,1) = -1) THEN
                 BEGIN
                    IF (WK_SSN_OWNER <> 'T') THEN
                    BEGIN
                       WK_L_PICK_LINE_STATUS = 'NP';
                       WK_SSN_OWNER = 'F';
                    END
                 END
                 ELSE
                 BEGIN
                       WK_SSN_OWNER = 'T';
                 END
              END
           END
        END
     END
     IF (WK_PICK_STATUS = 'OP') THEN
     BEGIN
         WK_DOITEM = '1';
     END
/*
     IF (WK_PICK_STATUS = 'CN') THEN
     BEGIN
         WK_DOITEM = '1';
     END
*/
/*
     IF (WK_PICK_STATUS = 'HD') THEN
     BEGIN
         WK_DOITEM = '1';
     END
*/
/*
     IF (WK_PICK_STATUS = 'DX') THEN
     BEGIN
         WK_DOITEM = '0';
     END
*/
     IF (WK_PICK_STATUS = 'AS') THEN
     BEGIN
         WK_DOITEM = '1';
     END
   
     /* IF (WK_DOITEM = '1') THEN */
     IF ((WK_DOITEM = '1') AND (WK_DOORDER = '1')) THEN
     BEGIN
         WK_L_WH_ID = '';
         WK_L_LOCN_ID = '';
          /* CHECK SSN */
          IF (NEW.L_SSN_ID IS NULL) THEN
          BEGIN
             /* A NULL */
             WK_FOUND = 2;
          END
          ELSE
          BEGIN
             IF (WK_L_SSN_ID > '') THEN
             BEGIN
                IF (WK_L_PICK_LINE_STATUS <> 'NP') THEN
                BEGIN
                   SELECT WH_ID, LOCN_ID FROM ISSN
                      WHERE SSN_ID = :WK_L_SSN_ID
                      INTO :WK_L_WH_ID, :WK_L_LOCN_ID;
                   IF (WK_SSN_OWNER = 'T') THEN
                   BEGIN
                      UPDATE ISSN SET ISSN_STATUS = 'RS',
                         PICK_ORDER = :WK_L_PICK_LABEL_NO  
                         WHERE SSN_ID = :WK_L_SSN_ID;
                   END
                END
                ELSE
                BEGIN
                   WK_L_LOCN_ID = 'NIL PICK';
                END
             END
          END
       
          /* GET LENGTH FOR PRODUCT */   
          IF (NEW.L_PROD_ID IS NULL) THEN
          BEGIN
             /* A NULL */
             WK_FOUND = 2;
          END
          ELSE
          BEGIN
             IF (WK_L_PROD_ID > '') THEN
             BEGIN
                SELECT MAX_LENGTH, FIXED_LENGTH
                FROM PARAM
                WHERE DATA_ID = 'PROD_INTERNAL'
                INTO :WK_PROD_LENGTH, :WK_PROD_FIXED;
                WK_L_PROD_ID = ALLTRIM(WK_L_PROD_ID) ;     
                WK_LEN_LABEL_NO = STRLEN(WK_L_PROD_ID) ;     
                IF (WK_PROD_FIXED = 'T') THEN
                BEGIN
                   /* PADDING LEADING WITH 0 */
                   WHILE (WK_LEN_LABEL_NO < :WK_PROD_LENGTH) DO
                   BEGIN
                      WK_L_PROD_ID = '0' || WK_L_PROD_ID ;      
                      WK_LEN_LABEL_NO = WK_LEN_LABEL_NO + 1;
                   END
                END
                IF (WK_L_WH_ID = '') THEN
                BEGIN
                   SELECT FIRST 1 WH_ID, LOCN_ID FROM ISSN
                      WHERE PROD_ID = :WK_L_PROD_ID
                        AND (WH_ID < 'X'
                        OR WH_ID > 'X~')
                      INTO :WK_L_WH_ID, :WK_L_LOCN_ID;
                END
                WK_FOUND = 0;
                SELECT 1, STOCK, EXPORT_CATEGORY
                FROM PROD_PROFILE
                WHERE PROD_ID = :WK_L_PROD_ID
                INTO :WK_FOUND, :WK_PROD_STOCK, :WK_PP_EXPORT_CATEGORY;
                IF (WK_FOUND = 0) THEN
                BEGIN
                   /* no product yet - must be added - but stock status for not to use */
                   SELECT DEFAULT_PROD_STOCK 
                   FROM CONTROL 
                   INTO :WK_PROD_STOCK;
                   INSERT INTO PROD_PROFILE (PROD_ID, 
                      SHORT_DESC, 
                      LONG_DESC, 
                      STOCK, 
                      COMPANY_ID, 
                      LAST_UPDATE_DATE, 
                      LAST_UPDATE_BY,
                      STANDARD_COST)
                   VALUES (:WK_L_PROD_ID,
                      :WK_L_OTHER2,
                      :WK_L_OTHER2,
                      :WK_PROD_STOCK,
                      :WK_H_COMPANY_ID,
                      'NOW',
                      'BDCS',
                      :WK_L_SALE_PRICE);
   
                END
                IF (WK_PROD_STOCK IS NULL) THEN
                BEGIN
                   SELECT DEFAULT_PROD_STOCK 
                   FROM CONTROL 
                   INTO :WK_PROD_STOCK;
                END
                WK_FOUND = 0;
                SELECT 1
                FROM CONTROL
                WHERE (POS(PROD_STOCK_OK,:WK_PROD_STOCK,0,1) > -1)
                INTO :WK_FOUND;
                IF (WK_FOUND = 0) THEN
                BEGIN
                   /* prod_stock not ok */
                   WK_L_PICK_LINE_STATUS = 'HD';
                END
                IF (WK_PP_EXPORT_CATEGORY IS NULL) THEN
                BEGIN
                   WK_PP_EXPORT_CATEGORY = '';
                END
                ELSE
                BEGIN
                   UPDATE PICK_ORDER SET EXPORT_CATEGORY = :WK_PP_EXPORT_CATEGORY
                   WHERE PICK_ORDER = :WK_H_PICK_ORDER;
                END
                
             END
          END
       
          WK_L_OVER_SIZED = 'F';
          WK_FOUND = 0;
          IF (WK_L_CALC_ZONE_LOCN = 'T') THEN
          BEGIN
             IF (WK_L_PROD_ID IS NOT NULL) THEN
             BEGIN
                IF (WK_L_PROD_ID > '') THEN
                BEGIN
                   WK_L_WH_ID = '';
                   WK_L_LOCN_ID = '';
                   WK_L_ALT_WH_ID = '';
                   WK_L_ALT_LOCN_ID = '';
                   SELECT FIRST 1 1,LOCATION.WH_ID, LOCATION.LOCN_ID
                   FROM LOCATION
                   JOIN ZONE ON ZONE.CODE = LOCATION.ZONE_C
                   WHERE LOCATION.PROD_ID = :WK_L_PROD_ID
                   AND (ZONE.DEFAULT_DEVICE_ID IS NOT NULL)
                   ORDER BY LOCATION.LOCN_SEQ
                   INTO :WK_FOUND,:WK_L_WH_ID, :WK_L_LOCN_ID;
                   IF (WK_FOUND = 0) THEN
                   BEGIN
                      IF (WK_L_PICK_ORDER_QTY > 0) THEN
                      BEGIN
                         WK_L_OVER_SIZED = 'T';
                      END
                      /* not in normal pick zone - so is over sized */
                      /* so which oversized location to use ? */
                      /* have the company from the order */
                      SELECT FIRST 1 1,LOCATION.WH_ID, LOCATION.LOCN_ID
                      FROM ZONE
                      JOIN LOCATION ON ZONE.CODE = LOCATION.ZONE_C
                      WHERE (ZONE.COMPANY_ID = :WK_H_COMPANY_ID)
                      AND ((LOCATION.PROD_ID IS NULL)
                        OR (LOCATION.PROD_ID = ''))
                      ORDER BY LOCATION.LOCN_SEQ
                      INTO :WK_FOUND,:WK_L_ALT_WH_ID, :WK_L_ALT_LOCN_ID;
                      WK_L_WH_ID = WK_L_ALT_WH_ID;
                      WK_L_LOCN_ID = WK_L_ALT_LOCN_ID;
   
                   END
                   
                END
             END
          END
          IF (WK_L_OVER_SIZED = 'T') THEN
          BEGIN
             UPDATE PICK_ORDER SET OVER_SIZED = 'P',OVER_SIZED_REASON='Some Items Over Sized'
             WHERE PICK_ORDER = :WK_H_PICK_ORDER;
          END
          WK_FOUND = 0;
          WK_CURRENT_STATUS = '';
          SELECT 1, PICK_LINE_STATUS, PICK_LINE_DUE_DATE 
             FROM PICK_ITEM
             WHERE PICK_LABEL_NO = :WK_L_PICK_LABEL_NO 
             INTO :WK_FOUND, :WK_CURRENT_STATUS, :WK_CURRENT_LINE_DUE_DATE;
          IF (WK_FOUND = 0) THEN
          BEGIN
             IF (NEW.L_PICK_LINE_STATUS IS NULL) THEN
             BEGIN
                WK_L_PICK_LINE_STATUS = 'OP' ;
             END
             /* check current stock if none */
             IF ((:WK_L_PROD_ID IS NOT NULL)  AND (:WK_L_PROD_ID <> '')) THEN
             BEGIN
                IF (WK_L_PICK_LINE_STATUS = 'OP') THEN
                BEGIN
                   SELECT AVAILABLE_QTY 
                   FROM PRODUCT_COMPANY_WH_STOCK_STATUS(:WK_L_PROD_ID, '', '','Admin')
                   WHERE PROD_ID = :WK_L_PROD_ID
                   INTO :WK_PROD_AVAILABLE_QTY;
                   IF ((WK_PROD_AVAILABLE_QTY = 0) OR (WK_PROD_AVAILABLE_QTY IS NULL)) THEN
                   BEGIN
                      WK_L_PICK_LINE_STATUS = 'AS' ;
                   END
                END
             END
             IF (NEW.L_PICK_LINE_DUE_DATE IS NULL) THEN
             BEGIN
                WK_L_PICK_LINE_DUE_DATE = WK_H_PICK_DUE_DATE ;
             END
             /* NO LINE SO INSERT IT */
             INSERT INTO PICK_ITEM (
               PICK_LABEL_NO ,
               PICK_ORDER ,
               PICK_ORDER_LINE_NO ,
               CONTACT_NAME ,
               PROD_ID ,
               SSN_ID ,
               WARRANTY_TERM ,
               PICK_LABEL_DATE ,
               SPECIAL_INSTRUCTIONS1 ,
               SPECIAL_INSTRUCTIONS2 ,
               SPECIAL_INSTRUCTIONS3 ,
               SHIP_VIA ,
               PICK_ORDER_QTY ,
               PICK_ALLOCATED_QTY ,
               PICKED_QTY ,
               PICK_LINE_DUE_DATE ,
               PICK_STARTED ,
               DESPATCH_TS ,
               DESPATCH_LOCATION ,
               CREATE_DATE ,
               USER_ID ,
               DEVICE_ID ,
               CHECKIN_START ,
               CHECKIN_FINISH ,
               CHECKIN_USER_ID ,
               PICK_LINE_STATUS ,
               PARTIAL_PICK_ALLOWED,
               WH_ID,
               PICK_LOCATION,
               SALE_PRICE,
               SSN_CONFIRM,
               ALLOW_SUBSTITUTE,
               RETURN_DATE,
               TAX_RATE,
               TAX_AMOUNT,
               LINE_TOTAL,
               DISCOUNT ,
               LAST_UPDATE_DATE,
               BATCH_LINE,
               OVER_SIZED, 
               OTHER1,
               OTHER2,
               OTHER3,
               OTHER4,
               OTHER5,
               OTHER6,
               OTHER7,
               OTHER8,
               OTHER9,
               OTHER_QTY1,
               ALT_DESPATCH_WH_ID,
               ALT_DESPATCH_LOCN_ID,
               EXPORTED_DESPATCH)
             VALUES (
               :WK_L_PICK_LABEL_NO ,
               :WK_L_PICK_ORDER ,
               :WK_L_PICK_ORDER_LINE_NO ,
               :WK_L_CONTACT_NAME ,
               :WK_L_PROD_ID ,
               :WK_L_SSN_ID ,
               :WK_L_WARRANTY_TERM ,
               :WK_L_PICK_LABEL_DATE ,
               :WK_L_SPECIAL_INSTRUCTIONS1 ,
               :WK_L_SPECIAL_INSTRUCTIONS2 ,
               :WK_L_SPECIAL_INSTRUCTIONS3 ,
               :WK_L_SHIP_VIA ,
               :WK_L_PICK_ORDER_QTY ,
               :WK_L_PICK_ALLOCATED_QTY ,
               :WK_L_PICKED_QTY ,
               :WK_L_PICK_LINE_DUE_DATE ,
               :WK_L_PICK_STARTED ,
               :WK_L_DESPATCH_TS ,
               :WK_L_DESPATCH_LOCATION ,
               'NOW' ,
               :WK_L_USER_ID ,
               :WK_L_DEVICE_ID ,
               :WK_L_CHECKIN_START ,
               :WK_L_CHECKIN_FINISH ,
               :WK_L_CHECKIN_USER_ID ,
               :WK_L_PICK_LINE_STATUS ,
               :WK_L_PARTIAL_PICK_ALLOWED,
               :WK_L_WH_ID,
               :WK_L_LOCN_ID ,
               :WK_L_SALE_PRICE,
               :WK_SSN_OWNER,
               :WK_ALLOW_SSN_SUBSTITUTE,
               :WK_L_RETURN_DATE,
               :WK_L_TAX_RATE,
               :WK_L_TAX_AMOUNT,
               :WK_L_LINE_TOTAL,
               :WK_L_DISCOUNT,
               'NOW' ,
               :WK_L_BATCH_LINE,
               :WK_L_OVER_SIZED,
               :WK_L_OTHER1,
               :WK_L_OTHER2,
               :WK_L_OTHER3,
               :WK_L_OTHER4,
               :WK_L_OTHER5,
               :WK_L_OTHER6,
               :WK_L_OTHER7,
               :WK_L_OTHER8,
               :WK_L_OTHER9,
               :WK_L_OTHERQTY1,
               :WK_L_ALT_WH_ID,
               :WK_L_ALT_LOCN_ID,
               :WK_L_EXPORTED_DESPATCH);
          END
          ELSE
             BEGIN
                IF (NEW.L_PICK_LINE_STATUS IS NULL) THEN
                BEGIN
                   WK_L_PICK_LINE_STATUS = WK_CURRENT_STATUS ;
                END
                /* check current stock if none */
                IF ((:WK_L_PROD_ID IS NOT NULL)  AND (:WK_L_PROD_ID <> '')) THEN
                BEGIN
                   IF (WK_L_PICK_LINE_STATUS = 'OP') THEN
                   BEGIN
                      SELECT AVAILABLE_QTY 
                      FROM PRODUCT_COMPANY_WH_STOCK_STATUS(:WK_L_PROD_ID, '', '','Admin')
                      WHERE PROD_ID = :WK_L_PROD_ID
                      INTO :WK_PROD_AVAILABLE_QTY;
                      IF ((WK_PROD_AVAILABLE_QTY = 0) OR (WK_PROD_AVAILABLE_QTY IS NULL)) THEN
                      BEGIN
                         WK_L_PICK_LINE_STATUS = 'AS' ;
                      END
                   END
                END
                IF (NEW.L_PICK_LINE_DUE_DATE IS NULL) THEN
                BEGIN
                   WK_L_PICK_LINE_DUE_DATE = WK_CURRENT_LINE_DUE_DATE ;
                END
                UPDATE PICK_ITEM SET 
                  PICK_ORDER = :WK_L_PICK_ORDER ,
                  PICK_ORDER_LINE_NO = :WK_L_PICK_ORDER_LINE_NO ,
                  CONTACT_NAME = :WK_L_CONTACT_NAME ,
                  PROD_ID = :WK_L_PROD_ID ,
                  SSN_ID = :WK_L_SSN_ID ,
                  WARRANTY_TERM = :WK_L_WARRANTY_TERM ,
                  PICK_LABEL_DATE = :WK_L_PICK_LABEL_DATE ,
                  SPECIAL_INSTRUCTIONS1 = :WK_L_SPECIAL_INSTRUCTIONS1 ,
                  SPECIAL_INSTRUCTIONS2 = :WK_L_SPECIAL_INSTRUCTIONS2 ,
                  SPECIAL_INSTRUCTIONS3 = :WK_L_SPECIAL_INSTRUCTIONS3 ,
                  SHIP_VIA = :WK_L_SHIP_VIA ,
                  PICK_ORDER_QTY = :WK_L_PICK_ORDER_QTY ,
                  PICK_ALLOCATED_QTY = :WK_L_PICK_ALLOCATED_QTY ,
                  PICKED_QTY = :WK_L_PICKED_QTY ,
                  PICK_LINE_DUE_DATE = :WK_L_PICK_LINE_DUE_DATE ,
                  PICK_STARTED = :WK_L_PICK_STARTED ,
                  DESPATCH_TS = :WK_L_DESPATCH_TS ,
                  DESPATCH_LOCATION = :WK_L_DESPATCH_LOCATION ,
                  CREATE_DATE = 'NOW' ,
                  USER_ID = :WK_L_USER_ID ,
                  DEVICE_ID = :WK_L_DEVICE_ID ,
                  CHECKIN_START = :WK_L_CHECKIN_START ,
                  CHECKIN_FINISH = :WK_L_CHECKIN_FINISH ,
                  CHECKIN_USER_ID = :WK_L_CHECKIN_USER_ID ,
                  PICK_LINE_STATUS = :WK_L_PICK_LINE_STATUS ,
                  PARTIAL_PICK_ALLOWED = :WK_L_PARTIAL_PICK_ALLOWED ,
                  WH_ID = :WK_L_WH_ID,
                  PICK_LOCATION = :WK_L_LOCN_ID,
                  SALE_PRICE = :WK_L_SALE_PRICE,
                  SSN_CONFIRM = :WK_SSN_OWNER,
                  ALLOW_SUBSTITUTE = :WK_ALLOW_SSN_SUBSTITUTE,
                  RETURN_DATE = :WK_L_RETURN_DATE,
                  DISCOUNT = :WK_L_DISCOUNT,
                  TAX_RATE = :WK_L_TAX_RATE,
                  TAX_AMOUNT = :WK_L_TAX_AMOUNT,
                  LINE_TOTAL = :WK_L_LINE_TOTAL,
                  LAST_UPDATE_DATE = 'NOW',
                  BATCH_LINE = :WK_L_BATCH_LINE,
                  OVER_SIZED = :WK_L_OVER_SIZED,
                  OTHER1 = :WK_L_OTHER1, 
                  OTHER2 = :WK_L_OTHER2, 
                  OTHER3 = :WK_L_OTHER3, 
                  OTHER4 = :WK_L_OTHER4, 
                  OTHER5 = :WK_L_OTHER5, 
                  OTHER6 = :WK_L_OTHER6, 
                  OTHER7 = :WK_L_OTHER7, 
                  OTHER8 = :WK_L_OTHER8, 
                  OTHER9 = :WK_L_OTHER9, 
                  OTHER_QTY1 = :WK_L_OTHERQTY1,
                  ALT_DESPATCH_WH_ID = :WK_L_ALT_WH_ID,
                  ALT_DESPATCH_LOCN_ID = :WK_L_ALT_LOCN_ID,
                  EXPORTED_DESPATCH = :WK_L_EXPORTED_DESPATCH
                  WHERE PICK_LABEL_NO = :WK_L_PICK_LABEL_NO ;
             END /* update pick */
         END /* status can update/insert */
      END /* do loop */
   END
END ^

CREATE TRIGGER ADD_POSTCODE_DEPOT FOR POSTCODE_DEPOT 
ACTIVE BEFORE INSERT POSITION 10 
AS
BEGIN
   IF ((NEW.RECORD_ID IS NULL) OR (NEW.RECORD_ID = 0)) THEN
   BEGIN
      NEW.RECORD_ID  = GEN_ID(POSTCODE_DEPOT_ID_GEN,1);
   END
END ^

CREATE TRIGGER MOD_POSTCODE_DEPOT FOR POSTCODE_DEPOT 
ACTIVE BEFORE UPDATE POSITION 10 
AS
BEGIN
   IF ((NEW.RECORD_ID IS NULL) OR (NEW.RECORD_ID = 0)) THEN
   BEGIN
      NEW.RECORD_ID  = GEN_ID(POSTCODE_DEPOT_ID_GEN,1);
   END
END ^

CREATE TRIGGER ADD_PRN_REQUEST_NP FOR PRINT_REQUESTS 
ACTIVE BEFORE INSERT POSITION 20 
AS
DECLARE VARIABLE WK_FOUND INTEGER;
DECLARE VARIABLE WK_GM_MESSAGE VARCHAR(10);
DECLARE VARIABLE WK_DATA_FIELDS INTEGER;
DECLARE VARIABLE WK_FIELD_NO INTEGER;
DECLARE VARIABLE WK_WORK_DATA VARCHAR(32000);
DECLARE VARIABLE WK_WORK_LABEL VARCHAR(32000);
DECLARE VARIABLE WK_WORK_FIELD VARCHAR(32000);
DECLARE VARIABLE WK_WORK_AT_END CHAR(1);
DECLARE VARIABLE WK_WH_ID VARCHAR(32000);
DECLARE VARIABLE WK_ISSN_PRINTER CHAR(2);
DECLARE VARIABLE WK_LOG_FILENAME VARCHAR(80) ;
DECLARE VARIABLE WK_LOG_RESULT   INTEGER;
DECLARE VARIABLE WK_DUMMY        INTEGER;
DECLARE VARIABLE WK_REMOTE_QUEUE VARCHAR(50) ;
DECLARE VARIABLE WK_REMOTE_SERVER VARCHAR(50) ;
BEGIN
   NEW.PRN_DATE = 'NOW';
   IF (NEW.MESSAGE_ID IS NULL OR NEW.MESSAGE_ID = '') THEN
   BEGIN
      WK_GM_MESSAGE = '';
      SELECT MESSAGE_ID 
      FROM GET_NEXT_MESSAGE 
      INTO :WK_GM_MESSAGE;
      NEW.MESSAGE_ID =  WK_GM_MESSAGE;
   END
   ELSE
   BEGIN
      WK_GM_MESSAGE = NEW.MESSAGE_ID;
   END
   IF (NEW.REQUEST_STATUS IS NULL OR NEW.REQUEST_STATUS = '') THEN
   BEGIN
      NEW.REQUEST_STATUS = 'NP';
   END

   IF (NEW.REQUEST_STATUS  = 'NP') THEN
   BEGIN
      POST_EVENT 'PRN_REQUEST_NP';
   END
   IF (NEW.REQUEST_STATUS  = 'CP') THEN
   BEGIN
      /* check wether a print que printer */
      SELECT COMPUTER_QUEUE , COMPUTER_QUEUE_SERVER
      FROM SYS_EQUIP 
      WHERE DEVICE_ID = NEW.DEVICE_ID
      INTO :WK_REMOTE_QUEUE, :WK_REMOTE_SERVER;
      IF (WK_REMOTE_QUEUE IS NULL) THEN
      BEGIN
         /* do nothing */
         wk_DUMMY = 1;
      END
      ELSE
      BEGIN
         IF (WK_REMOTE_QUEUE <> '') THEN
         BEGIN
            NEW.REQUEST_STATUS = 'NQ';
         END
      END
   END
   IF (NEW.REQUEST_STATUS  = 'CP') THEN
   BEGIN
      POST_EVENT 'PRN_REQUEST_CP';
   END
   IF (NEW.REQUEST_STATUS  = 'NQ') THEN
   BEGIN
      POST_EVENT 'PRN_REQUEST_NQ';
   END
END ^

CREATE TRIGGER UPDATE_PRN_REQUEST_NP FOR PRINT_REQUESTS 
ACTIVE BEFORE UPDATE POSITION 20 
AS
DECLARE VARIABLE WK_DUMMY        INTEGER;
DECLARE VARIABLE WK_REMOTE_QUEUE VARCHAR(50) ;
DECLARE VARIABLE WK_REMOTE_SERVER VARCHAR(50) ;
BEGIN
   NEW.PRN_DATE = 'NOW';
   IF (NEW.REQUEST_STATUS = 'NP') THEN
   BEGIN
      POST_EVENT 'PRN_REQUEST_NP';
   END
   IF (NEW.REQUEST_STATUS  = 'CP') THEN
   BEGIN
      /* check wether a print que printer */
      SELECT COMPUTER_QUEUE , COMPUTER_QUEUE_SERVER
      FROM SYS_EQUIP 
      WHERE DEVICE_ID = NEW.DEVICE_ID
      INTO :WK_REMOTE_QUEUE, :WK_REMOTE_SERVER;
      IF (WK_REMOTE_QUEUE IS NULL) THEN
      BEGIN
         /* do nothing */
         wk_DUMMY = 1;
      END
      ELSE
      BEGIN
         IF (WK_REMOTE_QUEUE <> '') THEN
         BEGIN
            NEW.REQUEST_STATUS = 'NQ';
         END
      END
   END
   IF (NEW.REQUEST_STATUS = 'CP') THEN
   BEGIN
      POST_EVENT 'PRN_REQUEST_CP';
   END
   IF (NEW.REQUEST_STATUS = 'NQ') THEN
   BEGIN
      POST_EVENT 'PRN_REQUEST_NQ';
   END
END ^

CREATE TRIGGER ADD_PROD_COND_TIME FOR PRODUCT_CONDITION 
ACTIVE BEFORE INSERT POSITION 20 
AS
BEGIN
   NEW.LAST_UPDATE_DATE = 'NOW';
END ^

CREATE TRIGGER UPD_PROD_COND_TIME FOR PRODUCT_CONDITION 
ACTIVE BEFORE UPDATE POSITION 20 
AS
BEGIN
   NEW.LAST_UPDATE_DATE = 'NOW';
END ^

CREATE TRIGGER ADD_PRODUCT_COND_STATUS_TIME FOR PRODUCT_COND_STATUS 
ACTIVE BEFORE INSERT POSITION 20 
AS
BEGIN
   NEW.LAST_UPDATE_DATE = 'NOW';
END ^

CREATE TRIGGER INSERT_PRODUCT_COND_STATUS FOR PRODUCT_COND_STATUS 
ACTIVE AFTER INSERT POSITION 10 
AS 

  DECLARE VARIABLE REC_EXIST INTEGER;
  DECLARE VARIABLE WK_GLOBAL VARCHAR(30);
  DECLARE VARIABLE WK_SSN_ID VARCHAR(20) ;
  DECLARE VARIABLE CODE VARCHAR(1) ;
  DECLARE VARIABLE ORIGINAL VARCHAR(1) ;
  DECLARE VARIABLE ADD_PROD VARCHAR(1) ;
  DECLARE VARIABLE WK_NOFAULT CHAR(1) ;
BEGIN
  REC_EXIST = 0;

  
  WK_SSN_ID = NEW.SSN_ID;
  CODE = NEW.CODE;
  ORIGINAL = NEW.ORIGINAL_TEST;

  /* test A */
  CODE = 'A';
  /* only interested in 'S' records */
  ORIGINAL = 'S';
  /* Check if record exists */
  REC_EXIST = 0;
  SELECT FIRST 1 1
  FROM PRODUCT_COND_STATUS
  WHERE SSN_ID = :WK_SSN_ID
  AND CODE = :CODE
  AND ORIGINAL_TEST = :ORIGINAL
  INTO :REC_EXIST;

  /* if record not exists then insert */
  IF (REC_EXIST = 0) THEN
  BEGIN
    /* no fault found */
     WK_NOFAULT = 'P';
     EXECUTE PROCEDURE UPDATE_SSN_PRODUCT_COND_STATUS :WK_SSN_ID , :CODE , :ORIGINAL , :WK_NOFAULT ;
  END
  ELSE
  BEGIN
    /* fault found */
     WK_NOFAULT = 'F';
     EXECUTE PROCEDURE UPDATE_SSN_PRODUCT_COND_STATUS :WK_SSN_ID , :CODE , :ORIGINAL , :WK_NOFAULT ;
  END

  /* test B */
  CODE = 'B';
  /* Check if record exists */
  REC_EXIST = 0;
  SELECT FIRST 1 1
  FROM PRODUCT_COND_STATUS
  WHERE SSN_ID = :WK_SSN_ID
  AND CODE = :CODE
  AND ORIGINAL_TEST = :ORIGINAL
  INTO :REC_EXIST;

  /* if record not exists then insert */
  IF (REC_EXIST = 0) THEN
  BEGIN
    /* no fault found */
     WK_NOFAULT = 'P';
     EXECUTE PROCEDURE UPDATE_SSN_PRODUCT_COND_STATUS :WK_SSN_ID , :CODE , :ORIGINAL , :WK_NOFAULT ;
  END
  ELSE
  BEGIN
    /* fault found */
     WK_NOFAULT = 'F';
     EXECUTE PROCEDURE UPDATE_SSN_PRODUCT_COND_STATUS :WK_SSN_ID , :CODE , :ORIGINAL , :WK_NOFAULT ;
  END

  /* test C */
  CODE = 'C';
  /* Check if record exists */
  REC_EXIST = 0;
  SELECT FIRST 1 1
  FROM PRODUCT_COND_STATUS
  WHERE SSN_ID = :WK_SSN_ID
  AND CODE = :CODE
  AND ORIGINAL_TEST = :ORIGINAL
  INTO :REC_EXIST;

  /* if record not exists then insert */
  IF (REC_EXIST = 0) THEN
  BEGIN
    /* no fault found */
     WK_NOFAULT = 'P';
     EXECUTE PROCEDURE UPDATE_SSN_PRODUCT_COND_STATUS :WK_SSN_ID , :CODE , :ORIGINAL , :WK_NOFAULT ;
  END
  ELSE
  BEGIN
    /* fault found */
     WK_NOFAULT = 'F';
     EXECUTE PROCEDURE UPDATE_SSN_PRODUCT_COND_STATUS :WK_SSN_ID , :CODE , :ORIGINAL , :WK_NOFAULT ;
  END

  /* test D */
  CODE = 'D';
  /* Check if record exists */
  REC_EXIST = 0;
  SELECT FIRST 1 1
  FROM PRODUCT_COND_STATUS
  WHERE SSN_ID = :WK_SSN_ID
  AND CODE = :CODE
  AND ORIGINAL_TEST = :ORIGINAL
  INTO :REC_EXIST;

  /* if record not exists then insert */
  IF (REC_EXIST = 0) THEN
  BEGIN
    /* no fault found */
     WK_NOFAULT = 'P';
     EXECUTE PROCEDURE UPDATE_SSN_PRODUCT_COND_STATUS :WK_SSN_ID , :CODE , :ORIGINAL , :WK_NOFAULT ;
  END
  ELSE
  BEGIN
    /* fault found */
     WK_NOFAULT = 'F';
     EXECUTE PROCEDURE UPDATE_SSN_PRODUCT_COND_STATUS :WK_SSN_ID , :CODE , :ORIGINAL , :WK_NOFAULT ;
  END
END ^

CREATE TRIGGER UPD_PRODUCT_COND_STATUS_TIME FOR PRODUCT_COND_STATUS 
ACTIVE BEFORE UPDATE POSITION 20 
AS
BEGIN
   NEW.LAST_UPDATE_DATE = 'NOW';
END ^

CREATE TRIGGER DELETE_PRODUCT_COND_STATUS FOR PRODUCT_COND_STATUS 
ACTIVE AFTER DELETE POSITION 10 
AS 

  DECLARE VARIABLE REC_EXIST INTEGER;
  DECLARE VARIABLE WK_GLOBAL VARCHAR(30);
  DECLARE VARIABLE WK_SSN_ID VARCHAR(20) ;
  DECLARE VARIABLE CODE VARCHAR(1) ;
  DECLARE VARIABLE ORIGINAL VARCHAR(1) ;
  DECLARE VARIABLE ADD_PROD VARCHAR(1) ;
  DECLARE VARIABLE WK_NOFAULT CHAR(1) ;
BEGIN
  REC_EXIST = 0;

  
  WK_SSN_ID = OLD.SSN_ID;

  /* test A */
  CODE = 'A';
  /* only interested in 'S' records */
  ORIGINAL = 'S';
  /* Check if record exists */
  REC_EXIST = 0;
  SELECT FIRST 1 1
  FROM PRODUCT_COND_STATUS
  WHERE SSN_ID = :WK_SSN_ID
  AND CODE = :CODE
  AND ORIGINAL_TEST = :ORIGINAL
  INTO :REC_EXIST;

  /* if record not exists then insert */
  IF (REC_EXIST = 0) THEN
  BEGIN
    /* no fault found */
     WK_NOFAULT = 'P';
     EXECUTE PROCEDURE UPDATE_SSN_PRODUCT_COND_STATUS :WK_SSN_ID , :CODE , :ORIGINAL , :WK_NOFAULT ;
  END
  ELSE
  BEGIN
    /* fault found */
     WK_NOFAULT = 'F';
     EXECUTE PROCEDURE UPDATE_SSN_PRODUCT_COND_STATUS :WK_SSN_ID , :CODE , :ORIGINAL , :WK_NOFAULT ;
  END

  /* test B */
  CODE = 'B';
  /* Check if record exists */
  REC_EXIST = 0;
  SELECT FIRST 1 1
  FROM PRODUCT_COND_STATUS
  WHERE SSN_ID = :WK_SSN_ID
  AND CODE = :CODE
  AND ORIGINAL_TEST = :ORIGINAL
  INTO :REC_EXIST;

  /* if record not exists then insert */
  IF (REC_EXIST = 0) THEN
  BEGIN
    /* no fault found */
     WK_NOFAULT = 'P';
     EXECUTE PROCEDURE UPDATE_SSN_PRODUCT_COND_STATUS :WK_SSN_ID , :CODE , :ORIGINAL , :WK_NOFAULT ;
  END
  ELSE
  BEGIN
    /* fault found */
     WK_NOFAULT = 'F';
     EXECUTE PROCEDURE UPDATE_SSN_PRODUCT_COND_STATUS :WK_SSN_ID , :CODE , :ORIGINAL , :WK_NOFAULT ;
  END

  /* test C */
  CODE = 'C';
  /* Check if record exists */
  REC_EXIST = 0;
  SELECT FIRST 1 1
  FROM PRODUCT_COND_STATUS
  WHERE SSN_ID = :WK_SSN_ID
  AND CODE = :CODE
  AND ORIGINAL_TEST = :ORIGINAL
  INTO :REC_EXIST;

  /* if record not exists then insert */
  IF (REC_EXIST = 0) THEN
  BEGIN
    /* no fault found */
     WK_NOFAULT = 'P';
     EXECUTE PROCEDURE UPDATE_SSN_PRODUCT_COND_STATUS :WK_SSN_ID , :CODE , :ORIGINAL , :WK_NOFAULT ;
  END
  ELSE
  BEGIN
    /* fault found */
     WK_NOFAULT = 'F';
     EXECUTE PROCEDURE UPDATE_SSN_PRODUCT_COND_STATUS :WK_SSN_ID , :CODE , :ORIGINAL , :WK_NOFAULT ;
  END

  /* test D */
  CODE = 'D';
  /* Check if record exists */
  REC_EXIST = 0;
  SELECT FIRST 1 1
  FROM PRODUCT_COND_STATUS
  WHERE SSN_ID = :WK_SSN_ID
  AND CODE = :CODE
  AND ORIGINAL_TEST = :ORIGINAL
  INTO :REC_EXIST;

  /* if record not exists then insert */
  IF (REC_EXIST = 0) THEN
  BEGIN
    /* no fault found */
     WK_NOFAULT = 'P';
     EXECUTE PROCEDURE UPDATE_SSN_PRODUCT_COND_STATUS :WK_SSN_ID , :CODE , :ORIGINAL , :WK_NOFAULT ;
  END
  ELSE
  BEGIN
    /* fault found */
     WK_NOFAULT = 'F';
     EXECUTE PROCEDURE UPDATE_SSN_PRODUCT_COND_STATUS :WK_SSN_ID , :CODE , :ORIGINAL , :WK_NOFAULT ;
  END
END ^

CREATE TRIGGER ADD_PROD_EAN FOR PROD_EAN 
ACTIVE BEFORE INSERT POSITION 10 
AS
BEGIN
   IF (NEW.PROD_EAN_EXTENSION IS NULL ) THEN
   BEGIN
      NEW.PROD_EAN_EXTENSION  = '' ;
   END
   IF (NEW.PROD_EAN IS NULL ) THEN
   BEGIN
      NEW.PROD_EAN  = NEW.PROD_ID ;
   END
END ^

CREATE TRIGGER UPD_PROD_EAN FOR PROD_EAN 
ACTIVE BEFORE UPDATE POSITION 10 
AS
BEGIN
   IF (NEW.PROD_EAN_EXTENSION IS NULL  ) THEN
   BEGIN
      NEW.PROD_EAN_EXTENSION  = '' ;
   END
   IF (NEW.PROD_EAN IS NULL ) THEN
   BEGIN
      NEW.PROD_EAN  = NEW.PROD_ID ;
   END
END ^

CREATE TRIGGER INIT_PROD_PROFILE FOR PROD_PROFILE 
ACTIVE BEFORE INSERT POSITION 5 
AS
DECLARE VARIABLE WK_DEFAULT_UOM CHAR(2);
DECLARE VARIABLE WK_PROD_TAX_CODE  VARCHAR(40);
DECLARE VARIABLE WK_PROD_TAX_APPLICABLE  VARCHAR(50);
BEGIN
  IF (NEW.ISSUE IS NULL) THEN
      NEW.ISSUE = 1;
  IF (NEW.ISSUE = 0 ) THEN
      NEW.ISSUE = 1;
  IF (NEW.ISSUE_PER_ORDER_UNIT IS NULL) THEN
      NEW.ISSUE_PER_ORDER_UNIT = 1;
  IF (NEW.ISSUE_PER_ORDER_UNIT = 0 ) THEN
      NEW.ISSUE_PER_ORDER_UNIT = 1;
  IF (NEW.ISSUE_PER_INNER_UNIT IS NULL) THEN
      NEW.ISSUE_PER_INNER_UNIT = 1;
  IF (NEW.ISSUE_PER_INNER_UNIT = 0 ) THEN
      NEW.ISSUE_PER_INNER_UNIT = 1;
  IF (NEW.SHORT_DESC IS NULL) THEN
  BEGIN
      NEW.SHORT_DESC = NEW.PROD_ID;
     NEW.STOCK = 'U';
  END
   NEW.LAST_UPDATE_DATE = 'NOW';
   WK_DEFAULT_UOM = '';
   SELECT STANDARD_UOM 
   FROM UOM_TYPE 
   WHERE CODE = 'UT'
   INTO :WK_DEFAULT_UOM;
   IF (WK_DEFAULT_UOM IS NULL) THEN
   BEGIN
      WK_DEFAULT_UOM = 'EA';
   END
   IF (NEW.ORDER_UOM IS NULL OR NEW.ORDER_UOM = '') THEN
   BEGIN
      NEW.ORDER_UOM = WK_DEFAULT_UOM;
   END
   IF (NEW.INNER_UOM IS NULL OR NEW.INNER_UOM = '') THEN
   BEGIN
      NEW.ORDER_UOM = WK_DEFAULT_UOM;
   END
   IF (NEW.TAX_APPLICABLE IS NULL OR NEW.TAX_APPLICABLE = 'F') THEN
   BEGIN
      /* look at options table for tax_applicable for this prod_type */
      WK_PROD_TAX_CODE = '';
      WK_PROD_TAX_APPLICABLE = '';
      IF (NEW.PROD_TYPE IS NOT NULL) THEN
      BEGIN
         WK_PROD_TAX_CODE = NEW.PROD_TYPE;
         SELECT DESCRIPTION
         FROM OPTIONS
         WHERE GROUP_CODE = 'PRODTAX'
         AND CODE = :WK_PROD_TAX_CODE
         INTO :WK_PROD_TAX_APPLICABLE;
      END
      IF (WK_PROD_TAX_APPLICABLE IS NULL OR WK_PROD_TAX_APPLICABLE = '') THEN
      BEGIN
         WK_PROD_TAX_CODE = 'SYSTEM';
         WK_PROD_TAX_APPLICABLE = '';
         SELECT DESCRIPTION
         FROM OPTIONS
         WHERE GROUP_CODE = 'PRODTAX'
         AND CODE = :WK_PROD_TAX_CODE
         INTO :WK_PROD_TAX_APPLICABLE;
         IF (WK_PROD_TAX_APPLICABLE IS NULL OR WK_PROD_TAX_APPLICABLE = '') THEN
         BEGIN
            NEW.TAX_APPLICABLE = 'F';
         END
         ELSE
         BEGIN
            NEW.TAX_APPLICABLE = :WK_PROD_TAX_APPLICABLE;
         END
      END
   END
END ^

CREATE TRIGGER UPD_PROD_PROFILE_TIME FOR PROD_PROFILE 
ACTIVE BEFORE UPDATE POSITION 20 
AS
DECLARE VARIABLE WK_DEFAULT_UOM CHAR(2);
BEGIN
   NEW.LAST_UPDATE_DATE = 'NOW';
   WK_DEFAULT_UOM = '';
   SELECT STANDARD_UOM 
   FROM UOM_TYPE 
   WHERE CODE = 'UT'
   INTO :WK_DEFAULT_UOM;
   IF (WK_DEFAULT_UOM IS NULL) THEN
   BEGIN
      WK_DEFAULT_UOM = 'EA';
   END
   IF (NEW.ORDER_UOM IS NULL OR NEW.ORDER_UOM = '') THEN
   BEGIN
      NEW.ORDER_UOM = WK_DEFAULT_UOM;
   END
   IF (NEW.INNER_UOM IS NULL OR NEW.INNER_UOM = '') THEN
   BEGIN
      NEW.ORDER_UOM = WK_DEFAULT_UOM;
   END
END ^

CREATE TRIGGER PURCHASE_DETAIL_DETAIL_ID FOR PURCHASE_LINE_DETAIL 
ACTIVE BEFORE INSERT POSITION 0 
AS
BEGIN
  IF (NEW.PURCHASE_DETAIL_ID IS NULL) THEN
      NEW.PURCHASE_DETAIL_ID = GEN_ID(PURCHASE_DETAIL_GEN, 1);
  IF (NEW.PURCHASE_DETAIL_ID = 0) THEN
      NEW.PURCHASE_DETAIL_ID = GEN_ID(PURCHASE_DETAIL_GEN, 1);
END ^

CREATE TRIGGER ADD_PO_LINE_DETAIL_TIME FOR PURCHASE_LINE_DETAIL 
ACTIVE BEFORE INSERT POSITION 20 
AS
BEGIN
   NEW.CREATE_DATE = 'NOW';
   NEW.LAST_UPDATE_DATE = 'NOW';
END ^

CREATE TRIGGER UPDATE_PO_LINE_DETAIL_TIME FOR PURCHASE_LINE_DETAIL 
ACTIVE BEFORE UPDATE POSITION 20 
AS
DECLARE VARIABLE WK_LEGACY_TRYS INTEGER;
DECLARE VARIABLE WK_PURCHASE_ORDER VARCHAR(15);
DECLARE VARIABLE WK_LEGACY_ID VARCHAR(50);
DECLARE VARIABLE WK_GOTO_DX CHAR(1);
BEGIN
   NEW.LAST_UPDATE_DATE = 'NOW';
   IF (NEW.PLD_LEGACY_TRY IS NULL) THEN
   BEGIN
      NEW.PLD_LEGACY_TRY = 0;
   END
   IF (NEW.PURCHASE_DETAIL_STATUS = 'Dl') THEN
   BEGIN
      SELECT LEGACY_TRYS FROM CONTROL INTO :WK_LEGACY_TRYS;
      IF (WK_LEGACY_TRYS IS NULL) THEN
      BEGIN
         WK_LEGACY_TRYS = 0;
      END
      NEW.PLD_LEGACY_TRY = NEW.PLD_LEGACY_TRY + 1;
      IF (NEW.PLD_LEGACY_TRY < :WK_LEGACY_TRYS) THEN
      BEGIN
         NEW.PURCHASE_DETAIL_STATUS = 'DL';
      END
   END
   IF (NEW.PURCHASE_DETAIL_STATUS = 'DL') THEN
   BEGIN
      WK_GOTO_DX = 'F';
      SELECT PO_LEGACY_INTERNAL_ID FROM PURCHASE_ORDER
      WHERE PURCHASE_ORDER  = NEW.PURCHASE_ORDER
      INTO :WK_LEGACY_ID;
      IF (WK_LEGACY_ID IS NULL ) THEN
      BEGIN
         WK_GOTO_DX = 'T';
      END
      IF (WK_LEGACY_ID = '') THEN
      BEGIN
         WK_GOTO_DX = 'T';
      END
      IF (WK_GOTO_DX = 'T') THEN
      BEGIN
         NEW.PURCHASE_DETAIL_STATUS = 'pa';
      END
   END
END ^

CREATE TRIGGER ADD_PURCHASE_TYPE FOR PURCHASE_ORDER 
ACTIVE BEFORE INSERT POSITION 2 
AS
DECLARE VARIABLE WK_ORDER_TYPE CHAR(2);
DECLARE VARIABLE WK_ORDER_COMPANY VARCHAR(20);
DECLARE VARIABLE WK_ORDER_STATUS CHAR(2);
DECLARE VARIABLE WK_FOUND INTEGER;
DECLARE VARIABLE WK_TEST_COMPANY VARCHAR(20);
DECLARE VARIABLE WK_TEST_COMPANY2 VARCHAR(20);
DECLARE VARIABLE WK_ORDER_NO VARCHAR(10);
BEGIN
   WK_ORDER_TYPE = '';
   WK_ORDER_COMPANY = '';
   WK_ORDER_STATUS = '';
   SELECT DEFAULT_PURCHASE_TYPE, COMPANY_ID, DEFAULT_PURCHASE_STATUS
   FROM CONTROL
   INTO :WK_ORDER_TYPE, :WK_ORDER_COMPANY, :WK_ORDER_STATUS;

   IF (NEW.ORDER_TYPE IS NULL) THEN
   BEGIN
      NEW.ORDER_TYPE = :WK_ORDER_TYPE;
   END
   IF (NEW.COMPANY_ID IS NULL) THEN
   BEGIN
      NEW.COMPANY_ID = :WK_ORDER_COMPANY;
   END
   IF (NEW.PO_STATUS IS NULL) THEN
   BEGIN
      NEW.PO_STATUS = :WK_ORDER_STATUS;
   END
   IF (NEW.PO_STATUS = '') THEN
   BEGIN
      NEW.PO_STATUS = :WK_ORDER_STATUS;
   END
   /* now check the company */
   WK_FOUND = 0;
   WK_TEST_COMPANY = NEW.COMPANY_ID;
   SELECT 1
   FROM COMPANY
   WHERE COMPANY_ID = :WK_TEST_COMPANY
   INTO :WK_FOUND;
   IF (WK_FOUND IS NULL) THEN
   BEGIN
      WK_FOUND = 0;
   END
   IF (WK_FOUND = 0) THEN
   BEGIN
      SELECT FIRST 1 1, COMPANY_ID
      FROM COMPANY
      WHERE NAME = :WK_TEST_COMPANY
      INTO :WK_FOUND, WK_TEST_COMPANY2;
      IF (WK_FOUND IS NULL) THEN
      BEGIN
         WK_FOUND = 0;
      END
      IF (WK_FOUND = 1) THEN
      BEGIN
         NEW.COMPANY_ID = WK_TEST_COMPANY2;
      END
   END
   IF (WK_FOUND = 0) THEN
   BEGIN
      NEW.COMPANY_ID = :WK_ORDER_COMPANY;
   END
   IF ((NEW.PURCHASE_ORDER IS NULL) OR (NEW.PURCHASE_ORDER = '') OR (NEW.PURCHASE_ORDER = '0')) THEN
   BEGIN
     WK_ORDER_NO = '';
     SELECT ORDER_ID FROM  GET_PO_ORDER_NO (NEW.ORDER_TYPE)
     INTO :WK_ORDER_NO;
     NEW.PURCHASE_ORDER = :WK_ORDER_NO;
   END
END ^

CREATE TRIGGER MOD_PURCHASE_TYPE FOR PURCHASE_ORDER 
ACTIVE BEFORE UPDATE POSITION 2 
AS
DECLARE VARIABLE WK_ORDER_TYPE CHAR(2);
DECLARE VARIABLE WK_ORDER_COMPANY VARCHAR(20);
DECLARE VARIABLE WK_ORDER_STATUS CHAR(2);
DECLARE VARIABLE WK_FOUND INTEGER;
DECLARE VARIABLE WK_TEST_COMPANY VARCHAR(20);
DECLARE VARIABLE WK_TEST_COMPANY2 VARCHAR(20);
DECLARE VARIABLE WK_ORDER_NO VARCHAR(10);
BEGIN
   WK_ORDER_TYPE = '';
   WK_ORDER_COMPANY = '';
   WK_ORDER_STATUS = '';
   SELECT DEFAULT_PURCHASE_TYPE, COMPANY_ID, DEFAULT_PURCHASE_STATUS
   FROM CONTROL
   INTO :WK_ORDER_TYPE, :WK_ORDER_COMPANY, :WK_ORDER_STATUS;

   IF (NEW.ORDER_TYPE IS NULL) THEN
   BEGIN
      NEW.ORDER_TYPE = :WK_ORDER_TYPE;
   END
   IF (NEW.COMPANY_ID IS NULL) THEN
   BEGIN
      NEW.COMPANY_ID = :WK_ORDER_COMPANY;
   END
   IF (NEW.PO_STATUS IS NULL) THEN
   BEGIN
      NEW.PO_STATUS = :WK_ORDER_STATUS;
   END
   IF (NEW.PO_STATUS = '') THEN
   BEGIN
      NEW.PO_STATUS = :WK_ORDER_STATUS;
   END
   /* now check the company */
   WK_FOUND = 0;
   WK_TEST_COMPANY = NEW.COMPANY_ID;
   SELECT 1
   FROM COMPANY
   WHERE COMPANY_ID = :WK_TEST_COMPANY
   INTO :WK_FOUND;
   IF (WK_FOUND IS NULL) THEN
   BEGIN
      WK_FOUND = 0;
   END
   IF (WK_FOUND = 0) THEN
   BEGIN
      SELECT FIRST 1 1, COMPANY_ID
      FROM COMPANY
      WHERE NAME = :WK_TEST_COMPANY
      INTO :WK_FOUND, WK_TEST_COMPANY2;
      IF (WK_FOUND IS NULL) THEN
      BEGIN
         WK_FOUND = 0;
      END
      IF (WK_FOUND = 1) THEN
      BEGIN
         NEW.COMPANY_ID = WK_TEST_COMPANY2;
      END
   END
   IF (WK_FOUND = 0) THEN
   BEGIN
      NEW.COMPANY_ID = :WK_ORDER_COMPANY;
   END
   IF ((NEW.PURCHASE_ORDER IS NULL) OR (NEW.PURCHASE_ORDER = '') OR (NEW.PURCHASE_ORDER = '0')) THEN
   BEGIN
     WK_ORDER_NO = '';
     SELECT ORDER_ID FROM  GET_PO_ORDER_NO (NEW.ORDER_TYPE)
     INTO :WK_ORDER_NO;
     NEW.PURCHASE_ORDER = :WK_ORDER_NO;
   END
END ^

CREATE TRIGGER SAVE_PURCHASE_ORDER FOR PURCHASE_ORDER 
ACTIVE BEFORE DELETE POSITION 0 
AS
DECLARE VARIABLE WK_SAVE_PURCHASE_ITEM CHAR(1);
BEGIN
   BEGIN
      INSERT INTO PURCHASE_LINE_CANCEL(
        PURCHASE_ORDER ,
        PERSON_ID ,
        REQUISITION_NO ,
        PO_DATE ,
        PO_REVISION_NO ,
        COMPANY_ID ,
        DIVISION_ID ,
        PO_STATUS ,
        COMMENTS ,
        PO_PRINTED ,
        USER_ID ,
        ORDER_TYPE ,
        PO_LEGACY_DATE ,
        PO_CURRENCY ,
        PO_DUE_DATE ,
        PO_LEGACY_INTERNAL_ID ,
        PO_RECEIVE_WH_ID ,
        PO_LEGACY_MEMO ,
        PO_LEGACY_STATUS ,
        PO_LEGACY_RECVD_DATE ,
        PO_SHIP_TO_ADDRESS3 ,
        PO_SHIP_TO_ADDRESS4 ,
        PO_SHIP_TO_ADDRESS5 ,
        PO_CREATED_BY_NAME ,
        PO_RECEIVE_WH_NAME ,
        PO_LEGACY_STATUS_ID ,
        PO_SHIP_TO_ATTENSION ,
        PO_SHIP_TO_ADDRESSEE ,
        PO_SHIP_TO_PHONE ,
        PO_SHIP_TO_ADDRESS1 ,
        PO_SHIP_TO_ADDRESS2 ,
        PO_SHIP_TO_SUBURB ,
        PO_SHIP_TO_STATE ,
        PO_SHIP_TO_POSTCODE ,
        PO_SHIP_TO_COUNTRY ,
        PO_LEGACY_CONSIGNMENT ,
        PO_LEGACY_CREATED_BY_NAME ,
        PO_LEGACY_OWNER ,
        PO_LEGACY_OWNER_ID ,
        PO_LEGACY_RECV_ID ,
        PO_RECEIVER ,
        EARLIEST_DATE ,
        COST_CENTER ,
        PO_LEGACY_RECVD_QTY ,
        SUPPLIED_BY_ID ,
        SUPPLIER_CONTACT ,
        PO_SHIP_VIA ,
        PO_SHIP_VIA_SERVICE ,
        PO_SHIPPING_METHOD ,
        PO_FREIGHT_COST ,
        PO_CUSTOM_FEES ,
        PO_STORAGE_FEES ,
        PO_INSURANCE ,
        PO_AMOUNT_PAID ,
        PO_CONTAINER_FEES ,
        PO_UNLOADING_FEES ,
        PO_ADMIN_FEES ,
        PO_OTHER_FEES ,
        PO_TAX_AMOUNT ,
        PO_TAX_RATE ,
        PO_AMOUNT_DUE ,
        PO_LINE_EXTERNAL_NOTES ,
        REASON ,
        CANCEL_METHOD )
      VALUES (
        OLD.PURCHASE_ORDER ,
        OLD.PERSON_ID ,
        OLD.REQUISITION_NO ,
        OLD.PO_DATE ,
        OLD.PO_REVISION_NO ,
        OLD.COMPANY_ID ,
        OLD.DIVISION_ID ,
        OLD.PO_STATUS ,
        OLD.COMMENTS ,
        OLD.PO_PRINTED ,
        OLD.USER_ID ,
        OLD.ORDER_TYPE ,
        OLD.PO_LEGACY_DATE ,
        OLD.PO_CURRENCY ,
        OLD.PO_DUE_DATE ,
        OLD.PO_LEGACY_INTERNAL_ID ,
        OLD.PO_RECEIVE_WH_ID ,
        OLD.PO_LEGACY_MEMO ,
        OLD.PO_LEGACY_STATUS ,
        OLD.PO_LEGACY_RECVD_DATE ,
        OLD.PO_SHIP_TO_ADDRESS3 ,
        OLD.PO_SHIP_TO_ADDRESS4 ,
        OLD.PO_SHIP_TO_ADDRESS5 ,
        OLD.PO_CREATED_BY_NAME ,
        OLD.PO_RECEIVE_WH_NAME ,
        OLD.PO_LEGACY_STATUS_ID ,
        OLD.PO_SHIP_TO_ATTENSION ,
        OLD.PO_SHIP_TO_ADDRESSEE ,
        OLD.PO_SHIP_TO_PHONE ,
        OLD.PO_SHIP_TO_ADDRESS1 ,
        OLD.PO_SHIP_TO_ADDRESS2 ,
        OLD.PO_SHIP_TO_SUBURB ,
        OLD.PO_SHIP_TO_STATE ,
        OLD.PO_SHIP_TO_POSTCODE ,
        OLD.PO_SHIP_TO_COUNTRY ,
        OLD.PO_LEGACY_CONSIGNMENT ,
        OLD.PO_LEGACY_CREATED_BY_NAME ,
        OLD.PO_LEGACY_OWNER ,
        OLD.PO_LEGACY_OWNER_ID ,
        OLD.PO_LEGACY_RECV_ID ,
        OLD.PO_RECEIVER ,
        OLD.EARLIEST_DATE ,
        OLD.COST_CENTER ,
        OLD.PO_LEGACY_RECVD_QTY ,
        OLD.SUPPLIED_BY_ID ,
        OLD.SUPPLIER_CONTACT ,
        OLD.PO_SHIP_VIA ,
        OLD.PO_SHIP_VIA_SERVICE ,
        OLD.PO_SHIPPING_METHOD ,
        OLD.PO_FREIGHT_COST ,
        OLD.PO_CUSTOM_FEES ,
        OLD.PO_STORAGE_FEES ,
        OLD.PO_INSURANCE ,
        OLD.PO_AMOUNT_PAID ,
        OLD.PO_CONTAINER_FEES ,
        OLD.PO_UNLOADING_FEES ,
        OLD.PO_ADMIN_FEES ,
        OLD.PO_OTHER_FEES ,
        OLD.PO_TAX_AMOUNT ,
        OLD.PO_TAX_RATE ,
        OLD.PO_AMOUNT_DUE ,
        OLD.PO_LINE_EXTERNAL_NOTES ,
        'Purchase Order Record Deleted' ,
        'o' );
   END
END ^

CREATE TRIGGER ADD_PURCHASE_LINE_STATUS FOR PURCHASE_ORDER_LINE 
ACTIVE BEFORE INSERT POSITION 2 
AS
DECLARE VARIABLE WK_ORDER_STATUS VARCHAR(40);
DECLARE VARIABLE WK_ORDER_CONNOTE VARCHAR(50);
DECLARE VARIABLE WK_ORDER_ID     VARCHAR(20);
DECLARE VARIABLE WK_LAST_LINE VARCHAR(10);
DECLARE VARIABLE WK_LAST_LINE_I INTEGER;
DECLARE VARIABLE WK_CHECK_LINE INTEGER;
DECLARE VARIABLE WK_NEW_LINE INTEGER;
DECLARE VARIABLE WK_PROD_ID     VARCHAR(30);
DECLARE VARIABLE WK_FOUND INTEGER;
DECLARE VARIABLE WK_OLD_NOTE BLOB ;
DECLARE VARIABLE WK_NOTE_STR2 VARCHAR(32000);
DECLARE VARIABLE WK_START_POSN INTEGER;
DECLARE VARIABLE WK_END_POSN INTEGER;
DECLARE VARIABLE WK_LEN_TOGET INTEGER;
BEGIN
   WK_ORDER_STATUS = '';
   SELECT DEFAULT_PURCHASE_STATUS
   FROM CONTROL
   INTO :WK_ORDER_STATUS ;

   WK_ORDER_ID = NEW.PURCHASE_ORDER;

   IF (NEW.PO_LINE_STATUS IS NULL) THEN
   BEGIN
      NEW.PO_LINE_STATUS = :WK_ORDER_STATUS;
   END
   IF (NEW.PO_LINE_STATUS = '') THEN
   BEGIN
      NEW.PO_LINE_STATUS = :WK_ORDER_STATUS;
   END
   IF (NEW.LAST_UPDATE_DATE IS NULL) THEN
   BEGIN
      NEW.LAST_UPDATE_DATE = 'NOW';
   END
   IF ((NEW.UOM_ORDER IS NULL) OR (NEW.UOM_ORDER = '')) THEN
   BEGIN
      NEW.UOM_ORDER = 'EA';
   END
   IF ((NEW.PO_LINE_QTY IS NOT NULL) AND (NEW.ORIGINAL_QTY IS NULL)) THEN
   BEGIN
      NEW.ORIGINAL_QTY = NEW.PO_LINE_QTY;
   END
   IF ((NEW.UOM_ORDER IS NULL) OR (NEW.UOM_ORDER = '')) THEN
   BEGIN
      NEW.UOM_ORDER = 'EA';
   END
   /* check line no */
   SELECT PO_LEGACY_CONSIGNMENT
   FROM PURCHASE_ORDER
   WHERE PURCHASE_ORDER = :WK_ORDER_ID
   INTO :WK_ORDER_CONNOTE;

   IF (WK_ORDER_CONNOTE IS NOT NULL) THEN
   BEGIN
      IF (WK_ORDER_CONNOTE <> '') THEN
      BEGIN
         /* must calc the line no to use for this order
            is the next line for this connote  */
         SELECT MAX(PURCHASE_ORDER_LINE.PO_LINE),COUNT(*) 
         FROM PURCHASE_ORDER 
         JOIN PURCHASE_ORDER_LINE ON PURCHASE_ORDER_LINE.PURCHASE_ORDER = PURCHASE_ORDER.PURCHASE_ORDER 
         WHERE PURCHASE_ORDER.PO_LEGACY_CONSIGNMENT = :WK_ORDER_CONNOTE
         INTO :WK_LAST_LINE, :WK_CHECK_LINE;
         IF (WK_LAST_LINE IS NULL) THEN
         BEGIN
            WK_LAST_LINE = '0';
         END
         IF (WK_CHECK_LINE IS NULL) THEN
         BEGIN
            WK_CHECK_LINE = 0;
         END
         WK_LAST_LINE_I = :WK_LAST_LINE;
         IF (WK_CHECK_LINE > WK_LAST_LINE_I) THEN
         BEGIN
            WK_LAST_LINE_I = WK_CHECK_LINE;
         END
         WK_NEW_LINE = WK_LAST_LINE_I + 1;
         NEW.PO_LINE = WK_NEW_LINE;
      END
   END
   /* check that the prod exists */
   WK_PROD_ID = NEW.PROD_ID;
   WK_FOUND = 0;
   SELECT 1 FROM PROD_PROFILE
   WHERE PROD_ID = :WK_PROD_ID
   INTO :WK_FOUND;
   IF (WK_FOUND IS NULL) THEN
   BEGIN
      WK_FOUND = 0;
   END
   IF (WK_FOUND = 0) THEN
   BEGIN
      WK_OLD_NOTE = NEW.PO_LINE_DESCRIPTION;
      IF (WK_OLD_NOTE IS NULL) THEN
      BEGIN
         WK_NOTE_STR2 = NEW.PROD_ID;
      END 
      ELSE
      BEGIN
         WK_START_POSN = 1;
         WK_END_POSN = BLOB_BYTECOUNT(:WK_OLD_NOTE);
         WK_LEN_TOGET = WK_END_POSN - WK_START_POSN + 1;
         IF (WK_LEN_TOGET > 50) THEN
         BEGIN
            WK_LEN_TOGET = 50;
         END
         WK_NOTE_STR2 = BLOB_SUBSTR(:WK_OLD_NOTE, :WK_START_POSN, :WK_START_POSN + :WK_LEN_TOGET);
      END
      INSERT INTO PROD_PROFILE (PROD_ID,SHORT_DESC, LONG_DESC) VALUES (NEW.PROD_ID, :WK_NOTE_STR2, :WK_NOTE_STR2);
   END
END ^

CREATE TRIGGER MOD_PURCHASE_LINE_DATE FOR PURCHASE_ORDER_LINE 
ACTIVE BEFORE UPDATE POSITION 2 
AS
DECLARE VARIABLE WK_PO_STATUS CHAR(2);
DECLARE VARIABLE WK_PO_ORDER VARCHAR(10);
DECLARE VARIABLE WK_POL_LINE CHAR(4);
DECLARE VARIABLE WK_MORE_LINES CHAR(4);
DECLARE VARIABLE WK_PROD_ID     VARCHAR(30);
DECLARE VARIABLE WK_FOUND INTEGER;
DECLARE VARIABLE WK_OLD_NOTE BLOB ;
DECLARE VARIABLE WK_NOTE_STR2 VARCHAR(32000);
DECLARE VARIABLE WK_START_POSN INTEGER;
DECLARE VARIABLE WK_END_POSN INTEGER;
DECLARE VARIABLE WK_LEN_TOGET INTEGER;
DECLARE VARIABLE WK_ORDER_STATUS VARCHAR(40);
BEGIN
   NEW.LAST_UPDATE_DATE = 'NOW';
   IF ((NEW.PO_LINE_QTY IS NOT NULL) AND (NEW.ORIGINAL_QTY IS NULL)) THEN
   BEGIN
      NEW.ORIGINAL_QTY = NEW.PO_LINE_QTY;
   END
   WK_ORDER_STATUS = '';
   SELECT DEFAULT_PURCHASE_STATUS
   FROM CONTROL
   INTO :WK_ORDER_STATUS ;
   IF (NEW.PO_LINE_STATUS IS NULL) THEN
   BEGIN
      NEW.PO_LINE_STATUS = :WK_ORDER_STATUS;
   END
   IF (NEW.PO_LINE_STATUS = '') THEN
   BEGIN
      NEW.PO_LINE_STATUS = :WK_ORDER_STATUS;
   END
   /* check order status */
   IF (NEW.PO_LINE_STATUS = 'CL' OR
       NEW.PO_LINE_STATUS = 'OS')  THEN
   BEGIN
      /* get the orders po_status */
      WK_PO_STATUS = '';
      WK_PO_ORDER = NEW.PURCHASE_ORDER;
      WK_POL_LINE = NEW.PO_LINE;
      SELECT PO_STATUS
      FROM PURCHASE_ORDER
      WHERE PURCHASE_ORDER = :WK_PO_ORDER
      INTO :WK_PO_STATUS;
      IF (WK_PO_STATUS = 'OP' OR
          WK_PO_STATUS = 'CF') THEN
      BEGIN
         /* are there any cf or op lines on this order */
         WK_MORE_LINES = '';
         SELECT FIRST 1 PO_LINE
         FROM PURCHASE_ORDER_LINE
         WHERE PURCHASE_ORDER = :WK_PO_ORDER
         AND PO_LINE <> :WK_POL_LINE
         AND PO_LINE_STATUS IN ('OP','CF')
         INTO :WK_MORE_LINES;
         IF (WK_MORE_LINES IS NULL) THEN
         BEGIN
            WK_MORE_LINES = '';
         END
         IF (WK_MORE_LINES = '') THEN
         BEGIN
            /* update purchase_order.po_status to 'CL' */
            UPDATE PURCHASE_ORDER
            SET PO_STATUS = 'CL'
            WHERE PURCHASE_ORDER = :WK_PO_ORDER;
         END
      END
   END
   /* check that the prod exists */
   WK_PROD_ID = NEW.PROD_ID;
   WK_FOUND = 0;
   SELECT 1 FROM PROD_PROFILE
   WHERE PROD_ID = :WK_PROD_ID
   INTO :WK_FOUND;
   IF (WK_FOUND IS NULL) THEN
   BEGIN
      WK_FOUND = 0;
   END
   IF (WK_FOUND = 0) THEN
   BEGIN
      WK_OLD_NOTE = NEW.PO_LINE_DESCRIPTION;
      IF (WK_OLD_NOTE IS NULL) THEN
      BEGIN
         WK_NOTE_STR2 = NEW.PROD_ID;
      END 
      ELSE
      BEGIN
         WK_START_POSN = 1;
         WK_END_POSN = BLOB_BYTECOUNT(:WK_OLD_NOTE);
         WK_LEN_TOGET = WK_END_POSN - WK_START_POSN + 1;
         IF (WK_LEN_TOGET > 50) THEN
         BEGIN
            WK_LEN_TOGET = 50;
         END
         WK_NOTE_STR2 = BLOB_SUBSTR(:WK_OLD_NOTE, :WK_START_POSN, :WK_START_POSN + :WK_LEN_TOGET);
      END
      INSERT INTO PROD_PROFILE (PROD_ID,SHORT_DESC, LONG_DESC) VALUES (NEW.PROD_ID, :WK_NOTE_STR2, :WK_NOTE_STR2);
   END
END ^

CREATE TRIGGER SAVE_PURCHASE_ORDER_LINE FOR PURCHASE_ORDER_LINE 
ACTIVE BEFORE DELETE POSITION 0 
AS
DECLARE VARIABLE WK_SAVE_PURCHASE_ITEM CHAR(1);
BEGIN
   BEGIN
      INSERT INTO PURCHASE_LINE_CANCEL(
        PURCHASE_ORDER ,
        PO_LINE ,
        REQUISITION_NO ,
        PROD_ID ,
        PO_LINE_QTY ,
        UNIT_PRICE ,
        UOM_ORDER ,
        PO_LINE_DUE_DATE ,
        PO_LINE_STATUS ,
        COMMENTS ,
        GST_VALUE ,
        GST_RATE ,
        GST_CODE ,
        ORIGINAL_QTY ,
        PO_LINE_DESCRIPTION ,
        PO_LINE_OPTIONS ,
        PO_LINE_QTY_F ,
        PO_LINE_LOTNO_LIST ,
        PO_LINE_STATUS_TF ,
        PO_LINE_CUSTOMER_ID ,
        PO_LINE_CUSTOMER_NAME ,
        PO_CURRENCY ,
        LAST_UPDATE_DATE ,
        PO_LEGACY_RECV_ID ,
        PO_REVISION_STATUS ,
        PO_LEGACY_LINE ,
        EARLIEST_DATE ,
        PO_LINE_EXTERNAL_NOTES ,
        PO_LINE_DISCOUNT ,
        PO_LINE_TOTAL ,
        LAST_UPDATE_BY ,
        REASON ,
        CANCEL_METHOD )
      VALUES (
        OLD.PURCHASE_ORDER ,
        OLD.PO_LINE ,
        OLD.REQUISITION_NO ,
        OLD.PROD_ID ,
        OLD.PO_LINE_QTY ,
        OLD.UNIT_PRICE ,
        OLD.UOM_ORDER ,
        OLD.PO_LINE_DUE_DATE ,
        OLD.PO_LINE_STATUS ,
        OLD.COMMENTS ,
        OLD.GST_VALUE ,
        OLD.GST_RATE ,
        OLD.GST_CODE ,
        OLD.ORIGINAL_QTY ,
        OLD.PO_LINE_DESCRIPTION ,
        OLD.PO_LINE_OPTIONS ,
        OLD.PO_LINE_QTY_F ,
        OLD.PO_LINE_LOTNO_LIST ,
        OLD.PO_LINE_STATUS_TF ,
        OLD.PO_LINE_CUSTOMER_ID ,
        OLD.PO_LINE_CUSTOMER_NAME ,
        OLD.PO_CURRENCY ,
        OLD.LAST_UPDATE_DATE ,
        OLD.PO_LEGACY_RECV_ID ,
        OLD.PO_REVISION_STATUS ,
        OLD.PO_LEGACY_LINE ,
        OLD.EARLIEST_DATE ,
        OLD.PO_LINE_EXTERNAL_NOTES ,
        OLD.PO_LINE_DISCOUNT ,
        OLD.PO_LINE_TOTAL ,
        OLD.LAST_UPDATE_BY ,
        'Purchase Order Line Record Deleted' ,
        'l' );
   END
END ^

CREATE TRIGGER ADD_PURCHASE_FROM_TEMP FOR PURCHASE_ORDER_LINE_TEMP 
ACTIVE BEFORE INSERT POSITION 0 
AS
DECLARE VARIABLE WK_FOUND INTEGER;
DECLARE VARIABLE WK_H_PERSON_ID VARCHAR(10); 
DECLARE VARIABLE WK_P_PERSON_TYPE CHAR(2);
DECLARE VARIABLE WK_P_FIRST_NAME VARCHAR(50); 
DECLARE VARIABLE WK_P_LAST_NAME VARCHAR(50); 
DECLARE VARIABLE WK_P_ADDRESS_LINE1 VARCHAR(100); 
DECLARE VARIABLE WK_P_ADDRESS_LINE2 VARCHAR(50); 
DECLARE VARIABLE WK_P_CITY VARCHAR(25); 
DECLARE VARIABLE WK_P_STATE VARCHAR(15); 
DECLARE VARIABLE WK_P_POST_CODE VARCHAR(10); 
DECLARE VARIABLE WK_P_COUNTRY VARCHAR(25);

DECLARE VARIABLE WK_H_PURCHASE_ORDER VARCHAR(10);
DECLARE VARIABLE WK_H_REQUISITION_NO VARCHAR(10) ; 
DECLARE VARIABLE WK_H_PO_DATE        TIMESTAMP ; 
DECLARE VARIABLE WK_H_PO_REVISION_NO CHAR(2) ; 
DECLARE VARIABLE WK_H_PO_STATUS      CHAR(2) ; 
DECLARE VARIABLE WK_H_COMMENTS       VARCHAR(512) ; 
DECLARE VARIABLE WK_H_PO_PRINTED     TIMESTAMP ; 
DECLARE VARIABLE WK_H_USER_ID        VARCHAR(10) ; 
DECLARE VARIABLE WK_H_COMPANY_ID     VARCHAR(20);
DECLARE VARIABLE WK_H_DIVISION_ID    VARCHAR(20);
DECLARE VARIABLE WK_H_ORDER_TYPE     CHAR(2);
DECLARE VARIABLE WK_H_COST_CENTER    VARCHAR(40);
DECLARE VARIABLE WK_H_LEGACY_MEMO    VARCHAR(1024);
DECLARE VARIABLE WK_H_LEGACY_RECEIVE_WH_NAME  VARCHAR(50);
DECLARE VARIABLE WK_H_LEGACY_DATE    TIMESTAMP ; 
DECLARE VARIABLE WK_H_DUE_DATE       TIMESTAMP ; 
DECLARE VARIABLE WK_H_LEGACY_RECV_QTY INTEGER;
DECLARE VARIABLE WK_H_LEGACY_RECV_DATE TIMESTAMP ; 

DECLARE VARIABLE WK_L_PURCHASE_ORDER  VARCHAR(10);
DECLARE VARIABLE WK_L_PO_LINE         CHAR(4);
DECLARE VARIABLE WK_L_REQUISITION_NO  VARCHAR(10) ; 
DECLARE VARIABLE WK_L_PROD_ID         VARCHAR(30) ; 
DECLARE VARIABLE WK_L_PO_LINE_QTY     NUMERIC(18, 0) ; 
DECLARE VARIABLE WK_L_UNIT_PRICE      NUMERIC(9, 3) ; 
DECLARE VARIABLE WK_L_UOM_ORDER       CHAR(2) ; 
DECLARE VARIABLE WK_L_PO_LINE_DUE_DATE TIMESTAMP ; 
DECLARE VARIABLE WK_L_PO_LINE_STATUS  CHAR(2) ; 
DECLARE VARIABLE WK_L_COMMENTS        VARCHAR(512) ; 
DECLARE VARIABLE WK_L_GST_VALUE       INTEGER ; 
DECLARE VARIABLE WK_L_GST_RATE        INTEGER ; 
DECLARE VARIABLE WK_L_GST_CODE        VARCHAR(3) ; 
DECLARE VARIABLE WK_L_LINE_CNT        INTEGER ; 
DECLARE VARIABLE WK_LEN_LABEL_NO      INTEGER; 
DECLARE VARIABLE WK_PROD_LENGTH       INTEGER;
DECLARE VARIABLE WK_PROD_FIXED        CHAR(1);
DECLARE VARIABLE WK_PURCHASE_LENGTH   INTEGER;
DECLARE VARIABLE WK_PURCHASE_FIXED    CHAR(1);
DECLARE VARIABLE WK_PURCHASE_ORDER    VARCHAR(10); 
DECLARE VARIABLE WK_PP_SHORT_DESC     VARCHAR(50);
DECLARE VARIABLE WK_PP_UOM            CHAR(2);
DECLARE VARIABLE WK_PP_ISSUE_UOM      INTEGER;
DECLARE VARIABLE WK_RESULT            INTEGER;
DECLARE VARIABLE WK_H_PO_RECEIVE_WH_ID CHAR(2) ; 
BEGIN
   BEGIN
      NEW.RECORD_ID  = GEN_ID(TEMP_ID_GEN ,1);
   END
   WK_H_PERSON_ID  = NEW.H_PERSON_ID;
   WK_P_PERSON_TYPE = NEW.P_PERSON_TYPE;
   WK_P_FIRST_NAME = NEW.P_FIRST_NAME;
   WK_P_LAST_NAME = NEW.P_LAST_NAME;
   WK_P_ADDRESS_LINE1 = NEW.P_ADDRESS_LINE1;
   WK_P_ADDRESS_LINE2 = NEW.P_ADDRESS_LINE2;
   WK_P_CITY = NEW.P_CITY;
   WK_P_STATE = NEW.P_STATE;
   WK_P_POST_CODE = NEW.P_POST_CODE;
   WK_P_COUNTRY = NEW.P_COUNTRY;

   WK_H_PURCHASE_ORDER = NEW.H_PURCHASE_ORDER ;
   WK_H_REQUISITION_NO = NEW.H_REQUISITION_NO ;
   WK_H_PO_DATE        = NEW.H_PO_DATE        ;
   WK_H_PO_REVISION_NO = NEW.H_PO_REVISION_NO ;
   WK_H_PO_STATUS      = NEW.H_PO_STATUS      ;
   WK_H_COMMENTS       = NEW.H_COMMENTS       ;
   WK_H_PO_PRINTED     = NEW.H_PO_PRINTED     ;
   WK_H_USER_ID        = NEW.H_USER_ID        ;
   WK_H_COMPANY_ID = NEW.H_COMPANY_ID;
   WK_H_DIVISION_ID = NEW.H_DIVISION_ID;
   WK_H_COST_CENTER = NEW.H_COST_CENTER;
   WK_H_LEGACY_MEMO = NEW.H_PO_LEGACY_MEMO;
   WK_H_LEGACY_RECEIVE_WH_NAME = NEW.H_PO_LEGACY_RECEIVE_WH_NAME;
   WK_H_LEGACY_DATE = NEW.H_PO_LEGACY_DATE;
   WK_H_DUE_DATE = NEW.H_PO_DUE_DATE;
   WK_H_LEGACY_RECV_DATE = NEW.H_PO_LEGACY_RECV_DATE;
   WK_H_LEGACY_RECV_QTY  = NEW.H_PO_LEGACY_RECV_QTY;
   WK_H_PO_RECEIVE_WH_ID = NEW.H_PO_RECEIVE_WH_ID;
   IF (NEW.H_ORDER_TYPE IS NULL) THEN
   BEGIN
      WK_H_ORDER_TYPE = 'PO';
   END
   ELSE
   BEGIN
      WK_H_ORDER_TYPE = NEW.H_ORDER_TYPE;
   END
   IF (WK_H_PO_RECEIVE_WH_ID IS NULL) THEN
   BEGIN
      SELECT DEFAULT_WH_ID
      FROM CONTROL
      INTO :WK_H_PO_RECEIVE_WH_ID;
   END

   WK_L_PURCHASE_ORDER  = NEW.L_PURCHASE_ORDER  ;
   WK_L_PO_LINE         = NEW.L_PO_LINE         ;
   WK_L_REQUISITION_NO  = NEW.L_REQUISITION_NO  ;
   WK_L_PROD_ID         = NEW.L_PROD_ID         ;
   WK_L_PO_LINE_QTY     = NEW.L_PO_LINE_QTY     ;
   WK_L_UNIT_PRICE      = NEW.L_UNIT_PRICE      ;
   WK_L_UOM_ORDER       = NEW.L_UOM_ORDER       ;
   WK_L_PO_LINE_DUE_DATE = NEW.L_PO_LINE_DUE_DATE ;
   WK_L_PO_LINE_STATUS  = NEW.L_PO_LINE_STATUS  ;
   WK_L_COMMENTS        = NEW.L_COMMENTS        ;
   WK_L_GST_VALUE       = NEW.L_GST_VALUE       ;
   WK_L_GST_RATE        = NEW.L_GST_RATE        ;
   WK_L_GST_CODE        = NEW.L_GST_CODE        ;

   WK_PP_SHORT_DESC     = NEW.PP_SHORT_DESC;
   WK_PP_UOM            = 'EA';
   WK_PP_ISSUE_UOM      = 1;        
   /* Check person */
   IF (WK_H_PERSON_ID IS NULL) THEN
   BEGIN
      WK_H_PERSON_ID = '';
   END
   IF (WK_H_PERSON_ID = '') THEN
   BEGIN
      SELECT FIRST 1 PERSON_ID 
         FROM PERSON 
         WHERE FIRST_NAME = :WK_P_FIRST_NAME
         AND   PERSON_TYPE = :WK_P_PERSON_TYPE
         INTO :WK_H_PERSON_ID;
      IF (WK_H_PERSON_ID IS NULL) THEN
      BEGIN
         WK_H_PERSON_ID = '';
      END
      IF (WK_H_PERSON_ID = '') THEN
      BEGIN
         /* no person so must create an id */
         /* use 1st 7 bytes of name and numeric 3 which is the count of names */
         WK_H_PERSON_ID = SUBSTR(WK_P_FIRST_NAME, 1, 7);
         WK_FOUND = 0;
         SELECT COUNT(*)
         FROM PERSON
         WHERE PERSON_ID STARTING  :WK_H_PERSON_ID 
         INTO :WK_FOUND;
         IF (WK_FOUND IS NULL) THEN
         BEGIN
            WK_FOUND = 0;
         END
         WK_FOUND = WK_FOUND + 1;
         WK_H_PERSON_ID = :WK_H_PERSON_ID || :WK_FOUND;
      END
   END
   /* Check person */
   WK_FOUND = 0;
   SELECT 1 FROM PERSON 
      WHERE PERSON_ID = :WK_H_PERSON_ID
      INTO :WK_FOUND;
   IF (WK_FOUND = 0) THEN
   BEGIN
      /* no person so insert it */
      INSERT INTO PERSON (PERSON_ID, PERSON_TYPE, FIRST_NAME, LAST_NAME, ADDRESS_LINE1, ADDRESS_LINE2, CITY, STATE, POST_CODE, COUNTRY )
      VALUES (:WK_H_PERSON_ID, :WK_P_PERSON_TYPE, :WK_P_FIRST_NAME, :WK_P_LAST_NAME, :WK_P_ADDRESS_LINE1, :WK_P_ADDRESS_LINE2, :WK_P_CITY, :WK_P_STATE, :WK_P_POST_CODE, :WK_P_COUNTRY);
   END
   ELSE
   BEGIN
      UPDATE PERSON  SET PERSON_TYPE = :WK_P_PERSON_TYPE, 
         FIRST_NAME = :WK_P_FIRST_NAME, 
         LAST_NAME = :WK_P_LAST_NAME, 
         ADDRESS_LINE1 = :WK_P_ADDRESS_LINE1, 
         ADDRESS_LINE2 = :WK_P_ADDRESS_LINE2, 
         CITY = :WK_P_CITY, 
         STATE = :WK_P_STATE, 
         POST_CODE = :WK_P_POST_CODE, 
         COUNTRY = :WK_P_COUNTRY 
       WHERE PERSON_ID = :WK_H_PERSON_ID;
   END
   WK_FOUND = 0;
   /* Get length for purchase */   
   SELECT MAX_LENGTH, FIXED_LENGTH
   FROM PARAM
   WHERE DATA_ID = 'PURCHASE'
   INTO :WK_PURCHASE_LENGTH, :WK_PURCHASE_FIXED;
   IF (WK_PURCHASE_LENGTH IS NULL) THEN
   BEGIN
      WK_PURCHASE_LENGTH = 0;
   END
   IF (WK_PURCHASE_FIXED IS NULL) THEN
   BEGIN
      WK_PURCHASE_FIXED = 'F';
   END
   IF (SUBSTR(WK_H_PURCHASE_ORDER,1,1) <> 'P') THEN
   BEGIN
      IF (WK_PURCHASE_FIXED = 'T') THEN
      BEGIN
         WK_PURCHASE_ORDER = WK_H_PURCHASE_ORDER;
         WK_H_PURCHASE_ORDER = 'P' ; 
         WK_LEN_LABEL_NO = STRLEN(WK_PURCHASE_ORDER) + 1 ;     
         /* Padding leading with 0 */
         WHILE (WK_LEN_LABEL_NO < :WK_PURCHASE_LENGTH) DO
         BEGIN
            WK_H_PURCHASE_ORDER= WK_H_PURCHASE_ORDER || '0';      
            WK_LEN_LABEL_NO = WK_LEN_LABEL_NO + 1;
         END
         IF (STRLEN(WK_PURCHASE_ORDER) >= WK_PURCHASE_LENGTH) THEN
         BEGIN
            WK_H_PURCHASE_ORDER=  WK_PURCHASE_ORDER;       
         END
         ELSE
         BEGIN
            WK_H_PURCHASE_ORDER= WK_H_PURCHASE_ORDER || WK_PURCHASE_ORDER;       
         END
      END
   END
   WK_L_PURCHASE_ORDER = WK_H_PURCHASE_ORDER ;
   IF (NEW.L_PURCHASE_ORDER IS NULL) THEN
   BEGIN
      NEW.L_PURCHASE_ORDER = WK_L_PURCHASE_ORDER;
   END

   SELECT 1 FROM PURCHASE_ORDER
      WHERE PURCHASE_ORDER = :WK_H_PURCHASE_ORDER
      INTO :WK_FOUND;
   IF (WK_FOUND = 0) THEN
   BEGIN
      /* no order so insert it */
      INSERT INTO PURCHASE_ORDER (
         PURCHASE_ORDER, 
         REQUISITION_NO,
         PO_DATE,      
         PO_REVISION_NO,
         PO_STATUS,    
         COMMENTS,    
         PO_PRINTED, 
         USER_ID,   
         PERSON_ID,
         COMPANY_ID,
         DIVISION_ID,
         ORDER_TYPE,
         COST_CENTER,
         PO_LEGACY_MEMO,
         PO_RECEIVE_WH_NAME,
         PO_LEGACY_DATE,
         PO_DUE_DATE,
         PO_LEGACY_RECVD_DATE,
         PO_LEGACY_RECVD_QTY,
         PO_RECEIVE_WH_ID,
         LAST_UPDATE_DATE,
         LAST_UPDATE_BY)
      VALUES (
         :WK_H_PURCHASE_ORDER     ,
         :WK_H_REQUISITION_NO    ,
         :WK_H_PO_DATE          ,
         :WK_H_PO_REVISION_NO  ,
         :WK_H_PO_STATUS             ,
         :WK_H_COMMENTS             ,
         :WK_H_PO_PRINTED          ,
         :WK_H_USER_ID            ,
         :WK_H_PERSON_ID ,
         :WK_H_COMPANY_ID ,
         :WK_H_DIVISION_ID,
         :WK_H_ORDER_TYPE,
         :WK_H_COST_CENTER,
         :WK_H_LEGACY_MEMO,
         :WK_H_LEGACY_RECEIVE_WH_NAME,
         :WK_H_LEGACY_DATE,
         :WK_H_DUE_DATE,
         :WK_H_LEGACY_RECV_DATE,
         :WK_H_LEGACY_RECV_QTY,
         :WK_H_PO_RECEIVE_WH_ID,
         'NOW',
         'BDCS');
   END
   ELSE
   BEGIN
      UPDATE PURCHASE_ORDER SET
         REQUISITION_NO = :WK_H_REQUISITION_NO ,
         PO_DATE =     :WK_H_PO_DATE ,
         PO_REVISION_NO = :WK_H_PO_REVISION_NO  ,
         PO_STATUS =   :WK_H_PO_STATUS,
         COMMENTS =   :WK_H_COMMENTS ,
         PO_PRINTED = :WK_H_PO_PRINTED ,
         USER_ID =  :WK_H_USER_ID ,
         PERSON_ID = :WK_H_PERSON_ID ,
         COMPANY_ID = :WK_H_COMPANY_ID ,
         DIVISION_ID = :WK_H_DIVISION_ID, 
         ORDER_TYPE = :WK_H_ORDER_TYPE ,
         COST_CENTER = :WK_H_COST_CENTER,
         PO_LEGACY_MEMO = :WK_H_LEGACY_MEMO,
         PO_RECEIVE_WH_NAME = :WK_H_LEGACY_RECEIVE_WH_NAME,
         PO_LEGACY_DATE = :WK_H_LEGACY_DATE,
         PO_DUE_DATE = :WK_H_DUE_DATE,
         PO_LEGACY_RECVD_DATE = :WK_H_LEGACY_RECV_DATE,
         PO_LEGACY_RECVD_QTY = :WK_H_LEGACY_RECV_QTY,
         PO_RECEIVE_WH_ID = :WK_H_PO_RECEIVE_WH_ID,
         LAST_UPDATE_DATE = 'NOW',
         LAST_UPDATE_BY = 'BDCS'
         WHERE PURCHASE_ORDER = :WK_H_PURCHASE_ORDER ;
   END
   /* Get length for product */   
   SELECT MAX_LENGTH, FIXED_LENGTH
   FROM PARAM
   WHERE DATA_ID = 'PROD_INTERNAL'
   INTO :WK_PROD_LENGTH, :WK_PROD_FIXED;
   IF (WK_PROD_LENGTH IS NULL) THEN
   BEGIN
      WK_PROD_LENGTH = 0;
   END
   IF (WK_PROD_FIXED IS NULL) THEN
   BEGIN
      WK_PROD_FIXED = 'F';
   END
   IF (WK_PROD_FIXED = 'T') THEN
   BEGIN
      WK_LEN_LABEL_NO = STRLEN(WK_L_PROD_ID) ;     
      /* Padding leading with 0 */
      WHILE (WK_LEN_LABEL_NO < :WK_PROD_LENGTH) DO
      BEGIN
         WK_L_PROD_ID = '0' || WK_L_PROD_ID ;      
         WK_LEN_LABEL_NO = WK_LEN_LABEL_NO + 1;
      END
   END

   /* do I have a po line */
   IF (WK_L_PO_LINE IS NULL) THEN
   BEGIN
      SELECT FIRST 1 PO_LINE 
      FROM PURCHASE_ORDER_LINE
      WHERE PURCHASE_ORDER = :WK_L_PURCHASE_ORDER AND
      PROD_ID = :WK_L_PROD_ID 
      INTO :WK_L_PO_LINE;
   END
   IF (WK_L_PO_LINE IS NULL) THEN
   BEGIN
      /* ok so no line - must generate one */
      SELECT COUNT(*) 
      FROM PURCHASE_ORDER_LINE
      WHERE PURCHASE_ORDER = :WK_L_PURCHASE_ORDER 
      INTO :WK_L_LINE_CNT;
      IF (WK_L_LINE_CNT IS NULL) THEN
      BEGIN
         WK_L_LINE_CNT = 0;
      END
      WK_L_LINE_CNT = WK_L_LINE_CNT + 1;
      WK_L_PO_LINE = LPAD(WK_L_LINE_CNT,'0',4);
   END
   IF (NEW.L_PO_LINE IS NULL) THEN
   BEGIN
      NEW.L_PO_LINE = WK_L_PO_LINE;
   END
   WK_FOUND = 0;
   SELECT 1 FROM PURCHASE_ORDER_LINE
      WHERE PURCHASE_ORDER = :WK_L_PURCHASE_ORDER AND
            PO_LINE = :WK_L_PO_LINE
      INTO :WK_FOUND;
   IF (WK_FOUND = 0) THEN
   BEGIN
      /* no line so insert it */
      INSERT INTO PURCHASE_ORDER_LINE (
         PURCHASE_ORDER,              
         PO_LINE,                    
         REQUISITION_NO,            
         PROD_ID,                  
         PO_LINE_QTY,            
         UNIT_PRICE,            
         UOM_ORDER,            
         PO_LINE_DUE_DATE,    
         PO_LINE_STATUS,     
         COMMENTS,          
         GST_VALUE,        
         GST_RATE,        
         GST_CODE,
         ORIGINAL_QTY)        
      VALUES (
         :WK_L_PURCHASE_ORDER,              
         :WK_L_PO_LINE,                    
         :WK_L_REQUISITION_NO,            
         :WK_L_PROD_ID       ,           
         :WK_L_PO_LINE_QTY   ,         
         :WK_L_UNIT_PRICE    ,        
         :WK_L_UOM_ORDER     ,       
         :WK_L_PO_LINE_DUE_DATE,    
         :WK_L_PO_LINE_STATUS,     
         :WK_L_COMMENTS      ,    
         :WK_L_GST_VALUE     ,   
         :WK_L_GST_RATE      ,  
         :WK_L_GST_CODE      ,
         :WK_L_PO_LINE_QTY            
 );       
   END
   ELSE
   BEGIN
      UPDATE PURCHASE_ORDER_LINE SET
         REQUISITION_NO = :WK_L_REQUISITION_NO,            
         PROD_ID =        :WK_L_PROD_ID       ,           
         PO_LINE_QTY =    :WK_L_PO_LINE_QTY   ,         
         UNIT_PRICE =     :WK_L_UNIT_PRICE    ,        
         UOM_ORDER =      :WK_L_UOM_ORDER     ,       
         PO_LINE_DUE_DATE = :WK_L_PO_LINE_DUE_DATE,    
         PO_LINE_STATUS =   :WK_L_PO_LINE_STATUS,     
         COMMENTS =         :WK_L_COMMENTS    ,      
         GST_VALUE =      :WK_L_GST_VALUE     ,   
         GST_RATE =       :WK_L_GST_RATE      ,  
         GST_CODE =       :WK_L_GST_CODE         
      WHERE PURCHASE_ORDER = :WK_L_PURCHASE_ORDER AND           
         PO_LINE =        :WK_L_PO_LINE;                    
   END
   WK_FOUND = 0;
   SELECT 1 FROM PROD_PROFILE
      WHERE PROD_ID = :WK_L_PROD_ID
      INTO :WK_FOUND;
   IF (WK_FOUND = 0) THEN
   BEGIN
      /* no line so insert it */
      INSERT INTO PROD_PROFILE (
         PROD_ID,              
         SHORT_DESC,                    
         UOM,            
         ISSUE_UOM)        
      VALUES (
         :WK_L_PROD_ID       ,           
         :WK_PP_SHORT_DESC   ,         
         :WK_PP_UOM          ,        
         :WK_PP_ISSUE_UOM           
 );       
   END
END ^

CREATE TRIGGER PURCHASE_SUB_LINE_ID FOR PURCHASE_SUB_LINE 
ACTIVE BEFORE INSERT POSITION 0 
AS
BEGIN
  IF (NEW.RECORD_ID IS NULL) THEN
      NEW.RECORD_ID = GEN_ID(PURCHASE_SUB_LINE_GEN, 1);
  IF (NEW.RECORD_ID = 0) THEN
      NEW.RECORD_ID = GEN_ID(PURCHASE_SUB_LINE_GEN, 1);
END ^

CREATE TRIGGER ADD_PO_SUB_LINE_TIME FOR PURCHASE_SUB_LINE 
ACTIVE BEFORE INSERT POSITION 20 
AS
BEGIN
   NEW.CREATE_DATE = 'NOW';
   NEW.LAST_UPDATE_DATE = 'NOW';
END ^

CREATE TRIGGER UPDATE_PO_SUB_LINE_TIME FOR PURCHASE_SUB_LINE 
ACTIVE BEFORE UPDATE POSITION 20 
AS
BEGIN
   NEW.LAST_UPDATE_DATE = 'NOW';
END ^

CREATE TRIGGER SAVE_PURCHASE_SUB_LINE FOR PURCHASE_SUB_LINE 
ACTIVE BEFORE DELETE POSITION 0 
AS
DECLARE VARIABLE WK_SAVE_PURCHASE_ITEM CHAR(1);
BEGIN
   BEGIN
      INSERT INTO PURCHASE_LINE_CANCEL(
        PURCHASE_ORDER ,
        PO_LINE ,
        SSN_ID ,
        PSL_OTHER1 ,
        PSL_OTHER2 ,
        PSL_OTHER_DATE3 ,
        PSL_OTHER_DATE4 ,
        PSL_STATUS ,
        USER_ID ,
        DEVICE_ID ,
        CREATE_DATE ,
        LAST_UPDATE_DATE ,
        LAST_UPDATE_BY ,
        PSL_ORDER_QTY ,
        PSL_RECEIVED_QTY ,
        REASON ,
        CANCEL_METHOD )
      VALUES (
        OLD.PURCHASE_ORDER ,
        OLD.PO_LINE ,
        OLD.SSN_ID ,
        OLD.PSL_OTHER1 ,
        OLD.PSL_OTHER2 ,
        OLD.PSL_OTHER_DATE3 ,
        OLD.PSL_OTHER_DATE4 ,
        OLD.PSL_STATUS ,
        OLD.USER_ID ,
        OLD.DEVICE_ID ,
        OLD.CREATE_DATE ,
        OLD.LAST_UPDATE_DATE ,
        OLD.LAST_UPDATE_BY ,
        OLD.PSL_ORDER_QTY ,
        OLD.PSL_RECEIVED_QTY ,
        'Purchase Sub Line Record Deleted' ,
        's' );
   END
END ^

CREATE TRIGGER REPORTS_ID_INSERT FOR REPORTS 
ACTIVE BEFORE INSERT POSITION 0 
AS
BEGIN
    IF (NEW.REPORT_ID IS NULL) THEN
        NEW.REPORT_ID = GEN_ID(REPORT_ID_GEN, 1);
    IF (NEW.REPORT_ID = 0) THEN
        NEW.REPORT_ID = GEN_ID(REPORT_ID_GEN, 1);
    IF (NEW.NAME IS NULL) THEN
        NEW.NAME = '';
    IF (NEW.DESCRIPTION IS NULL) THEN
        NEW.DESCRIPTION = '';
    IF (NEW.QUERY IS NULL) THEN
        NEW.QUERY = '';

END ^

CREATE TRIGGER REPORTS_DETAIL_ID_INSERT FOR REPORTS_DETAIL 
ACTIVE BEFORE INSERT POSITION 0 
AS
BEGIN
    IF (NEW.REPORT_DETAIL_ID IS NULL) THEN
        NEW.REPORT_DETAIL_ID = GEN_ID(REPORT_DETAIL_ID_GEN, 1);
END ^

CREATE TRIGGER ADD_REPORTS_TYPE FOR REPORTS_TYPE 
ACTIVE BEFORE INSERT POSITION 10 
AS
BEGIN
   NEW.LAST_UPDATE_DATE = 'NOW';
END ^

CREATE TRIGGER MOD_REPORTS_TYPE FOR REPORTS_TYPE 
ACTIVE BEFORE UPDATE POSITION 10 
AS
BEGIN
   NEW.LAST_UPDATE_DATE = 'NOW';
END ^

CREATE TRIGGER INSERT_SKILL_CODES FOR SKILL 
INACTIVE BEFORE INSERT POSITION 0 
AS
DECLARE VARIABLE WK_CODE VARCHAR(40);
DECLARE VARIABLE WK_SKILL CHAR(2);
DECLARE VARIABLE WK_DESC VARCHAR(50);
DECLARE VARIABLE WK_PUBLISH CHAR(1);
DECLARE VARIABLE WK_COMPULSORY CHAR(1);
DECLARE VARIABLE WK_CREATED_DATE TIMESTAMP;
DECLARE VARIABLE WK_CREATED_BY VARCHAR(10);
DECLARE VARIABLE WK_FOUND INTEGER;
BEGIN
   WK_CODE = NEW.CODE;
   WK_SKILL = NEW.SKILL_TYPE;
   WK_DESC = NEW.DESCRIPTION;
   WK_PUBLISH = NEW.PUBLISH;
   WK_COMPULSORY = NEW.COMPULSORY_SKILL;
   WK_CREATED_DATE = NEW.CREATED_DATE;
   WK_CREATED_BY = NEW.CREATED_BY;
   WK_FOUND = 0;
   SELECT 1 
   FROM TRAINING_SKILL_CODES
   WHERE CODE = :WK_CODE
   INTO WK_FOUND;
   IF (WK_FOUND = 1) THEN
   BEGIN
      UPDATE TRAINING_SKILL_CODES SET
      DESCRIPTION = :WK_DESC,
      SKILL_TYPE = :WK_SKILL,
      PUBLISH = :WK_PUBLISH,
      COMPULSORY_SKILL = :WK_COMPULSORY,
      CREATED_DATE = :WK_CREATED_DATE,
      CREATED_BY = :WK_CREATED_BY
      WHERE CODE = :WK_CODE;
   END
   ELSE
   BEGIN
      INSERT INTO TRAINING_SKILL_CODES 
      (DESCRIPTION ,
      SKILL_TYPE ,
      PUBLISH ,
      COMPULSORY_SKILL ,
      CREATED_DATE ,
      CREATED_BY,
      CODE)
      VALUES( :WK_DESC,
      :WK_SKILL,
      :WK_PUBLISH,
      :WK_COMPULSORY,
      :WK_CREATED_DATE,
      :WK_CREATED_BY,
      :WK_CODE);
   END
END ^

CREATE TRIGGER UPDATE_SKILL_CODES FOR SKILL 
INACTIVE BEFORE UPDATE POSITION 0 
AS
DECLARE VARIABLE WK_CODE VARCHAR(40);
DECLARE VARIABLE WK_SKILL CHAR(2);
DECLARE VARIABLE WK_DESC VARCHAR(50);
DECLARE VARIABLE WK_PUBLISH CHAR(1);
DECLARE VARIABLE WK_COMPULSORY CHAR(1);
DECLARE VARIABLE WK_CREATED_DATE TIMESTAMP;
DECLARE VARIABLE WK_CREATED_BY VARCHAR(10);
DECLARE VARIABLE WK_FOUND INTEGER;
BEGIN
   WK_CODE = NEW.CODE;
   WK_SKILL = NEW.SKILL_TYPE;
   WK_DESC = NEW.DESCRIPTION;
   WK_PUBLISH = NEW.PUBLISH;
   WK_COMPULSORY = NEW.COMPULSORY_SKILL;
   WK_CREATED_DATE = NEW.CREATED_DATE;
   WK_CREATED_BY = NEW.CREATED_BY;
   WK_FOUND = 0;
   SELECT 1 
   FROM TRAINING_SKILL_CODES
   WHERE CODE = :WK_CODE
   INTO WK_FOUND;
   IF (WK_FOUND = 1) THEN
   BEGIN
      UPDATE TRAINING_SKILL_CODES SET
      DESCRIPTION = :WK_DESC,
      SKILL_TYPE = :WK_SKILL,
      PUBLISH = :WK_PUBLISH,
      COMPULSORY_SKILL = :WK_COMPULSORY,
      CREATED_DATE = :WK_CREATED_DATE,
      CREATED_BY = :WK_CREATED_BY
      WHERE CODE = :WK_CODE;
   END
   ELSE
   BEGIN
      INSERT INTO TRAINING_SKILL_CODES 
      (DESCRIPTION ,
      SKILL_TYPE ,
      PUBLISH ,
      COMPULSORY_SKILL ,
      CREATED_DATE ,
      CREATED_BY,
      CODE)
      VALUES( :WK_DESC,
      :WK_SKILL,
      :WK_PUBLISH,
      :WK_COMPULSORY,
      :WK_CREATED_DATE,
      :WK_CREATED_BY,
      :WK_CODE);
   END
END ^

CREATE TRIGGER INSERT_SSN_PO_PRICE FOR SSN 
ACTIVE BEFORE INSERT POSITION 0 
AS
DECLARE VARIABLE WK_QTY INTEGER;
DECLARE VARIABLE WK_QTYF FLOAT;
DECLARE VARIABLE WK_REASON VARCHAR(40);
BEGIN
   IF (NOT NEW.PURCHASE_PRICE IS NULL) THEN
   BEGIN
      IF (NEW.LOAN_COST_BASE IS NULL) THEN
      BEGIN
         NEW.LOAN_COST_BASE = NEW.PURCHASE_PRICE;
      END
      IF (NEW.LOAN_COST_BASE = 0 ) THEN
      BEGIN
         NEW.LOAN_COST_BASE = NEW.PURCHASE_PRICE;
      END
   END
END ^

CREATE TRIGGER INSERT_SSN_STATUS FOR SSN 
ACTIVE BEFORE INSERT POSITION 0 
AS
DECLARE VARIABLE WK_STATUS CHAR(2);
DECLARE VARIABLE WK_COMPANY VARCHAR(20);
BEGIN
   IF (NEW.STATUS_SSN IS NULL) THEN
   BEGIN
      /* Get the STatus to use for the inserts */
      SELECT NEW_SSN_STATUS FROM CONTROL
      INTO :WK_STATUS;
      NEW.STATUS_SSN = WK_STATUS;
   END
   IF (NEW.COMPANY_ID IS NULL) THEN
   BEGIN
      /* Get the STatus to use for the inserts */
      SELECT COMPANY_ID FROM CONTROL
      INTO :WK_COMPANY;
      NEW.COMPANY_ID = WK_COMPANY;
   END
   IF (NEW.CURRENT_QTY IS NULL) THEN
   BEGIN
      /* Get the STatus to use for the inserts */
      IF (NEW.ORIGINAL_QTY IS NULL) THEN
      BEGIN
         NEW.CURRENT_QTY = 1;
      END
      ELSE
      BEGIN
         NEW.CURRENT_QTY = NEW.ORIGINAL_QTY;
      END
   END
END ^

CREATE TRIGGER ADD_SSN_TIME FOR SSN 
ACTIVE BEFORE INSERT POSITION 20 
AS
DECLARE VARIABLE WK_DO_CHART CHAR(1);
DECLARE VARIABLE WK_LEGACY_CODE VARCHAR(50);
DECLARE VARIABLE WK_LEGACY_LEDGER_CODE VARCHAR(50);
DECLARE VARIABLE WK_FOUND  INTEGER;
BEGIN
   NEW.LAST_UPDATE_DATE = 'NOW';
   IF (NEW.CREATE_DATE IS NULL) THEN
   BEGIN
      NEW.CREATE_DATE = 'NOW';
   END

   WK_DO_CHART = 'F';
   SELECT LEGACY_LEDGER_ACCOUNTS 
   FROM CONTROL
   INTO :WK_DO_CHART;
   IF (WK_DO_CHART IS NULL) THEN
   BEGIN
      WK_DO_CHART = 'F';
   END
   IF (WK_DO_CHART = 'T') THEN
   BEGIN
      IF ((NEW.LEGACY_LEDGER_SALE_CODE IS NULL) OR (NEW.LEGACY_LEDGER_SALE_CODE = '')) THEN
      BEGIN
         /* no admin fee account code */
         /* WK_LEGACY_CODE = NEW.COMPANY_ID || '|%|SALE_CODE'; */
         WK_LEGACY_CODE = NEW.COMPANY_ID || '|SALE_CODE|%';
         WK_LEGACY_LEDGER_CODE = '';
         WK_FOUND = 0;
         FOR SELECT DESCRIPTION 
         FROM OPTIONS
         WHERE GROUP_CODE = 'CMPLGRCODE'
         AND CODE LIKE :WK_LEGACY_CODE 
         INTO :WK_LEGACY_LEDGER_CODE    
         DO
         BEGIN
            IF (WK_FOUND = 0) THEN
            BEGIN
               NEW.LEGACY_LEDGER_SALE_CODE = WK_LEGACY_LEDGER_CODE;
               WK_FOUND = 1;
            END
         END
      END
   END
END ^

CREATE TRIGGER UPDATE_SSN_LOCATION FOR SSN 
ACTIVE BEFORE UPDATE POSITION 0 
AS
                                                       
  DECLARE VARIABLE WK_FROM_STATUS VARCHAR(2);
  DECLARE VARIABLE WK_TO_STATUS VARCHAR(2);
  DECLARE VARIABLE WK_NEW_WH_ID VARCHAR(2);
  DECLARE VARIABLE WK_NEW_LOCN_ID VARCHAR(10);
  DECLARE VARIABLE WK_OLD_WH_ID VARCHAR(2);
  DECLARE VARIABLE WK_OLD_LOCN_ID VARCHAR(10);
  DECLARE VARIABLE WK_IS_OK CHAR(1);
     
BEGIN
   /* Update SSN table */   
         
   WK_NEW_WH_ID = NEW.WH_ID;
   WK_NEW_LOCN_ID = NEW.LOCN_ID;
   WK_OLD_WH_ID = OLD.WH_ID;
   WK_OLD_LOCN_ID = OLD.LOCN_ID;
   IF ( (WK_NEW_WH_ID <> WK_OLD_WH_ID) OR
        (WK_NEW_LOCN_ID <> WK_OLD_LOCN_ID)) THEN
   BEGIN
      /* location changed */
      WK_FROM_STATUS = NEW.STATUS_SSN;
      WK_TO_STATUS = 'ST';
      SELECT MOVE_STAT FROM LOCATION 
         WHERE WH_ID = :WK_NEW_WH_ID AND LOCN_ID = :WK_NEW_LOCN_ID
         INTO :WK_TO_STATUS;
      /* now check on sys_moves */
      IF (WK_FROM_STATUS <> WK_TO_STATUS) THEN
      BEGIN
         WK_IS_OK = 'N';
         SELECT UPDATE_FLAG FROM SYS_MOVES
            WHERE FROM_STATUS = :WK_FROM_STATUS AND INTO_STATUS = :WK_TO_STATUS
            INTO :WK_IS_OK;
         IF (WK_IS_OK = 'T') THEN
         BEGIN
            NEW.STATUS_SSN = WK_TO_STATUS;
         END
      END
   END
END ^

CREATE TRIGGER UPDATE_SSN_SSNDESCRIPTION FOR SSN 
ACTIVE BEFORE UPDATE POSITION 10 
AS                       

DECLARE VARIABLE WK_FIELD VARCHAR(200);
DECLARE VARIABLE WK_DESC_TYPE VARCHAR(40);
DECLARE VARIABLE WK_STATUS CHAR(2);
DECLARE VARIABLE WK_WH_ID CHAR(2);
DECLARE VARIABLE WK_DESC VARCHAR(80);
DECLARE VARIABLE WK_NEW_DESC VARCHAR(700);
DECLARE VARIABLE WK_NEW_DESC2 VARCHAR(700);
DECLARE VARIABLE WK_LOG_FILENAME VARCHAR(255);
DECLARE VARIABLE WK_RESULT INTEGER;

BEGIN    
    
    /* Get SSN to update */
   WK_STATUS = NEW.STATUS_SSN;
   WK_WH_ID = NEW.WH_ID;
   /* WK_LOG_FILENAME = '/tmp/desc.log'; */
   /* IF ((WK_STATUS = 'PA' OR WK_STATUS = 'ST' OR WK_STATUS = 'TS' OR WK_STATUS = 'QR')
      AND (WK_WH_ID < 'X' 
      OR WK_WH_ID > 'X~')) THEN */
   IF ( (WK_WH_ID < 'X' OR WK_WH_ID > 'X~') 
        OR (WK_WH_ID = 'XB') ) THEN
   BEGIN
      /* WK_DESC = NONULL(NEW.SSN_DESCRIPTION); */
      WK_DESC = NEW.SSN_DESCRIPTION;
      IF (WK_DESC IS NULL) THEN
      BEGIN
         WK_DESC = '';
      END
      WK_NEW_DESC2 = '';
      FOR SELECT CODE     
          FROM DESCRIPTION_LAYOUT
          ORDER BY SEQUENCE
          INTO :WK_DESC_TYPE
      DO
      BEGIN
         WK_FIELD = '';
         IF (WK_DESC_TYPE = 'SSN_TYPE') THEN
         BEGIN
            /* WK_FIELD = ALLTRIM(NONULL(NEW.SSN_TYPE)); */
            WK_FIELD = NEW.SSN_TYPE;
            IF (WK_FIELD IS NULL) THEN
            BEGIN
               WK_FIELD = '';
            END
            WK_FIELD = ALLTRIM(WK_FIELD); 
            WK_NEW_DESC2 = WK_NEW_DESC2 || WK_FIELD || ' ';
         END
         IF (WK_DESC_TYPE = 'SSN_TYPE.DESCRIPTION') THEN
         BEGIN
            SELECT DESCRIPTION 
            FROM SSN_TYPE
            WHERE CODE = NEW.SSN_TYPE
            INTO :WK_FIELD;
            IF (WK_FIELD IS NULL) THEN
            BEGIN
               WK_FIELD = '';
            END
            WK_FIELD = ALLTRIM(WK_FIELD); 
            WK_NEW_DESC2 = WK_NEW_DESC2 || WK_FIELD || ' ';
         END
         IF (WK_DESC_TYPE = 'GENERIC') THEN
         BEGIN
            /* WK_FIELD = ALLTRIM(NONULL(NEW.GENERIC)); */
            WK_FIELD = NEW.GENERIC;
            IF (WK_FIELD IS NULL) THEN
            BEGIN
               WK_FIELD = '';
            END
            WK_FIELD = ALLTRIM(WK_FIELD); 
            WK_NEW_DESC2 = WK_NEW_DESC2 || WK_FIELD || ' ';
         END
         IF (WK_DESC_TYPE = 'GENERIC.DESCRIPTION') THEN
         BEGIN
            SELECT DESCRIPTION 
            FROM GENERIC
            WHERE CODE = NEW.GENERIC
            AND SSN_TYPE  = NEW.SSN_TYPE
            INTO :WK_FIELD;
            IF (WK_FIELD IS NULL) THEN
            BEGIN
               WK_FIELD = '';
            END
            WK_FIELD = ALLTRIM(WK_FIELD); 
            WK_NEW_DESC2 = WK_NEW_DESC2 || WK_FIELD || ' ';
         END
         IF (WK_DESC_TYPE = 'BRAND') THEN
         BEGIN
            /* WK_FIELD = ALLTRIM(NONULL(NEW.BRAND)); */
            WK_FIELD = NEW.BRAND; 
            IF (WK_FIELD IS NULL) THEN
            BEGIN
               WK_FIELD = '';
            END
            WK_FIELD = ALLTRIM(WK_FIELD); 
            WK_NEW_DESC2 = WK_NEW_DESC2 || WK_FIELD || ' ';
         END
         IF (WK_DESC_TYPE = 'BRAND.DESCRIPTION') THEN
         BEGIN
            SELECT DESCRIPTION 
            FROM BRAND
            WHERE CODE = NEW.BRAND
            INTO :WK_FIELD;
            IF (WK_FIELD IS NULL) THEN
            BEGIN
               WK_FIELD = '';
            END
            WK_FIELD = ALLTRIM(WK_FIELD); 
            WK_NEW_DESC2 = WK_NEW_DESC2 || WK_FIELD || ' ';
         END
         IF (WK_DESC_TYPE = 'SSN_SUB_TYPE') THEN
         BEGIN
            WK_FIELD = NEW.SSN_SUB_TYPE;
            IF (WK_FIELD IS NULL) THEN
            BEGIN
               WK_FIELD = '';
            END
            WK_FIELD = ALLTRIM(WK_FIELD); 
            WK_NEW_DESC2 = WK_NEW_DESC2 || WK_FIELD || ' ';
         END
         IF (WK_DESC_TYPE = 'SSN_SUB_TYPE.DESCRIPTION') THEN
         BEGIN
            SELECT DESCRIPTION 
            FROM SSN_SUB_TYPE
            WHERE CODE = NEW.SSN_SUB_TYPE
            AND   GENERIC = NEW.GENERIC
            AND SSN_TYPE  = NEW.SSN_TYPE
            INTO :WK_FIELD;
            IF (WK_FIELD IS NULL) THEN
            BEGIN
               WK_FIELD = '';
            END
            WK_FIELD = ALLTRIM(WK_FIELD); 
            WK_NEW_DESC2 = WK_NEW_DESC2 || WK_FIELD || ' ';
         END
         IF (WK_DESC_TYPE = 'MODEL') THEN
         BEGIN
            /* WK_FIELD = ALLTRIM(NONULL(NEW.MODEL)); */
            WK_FIELD = NEW.MODEL;
            IF (WK_FIELD IS NULL) THEN
            BEGIN
               WK_FIELD = '';
            END
            WK_FIELD = ALLTRIM(WK_FIELD); 
            WK_NEW_DESC2 = WK_NEW_DESC2 || WK_FIELD || ' ';
         END
         IF (WK_DESC_TYPE = 'SERIAL_NUMBER') THEN
         BEGIN
            /* WK_FIELD = ALLTRIM(NONULL(NEW.SERIAL_NUMBER)); */
            WK_FIELD = NEW.SERIAL_NUMBER;
            IF (WK_FIELD IS NULL) THEN
            BEGIN
               WK_FIELD = '';
            END
            WK_FIELD = ALLTRIM(WK_FIELD); 
            WK_NEW_DESC2 = WK_NEW_DESC2 || WK_FIELD || ' ';
         END
         IF (WK_DESC_TYPE = 'OTHER1') THEN
         BEGIN
            /* WK_FIELD = ALLTRIM(NONULL(NEW.OTHER1)); */
            WK_FIELD = NEW.OTHER1;
            IF (WK_FIELD IS NULL) THEN
            BEGIN
               WK_FIELD = '';
            END
            WK_FIELD = ALLTRIM(WK_FIELD); 
            WK_NEW_DESC2 = WK_NEW_DESC2 || WK_FIELD || ' ';
         END
         IF (WK_DESC_TYPE = 'OTHER2') THEN
         BEGIN
            /* WK_FIELD = ALLTRIM(NONULL(NEW.OTHER2)); */
            WK_FIELD = NEW.OTHER2;
            IF (WK_FIELD IS NULL) THEN
            BEGIN
               WK_FIELD = '';
            END
            WK_FIELD = ALLTRIM(WK_FIELD); 
            WK_NEW_DESC2 = WK_NEW_DESC2 || WK_FIELD || ' ';
         END
         IF (WK_DESC_TYPE = 'OTHER3') THEN
         BEGIN
            /* WK_FIELD = ALLTRIM(NONULL(NEW.OTHER3)); */
            WK_FIELD = NEW.OTHER3;
            IF (WK_FIELD IS NULL) THEN
            BEGIN
               WK_FIELD = '';
            END
            WK_FIELD = ALLTRIM(WK_FIELD);
            WK_NEW_DESC2 = WK_NEW_DESC2 || WK_FIELD || ' ';
         END
         IF (WK_DESC_TYPE = 'OTHER4') THEN
         BEGIN
            /* WK_FIELD = ALLTRIM(NONULL(NEW.OTHER4)); */
            WK_FIELD = NEW.OTHER4;
            IF (WK_FIELD IS NULL) THEN
            BEGIN
               WK_FIELD = '';
            END
            WK_FIELD = ALLTRIM(WK_FIELD); 
            WK_NEW_DESC2 = WK_NEW_DESC2 || WK_FIELD || ' ';
         END
         IF (WK_DESC_TYPE = 'OTHER5') THEN
         BEGIN
            /* WK_FIELD = ALLTRIM(NONULL(NEW.OTHER5)); */
            WK_FIELD = NEW.OTHER5;
            IF (WK_FIELD IS NULL) THEN
            BEGIN
               WK_FIELD = '';
            END
            WK_FIELD = ALLTRIM(WK_FIELD); 
            WK_NEW_DESC2 = WK_NEW_DESC2 || WK_FIELD || ' ';
         END
         IF (WK_DESC_TYPE = 'OTHER6') THEN
         BEGIN
            /* WK_FIELD = ALLTRIM(NONULL(NEW.OTHER6)); */
            WK_FIELD = NEW.OTHER6;
            IF (WK_FIELD IS NULL) THEN
            BEGIN
               WK_FIELD = '';
            END
            WK_FIELD = ALLTRIM(WK_FIELD); 
            WK_NEW_DESC2 = WK_NEW_DESC2 || WK_FIELD || ' ';
         END
         IF (WK_DESC_TYPE = 'OTHER7') THEN
         BEGIN
            /* WK_FIELD = ALLTRIM(NONULL(NEW.OTHER7)); */
            WK_FIELD = NEW.OTHER7;
            IF (WK_FIELD IS NULL) THEN
            BEGIN
               WK_FIELD = '';
            END
            WK_FIELD = ALLTRIM(WK_FIELD); 
            WK_NEW_DESC2 = WK_NEW_DESC2 || WK_FIELD || ' ';
         END
         IF (WK_DESC_TYPE = 'OTHER8') THEN
         BEGIN
            /* WK_FIELD = ALLTRIM(NONULL(NEW.OTHER8)); */
            WK_FIELD = NEW.OTHER8;
            IF (WK_FIELD IS NULL) THEN
            BEGIN
               WK_FIELD = '';
            END
            WK_FIELD = ALLTRIM(WK_FIELD); 
            WK_NEW_DESC2 = WK_NEW_DESC2 || WK_FIELD || ' ';
         END
         IF (WK_DESC_TYPE = 'OTHER9') THEN
         BEGIN
            /* WK_FIELD = ALLTRIM(NONULL(NEW.OTHER9)); */
            WK_FIELD = NEW.OTHER9;
            IF (WK_FIELD IS NULL) THEN
            BEGIN
               WK_FIELD = '';
            END
            WK_FIELD = ALLTRIM(WK_FIELD); 
            WK_NEW_DESC2 = WK_NEW_DESC2 || WK_FIELD || ' ';
         END
         IF (WK_DESC_TYPE = 'OTHER10') THEN
         BEGIN
            /* WK_FIELD = ALLTRIM(NONULL(NEW.OTHER10)); */
            WK_FIELD = NEW.OTHER10;
            IF (WK_FIELD IS NULL) THEN
            BEGIN
               WK_FIELD = '';
            END
            WK_FIELD = ALLTRIM(WK_FIELD); 
            WK_NEW_DESC2 = WK_NEW_DESC2 || WK_FIELD || ' ';
         END
         IF (WK_DESC_TYPE = 'LEGACY_ID') THEN
         BEGIN
            WK_FIELD = NEW.LEGACY_ID;
            IF (WK_FIELD IS NULL) THEN
            BEGIN
               WK_FIELD = '';
            END
            WK_FIELD = ALLTRIM(WK_FIELD); 
            WK_NEW_DESC2 = WK_NEW_DESC2 || WK_FIELD || ' ';
         END
         IF (WK_DESC_TYPE = 'LEGACY_DESCRIPTION') THEN
         BEGIN
            SELECT LEGACY_DESCRIPTION 
            FROM LEGACY 
            WHERE LEGACY_ID = NEW.LEGACY_ID
            INTO :WK_FIELD;
            IF (WK_FIELD IS NULL) THEN
            BEGIN
               WK_FIELD = '';
            END
            WK_FIELD = ALLTRIM(WK_FIELD); 
            WK_NEW_DESC2 = WK_NEW_DESC2 || WK_FIELD || ' ';
         END
         IF (WK_DESC_TYPE = 'LEGACY_DESCRIPTION2') THEN
         BEGIN
            SELECT LEGACY_DESCRIPTION2
            FROM LEGACY 
            WHERE LEGACY_ID = NEW.LEGACY_ID
            INTO :WK_FIELD;
            IF (WK_FIELD IS NULL) THEN
            BEGIN
               WK_FIELD = '';
            END
            WK_FIELD = ALLTRIM(WK_FIELD); 
            WK_NEW_DESC2 = WK_NEW_DESC2 || WK_FIELD || ' ';
         END
         IF (WK_DESC_TYPE = 'PROD_ID') THEN
         BEGIN
            /* WK_FIELD = ALLTRIM(NONULL(NEW.PROD_ID)); */
            WK_FIELD = NEW.PROD_ID;
            IF (WK_FIELD IS NULL) THEN
            BEGIN
               WK_FIELD = '';
            END
            WK_FIELD = ALLTRIM(WK_FIELD); 
            WK_NEW_DESC2 = WK_NEW_DESC2 || WK_FIELD || ' ';
         END
         IF (WK_DESC_TYPE = 'PROD_ID.SHORT_DESC') THEN
         BEGIN
            SELECT SHORT_DESC 
            FROM PROD_PROFILE
            WHERE PROD_ID = NEW.PROD_ID
            INTO :WK_FIELD;
            IF (WK_FIELD IS NULL) THEN
            BEGIN
               WK_FIELD = '';
            END
            WK_FIELD = ALLTRIM(WK_FIELD); 
            WK_NEW_DESC2 = WK_NEW_DESC2 || WK_FIELD || ' ';
         END
      END
      /* WK_NEW_DESC = LEFTS(WK_NEW_DESC2 , 80); */ 
      IF (STRLEN(WK_NEW_DESC2) > 80) THEN
      BEGIN
         WK_NEW_DESC = LEFTS(WK_NEW_DESC2,79);
      END
      ELSE
      BEGIN
         WK_NEW_DESC = WK_NEW_DESC2;
      END
      /* IF (WK_DESC <> WK_NEW_DESC) THEN */
      BEGIN      
        /* Update SSN Description */
        NEW.SSN_DESCRIPTION = :WK_NEW_DESC;
      END                     
   END                     
END ^

CREATE TRIGGER UPDATE_SSN_LOCN_LOG FOR SSN 
ACTIVE BEFORE UPDATE POSITION 20 
AS
                                                       
  DECLARE VARIABLE WK_NEW_WH_ID VARCHAR(2);
  DECLARE VARIABLE WK_NEW_LOCN_ID VARCHAR(10);
  DECLARE VARIABLE WK_OLD_WH_ID VARCHAR(2);
  DECLARE VARIABLE WK_OLD_LOCN_ID VARCHAR(10);
  DECLARE VARIABLE WK_BUFFER VARCHAR(512);
     
BEGIN
   /* Update ISSN table */   
         
   WK_NEW_WH_ID = NEW.WH_ID;
   WK_NEW_LOCN_ID = NEW.LOCN_ID;
   WK_OLD_WH_ID = OLD.WH_ID;
   WK_OLD_LOCN_ID = OLD.LOCN_ID;
   IF (WK_NEW_WH_ID IS NULL) THEN
      WK_NEW_WH_ID = '';
   IF (WK_NEW_LOCN_ID IS NULL) THEN
      WK_NEW_LOCN_ID = '';
   IF (WK_OLD_WH_ID IS NULL) THEN
      WK_OLD_WH_ID = '';
   IF (WK_OLD_LOCN_ID IS NULL) THEN
      WK_OLD_LOCN_ID = '';
   IF ( (WK_NEW_WH_ID <> WK_OLD_WH_ID) OR
        (WK_NEW_LOCN_ID <> WK_OLD_LOCN_ID)) THEN
   BEGIN
      /* location changed */
      WK_BUFFER = NEW.SSN_ID || ' SSN Location changed from ' || WK_OLD_WH_ID || '-' || WK_OLD_LOCN_ID;
      WK_BUFFER = WK_BUFFER || ' to ' || WK_NEW_WH_ID || '-' || WK_NEW_LOCN_ID;
      INSERT INTO LOG(DESCRIPTION) VALUES (:WK_BUFFER);
   END
END ^

CREATE TRIGGER UPDATE_SSN_TIME FOR SSN 
ACTIVE BEFORE UPDATE POSITION 20 
AS
BEGIN
   NEW.LAST_UPDATE_DATE = 'NOW';
   IF (NEW.CURRENT_QTY < 0) THEN
   BEGIN
      NEW.CURRENT_QTY = 0;
   END
   IF (NEW.DISPOSED = 'T' AND NEW.WH_ID <> 'XX') THEN
   BEGIN
      NEW.PREV_WH_ID = OLD.WH_ID;
      NEW.WH_ID = 'XX';
      NEW.STATUS_SSN = 'XX';
   END
   IF ((NEW.LOAN_SAFETY_CHECK = 'F') AND 
       ((NEW.LOAN_LAST_SAFETY_CHECK_DATE IS NOT NULL) OR
        (NEW.LOAN_SAFETY_PERIOD_NO <> 0 ) OR 
        (NEW.LOAN_SAFETY_PERIOD IS NOT NULL))) THEN
   BEGIN
      NEW.LOAN_LAST_SAFETY_CHECK_DATE = NULL;
      NEW.LOAN_SAFETY_PERIOD = NULL ;
      NEW.LOAN_SAFETY_PERIOD_NO = 0;
   END
   IF ((NEW.LOAN_CALIBRATE_CHECK = 'F') AND 
       ((NEW.LOAN_LAST_CALIBRATE_CHECK_DATE IS NOT NULL) OR
        (NEW.LOAN_CALIBRATE_PERIOD_NO <> 0 ) OR 
        (NEW.LOAN_CALIBRATE_PERIOD IS NOT NULL))) THEN
   BEGIN
      NEW.LOAN_LAST_CALIBRATE_CHECK_DATE = NULL;
      NEW.LOAN_CALIBRATE_PERIOD = NULL ;
      NEW.LOAN_CALIBRATE_PERIOD_NO = 0;
   END
END ^

CREATE TRIGGER SSN_MODEL FOR SSN 
ACTIVE AFTER UPDATE POSITION 2 
AS
DECLARE VARIABLE WK_EXISTS INTEGER;
DECLARE VARIABLE WK_MODEL VARCHAR(40);
BEGIN
   WK_MODEL = NEW.MODEL;
   WK_EXISTS = 0;
   IF (NEW.MODEL <> OLD.MODEL) THEN
   BEGIN
      SELECT 1 FROM MODEL WHERE CODE = :WK_MODEL INTO :WK_EXISTS;
      IF (WK_EXISTS = 0) THEN
      BEGIN
         INSERT INTO MODEL (CODE, DESCRIPTION) VALUES (:WK_MODEL, :WK_MODEL);
      END
   END
END ^

CREATE TRIGGER UPDATE_SSN_SSNSTATUS FOR SSN 
ACTIVE AFTER UPDATE POSITION 10 
AS                       

DECLARE VARIABLE WK_FOUND INTEGER;
DECLARE VARIABLE WK_ISSN VARCHAR(20);
DECLARE VARIABLE WK_ORIG_SSN VARCHAR(20);
DECLARE VARIABLE WK_STATUS CHAR(2);
DECLARE VARIABLE WK_OLD_STATUS CHAR(2);
DECLARE VARIABLE WK_ISSN_STATUS CHAR(2);
DECLARE VARIABLE WK_WH CHAR(2);
DECLARE VARIABLE WK_LOCN VARCHAR(10);
DECLARE VARIABLE WK_OLD_WH CHAR(2);
DECLARE VARIABLE WK_OLD_LOCN VARCHAR(10);
DECLARE VARIABLE WK_ISSN_WH CHAR(2);
DECLARE VARIABLE WK_ISSN_LOCN VARCHAR(10);

BEGIN    
    
    /* Get ISSN to update */
   WK_ISSN = NEW.SSN_ID;
   WK_STATUS = NEW.STATUS_SSN;
   WK_OLD_STATUS = OLD.STATUS_SSN;
   WK_LOCN = NEW.LOCN_ID;
   WK_OLD_LOCN = OLD.LOCN_ID;
   WK_WH = NEW.WH_ID;
   WK_OLD_WH = OLD.WH_ID;
   IF (WK_STATUS <> WK_OLD_STATUS) THEN
   BEGIN
      WK_FOUND = 0;
      SELECT 1, ISSN_STATUS
         FROM ISSN
         WHERE SSN_ID = :WK_ISSN
         INTO :WK_FOUND, :WK_ISSN_STATUS;
      IF (WK_FOUND = 1) THEN
      BEGIN
         IF (WK_ISSN_STATUS <> WK_STATUS) THEN
         BEGIN
            UPDATE ISSN 
               SET ISSN_STATUS = :WK_STATUS
               WHERE SSN_ID = :WK_ISSN;
         END
      END
   END
   IF ((WK_LOCN <> WK_OLD_LOCN) OR
       (WK_WH <> WK_OLD_WH)) THEN
   BEGIN
      WK_FOUND = 0;
      SELECT 1, WH_ID, LOCN_ID
         FROM ISSN
         WHERE SSN_ID = :WK_ISSN
         INTO :WK_FOUND, :WK_ISSN_WH, :WK_ISSN_LOCN;
      IF (WK_FOUND = 1) THEN
      BEGIN
         IF ((WK_ISSN_LOCN <> WK_LOCN) OR
             (WK_ISSN_WH <> WK_WH)) THEN
         BEGIN
            UPDATE ISSN 
               SET WH_ID = :WK_WH,
               LOCN_ID = :WK_LOCN
               WHERE SSN_ID = :WK_ISSN;
         END
      END
   END
END ^

CREATE TRIGGER SSN_HIST_RECORD_ID FOR SSN_HIST 
ACTIVE BEFORE INSERT POSITION 0 
AS
BEGIN
  IF (NEW.RECORD_ID IS NULL) THEN
      NEW.RECORD_ID = GEN_ID(SSN_HIST_RECORD_ID, 1);
  IF (NEW.TRN_CODE IS NULL) THEN
      NEW.TRN_CODE = '';
END ^

CREATE TRIGGER ADD_SSN_SUB_TYPE FOR SSN_SUB_TYPE 
ACTIVE BEFORE INSERT POSITION 10 
AS
BEGIN
   IF (NEW.CODE IS NOT NULL ) THEN
   BEGIN
      IF (LEN(NEW.CODE) <> LEN(ALLTRIM(NEW.CODE))) THEN
      BEGIN
         NEW.CODE  = ALLTRIM(NEW.CODE);
      END
   END
END ^

CREATE TRIGGER MOD_SSN_SUB_TYPE FOR SSN_SUB_TYPE 
ACTIVE BEFORE UPDATE POSITION 10 
AS
BEGIN
   IF (NEW.CODE IS NOT NULL ) THEN
   BEGIN
      IF (LEN(NEW.CODE) <> LEN(ALLTRIM(NEW.CODE))) THEN
      BEGIN
         NEW.CODE  = ALLTRIM(NEW.CODE);
      END
   END
END ^

CREATE TRIGGER ADD_SSN_TEST_TIME FOR SSN_TEST 
ACTIVE BEFORE INSERT POSITION 20 
AS
BEGIN
   NEW.LAST_UPDATE_DATE = 'NOW';
END ^

CREATE TRIGGER UPDATE_SSN_TEST_TIME FOR SSN_TEST 
ACTIVE BEFORE UPDATE POSITION 20 
AS
BEGIN
   NEW.LAST_UPDATE_DATE = 'NOW';
END ^

CREATE TRIGGER AI_SSN_TEST_RESULTS_SSN_TEST_ID FOR SSN_TEST_RESULTS 
ACTIVE BEFORE INSERT POSITION 0 
AS
BEGIN
  IF (NEW.SSN_TEST_ID IS NULL) THEN
      NEW.SSN_TEST_ID = GEN_ID(SSN_TEST_ID_GEN, 1);
/* Ensure that this record is processed in the PROCESS_TEST_RESULTS procedure
   if there is no criteria to process */
  if (NEW.inspect_pass_criteria = '') then
    NEW.processed = 'X';
  Else
    New.processed = 'O';
END ^

CREATE TRIGGER ADD_SSN_TYPE FOR SSN_TYPE 
ACTIVE BEFORE INSERT POSITION 10 
AS
BEGIN
   IF (NEW.CODE IS NOT NULL ) THEN
   BEGIN
      IF (LEN(NEW.CODE) <> LEN(ALLTRIM(NEW.CODE))) THEN
      BEGIN
         NEW.CODE  = ALLTRIM(NEW.CODE);
      END
   END
END ^

CREATE TRIGGER MOD_SSN_TYPE FOR SSN_TYPE 
ACTIVE BEFORE UPDATE POSITION 10 
AS
BEGIN
   IF (NEW.CODE IS NOT NULL ) THEN
   BEGIN
      IF (LEN(NEW.CODE) <> LEN(ALLTRIM(NEW.CODE))) THEN
      BEGIN
         NEW.CODE  = ALLTRIM(NEW.CODE);
      END
   END
END ^

CREATE TRIGGER STOCKTAKE_ID_INSERT FOR STOCKTAKE 
ACTIVE BEFORE INSERT POSITION 0 
AS
BEGIN
    IF (NEW.RECORD_ID IS NULL) THEN
        NEW.RECORD_ID = GEN_ID(STOCKTAKE_ID_GEN, 1);
END ^

CREATE TRIGGER ADD_SYS_ASCII FOR SYS_ASCII 
ACTIVE BEFORE INSERT POSITION 10 
AS
BEGIN
   IF ((NEW.RECORD_ID IS NULL) OR (NEW.RECORD_ID = 0)) THEN
   BEGIN
      NEW.RECORD_ID  = GEN_ID(SYS_ASCII_ID_GEN,1);
   END
   NEW.LAST_UPDATE_DATE = 'NOW';
END ^

CREATE TRIGGER ADD_SYS_LABEL FOR SYS_LABEL 
ACTIVE BEFORE INSERT POSITION 10 
AS
BEGIN
   IF ((NEW.RECORD_ID IS NULL) OR (NEW.RECORD_ID = 0)) THEN
   BEGIN
      NEW.RECORD_ID  = GEN_ID(SYS_LABEL_ID_GEN,1);
   END
   NEW.LAST_UPDATE_DATE = 'NOW';
END ^

CREATE TRIGGER ADD_SYS_LABEL_VAR FOR SYS_LABEL_VAR 
ACTIVE BEFORE INSERT POSITION 10 
AS
BEGIN
   IF ((NEW.RECORD_ID IS NULL) OR (NEW.RECORD_ID = 0)) THEN
   BEGIN
      NEW.RECORD_ID  = GEN_ID(SYS_LABEL_VAR_ID_GEN,1);
   END
   NEW.LAST_UPDATE_DATE = 'NOW';
END ^

CREATE TRIGGER ADD_SYS_MENU FOR SYS_MENU 
ACTIVE BEFORE INSERT POSITION 10 
AS
BEGIN
   IF ((NEW.RECORD_ID IS NULL) OR (NEW.RECORD_ID = 0)) THEN
   BEGIN
      NEW.RECORD_ID  = GEN_ID(SYS_MENU_ID_GEN,1);
   END
   NEW.LAST_UPDATE_DATE = 'NOW';
END ^

CREATE TRIGGER UPD_SYS_MENU FOR SYS_MENU 
ACTIVE BEFORE UPDATE POSITION 10 
AS
BEGIN
   IF ((NEW.RECORD_ID IS NULL) OR (NEW.RECORD_ID = 0)) THEN
   BEGIN
      NEW.RECORD_ID  = GEN_ID(SYS_MENU_ID_GEN,1);
   END
   NEW.LAST_UPDATE_DATE = 'NOW';
END ^

CREATE TRIGGER ADD_SYS_SCREEN FOR SYS_SCREEN 
ACTIVE BEFORE INSERT POSITION 10 
AS
BEGIN
   IF ((NEW.RECORD_ID IS NULL) OR (NEW.RECORD_ID = 0)) THEN
   BEGIN
      NEW.RECORD_ID  = GEN_ID(SYS_SCREEN_ID_GEN,1);
   END
   NEW.LAST_UPDATE_DATE = 'NOW';
END ^

CREATE TRIGGER MOD_SYS_SCREEN FOR SYS_SCREEN 
ACTIVE BEFORE UPDATE POSITION 10 
AS
BEGIN
   IF ((NEW.RECORD_ID IS NULL) OR (NEW.RECORD_ID = 0)) THEN
   BEGIN
      NEW.RECORD_ID  = GEN_ID(SYS_SCREEN_ID_GEN,1);
   END
   NEW.LAST_UPDATE_DATE = 'NOW';
END ^

CREATE TRIGGER ADD_SYS_SCREEN_ACTION FOR SYS_SCREEN_ACTION 
ACTIVE BEFORE INSERT POSITION 10 
AS
BEGIN
   IF ((NEW.RECORD_ID IS NULL) OR (NEW.RECORD_ID = 0)) THEN
   BEGIN
      NEW.RECORD_ID  = GEN_ID(SYS_SCREEN_ACTION_ID_GEN,1);
   END
   NEW.LAST_UPDATE_DATE = 'NOW';
END ^

CREATE TRIGGER UPD_SYS_SCREEN_ACTION FOR SYS_SCREEN_ACTION 
ACTIVE BEFORE UPDATE POSITION 10 
AS
BEGIN
   IF ((NEW.RECORD_ID IS NULL) OR (NEW.RECORD_ID = 0)) THEN
   BEGIN
      NEW.RECORD_ID  = GEN_ID(SYS_SCREEN_ACTION_ID_GEN,1);
   END
   NEW.LAST_UPDATE_DATE = 'NOW';
END ^

CREATE TRIGGER ADD_SYS_SCREEN_BUTTON FOR SYS_SCREEN_BUTTON 
ACTIVE BEFORE INSERT POSITION 10 
AS
BEGIN
   IF ((NEW.RECORD_ID IS NULL) OR (NEW.RECORD_ID = 0)) THEN
   BEGIN
      NEW.RECORD_ID  = GEN_ID(SYS_SCREEN_BUTTON_ID_GEN,1);
   END
   NEW.LAST_UPDATE_DATE = 'NOW';
END ^

CREATE TRIGGER UPD_SYS_SCREEN_BUTTON FOR SYS_SCREEN_BUTTON 
ACTIVE BEFORE UPDATE POSITION 10 
AS
BEGIN
   IF ((NEW.RECORD_ID IS NULL) OR (NEW.RECORD_ID = 0)) THEN
   BEGIN
      NEW.RECORD_ID  = GEN_ID(SYS_SCREEN_BUTTON_ID_GEN,1);
   END
   NEW.LAST_UPDATE_DATE = 'NOW';
END ^

CREATE TRIGGER ADD_SYS_SCREEN_COLOUR FOR SYS_SCREEN_COLOUR 
ACTIVE BEFORE INSERT POSITION 10 
AS
BEGIN
   IF ((NEW.RECORD_ID IS NULL) OR (NEW.RECORD_ID = 0)) THEN
   BEGIN
      NEW.RECORD_ID  = GEN_ID(SYS_SCREEN_COLOUR_ID_GEN,1);
   END
   NEW.LAST_UPDATE_DATE = 'NOW';
END ^

CREATE TRIGGER UPD_SYS_SCREEN_COLOUR FOR SYS_SCREEN_COLOUR 
ACTIVE BEFORE UPDATE POSITION 10 
AS
BEGIN
   IF ((NEW.RECORD_ID IS NULL) OR (NEW.RECORD_ID = 0)) THEN
   BEGIN
      NEW.RECORD_ID  = GEN_ID(SYS_SCREEN_COLOUR_ID_GEN,1);
   END
   NEW.LAST_UPDATE_DATE = 'NOW';
END ^

CREATE TRIGGER ADD_SYS_SCREEN_ORDER FOR SYS_SCREEN_ORDER 
ACTIVE BEFORE INSERT POSITION 10 
AS
BEGIN
   IF ((NEW.RECORD_ID IS NULL) OR (NEW.RECORD_ID = 0)) THEN
   BEGIN
      NEW.RECORD_ID  = GEN_ID(SYS_SCREEN_ORDER_ID_GEN,1);
   END
   NEW.LAST_UPDATE_DATE = 'NOW';
END ^

CREATE TRIGGER UPD_SYS_SCREEN_ORDER FOR SYS_SCREEN_ORDER 
ACTIVE BEFORE UPDATE POSITION 10 
AS
BEGIN
   IF ((NEW.RECORD_ID IS NULL) OR (NEW.RECORD_ID = 0)) THEN
   BEGIN
      NEW.RECORD_ID  = GEN_ID(SYS_SCREEN_ORDER_ID_GEN,1);
   END
   NEW.LAST_UPDATE_DATE = 'NOW';
END ^

CREATE TRIGGER ADD_SYS_SCREEN_PROCEDURE FOR SYS_SCREEN_PROCEDURE 
ACTIVE BEFORE INSERT POSITION 10 
AS
BEGIN
   IF ((NEW.RECORD_ID IS NULL) OR (NEW.RECORD_ID = 0)) THEN
   BEGIN
      NEW.RECORD_ID  = GEN_ID(SYS_SCREEN_PROCEDURE_ID_GEN,1);
   END
   NEW.LAST_UPDATE_DATE = 'NOW';
END ^

CREATE TRIGGER MOD_SYS_SCREEN_PROCEDURE FOR SYS_SCREEN_PROCEDURE 
ACTIVE BEFORE UPDATE POSITION 10 
AS
BEGIN
   IF ((NEW.RECORD_ID IS NULL) OR (NEW.RECORD_ID = 0)) THEN
   BEGIN
      NEW.RECORD_ID  = GEN_ID(SYS_SCREEN_PROCEDURE_ID_GEN,1);
   END
   NEW.LAST_UPDATE_DATE = 'NOW';
END ^

CREATE TRIGGER ADD_SYS_SCREEN_TAB FOR SYS_SCREEN_TAB 
ACTIVE BEFORE INSERT POSITION 10 
AS
BEGIN
   IF ((NEW.RECORD_ID IS NULL) OR (NEW.RECORD_ID = 0)) THEN
   BEGIN
      NEW.RECORD_ID  = GEN_ID(SYS_SCREEN_TAB_ID_GEN,1);
   END
   NEW.LAST_UPDATE_DATE = 'NOW';
END ^

CREATE TRIGGER UPD_SYS_SCREEN_TAB FOR SYS_SCREEN_TAB 
ACTIVE BEFORE UPDATE POSITION 10 
AS
BEGIN
   IF ((NEW.RECORD_ID IS NULL) OR (NEW.RECORD_ID = 0)) THEN
   BEGIN
      NEW.RECORD_ID  = GEN_ID(SYS_SCREEN_TAB_ID_GEN,1);
   END
   NEW.LAST_UPDATE_DATE = 'NOW';
END ^

CREATE TRIGGER ADD_SYS_SCREEN_TABLE FOR SYS_SCREEN_TABLE 
ACTIVE BEFORE INSERT POSITION 10 
AS
BEGIN
   IF ((NEW.RECORD_ID IS NULL) OR (NEW.RECORD_ID = 0)) THEN
   BEGIN
      NEW.RECORD_ID  = GEN_ID(SYS_SCREEN_TABLE_ID_GEN,1);
   END
   NEW.LAST_UPDATE_DATE = 'NOW';
END ^

CREATE TRIGGER MOD_SYS_SCREEN_TABLE FOR SYS_SCREEN_TABLE 
ACTIVE BEFORE UPDATE POSITION 10 
AS
BEGIN
   IF ((NEW.RECORD_ID IS NULL) OR (NEW.RECORD_ID = 0)) THEN
   BEGIN
      NEW.RECORD_ID  = GEN_ID(SYS_SCREEN_TABLE_ID_GEN,1);
   END
   NEW.LAST_UPDATE_DATE = 'NOW';
END ^

CREATE TRIGGER ADD_SYS_SCREEN_VAR FOR SYS_SCREEN_VAR 
ACTIVE BEFORE INSERT POSITION 10 
AS
BEGIN
   IF ((NEW.RECORD_ID IS NULL) OR (NEW.RECORD_ID = 0)) THEN
   BEGIN
      NEW.RECORD_ID  = GEN_ID(SYS_SCREEN_VAR_ID_GEN,1);
   END
   NEW.LAST_UPDATE_DATE = 'NOW';
END ^

CREATE TRIGGER MOD_SYS_SCREEN_VAR FOR SYS_SCREEN_VAR 
ACTIVE BEFORE UPDATE POSITION 10 
AS
BEGIN
   IF ((NEW.RECORD_ID IS NULL) OR (NEW.RECORD_ID = 0)) THEN
   BEGIN
      NEW.RECORD_ID  = GEN_ID(SYS_SCREEN_VAR_ID_GEN,1);
   END
   NEW.LAST_UPDATE_DATE = 'NOW';
END ^

CREATE TRIGGER AI_TASK_SCHEDULE FOR TASK_SCHEDULE 
ACTIVE BEFORE INSERT POSITION 0 
AS
BEGIN
  IF (NEW.TASK_ID IS NULL) THEN
      NEW.TASK_ID = GEN_ID(TASK_ID_GEN, 1);
END ^

CREATE TRIGGER AI_TEST_QUESTIONS_QUESTION_ID FOR TEST_QUESTIONS 
ACTIVE BEFORE INSERT POSITION 0 
AS
BEGIN
  IF (NEW.QUESTION_ID IS NULL) THEN
      NEW.QUESTION_ID = GEN_ID(TEST_QUESTIONS_RECORD_ID_GEN, 1);
END ^

CREATE TRIGGER DELETE_TRAINING_SKILL FOR TRAINING_SKILL 
INACTIVE AFTER DELETE POSITION 0 
AS
DECLARE VARIABLE WK_PERSON VARCHAR(10);
DECLARE VARIABLE WK_CODE VARCHAR(40);
DECLARE VARIABLE WK_DATE TIMESTAMP;
DECLARE VARIABLE WK_DATE_STR VARCHAR(30) ;
DECLARE VARIABLE WK_BY VARCHAR(10);
DECLARE VARIABLE WK_LOCN VARCHAR(40);
DECLARE VARIABLE WK_AUTH VARCHAR(50);
DECLARE VARIABLE WK_PASS CHAR(1);
DECLARE VARIABLE WK_TRESULT VARCHAR(20);
DECLARE VARIABLE WK_CERT TIMESTAMP;
DECLARE VARIABLE WK_CERT_STR VARCHAR(30) ;
DECLARE VARIABLE WK_COMPULSORY CHAR(1) ;
DECLARE VARIABLE WK_DIRECTORY VARCHAR(80);
DECLARE VARIABLE WK_FILENAME VARCHAR(255);
DECLARE VARIABLE WK_LABEL_LINE VARCHAR(355);
DECLARE VARIABLE WK_RESULT INTEGER;
BEGIN
   WK_PERSON = OLD.PERSON_ID;
   WK_CODE = OLD.TRAINING_CODE;
   WK_DATE = OLD.TRAINING_DATE;
   WK_DATE_STR = CAST(WK_DATE AS CHAR(22));
   WK_BY = OLD.TRAINING_BY;
   WK_LOCN = OLD.TRAINING_LOCATION;
   WK_AUTH = OLD.TRAINING_AUTHORITY;
   WK_PASS = OLD.TRAINING_PASS;
   WK_TRESULT = OLD.TRAINING_RESULT;
   WK_CERT = OLD.TRAINING_CERT_PRINTED;
   WK_CERT_STR = CAST(WK_CERT AS CHAR(22));
   WK_COMPULSORY = OLD.COMPULSORY_SKILL;
   SELECT EMPLOYEE_FTP_DIRECTORY FROM CONTROL INTO :WK_DIRECTORY;
   WK_FILENAME = WK_DIRECTORY || 'deltskill.trn';
   WK_LABEL_LINE = SQUOTEDSTR(WK_PERSON) || ',' ||
   SQUOTEDSTR(WK_CODE) || ',' ||
   SQUOTEDSTR(WK_DATE_STR) || ',' ||
   SQUOTEDSTR(WK_BY) || ',' ||
   SQUOTEDSTR(WK_LOCN) || ',' ||
   SQUOTEDSTR(WK_AUTH) || ',' ||
   SQUOTEDSTR(WK_PASS) || ',' ||
   SQUOTEDSTR(WK_TRESULT) || ',' ||
   SQUOTEDSTR(WK_CERT_STR) ||  ',' ||
   SQUOTEDSTR(WK_COMPULSORY) ;
   WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE);
   IF (WK_RESULT <> 0) THEN
   BEGIN
      WK_FILENAME = WK_DIRECTORY || 'deltskill.2rn';
      WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE);
   END

END ^

CREATE TRIGGER DELETE_TRAINING_SKILL_CODES FOR TRAINING_SKILL_CODES 
INACTIVE AFTER DELETE POSITION 0 
AS
DECLARE VARIABLE WK_CODE VARCHAR(40);
DECLARE VARIABLE WK_DIRECTORY VARCHAR(80);
DECLARE VARIABLE WK_FILENAME VARCHAR(255);
DECLARE VARIABLE WK_LABEL_LINE VARCHAR(255);
DECLARE VARIABLE WK_RESULT INTEGER;
BEGIN
   WK_CODE = OLD.CODE;
   SELECT EMPLOYEE_FTP_DIRECTORY FROM CONTROL INTO :WK_DIRECTORY;
   WK_FILENAME = WK_DIRECTORY || 'delskillcode.trn';
   WK_LABEL_LINE = SQUOTEDSTR(WK_CODE) ;
   WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE);
   IF (WK_RESULT <> 0) THEN
   BEGIN
      WK_FILENAME = WK_DIRECTORY || 'delskillcode.2rn';
      WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE);
   END

END ^

CREATE TRIGGER RUN_TRANSACTION_NITP FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 1 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'NITP') THEN
  BEGIN
   EXECUTE PROCEDURE PC_NIXX 
    NEW.RECORD_ID ,
    NEW.WH_ID,
    NEW.LOCN_ID,
    NEW.OBJECT,
    NEW.TRN_TYPE,
    NEW.TRN_CODE,
    NEW.TRN_DATE,
    NEW.REFERENCE,
    NEW.QTY,
    NEW.PERSON_ID,
    NEW.DEVICE_ID,
    NEW.INSTANCE_ID;
   EXECUTE PROCEDURE TRAN_ARCHIVE;
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_NIOB FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 2 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'NIOB') THEN
  BEGIN
   EXECUTE PROCEDURE PC_NIXX 
    NEW.RECORD_ID ,
    NEW.WH_ID,
    NEW.LOCN_ID,
    NEW.OBJECT,
    NEW.TRN_TYPE,
    NEW.TRN_CODE,
    NEW.TRN_DATE,
    NEW.REFERENCE,
    NEW.QTY,
    NEW.PERSON_ID,
    NEW.DEVICE_ID,
    NEW.INSTANCE_ID;
   EXECUTE PROCEDURE TRAN_ARCHIVE;
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_UGXX FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 2 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0);
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (SUBSTR(NEW.TRN_TYPE,1,2) = 'UG') THEN
  BEGIN
   EXECUTE PROCEDURE PC_UGXX
    NEW.RECORD_ID ,
    NEW.WH_ID,
    NEW.LOCN_ID,
    NEW.OBJECT,
    NEW.TRN_TYPE,
    NEW.TRN_CODE,
    NEW.TRN_DATE,
    NEW.REFERENCE,
    NEW.QTY,
    NEW.PERSON_ID,
    NEW.DEVICE_ID,
    NEW.INSTANCE_ID;
   EXECUTE PROCEDURE TRAN_ARCHIVE;
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_UIO1 FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 2 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0);
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'UIO1') THEN
  BEGIN
   EXECUTE PROCEDURE PC_UIXX
    NEW.RECORD_ID ,
    NEW.WH_ID,
    NEW.LOCN_ID,
    NEW.OBJECT,
    NEW.TRN_TYPE,
    NEW.TRN_CODE,
    NEW.TRN_DATE,
    NEW.REFERENCE,
    NEW.QTY,
    NEW.PERSON_ID,
    NEW.DEVICE_ID,
    NEW.INSTANCE_ID;
   EXECUTE PROCEDURE TRAN_ARCHIVE;
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_UIXX FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 2 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0);
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (SUBSTR(NEW.TRN_TYPE,1,2) = 'UI') THEN
  BEGIN
   EXECUTE PROCEDURE PC_UIXX
   (NEW.RECORD_ID ,
    NEW.WH_ID,
    NEW.LOCN_ID,
    NEW.OBJECT,
    NEW.TRN_TYPE,
    NEW.TRN_CODE,
    NEW.TRN_DATE,
    NEW.REFERENCE,
    NEW.QTY,
    NEW.PERSON_ID,
    NEW.DEVICE_ID,
    NEW.INSTANCE_ID);
   /* EXECUTE PROCEDURE TRAN_ARCHIVE; */
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_NIBC FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 3 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'NIBC') THEN
  BEGIN
   EXECUTE PROCEDURE PC_NIXX 
    NEW.RECORD_ID ,
    NEW.WH_ID,
    NEW.LOCN_ID,
    NEW.OBJECT,
    NEW.TRN_TYPE,
    NEW.TRN_CODE,
    NEW.TRN_DATE,
    NEW.REFERENCE,
    NEW.QTY,
    NEW.PERSON_ID,
    NEW.DEVICE_ID,
    NEW.INSTANCE_ID;
   EXECUTE PROCEDURE TRAN_ARCHIVE;
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_NIMO FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 4 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'NIMO') THEN
  BEGIN
   EXECUTE PROCEDURE PC_NIXX 
    NEW.RECORD_ID ,
    NEW.WH_ID,
    NEW.LOCN_ID,
    NEW.OBJECT,
    NEW.TRN_TYPE,
    NEW.TRN_CODE,
    NEW.TRN_DATE,
    NEW.REFERENCE,
    NEW.QTY,
    NEW.PERSON_ID,
    NEW.DEVICE_ID,
    NEW.INSTANCE_ID;
   EXECUTE PROCEDURE TRAN_ARCHIVE;
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_NICC FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 5 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'NICC') THEN
  BEGIN
   EXECUTE PROCEDURE PC_NIXX 
    NEW.RECORD_ID ,
    NEW.WH_ID,
    NEW.LOCN_ID,
    NEW.OBJECT,
    NEW.TRN_TYPE,
    NEW.TRN_CODE,
    NEW.TRN_DATE,
    NEW.REFERENCE,
    NEW.QTY,
    NEW.PERSON_ID,
    NEW.DEVICE_ID,
    NEW.INSTANCE_ID;
   EXECUTE PROCEDURE TRAN_ARCHIVE;
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_NILG FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 6 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'NILG') THEN
  BEGIN
   EXECUTE PROCEDURE PC_NIXX 
    NEW.RECORD_ID ,
    NEW.WH_ID,
    NEW.LOCN_ID,
    NEW.OBJECT,
    NEW.TRN_TYPE,
    NEW.TRN_CODE,
    NEW.TRN_DATE,
    NEW.REFERENCE,
    NEW.QTY,
    NEW.PERSON_ID,
    NEW.DEVICE_ID,
    NEW.INSTANCE_ID;
   EXECUTE PROCEDURE TRAN_ARCHIVE;
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_PSRF FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 7 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'PSRF') THEN
  BEGIN
   EXECUTE PROCEDURE PC_NIXX 
    NEW.RECORD_ID ,
    NEW.WH_ID,
    NEW.LOCN_ID,
    NEW.OBJECT,
    NEW.TRN_TYPE,
    NEW.TRN_CODE,
    NEW.TRN_DATE,
    NEW.REFERENCE,
    NEW.QTY,
    NEW.PERSON_ID,
    NEW.DEVICE_ID,
    NEW.INSTANCE_ID;
   EXECUTE PROCEDURE TRAN_ARCHIVE;
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_NISN FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 8 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'NISN') THEN
  BEGIN
   EXECUTE PROCEDURE PC_NIXX 
    NEW.RECORD_ID ,
    NEW.WH_ID,
    NEW.LOCN_ID,
    NEW.OBJECT,
    NEW.TRN_TYPE,
    NEW.TRN_CODE,
    NEW.TRN_DATE,
    NEW.REFERENCE,
    NEW.QTY,
    NEW.PERSON_ID,
    NEW.DEVICE_ID,
    NEW.INSTANCE_ID;
   EXECUTE PROCEDURE TRAN_ARCHIVE;
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_NIO1 FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 9 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'NIO1') THEN
  BEGIN
   EXECUTE PROCEDURE PC_NIXX 
    NEW.RECORD_ID ,
    NEW.WH_ID,
    NEW.LOCN_ID,
    NEW.OBJECT,
    NEW.TRN_TYPE,
    NEW.TRN_CODE,
    NEW.TRN_DATE,
    NEW.REFERENCE,
    NEW.QTY,
    NEW.PERSON_ID,
    NEW.DEVICE_ID,
    NEW.INSTANCE_ID;
   EXECUTE PROCEDURE TRAN_ARCHIVE;
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_NIO2 FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 10 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'NIO2') THEN
  BEGIN
   EXECUTE PROCEDURE PC_NIXX 
    NEW.RECORD_ID ,
    NEW.WH_ID,
    NEW.LOCN_ID,
    NEW.OBJECT,
    NEW.TRN_TYPE,
    NEW.TRN_CODE,
    NEW.TRN_DATE,
    NEW.REFERENCE,
    NEW.QTY,
    NEW.PERSON_ID,
    NEW.DEVICE_ID,
    NEW.INSTANCE_ID;
   EXECUTE PROCEDURE TRAN_ARCHIVE;
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_NIO3 FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 11 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'NIO3') THEN
  BEGIN
   EXECUTE PROCEDURE PC_NIXX 
    NEW.RECORD_ID ,
    NEW.WH_ID,
    NEW.LOCN_ID,
    NEW.OBJECT,
    NEW.TRN_TYPE,
    NEW.TRN_CODE,
    NEW.TRN_DATE,
    NEW.REFERENCE,
    NEW.QTY,
    NEW.PERSON_ID,
    NEW.DEVICE_ID,
    NEW.INSTANCE_ID;
   EXECUTE PROCEDURE TRAN_ARCHIVE;
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_NIO4 FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 12 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'NIO4') THEN
  BEGIN
   EXECUTE PROCEDURE PC_NIXX 
    NEW.RECORD_ID ,
    NEW.WH_ID,
    NEW.LOCN_ID,
    NEW.OBJECT,
    NEW.TRN_TYPE,
    NEW.TRN_CODE,
    NEW.TRN_DATE,
    NEW.REFERENCE,
    NEW.QTY,
    NEW.PERSON_ID,
    NEW.DEVICE_ID,
    NEW.INSTANCE_ID;
   EXECUTE PROCEDURE TRAN_ARCHIVE;
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_NIO5 FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 13 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'NIO5') THEN
  BEGIN
   EXECUTE PROCEDURE PC_NIXX 
    NEW.RECORD_ID ,
    NEW.WH_ID,
    NEW.LOCN_ID,
    NEW.OBJECT,
    NEW.TRN_TYPE,
    NEW.TRN_CODE,
    NEW.TRN_DATE,
    NEW.REFERENCE,
    NEW.QTY,
    NEW.PERSON_ID,
    NEW.DEVICE_ID,
    NEW.INSTANCE_ID;
   EXECUTE PROCEDURE TRAN_ARCHIVE;
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_NIO6 FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 14 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'NIO6') THEN
  BEGIN
   EXECUTE PROCEDURE PC_NIXX 
    NEW.RECORD_ID ,
    NEW.WH_ID,
    NEW.LOCN_ID,
    NEW.OBJECT,
    NEW.TRN_TYPE,
    NEW.TRN_CODE,
    NEW.TRN_DATE,
    NEW.REFERENCE,
    NEW.QTY,
    NEW.PERSON_ID,
    NEW.DEVICE_ID,
    NEW.INSTANCE_ID;
   EXECUTE PROCEDURE TRAN_ARCHIVE;
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_NIO7 FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 15 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'NIO7') THEN
  BEGIN
   EXECUTE PROCEDURE PC_NIXX 
    NEW.RECORD_ID ,
    NEW.WH_ID,
    NEW.LOCN_ID,
    NEW.OBJECT,
    NEW.TRN_TYPE,
    NEW.TRN_CODE,
    NEW.TRN_DATE,
    NEW.REFERENCE,
    NEW.QTY,
    NEW.PERSON_ID,
    NEW.DEVICE_ID,
    NEW.INSTANCE_ID;
   EXECUTE PROCEDURE TRAN_ARCHIVE;
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_NIO8 FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 16 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'NIO8') THEN
  BEGIN
   EXECUTE PROCEDURE PC_NIXX 
    NEW.RECORD_ID ,
    NEW.WH_ID,
    NEW.LOCN_ID,
    NEW.OBJECT,
    NEW.TRN_TYPE,
    NEW.TRN_CODE,
    NEW.TRN_DATE,
    NEW.REFERENCE,
    NEW.QTY,
    NEW.PERSON_ID,
    NEW.DEVICE_ID,
    NEW.INSTANCE_ID;
   EXECUTE PROCEDURE TRAN_ARCHIVE;
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_NIO9 FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 17 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'NIO9') THEN
  BEGIN
   EXECUTE PROCEDURE PC_NIXX 
    NEW.RECORD_ID ,
    NEW.WH_ID,
    NEW.LOCN_ID,
    NEW.OBJECT,
    NEW.TRN_TYPE,
    NEW.TRN_CODE,
    NEW.TRN_DATE,
    NEW.REFERENCE,
    NEW.QTY,
    NEW.PERSON_ID,
    NEW.DEVICE_ID,
    NEW.INSTANCE_ID;
   EXECUTE PROCEDURE TRAN_ARCHIVE;
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_NIOA FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 18 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'NIOA') THEN
  BEGIN
   EXECUTE PROCEDURE PC_NIXX 
    NEW.RECORD_ID ,
    NEW.WH_ID,
    NEW.LOCN_ID,
    NEW.OBJECT,
    NEW.TRN_TYPE,
    NEW.TRN_CODE,
    NEW.TRN_DATE,
    NEW.REFERENCE,
    NEW.QTY,
    NEW.PERSON_ID,
    NEW.DEVICE_ID,
    NEW.INSTANCE_ID;
   EXECUTE PROCEDURE TRAN_ARCHIVE;
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_NIOK FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 19 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'NIOK') THEN
  BEGIN
   EXECUTE PROCEDURE PC_NIXX 
    NEW.RECORD_ID ,
    NEW.WH_ID,
    NEW.LOCN_ID,
    NEW.OBJECT,
    NEW.TRN_TYPE,
    NEW.TRN_CODE,
    NEW.TRN_DATE,
    NEW.REFERENCE,
    NEW.QTY,
    NEW.PERSON_ID,
    NEW.DEVICE_ID,
    NEW.INSTANCE_ID;
   EXECUTE PROCEDURE TRAN_ARCHIVE;
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_NIPC FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 20 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'NIPC') THEN
  BEGIN
   EXECUTE PROCEDURE PC_NIXX 
    NEW.RECORD_ID ,
    NEW.WH_ID,
    NEW.LOCN_ID,
    NEW.OBJECT,
    NEW.TRN_TYPE,
    NEW.TRN_CODE,
    NEW.TRN_DATE,
    NEW.REFERENCE,
    NEW.QTY,
    NEW.PERSON_ID,
    NEW.DEVICE_ID,
    NEW.INSTANCE_ID;
   EXECUTE PROCEDURE TRAN_ARCHIVE;
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_NIOL FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 21 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'NIOL') THEN
  BEGIN
   EXECUTE PROCEDURE PC_NIXX 
    NEW.RECORD_ID ,
    NEW.WH_ID,
    NEW.LOCN_ID,
    NEW.OBJECT,
    NEW.TRN_TYPE,
    NEW.TRN_CODE,
    NEW.TRN_DATE,
    NEW.REFERENCE,
    NEW.QTY,
    NEW.PERSON_ID,
    NEW.DEVICE_ID,
    NEW.INSTANCE_ID;
   EXECUTE PROCEDURE TRAN_ARCHIVE;
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_NIST FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 22 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'NIST') THEN
  BEGIN
   EXECUTE PROCEDURE PC_NIXX 
    NEW.RECORD_ID ,
    NEW.WH_ID,
    NEW.LOCN_ID,
    NEW.OBJECT,
    NEW.TRN_TYPE,
    NEW.TRN_CODE,
    NEW.TRN_DATE,
    NEW.REFERENCE,
    NEW.QTY,
    NEW.PERSON_ID,
    NEW.DEVICE_ID,
    NEW.INSTANCE_ID;
   EXECUTE PROCEDURE TRAN_ARCHIVE;
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_NILX FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 23 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'NILX') THEN
  BEGIN
   EXECUTE PROCEDURE PC_NIXX 
    NEW.RECORD_ID ,
    NEW.WH_ID,
    NEW.LOCN_ID,
    NEW.OBJECT,
    NEW.TRN_TYPE,
    NEW.TRN_CODE,
    NEW.TRN_DATE,
    NEW.REFERENCE,
    NEW.QTY,
    NEW.PERSON_ID,
    NEW.DEVICE_ID,
    NEW.INSTANCE_ID;
   EXECUTE PROCEDURE TRAN_ARCHIVE;
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_NIGC FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 24 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'NIGC') THEN
  BEGIN
   EXECUTE PROCEDURE PC_NIXX 
    NEW.RECORD_ID ,
    NEW.WH_ID,
    NEW.LOCN_ID,
    NEW.OBJECT,
    NEW.TRN_TYPE,
    NEW.TRN_CODE,
    NEW.TRN_DATE,
    NEW.REFERENCE,
    NEW.QTY,
    NEW.PERSON_ID,
    NEW.DEVICE_ID,
    NEW.INSTANCE_ID;
   EXECUTE PROCEDURE TRAN_ARCHIVE;
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_NIAP FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 25 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'NIAP') THEN
  BEGIN
   EXECUTE PROCEDURE PC_ADD_PROD_COND_STATUS 
    NEW.RECORD_ID ,
    NEW.WH_ID,
    NEW.LOCN_ID,
    NEW.OBJECT,
    NEW.TRN_TYPE,
    NEW.TRN_CODE,
    NEW.TRN_DATE,
    NEW.REFERENCE,
    NEW.QTY,
    NEW.PERSON_ID,
    NEW.DEVICE_ID;
   EXECUTE PROCEDURE TRAN_ARCHIVE;
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_NIOP FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 26 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'NIOP') THEN
  BEGIN
   EXECUTE PROCEDURE PC_ADD_PROD_COND_STATUS 
    NEW.RECORD_ID ,
    NEW.WH_ID,
    NEW.LOCN_ID,
    NEW.OBJECT,
    NEW.TRN_TYPE,
    NEW.TRN_CODE,
    NEW.TRN_DATE,
    NEW.REFERENCE,
    NEW.QTY,
    NEW.PERSON_ID,
    NEW.DEVICE_ID;
   EXECUTE PROCEDURE TRAN_ARCHIVE;
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_NICP FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 27 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'NICP') THEN
  BEGIN
   EXECUTE PROCEDURE PC_ADD_PROD_COND_STATUS 
    NEW.RECORD_ID ,
    NEW.WH_ID,
    NEW.LOCN_ID,
    NEW.OBJECT,
    NEW.TRN_TYPE,
    NEW.TRN_CODE,
    NEW.TRN_DATE,
    NEW.REFERENCE,
    NEW.QTY,
    NEW.PERSON_ID,
    NEW.DEVICE_ID;
   EXECUTE PROCEDURE TRAN_ARCHIVE;
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_AULO FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 28 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'AULO') THEN
  BEGIN
   EXECUTE PROCEDURE PC_AULO 
    NEW.RECORD_ID ,
    NEW.WH_ID,
    NEW.LOCN_ID,
    NEW.TRN_DATE;
   EXECUTE PROCEDURE TRAN_ARCHIVE;
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_AUOB FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 29 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_RECORD_ID INTEGER;
DECLARE VARIABLE WK_WH_ID CHAR(2);
DECLARE VARIABLE WK_LOCN_ID VARCHAR(10);
DECLARE VARIABLE WK_OBJECT VARCHAR(30);
DECLARE VARIABLE WK_TRN_TYPE VARCHAR(4);
DECLARE VARIABLE WK_TRN_CODE CHAR(1);
DECLARE VARIABLE WK_TRN_DATE TIMESTAMP;
DECLARE VARIABLE WK_REFERENCE VARCHAR(40);
DECLARE VARIABLE WK_QTY INTEGER;
DECLARE VARIABLE WK_PERSON_ID VARCHAR(10);
DECLARE VARIABLE WK_DEVICE_ID CHAR(2);
DECLARE VARIABLE WK_INSTANCE_ID VARCHAR(10);
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'AUOB') THEN
  BEGIN
    WK_RECORD_ID = NEW.RECORD_ID ;
    WK_WH_ID = NEW.WH_ID;
    WK_LOCN_ID = NEW.LOCN_ID;
    WK_OBJECT = NEW.OBJECT;
    WK_TRN_TYPE = NEW.TRN_TYPE;
    WK_TRN_CODE = NEW.TRN_CODE;
    WK_TRN_DATE = NEW.TRN_DATE;
    WK_REFERENCE = NEW.REFERENCE;
    WK_QTY = NEW.QTY;
    WK_PERSON_ID = NEW.PERSON_ID;
    WK_DEVICE_ID = NEW.DEVICE_ID;
    WK_INSTANCE_ID = NEW.INSTANCE_ID;
   EXECUTE PROCEDURE PC_AUOB (
    WK_RECORD_ID ,
    WK_WH_ID,
    WK_LOCN_ID,
    WK_OBJECT,
    WK_TRN_TYPE,
    WK_TRN_CODE,
    WK_TRN_DATE,
    WK_REFERENCE,
    WK_QTY,
    WK_PERSON_ID,
    WK_DEVICE_ID,
    WK_INSTANCE_ID);
   /* EXECUTE PROCEDURE TRAN_ARCHIVE; */
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_NIID FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 30 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'NIID') THEN
  BEGIN
   EXECUTE PROCEDURE PC_AUOB 
    NEW.RECORD_ID ,
    NEW.WH_ID,
    NEW.LOCN_ID,
    NEW.OBJECT,
    NEW.TRN_TYPE,
    NEW.TRN_CODE,
    NEW.TRN_DATE,
    NEW.REFERENCE,
    NEW.QTY,
    NEW.PERSON_ID,
    NEW.DEVICE_ID,
    NEW.INSTANCE_ID;
   /* EXECUTE PROCEDURE TRAN_ARCHIVE; */
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_NXAP FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 31 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'NXAP') THEN
  BEGIN
   EXECUTE PROCEDURE PC_DELETE_ONE_PROD_COND_STATUS 
    NEW.RECORD_ID ,
    NEW.WH_ID,
    NEW.LOCN_ID,
    NEW.OBJECT,
    NEW.TRN_TYPE,
    NEW.TRN_CODE,
    NEW.TRN_DATE,
    NEW.REFERENCE,
    NEW.QTY,
    NEW.PERSON_ID,
    NEW.DEVICE_ID;
   EXECUTE PROCEDURE TRAN_ARCHIVE;
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_NXOP FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 32 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'NXOP') THEN
  BEGIN
   EXECUTE PROCEDURE PC_DELETE_ONE_PROD_COND_STATUS 
    NEW.RECORD_ID ,
    NEW.WH_ID,
    NEW.LOCN_ID,
    NEW.OBJECT,
    NEW.TRN_TYPE,
    NEW.TRN_CODE,
    NEW.TRN_DATE,
    NEW.REFERENCE,
    NEW.QTY,
    NEW.PERSON_ID,
    NEW.DEVICE_ID;
   EXECUTE PROCEDURE TRAN_ARCHIVE;
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_NXCP FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 33 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'NXCP') THEN
  BEGIN
   EXECUTE PROCEDURE PC_DELETE_ONE_PROD_COND_STATUS 
    NEW.RECORD_ID ,
    NEW.WH_ID,
    NEW.LOCN_ID,
    NEW.OBJECT,
    NEW.TRN_TYPE,
    NEW.TRN_CODE,
    NEW.TRN_DATE,
    NEW.REFERENCE,
    NEW.QTY,
    NEW.PERSON_ID,
    NEW.DEVICE_ID;
   EXECUTE PROCEDURE TRAN_ARCHIVE;
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_NILT FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 34 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'NILT') THEN
  BEGIN
   EXECUTE PROCEDURE PC_NILT_NILS
    NEW.RECORD_ID ,
    NEW.WH_ID,
    NEW.LOCN_ID,
    NEW.OBJECT,
    NEW.TRN_TYPE,
    NEW.TRN_CODE,
    NEW.TRN_DATE,
    NEW.REFERENCE,
    NEW.QTY,
    NEW.PERSON_ID,
    NEW.DEVICE_ID;
   EXECUTE PROCEDURE TRAN_ARCHIVE;
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_NILS FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 35 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'NILS') THEN
  BEGIN
   EXECUTE PROCEDURE PC_NILT_NILS
    NEW.RECORD_ID ,
    NEW.WH_ID,
    NEW.LOCN_ID,
    NEW.OBJECT,
    NEW.TRN_TYPE,
    NEW.TRN_CODE,
    NEW.TRN_DATE,
    NEW.REFERENCE,
    NEW.QTY,
    NEW.PERSON_ID,
    NEW.DEVICE_ID;
   EXECUTE PROCEDURE TRAN_ARCHIVE;
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_TRLO FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 36 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'TRLO') THEN
  BEGIN
   EXECUTE PROCEDURE PC_TRLO_TRLI
    NEW.RECORD_ID ,
    NEW.WH_ID,
    NEW.LOCN_ID,
    NEW.OBJECT,
    NEW.TRN_TYPE,
    NEW.TRN_CODE,
    NEW.TRN_DATE,
    NEW.REFERENCE,
    NEW.QTY,
    NEW.PERSON_ID,
    NEW.DEVICE_ID;
   /* EXECUTE PROCEDURE TRAN_ARCHIVE; */
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_TRLI FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 37 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'TRLI') THEN
  BEGIN
   EXECUTE PROCEDURE PC_TRLO_TRLI
    NEW.RECORD_ID ,
    NEW.WH_ID,
    NEW.LOCN_ID,
    NEW.OBJECT,
    NEW.TRN_TYPE,
    NEW.TRN_CODE,
    NEW.TRN_DATE,
    NEW.REFERENCE,
    NEW.QTY,
    NEW.PERSON_ID,
    NEW.DEVICE_ID;
   /* EXECUTE PROCEDURE TRAN_ARCHIVE; */
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_TROL FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 38 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'TROL') THEN
  BEGIN
   EXECUTE PROCEDURE PC_TROL_TRIL
    NEW.RECORD_ID ,
    NEW.WH_ID,
    NEW.LOCN_ID,
    NEW.OBJECT,
    NEW.TRN_TYPE,
    NEW.TRN_CODE,
    NEW.TRN_DATE,
    NEW.REFERENCE,
    NEW.QTY,
    NEW.PERSON_ID,
    NEW.DEVICE_ID;
   /* EXECUTE PROCEDURE TRAN_ARCHIVE; */
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_TRIL FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 39 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'TRIL') THEN
  BEGIN
   EXECUTE PROCEDURE PC_TROL_TRIL
    NEW.RECORD_ID ,
    NEW.WH_ID,
    NEW.LOCN_ID,
    NEW.OBJECT,
    NEW.TRN_TYPE,
    NEW.TRN_CODE,
    NEW.TRN_DATE,
    NEW.REFERENCE,
    NEW.QTY,
    NEW.PERSON_ID,
    NEW.DEVICE_ID;
   /* EXECUTE PROCEDURE TRAN_ARCHIVE; */
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_TRSS FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 40 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'TRSS') THEN
  BEGIN
   EXECUTE PROCEDURE PC_TRSS 
    NEW.RECORD_ID ,
    NEW.WH_ID,
    NEW.LOCN_ID,
    NEW.OBJECT,
    NEW.TRN_TYPE,
    NEW.TRN_CODE,
    NEW.TRN_DATE,
    NEW.REFERENCE,
    NEW.QTY,
    NEW.PERSON_ID,
    NEW.DEVICE_ID;
   EXECUTE PROCEDURE TRAN_ARCHIVE;
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_WMAR FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 41 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'WMAR') THEN
  BEGIN
   EXECUTE PROCEDURE PC_WMAR 
    NEW.RECORD_ID ,
    NEW.WH_ID,
    NEW.LOCN_ID,
    NEW.OBJECT,
    NEW.TRN_TYPE,
    NEW.TRN_CODE,
    NEW.TRN_DATE,
    NEW.REFERENCE,
    NEW.QTY,
    NEW.PERSON_ID,
    NEW.DEVICE_ID,
    NEW.SUB_LOCN_ID;
   EXECUTE PROCEDURE TRAN_ARCHIVE;
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_GRNV FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 42 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_SAVE_DIRECTORY VARCHAR(75);
DECLARE VARIABLE WK_SAVE_FILENAME VARCHAR(255);
DECLARE VARIABLE WK_LABEL_LINE    VARCHAR(255);
DECLARE VARIABLE WK_TRN_DATE      VARCHAR(25);
DECLARE VARIABLE WK_RESULT        INTEGER;
BEGIN
   WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
   IF (WK_AUTORUN = 1) THEN
   BEGIN
      IF (NEW.TRN_TYPE = 'GRNV') THEN
      BEGIN
         WK_SAVE_DIRECTORY = '/tmp/';
         WK_SAVE_FILENAME = WK_SAVE_DIRECTORY || 'GRNVTRAN.log';
         WK_TRN_DATE = MER_YEAR(NEW.TRN_DATE) || VLPAD(MER_MONTH(NEW.TRN_DATE),'0',2) || VLPAD(MER_DAY(NEW.TRN_DATE),'0',2) || VLPAD(MER_HOUR(NEW.TRN_DATE),'0',2) || VLPAD(MER_MINUTE(NEW.TRN_DATE),'0',2) || VLPAD(SEC(NEW.TRN_DATE),'0',2);
         WK_LABEL_LINE = NEW.TRN_TYPE  || NEW.TRN_CODE || :WK_TRN_DATE ||
                VPAD(NEW.OBJECT,' ',30) || VPAD(NEW.WH_ID,' ',2) || VPAD(NEW.LOCN_ID,' ',8) || VPAD(NEW.SUB_LOCN_ID,' ',10) ||
                VPAD(NEW.REFERENCE,' ',40) || VLPAD(NEW.QTY,'0',10) || VPAD(NEW.PERSON_ID,' ',8) || VPAD(NEW.DEVICE_ID,' ',2) ||
                VPAD(NEW.INPUT_SOURCE,' ',9);
         WK_RESULT = FILE_WRITELN(WK_SAVE_FILENAME, WK_LABEL_LINE);
         IF ((NEW.TRN_CODE = 'S') OR 
             (NEW.TRN_CODE = 'I')) THEN
         BEGIN
            EXECUTE PROCEDURE ADD_NAMED_SSN_ISSN_GRNV
            NEW.WH_ID,
            NEW.LOCN_ID,
            NEW.OBJECT,
            NEW.TRN_DATE,
            NEW.QTY,
            NEW.SUB_LOCN_ID,    
            NEW.REFERENCE,    
            NEW.INPUT_SOURCE,    
            NEW.RECORD_ID,    
            NEW.TRN_CODE;    
         END
         ELSE
         BEGIN
            IF ((NEW.TRN_CODE = 'G') OR 
                (NEW.TRN_CODE = 'P')) THEN
            BEGIN 
               EXECUTE PROCEDURE ADD_SSN_ISSN_GRNV     
               NEW.WH_ID,
               NEW.LOCN_ID,
               NEW.OBJECT,
               NEW.TRN_DATE,
               NEW.QTY,
               NEW.SUB_LOCN_ID,    
               NEW.REFERENCE,    
               NEW.INPUT_SOURCE,    
               NEW.RECORD_ID;    
            END
            ELSE
            BEGIN
               IF ((NEW.TRN_CODE = 'H') OR 
                   (NEW.TRN_CODE = 'Q')) THEN
               BEGIN 
                  EXECUTE PROCEDURE ADD_SSN_ISSN_GRNV_WEIGHT     
                  NEW.WH_ID,
                  NEW.LOCN_ID,
                  NEW.OBJECT,
                  NEW.TRN_DATE,
                  NEW.QTY,
                  NEW.SUB_LOCN_ID,    
                  NEW.REFERENCE,    
                  NEW.INPUT_SOURCE,    
                  NEW.RECORD_ID;    
               END
            END
         END
         /* EXECUTE PROCEDURE TRAN_ARCHIVE; */
      END
   END
END ^

CREATE TRIGGER RUN_TRANSACTION_GRND FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 43 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_RECORD  INTEGER;
DECLARE VARIABLE WK_OBJECT  VARCHAR(30);
DECLARE VARIABLE WK_REFERENCE  VARCHAR(40);
DECLARE VARIABLE WK_AWB  VARCHAR(20);
DECLARE VARIABLE WK_WH_ID CHAR(2);
DECLARE VARIABLE WK_LOCN_ID  VARCHAR(10);
DECLARE VARIABLE WK_CARRIER  VARCHAR(10);
DECLARE VARIABLE WK_CARRIER_X  VARCHAR(12);
DECLARE VARIABLE WK_SUBLOCN  VARCHAR(10);
DECLARE VARIABLE WK_VECHICLE  VARCHAR(8);
DECLARE VARIABLE WK_GRN_TYPE CHAR(2);
DECLARE VARIABLE WK_LOADNO VARCHAR(10);
DECLARE VARIABLE WK_LOAD_LINE_NO VARCHAR(4);
/* DECLARE VARIABLE WK_CONTAINERS CHAR(1); */
DECLARE VARIABLE WK_CONTAINERS VARCHAR(40);
DECLARE VARIABLE WK_OWNER VARCHAR(10);
DECLARE VARIABLE WK_PALLET_QTY INTEGER;
DECLARE VARIABLE WK_PALLET_QTY_X VARCHAR(3);
DECLARE VARIABLE WK_QTY  INTEGER;
DECLARE VARIABLE WK_GRN  VARCHAR(20);
DECLARE VARIABLE WK_USER  VARCHAR(10);
DECLARE VARIABLE WK_DEVICE  VARCHAR(2);
DECLARE VARIABLE WK_DATE TIMESTAMP;
DECLARE VARIABLE WK_GRN_ID  VARCHAR(10);
/* DECLARE VARIABLE WK_ERROR_TEXT  VARCHAR(255); */
DECLARE VARIABLE WK_ERROR_TEXT  VARCHAR(1024);
DECLARE VARIABLE WK_DIRECTORY VARCHAR(80);
DECLARE VARIABLE WK_FILENAME VARCHAR(80);
DECLARE VARIABLE WK_FILENAME2 VARCHAR(80);
DECLARE VARIABLE WK_RESULT INTEGER;
DECLARE VARIABLE WK_SHIP_DATE_X  VARCHAR(30);
DECLARE VARIABLE WK_SHIP_DATE2_X  VARCHAR(30);
DECLARE VARIABLE WK_POSN  INTEGER;
DECLARE VARIABLE WK_SHIP  INTEGER;
DECLARE VARIABLE WK_SHIP_DATE TIMESTAMP;
DECLARE VARIABLE WK_OWNER_X  VARCHAR(12);
DECLARE VARIABLE WK_SUPPLIER  VARCHAR(10);
DECLARE VARIABLE WK_PRINTER  VARCHAR(40);
DECLARE VARIABLE WK_GRN_LABEL  VARCHAR(20);
DECLARE VARIABLE WK_HAVE_FILE_2 INTEGER;
DECLARE VARIABLE WK_DATE_X VARCHAR(24);
DECLARE VARIABLE WK_TIME VARCHAR(10);
DECLARE VARIABLE WK_LABEL_LINE  VARCHAR(110);
DECLARE VARIABLE WK_LABEL_QTY  INTEGER;
/* SUMEER - 18TH JUNE 2007 - 30TH JUNE 2007 */
DECLARE VARIABLE WK_PACK_OWNER_CODE VARCHAR(10) ;
DECLARE VARIABLE WK_PACK_OWNER_DESCRIPTION VARCHAR(40) ;
DECLARE VARIABLE WK_PACK_TYPE VARCHAR(2) ;
DECLARE VARIABLE WK_PACK_QTY_STRING VARCHAR(5) ;
DECLARE VARIABLE WK_PACK_QTY INTEGER ;
DECLARE VARIABLE WK_PACK_CHECK_CNT INTEGER ;
/* THE FOLLOWING VARIABLES ARE FOR TYPE 'L' */
DECLARE VARIABLE WK_PACK_CONTAINER_NO VARCHAR(20) ;
DECLARE VARIABLE WK_PACK_CONTAINER_TYPE VARCHAR(20) ;
DECLARE VARIABLE WK_DEFAULT_GRN_LABELS VARCHAR(2) ;
/* SUMEER - 18TH JUNE 2007 - 30TH JUNE 2007 */
DECLARE VARIABLE WK_PO_1_USER CHAR(1) ;
DECLARE VARIABLE WK_PO_RECEIVER VARCHAR(10) ;
DECLARE VARIABLE WK_FOUND INTEGER ;
DECLARE VARIABLE WK_LOG_FILENAME VARCHAR(80) ;
DECLARE VARIABLE WK_PO_DUE_DATE TIMESTAMP;
DECLARE VARIABLE WK_PO_COMPANY  VARCHAR(20);
DECLARE VARIABLE WK_DUMMY  VARCHAR(20);
DECLARE VARIABLE WK_DO_BARTENDER CHAR(1);
DECLARE VARIABLE WK_LINE_QTY INTEGER ;
DECLARE VARIABLE WK_GRN_PRIMARY_LABEL_ID VARCHAR(20);
DECLARE VARIABLE WK_LABEL_EXTENSION      VARCHAR(20);

BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'GRND') THEN
  BEGIN
     WK_RECORD = NEW.RECORD_ID; 
     /* WK_ERROR_TEXT = 'Processed OK'; */
     WK_ERROR_TEXT = 'Processed successfully';
     WK_SHIP_DATE = NULL;
     WK_LOG_FILENAME = '/tmp/grnd.log';
     IF (NEW.TRN_CODE = 'R') THEN
     BEGIN
        WK_GRN = '';
        WK_OBJECT = NEW.OBJECT;
        WK_AWB = substr(WK_OBJECT,1, 20);
        WK_POSN = POS(:WK_OBJECT,'|',0,1);
        IF (WK_POSN > -1) THEN
        BEGIN
           WK_AWB = SUBSTR(WK_OBJECT, 1, WK_POSN);
           EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_OBJECT, 2  RETURNING_VALUES :WK_SHIP_DATE2_X ; 
           WK_SHIP_DATE_X = SUBSTR(WK_SHIP_DATE2_X, 1, 4) || '-' ||
           SUBSTR(WK_SHIP_DATE2_X, 5, 6) || '-' ||
           SUBSTR(WK_SHIP_DATE2_X, 7, 8);
        END
        WK_WH_ID = NEW.WH_ID;
        WK_LOCN_ID = NEW.LOCN_ID;
        WK_CARRIER_X = WK_WH_ID || WK_LOCN_ID;
        WK_CARRIER = substr(WK_CARRIER_X,1,10);
        WK_SUBLOCN = NEW.SUB_LOCN_ID;
        WK_VECHICLE = substr(WK_SUBLOCN,1,8);
        WK_REFERENCE = NEW.REFERENCE;
        WK_GRN_TYPE = substr(WK_REFERENCE,1,2);
        EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_REFERENCE, 2  RETURNING_VALUES :WK_LOADNO ; 
        EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_REFERENCE, 3  RETURNING_VALUES :WK_LOAD_LINE_NO ; 
        EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_REFERENCE, 4  RETURNING_VALUES :WK_CONTAINERS ; 
        EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_REFERENCE, 5  RETURNING_VALUES :WK_OWNER ; 
        EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_REFERENCE, 6  RETURNING_VALUES :WK_PALLET_QTY_X ; 
        WK_PALLET_QTY = CAST(WK_PALLET_QTY_X AS INTEGER);
        WK_QTY = NEW.QTY;
        WK_USER = NEW.PERSON_ID;
        WK_DEVICE = NEW.DEVICE_ID;
        WK_DATE = NEW.TRN_DATE;
        IF (WK_GRN_TYPE = 'LD') THEN
        BEGIN
           IF (WK_LOADNO = '') THEN
           BEGIN
              EXECUTE PROCEDURE GET_LOAD_NO RETURNING_VALUES :WK_LOADNO;
           END
        END
        IF (WK_POSN > -1) THEN
        BEGIN
           WK_SHIP_DATE = CAST(:WK_SHIP_DATE_X AS TIMESTAMP);
           WHEN SQLCODE -413
           DO
           BEGIN
              /* No Ship date */
              WK_SHIP_DATE = NULL;
           END
        END
        /*
 if the order no is empty
 must calc the next order no to use

 for the screens ?? also have a table
 for companys allowed orders
 with a status
 company
 order
 status

 can I use the purchase_order for this ?? ***
 (ie is the order no on its own unique ??)
 I shall assume that it is
        */
        EXECUTE PROCEDURE ADD_GRN :WK_GRN, :WK_GRN_TYPE, :WK_QTY, '', 
                                  :WK_CARRIER, :WK_VECHICLE, :WK_AWB,
                                  :WK_PALLET_QTY, '', :WK_CONTAINERS,
                                  :WK_OWNER, :WK_USER, :WK_DEVICE,
                                  :WK_DATE, :WK_LOADNO, :WK_LOAD_LINE_NO,
                                  '', '', :WK_SHIP_DATE RETURNING_VALUES :WK_GRN_ID;
/*
        IF (WK_POSN > -1) THEN
        BEGIN
           UPDATE GRN SET SHIPPED_DATE = CAST(:WK_SHIP_DATE_X AS TIMESTAMP)
           WHERE GRN = :WK_GRN_ID;
           WHEN SQLCODE -413
           DO
           BEGIN
              -* No Ship date *-
              WK_SHIP = 0;
           END
        END
*/
        WK_ERROR_TEXT = 'GRN:' || WK_GRN_ID || ':LOAD:' || WK_LOADNO || ':message:' || WK_ERROR_TEXT;

        WK_DIRECTORY = '';
        SELECT FTP_DIRECTORY
           FROM CONTROL
           INTO :WK_DIRECTORY;
        WK_FILENAME = WK_DIRECTORY || WK_DEVICE || '.rp';
        /* clear devices file */
        WK_RESULT = FILE_DELETE(WK_FILENAME);
        WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_ERROR_TEXT); 
        UPDATE TRANSACTIONS SET COMPLETE='T',ERROR_TEXT=:WK_ERROR_TEXT WHERE RECORD_ID = :WK_RECORD;
     END

     IF (NEW.TRN_CODE = 'B') THEN
     BEGIN
        WK_GRN = '';
        WK_OBJECT = NEW.OBJECT;
        /* object is awb | ship date */
        WK_AWB = substr(WK_OBJECT,1, 20);
        WK_POSN = POS(:WK_OBJECT,'|',0,1);
        IF (WK_POSN > -1) THEN
        BEGIN
           WK_AWB = SUBSTR(WK_OBJECT, 1, WK_POSN);
           EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_OBJECT, 2  RETURNING_VALUES :WK_SHIP_DATE2_X ; 
           WK_SHIP_DATE_X = SUBSTR(WK_SHIP_DATE2_X, 1, 4) || '-' ||
           SUBSTR(WK_SHIP_DATE2_X, 5, 6) || '-' ||
           SUBSTR(WK_SHIP_DATE2_X, 7, 8);
        END
        WK_WH_ID = NEW.WH_ID;
        WK_LOCN_ID = NEW.LOCN_ID;
        WK_CARRIER_X = WK_WH_ID || WK_LOCN_ID;
        WK_CARRIER = substr(WK_CARRIER_X,1,10);
        WK_SUBLOCN = NEW.SUB_LOCN_ID;
        WK_VECHICLE = substr(WK_SUBLOCN,1,8);
        WK_REFERENCE = NEW.REFERENCE;
        WK_GRN_TYPE = substr(WK_REFERENCE,1,2);
        EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_REFERENCE, 2  RETURNING_VALUES :WK_LOADNO ; 
        EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_REFERENCE, 3  RETURNING_VALUES :WK_LOAD_LINE_NO ; 
        EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_REFERENCE, 4  RETURNING_VALUES :WK_CONTAINERS ; 
        EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_REFERENCE, 5  RETURNING_VALUES :WK_OWNER ; 
        EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_REFERENCE, 6  RETURNING_VALUES :WK_PALLET_QTY_X ; 
/* SUMEER - 18TH JUNE 2007 - 30TH JUNE 2007 */
        EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_REFERENCE, 7  RETURNING_VALUES :WK_PACK_OWNER_CODE ;
        EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_REFERENCE, 8  RETURNING_VALUES :WK_PACK_TYPE ;
        EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_REFERENCE, 9  RETURNING_VALUES :WK_PACK_QTY_STRING ;
/* SUMEER - 18TH JUNE 2007 - 30TH JUNE 2007 */

        IF (WK_OWNER <> 'NONE') THEN
        BEGIN
           WK_PALLET_QTY = CAST(WK_PALLET_QTY_X AS INTEGER);
           WHEN SQLCODE -413
           DO
           BEGIN
              /* No Pallet Qty */
              WK_PALLET_QTY = 0;
           END
        END
        ELSE
        BEGIN
           WK_PALLET_QTY = 0;
        END
        
        
        
/* SUMEER - 18TH JUNE 2007 - 30TH JUNE 2007 */
        IF (ALLTRIM(WK_PACK_QTY_STRING) <> '') THEN
        BEGIN
             WK_PACK_QTY = CAST(WK_PACK_QTY_STRING AS INTEGER);
             WHEN SQLCODE -413
             DO
             BEGIN
                /* No Pallet Qty */
                WK_PACK_QTY = 0;
             END
        END
        ELSE
        BEGIN
             WK_PACK_QTY = 0;
        END
/*
        IF (RTRIM(LTRIM(WK_PACK_QTY_STRING)) <> '') THEN
        BEGIN
             WK_PACK_QTY = CAST(WK_PACK_QTY_STRING AS INTEGER);
        END
        ELSE
        BEGIN
             WK_PACK_QTY = 0;
        END
*/
        
        WK_PACK_OWNER_DESCRIPTION = 'NOT DEF';
        
        SELECT COUNT(*) FROM OPTIONS
        WHERE GROUP_CODE = 'PACK_OWNER'
        AND CODE = :WK_PACK_OWNER_CODE
        INTO WK_PACK_CHECK_CNT;


        IF (WK_PACK_CHECK_CNT > 0) THEN
        BEGIN
             SELECT DESCRIPTION  FROM OPTIONS
             WHERE GROUP_CODE = 'PACK_OWNER'
             AND CODE = :WK_PACK_OWNER_CODE
             INTO WK_PACK_OWNER_DESCRIPTION;
        END

/* SUMEER - 18TH JUNE 2007 - 30TH JUNE 2007 */

        

        WK_QTY = NEW.QTY;
        WK_USER = NEW.PERSON_ID;
        WK_DEVICE = NEW.DEVICE_ID;
        WK_DATE = NEW.TRN_DATE;
        IF (WK_POSN > -1) THEN
        BEGIN
           WK_SHIP_DATE = CAST(:WK_SHIP_DATE_X AS TIMESTAMP);
           WHEN SQLCODE -413
           DO
           BEGIN
              /* No Ship date */
              WK_SHIP_DATE = NULL;
           END
        END
        IF (WK_GRN_TYPE = 'PO') THEN
        BEGIN
           WK_PO_1_USER = 'F';
           SELECT PO_RECEIVE_BY_1_USER FROM CONTROL
           INTO :WK_PO_1_USER;

           IF (WK_PO_1_USER IS NULL) THEN
           BEGIN
              WK_PO_1_USER = 'F';
           END
           IF (WK_PO_1_USER = 'T') THEN
           BEGIN
              WK_PO_RECEIVER = '';
              SELECT PO_RECEIVER 
              FROM PURCHASE_ORDER 
              WHERE PURCHASE_ORDER = :WK_LOADNO
              INTO :WK_PO_RECEIVER;
              IF (WK_PO_RECEIVER IS NULL) THEN
              BEGIN
                 WK_PO_RECEIVER = '';
              END
              IF (WK_PO_RECEIVER = '') THEN
              BEGIN
                 /* is OK */
                  UPDATE PURCHASE_ORDER 
                  SET PO_RECEIVER = :WK_DEVICE
                  WHERE PURCHASE_ORDER = :WK_LOADNO;
              END
              ELSE
              BEGIN
                 IF (WK_PO_RECEIVER <> WK_DEVICE) THEN
                 BEGIN
                    WK_ERROR_TEXT = 'Cannot do GRNV Order owned by ' || :WK_PO_RECEIVER;
                    EXECUTE PROCEDURE UPDATE_TRAN (:WK_RECORD, 'F', :WK_ERROR_TEXT);
                    EXIT;
                 END
              END
           END
        END
        IF (WK_GRN_TYPE = 'LD') THEN
        BEGIN
           IF (WK_LOADNO = '') THEN
           BEGIN
              EXECUTE PROCEDURE GET_LOAD_NO RETURNING_VALUES :WK_LOADNO;
           END
        END
        /* 8 sep 2008 sumeer we have added a '' for pallet_yn and remove wk_owner which we dont have at this stage. */
        EXECUTE PROCEDURE ADD_GRN :WK_GRN, :WK_GRN_TYPE, :WK_QTY, '',
                                  :WK_CARRIER, :WK_VECHICLE, :WK_AWB,
                                  :WK_PALLET_QTY, '', :WK_CONTAINERS,
                                  :WK_OWNER, :WK_USER, :WK_DEVICE,
                                  :WK_DATE, :WK_LOADNO, :WK_LOAD_LINE_NO,
                                  '', '', :WK_SHIP_DATE RETURNING_VALUES :WK_GRN_ID;
                                  
        /* SUMEER - 18TH JUNE 2007 - 30TH JUNE 2007 */
        /* I HAVE NOT  MODIFIED ADD_GRN PROCEDURE AS I EXPECT OTHER TRIGGERS OR PROCEDURES TO CALL IT AS WELL. HENCE I AM TAKING THE SAFE OPTION OF UPDATE */
        
        UPDATE GRN SET PACK_CRATE_OWNER = :WK_PACK_OWNER_DESCRIPTION, PACK_CRATE_TYPE = :WK_PACK_TYPE, PACK_CRATE_QTY = :WK_PACK_QTY
        WHERE GRN = :WK_GRN_ID;
        /* SUMEER - 18TH JUNE 2007 - 30TH JUNE 2007 */

                                  

/*
        IF (WK_POSN > -1) THEN
        BEGIN
           UPDATE GRN SET SHIPPED_DATE = CAST(:WK_SHIP_DATE_X AS TIMESTAMP)
           WHERE GRN = :WK_GRN_ID;
           WHEN SQLCODE -413
           DO
           BEGIN
              -* No Ship date *-
              WK_SHIP = 0;
           END
        END
*/
        WK_ERROR_TEXT = 'GRN:' || WK_GRN_ID || ':LOAD:' || WK_LOADNO || ':message:' || WK_ERROR_TEXT;
        UPDATE TRANSACTIONS SET COMPLETE='T',ERROR_TEXT=:WK_ERROR_TEXT WHERE RECORD_ID = :WK_RECORD;
   
     END

     IF (NEW.TRN_CODE = 'G') THEN
     BEGIN
        /* do nothing since the delphi has already done it */
        WK_SHIP = 0;
        UPDATE TRANSACTIONS SET COMPLETE='T',ERROR_TEXT=:WK_ERROR_TEXT WHERE RECORD_ID = :WK_RECORD;
     END

     IF (NEW.TRN_CODE = 'I') THEN
     BEGIN
        WK_GRN = '';
        WK_OBJECT = NEW.OBJECT;
        /* object is awb | ship date */
        IF (LEN(WK_OBJECT) > 20) THEN
        BEGIN
           WK_AWB = substr(WK_OBJECT,1, 20);
        END
        ELSE
        BEGIN
           WK_AWB = WK_OBJECT;
        END
        WK_POSN = POS(:WK_OBJECT,'|',0,1);
        IF (WK_POSN > -1) THEN
        BEGIN
           WK_AWB = SUBSTR(WK_OBJECT, 1, WK_POSN);
           EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_OBJECT, 2  RETURNING_VALUES :WK_SHIP_DATE2_X ; 
           WK_SHIP_DATE_X = SUBSTR(WK_SHIP_DATE2_X, 1, 4) || '-' ||
           SUBSTR(WK_SHIP_DATE2_X, 5, 6) || '-' ||
           SUBSTR(WK_SHIP_DATE2_X, 7, 8);
        END
        WK_WH_ID = NEW.WH_ID;
        WK_LOCN_ID = NEW.LOCN_ID;
        /* WK_CARRIER_X = WK_WH_ID || WK_LOCN_ID; */
        WK_CARRIER = '';
        SELECT DEFAULT_CARRIER_ID FROM CONTROL INTO :WK_CARRIER;
        IF (WK_CARRIER IS NULL) THEN
        BEGIN
           WK_CARRIER = '';
        END
        WK_SUBLOCN = NEW.SUB_LOCN_ID;
        WK_VECHICLE = '';
        WK_REFERENCE = NEW.REFERENCE;
        WK_GRN_TYPE = substr(WK_REFERENCE,1,2);
        EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_REFERENCE, 2  RETURNING_VALUES :WK_LOADNO ; 
        EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_REFERENCE, 3  RETURNING_VALUES :WK_LOAD_LINE_NO ; 

        EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_REFERENCE, 4  RETURNING_VALUES :WK_CONTAINERS ; 
        EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_REFERENCE, 5  RETURNING_VALUES :WK_OWNER ; 
        EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_REFERENCE, 6  RETURNING_VALUES :WK_PALLET_QTY_X ; 
        EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_REFERENCE, 7  RETURNING_VALUES :WK_PACK_OWNER_CODE ;
        EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_REFERENCE, 8  RETURNING_VALUES :WK_PACK_TYPE ;
        EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_REFERENCE, 9  RETURNING_VALUES :WK_PACK_QTY_STRING ;

        IF (WK_OWNER = '') THEN
        BEGIN
           WK_OWNER = 'N';
        END
        WK_OWNER = SUBSTR(WK_OWNER,1,1);
        IF (WK_OWNER <> 'NONE' AND WK_OWNER <> 'N') THEN
        BEGIN
           WK_PALLET_QTY = CAST(WK_PALLET_QTY_X AS INTEGER);
        END
        ELSE
        BEGIN
           WK_PALLET_QTY = 0;
        END
        IF (WK_CONTAINERS = '') THEN
        BEGIN
           WK_CONTAINERS = 'N';
        END
        WK_CONTAINERS = SUBSTR(WK_CONTAINERS,1,1);
        
        IF (RTRIM(LTRIM(WK_PACK_QTY_STRING)) <> '') THEN
        BEGIN
             WK_PACK_QTY = CAST(WK_PACK_QTY_STRING AS INTEGER);
        END
        ELSE
        BEGIN
             WK_PACK_QTY = 0;
        END
        
        WK_PACK_OWNER_DESCRIPTION = 'NOT DEF';
        
        SELECT COUNT(*) FROM OPTIONS
        WHERE GROUP_CODE = 'PACK_OWNER'
        AND CODE = :WK_PACK_OWNER_CODE
        INTO WK_PACK_CHECK_CNT;


        IF (WK_PACK_CHECK_CNT > 0) THEN
        BEGIN
             SELECT DESCRIPTION  FROM OPTIONS
             WHERE GROUP_CODE = 'PACK_OWNE'
             AND CODE = :WK_PACK_OWNER_CODE
             INTO WK_PACK_OWNER_DESCRIPTION;
        END

        WK_QTY = NEW.QTY;
        WK_USER = NEW.PERSON_ID;
        WK_DEVICE = NEW.DEVICE_ID;
        WK_DATE = NEW.TRN_DATE;
        IF (WK_POSN > -1) THEN
        BEGIN
           WK_SHIP_DATE = CAST(:WK_SHIP_DATE_X AS TIMESTAMP);
           WHEN SQLCODE -413
           DO
           BEGIN
              /* No Ship date */
              WK_SHIP_DATE = NULL;
           END
        END
        IF (WK_GRN_TYPE = 'PO') THEN
        BEGIN
           WK_PO_1_USER = 'F';
           SELECT PO_RECEIVE_BY_1_USER FROM CONTROL
           INTO :WK_PO_1_USER;

           IF (WK_PO_1_USER IS NULL) THEN
           BEGIN
              WK_PO_1_USER = 'F';
           END
           IF (WK_PO_1_USER = 'T') THEN
           BEGIN
              WK_PO_RECEIVER = '';
              SELECT PO_RECEIVER 
              FROM PURCHASE_ORDER 
              WHERE PURCHASE_ORDER = :WK_LOADNO
              INTO :WK_PO_RECEIVER;
              IF (WK_PO_RECEIVER IS NULL) THEN
              BEGIN
                 WK_PO_RECEIVER = '';
              END
              IF (WK_PO_RECEIVER = '') THEN
              BEGIN
                 /* is OK */
                  UPDATE PURCHASE_ORDER 
                  SET PO_RECEIVER = :WK_DEVICE
                  WHERE PURCHASE_ORDER = :WK_LOADNO;
              END
              ELSE
              BEGIN
                 IF (WK_PO_RECEIVER <> WK_DEVICE) THEN
                 BEGIN
                    WK_ERROR_TEXT = 'Cannot do GRNV Order owned by ' || :WK_PO_RECEIVER;
                    EXECUTE PROCEDURE UPDATE_TRAN (:WK_RECORD, 'F', :WK_ERROR_TEXT);
                    EXIT;
                 END
              END
           END
        END
        IF (WK_GRN_TYPE = 'LD') THEN
        BEGIN
           IF (WK_LOADNO = '') THEN
           BEGIN
              EXECUTE PROCEDURE GET_LOAD_NO RETURNING_VALUES :WK_LOADNO;
           END
        END
        EXECUTE PROCEDURE ADD_GRN :WK_GRN, :WK_GRN_TYPE, :WK_QTY, '',
                                  :WK_CARRIER, :WK_VECHICLE, :WK_AWB,
                                  :WK_PALLET_QTY, '', :WK_CONTAINERS,
                                  :WK_OWNER, :WK_USER, :WK_DEVICE,
                                  :WK_DATE, :WK_LOADNO, :WK_LOAD_LINE_NO,
                                  '', '', :WK_SHIP_DATE RETURNING_VALUES :WK_GRN_ID;
                                  
        UPDATE GRN SET PACK_CRATE_OWNER = :WK_PACK_OWNER_DESCRIPTION, PACK_CRATE_TYPE = :WK_PACK_TYPE, PACK_CRATE_QTY = :WK_PACK_QTY
        WHERE GRN = :WK_GRN_ID;

        WK_ERROR_TEXT = 'GRN:' || WK_GRN_ID || ':LOAD:' || WK_LOADNO || ':message:' || WK_ERROR_TEXT;
        UPDATE TRANSACTIONS SET COMPLETE='T',ERROR_TEXT=:WK_ERROR_TEXT WHERE RECORD_ID = :WK_RECORD;
        /* save the grn in the session table */
        IF (WK_GRN_TYPE = 'IP') THEN
        BEGIN
           UPDATE PURCHASE_ORDER
           SET PO_GRN = :WK_GRN_ID
           WHERE PURCHASE_ORDER = :WK_LOADNO;
           SELECT PO_DUE_DATE 
           FROM PURCHASE_ORDER 
           WHERE PURCHASE_ORDER = :WK_LOADNO
           INTO :WK_PO_DUE_DATE;
           IF (WK_PO_DUE_DATE IS NULL) THEN
           BEGIN
              UPDATE GRN SET WH_ID = :WK_WH_ID,
              GRN_STATUS = 'IN'
              WHERE GRN = :WK_GRN_ID;
           END
           ELSE
           BEGIN
              UPDATE GRN SET GRN_DUE_DATE = :WK_PO_DUE_DATE,
              WH_ID = :WK_WH_ID,
              GRN_STATUS = 'IN'
              WHERE GRN = :WK_GRN_ID;
           END
        END
        WK_FOUND = 0;
        SELECT 1
        FROM SESSION
        WHERE DEVICE_ID = :WK_DEVICE
        AND CODE = 'CURRENT_GRN'
        INTO :WK_FOUND;
        IF (WK_FOUND IS NULL) THEN
        BEGIN
           WK_FOUND = 0;
        END
        IF (WK_FOUND = 0) THEN
        BEGIN
           INSERT INTO SESSION (DEVICE_ID, CODE, DESCRIPTION, CREATE_DATE) VALUES (:WK_DEVICE, 'CURRENT_GRN', :WK_GRN_ID, :WK_DATE);
        END
        ELSE
        BEGIN
           UPDATE SESSION SET DESCRIPTION = :WK_GRN_ID, CREATE_DATE = 'NOW'
           WHERE DEVICE_ID = :WK_DEVICE
           AND CODE = 'CURRENT_GRN';
        END
   
     END

     IF (NEW.TRN_CODE = 'L') THEN
     BEGIN
/*
create a new class for this transaction GRND|L

GRND|(G,R,B) does a create of GRN for a purchase order
 or LOAD

GRND|L then for the given GRN creates the qty of
 GRN Labels 
 was going to have a new table grn_order
 with 
 grn
 order no
 grn_label_no (calced a G followed by the next generated no)
 company (person)
 supplier (person)
 uniqueness is 
 the grn_label_no
 or order_no + company ***
 I shall use order no as unique
 
 if the order no is empty
 must calc the next order no to use

 for the screens ?? also have a table
 for companys allowed orders
 with a status
 company
 order
 status

 can I use the purchase_order for this ?? ***
 (ie is the order no on its own unique ??)
 I shall assume that it is

*/
        WK_OBJECT = NEW.OBJECT;
        WK_GRN = substr(WK_OBJECT,1, 20);
        WK_POSN = POS(:WK_OBJECT,'|',0,1);
        IF (WK_POSN > -1) THEN
        BEGIN
           WK_GRN = SUBSTR(WK_OBJECT, 1, WK_POSN);
        END
        WK_GRN = VRTRIM(WK_GRN);
        IF (WK_GRN = '') THEN
        BEGIN
           /* get the grn */
           SELECT DESCRIPTION
           FROM SESSION
           WHERE DEVICE_ID = :WK_DEVICE
           AND CODE = 'CURRENT_GRN'
           INTO :WK_GRN;
        END
        WK_WH_ID = NEW.WH_ID;
        WK_LOCN_ID = NEW.LOCN_ID;
        WK_SUBLOCN = NEW.SUB_LOCN_ID;
        WK_SUPPLIER = WK_SUBLOCN;

        WK_LOADNO = '';
        WK_PRINTER = 'PA';
        WK_REFERENCE = NEW.REFERENCE;
        WK_GRN_TYPE = SUBSTR(WK_REFERENCE,1,2);
        WK_OWNER_X = WK_WH_ID || WK_LOCN_ID;
        
         
/*
        IF (WK_GRN_TYPE = 'IP') THEN
        BEGIN
           WK_OWNER_X =  WK_LOCN_ID;
        END
*/
        EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_REFERENCE, 2  RETURNING_VALUES :WK_LOADNO ; 
        IF (WK_GRN_TYPE = 'IP') THEN
        BEGIN
           WK_PO_COMPANY = '';
           SELECT COMPANY_ID 
           FROM PURCHASE_ORDER 
           WHERE PURCHASE_ORDER = :WK_LOADNO
           INTO :WK_PO_COMPANY;
           IF ((WK_PO_COMPANY IS NULL) OR (WK_PO_COMPANY = '')) THEN
           BEGIN
              WK_DUMMY =  WK_OWNER_X;
           END
           ELSE
           BEGIN
              WK_OWNER_X =  WK_PO_COMPANY;
           END
        END
        WK_OWNER = SUBSTR(WK_OWNER_X,1,10);
         UPDATE GRN SET COMMENTS = :WK_OWNER_X WHERE GRN = :WK_GRN;

        EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_REFERENCE, 3  RETURNING_VALUES :WK_PACK_CONTAINER_NO ;
        EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_REFERENCE, 4  RETURNING_VALUES :WK_PACK_CONTAINER_TYPE;
        /* SUMEER SHOREE 24TH JUNE 2007 - HAVE CHANGED THE PRINTER FROM 4 --> 5
        MOREOVER FRANK HAS NOT HARDCODED THE PRINTER AS THE FOLLOWING CODE STORES THE VALUE IN WK_PRINTER.
        WK_PRINTER = 'PA' THEREFORE IS JUST A DEFAULT VALUE.
        */
        EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_REFERENCE, 5  RETURNING_VALUES :WK_PRINTER ;
        WK_PRINTER = VRTRIM(WK_PRINTER);
        IF (WK_PRINTER = '') THEN
        BEGIN
           WK_PRINTER = 'PA';
        END
        WK_QTY = NEW.QTY;
        WK_USER = NEW.PERSON_ID;
        WK_DEVICE = NEW.DEVICE_ID;
        WK_DATE = NEW.TRN_DATE;
        WK_DATE_X = LPAD(MER_DAY(WK_DATE),'0',2) || '/' || LPAD(MER_MONTH(WK_DATE),'0',2) || '/' || SUBSTR(CAST(MER_YEAR(WK_DATE) AS CHAR(4)) , 3,4);
        WK_TIME = LPAD(MER_HOUR(WK_DATE),'0',2) || ':' || LPAD(MER_MINUTE(WK_DATE),'0',2) ;
        WK_DATE_X = WK_DATE_X || ' ' || WK_TIME;
        IF (STRLEN(WK_PACK_CONTAINER_TYPE) > 2) THEN
        BEGIN
           WK_PACK_CONTAINER_TYPE = SUBSTR(WK_PACK_CONTAINER_TYPE,1,2);
        END
        
        SELECT DEFAULT_GRN_LABELS FROM CONTROL
        INTO :WK_DEFAULT_GRN_LABELS;

        IF (WK_DEFAULT_GRN_LABELS IS NULL) THEN
        BEGIN
           WK_DEFAULT_GRN_LABELS = 0;
        END
        IF (WK_QTY IS NULL) THEN
        BEGIN
           WK_QTY = 0;
        END
        IF (WK_QTY = 0) THEN
        BEGIN
           WK_LABEL_QTY = WK_DEFAULT_GRN_LABELS;
        END
        ELSE
        BEGIN
           WK_LABEL_QTY = WK_QTY;
        END

        SELECT AWB_CONSIGNMENT_NO
        FROM GRN
        WHERE GRN = :WK_GRN
        INTO :WK_AWB;
        UPDATE GRN SET RETURN_ID = :WK_SUPPLIER,
        CONTAINER_NO = :WK_PACK_CONTAINER_NO,
        SHIP_CONTAINER_TYPE = :WK_PACK_CONTAINER_TYPE,
        OWNER_ID = :WK_OWNER
        WHERE GRN = :WK_GRN;
        /* need the directory for this label set */
        SELECT WORKING_DIRECTORY FROM SYS_EQUIP 
           WHERE DEVICE_ID = :WK_PRINTER
           INTO :WK_DIRECTORY;
        /* must create qty of labels
           and send the print request to the printer */

        WK_HAVE_FILE_2 = 0;
        /* ok now have wk_grn_label */
        /* if (WK_DEFAULT_GRN_LABELS > 0) then */
        IF (WK_LABEL_QTY > 0) THEN
        BEGIN
           IF (WK_AWB IS NULL) then
           BEGIN
              WK_AWB = '';
           END
           /* want to in a for loop for each of qty 
              calc the next label_extension to use
              calc the next label_no        to use
              insert the grn_order

              at the end
              execute pc_label_grn
              for the labels 
           */
           WK_DO_BARTENDER = 'N';
           WK_LINE_QTY = 0;
           WHILE (WK_LINE_QTY < WK_LABEL_QTY)
           DO
           BEGIN
              SELECT LABEL_NO 
              FROM NEXT_GRN_ORDER_LABEL
              INTO :WK_GRN_LABEL ;
              IF (WK_LINE_QTY = 0) THEN
              BEGIN
                 WK_GRN_PRIMARY_LABEL_ID = WK_GRN_LABEL;
              END
              WK_LABEL_EXTENSION = LPAD(WK_LINE_QTY,'0',2);
              INSERT INTO GRN_ORDER (GRN ,
                   ORDER_NO ,
                   GRN_LABEL_NO ,
                   COMPANY_ID ,
                   SUPPLIER_ID ,
                   CREATE_DATE ,
                   CREATED_BY,
                   LABEL_EXTENSION,
                   GRN_PARENT_LABEL_ID )
              VALUES (:WK_GRN,
                   :WK_LOADNO,
                   :WK_GRN_LABEL,
                   :WK_OWNER,
                   :WK_SUPPLIER,
                   :WK_DATE,
                   :WK_USER,
                   :WK_LABEL_EXTENSION,
                   :WK_GRN_PRIMARY_LABEL_ID);
              WK_LINE_QTY = WK_LINE_QTY + 1;
                SELECT RES, ERROR_TEXT, DO_BARTENDER 
                FROM PC_LABEL_GRN (:WK_PRINTER ,
                                   1,
                                   :WK_GRN  ,
                                   :WK_GRN_LABEL ,
                                   :WK_USER)
                INTO :WK_RESULT, :WK_ERROR_TEXT, :WK_DO_BARTENDER;
           END
                IF (WK_DO_BARTENDER = 'T') THEN
                BEGIN
                   /* write printer file  */
                   /* append the file name to the directory*/
                   WK_FILENAME = WK_DIRECTORY || 'GRN.1xt';
                    WK_LABEL_LINE = '"' || WK_GRN_PRIMARY_LABEL_ID || '","' ||
                        WK_GRN || '","' ||
                        WK_GRN_TYPE || '","' ||
                        WK_LOADNO || '","' ||
                        WK_AWB || '",' ||
                        WK_LABEL_QTY || ',"' ||
                        WK_DATE_X || '","' ||
                        WK_PRINTER || '",' ||
                        /* WK_DEFAULT_GRN_LABELS || ''; */
                        WK_LABEL_QTY || '';
                    WK_HAVE_FILE_2 = 1;
                    WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE);
                    IF (WK_RESULT <> 0) THEN
                    BEGIN
                       WK_FILENAME = WK_DIRECTORY || 'GRN.2xt';
                       WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE);
                       WK_HAVE_FILE_2 = -1;
                    END
                    IF (WK_HAVE_FILE_2 = 1) THEN
                    BEGIN
                       /* rename grn.1xt to grn.txt */
                       WK_FILENAME = WK_DIRECTORY || 'GRN.1xt';
                       WK_FILENAME2 = WK_DIRECTORY || 'GRN.txt';
                       WK_RESULT = FILE_RENAME(WK_FILENAME, WK_FILENAME2);
                    END
                    IF (WK_HAVE_FILE_2 = -1) THEN
                    BEGIN
                       /* rename grn.1xt to grn.txt */
                       WK_FILENAME = WK_DIRECTORY || 'GRN.2xt';
                       WK_FILENAME2 = WK_DIRECTORY || 'GRN.txt';
                       WK_RESULT = FILE_RENAME(WK_FILENAME, WK_FILENAME2);
                    END
                END
        END /* iF WK_DEFAULT_GRN_LABELS > 0 */

        UPDATE TRANSACTIONS SET COMPLETE='T',ERROR_TEXT=:WK_ERROR_TEXT WHERE RECORD_ID = :WK_RECORD;
     END

  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_QANE FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 43 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_ISSN_SSNID VARCHAR(30);
DECLARE VARIABLE WK_SSN_SSNID VARCHAR(30);
DECLARE VARIABLE WK_RECORD  INTEGER;
DECLARE VARIABLE WK_QUESTION  INTEGER;
DECLARE VARIABLE WK_HAS_A_ERROR  INTEGER;
DECLARE VARIABLE WK_HAS_B_ERROR  INTEGER;
DECLARE VARIABLE WK_HAS_C_ERROR  INTEGER;
DECLARE VARIABLE WK_HAS_D_ERROR  INTEGER;
DECLARE VARIABLE WK_DATE  TIMESTAMP;
DECLARE VARIABLE WK_TEST_ID INTEGER;
DECLARE VARIABLE WK_CATEGORY VARCHAR(1);
DECLARE VARIABLE WK_NEW_STATUS VARCHAR(2);
DECLARE VARIABLE WK_ALLOWED_STATUS VARCHAR(40);
DECLARE VARIABLE strDesc VARCHAR(30);
DECLARE VARIABLE WK_DO_UASL CHAR(1);
DECLARE VARIABLE WK_TEST_PROD VARCHAR(30);
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'QANE') THEN
  BEGIN
   /* must update passed ssn answer_id = null
      question_id = sequence 0 question for type
      and remove records from resume test for this ssn_id
   */
     WK_ISSN_SSNID = NEW.OBJECT; 
     WK_SSN_SSNID = NEW.OBJECT; 
     WK_RECORD = NEW.RECORD_ID; 
     WK_DATE = NEW.TRN_DATE; 
     /* get seq 0 question */
     SELECT TQ.QUESTION_ID, SN.SSN_ID 
         FROM ISSN ISS 
              JOIN SSN SN ON SN.SSN_ID = ISS.ORIGINAL_SSN 
                 JOIN TEST_QUESTIONS TQ ON TQ.SSN_TYPE = SN.SSN_TYPE
         WHERE ISS.SSN_ID = :WK_ISSN_SSNID
              AND TQ.SEQUENCE = 0
         INTO :WK_QUESTION, :WK_SSN_SSNID;
     DELETE FROM RESUME_TEST WHERE SSN_ID = :WK_ISSN_SSNID;
     SELECT TEST_ID FROM SSN_TEST 
         WHERE SSN_ID=:WK_SSN_SSNID AND STATUS_TEST = 'OP'
         INTO :WK_TEST_ID;
     UPDATE SSN_TEST SET STATUS_TEST = 'CL',END_DATE=:WK_DATE 
         WHERE SSN_ID=:WK_SSN_SSNID AND STATUS_TEST = 'OP';
     WK_HAS_A_ERROR = 0;
     WK_HAS_B_ERROR = 0;
     WK_HAS_C_ERROR = 0;
     WK_HAS_D_ERROR = 0;
     SELECT COUNT(*) FROM PRODUCT_COND_STATUS 
         WHERE SSN_ID = :WK_SSN_SSNID
           AND CODE = 'A'
           AND ORIGINAL_TEST = 'S'
         INTO :WK_HAS_A_ERROR;
     SELECT COUNT(*) FROM PRODUCT_COND_STATUS 
         WHERE SSN_ID = :WK_SSN_SSNID
           AND CODE = 'B'
           AND ORIGINAL_TEST = 'S'
         INTO :WK_HAS_B_ERROR;
     SELECT COUNT(*) FROM PRODUCT_COND_STATUS 
         WHERE SSN_ID = :WK_SSN_SSNID
           AND CODE = 'C'
           AND ORIGINAL_TEST = 'S'
         INTO :WK_HAS_C_ERROR;
     SELECT COUNT(*) FROM PRODUCT_COND_STATUS 
         WHERE SSN_ID = :WK_SSN_SSNID
           AND CODE = 'D'
           AND ORIGINAL_TEST = 'S'
         INTO :WK_HAS_D_ERROR;
     IF (WK_HAS_A_ERROR = 0) THEN
     BEGIN
        /* no failures */
        EXECUTE PROCEDURE GET_GLOBAL_CONDITION 1, 'P' RETURNING_VALUES :strDesc;
        UPDATE SSN
        /*SET OTHER1 = 'AS NEW CONDITION'*/
        SET OTHER1 = :strDesc
        WHERE SSN_ID = :WK_SSN_SSNID;
     END
     IF (WK_HAS_B_ERROR = 0) THEN
     BEGIN
        EXECUTE PROCEDURE GET_GLOBAL_CONDITION 2, 'P' RETURNING_VALUES :strDesc;
        UPDATE SSN
        /*SET OTHER2 = 'TESTED - OK'*/
        SET OTHER2 = :strDesc
        WHERE SSN_ID = :WK_SSN_SSNID;
     END
     IF (WK_HAS_C_ERROR = 0) THEN
     BEGIN
        EXECUTE PROCEDURE GET_GLOBAL_CONDITION 3, 'P' RETURNING_VALUES :strDesc;
        UPDATE SSN
        /*SET OTHER3 = 'COMPLETE'*/
        SET OTHER3 = :strDesc
        WHERE SSN_ID = :WK_SSN_SSNID;
     END
     IF (WK_HAS_D_ERROR = 0) THEN
     BEGIN
        EXECUTE PROCEDURE GET_GLOBAL_CONDITION 4, 'P' RETURNING_VALUES :strDesc;
        UPDATE SSN
        /*SET OTHER4 = 'NO SERVICE'*/
        SET OTHER4 = :strDesc
        WHERE SSN_ID = :WK_SSN_SSNID;
     END
     IF ((WK_HAS_A_ERROR = 0) AND
         (WK_HAS_B_ERROR = 0) AND
         (WK_HAS_C_ERROR = 0) AND
         (WK_HAS_D_ERROR = 0)) THEN 
     BEGIN
        UPDATE SSN SET ANSWER_ID = NULL,QUESTION_ID=:WK_QUESTION,STATUS_SSN='PA' WHERE SSN_ID = :WK_SSN_SSNID;
        /* UPDATE ISSN SET ISSN_STATUS ='PA' WHERE SSN_ID = :WK_SSN_SSNID; */
        SELECT TEST_FROM_ALLOWED_SSN_STATUS, 
               SEND_UASL_V4 
        FROM CONTROL 
        INTO :WK_ALLOWED_STATUS, 
             :WK_DO_UASL;
        UPDATE ISSN SET ISSN_STATUS ='PA' 
        WHERE ORIGINAL_SSN = :WK_SSN_SSNID
        AND (WH_ID < 'X' OR WH_ID > 'X~') 
        AND (POS(:WK_ALLOWED_STATUS,ISSN.ISSN_STATUS,0,1) > -1);
 /* cannot update issns in 'X' wh_ids 
           or status starting 'Q' 'D' 'A' 'X' 
                     'P' (except 'PA')
        */
        IF (WK_DO_UASL = 'T') THEN
        BEGIN
           WK_TEST_PROD = '';
           SELECT PROD_ID FROM ISSN WHERE SSN_ID = :WK_SSN_SSNID
           INTO :WK_TEST_PROD;
           IF (WK_TEST_PROD IS NOT NULL) THEN
           BEGIN
              EXECUTE PROCEDURE SEND_PICKABLE_STOCK (:WK_TEST_PROD,
                 NEW.PERSON_ID,
                 NEW.DEVICE_ID,
                 :WK_DATE);
           END
        END
     END
     ELSE
     BEGIN
        SELECT TEST_FAIL_STATUS FROM CONTROL INTO :WK_NEW_STATUS;
        UPDATE SSN SET ANSWER_ID = NULL,QUESTION_ID=:WK_QUESTION,STATUS_SSN=:WK_NEW_STATUS WHERE SSN_ID = :WK_SSN_SSNID;
        /* UPDATE ISSN SET ISSN_STATUS =:WK_NEW_STATUS WHERE SSN_ID = :WK_SSN_SSNID; */
        SELECT TEST_FROM_ALLOWED_SSN_STATUS 
        FROM CONTROL 
        INTO :WK_ALLOWED_STATUS;
        UPDATE ISSN SET ISSN_STATUS = :WK_NEW_STATUS 
        WHERE ORIGINAL_SSN = :WK_SSN_SSNID
        AND (WH_ID < 'X' OR WH_ID > 'X~') 
        AND (POS(:WK_ALLOWED_STATUS,ISSN.ISSN_STATUS,0,1) > -1);
 /* cannot update issns in 'X' wh_ids 
           or status starting 'Q' 'D' 'A' 'X' 
                     'P' (except 'PA')
        */
     END

     UPDATE TRANSACTIONS SET COMPLETE='T',ERROR_TEXT='Reset Answer ID' WHERE RECORD_ID = :WK_RECORD;

   EXECUTE PROCEDURE TRAN_ARCHIVE;
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_QANS FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 44 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'QANS') THEN
  BEGIN
   EXECUTE PROCEDURE PC_QANS 
    NEW.RECORD_ID ,
    NEW.WH_ID,
    NEW.LOCN_ID,
    NEW.OBJECT,
    NEW.TRN_TYPE,
    NEW.TRN_CODE,
    NEW.TRN_DATE,
    NEW.REFERENCE,
    NEW.QTY,
    NEW.PERSON_ID,
    NEW.DEVICE_ID,
    NEW.SUB_LOCN_ID;
   EXECUTE PROCEDURE TRAN_ARCHIVE;
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_NIDP FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 45 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'NIDP') THEN
  BEGIN
   EXECUTE PROCEDURE PC_ADD_PROD_COND_STATUS 
    NEW.RECORD_ID ,
    NEW.WH_ID,
    NEW.LOCN_ID,
    NEW.OBJECT,
    NEW.TRN_TYPE,
    NEW.TRN_CODE,
    NEW.TRN_DATE,
    NEW.REFERENCE,
    NEW.QTY,
    NEW.PERSON_ID,
    NEW.DEVICE_ID;
   EXECUTE PROCEDURE TRAN_ARCHIVE;
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_NXDP FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 46 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'NXDP') THEN
  BEGIN
   EXECUTE PROCEDURE PC_DELETE_ONE_PROD_COND_STATUS 
    NEW.RECORD_ID ,
    NEW.WH_ID,
    NEW.LOCN_ID,
    NEW.OBJECT,
    NEW.TRN_TYPE,
    NEW.TRN_CODE,
    NEW.TRN_DATE,
    NEW.REFERENCE,
    NEW.QTY,
    NEW.PERSON_ID,
    NEW.DEVICE_ID;
   EXECUTE PROCEDURE TRAN_ARCHIVE;
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_NIEP FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 47 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'NIEP') THEN
  BEGIN
   EXECUTE PROCEDURE PC_ADD_PROD_COND_STATUS 
    NEW.RECORD_ID ,
    NEW.WH_ID,
    NEW.LOCN_ID,
    NEW.OBJECT,
    NEW.TRN_TYPE,
    NEW.TRN_CODE,
    NEW.TRN_DATE,
    NEW.REFERENCE,
    NEW.QTY,
    NEW.PERSON_ID,
    NEW.DEVICE_ID;
   EXECUTE PROCEDURE TRAN_ARCHIVE;
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_NXEP FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 48 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'NXEP') THEN
  BEGIN
   EXECUTE PROCEDURE PC_DELETE_ONE_PROD_COND_STATUS 
    NEW.RECORD_ID ,
    NEW.WH_ID,
    NEW.LOCN_ID,
    NEW.OBJECT,
    NEW.TRN_TYPE,
    NEW.TRN_CODE,
    NEW.TRN_DATE,
    NEW.REFERENCE,
    NEW.QTY,
    NEW.PERSON_ID,
    NEW.DEVICE_ID;
   EXECUTE PROCEDURE TRAN_ARCHIVE;
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_PKAL FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 49 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_PICK_QTY INTEGER;
DECLARE VARIABLE WK_PICK_CNT INTEGER;
DECLARE VARIABLE WK_LABEL VARCHAR(7);
DECLARE VARIABLE WK_DEVICE CHAR(2);
DECLARE VARIABLE WK_USER VARCHAR(10);
DECLARE VARIABLE WK_ORDER VARCHAR(30);
DECLARE VARIABLE WK_ORDER_STATUS CHAR(2);
DECLARE VARIABLE WK_ORDER_START TIMESTAMP;
DECLARE VARIABLE WK_DATE TIMESTAMP;
DECLARE VARIABLE WK_RECORD INTEGER;
DECLARE VARIABLE WK_PI_LABEL VARCHAR(7);
DECLARE VARIABLE WK_PI_SSN VARCHAR(20);
DECLARE VARIABLE WK_PI_PROD VARCHAR(30);
DECLARE VARIABLE WK_PI_WH CHAR(2);
DECLARE VARIABLE WK_PI_LOCN VARCHAR(10);
DECLARE VARIABLE WK_PI_LASTLOCN VARCHAR(10);
DECLARE VARIABLE WK_PI_QTY INTEGER;
DECLARE VARIABLE WK_PI_STATUS CHAR(2);
DECLARE VARIABLE WK_PI_STATUS_2 CHAR(2);
DECLARE VARIABLE WK_PI_DESCRIPTION VARCHAR(40);
DECLARE VARIABLE WK_PI_ORDER VARCHAR(15);
DECLARE VARIABLE WK_PI_ORDER_QTY INTEGER;
DECLARE VARIABLE WK_PI_DESPATCH_LOCN VARCHAR(10);
DECLARE VARIABLE WK_DIRECTORY VARCHAR(80);
DECLARE VARIABLE WK_FILENAME VARCHAR(80);
DECLARE VARIABLE WK_LABEL_LINE VARCHAR(330);
DECLARE VARIABLE WK_RESULT INTEGER;
DECLARE VARIABLE WK_PROD_SSN VARCHAR(20);
DECLARE VARIABLE WK_UOM CHAR(2);
DECLARE VARIABLE WK_PICK_TYPE CHAR(1);
DECLARE VARIABLE WK_FOUND_PICK INTEGER;
DECLARE VARIABLE WK_SEQ INTEGER;
DECLARE VARIABLE WK_DESPATCH_GROUP VARCHAR(10);
DECLARE VARIABLE WK_TOT_GROUP_LOCNS INTEGER;
DECLARE VARIABLE WK_TOT_GROUP_PRODUCTS_USED INTEGER;
DECLARE VARIABLE WK_TOT_GROUPS_PRODUCTS_USED INTEGER;
DECLARE VARIABLE WK_TOT_GROUP_EMPTY INTEGER;
DECLARE VARIABLE WK_TOT_ORDER_PRODUCTS INTEGER;
DECLARE VARIABLE WK_MAX_ORDERS INTEGER;
DECLARE VARIABLE WK_MAX_PRODUCTS INTEGER;
DECLARE VARIABLE WK_TOT_GROUPS_ORDERS INTEGER;
DECLARE VARIABLE WK_WHO_FOR VARCHAR(40);
DECLARE VARIABLE WK_WHO_FOR2 VARCHAR(40);
DECLARE VARIABLE WK_FOUND INTEGER;
DECLARE VARIABLE WK_GM_MESSAGE VARCHAR(10);
DECLARE VARIABLE WK_T4_DELIM CHAR(1);
DECLARE VARIABLE WK_T4_TRAN_DATA VARCHAR(1024);
DECLARE VARIABLE WK_T4_SOURCE VARCHAR(512);
DECLARE VARIABLE WK_NEW_RECORD INTEGER;
DECLARE VARIABLE WK_CN_PRIORITY SMALLINT;
DECLARE VARIABLE WK_DO_UCIS CHAR(1);
DECLARE VARIABLE WK_DO_GSMD CHAR(1);
DECLARE VARIABLE WK_DO_PRCL CHAR(1);
DECLARE VARIABLE WK_DO_GCNA CHAR(1);
DECLARE VARIABLE WK_PROD_OK VARCHAR(80);
DECLARE VARIABLE WK_BUFFER VARCHAR(80);
DECLARE VARIABLE WK_WORK_PROD VARCHAR(30);
DECLARE VARIABLE WK_WORK_PROD2 VARCHAR(30);
DECLARE VARIABLE WK_WORK_TOPICK_QTY INTEGER;
DECLARE VARIABLE WK_WORK_PICKED_QTY INTEGER;
DECLARE VARIABLE WK_WORK_ORDER_QTY INTEGER;
DECLARE VARIABLE WK_AVAILABLE_QTY INTEGER;
DECLARE VARIABLE WK_ALLOC_ORDER_QTY INTEGER;
DECLARE VARIABLE WK_ORDER_QTY INTEGER;
DECLARE VARIABLE WK_PICKED_QTY INTEGER;
DECLARE VARIABLE WK_IMPORTSTATUS VARCHAR(40); 
DECLARE VARIABLE WK_TOT_ORDER_PRODUCTS_GROUP INTEGER;
DECLARE VARIABLE WK_MOVE_PRIORITY INTEGER;
DECLARE VARIABLE WK_HELD_STATUS VARCHAR(2); 
DECLARE VARIABLE WK_PROD_SIZE_TYPE VARCHAR(40);
DECLARE VARIABLE WK_ALLOW_EMPTY VARCHAR(50);
DECLARE VARIABLE WK_PO_WH_ID CHAR(2);
DECLARE VARIABLE WK_PO_COMPANY_ID VARCHAR(20);
DECLARE VARIABLE WK_PO_SUPPLIER_LIST VARCHAR(10);
DECLARE VARIABLE WK_SE_PRINTER_NAME VARCHAR(50);
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'PKAL') THEN
  BEGIN
     IF ((NEW.TRN_CODE = 'D') OR
         (NEW.TRN_CODE = 'E')) THEN
     BEGIN
        /* get qty to allocate */
        WK_PICK_QTY = 0;
        IF (NEW.QTY = 0) THEN
        BEGIN
           SELECT PICK_ALLOCATE_QTY
               FROM CONTROL
               INTO :WK_PICK_QTY;
        END
        ELSE
        BEGIN
           WK_PICK_QTY = NEW.QTY;
        END
        WK_DEVICE = NEW.WH_ID;
        WK_USER = NEW.PERSON_ID;
        WK_RECORD = NEW.RECORD_ID;
        WK_PICK_TYPE = NEW.TRN_CODE;
        WK_DATE = NEW.TRN_DATE;
        /* want to do wk_qty picks */
        WK_PICK_CNT = 0;
        WK_FOUND_PICK = 1;
        WHILE ((WK_PICK_CNT < WK_PICK_QTY) AND (WK_FOUND_PICK = 1))
        DO
        BEGIN
           WK_FOUND_PICK = 0;
           /*   WHERE P1.PICK_LINE_STATUS IN ('OP','CN') */
           /*   WHERE P1.PICK_LINE_STATUS IN ('OP') */
           FOR 
              SELECT FIRST 5 P1.PICK_LABEL_NO, 
                  P1.PICK_ORDER, 
                  P2.PICK_STARTED,
                  P1.PICK_ORDER_QTY   
              FROM PICK_ITEM P1 
                  JOIN PICK_ORDER P2 ON P2.PICK_ORDER = P1.PICK_ORDER 
                  LEFT OUTER JOIN ISSN P3 ON P3.SSN_ID = P1.SSN_ID 
              WHERE P1.PICK_LINE_STATUS IN ('OP','UP') 
                AND P2.PICK_STATUS IN ('OP','DA')
                ORDER BY P2.PICK_PRIORITY, P2.WIP_ORDERING, P1.WIP_PRELOCN_ORDERING, P3.LOCN_ID, P1.PICK_LOCATION, P1.WIP_POSTLOCN_ORDERING 
              INTO :WK_LABEL, :WK_ORDER, :WK_ORDER_START, :WK_PI_ORDER_QTY
           DO
           BEGIN
              WK_FOUND_PICK = 1;
              IF (WK_PICK_CNT < WK_PICK_QTY) THEN
              BEGIN
                 IF (WK_PI_ORDER_QTY > 0)
                 THEN
                 BEGIN
                    WK_PICK_CNT = WK_PICK_CNT + 1;
                    UPDATE PICK_ITEM 
                       SET USER_ID = :WK_USER, 
                           DEVICE_ID = :WK_DEVICE, 
                           PICK_LINE_STATUS = 'AL', 
                           PICK_STARTED = 'NOW'
                        WHERE PICK_LABEL_NO = :WK_LABEL;
                    IF (WK_ORDER_START IS NULL) THEN
                    BEGIN
                       /*     PICK_STATUS = 'PG' */ 
                       UPDATE PICK_ORDER
                          SET PICK_STARTED = 'NOW'
                           WHERE PICK_ORDER = :WK_ORDER;
                    END
                 END
                 ELSE
                 BEGIN
                    UPDATE PICK_ITEM 
                       SET PICK_LINE_STATUS = 'NP' 
                        WHERE PICK_LABEL_NO = :WK_LABEL;
                 END
              END
           END
        END
        IF (WK_PICK_TYPE = 'E') THEN
        BEGIN
            /* from a browser */
           WK_DIRECTORY = '';
        END
        ELSE
        BEGIN
            /* from -code is D - vb - require ftp files */
           WK_DIRECTORY = '';
           SELECT FTP_DIRECTORY
               FROM CONTROL
               INTO :WK_DIRECTORY;
            WK_FILENAME = WK_DIRECTORY || WK_DEVICE || '.pk';
           /* clear devices file */
            WK_RESULT = FILE_DELETE(WK_FILENAME);
            WK_RESULT = FILE_WRITELN(WK_FILENAME, 'DELETE FROM PICK_LOCATIONS');
            WK_RESULT = FILE_WRITELN(WK_FILENAME, 'DELETE FROM PICK_QTYS');
            WK_SEQ = 0;
           FOR 
              SELECT P1.PICK_LABEL_NO, 
                     P1.PROD_ID,
                     P1.SSN_ID,
                     P1.PICK_ORDER,
                     P1.PICK_ORDER_QTY,
                     P1.DESPATCH_LOCATION,
                     P1.PICK_LINE_STATUS
                     FROM PICK_ITEM P1
                        JOIN PICK_ORDER P2 ON P2.PICK_ORDER = P1.PICK_ORDER 
                        LEFT OUTER JOIN ISSN P3 ON P3.SSN_ID = P1.SSN_ID 
                     WHERE P1.PICK_LINE_STATUS IN ('AL','PG','PL')
                       AND P1.DEVICE_ID = :WK_DEVICE
                       ORDER BY P2.PICK_PRIORITY, P2.WIP_ORDERING, P1.WIP_PRELOCN_ORDERING, P3.LOCN_ID, P1.PICK_LOCATION, P1.WIP_POSTLOCN_ORDERING 
                     INTO :WK_PI_LABEL, :WK_PI_PROD, :WK_PI_SSN, :WK_PI_ORDER, :WK_PI_ORDER_QTY, :WK_PI_DESPATCH_LOCN, :WK_PI_STATUS_2
           DO
           BEGIN
      /*
       must get for pick_locations
                     WH_ID,
                     LOCN_ID,
                     QTY_AVAIL,
                     ISSN_STATUS
       must get for pick_qtys
                     DESCRIPTION
                     UOM
      */
              WK_SEQ = WK_SEQ + 1;
              WK_PI_WH = '';
              WK_PI_LOCN = '';
              WK_PI_LASTLOCN = '';
              WK_PI_QTY = 0;
              WK_PI_STATUS = '';
              WK_PI_DESCRIPTION = '';
              IF (WK_PI_SSN IS NULL) THEN
              BEGIN
                 /* a product */
                 FOR
                 SELECT ISSN.WH_ID, ISSN.LOCN_ID, ISSN.CURRENT_QTY, ISSN.ISSN_STATUS, PROD_PROFILE.SHORT_DESC, ISSN.SSN_ID, PROD_PROFILE.UOM 
                 FROM ISSN 
                      JOIN PROD_PROFILE ON PROD_PROFILE.PROD_ID = ISSN.PROD_ID
                 WHERE ISSN.PROD_ID = :WK_PI_PROD 
                   AND (ISSN.WH_ID < 'X' OR ISSN.WH_ID > 'X~') AND ISSN.ISSN_STATUS IN ('ST','PA','AL','PG','PL')
                 INTO :WK_PI_WH, :WK_PI_LOCN, :WK_PI_QTY, :WK_PI_STATUS, :WK_PI_DESCRIPTION, :WK_PROD_SSN, :WK_UOM
                 DO
                 BEGIN
                    /* update status */
                    /* UPDATE ISSN SET ISSN_STATUS = 'AL' WHERE SSN_ID = :WK_PROD_SSN; */
                     IF (WK_PI_LASTLOCN = '') THEN
                     BEGIN
                        UPDATE PICK_ITEM SET PICK_LOCATION = :WK_PI_LOCN 
                        WHERE PICK_LABEL_NO = :WK_PI_LABEL; 
                        WK_PI_LASTLOCN = WK_PI_LOCN;
                     END
                    /* add to devices file */
                    WK_LABEL_LINE = 'INSERT INTO PICK_LOCATIONS (PICK_LABEL_NO, PROD_ID , SSN_ID , WH_ID , LOCN_ID , QTY_AVAILABLE , ISSN_STATUS )  VALUES (' ||
                      "'" || :WK_PI_LABEL  || "','" ||
                      :WK_PI_PROD  || "','" ||
                      :WK_PROD_SSN  || "','" ||
                      :WK_PI_WH  || "','" ||
                      :WK_PI_LOCN  || "','" ||
                      ALLTRIM(CAST(WK_PI_QTY AS CHAR(6))) || "','" ||
                      :WK_PI_STATUS_2  || "')";
                    WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE);
                 END
              END
              ELSE
              BEGIN
                 /* an ssn */
                    /* update status */
                 UPDATE ISSN SET ISSN_STATUS = :WK_PI_STATUS_2 WHERE SSN_ID = :WK_PI_SSN;
                 SELECT ISSN.WH_ID, ISSN.LOCN_ID, ISSN.CURRENT_QTY, ISSN.ISSN_STATUS, SSN.SSN_TYPE, 'EA'
                 FROM ISSN 
                      JOIN SSN ON SSN.SSN_ID = ISSN.ORIGINAL_SSN
                 WHERE ISSN.SSN_ID = :WK_PI_SSN 
                 INTO :WK_PI_WH, :WK_PI_LOCN, :WK_PI_QTY, :WK_PI_STATUS, :WK_PI_DESCRIPTION, :WK_UOM;
                 UPDATE PICK_ITEM SET PICK_LOCATION = :WK_PI_LOCN 
                 WHERE PICK_LABEL_NO = :WK_PI_LABEL; 
                 /* add to devices file */
                 WK_LABEL_LINE = 'INSERT INTO PICK_LOCATIONS (PICK_LABEL_NO, PROD_ID , SSN_ID , WH_ID , LOCN_ID , QTY_AVAILABLE , ISSN_STATUS )  VALUES (' ||
                      "'" || :WK_PI_LABEL  || "','" ||
                      :WK_PI_PROD  || "','" ||
                      :WK_PI_SSN  || "','" ||
                      :WK_PI_WH  || "','" ||
                      :WK_PI_LOCN  || "','" ||
                      ALLTRIM(CAST(WK_PI_QTY AS CHAR(6))) || "','" ||
                      :WK_PI_STATUS  || "')";
                 WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE);
              END
              /* add to devices file */
              WK_LABEL_LINE = 'INSERT INTO PICK_QTYS (PICK_LABEL_NO, PROD_ID , SSN_ID , DESCRIPTION, PICK_ORDER, PICK_ORDER_QTY, UOM, PICK_LINE_STATUS, DESPATCH_LOCATION, SEQ )  VALUES (' ||
                      "'" || :WK_PI_LABEL  || "','" ||
                      :WK_PI_PROD  || "','" ||
                      :WK_PI_SSN  || "','" ||
                      :WK_PI_DESCRIPTION  || "','" ||
                      :WK_PI_ORDER        || "','" ||
                      ALLTRIM(CAST(WK_PI_ORDER_QTY AS CHAR(6))) || "','" ||
                      :WK_UOM             || "','" ||
                      :WK_PI_STATUS_2     || "','" ||
                      :WK_PI_DESPATCH_LOCN || "','" ||
                      ALLTRIM(CAST(WK_SEQ  AS CHAR(4))) || "')";
              WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE);
           END /* for */
        END /* code D ftp files */

        EXECUTE PROCEDURE UPDATE_TRAN (WK_RECORD, 'T','Processed successfully');
        /* EXECUTE PROCEDURE TRAN_ARCHIVE; */
     END /* code D or E */
     IF (NEW.TRN_CODE = 'G') THEN
     BEGIN
        WK_ORDER = NEW.OBJECT;
        WK_DEVICE = NEW.WH_ID;
        IF (WK_DEVICE IS NULL) THEN
        BEGIN
           WK_DEVICE = '';
        END
        IF (WK_DEVICE = '') THEN
        BEGIN
           WK_DEVICE = NEW.DEVICE_ID;
        END
        WK_DESPATCH_GROUP = NEW.SUB_LOCN_ID; /* trolley */
        WK_USER = NEW.PERSON_ID;
        WK_WHO_FOR = NEW.REFERENCE;
        WK_RECORD = NEW.RECORD_ID;
        WK_CN_PRIORITY = 0;
	WK_ALLOW_EMPTY = 'F';
        SELECT DEFAULT_PICK_PRIORITY, SEND_UCIS_V4, PICK_IMPORT_SSN_STATUS , WARN_PICK_PRIORITY, SEND_PRCL_V4, SEND_GCNA_V4
        FROM CONTROL 
        INTO :WK_CN_PRIORITY, :WK_DO_UCIS , :WK_IMPORTSTATUS, :WK_MOVE_PRIORITY, :WK_DO_PRCL, :WK_DO_GCNA;
	SELECT DESCRIPTION
 	FROM OPTIONS
	WHERE GROUP_CODE = 'PKALEMPTY' AND CODE = 'G'
	INTO WK_ALLOW_EMPTY;
	IF (WK_ALLOW_EMPTY IS NULL) THEN
	BEGIN
	   WK_ALLOW_EMPTY = 'F';
	END
/*
=====================================================================
 get # of locns in trolley  => a
 get # prods on trolley => f
  sum # products from pick items for trolley (new field)
  (status AL PG PL) gives the # of used locns
 get # of empty locns in trolley  => b = a - f
 calc # prods on order => e
 check (e <= b)
 else error and exit
 check (f + e) <= max from control
 else error and exit
 get # orders on trolley => g
 check (g + 1) <= max from control
 else error and exit

 then allocate to device all lines on order

====================================================================
*/
 /* get # of locns in trolley  => a */
        WK_TOT_GROUP_LOCNS = 0; /* field a */
        IF (WK_DESPATCH_GROUP <> '') THEN
        BEGIN
           SELECT COUNT(*) 
           FROM LOCATION
           WHERE LOCN_ID STARTING :WK_DESPATCH_GROUP
           AND MOVEABLE_LOCN = 'T'
           AND LOCN_STAT = 'OK'
           INTO :WK_TOT_GROUP_LOCNS;
        END
        ELSE
        BEGIN
           WK_TOT_GROUP_LOCNS = 1000000000;
        END
	IF (WK_ALLOW_EMPTY = 'T') THEN
	BEGIN
           WK_TOT_GROUP_LOCNS = 1000000000;
	END
 /* get # prods on trolley => f */
        WK_TOT_GROUP_PRODUCTS_USED = 0; /* field f */
        IF (WK_DESPATCH_GROUP <> '') THEN
        BEGIN
           SELECT COUNT(DISTINCT PROD_ID)
           FROM PICK_ITEM
           WHERE DESPATCH_LOCATION_GROUP = :WK_DESPATCH_GROUP
           AND PICK_LINE_STATUS IN ('AL','PG','PL')
           INTO WK_TOT_GROUP_PRODUCTS_USED;
        END
 /* get # of empty locns in trolley  => b = a - f */
        WK_TOT_GROUP_EMPTY = WK_TOT_GROUP_LOCNS - WK_TOT_GROUP_PRODUCTS_USED; /* field b */
 /* get # prods on order => e */
        WK_TOT_ORDER_PRODUCTS = 0; /* field e */
        SELECT COUNT(DISTINCT PROD_ID)
        FROM PICK_ITEM
        WHERE PICK_ORDER = :WK_ORDER
           AND PICK_LINE_STATUS IN ('OP')
        INTO WK_TOT_ORDER_PRODUCTS;
 /* get # prods on order with prod already in trolley  */
        WK_TOT_ORDER_PRODUCTS_GROUP = 0; /*  */
        SELECT COUNT(DISTINCT P1.PROD_ID)
        FROM PICK_ITEM P1
        JOIN PICK_ITEM P2
           ON P2.PROD_ID = P1.PROD_ID
           AND P2.DESPATCH_LOCATION_GROUP = :WK_DESPATCH_GROUP
        WHERE P1.PICK_ORDER = :WK_ORDER
           AND P1.PICK_LINE_STATUS IN ('OP')
           AND P2.PICK_LINE_STATUS IN ('AL','PG','PL')
           AND P2.PICK_ORDER <> :WK_ORDER
        INTO WK_TOT_ORDER_PRODUCTS_GROUP;
        IF (WK_TOT_ORDER_PRODUCTS > (WK_TOT_GROUP_EMPTY + WK_TOT_ORDER_PRODUCTS_GROUP)) THEN
        BEGIN
           EXECUTE PROCEDURE UPDATE_TRAN (WK_RECORD, 'F','More Products on Order than Free Locations');
/*
-- need to reduce this by products already in trolley
*/
           UPDATE PICK_ORDER SET PICK_PRIORITY = :WK_MOVE_PRIORITY
           WHERE PICK_ORDER = :WK_ORDER;
        END
        ELSE
        BEGIN
/*
           -* get max qtys from control *-
           WK_MAX_ORDERS = 0;
           WK_MAX_PRODUCTS = 0;
           SELECT MAX_PICK_ORDERS, MAX_PICK_PRODUCTS
           FROM CONTROL
           INTO :WK_MAX_ORDERS, :WK_MAX_PRODUCTS;
           WK_TOT_GROUPS_PRODUCTS_USED = 0; 
           SELECT COUNT(DISTINCT PROD_ID)
           FROM PICK_ITEM
           WHERE PICK_LINE_STATUS IN ('AL','PG','PL')
           INTO WK_TOT_GROUPS_PRODUCTS_USED;
           IF (WK_MAX_PRODUCTS < (WK_TOT_ORDER_PRODUCTS + WK_TOT_GROUPS_PRODUCTS_USED )) THEN
           BEGIN
              EXECUTE PROCEDURE UPDATE_TRAN (WK_RECORD, 'F','More Products Required for Order than Allowed at the Moment');
              UPDATE PICK_ORDER SET PICK_PRIORITY = :WK_MOVE_PRIORITY
              WHERE PICK_ORDER = :WK_ORDER;
           END
           ELSE
           BEGIN
       -* get # orders on all trolleys => g *-
              WK_TOT_GROUPS_ORDERS = 0; -* field g *-
              SELECT COUNT(DISTINCT PICK_ORDER)
              FROM PICK_ITEM
              WHERE PICK_LINE_STATUS IN ('AL','PG','PL')
              INTO WK_TOT_GROUPS_ORDERS;
              IF ( WK_MAX_ORDERS < (WK_TOT_GROUPS_ORDERS + 1)) THEN
              BEGIN
         EXECUTE PROCEDURE UPDATE_TRAN (WK_RECORD, 'F','More Orders than Allowed at the Moment');
         UPDATE PICK_ORDER SET PICK_PRIORITY = :WK_MOVE_PRIORITY
         WHERE PICK_ORDER = :WK_ORDER;
              END
              ELSE
*/
              WK_PROD_OK = '';
              FOR SELECT PROD_ID, 
                  SUM( PICK_ITEM.PICK_ORDER_QTY ), 
                  SUM( PICK_ITEM.PICKED_QTY ) 
                  FROM PICK_ITEM
                  WHERE PICK_ORDER = :WK_ORDER
                  AND PICK_LINE_STATUS IN ('OP','UP')
                  GROUP BY PROD_ID
                  INTO :WK_WORK_PROD, :WK_WORK_ORDER_QTY, :WK_WORK_PICKED_QTY
              DO
              BEGIN
                 IF (WK_WORK_ORDER_QTY IS NULL) THEN
                 BEGIN
                    WK_WORK_ORDER_QTY = 0;
                 END
                 IF (WK_WORK_PICKED_QTY IS NULL) THEN
                 BEGIN
                    WK_WORK_PICKED_QTY = 0;
                 END
                 WK_WORK_TOPICK_QTY = WK_WORK_ORDER_QTY - WK_WORK_PICKED_QTY;
                 SELECT SUM( ISSN.CURRENT_QTY ) 
                       FROM ISSN
                       WHERE ISSN.PROD_ID = :WK_WORK_PROD
                       AND (POS(:WK_IMPORTSTATUS,ISSN.ISSN_STATUS,0,1) > -1)
                       GROUP BY ISSN.PROD_ID
                    INTO :WK_AVAILABLE_QTY;
                 IF (WK_AVAILABLE_QTY IS NULL) THEN
                 BEGIN
                    WK_AVAILABLE_QTY = 0;
                 END
                 /* now must get qty allocated on order not picked */
                 WK_PICKED_QTY = 0;
                 WK_ORDER_QTY = 0;
                 SELECT SUM( PICK_ITEM.PICK_ORDER_QTY ), 
                        SUM( PICK_ITEM.PICKED_QTY ) 
                         FROM PICK_ITEM
                         WHERE PICK_ITEM.PROD_ID = :WK_WORK_PROD
                         AND ('AL' = PICK_ITEM.PICK_LINE_STATUS)
                         GROUP BY PICK_ITEM.PROD_ID
                      INTO :WK_ORDER_QTY, :WK_PICKED_QTY;
                 IF (WK_ORDER_QTY IS NULL) THEN
                 BEGIN
                    WK_ORDER_QTY = 0;
                 END
                 IF (WK_PICKED_QTY IS NULL) THEN
                 BEGIN
                    WK_PICKED_QTY = 0;
                 END
                 WK_ALLOC_ORDER_QTY = WK_ORDER_QTY - WK_PICKED_QTY;
                 WK_AVAILABLE_QTY = WK_AVAILABLE_QTY - WK_ALLOC_ORDER_QTY;
                 IF (WK_AVAILABLE_QTY < WK_WORK_TOPICK_QTY ) THEN
                 BEGIN
                    IF (LEN(WK_PROD_OK) < 53) THEN
                    BEGIN
                       WK_PROD_OK = WK_PROD_OK || ' ' || WK_WORK_PROD;
                    END
                 END
              END /* end of for */
              IF (WK_PROD_OK <> '') THEN
              BEGIN
                 WK_BUFFER = 'Not enough Stock ' || :WK_PROD_OK;
                 EXECUTE PROCEDURE UPDATE_TRAN (WK_RECORD, 'F',:WK_BUFFER );
                 UPDATE PICK_ORDER SET PICK_PRIORITY = :WK_MOVE_PRIORITY
                 WHERE PICK_ORDER = :WK_ORDER;
              END
              ELSE
              BEGIN
                 WK_FOUND = 0;
                 SELECT FIRST 1 1
                 FROM PICK_ITEM
                 WHERE PICK_ORDER = :WK_ORDER
                 AND PICK_LINE_STATUS IN ('OP','UP')
                 INTO :WK_FOUND;
                 IF (WK_FOUND = 1) THEN
                 BEGIN
                    /* ok we can allocate this */
                    UPDATE PICK_ITEM 
                       SET USER_ID = :WK_WHO_FOR, 
                           DEVICE_ID = NULL, 
                           PICK_LINE_STATUS = 'CN' 
                        WHERE PICK_ORDER = :WK_ORDER
                        AND PICK_LINE_STATUS IN ('OP','UP')
                        AND PICK_ORDER_QTY = 0;
                    UPDATE PICK_ITEM 
                       SET USER_ID = :WK_WHO_FOR, 
                           DEVICE_ID = :WK_DEVICE, 
                           DESPATCH_LOCATION_GROUP = :WK_DESPATCH_GROUP, 
                           PICK_LINE_STATUS = 'AL', 
                           PICK_STARTED = 'NOW'
                        WHERE PICK_ORDER = :WK_ORDER
                        AND PICK_LINE_STATUS IN ('OP','UP');
                    /*     PICK_STATUS = 'PG' */ 
                    UPDATE PICK_ORDER
                       SET PICK_STARTED = 'NOW'
                        WHERE PICK_ORDER = :WK_ORDER
                        AND PICK_STARTED IS NULL;

                    IF (WK_DO_GCNA = 'T') THEN
                    BEGIN
                       /* now send of trans to update address */
                       WK_GM_MESSAGE = '';
                       SELECT MESSAGE_ID 
                       FROM GET_NEXT_MESSAGE 
                       INTO :WK_GM_MESSAGE;
                       WK_T4_DELIM = '|';
                       WK_T4_TRAN_DATA = WK_USER || WK_T4_DELIM ;
                       WK_T4_TRAN_DATA = WK_T4_TRAN_DATA || WK_DEVICE || WK_T4_DELIM ;
                       WK_T4_TRAN_DATA = WK_T4_TRAN_DATA || WK_GM_MESSAGE || WK_T4_DELIM ;
                       WK_T4_TRAN_DATA = WK_T4_TRAN_DATA || '<ContactInstanceID>' || WK_ORDER || WK_T4_DELIM ;
                       WK_T4_SOURCE = 'SSSS' ;
                       SELECT REC_ID FROM ADD_TRAN_V4 ( 'V4', 'GCNA','S',
                          NEW.TRN_DATE,
                          :WK_T4_DELIM,
                          NEW.PERSON_ID,
                          NEW.DEVICE_ID,
                          :WK_GM_MESSAGE,
                          :WK_T4_TRAN_DATA,
                          'F','','MASTER',0,
                          :WK_T4_SOURCE)
                       INTO :WK_NEW_RECORD;
                       EXECUTE PROCEDURE ADD_MESSAGE_V4 ( 
                          :WK_GM_MESSAGE,
                         'V4', 'GCNA','S',
                          NEW.TRN_DATE,
                          NEW.PERSON_ID,
                          NEW.DEVICE_ID,
                          :WK_CN_PRIORITY,
                          'WS','',NULL);
                    END

                    WK_DO_GSMD = 'F';
                    SELECT SPECIAL_INSTRUCTIONS
                    FROM PICK_ORDER 
                    WHERE PICK_ORDER = :WK_ORDER
                    INTO :WK_DO_GSMD;
                    IF (WK_DO_GSMD = 'T') THEN
                    BEGIN
                       /* now send of trans to update special instructions */
                       WK_GM_MESSAGE = '';
                       SELECT MESSAGE_ID 
                       FROM GET_NEXT_MESSAGE 
                       INTO :WK_GM_MESSAGE;
                       WK_T4_DELIM = '|';
                       WK_T4_TRAN_DATA = WK_USER || WK_T4_DELIM ;
                       WK_T4_TRAN_DATA = WK_T4_TRAN_DATA || WK_DEVICE || WK_T4_DELIM ;
                       WK_T4_TRAN_DATA = WK_T4_TRAN_DATA || WK_GM_MESSAGE || WK_T4_DELIM ;
                       WK_T4_TRAN_DATA = WK_T4_TRAN_DATA || '<ContactInstanceID>' || WK_ORDER || WK_T4_DELIM ;
                       WK_T4_SOURCE = 'SSSS' ;
                       SELECT REC_ID FROM ADD_TRAN_V4 ( 'V4', 'GSMD','S',
                          NEW.TRN_DATE,
                          :WK_T4_DELIM,
                          NEW.PERSON_ID,
                          NEW.DEVICE_ID,
                          :WK_GM_MESSAGE,
                          :WK_T4_TRAN_DATA,
                          'F','','MASTER',0,
                          :WK_T4_SOURCE)
                       INTO :WK_NEW_RECORD;
                       EXECUTE PROCEDURE ADD_MESSAGE_V4 ( 
                          :WK_GM_MESSAGE,
                         'V4', 'GSMD','S',
                          NEW.TRN_DATE,
                          NEW.PERSON_ID,
                          NEW.DEVICE_ID,
                          :WK_CN_PRIORITY,
                          'WS','',NULL);
                    END

                    IF (WK_DO_PRCL = 'T') THEN
                    BEGIN
                       /* now send of trans to print cover letter */
                       WK_SE_PRINTER_NAME = '';
	               SELECT SYS_EQUIP.COMPUTER_NAME  
                       FROM CONTROL 
                       LEFT OUTER JOIN SYS_EQUIP ON CONTROL.DEFAULT_PICK_PRINTER = SYS_EQUIP.DEVICE_ID 
                       INTO :WK_SE_PRINTER_NAME;
                       IF (WK_SE_PRINTER_NAME IS NULL) THEN
                       BEGIN
                          WK_SE_PRINTER_NAME = 'NONE';
                       END
                       WK_PO_SUPPLIER_LIST = 'F';
                       SELECT SUPPLIER_LIST
                       FROM PICK_ORDER 
                       WHERE PICK_ORDER = :WK_ORDER
                       INTO :WK_PO_SUPPLIER_LIST;
                       IF (WK_PO_SUPPLIER_LIST IS NULL) THEN
                       BEGIN
                          WK_PO_SUPPLIER_LIST = 'F';
                       END
                       IF ((WK_PO_SUPPLIER_LIST = 'T') OR (WK_PO_SUPPLIER_LIST = 't')) THEN
                       BEGIN
                          WK_PO_SUPPLIER_LIST = 'true';
                       END
                       ELSE
                       BEGIN
                          WK_PO_SUPPLIER_LIST = 'false';
                       END
                       WK_GM_MESSAGE = '';
                       SELECT MESSAGE_ID 
                       FROM GET_NEXT_MESSAGE 
                       INTO :WK_GM_MESSAGE;
                       WK_T4_DELIM = '|';
                       WK_T4_TRAN_DATA = WK_USER || WK_T4_DELIM ;
                       WK_T4_TRAN_DATA = WK_T4_TRAN_DATA || WK_DEVICE || WK_T4_DELIM ;
                       WK_T4_TRAN_DATA = WK_T4_TRAN_DATA || WK_GM_MESSAGE || WK_T4_DELIM ;
                       WK_T4_TRAN_DATA = WK_T4_TRAN_DATA || '<ContactInstanceID>' || WK_ORDER || WK_T4_DELIM ;
                       WK_T4_TRAN_DATA = WK_T4_TRAN_DATA || '<CoverLetterFlag>true' || WK_T4_DELIM ;
                       WK_T4_TRAN_DATA = WK_T4_TRAN_DATA || '<SupplierListFlag>' || WK_PO_SUPPLIER_LIST || WK_T4_DELIM ;
                       WK_T4_TRAN_DATA = WK_T4_TRAN_DATA || '<Printername>' || WK_SE_PRINTER_NAME || WK_T4_DELIM ;
                       WK_T4_SOURCE = 'SSSSSSS' ;
                       SELECT REC_ID FROM ADD_TRAN_V4 ( 'V4', 'PRCL','S',
                          NEW.TRN_DATE,
                          :WK_T4_DELIM,
                          NEW.PERSON_ID,
                          NEW.DEVICE_ID,
                          :WK_GM_MESSAGE,
                          :WK_T4_TRAN_DATA,
                          'F','','MASTER',0,
                          :WK_T4_SOURCE)
                       INTO :WK_NEW_RECORD;
                       EXECUTE PROCEDURE ADD_MESSAGE_V4 ( 
                          :WK_GM_MESSAGE,
                         'V4', 'PRCL','S',
                          NEW.TRN_DATE,
                          NEW.PERSON_ID,
                          NEW.DEVICE_ID,
                          :WK_CN_PRIORITY,
                          'WS','',NULL);
                    END


                    IF (WK_DO_UCIS = 'T') THEN
                    BEGIN
                       /* now send of trans to update remote status */
                       WK_GM_MESSAGE = '';
                       SELECT MESSAGE_ID 
                       FROM GET_NEXT_MESSAGE 
                       INTO :WK_GM_MESSAGE;
                       WK_T4_DELIM = '|';
                       WK_T4_TRAN_DATA = WK_USER || WK_T4_DELIM ;
                       WK_T4_TRAN_DATA = WK_T4_TRAN_DATA || WK_DEVICE || WK_T4_DELIM ;
                       WK_T4_TRAN_DATA = WK_T4_TRAN_DATA || WK_GM_MESSAGE || WK_T4_DELIM ;
                       WK_T4_TRAN_DATA = WK_T4_TRAN_DATA || '<ContactInstanceID>' || WK_ORDER || WK_T4_DELIM ;
                       WK_T4_TRAN_DATA = WK_T4_TRAN_DATA || '<ContactInstanceStatusCode>AL' || WK_T4_DELIM ;
                       WK_T4_TRAN_DATA = WK_T4_TRAN_DATA || '<UpdateDateTime>' || MER_YEAR('NOW') || '-' || LPAD(MER_MONTH('NOW'),'0',2) || '-' || LPAD(MER_DAY('NOW'),'0',2) || 'T' || LPAD(MER_HOUR('NOW'),'0',2) || ':' || LPAD(MER_MINUTE('NOW'),'0',2) || ':' || LPAD(SEC('NOW'),'0',2) || WK_T4_DELIM ;
                       WK_T4_SOURCE = 'SSSSSS' ;
                       SELECT REC_ID FROM ADD_TRAN_V4 ( 'V4', 'UCIS','S',
                          NEW.TRN_DATE,
                          :WK_T4_DELIM,
                          NEW.PERSON_ID,
                          NEW.DEVICE_ID,
                          :WK_GM_MESSAGE,
                          :WK_T4_TRAN_DATA,
                          'F','','MASTER',0,
                          :WK_T4_SOURCE)
                       INTO :WK_NEW_RECORD;
                       EXECUTE PROCEDURE ADD_MESSAGE_V4 ( 
                          :WK_GM_MESSAGE,
                         'V4', 'UCIS','S',
                          NEW.TRN_DATE,
                          NEW.PERSON_ID,
                          NEW.DEVICE_ID,
                          :WK_CN_PRIORITY,
                          'WS','',NULL);
                    END 
                    EXECUTE PROCEDURE UPDATE_TRAN (WK_RECORD, 'T','Processed successfully');
                    /* EXECUTE PROCEDURE TRAN_ARCHIVE; */
                 END
                 ELSE
                 BEGIN
             EXECUTE PROCEDURE UPDATE_TRAN (WK_RECORD, 'F','No Allocatable Lines on Order');
             UPDATE PICK_ORDER SET PICK_PRIORITY = :WK_MOVE_PRIORITY
             WHERE PICK_ORDER = :WK_ORDER;
                 END
              END
/*
           END
*/
        END
     END /* code G */

  END /* PKAL */
 END /* autorun */
END ^

CREATE TRIGGER RUN_TRANSACTION_PKAL2 FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 49 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_PICK_QTY INTEGER;
DECLARE VARIABLE WK_PICK_CNT INTEGER;
DECLARE VARIABLE WK_LABEL VARCHAR(7);
DECLARE VARIABLE WK_DEVICE CHAR(2);
DECLARE VARIABLE WK_USER VARCHAR(10);
DECLARE VARIABLE WK_ORDER VARCHAR(30);
DECLARE VARIABLE WK_ORDER_STATUS CHAR(2);
DECLARE VARIABLE WK_ORDER_START TIMESTAMP;
DECLARE VARIABLE WK_DATE TIMESTAMP;
DECLARE VARIABLE WK_RECORD INTEGER;
DECLARE VARIABLE WK_PI_LABEL VARCHAR(7);
DECLARE VARIABLE WK_PI_SSN VARCHAR(20);
DECLARE VARIABLE WK_PI_PROD VARCHAR(30);
DECLARE VARIABLE WK_PI_WH CHAR(2);
DECLARE VARIABLE WK_PI_LOCN VARCHAR(10);
DECLARE VARIABLE WK_PI_LASTLOCN VARCHAR(10);
DECLARE VARIABLE WK_PI_QTY INTEGER;
DECLARE VARIABLE WK_PI_STATUS CHAR(2);
DECLARE VARIABLE WK_PI_STATUS_2 CHAR(2);
DECLARE VARIABLE WK_PI_DESCRIPTION VARCHAR(40);
DECLARE VARIABLE WK_PI_ORDER VARCHAR(15);
DECLARE VARIABLE WK_PI_ORDER_QTY INTEGER;
DECLARE VARIABLE WK_PI_DESPATCH_LOCN VARCHAR(10);
DECLARE VARIABLE WK_DIRECTORY VARCHAR(80);
DECLARE VARIABLE WK_FILENAME VARCHAR(80);
DECLARE VARIABLE WK_LABEL_LINE VARCHAR(330);
DECLARE VARIABLE WK_RESULT INTEGER;
DECLARE VARIABLE WK_PROD_SSN VARCHAR(20);
DECLARE VARIABLE WK_UOM CHAR(2);
DECLARE VARIABLE WK_PICK_TYPE CHAR(1);
DECLARE VARIABLE WK_FOUND_PICK INTEGER;
DECLARE VARIABLE WK_SEQ INTEGER;
DECLARE VARIABLE WK_DESPATCH_GROUP VARCHAR(10);
DECLARE VARIABLE WK_TOT_GROUP_LOCNS INTEGER;
DECLARE VARIABLE WK_TOT_GROUP_PRODUCTS_USED INTEGER;
DECLARE VARIABLE WK_TOT_GROUPS_PRODUCTS_USED INTEGER;
DECLARE VARIABLE WK_TOT_GROUP_EMPTY INTEGER;
DECLARE VARIABLE WK_TOT_ORDER_PRODUCTS INTEGER;
DECLARE VARIABLE WK_MAX_ORDERS INTEGER;
DECLARE VARIABLE WK_MAX_PRODUCTS INTEGER;
DECLARE VARIABLE WK_TOT_GROUPS_ORDERS INTEGER;
DECLARE VARIABLE WK_WHO_FOR VARCHAR(40);
DECLARE VARIABLE WK_WHO_FOR2 VARCHAR(40);
DECLARE VARIABLE WK_FOUND INTEGER;
DECLARE VARIABLE WK_GM_MESSAGE VARCHAR(10);
DECLARE VARIABLE WK_T4_DELIM CHAR(1);
DECLARE VARIABLE WK_T4_TRAN_DATA VARCHAR(1024);
DECLARE VARIABLE WK_T4_SOURCE VARCHAR(512);
DECLARE VARIABLE WK_NEW_RECORD INTEGER;
DECLARE VARIABLE WK_CN_PRIORITY SMALLINT;
DECLARE VARIABLE WK_DO_UCIS CHAR(1);
DECLARE VARIABLE WK_DO_GSMD CHAR(1);
DECLARE VARIABLE WK_PROD_OK VARCHAR(80);
DECLARE VARIABLE WK_BUFFER VARCHAR(80);
DECLARE VARIABLE WK_WORK_PROD VARCHAR(30);
DECLARE VARIABLE WK_WORK_PROD2 VARCHAR(30);
DECLARE VARIABLE WK_WORK_TOPICK_QTY INTEGER;
DECLARE VARIABLE WK_WORK_PICKED_QTY INTEGER;
DECLARE VARIABLE WK_WORK_ORDER_QTY INTEGER;
DECLARE VARIABLE WK_AVAILABLE_QTY INTEGER;
DECLARE VARIABLE WK_ALLOC_ORDER_QTY INTEGER;
DECLARE VARIABLE WK_ORDER_QTY INTEGER;
DECLARE VARIABLE WK_PICKED_QTY INTEGER;
DECLARE VARIABLE WK_IMPORTSTATUS VARCHAR(40); 
DECLARE VARIABLE WK_TOT_ORDER_PRODUCTS_GROUP INTEGER;
DECLARE VARIABLE WK_MOVE_PRIORITY INTEGER;
DECLARE VARIABLE WK_HELD_STATUS VARCHAR(2); 
DECLARE VARIABLE WK_PROD_SIZE_TYPE VARCHAR(40);
DECLARE VARIABLE WK_ALLOW_EMPTY VARCHAR(50);
DECLARE VARIABLE WK_PO_WH_ID CHAR(2);
DECLARE VARIABLE WK_PO_COMPANY_ID VARCHAR(20);
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'PKAL') THEN
  BEGIN
     IF (NEW.TRN_CODE = 'H') THEN
     BEGIN
        WK_USER = NEW.PERSON_ID;
        WK_WHO_FOR = NEW.REFERENCE;
        WK_RECORD = NEW.RECORD_ID;
        WK_CN_PRIORITY = 0;
        WK_BUFFER = '';
        SELECT DEFAULT_PICK_PRIORITY, PICK_IMPORT_SSN_STATUS , WARN_PICK_PRIORITY
        FROM CONTROL 
        INTO :WK_CN_PRIORITY, :WK_IMPORTSTATUS, :WK_MOVE_PRIORITY;
/*
=====================================================================
 for all unallocated orders of today

 product from pick_item
 device from the zone 
        if the product is specified in a location within a zone
        otherwise use the zone for the company of the order
 then allocate to device 
====================================================================
*/
        WK_ORDER = '';
        FOR SELECT PI.PICK_ORDER 
            FROM PICK_ITEM PI
            JOIN PICK_ORDER PO ON PO.PICK_ORDER = PI.PICK_ORDER
            WHERE 
            PI.PICK_LINE_STATUS IN ('OP','UP')
            AND PO.PICK_STATUS IN ('OP','DA')
            GROUP BY PO.PICK_PRIORITY, PI.PICK_ORDER
            INTO :WK_ORDER 
        DO
        BEGIN
           SELECT WH_ID, COMPANY_ID
           FROM PICK_ORDER
           WHERE PICK_ORDER.PICK_ORDER = :WK_ORDER
           INTO :WK_PO_WH_ID, :WK_PO_COMPANY_ID;
           IF (WK_PO_WH_ID IS NULL) THEN
           BEGIN
              WK_PO_WH_ID = 'ALL';
           END
           IF (WK_PO_COMPANY_ID IS NULL) THEN
           BEGIN
              WK_PO_COMPANY_ID = 'ALL';
           END
           WK_HELD_STATUS = '';
           SELECT OPTIONS.DESCRIPTION
           FROM PICK_ORDER
           JOIN OPTIONS ON OPTIONS.GROUP_CODE = 'CMPPKHELD' AND OPTIONS.CODE = (PICK_ORDER.COMPANY_ID || '|' || PICK_ORDER.P_COUNTRY)
           WHERE PICK_ORDER.PICK_ORDER = :WK_ORDER
           INTO :WK_HELD_STATUS;
           IF (WK_HELD_STATUS IS NULL) THEN
           BEGIN
              SELECT OPTIONS.DESCRIPTION
              FROM PICK_ORDER
              JOIN OPTIONS ON OPTIONS.GROUP_CODE = 'CMPPKHELD' AND OPTIONS.CODE = PICK_ORDER.COMPANY_ID 
              WHERE PICK_ORDER.PICK_ORDER = :WK_ORDER
              INTO :WK_HELD_STATUS;
           END
           IF (WK_HELD_STATUS IS NULL) THEN
           BEGIN
              WK_HELD_STATUS = 'HD';
           END
           WK_PROD_OK = '';
           BEGIN
              WK_WORK_PROD = '';
              WK_WORK_ORDER_QTY = 0;
              WK_WORK_PICKED_QTY = 0;
              FOR SELECT PROD_ID, 
                  SUM( PICK_ITEM.PICK_ORDER_QTY ), 
                  SUM( PICK_ITEM.PICKED_QTY )
                  FROM PICK_ITEM
                  WHERE PICK_ORDER = :WK_ORDER
                  AND PICK_LINE_STATUS IN ('OP','UP')
                  GROUP BY PROD_ID
                  INTO :WK_WORK_PROD, :WK_WORK_ORDER_QTY, :WK_WORK_PICKED_QTY
              DO
              BEGIN
                 IF (WK_WORK_ORDER_QTY IS NULL) THEN
                 BEGIN
                    WK_WORK_ORDER_QTY = 0;
                 END
                 IF (WK_WORK_PICKED_QTY IS NULL) THEN
                 BEGIN
                    WK_WORK_PICKED_QTY = 0;
                 END
                 WK_WORK_TOPICK_QTY = WK_WORK_ORDER_QTY - WK_WORK_PICKED_QTY;
                 WK_AVAILABLE_QTY = 0;
                 IF (WK_PO_WH_ID = 'ALL') THEN
                 BEGIN
                    /* allow all wh_id */
                    IF (WK_PO_COMPANY_ID = 'ALL') THEN
                    BEGIN
                       /* allow all wh_id and all company_id */
                       SELECT SUM( ISSN.CURRENT_QTY ) 
                             FROM ISSN
                             WHERE ISSN.PROD_ID = :WK_WORK_PROD
                             AND (POS(:WK_IMPORTSTATUS,ISSN.ISSN_STATUS,0,1) > -1)
                             GROUP BY ISSN.PROD_ID
                       INTO :WK_AVAILABLE_QTY;
                    END
                    ELSE
                    BEGIN
                       /* allow all wh_id and required company_id */
                       SELECT SUM( ISSN.CURRENT_QTY ) 
                             FROM ISSN
                             WHERE ISSN.PROD_ID = :WK_WORK_PROD
                             AND ISSN.COMPANY_ID = :WK_PO_COMPANY_ID
                             AND (POS(:WK_IMPORTSTATUS,ISSN.ISSN_STATUS,0,1) > -1)
                             GROUP BY ISSN.PROD_ID
                       INTO :WK_AVAILABLE_QTY;
                    END
                 END
                 ELSE
                 BEGIN
                    /* only required wh_id */
                    IF (WK_PO_COMPANY_ID = 'ALL') THEN
                    BEGIN
                       /* only required wh_id and  all company_id */
                       SELECT SUM( ISSN.CURRENT_QTY ) 
                             FROM ISSN
                             WHERE ISSN.PROD_ID = :WK_WORK_PROD
                             AND ISSN.WH_ID = :WK_PO_WH_ID
                             AND (POS(:WK_IMPORTSTATUS,ISSN.ISSN_STATUS,0,1) > -1)
                             GROUP BY ISSN.PROD_ID
                       INTO :WK_AVAILABLE_QTY;
                    END
                    ELSE
                    BEGIN
                       /* only required wh_id and  required company_id */
                       SELECT SUM( ISSN.CURRENT_QTY ) 
                             FROM ISSN
                             WHERE ISSN.PROD_ID = :WK_WORK_PROD
                             AND ISSN.WH_ID = :WK_PO_WH_ID
                             AND ISSN.COMPANY_ID = :WK_PO_COMPANY_ID
                             AND (POS(:WK_IMPORTSTATUS,ISSN.ISSN_STATUS,0,1) > -1)
                             GROUP BY ISSN.PROD_ID
                       INTO :WK_AVAILABLE_QTY;
                    END
                 END
                 IF (WK_AVAILABLE_QTY IS NULL) THEN
                 BEGIN
                    WK_AVAILABLE_QTY = 0;
                 END
                 /* now must get qty allocated on order not picked */
                 WK_PICKED_QTY = 0;
                 WK_ORDER_QTY = 0;
                 SELECT SUM( PICK_ITEM.PICK_ORDER_QTY ), 
                        SUM( PICK_ITEM.PICKED_QTY ) 
                         FROM PICK_ITEM
                         WHERE PICK_ITEM.PROD_ID = :WK_WORK_PROD
                         AND ('AL' = PICK_ITEM.PICK_LINE_STATUS)
                         GROUP BY PICK_ITEM.PROD_ID
                      INTO :WK_ORDER_QTY, :WK_PICKED_QTY;
                 IF (WK_ORDER_QTY IS NULL) THEN
                 BEGIN
                    WK_ORDER_QTY = 0;
                 END
                 IF (WK_PICKED_QTY IS NULL) THEN
                 BEGIN
                    WK_PICKED_QTY = 0;
                 END
                 WK_ALLOC_ORDER_QTY = WK_ORDER_QTY - WK_PICKED_QTY;
                 WK_AVAILABLE_QTY = WK_AVAILABLE_QTY - WK_ALLOC_ORDER_QTY;
                 IF (WK_AVAILABLE_QTY < WK_WORK_TOPICK_QTY ) THEN
                 BEGIN
                    IF (LEN(WK_PROD_OK) < 53) THEN
                    BEGIN
                       WK_PROD_OK = WK_PROD_OK || ' ' || WK_WORK_PROD;
                    END
                    /* IF (WK_HELD_STATUS = 'HD') THEN */
                    /* IF ((WK_HELD_STATUS = 'HD') OR (WK_HELD_STATUS = 'CN')) THEN */
                    IF ((WK_HELD_STATUS = 'HD') OR (WK_HELD_STATUS = 'CN') OR (WK_HELD_STATUS = 'AS')) THEN
                    BEGIN
                       UPDATE PICK_ITEM 
                       SET PICK_LINE_STATUS = :WK_HELD_STATUS,
                       REASON = 'NOT ENOUGH STOCK'
                       WHERE PROD_ID = :WK_WORK_PROD
                       AND PICK_ORDER = :WK_ORDER
                       AND PICK_LINE_STATUS IN ('OP','UP');
                    END
                    ELSE
                    BEGIN
                       UPDATE PICK_ITEM 
                       SET REASON = 'NOT ENOUGH STOCK'
                       WHERE PROD_ID = :WK_WORK_PROD
                       AND PICK_ORDER = :WK_ORDER
                       AND PICK_LINE_STATUS IN ('OP','UP');
                    END
                 END
              END /* end of for */
              BEGIN
                 IF (WK_PROD_OK <> '') THEN
                 BEGIN
                    UPDATE PICK_ORDER SET PICK_PRIORITY = :WK_MOVE_PRIORITY 
                    WHERE PICK_ORDER = :WK_ORDER;
                 END
                 WK_FOUND = 0;
                 SELECT FIRST 1 1
                 FROM PICK_ITEM
                 WHERE PICK_ORDER = :WK_ORDER
                 AND PICK_LINE_STATUS IN ('OP','UP')
                 INTO :WK_FOUND;
                 IF (WK_FOUND = 1) THEN
                 BEGIN
                    /* ok we can allocate this */
                    UPDATE PICK_ITEM 
                       SET USER_ID = :WK_WHO_FOR, 
                           DEVICE_ID = NULL, 
                           PICK_LINE_STATUS = 'CN' 
                        WHERE PICK_ORDER = :WK_ORDER
                        AND PICK_LINE_STATUS IN ('OP','UP')
                        AND PICK_ORDER_QTY = 0;
                    UPDATE PICK_ITEM 
                       SET USER_ID = :WK_WHO_FOR, 
                           DEVICE_ID = (SELECT ZONE.DEFAULT_DEVICE_ID
                              FROM LOCATION
                              JOIN ZONE ON ZONE.CODE = LOCATION.ZONE_C
                              WHERE LOCATION.WH_ID = PICK_ITEM.WH_ID
                              AND LOCATION.LOCN_ID = PICK_ITEM.PICK_LOCATION), 
                           PICK_LINE_STATUS = 'AL', 
                           PICK_STARTED = 'NOW'
                        WHERE PICK_ORDER = :WK_ORDER
                        AND PICK_LINE_STATUS IN ('OP','UP');
                    /*     PICK_STATUS = 'PG' */ 
                    UPDATE PICK_ORDER
                       SET PICK_STARTED = 'NOW'
                        WHERE PICK_ORDER = :WK_ORDER
                        AND PICK_STARTED IS NULL;

                 END
                 ELSE
                 BEGIN
                    /* no lines left to allocate */
             /* UPDATE PICK_ORDER SET PICK_PRIORITY = :WK_MOVE_PRIORITY,PICK_STATUS = 'HD' 
             WHERE PICK_ORDER = :WK_ORDER; */
                 END
              END
           END
        END
        EXECUTE PROCEDURE UPDATE_TRAN (WK_RECORD, 'T','Processed successfully');
        /* EXECUTE PROCEDURE TRAN_ARCHIVE; */

     END /* code H */

     IF (NEW.TRN_CODE = 'I') THEN
     BEGIN
        /* allocate an order */
        WK_USER = NEW.PERSON_ID;
        WK_WHO_FOR = NEW.REFERENCE;
        WK_RECORD = NEW.RECORD_ID;
        WK_DEVICE = NEW.WH_ID;
        WK_ORDER = NEW.OBJECT;
        WK_CN_PRIORITY = 0;
        WK_BUFFER = '';
        SELECT DEFAULT_PICK_PRIORITY, PICK_IMPORT_SSN_STATUS , WARN_PICK_PRIORITY
        FROM CONTROL 
        INTO :WK_CN_PRIORITY, :WK_IMPORTSTATUS, :WK_MOVE_PRIORITY;
/*
=====================================================================
 for all unallocated orders of today
 product from pick_item
 then allocate to device 
====================================================================
  need to add orders for produtcs with a size class (size_type)
  then include any product for that size class - rather than putting to 'HD' - no stock
====================================================================
*/
        WK_ORDER = NEW.OBJECT;
        BEGIN
           SELECT WH_ID, COMPANY_ID
           FROM PICK_ORDER
           WHERE PICK_ORDER.PICK_ORDER = :WK_ORDER
           INTO :WK_PO_WH_ID, :WK_PO_COMPANY_ID;
           IF (WK_PO_WH_ID IS NULL) THEN
           BEGIN
              WK_PO_WH_ID = 'ALL';
           END
           IF (WK_PO_COMPANY_ID IS NULL) THEN
           BEGIN
              WK_PO_COMPANY_ID = 'ALL';
           END
           WK_HELD_STATUS = '';
           SELECT OPTIONS.DESCRIPTION, PICK_ORDER.PICK_STATUS
           FROM PICK_ORDER
           LEFT OUTER JOIN OPTIONS ON OPTIONS.GROUP_CODE = 'CMPPKHELD' AND OPTIONS.CODE = (PICK_ORDER.COMPANY_ID || '|' || PICK_ORDER.P_COUNTRY)
           WHERE PICK_ORDER.PICK_ORDER = :WK_ORDER
           INTO :WK_HELD_STATUS, :WK_ORDER_STATUS;
           IF (WK_HELD_STATUS IS NULL) THEN
           BEGIN
              SELECT OPTIONS.DESCRIPTION
              FROM PICK_ORDER
              JOIN OPTIONS ON OPTIONS.GROUP_CODE = 'CMPPKHELD' AND OPTIONS.CODE = PICK_ORDER.COMPANY_ID 
              WHERE PICK_ORDER.PICK_ORDER = :WK_ORDER
              INTO :WK_HELD_STATUS;
           END
           IF (WK_HELD_STATUS IS NULL) THEN
           BEGIN
              WK_HELD_STATUS = 'HD';
           END
           IF (WK_ORDER_STATUS IS NULL) THEN
           BEGIN
              WK_ORDER_STATUS = 'UC';
           END
           WK_PROD_OK = '';
           IF (WK_ORDER_STATUS = 'OP' OR WK_ORDER_STATUS = 'DA') THEN
           BEGIN
              WK_WORK_PROD = '';
              WK_WORK_ORDER_QTY = 0;
              WK_WORK_PICKED_QTY = 0;
              FOR SELECT PROD_ID, 
                  SUM( PICK_ITEM.PICK_ORDER_QTY ), 
                  SUM( PICK_ITEM.PICKED_QTY )
                  FROM PICK_ITEM
                  WHERE PICK_ORDER = :WK_ORDER
                  AND PICK_LINE_STATUS IN ('OP','UP')
                  GROUP BY PROD_ID
                  INTO :WK_WORK_PROD, :WK_WORK_ORDER_QTY, :WK_WORK_PICKED_QTY
              DO
              BEGIN
                 IF (WK_WORK_ORDER_QTY IS NULL) THEN
                 BEGIN
                    WK_WORK_ORDER_QTY = 0;
                 END
                 IF (WK_WORK_PICKED_QTY IS NULL) THEN
                 BEGIN
                    WK_WORK_PICKED_QTY = 0;
                 END
                 WK_PROD_SIZE_TYPE = '';
                 SELECT SIZE_TYPE
                 FROM PROD_PROFILE
                 WHERE PROD_ID = :WK_WORK_PROD 
                 INTO :WK_PROD_SIZE_TYPE;
                 IF (WK_PROD_SIZE_TYPE IS NULL) THEN
                 BEGIN
                    WK_PROD_SIZE_TYPE = '';
                 END
                 WK_WORK_TOPICK_QTY = WK_WORK_ORDER_QTY - WK_WORK_PICKED_QTY;
                 WK_AVAILABLE_QTY = 0;
                 IF (WK_PROD_SIZE_TYPE = '') THEN
                 BEGIN
                    /* use only this product */
                    IF (WK_PO_WH_ID = 'ALL') THEN
                    BEGIN
                       /* allow all wh_id */
                       IF (WK_PO_COMPANY_ID = 'ALL') THEN
                       BEGIN
                          /* allow all wh_id and all company_id */
                          SELECT SUM( ISSN.CURRENT_QTY ) 
                                FROM ISSN
                                WHERE ISSN.PROD_ID = :WK_WORK_PROD
                                AND (POS(:WK_IMPORTSTATUS,ISSN.ISSN_STATUS,0,1) > -1)
                                GROUP BY ISSN.PROD_ID
                          INTO :WK_AVAILABLE_QTY;
                       END
                       ELSE
                       BEGIN
                          /* allow all wh_id and required company_id */
                          SELECT SUM( ISSN.CURRENT_QTY ) 
                                FROM ISSN
                                WHERE ISSN.PROD_ID = :WK_WORK_PROD
                                AND ISSN.COMPANY_ID = :WK_PO_COMPANY_ID
                                AND (POS(:WK_IMPORTSTATUS,ISSN.ISSN_STATUS,0,1) > -1)
                                GROUP BY ISSN.PROD_ID
                          INTO :WK_AVAILABLE_QTY;
                       END
                    END
                    ELSE
                    BEGIN
                       /* only required wh_id */
                       IF (WK_PO_COMPANY_ID = 'ALL') THEN
                       BEGIN
                          /* only required wh_id and  all company_id */
                          SELECT SUM( ISSN.CURRENT_QTY ) 
                                FROM ISSN
                                WHERE ISSN.PROD_ID = :WK_WORK_PROD
                                AND ISSN.WH_ID = :WK_PO_WH_ID
                                AND (POS(:WK_IMPORTSTATUS,ISSN.ISSN_STATUS,0,1) > -1)
                                GROUP BY ISSN.PROD_ID
                          INTO :WK_AVAILABLE_QTY;
                       END
                       ELSE
                       BEGIN
                          /* only required wh_id and  required company_id */
                          SELECT SUM( ISSN.CURRENT_QTY ) 
                                FROM ISSN
                                WHERE ISSN.PROD_ID = :WK_WORK_PROD
                                AND ISSN.WH_ID = :WK_PO_WH_ID
                                AND ISSN.COMPANY_ID = :WK_PO_COMPANY_ID
                                AND (POS(:WK_IMPORTSTATUS,ISSN.ISSN_STATUS,0,1) > -1)
                                GROUP BY ISSN.PROD_ID
                          INTO :WK_AVAILABLE_QTY;
                       END
                    END
                 END
                 ELSE
                 BEGIN
                    /* use products in this size type */
                    IF (WK_PO_WH_ID = 'ALL') THEN
                    BEGIN
                       /* allow all wh_id */
                       IF (WK_PO_COMPANY_ID = 'ALL') THEN
                       BEGIN
                          /* allow all wh_id and all company_id */
                          SELECT SUM( ISSN.CURRENT_QTY ) 
                                FROM PROD_PROFILE
                                JOIN ISSN ON ISSN.PROD_ID = PROD_PROFILE.PROD_ID
                                WHERE PROD_PROFILE.SIZE_TYPE  = :WK_PROD_SIZE_TYPE
                                AND (POS(:WK_IMPORTSTATUS,ISSN.ISSN_STATUS,0,1) > -1)
                                GROUP BY PROD_PROFILE.SIZE_TYPE
                          INTO :WK_AVAILABLE_QTY;
                       END
                       ELSE
                       BEGIN
                          /* allow all wh_id and required company_id */
                          SELECT SUM( ISSN.CURRENT_QTY ) 
                                FROM PROD_PROFILE
                                JOIN ISSN ON ISSN.PROD_ID = PROD_PROFILE.PROD_ID
                                WHERE PROD_PROFILE.SIZE_TYPE  = :WK_PROD_SIZE_TYPE
                                AND ISSN.COMPANY_ID = :WK_PO_COMPANY_ID
                                AND (POS(:WK_IMPORTSTATUS,ISSN.ISSN_STATUS,0,1) > -1)
                                GROUP BY PROD_PROFILE.SIZE_TYPE
                          INTO :WK_AVAILABLE_QTY;
                       END
                    END
                    ELSE
                    BEGIN
                       /* only required wh_id */
                       IF (WK_PO_COMPANY_ID = 'ALL') THEN
                       BEGIN
                          /* only required wh_id and  all company_id */
                          SELECT SUM( ISSN.CURRENT_QTY ) 
                                FROM PROD_PROFILE
                                JOIN ISSN ON ISSN.PROD_ID = PROD_PROFILE.PROD_ID
                                WHERE PROD_PROFILE.SIZE_TYPE  = :WK_PROD_SIZE_TYPE
                                AND ISSN.WH_ID = :WK_PO_WH_ID
                                AND (POS(:WK_IMPORTSTATUS,ISSN.ISSN_STATUS,0,1) > -1)
                                GROUP BY PROD_PROFILE.SIZE_TYPE
                          INTO :WK_AVAILABLE_QTY;
                       END
                       ELSE
                       BEGIN
                          /* only required wh_id and  required company_id */
                          SELECT SUM( ISSN.CURRENT_QTY ) 
                                FROM PROD_PROFILE
                                JOIN ISSN ON ISSN.PROD_ID = PROD_PROFILE.PROD_ID
                                WHERE PROD_PROFILE.SIZE_TYPE  = :WK_PROD_SIZE_TYPE
                                AND ISSN.WH_ID = :WK_PO_WH_ID
                                AND ISSN.COMPANY_ID = :WK_PO_COMPANY_ID
                                AND (POS(:WK_IMPORTSTATUS,ISSN.ISSN_STATUS,0,1) > -1)
                                GROUP BY PROD_PROFILE.SIZE_TYPE
                          INTO :WK_AVAILABLE_QTY;
                       END
                    END
                 END
                 IF (WK_AVAILABLE_QTY IS NULL) THEN
                 BEGIN
                    WK_AVAILABLE_QTY = 0;
                 END
                 /* now must get qty allocated on order not picked */
                 WK_PICKED_QTY = 0;
                 WK_ORDER_QTY = 0;
                 IF (WK_PROD_SIZE_TYPE = '') THEN
                 BEGIN
                    /* use only this product */
                    SELECT SUM( PICK_ITEM.PICK_ORDER_QTY ), 
                           SUM( PICK_ITEM.PICKED_QTY ) 
                            FROM PICK_ITEM
                            WHERE PICK_ITEM.PROD_ID = :WK_WORK_PROD
                            AND ('AL' = PICK_ITEM.PICK_LINE_STATUS)
                            GROUP BY PICK_ITEM.PROD_ID
                         INTO :WK_ORDER_QTY, :WK_PICKED_QTY;
                 END
                 ELSE
                 BEGIN
                    /* use products in this size type */
                    SELECT SUM( PICK_ITEM.PICK_ORDER_QTY ), 
                           SUM( PICK_ITEM.PICKED_QTY ) 
                            FROM PROD_PROFILE
                            JOIN PICK_ITEM ON PICK_ITEM.PROD_ID = PROD_PROFILE.PROD_ID
                            WHERE PROD_PROFILE.SIZE_TYPE  = :WK_PROD_SIZE_TYPE
                            AND ('AL' = PICK_ITEM.PICK_LINE_STATUS)
                            GROUP BY PROD_PROFILE.SIZE_TYPE
                         INTO :WK_ORDER_QTY, :WK_PICKED_QTY;
                 END
                 IF (WK_ORDER_QTY IS NULL) THEN
                 BEGIN
                    WK_ORDER_QTY = 0;
                 END
                 IF (WK_PICKED_QTY IS NULL) THEN
                 BEGIN
                    WK_PICKED_QTY = 0;
                 END
                 WK_ALLOC_ORDER_QTY = WK_ORDER_QTY - WK_PICKED_QTY;
                 WK_AVAILABLE_QTY = WK_AVAILABLE_QTY - WK_ALLOC_ORDER_QTY;
                 IF (WK_AVAILABLE_QTY < WK_WORK_TOPICK_QTY ) THEN
                 BEGIN
                    IF (LEN(WK_PROD_OK) < 53) THEN
                    BEGIN
                       WK_PROD_OK = WK_PROD_OK || ' ' || WK_WORK_PROD;
                    END
                    /* IF (WK_HELD_STATUS = 'HD') THEN */
                    /* IF ((WK_HELD_STATUS = 'HD') OR (WK_HELD_STATUS = 'CN')) THEN */
                    IF ((WK_HELD_STATUS = 'HD') OR (WK_HELD_STATUS = 'CN') OR (WK_HELD_STATUS = 'AS')) THEN
                    BEGIN
                       UPDATE PICK_ITEM 
                       SET PICK_LINE_STATUS = :WK_HELD_STATUS,
                       REASON = 'NOT ENOUGH STOCK'
                       WHERE PROD_ID = :WK_WORK_PROD
                       AND PICK_ORDER = :WK_ORDER
                       AND PICK_LINE_STATUS IN ('OP','UP');
                    END
                    ELSE
                    BEGIN
                       UPDATE PICK_ITEM 
                       SET REASON = 'NOT ENOUGH STOCK'
                       WHERE PROD_ID = :WK_WORK_PROD
                       AND PICK_ORDER = :WK_ORDER
                       AND PICK_LINE_STATUS IN ('OP','UP');
                    END
                 END
              END /* end of for */
              BEGIN
                 IF (WK_PROD_OK <> '') THEN
                 BEGIN
                    UPDATE PICK_ORDER SET PICK_PRIORITY = :WK_MOVE_PRIORITY 
                    WHERE PICK_ORDER = :WK_ORDER;
                 END
                 WK_FOUND = 0;
                 SELECT FIRST 1 1
                 FROM PICK_ITEM
                 WHERE PICK_ORDER = :WK_ORDER
                 AND PICK_LINE_STATUS IN ('OP','UP')
                 INTO :WK_FOUND;
                 IF (WK_FOUND = 1) THEN
                 BEGIN
                    /* ok we can allocate this */
                    UPDATE PICK_ITEM 
                       SET USER_ID = :WK_WHO_FOR, 
                           DEVICE_ID = NULL, 
                           PICK_LINE_STATUS = 'CN' 
                        WHERE PICK_ORDER = :WK_ORDER
                        AND PICK_LINE_STATUS IN ('OP','UP')
                        AND PICK_ORDER_QTY = 0;
                    UPDATE PICK_ITEM 
                       SET USER_ID = :WK_WHO_FOR, 
                           DEVICE_ID = :WK_DEVICE,
                           PICK_LINE_STATUS = 'AL', 
                           PICK_STARTED = 'NOW'
                        WHERE PICK_ORDER = :WK_ORDER
                        AND PICK_LINE_STATUS IN ('OP','UP');
                    /*     PICK_STATUS = 'PG' */ 
                    UPDATE PICK_ORDER
                       SET PICK_STARTED = 'NOW'
                        WHERE PICK_ORDER = :WK_ORDER
                        AND PICK_STARTED IS NULL;

                 END
                 ELSE
                 BEGIN
                    /* no lines left to allocate */
/*           UPDATE PICK_ORDER SET PICK_PRIORITY = :WK_MOVE_PRIORITY,PICK_STATUS = 'HD'
             WHERE PICK_ORDER = :WK_ORDER; */
                 END
              END
           END
        END
        EXECUTE PROCEDURE UPDATE_TRAN (WK_RECORD, 'T','Processed successfully');
        /* EXECUTE PROCEDURE TRAN_ARCHIVE; */

     END /* code I */
     IF (NEW.TRN_CODE = 'J') THEN
     BEGIN
        /* allocate a product or issns of a product */
        WK_USER = NEW.PERSON_ID;
        WK_WHO_FOR = NEW.REFERENCE;
        WK_RECORD = NEW.RECORD_ID;
        WK_DEVICE = NEW.WH_ID;
        WK_WORK_PROD = NEW.OBJECT;
        WK_CN_PRIORITY = 0;
        WK_BUFFER = '';
        SELECT DEFAULT_PICK_PRIORITY, PICK_IMPORT_SSN_STATUS , WARN_PICK_PRIORITY
        FROM CONTROL 
        INTO :WK_CN_PRIORITY, :WK_IMPORTSTATUS, :WK_MOVE_PRIORITY;
/*
=====================================================================
 for all unallocated orders 
 with the product from pick_item
 then allocate to device 
then do the issns for the product
====================================================================
*/
        WK_ORDER  = '';
        WK_WORK_ORDER_QTY = 0;
        WK_WORK_PICKED_QTY = 0;
        FOR SELECT PICK_ITEM.PICK_ORDER,
            SUM( PICK_ITEM.PICK_ORDER_QTY ), 
            SUM( PICK_ITEM.PICKED_QTY )
            FROM PICK_ITEM
            JOIN PICK_ORDER ON PICK_ORDER.PICK_ORDER = PICK_ITEM.PICK_ORDER
            LEFT OUTER JOIN ISSN ON ISSN.SSN_ID = PICK_ITEM.SSN_ID
            WHERE (PICK_ITEM.PROD_ID = :WK_WORK_PROD
            OR  ISSN.PROD_ID = :WK_WORK_PROD)
            AND PICK_ITEM.PICK_LINE_STATUS IN ('OP','UP')
            AND PICK_ORDER.PICK_STATUS IN ('OP','DA')
            GROUP BY PICK_ITEM.PICK_ORDER 
            INTO :WK_ORDER, :WK_WORK_ORDER_QTY, :WK_WORK_PICKED_QTY
        DO
        BEGIN
           IF (WK_WORK_ORDER_QTY IS NULL) THEN
           BEGIN
              WK_WORK_ORDER_QTY = 0;
           END
           IF (WK_WORK_PICKED_QTY IS NULL) THEN
           BEGIN
              WK_WORK_PICKED_QTY = 0;
           END
           SELECT WH_ID, COMPANY_ID
           FROM PICK_ORDER
           WHERE PICK_ORDER.PICK_ORDER = :WK_ORDER
           INTO :WK_PO_WH_ID, :WK_PO_COMPANY_ID;
           IF (WK_PO_WH_ID IS NULL) THEN
           BEGIN
              WK_PO_WH_ID = 'ALL';
           END
           IF (WK_PO_COMPANY_ID IS NULL) THEN
           BEGIN
              WK_PO_COMPANY_ID = 'ALL';
           END
           WK_HELD_STATUS = '';
           SELECT OPTIONS.DESCRIPTION, PICK_ORDER.PICK_STATUS
           FROM PICK_ORDER
           LEFT OUTER JOIN OPTIONS ON OPTIONS.GROUP_CODE = 'CMPPKHELD' AND OPTIONS.CODE = (PICK_ORDER.COMPANY_ID || '|' || PICK_ORDER.P_COUNTRY)
           WHERE PICK_ORDER.PICK_ORDER = :WK_ORDER
           INTO :WK_HELD_STATUS, :WK_ORDER_STATUS;
           IF (WK_HELD_STATUS IS NULL) THEN
           BEGIN
              SELECT OPTIONS.DESCRIPTION
              FROM PICK_ORDER
              JOIN OPTIONS ON OPTIONS.GROUP_CODE = 'CMPPKHELD' AND OPTIONS.CODE = PICK_ORDER.COMPANY_ID 
              WHERE PICK_ORDER.PICK_ORDER = :WK_ORDER
              INTO :WK_HELD_STATUS;
           END
           IF (WK_HELD_STATUS IS NULL) THEN
           BEGIN
              WK_HELD_STATUS = 'HD';
           END
           IF (WK_ORDER_STATUS IS NULL) THEN
           BEGIN
              WK_ORDER_STATUS = 'UC';
           END
           WK_PROD_OK = '';
           IF (WK_ORDER_STATUS = 'OP' OR WK_ORDER_STATUS = 'DA') THEN
           BEGIN
              BEGIN
                 WK_WORK_TOPICK_QTY = WK_WORK_ORDER_QTY - WK_WORK_PICKED_QTY;
                 WK_AVAILABLE_QTY = 0;
                 IF (WK_PO_WH_ID = 'ALL') THEN
                 BEGIN
                    /* allow all wh_id */
                    IF (WK_PO_COMPANY_ID = 'ALL') THEN
                    BEGIN
                       /* allow all wh_id and all company_id */
                       SELECT SUM( ISSN.CURRENT_QTY ) 
                             FROM ISSN
                             WHERE ISSN.PROD_ID = :WK_WORK_PROD
                             AND (POS(:WK_IMPORTSTATUS,ISSN.ISSN_STATUS,0,1) > -1)
                             GROUP BY ISSN.PROD_ID
                       INTO :WK_AVAILABLE_QTY;
                    END
                    ELSE
                    BEGIN
                       /* allow all wh_id and required company_id */
                       SELECT SUM( ISSN.CURRENT_QTY ) 
                             FROM ISSN
                             WHERE ISSN.PROD_ID = :WK_WORK_PROD
                             AND ISSN.COMPANY_ID = :WK_PO_COMPANY_ID
                             AND (POS(:WK_IMPORTSTATUS,ISSN.ISSN_STATUS,0,1) > -1)
                             GROUP BY ISSN.PROD_ID
                       INTO :WK_AVAILABLE_QTY;
                    END
                 END
                 ELSE
                 BEGIN
                    /* only required wh_id */
                    IF (WK_PO_COMPANY_ID = 'ALL') THEN
                    BEGIN
                       /* only required wh_id and  all company_id */
                       SELECT SUM( ISSN.CURRENT_QTY ) 
                             FROM ISSN
                             WHERE ISSN.PROD_ID = :WK_WORK_PROD
                             AND ISSN.WH_ID = :WK_PO_WH_ID
                             AND (POS(:WK_IMPORTSTATUS,ISSN.ISSN_STATUS,0,1) > -1)
                             GROUP BY ISSN.PROD_ID
                       INTO :WK_AVAILABLE_QTY;
                    END
                    ELSE
                    BEGIN
                       /* only required wh_id and  required company_id */
                       SELECT SUM( ISSN.CURRENT_QTY ) 
                             FROM ISSN
                             WHERE ISSN.PROD_ID = :WK_WORK_PROD
                             AND ISSN.WH_ID = :WK_PO_WH_ID
                             AND ISSN.COMPANY_ID = :WK_PO_COMPANY_ID
                             AND (POS(:WK_IMPORTSTATUS,ISSN.ISSN_STATUS,0,1) > -1)
                             GROUP BY ISSN.PROD_ID
                       INTO :WK_AVAILABLE_QTY;
                    END
                 END
                 IF (WK_AVAILABLE_QTY IS NULL) THEN
                 BEGIN
                    WK_AVAILABLE_QTY = 0;
                 END
                 /* now must get qty allocated on order not picked */
                 WK_PICKED_QTY = 0;
                 WK_ORDER_QTY = 0;
                 SELECT SUM( PICK_ITEM.PICK_ORDER_QTY ), 
                        SUM( PICK_ITEM.PICKED_QTY ) 
                        FROM PICK_ITEM
                        LEFT OUTER JOIN ISSN ON ISSN.SSN_ID = PICK_ITEM.SSN_ID
                        WHERE (PICK_ITEM.PROD_ID = :WK_WORK_PROD
                        OR  ISSN.PROD_ID = :WK_WORK_PROD)
                        AND ('AL' = PICK_ITEM.PICK_LINE_STATUS)
                      INTO :WK_ORDER_QTY, :WK_PICKED_QTY;
                 IF (WK_ORDER_QTY IS NULL) THEN
                 BEGIN
                    WK_ORDER_QTY = 0;
                 END
                 IF (WK_PICKED_QTY IS NULL) THEN
                 BEGIN
                    WK_PICKED_QTY = 0;
                 END
                 WK_ALLOC_ORDER_QTY = WK_ORDER_QTY - WK_PICKED_QTY;
                 WK_AVAILABLE_QTY = WK_AVAILABLE_QTY - WK_ALLOC_ORDER_QTY;
                 IF (WK_AVAILABLE_QTY < WK_WORK_TOPICK_QTY ) THEN
                 BEGIN
                    IF (LEN(WK_PROD_OK) < 53) THEN
                    BEGIN
                       WK_PROD_OK = WK_PROD_OK || ' ' || WK_WORK_PROD;
                    END
                    /* IF (WK_HELD_STATUS = 'HD') THEN */
                    /* IF ((WK_HELD_STATUS = 'HD') OR (WK_HELD_STATUS = 'CN')) THEN */
                    IF ((WK_HELD_STATUS = 'HD') OR (WK_HELD_STATUS = 'CN') OR (WK_HELD_STATUS = 'AS')) THEN
                    BEGIN
                       UPDATE PICK_ITEM 
                       SET PICK_LINE_STATUS = :WK_HELD_STATUS,
                       REASON = 'NOT ENOUGH STOCK'
                       WHERE PROD_ID = :WK_WORK_PROD
                          AND PICK_ORDER = :WK_ORDER
                          AND PICK_LINE_STATUS IN ('OP','UP');
                       UPDATE PICK_ITEM 
                       SET PICK_LINE_STATUS = :WK_HELD_STATUS,
                       REASON = 'NOT ENOUGH STOCK'
                       WHERE PICK_ORDER = :WK_ORDER
                          AND PICK_LINE_STATUS IN ('OP','UP')
                          AND EXISTS ( SELECT ISSN.SSN_ID FROM ISSN WHERE ISSN.SSN_ID = PICK_ITEM.SSN_ID AND ISSN.PROD_ID = :WK_WORK_PROD ) ;
                    END
                    ELSE
                    BEGIN
                       UPDATE PICK_ITEM 
                       SET REASON = 'NOT ENOUGH STOCK'
                       WHERE PICK_ORDER = :WK_ORDER
                          AND PROD_ID = :WK_WORK_PROD
                          AND PICK_LINE_STATUS IN ('OP','UP');
                       UPDATE PICK_ITEM 
                       SET REASON = 'NOT ENOUGH STOCK'
                       WHERE PICK_ORDER = :WK_ORDER
                          AND PICK_LINE_STATUS IN ('OP','UP')
                          AND EXISTS ( SELECT ISSN.SSN_ID FROM ISSN WHERE ISSN.SSN_ID = PICK_ITEM.SSN_ID AND ISSN.PROD_ID = :WK_WORK_PROD ) ;
                    END
                 END
              END /* if - was end of for */
              BEGIN
                 IF (WK_PROD_OK <> '') THEN
                 BEGIN
                    UPDATE PICK_ORDER SET PICK_PRIORITY = :WK_MOVE_PRIORITY 
                    WHERE PICK_ORDER = :WK_ORDER;
                 END
                 WK_FOUND = 0;
                 SELECT FIRST 1 1
                 FROM PICK_ITEM
                 LEFT OUTER JOIN ISSN ON ISSN.SSN_ID = PICK_ITEM.SSN_ID
                 WHERE PICK_ITEM.PICK_ORDER = :WK_ORDER
                    AND (PICK_ITEM.PROD_ID = :WK_WORK_PROD
                    OR  ISSN.PROD_ID = :WK_WORK_PROD ) 
                 AND PICK_ITEM.PICK_LINE_STATUS IN ('OP','UP')
                 INTO :WK_FOUND;
                 IF (WK_FOUND = 1) THEN
                 BEGIN
                    /* ok we can allocate this */
                    UPDATE PICK_ITEM 
                       SET USER_ID = :WK_WHO_FOR, 
                           DEVICE_ID = NULL, 
                           PICK_LINE_STATUS = 'CN' 
                        WHERE PICK_ORDER = :WK_ORDER
                        AND PICK_LINE_STATUS IN ('OP','UP')
                        AND PICK_ORDER_QTY = 0;
                    UPDATE PICK_ITEM 
                       SET USER_ID = :WK_WHO_FOR, 
                           DEVICE_ID = :WK_DEVICE,
                           PICK_LINE_STATUS = 'AL', 
                           PICK_STARTED = 'NOW'
                        WHERE PICK_ORDER = :WK_ORDER
                        AND PROD_ID = :WK_WORK_PROD
                        AND PICK_LINE_STATUS IN ('OP','UP');
                    UPDATE PICK_ITEM 
                       SET USER_ID = :WK_WHO_FOR, 
                           DEVICE_ID = :WK_DEVICE,
                           PICK_LINE_STATUS = 'AL', 
                           PICK_STARTED = 'NOW'
                        WHERE PICK_ORDER = :WK_ORDER
                          AND EXISTS ( SELECT ISSN.SSN_ID FROM ISSN WHERE ISSN.SSN_ID = PICK_ITEM.SSN_ID AND ISSN.PROD_ID = :WK_WORK_PROD ) 
                        AND PICK_LINE_STATUS IN ('OP','UP');
                    /*     PICK_STATUS = 'PG' */ 
                    UPDATE PICK_ORDER
                       SET PICK_STARTED = 'NOW'
                        WHERE PICK_ORDER = :WK_ORDER
                        AND PICK_STARTED IS NULL;

                 END
                 ELSE
                 BEGIN
                    /* no lines left to allocate */
/*           UPDATE PICK_ORDER SET PICK_PRIORITY = :WK_MOVE_PRIORITY,PICK_STATUS = 'HD'
             WHERE PICK_ORDER = :WK_ORDER; */
                 END
              END
           END
        END /* end for */
        EXECUTE PROCEDURE UPDATE_TRAN (WK_RECORD, 'T','Processed successfully');
        /* EXECUTE PROCEDURE TRAN_ARCHIVE; */
     END /* code J */
  END /* PKAL */
 END /* autorun */
END ^

CREATE TRIGGER RUN_TRANSACTION_PKAL3 FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 49 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_PICK_QTY INTEGER;
DECLARE VARIABLE WK_PICK_CNT INTEGER;
DECLARE VARIABLE WK_LABEL VARCHAR(7);
DECLARE VARIABLE WK_DEVICE CHAR(2);
DECLARE VARIABLE WK_USER VARCHAR(10);
DECLARE VARIABLE WK_ORDER VARCHAR(30);
DECLARE VARIABLE WK_ORDER_STATUS CHAR(2);
DECLARE VARIABLE WK_ORDER_START TIMESTAMP;
DECLARE VARIABLE WK_DATE TIMESTAMP;
DECLARE VARIABLE WK_RECORD INTEGER;
DECLARE VARIABLE WK_PI_LABEL VARCHAR(7);
DECLARE VARIABLE WK_PI_SSN VARCHAR(20);
DECLARE VARIABLE WK_PI_PROD VARCHAR(30);
DECLARE VARIABLE WK_PI_WH CHAR(2);
DECLARE VARIABLE WK_PI_LOCN VARCHAR(10);
DECLARE VARIABLE WK_PI_LASTLOCN VARCHAR(10);
DECLARE VARIABLE WK_PI_QTY INTEGER;
DECLARE VARIABLE WK_PI_STATUS CHAR(2);
DECLARE VARIABLE WK_PI_STATUS_2 CHAR(2);
DECLARE VARIABLE WK_PI_DESCRIPTION VARCHAR(40);
DECLARE VARIABLE WK_PI_ORDER VARCHAR(15);
DECLARE VARIABLE WK_PI_ORDER_QTY INTEGER;
DECLARE VARIABLE WK_PI_DESPATCH_LOCN VARCHAR(10);
DECLARE VARIABLE WK_PI_TYPE   VARCHAR(10);
DECLARE VARIABLE WK_DIRECTORY VARCHAR(80);
DECLARE VARIABLE WK_FILENAME VARCHAR(80);
DECLARE VARIABLE WK_LABEL_LINE VARCHAR(330);
DECLARE VARIABLE WK_RESULT INTEGER;
DECLARE VARIABLE WK_PROD_SSN VARCHAR(20);
DECLARE VARIABLE WK_UOM CHAR(2);
DECLARE VARIABLE WK_PICK_TYPE CHAR(1);
DECLARE VARIABLE WK_FOUND_PICK INTEGER;
DECLARE VARIABLE WK_SEQ INTEGER;
DECLARE VARIABLE WK_DESPATCH_GROUP VARCHAR(10);
DECLARE VARIABLE WK_TOT_GROUP_LOCNS INTEGER;
DECLARE VARIABLE WK_TOT_GROUP_PRODUCTS_USED INTEGER;
DECLARE VARIABLE WK_TOT_GROUPS_PRODUCTS_USED INTEGER;
DECLARE VARIABLE WK_TOT_GROUP_EMPTY INTEGER;
DECLARE VARIABLE WK_TOT_ORDER_PRODUCTS INTEGER;
DECLARE VARIABLE WK_MAX_ORDERS INTEGER;
DECLARE VARIABLE WK_MAX_PRODUCTS INTEGER;
DECLARE VARIABLE WK_TOT_GROUPS_ORDERS INTEGER;
DECLARE VARIABLE WK_WHO_FOR VARCHAR(40);
DECLARE VARIABLE WK_WHO_FOR2 VARCHAR(40);
DECLARE VARIABLE WK_FOUND INTEGER;
DECLARE VARIABLE WK_GM_MESSAGE VARCHAR(10);
DECLARE VARIABLE WK_T4_DELIM CHAR(1);
DECLARE VARIABLE WK_T4_TRAN_DATA VARCHAR(1024);
DECLARE VARIABLE WK_T4_SOURCE VARCHAR(512);
DECLARE VARIABLE WK_NEW_RECORD INTEGER;
DECLARE VARIABLE WK_CN_PRIORITY SMALLINT;
DECLARE VARIABLE WK_DO_UCIS CHAR(1);
DECLARE VARIABLE WK_DO_GSMD CHAR(1);
DECLARE VARIABLE WK_PROD_OK VARCHAR(80);
DECLARE VARIABLE WK_BUFFER VARCHAR(80);
DECLARE VARIABLE WK_WORK_PROD VARCHAR(30);
DECLARE VARIABLE WK_WORK_PROD2 VARCHAR(30);
DECLARE VARIABLE WK_WORK_TOPICK_QTY INTEGER;
DECLARE VARIABLE WK_WORK_PICKED_QTY INTEGER;
DECLARE VARIABLE WK_WORK_ORDER_QTY INTEGER;
DECLARE VARIABLE WK_WORK_LABEL VARCHAR(7);
DECLARE VARIABLE WK_AVAILABLE_QTY INTEGER;
DECLARE VARIABLE WK_ALLOC_ORDER_QTY INTEGER;
DECLARE VARIABLE WK_ORDER_QTY INTEGER;
DECLARE VARIABLE WK_PICKED_QTY INTEGER;
DECLARE VARIABLE WK_IMPORTSTATUS VARCHAR(40); 
DECLARE VARIABLE WK_TOT_ORDER_PRODUCTS_GROUP INTEGER;
DECLARE VARIABLE WK_MOVE_PRIORITY INTEGER;
DECLARE VARIABLE WK_HELD_STATUS VARCHAR(2); 
DECLARE VARIABLE WK_PROD_SIZE_TYPE VARCHAR(40);
DECLARE VARIABLE WK_ALLOW_EMPTY VARCHAR(50);
DECLARE VARIABLE WK_PO_WH_ID CHAR(2);
DECLARE VARIABLE WK_PO_COMPANY_ID VARCHAR(20);
DECLARE VARIABLE WK_DO_BY_LABEL VARCHAR(40);
DECLARE VARIABLE WK_LOG_FILENAME VARCHAR(80) ;
DECLARE VARIABLE WK_LOG_RESULT   INTEGER;
DECLARE VARIABLE WK_LOG_BUFFER VARCHAR(255) ;
DECLARE VARIABLE WK_HAVE_ERROR CHAR(1) ;
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'PKAL') THEN
  BEGIN
     IF (NEW.TRN_CODE = 'F') THEN
     BEGIN
        WK_LOG_FILENAME = '/tmp/pkalf.log';
        WK_HAVE_ERROR = 'F';
        /* allocate a product or issns of a product for a specific label */
        WK_USER = NEW.PERSON_ID;
        /* WK_WHO_FOR = NEW.REFERENCE; */
        WK_RECORD = NEW.RECORD_ID;
        WK_DEVICE = NEW.WH_ID;
        WK_PI_LABEL = NEW.OBJECT;
        WK_DATE = NEW.TRN_DATE;
        EXECUTE PROCEDURE GET_REFERENCE_FIELD NEW.REFERENCE, 1  RETURNING_VALUES :WK_WHO_FOR ; 
        EXECUTE PROCEDURE GET_REFERENCE_FIELD NEW.REFERENCE, 2  RETURNING_VALUES :WK_WORK_PROD ; 
        /* cannot trust the product or who for - use the pick_label and sys_equip for this */
        WK_CN_PRIORITY = 0;
        WK_BUFFER = '';
        SELECT CURRENT_PERSON, LAST_PERSON
        FROM SYS_EQUIP
        WHERE DEVICE_ID = :WK_DEVICE
        INTO :WK_WHO_FOR, :WK_WHO_FOR2;
        IF (WK_WHO_FOR IS NULL) THEN
        BEGIN
           WK_WHO_FOR = WK_WHO_FOR2;
        END
        SELECT DEFAULT_PICK_PRIORITY, PICK_IMPORT_SSN_STATUS , WARN_PICK_PRIORITY
        FROM CONTROL 
        INTO :WK_CN_PRIORITY, :WK_IMPORTSTATUS, :WK_MOVE_PRIORITY;
/*
=====================================================================
 for all unallocated orders 
 with the product from pick_item
 then allocate to device 
====================================================================
*/
        WK_DO_BY_LABEL = 'T';
        SELECT DESCRIPTION
        FROM OPTIONS
        WHERE GROUP_CODE = 'PKAL'
        AND CODE = 'F|BYLABEL'
        INTO :WK_DO_BY_LABEL;
        IF (WK_DO_BY_LABEL IS NULL) THEN
        BEGIN
           WK_DO_BY_LABEL = 'T';
        END
        IF (WK_DO_BY_LABEL = 'T') THEN
        BEGIN
           WK_ORDER  = '';
           WK_WORK_ORDER_QTY = 0;
           WK_WORK_PICKED_QTY = 0;
           FOR SELECT PICK_ITEM.PICK_ORDER,
               PICK_ITEM.PROD_ID,
               PICK_ITEM.PICK_ORDER_QTY , 
               PICK_ITEM.PICKED_QTY 
               FROM PICK_ITEM
               JOIN PICK_ORDER ON PICK_ORDER.PICK_ORDER = PICK_ITEM.PICK_ORDER
               WHERE PICK_ITEM.PICK_LABEL_NO = :WK_PI_LABEL
               AND PICK_ITEM.PICK_LINE_STATUS IN ('OP','UP')
               AND PICK_ORDER.PICK_STATUS IN ('OP','DA')
               INTO :WK_ORDER, :WK_WORK_PROD, :WK_WORK_ORDER_QTY, :WK_WORK_PICKED_QTY
           DO
           BEGIN
              IF (WK_WORK_ORDER_QTY IS NULL) THEN
              BEGIN
                 WK_WORK_ORDER_QTY = 0;
              END
              IF (WK_WORK_PICKED_QTY IS NULL) THEN
              BEGIN
                 WK_WORK_PICKED_QTY = 0;
              END
              IF (WK_WORK_PROD IS NOT NULL) THEN
              BEGIN
                 WK_WORK_PROD = ALLTRIM(WK_WORK_PROD);
                 IF (STRLEN(WK_WORK_PROD) = 0) THEN
                 BEGIN
                    WK_WORK_PROD = NULL;
                 END
              END
              SELECT WH_ID, COMPANY_ID
              FROM PICK_ORDER
              WHERE PICK_ORDER.PICK_ORDER = :WK_ORDER
              INTO :WK_PO_WH_ID, :WK_PO_COMPANY_ID;
              IF (WK_PO_WH_ID IS NULL) THEN
              BEGIN
                 WK_PO_WH_ID = 'ALL';
              END
              IF (WK_PO_COMPANY_ID IS NULL) THEN
              BEGIN
                 WK_PO_COMPANY_ID = 'ALL';
              END
              WK_HELD_STATUS = '';
              SELECT OPTIONS.DESCRIPTION, PICK_ORDER.PICK_STATUS
              FROM PICK_ORDER
              LEFT OUTER JOIN OPTIONS ON OPTIONS.GROUP_CODE = 'CMPPKHELD' AND OPTIONS.CODE = (PICK_ORDER.COMPANY_ID || '|' || PICK_ORDER.P_COUNTRY)
              WHERE PICK_ORDER.PICK_ORDER = :WK_ORDER
              INTO :WK_HELD_STATUS, :WK_ORDER_STATUS;
              IF (WK_HELD_STATUS IS NULL) THEN
              BEGIN
                 SELECT OPTIONS.DESCRIPTION
                 FROM PICK_ORDER
                 JOIN OPTIONS ON OPTIONS.GROUP_CODE = 'CMPPKHELD' AND OPTIONS.CODE = PICK_ORDER.COMPANY_ID 
                 WHERE PICK_ORDER.PICK_ORDER = :WK_ORDER
                 INTO :WK_HELD_STATUS;
              END
              IF (WK_HELD_STATUS IS NULL) THEN
              BEGIN
                 WK_HELD_STATUS = 'HD';
              END
              IF (WK_ORDER_STATUS IS NULL) THEN
              BEGIN
                 WK_ORDER_STATUS = 'UC';
              END
              WK_PROD_OK = '';
              IF (WK_ORDER_STATUS = 'OP' OR WK_ORDER_STATUS = 'DA') THEN
              BEGIN
                 BEGIN
                    WK_WORK_TOPICK_QTY = WK_WORK_ORDER_QTY - WK_WORK_PICKED_QTY;
                    WK_AVAILABLE_QTY = 0;
                    IF (WK_WORK_PROD IS NOT NULL) THEN
                    BEGIN
                       /* get available qty */
                       IF (WK_PO_WH_ID = 'ALL') THEN
                       BEGIN
                          /* allow all wh_id */
                          IF (WK_PO_COMPANY_ID = 'ALL') THEN
                          BEGIN
                             /* allow all wh_id and all company_id */
                             SELECT SUM( ISSN.CURRENT_QTY ) 
                                   FROM ISSN
                                   WHERE ISSN.PROD_ID = :WK_WORK_PROD
                                   AND (POS(:WK_IMPORTSTATUS,ISSN.ISSN_STATUS,0,1) > -1)
                                   GROUP BY ISSN.PROD_ID
                             INTO :WK_AVAILABLE_QTY;
                          END
                          ELSE
                          BEGIN
                             /* allow all wh_id and required company_id */
                             SELECT SUM( ISSN.CURRENT_QTY ) 
                                   FROM ISSN
                                   WHERE ISSN.PROD_ID = :WK_WORK_PROD
                                   AND ISSN.COMPANY_ID = :WK_PO_COMPANY_ID
                                   AND (POS(:WK_IMPORTSTATUS,ISSN.ISSN_STATUS,0,1) > -1)
                                   GROUP BY ISSN.PROD_ID
                             INTO :WK_AVAILABLE_QTY;
                          END
                       END
                       ELSE
                       BEGIN
                          /* only required wh_id */
                          IF (WK_PO_COMPANY_ID = 'ALL') THEN
                          BEGIN
                             /* only required wh_id and  all company_id */
                             SELECT SUM( ISSN.CURRENT_QTY ) 
                                   FROM ISSN
                                   WHERE ISSN.PROD_ID = :WK_WORK_PROD
                                   AND ISSN.WH_ID = :WK_PO_WH_ID
                                   AND (POS(:WK_IMPORTSTATUS,ISSN.ISSN_STATUS,0,1) > -1)
                                   GROUP BY ISSN.PROD_ID
                             INTO :WK_AVAILABLE_QTY;
                          END
                          ELSE
                          BEGIN
                             /* only required wh_id and  required company_id */
                             SELECT SUM( ISSN.CURRENT_QTY ) 
                                   FROM ISSN
                                   WHERE ISSN.PROD_ID = :WK_WORK_PROD
                                   AND ISSN.WH_ID = :WK_PO_WH_ID
                                   AND ISSN.COMPANY_ID = :WK_PO_COMPANY_ID
                                   AND (POS(:WK_IMPORTSTATUS,ISSN.ISSN_STATUS,0,1) > -1)
                                   GROUP BY ISSN.PROD_ID
                             INTO :WK_AVAILABLE_QTY;
                          END
                       END
                    END
                    IF (WK_AVAILABLE_QTY IS NULL) THEN
                    BEGIN
                       WK_AVAILABLE_QTY = 0;
                    END
                    /* now must get qty allocated on order not picked */
                    WK_PICKED_QTY = 0;
                    WK_ORDER_QTY = 0;
                    IF (WK_WORK_PROD IS NOT NULL) THEN
                    BEGIN
                       SELECT SUM( PICK_ITEM.PICK_ORDER_QTY ), 
                              SUM( PICK_ITEM.PICKED_QTY ) 
                              FROM PICK_ITEM
                              LEFT OUTER JOIN ISSN ON ISSN.SSN_ID = PICK_ITEM.SSN_ID
                              WHERE (PICK_ITEM.PROD_ID = :WK_WORK_PROD
                              OR  ISSN.PROD_ID = :WK_WORK_PROD)
                              AND ('AL' = PICK_ITEM.PICK_LINE_STATUS)
                            INTO :WK_ORDER_QTY, :WK_PICKED_QTY;
                    END
                    IF (WK_ORDER_QTY IS NULL) THEN
                    BEGIN
                       WK_ORDER_QTY = 0;
                    END
                    IF (WK_PICKED_QTY IS NULL) THEN
                    BEGIN
                       WK_PICKED_QTY = 0;
                    END
                    WK_ALLOC_ORDER_QTY = WK_ORDER_QTY - WK_PICKED_QTY;
                    WK_AVAILABLE_QTY = WK_AVAILABLE_QTY - WK_ALLOC_ORDER_QTY;
                    IF (WK_WORK_PROD IS NULL) THEN
                    BEGIN
                       /* for an ssn decision already made in the confirm */
                       WK_AVAILABLE_QTY = WK_WORK_TOPICK_QTY;
                    END
                    IF (WK_AVAILABLE_QTY < WK_WORK_TOPICK_QTY ) THEN
                    BEGIN
                       IF (LEN(WK_PROD_OK) < 53) THEN
                       BEGIN
                          WK_PROD_OK = WK_PROD_OK || ' ' || WK_WORK_PROD;
                       END
                       /* IF (WK_HELD_STATUS = 'HD') THEN */
                       /* IF ((WK_HELD_STATUS = 'HD') OR (WK_HELD_STATUS = 'CN')) THEN */
                       IF ((WK_HELD_STATUS = 'HD') OR (WK_HELD_STATUS = 'CN') OR (WK_HELD_STATUS = 'AS')) THEN
                       BEGIN
                          UPDATE PICK_ITEM 
                          SET PICK_LINE_STATUS = :WK_HELD_STATUS,
                          REASON = 'NOT ENOUGH STOCK'
                          WHERE PICK_LABEL_NO = :WK_PI_LABEL
                             AND PICK_LINE_STATUS IN ('OP','UP');
                       END
                       ELSE
                       BEGIN
                          UPDATE PICK_ITEM 
                          SET REASON = 'NOT ENOUGH STOCK'
                          WHERE PICK_LABEL_NO = :WK_PI_LABEL
                             AND PICK_LINE_STATUS IN ('OP','UP');
                       END
                    END
                 END /* if - was end of for */
                 BEGIN
                    IF (WK_PROD_OK <> '') THEN
                    BEGIN
                       UPDATE PICK_ORDER SET PICK_PRIORITY = :WK_MOVE_PRIORITY 
                       WHERE PICK_ORDER = :WK_ORDER;
                    END
                    WK_FOUND = 0;
                    SELECT FIRST 1 1
                    FROM PICK_ITEM
                    WHERE PICK_ITEM.PICK_LABEL_NO = :WK_PI_LABEL
                    AND PICK_ITEM.PICK_LINE_STATUS IN ('OP','UP')
                    INTO :WK_FOUND;
                    IF (WK_FOUND = 1) THEN
                    BEGIN
                       /* ok we can allocate this */
                       UPDATE PICK_ITEM 
                          SET USER_ID = :WK_WHO_FOR, 
                              DEVICE_ID = NULL, 
                              PICK_LINE_STATUS = 'CN' 
                           WHERE PICK_ORDER = :WK_ORDER
                           AND PICK_LINE_STATUS IN ('OP','UP')
                           AND PICK_ORDER_QTY = 0;
                       UPDATE PICK_ITEM 
                          SET USER_ID = :WK_WHO_FOR, 
                              DEVICE_ID = :WK_DEVICE,
                              PICK_LINE_STATUS = 'AL', 
                              PICK_STARTED = 'NOW'
                           WHERE PICK_LABEL_NO = :WK_PI_LABEL
                           AND PICK_LINE_STATUS IN ('OP','UP');
                       UPDATE PICK_ORDER
                          SET PICK_STARTED = 'NOW'
                           WHERE PICK_ORDER = :WK_ORDER
                           AND PICK_STARTED IS NULL;
                    END
                    ELSE
                    BEGIN
                       /* no lines left to allocate */
   /*           UPDATE PICK_ORDER SET PICK_PRIORITY = :WK_MOVE_PRIORITY,PICK_STATUS = 'HD'
                WHERE PICK_ORDER = :WK_ORDER; */
                    END
                 END
              END
           END /* end for */
        END /* end if do label only  */
        ELSE
        BEGIN
           /* do by order for this label no */
           WK_ORDER  = '';
           WK_WORK_ORDER_QTY = 0;
           WK_WORK_PICKED_QTY = 0;
           SELECT PICK_ITEM.PICK_ORDER
               FROM PICK_ITEM
               JOIN PICK_ORDER ON PICK_ORDER.PICK_ORDER = PICK_ITEM.PICK_ORDER
               WHERE PICK_ITEM.PICK_LABEL_NO = :WK_PI_LABEL
               AND PICK_ITEM.PICK_LINE_STATUS IN ('OP','UP')
               AND PICK_ORDER.PICK_STATUS IN ('OP','DA')
               INTO :WK_ORDER ;
            IF (WK_ORDER IS NULL) THEN
            BEGIN
               WK_ORDER = '';
            END
           /* now do pkal for this */
/*
           WK_LOG_BUFFER = 'EXECUTE PROCEDURE ADD_TRAN(' || :WK_DEVICE || ', "T|      ",' || :WK_ORDER || ', "PKAL", "I", ' || :WK_DATE || ', ' || :WK_WHO_FOR || ', 0,  "F", "", "MASTER", 0, "          ", ' || NEW.INPUT_SOURCE || ',' || :WK_USER || ',' || NEW.DEVICE_ID || ')';
           WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, 'start add pick prod items');
           WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, WK_LOG_BUFFER);
*/
           IF (WK_ORDER <> '') THEN
           BEGIN
              EXECUTE PROCEDURE ADD_TRAN(
                    :WK_DEVICE,
                    'T|      ',
                    :WK_ORDER,
                    'PKAL',
                    'I',
                    :WK_DATE,
                    :WK_WHO_FOR,
                    0, /* qty */
                    'F',
                    '',
                    'MASTER',
                    0,
                    '          ', /* sub locn id */
                    NEW.INPUT_SOURCE,
                    :WK_USER,
                    NEW.DEVICE_ID);
           END
           ELSE
           BEGIN
              EXECUTE PROCEDURE UPDATE_TRAN (WK_RECORD, 'F','No Line to Allocate');
              WK_HAVE_ERROR = 'T';
           END
        END
        IF (WK_HAVE_ERROR = 'F') THEN
        BEGIN
           EXECUTE PROCEDURE UPDATE_TRAN (WK_RECORD, 'T','Processed successfully');
           /* EXECUTE PROCEDURE TRAN_ARCHIVE; */
        END
     END /* code F */

     IF ((NEW.TRN_CODE = 'K') OR
         (NEW.TRN_CODE = 'L')) THEN
     BEGIN
/*
         copied from code I 
         allocate an order 
         either do issn / ssn lines code K
           or product only lines  code L 
*/
        WK_USER = NEW.PERSON_ID;
        WK_WHO_FOR = NEW.REFERENCE;
        WK_RECORD = NEW.RECORD_ID;
        WK_DEVICE = NEW.WH_ID;
        WK_ORDER = NEW.OBJECT;
        WK_PI_TYPE = '';
        IF (NEW.TRN_CODE = 'K') THEN
        BEGIN
           WK_PI_TYPE = 'I' ; 
        END
        IF (NEW.TRN_CODE = 'L') THEN
        BEGIN
           WK_PI_TYPE = 'P' ; 
        END
        WK_CN_PRIORITY = 0;
        WK_BUFFER = '';
        SELECT DEFAULT_PICK_PRIORITY, PICK_IMPORT_SSN_STATUS , WARN_PICK_PRIORITY
        FROM CONTROL 
        INTO :WK_CN_PRIORITY, :WK_IMPORTSTATUS, :WK_MOVE_PRIORITY;
/*
=====================================================================
  for product lines
  need to add orders for products with a size class (size_type)
  then include any product for that size class - rather than putting to 'HD' - no stock
====================================================================
*/
        WK_ORDER = NEW.OBJECT;
        BEGIN
           SELECT WH_ID, COMPANY_ID
           FROM PICK_ORDER
           WHERE PICK_ORDER.PICK_ORDER = :WK_ORDER
           INTO :WK_PO_WH_ID, :WK_PO_COMPANY_ID;
           IF (WK_PO_WH_ID IS NULL) THEN
           BEGIN
              WK_PO_WH_ID = 'ALL';
           END
           IF (WK_PO_COMPANY_ID IS NULL) THEN
           BEGIN
              WK_PO_COMPANY_ID = 'ALL';
           END
           WK_HELD_STATUS = '';
           SELECT OPTIONS.DESCRIPTION, PICK_ORDER.PICK_STATUS
           FROM PICK_ORDER
           LEFT OUTER JOIN OPTIONS ON OPTIONS.GROUP_CODE = 'CMPPKHELD' AND OPTIONS.CODE = (PICK_ORDER.COMPANY_ID || '|' || PICK_ORDER.P_COUNTRY)
           WHERE PICK_ORDER.PICK_ORDER = :WK_ORDER
           INTO :WK_HELD_STATUS, :WK_ORDER_STATUS;
           IF (WK_HELD_STATUS IS NULL) THEN
           BEGIN
              SELECT OPTIONS.DESCRIPTION
              FROM PICK_ORDER
              JOIN OPTIONS ON OPTIONS.GROUP_CODE = 'CMPPKHELD' AND OPTIONS.CODE = PICK_ORDER.COMPANY_ID 
              WHERE PICK_ORDER.PICK_ORDER = :WK_ORDER
              INTO :WK_HELD_STATUS;
           END
           IF (WK_HELD_STATUS IS NULL) THEN
           BEGIN
              WK_HELD_STATUS = 'HD';
           END
           IF (WK_ORDER_STATUS IS NULL) THEN
           BEGIN
              WK_ORDER_STATUS = 'UC';
           END
           WK_PROD_OK = '';
           IF ((WK_ORDER_STATUS = 'OP' OR WK_ORDER_STATUS = 'DA') AND (WK_PI_TYPE = 'P')) THEN
           BEGIN
              WK_WORK_PROD = '';
              WK_WORK_ORDER_QTY = 0;
              WK_WORK_PICKED_QTY = 0;
              FOR SELECT PROD_ID, 
                  SUM( PICK_ITEM.PICK_ORDER_QTY ), 
                  SUM( PICK_ITEM.PICKED_QTY )
                  FROM PICK_ITEM
                  WHERE PICK_ORDER = :WK_ORDER
                  AND PICK_LINE_STATUS IN ('OP','UP')
                  AND (PROD_ID IS NOT NULL)
                  GROUP BY PROD_ID
                  INTO :WK_WORK_PROD, :WK_WORK_ORDER_QTY, :WK_WORK_PICKED_QTY
              DO
              BEGIN
                 IF (WK_WORK_ORDER_QTY IS NULL) THEN
                 BEGIN
                    WK_WORK_ORDER_QTY = 0;
                 END
                 IF (WK_WORK_PICKED_QTY IS NULL) THEN
                 BEGIN
                    WK_WORK_PICKED_QTY = 0;
                 END
                 WK_PROD_SIZE_TYPE = '';
                 SELECT SIZE_TYPE
                 FROM PROD_PROFILE
                 WHERE PROD_ID = :WK_WORK_PROD 
                 INTO :WK_PROD_SIZE_TYPE;
                 IF (WK_PROD_SIZE_TYPE IS NULL) THEN
                 BEGIN
                    WK_PROD_SIZE_TYPE = '';
                 END
                 WK_WORK_TOPICK_QTY = WK_WORK_ORDER_QTY - WK_WORK_PICKED_QTY;
                 WK_AVAILABLE_QTY = 0;
                 IF (WK_PROD_SIZE_TYPE = '') THEN
                 BEGIN
                    /* use only this product */
                    IF (WK_PO_WH_ID = 'ALL') THEN
                    BEGIN
                       /* allow all wh_id */
                       IF (WK_PO_COMPANY_ID = 'ALL') THEN
                       BEGIN
                          /* allow all wh_id and all company_id */
                          SELECT SUM( ISSN.CURRENT_QTY ) 
                                FROM ISSN
                                WHERE ISSN.PROD_ID = :WK_WORK_PROD
                                AND (POS(:WK_IMPORTSTATUS,ISSN.ISSN_STATUS,0,1) > -1)
                                GROUP BY ISSN.PROD_ID
                          INTO :WK_AVAILABLE_QTY;
                       END
                       ELSE
                       BEGIN
                          /* allow all wh_id and required company_id */
                          SELECT SUM( ISSN.CURRENT_QTY ) 
                                FROM ISSN
                                WHERE ISSN.PROD_ID = :WK_WORK_PROD
                                AND ISSN.COMPANY_ID = :WK_PO_COMPANY_ID
                                AND (POS(:WK_IMPORTSTATUS,ISSN.ISSN_STATUS,0,1) > -1)
                                GROUP BY ISSN.PROD_ID
                          INTO :WK_AVAILABLE_QTY;
                       END
                    END
                    ELSE
                    BEGIN
                       /* only required wh_id */
                       IF (WK_PO_COMPANY_ID = 'ALL') THEN
                       BEGIN
                          /* only required wh_id and  all company_id */
                          SELECT SUM( ISSN.CURRENT_QTY ) 
                                FROM ISSN
                                WHERE ISSN.PROD_ID = :WK_WORK_PROD
                                AND ISSN.WH_ID = :WK_PO_WH_ID
                                AND (POS(:WK_IMPORTSTATUS,ISSN.ISSN_STATUS,0,1) > -1)
                                GROUP BY ISSN.PROD_ID
                          INTO :WK_AVAILABLE_QTY;
                       END
                       ELSE
                       BEGIN
                          /* only required wh_id and  required company_id */
                          SELECT SUM( ISSN.CURRENT_QTY ) 
                                FROM ISSN
                                WHERE ISSN.PROD_ID = :WK_WORK_PROD
                                AND ISSN.WH_ID = :WK_PO_WH_ID
                                AND ISSN.COMPANY_ID = :WK_PO_COMPANY_ID
                                AND (POS(:WK_IMPORTSTATUS,ISSN.ISSN_STATUS,0,1) > -1)
                                GROUP BY ISSN.PROD_ID
                          INTO :WK_AVAILABLE_QTY;
                       END
                    END
                 END
                 ELSE
                 BEGIN
                    /* use products in this size type */
                    IF (WK_PO_WH_ID = 'ALL') THEN
                    BEGIN
                       /* allow all wh_id */
                       IF (WK_PO_COMPANY_ID = 'ALL') THEN
                       BEGIN
                          /* allow all wh_id and all company_id */
                          SELECT SUM( ISSN.CURRENT_QTY ) 
                                FROM PROD_PROFILE
                                JOIN ISSN ON ISSN.PROD_ID = PROD_PROFILE.PROD_ID
                                WHERE PROD_PROFILE.SIZE_TYPE  = :WK_PROD_SIZE_TYPE
                                AND (POS(:WK_IMPORTSTATUS,ISSN.ISSN_STATUS,0,1) > -1)
                                GROUP BY PROD_PROFILE.SIZE_TYPE
                          INTO :WK_AVAILABLE_QTY;
                       END
                       ELSE
                       BEGIN
                          /* allow all wh_id and required company_id */
                          SELECT SUM( ISSN.CURRENT_QTY ) 
                                FROM PROD_PROFILE
                                JOIN ISSN ON ISSN.PROD_ID = PROD_PROFILE.PROD_ID
                                WHERE PROD_PROFILE.SIZE_TYPE  = :WK_PROD_SIZE_TYPE
                                AND ISSN.COMPANY_ID = :WK_PO_COMPANY_ID
                                AND (POS(:WK_IMPORTSTATUS,ISSN.ISSN_STATUS,0,1) > -1)
                                GROUP BY PROD_PROFILE.SIZE_TYPE
                          INTO :WK_AVAILABLE_QTY;
                       END
                    END
                    ELSE
                    BEGIN
                       /* only required wh_id */
                       IF (WK_PO_COMPANY_ID = 'ALL') THEN
                       BEGIN
                          /* only required wh_id and  all company_id */
                          SELECT SUM( ISSN.CURRENT_QTY ) 
                                FROM PROD_PROFILE
                                JOIN ISSN ON ISSN.PROD_ID = PROD_PROFILE.PROD_ID
                                WHERE PROD_PROFILE.SIZE_TYPE  = :WK_PROD_SIZE_TYPE
                                AND ISSN.WH_ID = :WK_PO_WH_ID
                                AND (POS(:WK_IMPORTSTATUS,ISSN.ISSN_STATUS,0,1) > -1)
                                GROUP BY PROD_PROFILE.SIZE_TYPE
                          INTO :WK_AVAILABLE_QTY;
                       END
                       ELSE
                       BEGIN
                          /* only required wh_id and  required company_id */
                          SELECT SUM( ISSN.CURRENT_QTY ) 
                                FROM PROD_PROFILE
                                JOIN ISSN ON ISSN.PROD_ID = PROD_PROFILE.PROD_ID
                                WHERE PROD_PROFILE.SIZE_TYPE  = :WK_PROD_SIZE_TYPE
                                AND ISSN.WH_ID = :WK_PO_WH_ID
                                AND ISSN.COMPANY_ID = :WK_PO_COMPANY_ID
                                AND (POS(:WK_IMPORTSTATUS,ISSN.ISSN_STATUS,0,1) > -1)
                                GROUP BY PROD_PROFILE.SIZE_TYPE
                          INTO :WK_AVAILABLE_QTY;
                       END
                    END
                 END
                 IF (WK_AVAILABLE_QTY IS NULL) THEN
                 BEGIN
                    WK_AVAILABLE_QTY = 0;
                 END
                 /* now must get qty allocated on order not picked */
                 WK_PICKED_QTY = 0;
                 WK_ORDER_QTY = 0;
                 IF (WK_PROD_SIZE_TYPE = '') THEN
                 BEGIN
                    /* use only this product */
                    SELECT SUM( PICK_ITEM.PICK_ORDER_QTY ), 
                           SUM( PICK_ITEM.PICKED_QTY ) 
                            FROM PICK_ITEM
                            WHERE PICK_ITEM.PROD_ID = :WK_WORK_PROD
                            AND ('AL' = PICK_ITEM.PICK_LINE_STATUS)
                            GROUP BY PICK_ITEM.PROD_ID
                         INTO :WK_ORDER_QTY, :WK_PICKED_QTY;
                 END
                 ELSE
                 BEGIN
                    /* use products in this size type */
                    SELECT SUM( PICK_ITEM.PICK_ORDER_QTY ), 
                           SUM( PICK_ITEM.PICKED_QTY ) 
                            FROM PROD_PROFILE
                            JOIN PICK_ITEM ON PICK_ITEM.PROD_ID = PROD_PROFILE.PROD_ID
                            WHERE PROD_PROFILE.SIZE_TYPE  = :WK_PROD_SIZE_TYPE
                            AND ('AL' = PICK_ITEM.PICK_LINE_STATUS)
                            GROUP BY PROD_PROFILE.SIZE_TYPE
                         INTO :WK_ORDER_QTY, :WK_PICKED_QTY;
                 END
                 IF (WK_ORDER_QTY IS NULL) THEN
                 BEGIN
                    WK_ORDER_QTY = 0;
                 END
                 IF (WK_PICKED_QTY IS NULL) THEN
                 BEGIN
                    WK_PICKED_QTY = 0;
                 END
                 WK_ALLOC_ORDER_QTY = WK_ORDER_QTY - WK_PICKED_QTY;
                 WK_AVAILABLE_QTY = WK_AVAILABLE_QTY - WK_ALLOC_ORDER_QTY;
                 IF (WK_AVAILABLE_QTY < WK_WORK_TOPICK_QTY ) THEN
                 BEGIN
                    IF (LEN(WK_PROD_OK) < 53) THEN
                    BEGIN
                       WK_PROD_OK = WK_PROD_OK || ' ' || WK_WORK_PROD;
                    END
                    /* IF (WK_HELD_STATUS = 'HD') THEN */
                    /* IF ((WK_HELD_STATUS = 'HD') OR (WK_HELD_STATUS = 'CN')) THEN */
                    IF ((WK_HELD_STATUS = 'HD') OR (WK_HELD_STATUS = 'CN') OR (WK_HELD_STATUS = 'AS')) THEN
                    BEGIN
                       UPDATE PICK_ITEM 
                       SET PICK_LINE_STATUS = :WK_HELD_STATUS,
                       REASON = 'NOT ENOUGH STOCK'
                       WHERE PROD_ID = :WK_WORK_PROD
                       AND PICK_ORDER = :WK_ORDER
                       AND PICK_LINE_STATUS IN ('OP','UP');
                    END
                    ELSE
                    BEGIN
                       UPDATE PICK_ITEM 
                       SET REASON = 'NOT ENOUGH STOCK'
                       WHERE PROD_ID = :WK_WORK_PROD
                       AND PICK_ORDER = :WK_ORDER
                       AND PICK_LINE_STATUS IN ('OP','UP');
                    END
                 END
              END /* end of for */
              BEGIN
                 IF (WK_PROD_OK <> '') THEN
                 BEGIN
                    UPDATE PICK_ORDER SET PICK_PRIORITY = :WK_MOVE_PRIORITY 
                    WHERE PICK_ORDER = :WK_ORDER;
                 END
                 WK_FOUND = 0;
                 SELECT FIRST 1 1
                 FROM PICK_ITEM
                 WHERE PICK_ORDER = :WK_ORDER
                 AND PICK_LINE_STATUS IN ('OP','UP')
                 AND (PROD_ID IS NOT NULL)
                 INTO :WK_FOUND;
                 IF (WK_FOUND = 1) THEN
                 BEGIN
                    /* ok we can allocate this */
                    UPDATE PICK_ITEM 
                       SET USER_ID = :WK_WHO_FOR, 
                           DEVICE_ID = NULL, 
                           PICK_LINE_STATUS = 'CN' 
                        WHERE PICK_ORDER = :WK_ORDER
                        AND PICK_LINE_STATUS IN ('OP','UP')
                        AND PICK_ORDER_QTY = 0
                        AND (PROD_ID IS NOT NULL);
                    UPDATE PICK_ITEM 
                       SET USER_ID = :WK_WHO_FOR, 
                           DEVICE_ID = :WK_DEVICE,
                           PICK_LINE_STATUS = 'AL', 
                           PICK_STARTED = 'NOW'
                        WHERE PICK_ORDER = :WK_ORDER
                        AND PICK_LINE_STATUS IN ('OP','UP')
                        AND (PROD_ID IS NOT NULL);
                    /*     PICK_STATUS = 'PG' */ 
                    UPDATE PICK_ORDER
                       SET PICK_STARTED = 'NOW'
                        WHERE PICK_ORDER = :WK_ORDER
                        AND PICK_STARTED IS NULL;
                 END
                 ELSE
                 BEGIN
                    /* no lines left to allocate */
/*           UPDATE PICK_ORDER SET PICK_PRIORITY = :WK_MOVE_PRIORITY,PICK_STATUS = 'HD'
             WHERE PICK_ORDER = :WK_ORDER; */
                 END
              END
           END /* end of product lines for order and OP or DA order status */
           IF ((WK_ORDER_STATUS = 'OP' OR WK_ORDER_STATUS = 'DA') AND (WK_PI_TYPE = 'I')) THEN
           BEGIN
              WK_WORK_PROD = '';
              WK_WORK_ORDER_QTY = 0;
              WK_WORK_PICKED_QTY = 0;
              FOR SELECT SSN_ID, 
                   PICK_ITEM.PICK_ORDER_QTY , 
                   PICK_ITEM.PICKED_QTY,
                   PICK_ITEM.PICK_LABEL_NO 
                  FROM PICK_ITEM
                  WHERE PICK_ORDER = :WK_ORDER
                  AND PICK_LINE_STATUS IN ('OP','UP')
                  AND (SSN_ID IS NOT NULL)
                  INTO :WK_WORK_PROD, :WK_WORK_ORDER_QTY, :WK_WORK_PICKED_QTY, :WK_WORK_LABEL
              DO
              BEGIN
                 IF (WK_WORK_ORDER_QTY IS NULL) THEN
                 BEGIN
                    WK_WORK_ORDER_QTY = 0;
                 END
                 IF (WK_WORK_PICKED_QTY IS NULL) THEN
                 BEGIN
                    WK_WORK_PICKED_QTY = 0;
                 END
                 /* order is already confirmed */
                 IF (WK_WORK_ORDER_QTY <= 0) THEN
                 BEGIN
                    UPDATE PICK_ITEM 
                       SET USER_ID = :WK_WHO_FOR, 
                           DEVICE_ID = NULL, 
                           PICK_LINE_STATUS = 'CN' 
                        WHERE PICK_LABEL_NO  = :WK_WORK_LABEL;
                 END
                 ELSE
                 BEGIN
                    UPDATE PICK_ITEM 
                       SET USER_ID = :WK_WHO_FOR, 
                           DEVICE_ID = :WK_DEVICE,
                           PICK_LINE_STATUS = 'AL', 
                           PICK_STARTED = 'NOW'
                        WHERE PICK_LABEL_NO  = :WK_WORK_LABEL;
                 END
                    UPDATE PICK_ORDER
                       SET PICK_STARTED = 'NOW'
                        WHERE PICK_ORDER = :WK_ORDER
                        AND PICK_STARTED IS NULL;
              END
           END
        END
        EXECUTE PROCEDURE UPDATE_TRAN (WK_RECORD, 'T','Processed successfully');
        /* EXECUTE PROCEDURE TRAN_ARCHIVE; */

     END /* code K or  L */
  END /* PKAL */
 END /* autorun */
END ^

CREATE TRIGGER RUN_TRANSACTION_PKUA FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 50 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_DEVICE CHAR(2);
DECLARE VARIABLE WK_USER VARCHAR(10);
DECLARE VARIABLE WK_RECORD INTEGER;
DECLARE VARIABLE WK_PI_LABEL VARCHAR(7);
DECLARE VARIABLE WK_PI_SSN VARCHAR(20);
DECLARE VARIABLE WK_PI_PROD VARCHAR(30);
DECLARE VARIABLE WK_PI_ORDER VARCHAR(15);
DECLARE VARIABLE WK_PI_WH CHAR(2);
DECLARE VARIABLE WK_PI_LOCN VARCHAR(10);
DECLARE VARIABLE WK_PI_LASTLOCN VARCHAR(10);
DECLARE VARIABLE WK_PI_DESP_LOCN VARCHAR(10);
DECLARE VARIABLE WK_PI_QTY INTEGER;
DECLARE VARIABLE WK_PI_STATUS CHAR(2);
DECLARE VARIABLE WK_IS_STATUS CHAR(2);
DECLARE VARIABLE WK_DIRECTORY VARCHAR(80);
DECLARE VARIABLE WK_FILENAME VARCHAR(80);
DECLARE VARIABLE WK_LABEL_LINE VARCHAR(200);
DECLARE VARIABLE WK_RESULT INTEGER;
DECLARE VARIABLE WK_PROD_SSN VARCHAR(20);
DECLARE VARIABLE WK_DO_PKUA CHAR(1);
DECLARE VARIABLE WK_PI_OVER_SIZED CHAR(1);
DECLARE VARIABLE WK_LI_LOCN_SEQ DECIMAL(7,3);
DECLARE VARIABLE WK_LOG VARCHAR(100);
DECLARE VARIABLE WK_DATE VARCHAR(30);
DECLARE VARIABLE WK_SESS_LAST_LOCN VARCHAR(10);
DECLARE VARIABLE WK_SESS_LAST_LOCN_SEQ DECIMAL(7,3);
DECLARE VARIABLE WK_SESS_WH_ID VARCHAR(2);
DECLARE VARIABLE WK_SESS_LOCN_ID VARCHAR(10);
DECLARE VARIABLE WK_PROD_SIZE_TYPE VARCHAR(40);
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'PKUA') THEN
  BEGIN
     WK_DEVICE = NEW.WH_ID;
     WK_USER = NEW.PERSON_ID;
     WK_RECORD = NEW.RECORD_ID;
     /*
         This transaction updates the pick_item to the 
         current location for the 1st issn possible
     */

/*
     WK_DIRECTORY = '';
     SELECT FTP_DIRECTORY 
         FROM CONTROL
         INTO :WK_DIRECTORY ;
      WK_FILENAME = WK_DIRECTORY || WK_DEVICE || '.pk';
*/
      /* clear devices file */
 /*     WK_RESULT = FILE_DELETE(WK_FILENAME); */
   /*
    no change to pick_location
         WK_RESULT = FILE_WRITELN(WK_FILENAME, 'DELETE FROM PICK_LOCATIONS'); 
   */
   /*               WHERE PICK_LINE_STATUS IN ('AL', 'PG', 'PL') */
      FOR 
         SELECT PICK_LABEL_NO, 
                PROD_ID,
                SSN_ID,
                PICK_LINE_STATUS,
                DESPATCH_LOCATION,
                PICK_ORDER,
                OVER_SIZED
                FROM PICK_ITEM
                WHERE PICK_LINE_STATUS IN ('AL', 'PG' )
                  AND DEVICE_ID = :WK_DEVICE
                INTO :WK_PI_LABEL, :WK_PI_PROD, :WK_PI_SSN, :WK_PI_STATUS, :WK_PI_DESP_LOCN, :WK_PI_ORDER,:WK_PI_OVER_SIZED
      DO
      BEGIN
           /* check whether order allows pkua */
         WK_DO_PKUA = 'U';
         SELECT OPTIONS.DESCRIPTION
           FROM PICK_ORDER 
           JOIN OPTIONS ON OPTIONS.GROUP_CODE = 'CMPPKUA'
           AND OPTIONS.CODE = (PICK_ORDER.COMPANY_ID || '|' || PICK_ORDER.P_COUNTRY)
           WHERE PICK_ORDER.PICK_ORDER = :WK_PI_ORDER
           INTO :WK_DO_PKUA;
         IF (WK_DO_PKUA IS NULL) THEN
         BEGIN
            WK_DO_PKUA = 'U';
         END
         IF ((WK_DO_PKUA = 'T' AND WK_PI_OVER_SIZED = 'T')
             OR (WK_DO_PKUA = 'U')) THEN
         BEGIN
   /*
    must get
                  WH_ID,
                  LOCN_ID,
                  QTY_AVAIL,
                  ISSN_STATUS
   */
           WK_PI_WH = '';
           WK_PI_LOCN = '';
           WK_PI_LASTLOCN = '';
           WK_PI_QTY = 0;
           /* WK_PI_STATUS = ''; */
           IF (WK_PI_SSN IS NULL) THEN
           BEGIN
              /* a product */
              WK_SESS_LAST_LOCN = '';
              SELECT DESCRIPTION FROM SESSION 
              WHERE DEVICE_ID = :WK_DEVICE
              AND   CODE = 'picklocation'
              INTO :WK_SESS_LAST_LOCN;
              IF (WK_SESS_LAST_LOCN IS NULL) THEN
              BEGIN
                 WK_SESS_LAST_LOCN = '';
              END
              WK_PROD_SIZE_TYPE = '';
              SELECT SIZE_TYPE
              FROM PROD_PROFILE
              WHERE PROD_ID = :WK_PI_PROD 
              INTO :WK_PROD_SIZE_TYPE;
              IF (WK_PROD_SIZE_TYPE IS NULL) THEN
              BEGIN
                 WK_PROD_SIZE_TYPE = '';
              END
              IF (WK_SESS_LAST_LOCN > '') THEN
              BEGIN
                 WK_SESS_LAST_LOCN_SEQ = 0;
                 WK_SESS_WH_ID = SUBSTR(WK_SESS_LAST_LOCN,1,2);
                 WK_SESS_LOCN_ID = SUBSTR(WK_SESS_LAST_LOCN,3,10);
                 SELECT LOCN_SEQ FROM LOCATION 
                 WHERE WH_ID  = :WK_SESS_WH_ID
                 AND LOCN_ID = :WK_SESS_LOCN_ID
                 INTO :WK_SESS_LAST_LOCN_SEQ;
                 IF (WK_SESS_LAST_LOCN_SEQ IS NULL) THEN
                 BEGIN
                    WK_SESS_LAST_LOCN_SEQ = 0;
                 END
                 IF (WK_PROD_SIZE_TYPE = '') THEN
                 BEGIN
                    /* use only this product */
                    FOR
                       SELECT FIRST 1 ISSN.WH_ID, ISSN.LOCN_ID, ISSN.CURRENT_QTY, ISSN.ISSN_STATUS, ISSN.SSN_ID, LOCATION.LOCN_SEQ 
                       FROM ISSN 
                       LEFT OUTER JOIN LOCATION ON LOCATION.WH_ID = ISSN.WH_ID AND LOCATION.LOCN_ID = ISSN.LOCN_ID
                       WHERE ISSN.PROD_ID = :WK_PI_PROD 
                         AND (ISSN.WH_ID < 'X' OR ISSN.WH_ID >'X~') AND ISSN.ISSN_STATUS IN ('RS','AL','ST','PA')
                         AND LOCATION.LOCN_SEQ >= :WK_SESS_LAST_LOCN_SEQ
                       ORDER BY LOCATION.LOCN_SEQ, ISSN.WH_ID, ISSN.LOCN_ID 
                       INTO :WK_PI_WH, :WK_PI_LOCN, :WK_PI_QTY, :WK_IS_STATUS, :WK_PROD_SSN, :WK_LI_LOCN_SEQ 
                    DO
                    BEGIN
                       /* update status */
                       IF (WK_PI_LASTLOCN = '') THEN
                       BEGIN
                          UPDATE PICK_ITEM SET PICK_LOCATION = :WK_PI_LOCN, 
                             WH_ID = :WK_PI_WH,
                             PICK_LOCN_SEQ = :WK_LI_LOCN_SEQ 
                          WHERE PICK_LABEL_NO = :WK_PI_LABEL; 
                          WK_PI_LASTLOCN = WK_PI_LOCN;
                       END
                    END
                 END
                 ELSE
                 BEGIN
                    /* use the products from this size_type */
                    FOR
                       SELECT FIRST 1 ISSN.WH_ID, ISSN.LOCN_ID, ISSN.CURRENT_QTY, ISSN.ISSN_STATUS, ISSN.SSN_ID, LOCATION.LOCN_SEQ 
                       FROM ISSN 
                       LEFT OUTER JOIN LOCATION ON LOCATION.WH_ID = ISSN.WH_ID AND LOCATION.LOCN_ID = ISSN.LOCN_ID
                       WHERE ISSN.PROD_ID IN (SELECT PROD_ID FROM PROD_PROFILE WHERE SIZE_TYPE = :WK_PROD_SIZE_TYPE) 
                         AND (ISSN.WH_ID < 'X' OR ISSN.WH_ID >'X~') AND ISSN.ISSN_STATUS IN ('RS','AL','ST','PA')
                         AND LOCATION.LOCN_SEQ >= :WK_SESS_LAST_LOCN_SEQ
                       ORDER BY LOCATION.LOCN_SEQ, ISSN.WH_ID, ISSN.LOCN_ID 
                       INTO :WK_PI_WH, :WK_PI_LOCN, :WK_PI_QTY, :WK_IS_STATUS, :WK_PROD_SSN, :WK_LI_LOCN_SEQ 
                    DO
                    BEGIN
                       /* update status */
                       IF (WK_PI_LASTLOCN = '') THEN
                       BEGIN
                          UPDATE PICK_ITEM SET PICK_LOCATION = :WK_PI_LOCN, 
                             WH_ID = :WK_PI_WH,
                             PICK_LOCN_SEQ = :WK_LI_LOCN_SEQ 
                          WHERE PICK_LABEL_NO = :WK_PI_LABEL; 
                          WK_PI_LASTLOCN = WK_PI_LOCN;
                       END
                    END
                 END
              END
              IF (WK_PI_LASTLOCN = '') THEN
              BEGIN
                /* none found so try prev method */
                 WK_SESS_LAST_LOCN_SEQ = 999999;
                 FOR
                 SELECT FIRST 1 ISSN.WH_ID, ISSN.LOCN_ID, ISSN.CURRENT_QTY, ISSN.ISSN_STATUS, ISSN.SSN_ID, LOCATION.LOCN_SEQ 
                 FROM ISSN 
                 LEFT OUTER JOIN LOCATION ON LOCATION.WH_ID = ISSN.WH_ID AND LOCATION.LOCN_ID = ISSN.LOCN_ID
                 WHERE ISSN.PROD_ID = :WK_PI_PROD 
                   AND (ISSN.WH_ID < 'X' OR ISSN.WH_ID >'X~') AND ISSN.ISSN_STATUS IN ('RS','AL','ST','PA')
                   AND LOCATION.LOCN_SEQ <= :WK_SESS_LAST_LOCN_SEQ
                 ORDER BY LOCATION.LOCN_SEQ DESC, ISSN.WH_ID, ISSN.LOCN_ID 
                 INTO :WK_PI_WH, :WK_PI_LOCN, :WK_PI_QTY, :WK_IS_STATUS, :WK_PROD_SSN, :WK_LI_LOCN_SEQ 
                 DO
                 BEGIN
                    /* update status */
                    IF (WK_PI_LASTLOCN = '') THEN
                    BEGIN
                       UPDATE PICK_ITEM SET PICK_LOCATION = :WK_PI_LOCN, 
                          WH_ID = :WK_PI_WH,
                          PICK_LOCN_SEQ = :WK_LI_LOCN_SEQ 
                       WHERE PICK_LABEL_NO = :WK_PI_LABEL; 
                       WK_PI_LASTLOCN = WK_PI_LOCN;
                    END
   /*
    no change to pick_location
                 -* add to devices file *-
                 WK_LABEL_LINE = 'INSERT INTO PICK_LOCATIONS (PICK_LABEL_NO, PROD_ID , SSN_ID , WH_ID , LOCN_ID , QTY_AVAILABLE , ISSN_STATUS )  VALUES (' ||
                   SQUOTEDSTR(WK_PI_LABEL ) || ',' ||
                   SQUOTEDSTR(WK_PI_PROD ) || ',' ||
                   SQUOTEDSTR(WK_PROD_SSN ) || ',' ||
                   SQUOTEDSTR(WK_PI_WH ) || ',' ||
                   SQUOTEDSTR(WK_PI_LOCN ) || ',' ||
                   SQUOTEDSTR(ALLTRIM(CAST(WK_PI_QTY AS CHAR(6)))) || ',' ||
                   SQUOTEDSTR(WK_IS_STATUS ) || ')';
                 WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE);
   */
                 END
              END
           END
           ELSE
           BEGIN
              /* an ssn */
                 /* update status */
              UPDATE ISSN SET ISSN_STATUS = :WK_PI_STATUS WHERE SSN_ID = :WK_PI_SSN;
              SELECT ISSN.WH_ID, ISSN.LOCN_ID, ISSN.CURRENT_QTY  
              FROM ISSN 
              WHERE ISSN.SSN_ID = :WK_PI_SSN 
              INTO :WK_PI_WH, :WK_PI_LOCN, :WK_PI_QTY ;
              UPDATE PICK_ITEM SET PICK_LOCATION = :WK_PI_LOCN 
              WHERE PICK_LABEL_NO = :WK_PI_LABEL; 
   /*
    no change to pick_location
              -* add to devices file *-
              WK_LABEL_LINE = 'INSERT INTO PICK_LOCATIONS (PICK_LABEL_NO, PROD_ID , SSN_ID , WH_ID , LOCN_ID , QTY_AVAILABLE , ISSN_STATUS )  VALUES (' ||
                SQUOTEDSTR(WK_PI_LABEL ) || ',' ||
                SQUOTEDSTR(WK_PI_PROD ) || ',' ||
                SQUOTEDSTR(WK_PI_SSN ) || ',' ||
                SQUOTEDSTR(WK_PI_WH ) || ',' ||
                SQUOTEDSTR(WK_PI_LOCN ) || ',' ||
                SQUOTEDSTR(ALLTRIM(CAST(WK_PI_QTY AS CHAR(6)))) || ',' ||
                SQUOTEDSTR(WK_PI_STATUS ) || ')';
              WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE);
   */
           END
           /* add to devices file */
/*`
           WK_LABEL_LINE = 'UPDATE PICK_QTYS SET PICK_LINE_STATUS = ' ||
                   SQUOTEDSTR(WK_PI_STATUS) || ' , DESPATCH_LOCATION = ' ||
                   SQUOTEDSTR(WK_PI_DESP_LOCN) || ' WHERE PICK_LABEL_NO = ' ||
                   SQUOTEDSTR(WK_PI_LABEL );
           WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE);
*/
        END
     END
     /* WK_DATE = CAST(CAST("NOW" AS TIMESTAMP) AS VARCHAR(24)); */

   EXECUTE PROCEDURE UPDATE_TRAN (WK_RECORD, 'T','Processed successfully');
   /* EXECUTE PROCEDURE TRAN_ARCHIVE; */
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_ISIL FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 51 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_DEVICE CHAR(2);
DECLARE VARIABLE WK_USER VARCHAR(10);
DECLARE VARIABLE WK_RECORD INTEGER;
DECLARE VARIABLE WK_ISSUE_TO VARCHAR(10);
DECLARE VARIABLE WK_WH_ID CHAR(2);
DECLARE VARIABLE WK_LOCN_ID VARCHAR(10);
DECLARE VARIABLE WK_PRODUCT VARCHAR(30);
DECLARE VARIABLE WK_CHARGE_TO VARCHAR(40);
DECLARE VARIABLE WK_QTY INTEGER;
DECLARE VARIABLE WK_TRN_TYPE VARCHAR(4);
DECLARE VARIABLE WK_TRN_CODE CHAR(1);
DECLARE VARIABLE WK_AUDIT_DESC VARCHAR(40);
DECLARE VARIABLE WK_DATE TIMESTAMP;
DECLARE VARIABLE WK_SO_ID VARCHAR(10);

DECLARE VARIABLE WK_PICK_LABEL_NO CHAR(8);
DECLARE VARIABLE WK_PICK_LABEL_START INTEGER;
DECLARE VARIABLE WK_PICK_LABEL_STOP INTEGER;
DECLARE VARIABLE WK_PICK_LABEL_PREFIX INTEGER;
DECLARE VARIABLE WK_LEN_LABEL_NO INTEGER;
DECLARE VARIABLE WK_LABEL_LENGTH INTEGER;
DECLARE VARIABLE WK_PICK_ADJUSTMENT INTEGER;
DECLARE VARIABLE WK_L_PICK_LABEL_NO  VARCHAR(7);
DECLARE VARIABLE WK_QTY_TOGET INTEGER;
DECLARE VARIABLE WK_SSN_QTY INTEGER;
DECLARE VARIABLE WK_SSN_ID VARCHAR(30);
DECLARE VARIABLE WK_REASON VARCHAR(40);
DECLARE VARIABLE iSSN_LENGTH INTEGER;
DECLARE VARIABLE iSSN_ID INTEGER;
DECLARE VARIABLE I_SSN_ID VARCHAR(20);
DECLARE VARIABLE I_LEN_SSN_ID INTEGER;
DECLARE VARIABLE LEN_SSN_ID INTEGER;
DECLARE VARIABLE P_SSN_ID INTEGER;
DECLARE VARIABLE WK_PARENT_SSN_ID VARCHAR(30);
DECLARE VARIABLE WK_SAVE_SSN_ID VARCHAR(30);
DECLARE VARIABLE WK_SAVE_PARENT_SSN_ID VARCHAR(30);

BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'ISIL') THEN
  BEGIN
     WK_DEVICE = NEW.DEVICE_ID;
     WK_ISSUE_TO = NEW.SUB_LOCN_ID;
     WK_WH_ID = NEW.WH_ID;
     WK_LOCN_ID = NEW.LOCN_ID;
     WK_USER = NEW.PERSON_ID;
     WK_PRODUCT = NEW.OBJECT;
     WK_CHARGE_TO = NEW.REFERENCE;
     WK_QTY = NEW.QTY;
     WK_DATE = NEW.TRN_DATE;
     WK_RECORD = NEW.RECORD_ID;
     WK_TRN_CODE = NEW.TRN_CODE;
     WK_TRN_TYPE = NEW.TRN_TYPE;
     WK_SAVE_SSN_ID = 'SAVE';
     WK_SAVE_PARENT_SSN_ID = 'SAVE';

     WK_AUDIT_DESC = 'Issued to Device ' || :WK_DEVICE ;
/*
     get order for pick_order
     create order
     get label no for pick_item
     create pick_item

     set qtytoget
     for issn in location for product status PA or ST
     {
          if current_qty > qtytoget
                split the issn so that we take the qtytoget
                and create a pick_item_detail for it
                and change the status to 'DX' and put in the XD repository
                set the qtytoget to 0
          else
                take all current_qty
                create a pick_item_detail
                change status to 'DX' and put in the 'XD' respository
                reduce the qtytoget by the current_qty
          if (qtytoget is zero)
               break
     }
as at 29/02/04 reduce qty in ssn and issn (store into prev qty)
*/

     EXECUTE PROCEDURE  GET_SALE_ORDER_NO 'I'
             RETURNING_VALUES :WK_SO_ID;

     INSERT INTO PICK_ORDER (PICK_ORDER, PICK_ORDER_TYPE, PERSON_ID, COST_CENTER, PICK_DUE_DATE, CREATE_DATE, CREATED_BY, PICK_STARTED, PICK_STATUS) 
            VALUES (:WK_SO_ID,'IS',:WK_ISSUE_TO,:WK_CHARGE_TO,:WK_DATE,:WK_DATE,:WK_USER,:WK_DATE,'DX');


     /* Get length for label */   
     SELECT MAX_LENGTH
     FROM PARAM
     WHERE DATA_ID = 'PICK'
     INTO :WK_LABEL_LENGTH;
     WK_PICK_LABEL_NO = GEN_ID(PICK_LABEL_GEN, 1);
     WK_PICK_LABEL_START = GEN_ID(PICK_LABEL_START, 0);
     WK_PICK_LABEL_STOP = GEN_ID(PICK_LABEL_STOP, 0);
     WK_PICK_LABEL_PREFIX = GEN_ID(PICK_LABEL_PREFIX , 0);
     IF (WK_PICK_LABEL_NO > WK_PICK_LABEL_STOP) THEN
     BEGIN
        WK_PICK_ADJUSTMENT = WK_PICK_LABEL_START - WK_PICK_LABEL_STOP;
        WK_PICK_LABEL_NO = GEN_ID(PICK_LABEL_GEN, WK_PICK_ADJUSTMENT);
        WK_PICK_LABEL_PREFIX = GEN_ID(PICK_LABEL_PREFIX , 1);
        WK_PICK_LABEL_NO = WK_PICK_LABEL_START;
     END
     WK_LEN_LABEL_NO = STRLEN(ALLTRIM(WK_PICK_LABEL_NO)) + 1;     
     /* Get Label prefix */      
     WK_L_PICK_LABEL_NO = chr(WK_PICK_LABEL_PREFIX);
     /* Padding leading with 0 */
     WHILE (WK_LEN_LABEL_NO < WK_LABEL_LENGTH) DO
     BEGIN
        WK_L_PICK_LABEL_NO = WK_L_PICK_LABEL_NO || '0';      
        WK_LEN_LABEL_NO = WK_LEN_LABEL_NO + 1;
     END
     WK_L_PICK_LABEL_NO = WK_L_PICK_LABEL_NO || ALLTRIM(WK_PICK_LABEL_NO);

     INSERT INTO PICK_ITEM(PICK_LABEL_NO,PICK_ORDER,PROD_ID,PICK_ORDER_QTY,PICKED_QTY,CREATE_DATE,USER_ID,DEVICE_ID,PICK_LINE_STATUS,WH_ID,PICK_LOCATION) 
            VALUES (:WK_L_PICK_LABEL_NO,:WK_SO_ID,:WK_PRODUCT,:WK_QTY,:WK_QTY,:WK_DATE,:WK_USER,:WK_DEVICE,'DX',:WK_WH_ID,:WK_LOCN_ID);

     WK_QTY_TOGET = WK_QTY;
/*     FOR SELECT SSN_ID, CURRENT_QTY */
     FOR SELECT SSN_ID, CURRENT_QTY, ORIGINAL_SSN
         FROM ISSN
         WHERE WH_ID = :WK_WH_ID
           AND LOCN_ID = :WK_LOCN_ID
           AND PROD_ID = :WK_PRODUCT
           AND ISSN_STATUS IN ('PA','ST')
/*          INTO :WK_SSN_ID, :WK_SSN_QTY */
          INTO :WK_SSN_ID, :WK_SSN_QTY, :WK_PARENT_SSN_ID
     DO
     BEGIN
        WK_SAVE_SSN_ID = WK_SSN_ID;
        WK_SAVE_PARENT_SSN_ID = WK_PARENT_SSN_ID;
        IF (WK_QTY_TOGET > 0) THEN
        BEGIN
           IF (WK_SSN_QTY > WK_QTY_TOGET) THEN
           BEGIN
              /*  SPlit it */
              /* Get length for Barcode */   
              EXECUTE PROCEDURE GET_BARCODE_LENGTH RETURNING_VALUES iSSN_LENGTH;
              iSSN_ID = GEN_ID(ISSN_SSN_ID, 1);
              P_SSN_ID = iSSN_ID - 1;
              LEN_SSN_ID = STRLEN(P_SSN_ID);
              I_SSN_ID = '';
              I_LEN_SSN_ID = STRLEN(P_SSN_ID);
                 
              /* Padding leading with 0 */
              WHILE (I_LEN_SSN_ID < :iSSN_LENGTH) DO
              BEGIN
                 I_SSN_ID = I_SSN_ID || '0';
                 I_LEN_SSN_ID = I_LEN_SSN_ID + 1;
              END
              I_SSN_ID = I_SSN_ID || P_SSN_ID;
                 
              EXECUTE PROCEDURE PC_TRSS 
              :WK_RECORD ,
              :WK_WH_ID,
              :WK_LOCN_ID,
              :WK_SSN_ID,
              'TRSS',
              'A',
              :WK_DATE,
              :I_SSN_ID,
              :WK_QTY_TOGET,
              :WK_USER,
              :WK_DEVICE;
              /* take all this of the split issn */
              UPDATE ISSN SET ISSN_STATUS = 'DX',
                  PREV_PREV_WH_ID = PREV_WH_ID,
                  PREV_PREV_LOCN_ID = PREV_LOCN_ID,
                  PREV_WH_ID = WH_ID,
                  PREV_LOCN_ID = LOCN_ID,
                  WH_ID = 'XD',
                  PREV_QTY = CURRENT_QTY,
                  CURRENT_QTY = 0
               WHERE SSN_ID = :I_SSN_ID;
               UPDATE SSN SET CURRENT_QTY = CURRENT_QTY - :WK_QTY_TOGET
               WHERE SSN_ID = :WK_PARENT_SSN_ID;
               WK_REASON = 'Issued Split ' || :WK_QTY_TOGET || 'to User ' || :WK_USER ;
               EXECUTE PROCEDURE ADD_SSN_HIST('XD', :WK_LOCN_ID, :WK_PARENT_SSN_ID, 
                       :WK_TRN_TYPE, :WK_TRN_CODE, :WK_DATE,
                       :WK_AUDIT_DESC , :WK_REASON, :WK_QTY_TOGET, :WK_USER, :WK_DEVICE); 
               INSERT INTO PICK_ITEM_DETAIL 
                   (PICK_LABEL_NO, 
                    SSN_ID, 
                    PICK_DETAIL_STATUS, 
                    QTY_PICKED,
                    USER_ID, 
                    DEVICE_ID, 
                    CREATE_DATE)
               VALUES (:WK_L_PICK_LABEL_NO, 
                    :I_SSN_ID,
                    'DX',
                    :WK_QTY_TOGET,
                    :WK_USER,
                    :WK_DEVICE,
                    :WK_DATE);
                WK_QTY_TOGET = 0;
           END
           ELSE
           BEGIN
              /* take all this qty */
              UPDATE ISSN SET ISSN_STATUS = 'DX',
                  PREV_PREV_WH_ID = PREV_WH_ID,
                  PREV_PREV_LOCN_ID = PREV_LOCN_ID,
                  PREV_WH_ID = WH_ID,
                  PREV_LOCN_ID = LOCN_ID,
                  WH_ID = 'XD',
                  PREV_QTY = CURRENT_QTY,
                  CURRENT_QTY = 0
               WHERE SSN_ID = :WK_SSN_ID;
               UPDATE SSN SET CURRENT_QTY = CURRENT_QTY - :WK_SSN_QTY
               WHERE SSN_ID = :WK_PARENT_SSN_ID;
               WK_REASON = 'Issued All ' || :WK_QTY || 'to User ' || :WK_USER ;
               EXECUTE PROCEDURE ADD_SSN_HIST('XD', :WK_LOCN_ID, :WK_SSN_ID, 
                       :WK_TRN_TYPE, :WK_TRN_CODE, :WK_DATE,
                       :WK_AUDIT_DESC , :WK_REASON, :WK_QTY, :WK_USER, :WK_DEVICE); 
               INSERT INTO PICK_ITEM_DETAIL 
                   (PICK_LABEL_NO, 
                    SSN_ID, 
                    PICK_DETAIL_STATUS, 
                    QTY_PICKED,
                    USER_ID, 
                    DEVICE_ID, 
                    CREATE_DATE)
               VALUES (:WK_L_PICK_LABEL_NO, 
                    :WK_SSN_ID,
                    'DX',
                    :WK_SSN_QTY,
                    :WK_USER,
                    :WK_DEVICE,
                    :WK_DATE);
                WK_QTY_TOGET = WK_QTY_TOGET - WK_SSN_QTY;
           END
        END
     END

   IF (WK_QTY_TOGET > 0) THEN
   BEGIN
      WK_REASON = 'Still to Issue ' || :WK_QTY_TOGET || ' OF ' || :WK_QTY ;
      EXECUTE PROCEDURE UPDATE_TRAN (WK_RECORD, 'F',:WK_REASON);
      IF (WK_SAVE_SSN_ID <> 'SAVE') THEN
      BEGIN
         UPDATE ISSN SET ISSN_STATUS = 'DX',
                  PREV_QTY = CURRENT_QTY,
                  CURRENT_QTY = CURRENT_QTY - :WK_QTY_TOGET
         WHERE SSN_ID = :WK_SAVE_SSN_ID;
         UPDATE SSN SET CURRENT_QTY = CURRENT_QTY - :WK_QTY_TOGET
             WHERE SSN_ID = :WK_SAVE_PARENT_SSN_ID;
         WK_REASON = 'Issued Negative ' || :WK_QTY_TOGET || 'to User ' || :WK_USER ;
         EXECUTE PROCEDURE ADD_SSN_HIST('XD', :WK_LOCN_ID, :WK_SAVE_PARENT_SSN_ID, 
                       :WK_TRN_TYPE, :WK_TRN_CODE, :WK_DATE,
                       :WK_AUDIT_DESC , :WK_REASON, :WK_QTY_TOGET, :WK_USER, :WK_DEVICE); 
      END
   END
   ELSE
   BEGIN
      EXECUTE PROCEDURE UPDATE_TRAN (WK_RECORD, 'T','Processed successfully');
   END
   EXECUTE PROCEDURE TRAN_ARCHIVE;
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_PKOL FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 51 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_DEVICE CHAR(2);
DECLARE VARIABLE WK_USER VARCHAR(10);
DECLARE VARIABLE WK_RECORD INTEGER;
DECLARE VARIABLE WK_LABEL_NO VARCHAR(10);
DECLARE VARIABLE WK_WH_ID CHAR(2);
DECLARE VARIABLE WK_LOCN_ID VARCHAR(10);
DECLARE VARIABLE WK_OBJECT VARCHAR(30);
DECLARE VARIABLE WK_REASON VARCHAR(40);
DECLARE VARIABLE WK_QTY INTEGER;
DECLARE VARIABLE WK_PID_FOUND INTEGER;
DECLARE VARIABLE WK_PID_QTY INTEGER;
DECLARE VARIABLE WK_PI_STATUS CHAR(2);
DECLARE VARIABLE WK_DETAIL_ID INTEGER;
DECLARE VARIABLE WK_DATE TIMESTAMP;
DECLARE VARIABLE WK_PI_PICKED_QTY INTEGER;
DECLARE VARIABLE WK_PI_ORDER_QTY INTEGER;
DECLARE VARIABLE WK_PI_ORDER VARCHAR(15);
DECLARE VARIABLE WK_IS_QTY INTEGER;
DECLARE VARIABLE iSSN_LENGTH INTEGER;
DECLARE VARIABLE iSSN_ID INTEGER;
DECLARE VARIABLE I_SSN_ID VARCHAR(20);
DECLARE VARIABLE I_LEN_SSN_ID INTEGER;
DECLARE VARIABLE LEN_SSN_ID INTEGER;
DECLARE VARIABLE WK_OLD_SSN_ID VARCHAR(30);
DECLARE VARIABLE P_SSN_ID INTEGER;
DECLARE VARIABLE WK_PID_SSN VARCHAR(20);
DECLARE VARIABLE WK_DEVICE_WH CHAR(2);
DECLARE VARIABLE WK_PI_PICKED_QTY_NULL INTEGER;
DECLARE VARIABLE WK_TRN_TYPE VARCHAR(4);
DECLARE VARIABLE WK_TRN_CODE CHAR(1);
DECLARE VARIABLE WK_AUDIT_DESC VARCHAR(40);

DECLARE VARIABLE WK_PI_SSN_ID VARCHAR(20);
DECLARE VARIABLE WK_PI_PROD_ID VARCHAR(20);
DECLARE VARIABLE WK_PI_WH CHAR(2);
DECLARE VARIABLE WK_QTY_REMAINING INTEGER;
DECLARE VARIABLE WK_PI_LINE_QTY_REMAINING INTEGER;
DECLARE VARIABLE WK_QTY_TO_USE INTEGER;
DECLARE VARIABLE WK_ALLOWED_STATUS VARCHAR(40);
DECLARE VARIABLE WK_IS_SSN VARCHAR(20);
DECLARE VARIABLE WK_IS_QTY_REMAINING INTEGER;
DECLARE VARIABLE WK_USED_SSN VARCHAR(20);
DECLARE VARIABLE WK_IS_USED_QTY INTEGER;
DECLARE VARIABLE WK_LOG VARCHAR(255);
DECLARE VARIABLE WK_DO_UASL CHAR(1);
DECLARE VARIABLE WK_CURRENT_WH_ID CHAR(2);
DECLARE VARIABLE WK_CURRENT_LOCN_ID VARCHAR(10);
DECLARE VARIABLE WK_CURRENT_OTHER2 VARCHAR(50);
DECLARE VARIABLE WK_IS_TAKEN CHAR(1);
DECLARE VARIABLE WK_GENERATE_SSN_METHOD VARCHAR(25);
DECLARE VARIABLE WK_PALLET_NO VARCHAR(3);
DECLARE VARIABLE WK_PALLET_NO_INT INTEGER;
DECLARE VARIABLE WK_SSN_PREFIX VARCHAR(30);
DECLARE VARIABLE WK_ORIGINAL_SSN VARCHAR(20);
DECLARE VARIABLE WK_LAST_SSN VARCHAR(20);
DECLARE VARIABLE WK_LAST2_SSN VARCHAR(20);
DECLARE VARIABLE GRN VARCHAR(10);
DECLARE VARIABLE WK_FILENAME VARCHAR(255);
DECLARE VARIABLE WK_RESULT INTEGER;
DECLARE VARIABLE WK_OWNER VARCHAR(20);
DECLARE VARIABLE WK_OWNER_GRN VARCHAR(10);
DECLARE VARIABLE WK_OWNER_PFX CHAR(2);
DECLARE VARIABLE P_LAST_LINE_NO VARCHAR(10);
DECLARE VARIABLE WK_GRN_TYPE CHAR(2);
DECLARE VARIABLE WK_LOADNO VARCHAR(10);
DECLARE VARIABLE WK_GRN_LOT VARCHAR(30);
DECLARE VARIABLE WK_LAST_LOT_PALLET_NO INTEGER;
DECLARE VARIABLE WK_PO_WH_ID CHAR(2);
DECLARE VARIABLE WK_PO_LOCN_ID VARCHAR(10);
DECLARE VARIABLE WK_PO_COMPANY_ID VARCHAR(20);
DECLARE VARIABLE WK_PO_ORIGINAL_SSN VARCHAR(20);
DECLARE VARIABLE WK_THIS_QTY INTEGER;
DECLARE VARIABLE WK_THIS_REMAIN_QTY INTEGER;
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'PKOL') THEN
  BEGIN
     WK_FILENAME = '/tmp/pkol.log';
     WK_DEVICE = NEW.DEVICE_ID;
     WK_LABEL_NO = NEW.SUB_LOCN_ID;
     WK_WH_ID = NEW.WH_ID;
     WK_LOCN_ID = NEW.LOCN_ID;
     WK_USER = NEW.PERSON_ID;
     WK_OBJECT = NEW.OBJECT;
     WK_REASON = ALLTRIM(NEW.REFERENCE);
     WK_QTY = NEW.QTY;
     WK_DATE = NEW.TRN_DATE;
     WK_RECORD = NEW.RECORD_ID;
     WK_TRN_CODE = NEW.TRN_CODE;
     WK_TRN_TYPE = NEW.TRN_TYPE;

     WK_AUDIT_DESC = 'Picked to Device ' || :WK_DEVICE ;
/*
     get issn for object
     if qty < current_qty
         split issn and use new qty item
     update issn used status and location to device id

     get pick_item_detail for label and ssn
     add/update pick_item_detail
     update pick_item status =PG and qty picked
            if qty_picked = order_qty or reference not ''
            then status = PL
*/
     WK_PI_PICKED_QTY = 0;
     WK_PI_ORDER_QTY = 0;
     WK_PI_ORDER = '';

     IF ((NEW.TRN_CODE = 'I') OR (NEW.TRN_CODE = 'B')) THEN
     BEGIN
        /* standard method for picking by issn */   
        /*
        SELECT PICKED_QTY, PICK_ORDER_QTY  
               FROM PICK_ITEM
               WHERE PICK_LABEL_NO = :WK_LABEL_NO
               INTO :WK_PI_PICKED_QTY, :WK_PI_ORDER_QTY;
        */
        SELECT PICKED_QTY, PICK_ORDER_QTY, PICK_ORDER, PROD_ID, SSN_ID 
               FROM PICK_ITEM
               WHERE PICK_LABEL_NO = :WK_LABEL_NO
               INTO :WK_PI_PICKED_QTY, :WK_PI_ORDER_QTY, :WK_PI_ORDER, :WK_PI_PROD_ID, :WK_PI_SSN_ID;
        WK_PI_PICKED_QTY_NULL = 0;
        /* WK_RESULT = FILE_WRITELN(WK_FILENAME, '1'); */
        SELECT 1
               FROM PICK_ITEM
               WHERE PICK_LABEL_NO = :WK_LABEL_NO
                 AND PICKED_QTY IS NULL
               INTO :WK_PI_PICKED_QTY_NULL;
        /* WK_RESULT = FILE_WRITELN(WK_FILENAME, '2'); */
        IF (WK_PI_PICKED_QTY_NULL = 1) THEN
        BEGIN
           WK_PI_PICKED_QTY = 0;
        END
        WK_PI_STATUS = 'PG';
        IF (WK_REASON <> '') THEN
        BEGIN
           WK_PI_STATUS = 'PL';
        END
        WK_PI_PICKED_QTY = WK_PI_PICKED_QTY + WK_QTY;
        IF (WK_PI_PICKED_QTY >= WK_PI_ORDER_QTY) THEN
        BEGIN
           WK_PI_STATUS = 'PL';
           WK_THIS_REMAIN_QTY = WK_PI_PICKED_QTY - WK_PI_ORDER_QTY ;
           WK_THIS_QTY = WK_QTY - WK_THIS_REMAIN_QTY;
           WK_PI_PICKED_QTY = WK_PI_ORDER_QTY ;
        END
        WK_CURRENT_OTHER2 = '';
        SELECT CURRENT_QTY, WH_ID, LOCN_ID, ORIGINAL_SSN, OTHER2
               FROM ISSN
               WHERE SSN_ID = :WK_OBJECT
               INTO :WK_IS_QTY, :WK_CURRENT_WH_ID, :WK_CURRENT_LOCN_ID, :WK_ORIGINAL_SSN, :WK_CURRENT_OTHER2 ;
        /* WK_RESULT = FILE_WRITELN(WK_FILENAME, '3'); */
        IF (WK_IS_QTY IS NULL) THEN
        BEGIN
           WK_IS_QTY = 0;
        END
        IF (WK_QTY = 0 AND  WK_OBJECT = '') THEN
        BEGIN
        /* WK_RESULT = FILE_WRITELN(WK_FILENAME, 'qty is 0 and object is blank'); */
           /* 
             doing a no stock reason without scanning an issn
             no location
             must create an issn
             get the issn or ssn or product from the pick_item passed in the sub_locn_id
             get the wh_id and company from the pick_order
             then only require the location to create in
             so use 'NEWLABEL'
           */
           SELECT WH_ID, COMPANY_ID
           FROM PICK_ORDER
           WHERE PICK_ORDER = :WK_PI_ORDER
           INTO :WK_PO_WH_ID, :WK_PO_COMPANY_ID;
        /* WK_RESULT = FILE_WRITELN(WK_FILENAME, '4'); */
           IF (WK_PO_WH_ID IS NULL) THEN
           BEGIN
              SELECT DESCRIPTION
              FROM SESSION
              WHERE CODE = 'CURRENT_WH_ID'
              AND  DEVICE_ID = :WK_DEVICE
              INTO :WK_PO_WH_ID;
        /* WK_RESULT = FILE_WRITELN(WK_FILENAME, '5'); */
           END
           IF (WK_PO_COMPANY_ID IS NULL) THEN
           BEGIN
              SELECT COMPANY_ID
              FROM CONTROL
              INTO :WK_PO_COMPANY_ID;
        /* WK_RESULT = FILE_WRITELN(WK_FILENAME, '6'); */
           END
           WK_PO_LOCN_ID = 'NEWLABEL';
           IF (WK_PI_SSN_ID IS NOT NULL) THEN
           BEGIN
              IF (WK_PI_SSN_ID = '') THEN
              BEGIN
                 WK_PI_SSN_ID = NULL;
              END
           END
           IF (WK_PI_PROD_ID IS NOT NULL) THEN
           BEGIN
              IF (WK_PI_PROD_ID = '') THEN
              BEGIN
                 WK_PI_PROD_ID = NULL;
              END
           END
           IF (WK_PI_PROD_ID IS NULL) THEN
           BEGIN
              SELECT FIRST 1  PROD_ID FROM ISSN WHERE SSN_ID = :WK_PI_SSN_ID OR ORIGINAL_SSN = :WK_PI_SSN_ID INTO :WK_PI_PROD_ID;
        /* WK_RESULT = FILE_WRITELN(WK_FILENAME, '7'); */
           END
           IF (WK_PI_SSN_ID IS NOT NULL) THEN
           BEGIN
              SELECT FIRST 1  ORIGINAL_SSN FROM ISSN WHERE SSN_ID = :WK_PI_SSN_ID OR ORIGINAL_SSN = :WK_PI_SSN_ID INTO :WK_PO_ORIGINAL_SSN;
        /* WK_RESULT = FILE_WRITELN(WK_FILENAME, '8'); */
           END
           EXECUTE PROCEDURE ADD_ISSN (:WK_PO_ORIGINAL_SSN ,
              :WK_PO_WH_ID,
              :WK_PO_LOCN_ID,
              '',
              0,
              0,
              :WK_DATE,
              'ST',
              '',
              :WK_DATE,
              :WK_USER ,
              :WK_PI_PROD_ID,
              1);
        /* WK_RESULT = FILE_WRITELN(WK_FILENAME, '9'); */
           SELECT FIRST 1 SSN_ID
           FROM ISSN
           WHERE WH_ID = :WK_PO_WH_ID
           AND LOCN_ID = :WK_PO_LOCN_ID
           AND PROD_ID = :WK_PI_PROD_ID
           AND ISSN_STATUS = 'ST'
           AND CURRENT_QTY = 0
           AND CREATE_DATE = :WK_DATE
           INTO :WK_OBJECT;
        /* WK_RESULT = FILE_WRITELN(WK_FILENAME, '10'); */
           UPDATE ISSN SET COMPANY_ID = :WK_PO_COMPANY_ID WHERE SSN_ID = :WK_OBJECT;
        /* WK_RESULT = FILE_WRITELN(WK_FILENAME, '11'); */
           WK_CURRENT_WH_ID = WK_PO_WH_ID;
           WK_CURRENT_LOCN_ID = WK_PO_LOCN_ID;
        END
        /* WK_RESULT = FILE_WRITELN(WK_FILENAME, 'about to check this qty and is qty '); */
        /* WK_RESULT = FILE_WRITELN(WK_FILENAME, wk_this_qty); */
        /* WK_RESULT = FILE_WRITELN(WK_FILENAME, wk_is_qty); */
        /* want to use wk_this_qty */
        /* IF (WK_QTY < WK_IS_QTY) THEN */
        IF (WK_THIS_QTY < WK_IS_QTY) THEN
        BEGIN
        /* WK_RESULT = FILE_WRITELN(WK_FILENAME, 'this qty < is qty'); */
           /* note that here it is splitting off the tran qty . Not the pick remaining on the line !!!! */
           /*  SPlit it */
           /* calculate the next ssn id */
           SELECT GENERATE_SSN_METHOD FROM CONTROL INTO :WK_GENERATE_SSN_METHOD;
        /* WK_RESULT = FILE_WRITELN(WK_FILENAME, '12'); */

          /* IF ((WK_GENERATE_SSN_METHOD IS NULL) OR (WK_GENERATE_SSN_METHOD <> '|GRN=4|LINE=2|SUFFIX=2,3|')) THEN */
           IF ((WK_GENERATE_SSN_METHOD IS NULL) OR ((WK_GENERATE_SSN_METHOD <> '|GRN=4|LINE=2|SUFFIX=2,3|') AND 
               (WK_GENERATE_SSN_METHOD <> 'CMP=2|GRN=6|LINE=2|SFX=2' ))) THEN
           BEGIN
              /* Get length for Barcode */   
              EXECUTE PROCEDURE GET_BARCODE_LENGTH RETURNING_VALUES iSSN_LENGTH;
        /* WK_RESULT = FILE_WRITELN(WK_FILENAME, '13'); */
              iSSN_ID = GEN_ID(ISSN_SSN_ID, 1);
              P_SSN_ID = iSSN_ID - 1;
              LEN_SSN_ID = STRLEN(P_SSN_ID);
              I_SSN_ID = '';
              I_LEN_SSN_ID = STRLEN(P_SSN_ID);
              
              /* Padding leading with 0 */
              WHILE (I_LEN_SSN_ID < :iSSN_LENGTH) DO
              BEGIN
                 I_SSN_ID = I_SSN_ID || '0';
                 I_LEN_SSN_ID = I_LEN_SSN_ID + 1;
              END
              I_SSN_ID = I_SSN_ID || P_SSN_ID;
           END
           IF (WK_GENERATE_SSN_METHOD = '|GRN=4|LINE=2|SUFFIX=2,3|' ) THEN
           BEGIN
        /* WK_RESULT = FILE_WRITELN(WK_FILENAME, 'pkol start - grn style ssn id'); */
              /* the prefix (length 6 is the current issn ssn_id) */
              WK_SSN_PREFIX = SUBSTR(WK_OBJECT,1,6);
        /* WK_RESULT = FILE_WRITELN(WK_FILENAME, 'prefix ' || wk_ssn_prefix); */
              /* want the max pallet no for that prefix */  
              /* SELECT GRN FROM SSN WHERE SSN_ID = :WK_ORIGINAL_SSN INTO :GRN; */
              GRN = SUBSTR(WK_OBJECT,1,4);
        /* WK_RESULT = FILE_WRITELN(WK_FILENAME, 'grn ' || grn); */
              SELECT LAST_PALLET_NO FROM GRN WHERE GRN = :GRN INTO :WK_PALLET_NO_INT;
        /* WK_RESULT = FILE_WRITELN(WK_FILENAME, 'have pallet ' ); */
              IF (WK_PALLET_NO_INT IS NULL) THEN
              BEGIN
                 WK_PALLET_NO_INT = 0;
              END
                
              WK_PALLET_NO_INT = WK_PALLET_NO_INT + 1;
              UPDATE GRN SET LAST_PALLET_NO = :WK_PALLET_NO_INT WHERE GRN = :GRN;
              WK_PALLET_NO = WK_PALLET_NO_INT;
              IF (WK_PALLET_NO < 10) THEN
              BEGIN
                 WK_PALLET_NO = LPAD(WK_PALLET_NO,'0',2);
              END

              I_SSN_ID = WK_SSN_PREFIX || WK_PALLET_NO; 
           END /* if ssn method is |GRN=4|LINE=2|SUFFIX=2,3| */

           IF (WK_GENERATE_SSN_METHOD = 'CMP=2|GRN=6|LINE=2|SFX=2' ) THEN
           BEGIN
              GRN = '';
              WK_ORIGINAL_SSN = '';
              /* the prefix (length 6 is the current issn ssn_id) */
              WK_SSN_PREFIX = SUBSTR(WK_OBJECT,1,6);
              /* want the max pallet no for that prefix */  
              SELECT ORIGINAL_SSN FROM ISSN WHERE SSN_ID = :WK_OBJECT INTO :WK_ORIGINAL_SSN; 
              SELECT GRN FROM SSN WHERE SSN_ID = :WK_ORIGINAL_SSN INTO :GRN; 
              /* GRN = SUBSTR(WK_OBJECT,1,4); */
              /* want the max pallet no for that prefix */  
        /* WK_RESULT = FILE_WRITELN(WK_FILENAME, 'grn ' || grn); */
              WK_GRN_TYPE = '';
              WK_LOADNO = '';
              WK_GRN_LOT = '';
              SELECT GRN_TYPE, ORDER_NO , LAST_LOT_NO
              FROM GRN 
              WHERE GRN = :GRN
              INTO :WK_GRN_TYPE, :WK_LOADNO, :WK_GRN_LOT;
              WK_OWNER = '';
              WK_OWNER_PFX = '';
              IF (WK_GRN_LOT IS NULL) THEN
              BEGIN
                 WK_GRN_LOT = '';
              END
              SELECT LAST_PALLET_NO FROM GRN WHERE GRN = :GRN INTO :WK_PALLET_NO_INT;
        /* WK_RESULT = FILE_WRITELN(WK_FILENAME, 'have pallet ' ); */
              IF (WK_PALLET_NO_INT IS NULL) THEN
              BEGIN
                 WK_PALLET_NO_INT = 0;
              END
              IF (STRLEN(WK_GRN_LOT) > 0) THEN
              BEGIN
                 WK_LAST_LOT_PALLET_NO = 0;
                 SELECT MAX(LAST_PALLET_NO) FROM GRN WHERE LAST_LOT_NO = :WK_GRN_LOT INTO :WK_LAST_LOT_PALLET_NO;
                 IF (WK_LAST_LOT_PALLET_NO IS NULL) THEN
                 BEGIN
                    WK_LAST_LOT_PALLET_NO = WK_PALLET_NO_INT;
                 END
                 IF (WK_LAST_LOT_PALLET_NO > WK_PALLET_NO_INT) THEN
                 BEGIN
                    WK_PALLET_NO_INT = WK_LAST_LOT_PALLET_NO;
                 END
              END
              WK_PALLET_NO_INT = WK_PALLET_NO_INT + 1;
              UPDATE GRN SET LAST_PALLET_NO = :WK_PALLET_NO_INT WHERE GRN = :GRN;
              WK_PALLET_NO = WK_PALLET_NO_INT;
              IF (WK_PALLET_NO < 10) THEN
              BEGIN
                 WK_PALLET_NO = LPAD(WK_PALLET_NO,'0',2);
              END

              IF ((WK_GRN_TYPE = 'PO') OR
                  (WK_GRN_TYPE = 'RA') OR  
                  (WK_GRN_TYPE = 'TR') OR
                  (WK_GRN_TYPE = 'WO')) THEN
              BEGIN
                 SELECT COMPANY_ID, PO_LEGACY_OWNER_ID 
                 FROM PURCHASE_ORDER 
                 WHERE PURCHASE_ORDER = :WK_LOADNO
                 INTO :WK_OWNER, :WK_OWNER_PFX;
                 IF (WK_OWNER_PFX IS NULL) THEN
                 BEGIN
                    WK_OWNER_PFX = '';
                 END
              END
              IF (WK_OWNER IS NULL OR WK_OWNER = '') THEN
              BEGIN
                 SELECT OWNER_ID 
                 FROM GRN 
                 WHERE GRN = :GRN
                 INTO :WK_OWNER;
              END
              IF (WK_OWNER_PFX = '') THEN
              BEGIN
                 SELECT COMPANY_ID_PREFIX 
                 FROM COMPANY 
                 WHERE COMPANY_ID = :WK_OWNER 
                 INTO :WK_OWNER_PFX;
        
                 IF (WK_OWNER_PFX IS NULL) THEN
                 BEGIN
                    WK_OWNER_PFX = '';
                 END
              END
              LEN_SSN_ID = STRLEN(WK_OWNER_PFX);
              WHILE (LEN_SSN_ID < 2) DO
              BEGIN
                 WK_OWNER_PFX = '0' || WK_OWNER_PFX;
                 LEN_SSN_ID = LEN_SSN_ID + 1;
              END
              LEN_SSN_ID = STRLEN(GRN);
              WK_OWNER_GRN = GRN;
              WHILE (LEN_SSN_ID < 6) DO
              BEGIN
                 WK_OWNER_GRN = '0' || WK_OWNER_GRN;
                 LEN_SSN_ID = LEN_SSN_ID + 1;
              END
              P_LAST_LINE_NO = SUBSTR(WK_OBJECT,STRLEN(WK_OBJECT) - 3,STRLEN(WK_OBJECT) - 2);

              IF (STRLEN(WK_GRN_LOT) > 0) THEN
              BEGIN
                 WK_OWNER_PFX = SUBSTR(WK_OBJECT, 1, 2);
                 WK_OWNER_GRN = SUBSTR(WK_OBJECT,3, STRLEN(WK_OBJECT) - 4);
              END
              /* I_SSN_ID = WK_SSN_PREFIX || WK_PALLET_NO; */
              I_SSN_ID = WK_OWNER_PFX || WK_OWNER_GRN || P_LAST_LINE_NO || WK_PALLET_NO;
           END /* if ssn method is 'CMP=2|GRN=6|LINE=2|SFX=2' */
           /* end of get next ssn id */
              
/* ===================================== */
        /* WK_RESULT = FILE_WRITELN(WK_FILENAME, 'before pc_trss '); */
        /* WK_RESULT = FILE_WRITELN(WK_FILENAME, wk_object); */
        /* WK_RESULT = FILE_WRITELN(WK_FILENAME, i_ssn_id ); */
           /* :WK_QTY, */
           EXECUTE PROCEDURE PC_TRSS 
           :WK_RECORD ,
           :WK_WH_ID,
           :WK_LOCN_ID,
           :WK_OBJECT,
           'TRSS',
           'A',
           :WK_DATE,
           :I_SSN_ID,
           :WK_THIS_QTY,
           :WK_USER,
           :WK_DEVICE;
           WK_OLD_SSN_ID = WK_OBJECT;
           WK_OBJECT = I_SSN_ID;
        /* WK_RESULT = FILE_WRITELN(WK_FILENAME, '14'); */
        /* WK_RESULT = FILE_WRITELN(WK_FILENAME, 'after pc_trss ' || :I_SSN_ID ); */
           /* UPDATE ISSN SET OTHER1 = (SELECT OTHER1 FROM ISSN WHERE SSN_ID=:WK_OLD_SSN_ID), OTHER2 = 'Split ' || :WK_OLD_SSN_ID WHERE SSN_ID = :I_SSN_ID; */
           UPDATE ISSN SET OTHER1 = (SELECT OTHER1 FROM ISSN WHERE SSN_ID=:WK_OLD_SSN_ID), OTHER2 = 'Split ' || :WK_OLD_SSN_ID || ' Order ' || :WK_PI_ORDER WHERE SSN_ID = :I_SSN_ID;
        /* WK_RESULT = FILE_WRITELN(WK_FILENAME, '15'); */
        /* WK_RESULT = FILE_WRITELN(WK_FILENAME, 'after set other2 '  ); */
        END
        ELSE
        BEGIN
        /* WK_RESULT = FILE_WRITELN(WK_FILENAME, 'before check other2 '); */
           IF (WK_CURRENT_OTHER2 IS NOT NULL) THEN
           BEGIN
              IF (SUBSTR(:WK_CURRENT_OTHER2,1,5) = 'Split') THEN
              BEGIN
                 UPDATE ISSN SET OTHER2 = 'SPLit ' || ALLTRIM(SUBSTR(:WK_CURRENT_OTHER2,6,40))
                 WHERE SSN_ID = :WK_OBJECT;
        /* WK_RESULT = FILE_WRITELN(WK_FILENAME, '16'); */
              END
           END

        END
   
        /* WK_RESULT = FILE_WRITELN(WK_FILENAME, 'before check device  '); */
        /* use wh_id of device */
        WK_DEVICE_WH = WK_WH_ID;
        SELECT FIRST 1 WH_ID FROM LOCATION WHERE LOCN_ID = :WK_DEVICE
        AND (WH_ID NOT STARTING 'X')
        INTO :WK_DEVICE_WH;
        /* WK_RESULT = FILE_WRITELN(WK_FILENAME, '17'); */
   
        UPDATE ISSN SET ISSN_STATUS = :WK_PI_STATUS,
            PREV_PREV_WH_ID = PREV_WH_ID,
            PREV_PREV_LOCN_ID = PREV_LOCN_ID,
            PREV_WH_ID = WH_ID,
            PREV_LOCN_ID = LOCN_ID,
            WH_ID = :WK_DEVICE_WH,
            LOCN_ID = :WK_DEVICE
         WHERE SSN_ID = :WK_OBJECT;
        /* WK_RESULT = FILE_WRITELN(WK_FILENAME, '18'); */
         EXECUTE PROCEDURE ADD_SSN_HIST(:WK_DEVICE_WH, :WK_DEVICE, :WK_OBJECT, 
                 :WK_TRN_TYPE, :WK_TRN_CODE, :WK_DATE,
                 :WK_AUDIT_DESC , :WK_REASON, :WK_QTY, :WK_USER, :WK_DEVICE); 
        /* WK_RESULT = FILE_WRITELN(WK_FILENAME, '19'); */
   
        IF (WK_PI_STATUS = 'PL') THEN
        BEGIN
           UPDATE PICK_ITEM_DETAIL 
           SET  PICK_DETAIL_STATUS = :WK_PI_STATUS
           WHERE PICK_LABEL_NO = :WK_LABEL_NO 
           AND PICK_DETAIL_STATUS = 'PG';
        /* WK_RESULT = FILE_WRITELN(WK_FILENAME, '20'); */
           FOR SELECT SSN_ID FROM PICK_ITEM_DETAIL
               WHERE PICK_LABEL_NO = :WK_LABEL_NO 
               INTO :WK_PID_SSN
           DO
           BEGIN
              UPDATE ISSN 
              SET  ISSN_STATUS = :WK_PI_STATUS
              WHERE SSN_ID = :WK_PID_SSN 
              AND ISSN_STATUS = 'PG';
        /* WK_RESULT = FILE_WRITELN(WK_FILENAME, '21'); */
           END
        END
   
        WK_PID_FOUND = 0;
        SELECT 1, QTY_PICKED, PICK_DETAIL_ID 
               FROM PICK_ITEM_DETAIL
               WHERE PICK_LABEL_NO = :WK_LABEL_NO
               AND SSN_ID = :WK_OBJECT
               INTO :WK_PID_FOUND, :WK_PID_QTY, :WK_DETAIL_ID;
        /* WK_RESULT = FILE_WRITELN(WK_FILENAME, '22'); */
        IF (WK_PID_FOUND = 0) THEN
        BEGIN
           /* no detail record */
           /*     :WK_QTY, */
           INSERT INTO PICK_ITEM_DETAIL 
               (PICK_LABEL_NO, 
                SSN_ID, 
                PICK_DETAIL_STATUS, 
                QTY_PICKED,
                USER_ID, 
                DEVICE_ID, 
                CREATE_DATE,
                FROM_WH_ID,
                FROM_LOCN_ID)
           VALUES (:WK_LABEL_NO, 
                :WK_OBJECT,
                :WK_PI_STATUS,
                :WK_THIS_QTY,
                :WK_USER,
                :WK_DEVICE,
                :WK_DATE,
                :WK_CURRENT_WH_ID,
                :WK_CURRENT_LOCN_ID);
        /* WK_RESULT = FILE_WRITELN(WK_FILENAME, '23'); */
        END
        ELSE
        BEGIN
           /*     :WK_QTY , */
           UPDATE PICK_ITEM_DETAIL 
           SET  PICK_DETAIL_STATUS =
                :WK_PI_STATUS,
                QTY_PICKED =
                :WK_THIS_QTY ,
                USER_ID =
                :WK_USER,
                DEVICE_ID =
                :WK_DEVICE
           WHERE PICK_DETAIL_ID = :WK_DETAIL_ID;
        /* WK_RESULT = FILE_WRITELN(WK_FILENAME, '24'); */
        END
   
        UPDATE PICK_ITEM
        SET  PICK_LINE_STATUS =
                :WK_PI_STATUS,
                PICKED_QTY = :WK_PI_PICKED_QTY,
                REASON = :WK_REASON
        WHERE PICK_LABEL_NO = :WK_LABEL_NO;
        /* WK_RESULT = FILE_WRITELN(WK_FILENAME, '25'); */
   
      EXECUTE PROCEDURE UPDATE_TRAN (WK_RECORD, 'T','Processed successfully');
   /*
      EXECUTE PROCEDURE ADD_TRAN(
           :WK_DEVICE,
           '',
           '',
           'PKUA',
           'I',
           :WK_DATE,
           '',
           0,
           'F',
           '',
           'MASTER',
           0,
           '',
           'SSSSSSSSS',
           :WK_USER,
           :WK_DEVICE);
   */
     END
     ELSE
     IF (NEW.TRN_CODE = 'P')  THEN
     BEGIN
/*
        WK_LOG = 'TRN_CODE P' || NEW.TRN_CODE;
        INSERT INTO LOG(DESCRIPTION) VALUES(:WK_LOG);
*/
        /* standard method for picking by product */   
/*
        for pick items allocated to device for this product
        beginfor
           deal with issn's
            while (qty required (remaining) > 0) & not at end of issn's
               get an issn for product in the right location
               and the right status
               This then is like the issn method
               but the qty is calced
               if qty required(remaining) < current_qty
                  split issn and use new qty item
                  update issn used status and location to device id
                  reduce qty required (remaining)
               if qty required(remaining) = current_qty
                  take all of the issn
                  update issn used status and location to device id
                  reduce qty required (remaining)
            end while
         if now qty required remaining is still not zero - have problem
         so must create stock for remaining qty

        get pick_item_detail for device, and ssn is for this product
        add/update pick_item_detail for each issn used
        update pick_item status =PG and qty picked
           must split the qty picked amongst the pick items involved
            if qty_picked = order_qty or reference not ''
            then status = PL
*/
        WK_QTY_REMAINING = WK_QTY;
        WK_CURRENT_WH_ID = WK_WH_ID;
        WK_CURRENT_LOCN_ID = WK_LOCN_ID;
        /* get statuses from control */
        SELECT PICK_IMPORT_SSN_STATUS FROM CONTROL
        INTO :WK_ALLOWED_STATUS;
        SELECT SEND_UASL_V4 FROM CONTROL INTO :WK_DO_UASL;
        IF (WK_ALLOWED_STATUS IS NULL) THEN
        BEGIN
           WK_ALLOWED_STATUS = ',,';
        END
        /* use wh_id of device */
        WK_DEVICE_WH = WK_WH_ID;
        SELECT WH_ID FROM LOCATION WHERE LOCN_ID = :WK_DEVICE
        INTO :WK_DEVICE_WH;
        FOR SELECT PICK_LABEL_NO, PICKED_QTY, PICK_ORDER_QTY 
               FROM PICK_ITEM
               WHERE DEVICE_ID = :WK_DEVICE AND
               (PICK_LINE_STATUS IN ('AL','PG') OR
                (PICK_LINE_STATUS = 'PL' AND PICKED_QTY < PICK_ORDER_QTY))
               AND PROD_ID = :WK_OBJECT
               INTO :WK_LABEL_NO, :WK_PI_PICKED_QTY, :WK_PI_ORDER_QTY
        DO
        BEGIN
/*
           WK_LOG = 'in pick_item loop' || :WK_LABEL_NO || ' prod ' || :WK_OBJECT ;
           INSERT INTO LOG(DESCRIPTION) VALUES(:WK_LOG);
*/
           IF (WK_QTY_REMAINING > 0) THEN
           BEGIN
/*
              WK_LOG = 'wk_qty_remaining ' || :WK_QTY_REMAINING;
              INSERT INTO LOG(DESCRIPTION) VALUES(:WK_LOG);
*/
              WK_PI_PICKED_QTY_NULL = 0;
              SELECT 1
                     FROM PICK_ITEM
                     WHERE PICK_LABEL_NO = :WK_LABEL_NO
                       AND PICKED_QTY IS NULL
                     INTO :WK_PI_PICKED_QTY_NULL;
              IF (WK_PI_PICKED_QTY_NULL = 1) THEN
              BEGIN
                 WK_PI_PICKED_QTY = 0;
              END
              WK_PI_STATUS = 'PG';
              IF (WK_REASON <> '') THEN
              BEGIN
                 WK_PI_STATUS = 'PL';
              END
              /* how much to use on this line */
              WK_PI_LINE_QTY_REMAINING = WK_PI_ORDER_QTY - WK_PI_PICKED_QTY;
              IF (WK_PI_LINE_QTY_REMAINING <= WK_QTY_REMAINING) THEN
              BEGIN
                 WK_QTY_TO_USE = WK_PI_LINE_QTY_REMAINING;
              END
              ELSE
              BEGIN
                 WK_QTY_TO_USE = WK_QTY_REMAINING;
              END
              WK_PI_PICKED_QTY = WK_PI_PICKED_QTY + WK_QTY_TO_USE;
/*
              WK_LOG = 'wk_qty_to_use ' || :WK_QTY_TO_USE;
              INSERT INTO LOG(DESCRIPTION) VALUES(:WK_LOG);
*/
              IF (WK_PI_PICKED_QTY >= WK_PI_ORDER_QTY) THEN
              BEGIN
                 WK_PI_STATUS = 'PL';
              END
   
              /* must get issns to make up qty to use */
              WK_IS_QTY_REMAINING = WK_QTY_TO_USE;
/*
              WK_LOG = 'wk_is_qty_remaining ' || :WK_IS_QTY_REMAINING;
              INSERT INTO LOG(DESCRIPTION) VALUES(:WK_LOG);
*/
              /* if prod was NOPROD must ensure that we have enough stock */
              /* so must create issns */
              IF (WK_OBJECT = 'NOPROD') THEN
              BEGIN
                 WK_IS_QTY = 0;
                 SELECT SUM(CURRENT_QTY)
                  FROM ISSN
                  WHERE PROD_ID = :WK_OBJECT
                  AND WH_ID = :WK_WH_ID
                  AND LOCN_ID = :WK_LOCN_ID
                  AND POS(:WK_ALLOWED_STATUS, ISSN.ISSN_STATUS, 0, 1) > -1
                  AND CURRENT_QTY > 0
                  INTO :WK_IS_QTY;  
                 IF (WK_IS_QTY IS NULL) THEN
                 BEGIN
                    WK_IS_QTY = 0;
                 END

                 IF (WK_IS_QTY_REMAINING > WK_IS_QTY) THEN
                 BEGIN
                    /* lets make 10 time the amount for later use */
                    WK_IS_QTY = 10 * WK_IS_QTY_REMAINING;
                    EXECUTE PROCEDURE ADD_ISSN ('' ,
                       :WK_WH_ID,
                       :WK_LOCN_ID,
                       '',
                       :WK_IS_QTY,
                       0,
                       'NOW',
                       'ST',
                       '',
                       'NOW',
                       :WK_USER ,
                       :WK_OBJECT,
                       1);
                 END
              END
              WK_IS_TAKEN = 'N';
              FOR SELECT CURRENT_QTY, SSN_ID
                  FROM ISSN
                  WHERE PROD_ID = :WK_OBJECT
                  AND WH_ID = :WK_WH_ID
                  AND LOCN_ID = :WK_LOCN_ID
                  AND POS(:WK_ALLOWED_STATUS, ISSN.ISSN_STATUS, 0, 1) > -1
                  AND CURRENT_QTY > 0
                  INTO :WK_IS_QTY, :WK_IS_SSN 
              DO
              BEGIN
/*
                 WK_LOG = 'issn loop ' || :WK_IS_SSN || ' ' || :WK_IS_QTY;
                 INSERT INTO LOG(DESCRIPTION) VALUES(:WK_LOG);
*/
                 IF (WK_IS_QTY_REMAINING > 0) THEN
                 BEGIN
/*
                    WK_LOG = 'wk_is_qty_remaining ' || :WK_IS_QTY_REMAINING;
                    INSERT INTO LOG(DESCRIPTION) VALUES(:WK_LOG);
*/
                    /* how much can I take */
                    /* either issn qty or remaining qty if its less */
                    WK_USED_SSN = WK_IS_SSN;
                    WK_IS_USED_QTY = WK_IS_QTY;
                    IF (WK_IS_QTY_REMAINING < WK_IS_QTY) THEN
                    BEGIN
/*
                       WK_LOG = 'split it ' ;
                       INSERT INTO LOG(DESCRIPTION) VALUES(:WK_LOG);
*/
                       WK_IS_USED_QTY = WK_IS_QTY_REMAINING;
                       /*  SPlit it  and take wk_is_qty_remaining */
                       /* Get length for Barcode */   
                       EXECUTE PROCEDURE GET_BARCODE_LENGTH RETURNING_VALUES iSSN_LENGTH;
                       iSSN_ID = GEN_ID(ISSN_SSN_ID, 1);
                       P_SSN_ID = iSSN_ID - 1;
                       LEN_SSN_ID = STRLEN(P_SSN_ID);
                       I_SSN_ID = '';
                       I_LEN_SSN_ID = STRLEN(P_SSN_ID);
                          
                       /* Padding leading with 0 */
                       WHILE (I_LEN_SSN_ID < :iSSN_LENGTH) DO
                       BEGIN
                          I_SSN_ID = I_SSN_ID || '0';
                          I_LEN_SSN_ID = I_LEN_SSN_ID + 1;
                       END
                       I_SSN_ID = I_SSN_ID || P_SSN_ID;
                          
                       EXECUTE PROCEDURE PC_TRSS 
                          :WK_RECORD ,
                          :WK_WH_ID,
                          :WK_LOCN_ID,
                          :WK_IS_SSN,
                          'TRSS',
                          'A',
                          :WK_DATE,
                          :I_SSN_ID,
                          :WK_IS_QTY_REMAINING,
                          :WK_USER,
                          :WK_DEVICE;
                       WK_OLD_SSN_ID = WK_IS_SSN;
                       /* WK_OBJECT = I_SSN_ID */
                       WK_USED_SSN = I_SSN_ID;
                       /* must reduce wk_is_qty_remaining to zero */
                       /* so end of issns that we take */
                       UPDATE ISSN SET OTHER1 = (SELECT OTHER1 FROM ISSN WHERE SSN_ID=:WK_OLD_SSN_ID), OTHER2 = 'Split ' || :WK_OLD_SSN_ID || ' Order ' || :WK_PI_ORDER WHERE SSN_ID = :I_SSN_ID;
         
                    END
                    WK_IS_TAKEN = 'Y';
/*
                    WK_LOG = 'wk_used ssn_id ' || :WK_USED_SSN;
                    INSERT INTO LOG(DESCRIPTION) VALUES(:WK_LOG);
*/
                    UPDATE ISSN SET ISSN_STATUS = :WK_PI_STATUS,
                        PREV_PREV_WH_ID = PREV_WH_ID,
                        PREV_PREV_LOCN_ID = PREV_LOCN_ID,
                        PREV_WH_ID = WH_ID,
                        PREV_LOCN_ID = LOCN_ID,
                        WH_ID = :WK_DEVICE_WH,
                        LOCN_ID = :WK_DEVICE
                     WHERE SSN_ID = :WK_USED_SSN;
                    EXECUTE PROCEDURE ADD_SSN_HIST(:WK_DEVICE_WH, :WK_DEVICE, :WK_USED_SSN, 
                             :WK_TRN_TYPE, :WK_TRN_CODE, :WK_DATE,
                             :WK_AUDIT_DESC , :WK_REASON, :WK_IS_USED_QTY, :WK_USER, :WK_DEVICE); 
                    /* must reduce wk_is_qty_remaining by wk_is_used_qty */
         
/*
                    WK_LOG = 'wk_pi_status ' || :WK_PI_STATUS;
                    INSERT INTO LOG(DESCRIPTION) VALUES(:WK_LOG);
*/
                    IF (WK_PI_STATUS = 'PL') THEN
                    BEGIN
                       UPDATE PICK_ITEM_DETAIL 
                       SET  PICK_DETAIL_STATUS = :WK_PI_STATUS
                       WHERE PICK_LABEL_NO = :WK_LABEL_NO 
                       AND PICK_DETAIL_STATUS = 'PG';
                       FOR SELECT SSN_ID FROM PICK_ITEM_DETAIL
                           WHERE PICK_LABEL_NO = :WK_LABEL_NO 
                           INTO :WK_PID_SSN
                       DO
                       BEGIN
                          UPDATE ISSN 
                          SET  ISSN_STATUS = :WK_PI_STATUS
                          WHERE SSN_ID = :WK_PID_SSN 
                          AND ISSN_STATUS = 'PG';
                       END
                    END
                    WK_PID_FOUND = 0;
                    SELECT 1, QTY_PICKED, PICK_DETAIL_ID 
                          FROM PICK_ITEM_DETAIL
                          WHERE PICK_LABEL_NO = :WK_LABEL_NO
                          AND SSN_ID = :WK_USED_SSN
                          INTO :WK_PID_FOUND, :WK_PID_QTY, :WK_DETAIL_ID;
                    IF (WK_PID_FOUND = 0) THEN
                    BEGIN
                       /* no detail record */
                       INSERT INTO PICK_ITEM_DETAIL 
                           (PICK_LABEL_NO, 
                            SSN_ID, 
                            PICK_DETAIL_STATUS, 
                            QTY_PICKED,
                            USER_ID, 
                            DEVICE_ID, 
                            CREATE_DATE,
                            FROM_WH_ID,
                            FROM_LOCN_ID)
                       VALUES (:WK_LABEL_NO, 
                            :WK_USED_SSN,
                            :WK_PI_STATUS,
                            :WK_IS_USED_QTY,
                            :WK_USER,
                            :WK_DEVICE,
                            :WK_DATE,
                            :WK_CURRENT_WH_ID,
                            :WK_CURRENT_LOCN_ID);
                    END
                    ELSE
                    BEGIN
                       UPDATE PICK_ITEM_DETAIL 
                       SET  PICK_DETAIL_STATUS = :WK_PI_STATUS,
                            QTY_PICKED = :WK_IS_USED_QTY ,
                            USER_ID = :WK_USER,
                            DEVICE_ID = :WK_DEVICE
                       WHERE PICK_DETAIL_ID = :WK_DETAIL_ID;
                    END
                    WK_IS_QTY_REMAINING = WK_IS_QTY_REMAINING - WK_IS_USED_QTY;
                 END
      
              END /* end for issns loop */
/*
              WK_LOG = 'end issn loop ' || :WK_IS_TAKEN;
              INSERT INTO LOG(DESCRIPTION) VALUES(:WK_LOG);
*/
              IF (WK_IS_TAKEN = 'N') THEN
              BEGIN
                 /* no stock - so create dummy zero qtys */
/*
                 WK_LOG = 'create zero qty ssn ' ;
                 INSERT INTO LOG(DESCRIPTION) VALUES(:WK_LOG);
*/
                 EXECUTE PROCEDURE ADD_ISSN ('' ,
                       :WK_WH_ID,
                       :WK_LOCN_ID,
                       '',
                       0,
                       0,
                       'NOW',
                       'ST',
                       '',
                       'NOW',
                       :WK_USER ,
                       :WK_OBJECT,
                       1);
                 SELECT FIRST 1 CURRENT_QTY, SSN_ID
                     FROM ISSN
                     WHERE PROD_ID = :WK_OBJECT
                     AND WH_ID = :WK_WH_ID
                     AND LOCN_ID = :WK_LOCN_ID
                     AND POS(:WK_ALLOWED_STATUS, ISSN.ISSN_STATUS, 0, 1) > -1
                     AND CURRENT_QTY = 0
                     ORDER BY CREATE_DATE DESC
                     INTO :WK_IS_USED_QTY, :WK_USED_SSN;
                 UPDATE ISSN SET ISSN_STATUS = :WK_PI_STATUS,
                     PREV_PREV_WH_ID = PREV_WH_ID,
                     PREV_PREV_LOCN_ID = PREV_LOCN_ID,
                     PREV_WH_ID = WH_ID,
                     PREV_LOCN_ID = LOCN_ID,
                     WH_ID = :WK_DEVICE_WH,
                     LOCN_ID = :WK_DEVICE
                  WHERE SSN_ID = :WK_USED_SSN;
                 EXECUTE PROCEDURE ADD_SSN_HIST(:WK_DEVICE_WH, :WK_DEVICE, :WK_USED_SSN, 
                          :WK_TRN_TYPE, :WK_TRN_CODE, :WK_DATE,
                          :WK_AUDIT_DESC , :WK_REASON, :WK_IS_USED_QTY, :WK_USER, :WK_DEVICE); 
                 /* no detail record */
                 INSERT INTO PICK_ITEM_DETAIL 
                     (PICK_LABEL_NO, 
                      SSN_ID, 
                      PICK_DETAIL_STATUS, 
                      QTY_PICKED,
                      USER_ID, 
                      DEVICE_ID, 
                      CREATE_DATE,
                      FROM_WH_ID,
                      FROM_LOCN_ID)
                 VALUES (:WK_LABEL_NO, 
                      :WK_USED_SSN,
                      :WK_PI_STATUS,
                      :WK_IS_USED_QTY,
                      :WK_USER,
                      :WK_DEVICE,
                      :WK_DATE,
                      :WK_CURRENT_WH_ID,
                      :WK_CURRENT_LOCN_ID);
              END
/*
              WK_LOG = 'end add zero qty ' || :WK_IS_TAKEN;
              INSERT INTO LOG(DESCRIPTION) VALUES(:WK_LOG);
*/
              IF (WK_IS_QTY_REMAINING > 0) THEN
              BEGIN
                 /* dont have that much stock to take so adjust it down */
                 WK_PI_PICKED_QTY = WK_PI_PICKED_QTY - WK_IS_QTY_REMAINING;
                 WK_QTY_TO_USE = WK_QTY_TO_USE - WK_IS_QTY_REMAINING;
/*
                 WK_LOG = 'adjust qty remaining ' || :WK_QTY_TO_USE;
                 INSERT INTO LOG(DESCRIPTION) VALUES(:WK_LOG);
                 WK_LOG = 'adjust qty remaining picked_qty ' || :WK_PI_PICKED_QTY;
                 INSERT INTO LOG(DESCRIPTION) VALUES(:WK_LOG);
*/
              END
              UPDATE PICK_ITEM
              SET  PICK_LINE_STATUS =
                      :WK_PI_STATUS,
                      PICKED_QTY = :WK_PI_PICKED_QTY,
                      REASON = :WK_REASON
              WHERE PICK_LABEL_NO = :WK_LABEL_NO;
              WK_QTY_REMAINING = WK_QTY_REMAINING - WK_QTY_TO_USE;
/*
              WK_LOG = 'qty to use was ' || :WK_QTY_TO_USE;
              INSERT INTO LOG(DESCRIPTION) VALUES(:WK_LOG);
              WK_LOG = 'adjust qty remaining to ' || :WK_QTY_REMAINING;
              INSERT INTO LOG(DESCRIPTION) VALUES(:WK_LOG);
*/
           END
           ELSE
           BEGIN
              /* qty remaining is zero but still have lines left */
              /* must create zero qty issn and pick_item_detail */
/*
              WK_LOG = 'qty remaining <= 0  ' || :WK_QTY_REMAINING;
              INSERT INTO LOG(DESCRIPTION) VALUES(:WK_LOG);
*/
              WK_PI_PICKED_QTY_NULL = 0;
              SELECT 1
                     FROM PICK_ITEM
                     WHERE PICK_LABEL_NO = :WK_LABEL_NO
                       AND PICKED_QTY IS NULL
                     INTO :WK_PI_PICKED_QTY_NULL;
              IF (WK_PI_PICKED_QTY_NULL = 1) THEN
              BEGIN
                 WK_PI_PICKED_QTY = 0;
              END
              WK_PI_STATUS = 'PG';
              IF (WK_REASON <> '') THEN
              BEGIN
                 WK_PI_STATUS = 'PL';
              END
/*
              WK_LOG = 'wk_pi_status ' || :WK_PI_STATUS;
              INSERT INTO LOG(DESCRIPTION) VALUES(:WK_LOG);
*/
/*
              WK_PI_STATUS = 'CN';
   
              UPDATE PICK_ITEM
              SET  PICK_LINE_STATUS =
                      :WK_PI_STATUS,
                      PICKED_QTY = :WK_PI_PICKED_QTY,
                      DEVICE_ID = NULL,
                      REASON = :WK_REASON
              WHERE PICK_LABEL_NO = :WK_LABEL_NO;
*/
              /* no stock - so create dummy zero qtys */
              EXECUTE PROCEDURE ADD_ISSN ('' ,
                    :WK_WH_ID,
                    :WK_LOCN_ID,
                    '',
                    0,
                    0,
                    'NOW',
                    'ST',
                    '',
                    'NOW',
                    :WK_USER ,
                    :WK_OBJECT,
                    1);
              SELECT FIRST 1 CURRENT_QTY, SSN_ID
                  FROM ISSN
                  WHERE PROD_ID = :WK_OBJECT
                  AND WH_ID = :WK_WH_ID
                  AND LOCN_ID = :WK_LOCN_ID
                  AND POS(:WK_ALLOWED_STATUS, ISSN.ISSN_STATUS, 0, 1) > -1
                  AND CURRENT_QTY = 0
                  ORDER BY CREATE_DATE DESC
                  INTO :WK_IS_USED_QTY, :WK_USED_SSN;
              UPDATE ISSN SET ISSN_STATUS = :WK_PI_STATUS,
                  PREV_PREV_WH_ID = PREV_WH_ID,
                  PREV_PREV_LOCN_ID = PREV_LOCN_ID,
                  PREV_WH_ID = WH_ID,
                  PREV_LOCN_ID = LOCN_ID,
                  WH_ID = :WK_DEVICE_WH,
                  LOCN_ID = :WK_DEVICE
               WHERE SSN_ID = :WK_USED_SSN;
              EXECUTE PROCEDURE ADD_SSN_HIST(:WK_DEVICE_WH, :WK_DEVICE, :WK_USED_SSN, 
                       :WK_TRN_TYPE, :WK_TRN_CODE, :WK_DATE,
                       :WK_AUDIT_DESC , :WK_REASON, :WK_IS_USED_QTY, :WK_USER, :WK_DEVICE); 
              /* no detail record */
              INSERT INTO PICK_ITEM_DETAIL 
                  (PICK_LABEL_NO, 
                   SSN_ID, 
                   PICK_DETAIL_STATUS, 
                   QTY_PICKED,
                   USER_ID, 
                   DEVICE_ID, 
                   CREATE_DATE,
                   FROM_WH_ID,
                   FROM_LOCN_ID)
              VALUES (:WK_LABEL_NO, 
                   :WK_USED_SSN,
                   :WK_PI_STATUS,
                   :WK_IS_USED_QTY,
                   :WK_USER,
                   :WK_DEVICE,
                   :WK_DATE,
                   :WK_CURRENT_WH_ID,
                   :WK_CURRENT_LOCN_ID);
              UPDATE PICK_ITEM
              SET  PICK_LINE_STATUS =
                      :WK_PI_STATUS,
                      PICKED_QTY = :WK_PI_PICKED_QTY,
                      REASON = :WK_REASON
              WHERE PICK_LABEL_NO = :WK_LABEL_NO;
/*
              WK_LOG = 'created zero qty issn2 ' || :WK_PI_STATUS;
              INSERT INTO LOG(DESCRIPTION) VALUES(:WK_LOG);
*/
           END
        END /* end for pick items */
/*
        WK_LOG = 'end of pick_item ' ;
        INSERT INTO LOG(DESCRIPTION) VALUES(:WK_LOG);
*/
        EXECUTE PROCEDURE UPDATE_TRAN (WK_RECORD, 'T','Processed successfully');
        /* ok picked product - now send off remote sum of avail */
        IF (WK_DO_UASL = 'T') THEN
        BEGIN
           EXECUTE PROCEDURE SEND_PICKABLE_STOCK (:WK_OBJECT,
              :WK_USER,
              :WK_DEVICE,
              :WK_DATE);
        END
     END
/*
   EXECUTE PROCEDURE TRAN_ARCHIVE;
*/
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_PKCA FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 52 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_DEVICE CHAR(2);
DECLARE VARIABLE WK_PI_PICKED_QTY INTEGER;
DECLARE VARIABLE WK_PID_PICKED_QTY INTEGER;
DECLARE VARIABLE WK_LABEL_NO VARCHAR(10);
DECLARE VARIABLE WK_PI_STATUS CHAR(2);
DECLARE VARIABLE WK_PI_SSN VARCHAR(20);
DECLARE VARIABLE WK_PI_PROD VARCHAR(30);
DECLARE VARIABLE WK_RECORD INTEGER;
DECLARE VARIABLE WK_PID_SSN VARCHAR(20);
DECLARE VARIABLE WK_DATE TIMESTAMP;
DECLARE VARIABLE WK_USER VARCHAR(10);
DECLARE VARIABLE WK_FOUND INTEGER;
DECLARE VARIABLE WK_CANCEL CHAR(1);
DECLARE VARIABLE WK_PID_FROM_WH CHAR(2);
DECLARE VARIABLE WK_PID_FROM_LOCN VARCHAR(10);
DECLARE VARIABLE WK_CANCEL_SSN_STATUS CHAR(2);
DECLARE VARIABLE WK_PI_ORDER VARCHAR(15);
DECLARE VARIABLE WK_DO_UASL CHAR(1);
DECLARE VARIABLE WK_DO_UCIS CHAR(1);
DECLARE VARIABLE WK_GM_MESSAGE VARCHAR(10);
DECLARE VARIABLE WK_T4_DELIM CHAR(1);
DECLARE VARIABLE WK_T4_TRAN_DATA VARCHAR(1024);
DECLARE VARIABLE WK_T4_SOURCE VARCHAR(512);
DECLARE VARIABLE WK_NEW_RECORD INTEGER;
DECLARE VARIABLE WK_CN_PRIORITY SMALLINT;
DECLARE VARIABLE WK_CANCEL_PICK_STATUS VARCHAR(40);
DECLARE VARIABLE WK_PID_QTY_PICKED  INTEGER;
DECLARE VARIABLE WK_DEFAULT_LOCN_ID VARCHAR(10);
DECLARE VARIABLE WK_DEFAULT_WH_ID VARCHAR(2);
DECLARE VARIABLE WK_IS_QTY  INTEGER;
DECLARE VARIABLE WK_DEFAULT2_LOCN_ID VARCHAR(10);
DECLARE VARIABLE WK_DEFAULT2_WH_ID VARCHAR(2);

BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'PKCA') THEN
  BEGIN
     WK_DEVICE = NEW.DEVICE_ID;
     WK_DATE = NEW.TRN_DATE;
     WK_USER = NEW.PERSON_ID;
     WK_RECORD = NEW.RECORD_ID;
     WK_CANCEL = NEW.TRN_CODE;
     WK_CANCEL_SSN_STATUS = 'PA';
     WK_CN_PRIORITY = 0;
     SELECT PICK_CANCEL_SSN_STATUS, 
            SEND_UASL_V4, 
            SEND_UCIS_V4,
            DEFAULT_PICK_PRIORITY,
            PICK_CANCEL_PK_STATUS
     FROM CONTROL 
     INTO :WK_CANCEL_SSN_STATUS, 
          :WK_DO_UASL, 
          :WK_DO_UCIS,
          :WK_CN_PRIORITY,
          :WK_CANCEL_PICK_STATUS;

     FOR SELECT LOCATION.WH_ID, LOCATION.LOCN_ID
         FROM CONTROL
         JOIN LOCATION ON CONTROL.DEFAULT_WH_ID = LOCATION.WH_ID
         WHERE LOCATION.MOVE_STAT = 'RC'
         INTO :WK_DEFAULT_WH_ID, :WK_DEFAULT_LOCN_ID
     DO
     BEGIN
        WK_DEFAULT2_WH_ID = WK_DEFAULT_WH_ID;
        WK_DEFAULT2_LOCN_ID = WK_DEFAULT_LOCN_ID;
     END
         
     /* check whether can cancel */
     IF (WK_CANCEL = 'C') THEN
     BEGIN
        WK_FOUND = 0;
        BEGIN
           /* AND PID.PICK_DETAIL_STATUS STARTING 'D' */
           /*    AND PID2.PICK_DETAIL_STATUS IN ('PG','PL','AL') */
           SELECT FIRST 1 1
           FROM PICK_ITEM PI
           JOIN PICK_ITEM_DETAIL PID ON PI.PICK_LABEL_NO = PID.PICK_LABEL_NO
           WHERE PI.PICK_LABEL_NO IN (
              SELECT PID2.PICK_LABEL_NO 
               FROM PICK_ITEM_DETAIL PID2
               WHERE PID2.DEVICE_ID = :WK_DEVICE 
                 AND POS(:WK_CANCEL_PICK_STATUS,PID2.PICK_DETAIL_STATUS,0,1) > -1
               GROUP BY PID2.PICK_LABEL_NO)
              AND PID.PICK_DETAIL_STATUS IN ('DX','DC','DI','DQ')
            INTO :WK_FOUND;
        END
/*
        SELECT FIRST 1 1
        FROM PICK_ITEM PI
        JOIN PICK_ITEM_DETAIL PID ON PI.PICK_LABEL_NO = PID.PICK_LABEL_NO
        WHERE PI.DEVICE_ID = :WK_DEVICE 
           AND PID.PICK_DETAIL_STATUS STARTING 'D'
         INTO :WK_FOUND;
*/
        IF (WK_FOUND = 1) THEN
        BEGIN
           /* found pid records for this device - already part despatched */
           WK_CANCEL = 'D';
        END
     END

     /* update issns for part picked */
     /*    AND (PID.PICK_DETAIL_STATUS = 'PG'
           OR (PID.PICK_DETAIL_STATUS = 'PL')) */
     /* save prev status  and from location in issn for move back */
     FOR SELECT PID.SSN_ID , PI.SSN_ID, PI.PROD_ID, PID.FROM_WH_ID, PID.FROM_LOCN_ID 
         FROM PICK_ITEM_DETAIL PID
         JOIN PICK_ITEM PI ON PI.PICK_LABEL_NO = PID.PICK_LABEL_NO
         WHERE PID.DEVICE_ID = :WK_DEVICE 
           AND POS(:WK_CANCEL_PICK_STATUS,PID.PICK_DETAIL_STATUS,0,1) > -1
         ORDER by PID.SSN_ID, PID.LAST_UPDATE_DATE DESC
         INTO :WK_PID_SSN, :WK_PI_SSN, :WK_PI_PROD, :WK_PID_FROM_WH, :WK_PID_FROM_LOCN 
     DO
     BEGIN
        IF (WK_PI_SSN IS NOT NULL) THEN
        BEGIN
           IF (WK_CANCEL = 'C') THEN
           BEGIN
              /* UPDATE ISSN SET ISSN_STATUS = 'PA', */
              UPDATE ISSN SET ISSN_STATUS = :WK_CANCEL_SSN_STATUS,
                  WH_ID = :WK_PID_FROM_WH,
                  LOCN_ID = :WK_PID_FROM_LOCN,
                  PICK_ORDER = NULL
               WHERE SSN_ID = :WK_PID_SSN;
           END
           ELSE
           BEGIN
              UPDATE ISSN SET ISSN_STATUS = 'RS',
                  WH_ID = :WK_PID_FROM_WH,
                  LOCN_ID = :WK_PID_FROM_LOCN
               WHERE SSN_ID = :WK_PID_SSN;
           END
        END
        ELSE
        BEGIN
           SELECT CURRENT_QTY 
           FROM ISSN 
           WHERE SSN_ID = :WK_PID_SSN
           INTO :WK_IS_QTY;
           IF (WK_IS_QTY IS NULL) THEN
           BEGIN
              WK_IS_QTY = 0;
           END
           /* IF (WK_PID_QTY_PICKED > 0) THEN */
           IF (WK_IS_QTY > 0) THEN 
           BEGIN
              IF (STRLEN(WK_PID_FROM_LOCN) <> 2) THEN
              BEGIN
                 /* UPDATE ISSN SET ISSN_STATUS = 'PA', */
                 UPDATE ISSN SET ISSN_STATUS = :WK_CANCEL_SSN_STATUS,
                    WH_ID = :WK_PID_FROM_WH,
                    LOCN_ID = :WK_PID_FROM_LOCN
                 WHERE SSN_ID = :WK_PID_SSN;
              END
              ELSE
              BEGIN
                 /* UPDATE ISSN SET ISSN_STATUS = 'PA', */
                 UPDATE ISSN SET ISSN_STATUS = :WK_CANCEL_SSN_STATUS,
                    WH_ID = :WK_DEFAULT2_WH_ID,
                    LOCN_ID = :WK_DEFAULT2_LOCN_ID
                 WHERE SSN_ID = :WK_PID_SSN;
              END
           END
           ELSE
           BEGIN
              UPDATE ISSN SET ISSN_STATUS = 'XX' ,
                 WH_ID = 'XX',
                 LOCN_ID = '00000000'
              WHERE SSN_ID = :WK_PID_SSN;
           END

        END
     END
     IF (WK_CANCEL = 'C') THEN
     BEGIN
        UPDATE PICK_ORDER
           SET PICK_STATUS = 'CN',
           ORDER_CANCELLED = 'NOW'
           WHERE PICK_ORDER IN (SELECT DISTINCT PICK_ORDER FROM PICK_ITEM WHERE DEVICE_ID = :WK_DEVICE);
        IF (WK_DO_UCIS = 'T') THEN
        BEGIN
           /* now send of trans to update remote status */
           WK_GM_MESSAGE = '';
           SELECT MESSAGE_ID 
           FROM GET_NEXT_MESSAGE 
           INTO :WK_GM_MESSAGE;
           WK_T4_DELIM = '|';
           WK_T4_SOURCE = 'SSSSSS' ;
           FOR
              SELECT DISTINCT PICK_ORDER 
              FROM PICK_ITEM 
              WHERE DEVICE_ID = :WK_DEVICE
              INTO :WK_PI_ORDER
           DO
           BEGIN
              WK_T4_TRAN_DATA = WK_USER || WK_T4_DELIM ;
              WK_T4_TRAN_DATA = WK_T4_TRAN_DATA || WK_DEVICE || WK_T4_DELIM ;
              WK_T4_TRAN_DATA = WK_T4_TRAN_DATA || WK_GM_MESSAGE || WK_T4_DELIM ;
              WK_T4_TRAN_DATA = WK_T4_TRAN_DATA || '<ContactInstanceID>' || WK_PI_ORDER || WK_T4_DELIM ;
              WK_T4_TRAN_DATA = WK_T4_TRAN_DATA || '<ContactInstanceStatusCode>CN' || WK_T4_DELIM ;
              WK_T4_TRAN_DATA = WK_T4_TRAN_DATA || '<UpdateDateTime>' || MER_YEAR('NOW') || '-' || LPAD(MER_MONTH('NOW'),'0',2) || '-' || LPAD(MER_DAY('NOW'),'0',2) || 'T' || LPAD(MER_HOUR('NOW'),'0',2) || ':' || LPAD(MER_MINUTE('NOW'),'0',2) || ':' || LPAD(SEC('NOW'),'0',2) || WK_T4_DELIM ;
              SELECT REC_ID FROM ADD_TRAN_V4 ( 'V4', 'UCIS','S',
                 NEW.TRN_DATE,
                 :WK_T4_DELIM,
                 NEW.PERSON_ID,
                 NEW.DEVICE_ID,
                 :WK_GM_MESSAGE,
                 :WK_T4_TRAN_DATA,
                 'F','','MASTER',0,
                 :WK_T4_SOURCE)
              INTO :WK_NEW_RECORD;
           END
           EXECUTE PROCEDURE ADD_MESSAGE_V4 ( 
              :WK_GM_MESSAGE,
             'V4', 'UCIS','S',
              NEW.TRN_DATE,
              NEW.PERSON_ID,
              NEW.DEVICE_ID,
              :WK_CN_PRIORITY,
              'WS','',NULL);
        END 
     END
     /* update pick item part picked - from pid */
     /*    AND (PICK_DETAIL_STATUS = 'PG'
           OR (PICK_DETAIL_STATUS = 'PL')) */
     FOR SELECT SUM(QTY_PICKED), PICK_LABEL_NO 
         FROM PICK_ITEM_DETAIL
         WHERE DEVICE_ID = :WK_DEVICE 
           AND POS(:WK_CANCEL_PICK_STATUS,PICK_DETAIL_STATUS,0,1) > -1
         GROUP BY PICK_LABEL_NO
         INTO :WK_PID_PICKED_QTY, :WK_LABEL_NO
     DO
     BEGIN
        SELECT PICKED_QTY, PROD_ID 
        FROM PICK_ITEM
        WHERE PICK_LABEL_NO = :WK_LABEL_NO
         INTO :WK_PI_PICKED_QTY, :WK_PI_PROD;
        WK_PI_PICKED_QTY = WK_PI_PICKED_QTY - WK_PID_PICKED_QTY; 
        /* recalc pick_item status */
        IF (WK_PI_PICKED_QTY = 0) THEN
        BEGIN
           IF (WK_CANCEL = 'C') THEN
           BEGIN
              WK_PI_STATUS = 'CN';
           END
           ELSE
           BEGIN
              WK_PI_STATUS = 'OP';
           END
        END
        ELSE
        BEGIN
           WK_PI_STATUS = 'PG';
        END
        IF (WK_PI_STATUS = 'CN' OR WK_PI_STATUS = 'OP') THEN
        BEGIN
           UPDATE PICK_ITEM
           SET  PICK_LINE_STATUS = :WK_PI_STATUS,
                DEVICE_ID  = NULL,
                PICKED_QTY = :WK_PI_PICKED_QTY
           WHERE PICK_LABEL_NO = :WK_LABEL_NO;
        END
        ELSE
        BEGIN
           UPDATE PICK_ITEM
           SET  PICK_LINE_STATUS = :WK_PI_STATUS,
                PICKED_QTY = :WK_PI_PICKED_QTY
           WHERE PICK_LABEL_NO = :WK_LABEL_NO;
        END
        UPDATE PICK_ITEM_DETAIL
        SET  PICK_DETAIL_STATUS = 'CN'
        WHERE PICK_LABEL_NO = :WK_LABEL_NO
          AND (PICK_DETAIL_STATUS IN ('XX'));
        /* send to remote the available qty of the prod */
        IF (WK_DO_UASL = 'T') THEN
        BEGIN
           EXECUTE PROCEDURE SEND_PICKABLE_STOCK (:WK_PI_PROD,
              :WK_USER,
              :WK_DEVICE,
              :WK_DATE);
        END
     END
     IF (WK_CANCEL = 'C') THEN
     BEGIN
        WK_PI_STATUS = 'CN';
     END
     ELSE
     BEGIN
        WK_PI_STATUS = 'OP';
     END
     /* update pick item  status for unpick - from pick item */
     /*    AND (PICK_LINE_STATUS = 'PG'
           OR (PICK_LINE_STATUS = 'PL')) */
     FOR SELECT PICK_LABEL_NO, PROD_ID 
         FROM PICK_ITEM
         WHERE DEVICE_ID = :WK_DEVICE 
           AND POS(:WK_CANCEL_PICK_STATUS,PICK_LINE_STATUS,0,1) > -1
         INTO :WK_LABEL_NO, :WK_PI_PROD
     DO
     BEGIN
        WK_FOUND = 0;
     /*   (PICK_DETAIL_STATUS = 'PG'
           OR (PICK_DETAIL_STATUS = 'PL')) */
        SELECT COUNT(*) FROM PICK_ITEM_DETAIL
           WHERE POS(:WK_CANCEL_PICK_STATUS,PICK_DETAIL_STATUS,0,1) > -1
             AND PICK_LABEL_NO = :WK_LABEL_NO
           INTO :WK_FOUND;
        IF (WK_FOUND = 0) THEN
        BEGIN
           /* no details for pick item */
           UPDATE PICK_ITEM
           SET  PICK_LINE_STATUS = :WK_PI_STATUS,
                DEVICE_ID = NULL
           WHERE DEVICE_ID = :WK_DEVICE 
             AND PICK_LABEL_NO = :WK_LABEL_NO;
           /* send to remote the available qty of the prod */
           IF (WK_DO_UASL = 'T') THEN
           BEGIN
              EXECUTE PROCEDURE SEND_PICKABLE_STOCK (:WK_PI_PROD,
                 :WK_USER,
                 :WK_DEVICE,
                 :WK_DATE);
           END
        END
     END
     /* update pick item for 'AL' */
     FOR SELECT PROD_ID, PICK_LABEL_NO
     FROM PICK_ITEM 
     WHERE DEVICE_ID = :WK_DEVICE 
       AND PICK_LINE_STATUS IN ('AL')
     INTO :WK_PI_PROD, :WK_LABEL_NO
     DO
     BEGIN
        UPDATE PICK_ITEM
        SET  PICK_LINE_STATUS = :WK_PI_STATUS,
             DEVICE_ID = NULL
        WHERE PICK_LABEL_NO = :WK_LABEL_NO; 
        /* send to remote the available qty of the prod */
        IF (WK_DO_UASL = 'T') THEN
        BEGIN
           EXECUTE PROCEDURE SEND_PICKABLE_STOCK (:WK_PI_PROD,
              :WK_USER,
              :WK_DEVICE,
              :WK_DATE);
        END
     END
     /* update pick item detail for picked */
     /*    AND (PICK_DETAIL_STATUS = 'PG'
           OR (PICK_DETAIL_STATUS = 'PL')) */
     UPDATE PICK_ITEM_DETAIL
     SET  PICK_DETAIL_STATUS = 'XX',
          DEVICE_ID = LOWER(:WK_DEVICE)
     WHERE DEVICE_ID = :WK_DEVICE 
        AND POS(:WK_CANCEL_PICK_STATUS,PICK_DETAIL_STATUS,0,1) > -1;
     UPDATE PICK_LOCATION
     SET PICK_LOCATION_STATUS='CN'
     WHERE DEVICE_ID = :WK_DEVICE ;

     
     IF (WK_CANCEL = 'D') THEN
        EXECUTE PROCEDURE UPDATE_TRAN (WK_RECORD, 'F','Cannot Cancel Already Part Despatched');
     ELSE
        EXECUTE PROCEDURE UPDATE_TRAN (WK_RECORD, 'T','Processed successfully');
/*
   EXECUTE PROCEDURE ADD_TRAN(
        :WK_DEVICE,
        '',
        '',
        'PKUA',
        'I',
        :WK_DATE,
        '',
        0,
        'F',
        '',
        'MASTER',
        0,
        '',
        'SSSSSSSSS',
        :WK_USER,
        :WK_DEVICE);
*/
   /* EXECUTE PROCEDURE TRAN_ARCHIVE; */
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_PKCN FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 52 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_DEVICE CHAR(2);
DECLARE VARIABLE WK_PI_PICKED_QTY INTEGER;
DECLARE VARIABLE WK_PID_PICKED_QTY INTEGER;
DECLARE VARIABLE WK_LABEL_NO VARCHAR(10);
DECLARE VARIABLE WK_LABEL_NO2 VARCHAR(10);
DECLARE VARIABLE WK_PI_STATUS CHAR(2);
DECLARE VARIABLE WK_RECORD INTEGER;
DECLARE VARIABLE WK_PID_SSN VARCHAR(20);
DECLARE VARIABLE WK_PI_SSN VARCHAR(20);
DECLARE VARIABLE WK_PI_PROD VARCHAR(30);
DECLARE VARIABLE WK_FOUND INTEGER;
DECLARE VARIABLE WK_DATE TIMESTAMP;
DECLARE VARIABLE WK_USER VARCHAR(10);
DECLARE VARIABLE WK_CANCEL CHAR(1);
DECLARE VARIABLE WK_PID_FROM_WH CHAR(2);
DECLARE VARIABLE WK_PID_FROM_LOCN VARCHAR(10);
DECLARE VARIABLE WK_CANCEL_SSN_STATUS CHAR(2);
DECLARE VARIABLE WK_DO_UASL CHAR(1);
DECLARE VARIABLE WK_CANCEL_PICK_STATUS VARCHAR(40);

BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'PKCN') THEN
  BEGIN
     WK_DEVICE = NEW.DEVICE_ID;
     WK_LABEL_NO = NEW.SUB_LOCN_ID;
     WK_RECORD = NEW.RECORD_ID;
     WK_DATE = NEW.TRN_DATE;
     WK_USER = NEW.PERSON_ID;
     WK_CANCEL = NEW.TRN_CODE;
     WK_CANCEL_SSN_STATUS = 'PA';
     SELECT PICK_CANCEL_SSN_STATUS ,SEND_UASL_V4,
            PICK_CANCEL_PK_STATUS
     FROM CONTROL 
     INTO :WK_CANCEL_SSN_STATUS, :WK_DO_UASL,
          :WK_CANCEL_PICK_STATUS;
     WK_FOUND = 0;
     /* get the current label no to cancel */
     /* WHERE (PICK_LINE_STATUS IN ('AL','PG','PL','DS') */ 
     SELECT FIRST 1 1, PICK_LABEL_NO, SSN_ID, PROD_ID   
     FROM PICK_ITEM 
     WHERE (PICK_LINE_STATUS IN ('AL') 
           OR  POS(:WK_CANCEL_PICK_STATUS,PICK_LINE_STATUS,0,1) > -1
            )
       AND DEVICE_ID = :WK_DEVICE
       AND PICK_LABEL_NO = :WK_LABEL_NO
     ORDER BY PICK_LOCATION
     INTO :WK_FOUND, :WK_LABEL_NO, :WK_PI_SSN, :WK_PI_PROD;

     IF (WK_FOUND = 1) THEN
     BEGIN
        /* check whether can cancel */
        IF (WK_CANCEL = 'C') THEN
        BEGIN
           WK_FOUND = 0;
           /*   AND PID.PICK_DETAIL_STATUS STARTING 'D' */
           SELECT FIRST 1 1
           FROM PICK_ITEM PI
           JOIN PICK_ITEM_DETAIL PID ON PI.PICK_LABEL_NO = PID.PICK_LABEL_NO
           WHERE PI.PICK_LABEL_NO = :WK_LABEL_NO
              AND PID.PICK_DETAIL_STATUS IN ('DX','DC', 'DI','DQ')
            INTO :WK_FOUND;
           IF (WK_FOUND = 1) THEN
           BEGIN
              /* found pid records for this line - previously despatched */
              WK_CANCEL = 'D';
           END
        END

        /* save prev status in issn for move back */
        /*    AND (PICK_DETAIL_STATUS IN ('AL', 'PG', 'PL', 'DS') */
        FOR SELECT SSN_ID, FROM_WH_ID, FROM_LOCN_ID 
            FROM PICK_ITEM_DETAIL
            WHERE DEVICE_ID = :WK_DEVICE 
              AND PICK_LABEL_NO = :WK_LABEL_NO
              AND (PICK_DETAIL_STATUS IN ('AL' )
                   OR  POS(:WK_CANCEL_PICK_STATUS,PICK_DETAIL_STATUS,0,1) > -1
               )
            INTO :WK_PID_SSN, :WK_PID_FROM_WH, :WK_PID_FROM_LOCN
        DO
        BEGIN
           IF (WK_PI_SSN IS NOT NULL) THEN
           BEGIN
              IF (WK_CANCEL = 'C') THEN
              BEGIN
                 /* UPDATE ISSN SET ISSN_STATUS = 'PA', */
                 UPDATE ISSN SET ISSN_STATUS = :WK_CANCEL_SSN_STATUS,
                     WH_ID = :WK_PID_FROM_WH,
                     LOCN_ID = :WK_PID_FROM_LOCN,
                     PICK_ORDER = NULL
                  WHERE SSN_ID = :WK_PID_SSN;
              END
              ELSE
              BEGIN
                 UPDATE ISSN SET ISSN_STATUS = 'RS',
                     WH_ID = :WK_PID_FROM_WH,
                     LOCN_ID = :WK_PID_FROM_LOCN
                     WHERE SSN_ID = :WK_PID_SSN;
              END
           END
           ELSE
           BEGIN
              /* UPDATE ISSN SET ISSN_STATUS = 'PA', */
              UPDATE ISSN SET ISSN_STATUS = :WK_CANCEL_SSN_STATUS,
                     WH_ID = :WK_PID_FROM_WH,
                     LOCN_ID = :WK_PID_FROM_LOCN
               WHERE SSN_ID = :WK_PID_SSN;
           END
        END
        /*    AND (PICK_DETAIL_STATUS IN ('PG', 'PL', 'DS') */
        FOR SELECT SUM(QTY_PICKED)
            FROM PICK_ITEM_DETAIL
            WHERE DEVICE_ID = :WK_DEVICE 
              AND PICK_LABEL_NO = :WK_LABEL_NO
              AND (
                   POS(:WK_CANCEL_PICK_STATUS,PICK_DETAIL_STATUS,0,1) > -1
               )
            INTO :WK_PID_PICKED_QTY
        DO
        BEGIN
           SELECT PICKED_QTY 
           FROM PICK_ITEM
           WHERE PICK_LABEL_NO = :WK_LABEL_NO
            INTO :WK_PI_PICKED_QTY;
           WK_PI_PICKED_QTY = WK_PI_PICKED_QTY - WK_PID_PICKED_QTY; 
           /* recalc pick_item status */
           IF (WK_PI_PICKED_QTY = 0) THEN
           BEGIN
              IF (WK_CANCEL = 'C') THEN
              BEGIN
                 WK_PI_STATUS = 'CN';
              END
              ELSE
              BEGIN
                 WK_PI_STATUS = 'UP';
              END
           END
           ELSE
           BEGIN
              WK_PI_STATUS = 'PG';
           END
           UPDATE PICK_ITEM
           SET  PICK_LINE_STATUS = :WK_PI_STATUS,
                PICKED_QTY = :WK_PI_PICKED_QTY
           WHERE PICK_LABEL_NO = :WK_LABEL_NO;
        END
        IF (WK_CANCEL = 'C') THEN
        BEGIN
           WK_PI_STATUS = 'CN';
        END
        ELSE
        BEGIN
           WK_PI_STATUS = 'UP';
        END
        /*    AND (PICK_LINE_STATUS IN ('PG','PL','DS') */
        FOR SELECT PICK_LABEL_NO 
            FROM PICK_ITEM
            WHERE DEVICE_ID = :WK_DEVICE 
              AND PICK_LABEL_NO = :WK_LABEL_NO
              AND (
                   POS(:WK_CANCEL_PICK_STATUS,PICK_LINE_STATUS,0,1) > -1
               )
            INTO :WK_LABEL_NO2
        DO
        BEGIN
           WK_FOUND = 0;
           /* WHERE (PICK_DETAIL_STATUS IN ('PG','PL','DS') */
           SELECT COUNT(*) FROM PICK_ITEM_DETAIL
              WHERE (
                   POS(:WK_CANCEL_PICK_STATUS,PICK_DETAIL_STATUS,0,1) > -1
                 )
                AND PICK_LABEL_NO = :WK_LABEL_NO
              INTO :WK_FOUND;
           IF (WK_FOUND = 0) THEN
           BEGIN
              /* no details for pick item */
              UPDATE PICK_ITEM
              SET  PICK_LINE_STATUS = :WK_PI_STATUS,
                   DEVICE_ID = NULL
              WHERE DEVICE_ID = :WK_DEVICE 
                AND PICK_LABEL_NO = :WK_LABEL_NO;
           END
        END
        UPDATE PICK_ITEM
        SET  PICK_LINE_STATUS = :WK_PI_STATUS,
             DEVICE_ID = NULL
        WHERE DEVICE_ID = :WK_DEVICE 
          AND PICK_LABEL_NO = :WK_LABEL_NO
          AND PICK_LINE_STATUS IN ('AL');
        UPDATE PICK_ITEM_DETAIL
        SET  PICK_DETAIL_STATUS = 'CN'
        WHERE PICK_LABEL_NO = :WK_LABEL_NO
          AND (PICK_DETAIL_STATUS IN ('XX'));
        /*  AND (PICK_DETAIL_STATUS IN ('PG','PL','DS') */
        UPDATE PICK_ITEM_DETAIL
        SET  PICK_DETAIL_STATUS = 'XX',
             DEVICE_ID = LOWER(:WK_DEVICE)
        WHERE DEVICE_ID = :WK_DEVICE 
          AND PICK_LABEL_NO = :WK_LABEL_NO
          AND (
                   POS(:WK_CANCEL_PICK_STATUS,PICK_DETAIL_STATUS,0,1) > -1
            );
        
        IF (WK_CANCEL = 'C') THEN
        BEGIN
           SELECT PROD_ID
           FROM PICK_ITEM 
           WHERE PICK_LABEL_NO = :WK_LABEL_NO
           INTO :WK_PI_PROD;
           /* send to remote the available qty of the prod */
           IF (WK_DO_UASL = 'T') THEN
           BEGIN
              EXECUTE PROCEDURE SEND_PICKABLE_STOCK (:WK_PI_PROD,
                 :WK_USER,
                 :WK_DEVICE,
                 :WK_DATE);
           END
        END
        IF (WK_CANCEL = 'D') THEN
           EXECUTE PROCEDURE UPDATE_TRAN (WK_RECORD, 'F','Cannot Cancel Already Part Despatched');
        ELSE
           EXECUTE PROCEDURE UPDATE_TRAN (WK_RECORD, 'T','Processed successfully');
/*
      EXECUTE PROCEDURE ADD_TRAN(
           :WK_DEVICE,
           '',
           '',
           'PKUA',
           'I',
           :WK_DATE,
           '',
           0,
           'F',
           '',
           'MASTER',
           0,
           '',
           'SSSSSSSSS',
           :WK_USER,
           :WK_DEVICE);
*/
      /* EXECUTE PROCEDURE TRAN_ARCHIVE; */
   END
   ELSE
      EXECUTE PROCEDURE UPDATE_TRAN (WK_RECORD, 'F','Pick Item Not able to be Cancelled');
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_PKCO FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 52 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_DEVICE CHAR(2);
DECLARE VARIABLE WK_PI_PICKED_QTY INTEGER;
DECLARE VARIABLE WK_PID_PICKED_QTY INTEGER;
DECLARE VARIABLE WK_LABEL_NO VARCHAR(10);
DECLARE VARIABLE WK_PI_STATUS CHAR(2);
DECLARE VARIABLE WK_PI_SSN VARCHAR(20);
DECLARE VARIABLE WK_PI_PROD VARCHAR(30);
DECLARE VARIABLE WK_RECORD INTEGER;
DECLARE VARIABLE WK_PID_SSN VARCHAR(20);
DECLARE VARIABLE WK_DATE TIMESTAMP;
DECLARE VARIABLE WK_USER VARCHAR(10);
DECLARE VARIABLE WK_FOUND INTEGER;
DECLARE VARIABLE WK_CANCEL CHAR(1);
DECLARE VARIABLE WK_PID_FROM_WH CHAR(2);
DECLARE VARIABLE WK_PID_FROM_LOCN VARCHAR(10);
DECLARE VARIABLE WK_CANCEL_SSN_STATUS CHAR(2);
DECLARE VARIABLE WK_PI_ORDER VARCHAR(15);
DECLARE VARIABLE WK_DO_UASL CHAR(1);
DECLARE VARIABLE WK_DO_UCIS CHAR(1);
DECLARE VARIABLE WK_GM_MESSAGE VARCHAR(10);
DECLARE VARIABLE WK_T4_DELIM CHAR(1);
DECLARE VARIABLE WK_T4_TRAN_DATA VARCHAR(1024);
DECLARE VARIABLE WK_T4_SOURCE VARCHAR(512);
DECLARE VARIABLE WK_NEW_RECORD INTEGER;
DECLARE VARIABLE WK_CN_PRIORITY SMALLINT;
DECLARE VARIABLE WK_ORDER VARCHAR(30);
DECLARE VARIABLE WK_PID_QTY_PICKED  INTEGER;
DECLARE VARIABLE WK_DEFAULT_LOCN_ID VARCHAR(10);
DECLARE VARIABLE WK_DEFAULT_WH_ID VARCHAR(2);
DECLARE VARIABLE WK_IS_QTY  INTEGER;
DECLARE VARIABLE WK_DEFAULT2_LOCN_ID VARCHAR(10);
DECLARE VARIABLE WK_DEFAULT2_WH_ID VARCHAR(2);

BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'PKCO') THEN
  BEGIN
     WK_DEVICE = NEW.DEVICE_ID;
     WK_DATE = NEW.TRN_DATE;
     WK_USER = NEW.PERSON_ID;
     WK_RECORD = NEW.RECORD_ID;
     WK_CANCEL = NEW.TRN_CODE;
     WK_ORDER = NEW.OBJECT;
     WK_CANCEL_SSN_STATUS = 'PA';
     WK_CN_PRIORITY = 0;
     SELECT PICK_CANCEL_SSN_STATUS, 
            SEND_UASL_V4, 
            SEND_UCIS_V4,
            DEFAULT_PICK_PRIORITY
     FROM CONTROL 
     INTO :WK_CANCEL_SSN_STATUS, 
          :WK_DO_UASL, 
          :WK_DO_UCIS,
          :WK_CN_PRIORITY;

     /* check whether can cancel */
     IF (WK_CANCEL = 'C') THEN
     BEGIN
        WK_FOUND = 0;
        BEGIN
           /* AND PID.PICK_DETAIL_STATUS IN ('DC','DI','DX') */
           SELECT FIRST 1 1
           FROM PICK_ITEM PI
           JOIN PICK_ITEM_DETAIL PID ON PI.PICK_LABEL_NO = PID.PICK_LABEL_NO
           WHERE PI.PICK_ORDER = :WK_ORDER
           AND PI.PICK_LABEL_NO IN (
              SELECT PID2.PICK_LABEL_NO 
               FROM PICK_ITEM_DETAIL PID2
               WHERE PID2.PICK_DETAIL_STATUS IN ('PG','PL','AL','DS')
                 AND PID2.DEVICE_ID = :WK_DEVICE 
               GROUP BY PID2.PICK_LABEL_NO)
              AND PID.PICK_DETAIL_STATUS IN ('DC','DI','DX', 'DQ')
            INTO :WK_FOUND;
        END
        IF (WK_FOUND = 1) THEN
        BEGIN
           /* found pid records for this device - already part despatched */
           WK_CANCEL = 'D';
        END
     END

     FOR SELECT LOCATION.WH_ID, LOCATION.LOCN_ID
         FROM CONTROL
         JOIN LOCATION ON CONTROL.DEFAULT_WH_ID = LOCATION.WH_ID
         WHERE LOCATION.MOVE_STAT = 'RC'
         INTO :WK_DEFAULT_WH_ID, :WK_DEFAULT_LOCN_ID
     DO
     BEGIN
        WK_DEFAULT2_WH_ID = WK_DEFAULT_WH_ID;
        WK_DEFAULT2_LOCN_ID = WK_DEFAULT_LOCN_ID;
     END
         
     /* save prev status  and from location in issn for move back */
     FOR SELECT PID.SSN_ID , PI.SSN_ID, PI.PROD_ID, PID.FROM_WH_ID, PID.FROM_LOCN_ID, PID.QTY_PICKED 
         FROM PICK_ITEM PI 
         JOIN PICK_ITEM_DETAIL PID ON PI.PICK_LABEL_NO = PID.PICK_LABEL_NO
         WHERE PI.PICK_ORDER  = :WK_ORDER 
           AND PID.PICK_DETAIL_STATUS IN ('PG','PL','DS')
           AND PID.DEVICE_ID = :WK_DEVICE 
         ORDER by PID.SSN_ID, PID.LAST_UPDATE_DATE DESC
         INTO :WK_PID_SSN, :WK_PI_SSN, :WK_PI_PROD, :WK_PID_FROM_WH, :WK_PID_FROM_LOCN, :WK_PID_QTY_PICKED 
     DO
     BEGIN
        IF (WK_PI_SSN IS NOT NULL) THEN
        BEGIN
           IF (WK_CANCEL = 'C' OR WK_CANCEL = 'K') THEN
           BEGIN
              /* UPDATE ISSN SET ISSN_STATUS = 'PA', */
              UPDATE ISSN SET ISSN_STATUS = :WK_CANCEL_SSN_STATUS,
                  WH_ID = :WK_PID_FROM_WH,
                  LOCN_ID = :WK_PID_FROM_LOCN,
                  PICK_ORDER = NULL
               WHERE SSN_ID = :WK_PID_SSN;
           END
           ELSE
           BEGIN
              UPDATE ISSN SET ISSN_STATUS = 'RS',
                  WH_ID = :WK_PID_FROM_WH,
                  LOCN_ID = :WK_PID_FROM_LOCN
               WHERE SSN_ID = :WK_PID_SSN;
           END
        END
        ELSE
        BEGIN
           IF (WK_PID_QTY_PICKED IS NULL) THEN
           BEGIN
              WK_PID_QTY_PICKED = 0;
           END
           SELECT CURRENT_QTY 
           FROM ISSN 
           WHERE SSN_ID = :WK_PID_SSN
           INTO :WK_IS_QTY;
           IF (WK_IS_QTY IS NULL) THEN
           BEGIN
              WK_IS_QTY = 0;
           END
           /* IF (WK_PID_QTY_PICKED > 0) THEN */
           IF (WK_IS_QTY > 0) THEN 
           BEGIN
              IF (STRLEN(WK_PID_FROM_LOCN) <> 2) THEN
              BEGIN
                 /* UPDATE ISSN SET ISSN_STATUS = 'PA', */
                 UPDATE ISSN SET ISSN_STATUS = :WK_CANCEL_SSN_STATUS,
                    WH_ID = :WK_PID_FROM_WH,
                    LOCN_ID = :WK_PID_FROM_LOCN
                 WHERE SSN_ID = :WK_PID_SSN;
              END
              ELSE
              BEGIN
                 /* UPDATE ISSN SET ISSN_STATUS = 'PA', */
                 UPDATE ISSN SET ISSN_STATUS = :WK_CANCEL_SSN_STATUS,
                    WH_ID = :WK_DEFAULT2_WH_ID,
                    LOCN_ID = :WK_DEFAULT2_LOCN_ID
                 WHERE SSN_ID = :WK_PID_SSN;
              END
           END
           ELSE
           BEGIN
              UPDATE ISSN SET ISSN_STATUS = 'XX' ,
                 WH_ID = 'XX',
                 LOCN_ID = '00000000'
              WHERE SSN_ID = :WK_PID_SSN;
           END

        END
     END
     IF (WK_CANCEL = 'C' OR WK_CANCEL = 'K') THEN
     BEGIN
        UPDATE PICK_ORDER
           SET PICK_STATUS = 'CN',
           ORDER_CANCELLED = 'NOW'
           WHERE PICK_ORDER = :WK_ORDER;
        IF (WK_DO_UCIS = 'T') THEN
        BEGIN
           /* now send of trans to update remote status */
           WK_GM_MESSAGE = '';
           SELECT MESSAGE_ID 
           FROM GET_NEXT_MESSAGE 
           INTO :WK_GM_MESSAGE;
           WK_T4_DELIM = '|';
           WK_T4_SOURCE = 'SSSSSS' ;
           WK_PI_ORDER = WK_ORDER;
           BEGIN
              WK_T4_TRAN_DATA = WK_USER || WK_T4_DELIM ;
              WK_T4_TRAN_DATA = WK_T4_TRAN_DATA || WK_DEVICE || WK_T4_DELIM ;
              WK_T4_TRAN_DATA = WK_T4_TRAN_DATA || WK_GM_MESSAGE || WK_T4_DELIM ;
              WK_T4_TRAN_DATA = WK_T4_TRAN_DATA || '<ContactInstanceID>' || WK_PI_ORDER || WK_T4_DELIM ;
              WK_T4_TRAN_DATA = WK_T4_TRAN_DATA || '<ContactInstanceStatusCode>CN' || WK_T4_DELIM ;
              WK_T4_TRAN_DATA = WK_T4_TRAN_DATA || '<UpdateDateTime>' || MER_YEAR('NOW') || '-' || LPAD(MER_MONTH('NOW'),'0',2) || '-' || LPAD(MER_DAY('NOW'),'0',2) || 'T' || LPAD(MER_HOUR('NOW'),'0',2) || ':' || LPAD(MER_MINUTE('NOW'),'0',2) || ':' || LPAD(SEC('NOW'),'0',2) || WK_T4_DELIM ;
              SELECT REC_ID FROM ADD_TRAN_V4 ( 'V4', 'UCIS','S',
                 NEW.TRN_DATE,
                 :WK_T4_DELIM,
                 NEW.PERSON_ID,
                 NEW.DEVICE_ID,
                 :WK_GM_MESSAGE,
                 :WK_T4_TRAN_DATA,
                 'F','','MASTER',0,
                 :WK_T4_SOURCE)
              INTO :WK_NEW_RECORD;
           END
           EXECUTE PROCEDURE ADD_MESSAGE_V4 ( 
              :WK_GM_MESSAGE,
             'V4', 'UCIS','S',
              NEW.TRN_DATE,
              NEW.PERSON_ID,
              NEW.DEVICE_ID,
              :WK_CN_PRIORITY,
              'WS','',NULL);
        END 
     END
     FOR SELECT SUM(PID.QTY_PICKED), PID.PICK_LABEL_NO,PI.PICKED_QTY, PI.PROD_ID 
         FROM PICK_ITEM PI
         JOIN PICK_ITEM_DETAIL PID ON PID.PICK_LABEL_NO = PI.PICK_LABEL_NO
         WHERE PI.PICK_ORDER= :WK_ORDER 
           AND PID.PICK_DETAIL_STATUS IN ('PG','PL','DS')
           AND PID.DEVICE_ID = :WK_DEVICE 
         GROUP BY PID.PICK_LABEL_NO,PI.PICKED_QTY, PI.PROD_ID
         INTO :WK_PID_PICKED_QTY, :WK_LABEL_NO,:WK_PI_PICKED_QTY, :WK_PI_PROD
     DO
     BEGIN
        WK_PI_PICKED_QTY = WK_PI_PICKED_QTY - WK_PID_PICKED_QTY; 
        /* recalc pick_item status */
        IF (WK_PI_PICKED_QTY = 0) THEN
        BEGIN
           IF (WK_CANCEL = 'C' OR WK_CANCEL= 'K') THEN
           BEGIN
              WK_PI_STATUS = 'CN';
           END
           ELSE
           BEGIN
              WK_PI_STATUS = 'OP';
           END
        END
        ELSE
        BEGIN
           WK_PI_STATUS = 'PG';
        END
        IF (WK_PI_STATUS = 'CN' OR WK_PI_STATUS = 'OP') THEN
        BEGIN
           UPDATE PICK_ITEM
           SET  PICK_LINE_STATUS = :WK_PI_STATUS,
                DEVICE_ID = NULL,
                PICKED_QTY = :WK_PI_PICKED_QTY
           WHERE PICK_LABEL_NO = :WK_LABEL_NO;
        END
        ELSE
        BEGIN
           UPDATE PICK_ITEM
           SET  PICK_LINE_STATUS = :WK_PI_STATUS,
                PICKED_QTY = :WK_PI_PICKED_QTY
           WHERE PICK_LABEL_NO = :WK_LABEL_NO;
        END
        UPDATE PICK_ITEM_DETAIL
        SET  PICK_DETAIL_STATUS = 'CN'
        WHERE PICK_LABEL_NO = :WK_LABEL_NO
          AND (PICK_DETAIL_STATUS IN ('XX'));
        /* send to remote the available qty of the prod */
        IF (WK_DO_UASL = 'T') THEN
        BEGIN
           EXECUTE PROCEDURE SEND_PICKABLE_STOCK (:WK_PI_PROD,
              :WK_USER,
              :WK_DEVICE,
              :WK_DATE);
        END
     END
     IF (WK_CANCEL = 'C' OR WK_CANCEL = 'K') THEN
     BEGIN
        WK_PI_STATUS = 'CN';
     END
     ELSE
     BEGIN
        WK_PI_STATUS = 'OP';
     END
     FOR SELECT PICK_LABEL_NO, PROD_ID 
         FROM PICK_ITEM
         WHERE PICK_ORDER = :WK_ORDER  
           AND PICK_LINE_STATUS IN ('PG','PL','DS')
           AND DEVICE_ID = :WK_DEVICE 
         INTO :WK_LABEL_NO, :WK_PI_PROD
     DO
     BEGIN
        WK_FOUND = 0;
        SELECT COUNT(*) FROM PICK_ITEM_DETAIL
           WHERE PICK_DETAIL_STATUS IN ('PG','PL','DS')
             AND PICK_LABEL_NO = :WK_LABEL_NO
           INTO :WK_FOUND;
        IF (WK_FOUND = 0) THEN
        BEGIN
           /* no details for pick item */
           UPDATE PICK_ITEM
           SET  PICK_LINE_STATUS = :WK_PI_STATUS,
                   DEVICE_ID = NULL
           WHERE PICK_LABEL_NO = :WK_LABEL_NO
           AND DEVICE_ID = :WK_DEVICE;

           /* send to remote the available qty of the prod */
           IF (WK_DO_UASL = 'T') THEN
           BEGIN
              EXECUTE PROCEDURE SEND_PICKABLE_STOCK (:WK_PI_PROD,
                 :WK_USER,
                 :WK_DEVICE,
                 :WK_DATE);
           END
        END
     END
     FOR SELECT PROD_ID, PICK_LABEL_NO
     FROM PICK_ITEM 
     WHERE PICK_ORDER = :WK_ORDER 
       AND PICK_LINE_STATUS IN ('AL')
       AND DEVICE_ID = :WK_DEVICE 
     INTO :WK_PI_PROD, :WK_LABEL_NO
     DO
     BEGIN
        UPDATE PICK_ITEM
        SET  PICK_LINE_STATUS = :WK_PI_STATUS,
             DEVICE_ID = NULL
        WHERE PICK_LABEL_NO = :WK_LABEL_NO; 
        /* send to remote the available qty of the prod */
        IF (WK_DO_UASL = 'T') THEN
        BEGIN
           EXECUTE PROCEDURE SEND_PICKABLE_STOCK (:WK_PI_PROD,
              :WK_USER,
              :WK_DEVICE,
              :WK_DATE);
        END
     END
     UPDATE PICK_ITEM_DETAIL
     SET  PICK_DETAIL_STATUS = 'XX',
          DEVICE_ID = LOWER(:WK_DEVICE)
     WHERE PICK_LABEL_NO IN (SELECT PICK_LABEL_NO FROM PICK_ITEM WHERE PICK_ORDER = :WK_ORDER) 
       AND PICK_DETAIL_STATUS IN ('PG','PL','DS')
       AND DEVICE_ID = :WK_DEVICE;
     
     IF (WK_CANCEL = 'D') THEN
        EXECUTE PROCEDURE UPDATE_TRAN (WK_RECORD, 'F','Cannot Cancel Already Part Despatched');
     ELSE
        EXECUTE PROCEDURE UPDATE_TRAN (WK_RECORD, 'T','Processed successfully');
   /* EXECUTE PROCEDURE TRAN_ARCHIVE; */
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_PKDL FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 53 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_DEVICE CHAR(2);
DECLARE VARIABLE WK_USER VARCHAR(10);
DECLARE VARIABLE WK_RECORD INTEGER;
DECLARE VARIABLE WK_DIRECTORY VARCHAR(80);
DECLARE VARIABLE WK_FILENAME VARCHAR(80);
DECLARE VARIABLE WK_RESULT INTEGER;
DECLARE VARIABLE WK_PI_LABEL VARCHAR(7);
DECLARE VARIABLE WK_PI_LOCATION VARCHAR(10);
DECLARE VARIABLE WK_LABEL_LINE VARCHAR(200);
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'PKDL') THEN
  BEGIN
     WK_DEVICE = NEW.WH_ID;
     WK_USER = NEW.PERSON_ID;
     WK_RECORD = NEW.RECORD_ID;

     WK_DIRECTORY = '';
     SELECT FTP_DIRECTORY
         FROM CONTROL
         INTO :WK_DIRECTORY;
      WK_FILENAME = WK_DIRECTORY || WK_DEVICE || '.pk';
     /* clear devices file */
      WK_RESULT = FILE_DELETE(WK_FILENAME);
     FOR 
        SELECT PICK_LABEL_NO, 
               DESPATCH_LOCATION
               FROM PICK_ITEM
               WHERE PICK_LINE_STATUS IN ('PL')
                 AND DEVICE_ID = :WK_DEVICE
               INTO :WK_PI_LABEL, :WK_PI_LOCATION 
     DO
     BEGIN
           /* add to devices file */
           WK_LABEL_LINE = 'UPDATE PICK_QTYS SET DESPATCH_LOCATION = ' ||
             SQUOTEDSTR(WK_PI_LOCATION ) ||
             ' WHERE PICK_LABEL_NO = ' ||
             SQUOTEDSTR(WK_PI_LABEL ) || ')';
           WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE);
     END

   EXECUTE PROCEDURE UPDATE_TRAN (WK_RECORD, 'T','Processed successfully');
   EXECUTE PROCEDURE TRAN_ARCHIVE;
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_PLPK FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 54 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_DEVICE CHAR(2);
DECLARE VARIABLE WK_USER VARCHAR(10);
DECLARE VARIABLE WK_RECORD INTEGER;
DECLARE VARIABLE WK_QTY INTEGER;
DECLARE VARIABLE WK_DATE TIMESTAMP;
DECLARE VARIABLE WK_PRINTER VARCHAR(40);
DECLARE VARIABLE WK_LABEL VARCHAR(30);
DECLARE VARIABLE WK_DIRECTORY VARCHAR(80);
DECLARE VARIABLE WK_FILENAME VARCHAR(80);
DECLARE VARIABLE WK_LABEL_LINE VARCHAR(525);
DECLARE VARIABLE WK_RESULT INTEGER;
DECLARE VARIABLE WK_PI_LABEL VARCHAR(7);
DECLARE VARIABLE WK_PI_WH_ID CHAR(2);
DECLARE VARIABLE WK_PI_LOCN_ID VARCHAR(10);
DECLARE VARIABLE WK_PI_PICK_ORDER_QTY INTEGER;
DECLARE VARIABLE WK_PI_PROD_ID VARCHAR(30);
DECLARE VARIABLE WK_PI_PICK_ORDER VARCHAR(15);
DECLARE VARIABLE WK_PI_CONTACT VARCHAR(50);
DECLARE VARIABLE WK_PO_CONTACT VARCHAR(50);
DECLARE VARIABLE WK_PO_CUSTOMER_PO VARCHAR(20);
DECLARE VARIABLE WK_PD_ADDRESS VARCHAR(100);
DECLARE VARIABLE WK_PD_ADDRESS2 VARCHAR(50);
DECLARE VARIABLE WK_PD_ADDRESS3 VARCHAR(50);
DECLARE VARIABLE WK_PD_ADDRESS4 VARCHAR(50);
DECLARE VARIABLE WK_PD_ADDRESS5 VARCHAR(50);
DECLARE VARIABLE WK_PP_DESC VARCHAR(50);
DECLARE VARIABLE WK_CUSTOMER_NULL INTEGER;
DECLARE VARIABLE WK_PI_LINE_NO VARCHAR(4);
DECLARE VARIABLE WK_LINE_CNT INTEGER;
DECLARE VARIABLE WK_IS_WH_ID CHAR(2);
DECLARE VARIABLE WK_IS_LOCN_ID VARCHAR(10);
DECLARE VARIABLE WK_IS_QTY INTEGER;
DECLARE VARIABLE WK_IS_WH_ID1 CHAR(2);
DECLARE VARIABLE WK_IS_LOCN_ID1 VARCHAR(10);
DECLARE VARIABLE WK_IS_QTY1 INTEGER;
DECLARE VARIABLE WK_IS_WH_ID2 CHAR(2);
DECLARE VARIABLE WK_IS_LOCN_ID2 VARCHAR(10);
DECLARE VARIABLE WK_IS_QTY2 INTEGER;
DECLARE VARIABLE WK_ISSN_CNT INTEGER;
DECLARE VARIABLE WK_FOUND INTEGER;

BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'PLPK') THEN
  BEGIN
     WK_DEVICE = NEW.WH_ID;
     WK_USER = NEW.PERSON_ID;
     WK_DATE = NEW.TRN_DATE;
     WK_LABEL = ALLTRIM(NEW.OBJECT);
     WK_PRINTER = ALLTRIM(NEW.REFERENCE);
     WK_QTY = NEW.QTY;
     WK_RECORD = NEW.RECORD_ID;

     WK_DIRECTORY = '';

     IF (STRLEN(WK_PRINTER) > 2) THEN
     BEGIN
        WK_PRINTER = UPPER(SUBSTR(WK_PRINTER,2,3));
     END
     ELSE
     BEGIN
        WK_PRINTER = UPPER(WK_PRINTER);
     END
     /* need the directory for this label set */
     SELECT WORKING_DIRECTORY FROM SYS_EQUIP 
         WHERE DEVICE_ID = :WK_PRINTER
         INTO :WK_DIRECTORY;
     IF (NEW.TRN_CODE = 'O') THEN
     BEGIN
        /* print a label for order */
        WK_FOUND = 0;
        SELECT 1 , CUSTOMER_PO_WO
        FROM PICK_ORDER
        WHERE PICK_ORDER = :WK_LABEL
        INTO :WK_FOUND, :WK_PO_CUSTOMER_PO ;

        IF (WK_FOUND = 1) THEN
        BEGIN
           WK_FILENAME = WK_DIRECTORY || 'PICKO.txt';
           WK_LABEL_LINE = '"' || WK_LABEL || '","' ||
               WK_PO_CUSTOMER_PO || '","' ||
               WK_USER || '","' ||
               SUBSTR(WK_PRINTER,2,2) || '",' ||
               '1' /* label qty */;
           WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE);
           IF (WK_RESULT <> 0) THEN
           BEGIN
              WK_FILENAME = WK_DIRECTORY || 'PICKO2.txt';
              WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE);
           END
           IF (WK_RESULT <> 0) THEN
           BEGIN
              WK_FILENAME = WK_DIRECTORY || 'PICKO3.txt';
              WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE);
           END
           IF (WK_RESULT <> 0) THEN
           BEGIN
              WK_FILENAME = WK_DIRECTORY || 'PICKO3.txt';
              WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE);
           END
           IF (WK_RESULT <> 0) THEN
           BEGIN
              WK_FILENAME = WK_DIRECTORY || 'PICKO4.txt';
              WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE);
           END
           IF (WK_RESULT <> 0) THEN
           BEGIN
              WK_FILENAME = WK_DIRECTORY || 'PICKO5.txt';
              WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE);
           END
           IF (WK_RESULT <> 0) THEN
           BEGIN
              WK_FILENAME = WK_DIRECTORY || 'PICKO6.txt';
              WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE);
           END
           IF (WK_RESULT <> 0) THEN
           BEGIN
              WK_FILENAME = WK_DIRECTORY || 'PICKO7.txt';
              WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE);
           END
           IF (WK_RESULT <> 0) THEN
           BEGIN
              WK_FILENAME = WK_DIRECTORY || 'PICKO8.txt';
              WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE);
           END
           IF (WK_RESULT <> 0) THEN
           BEGIN
              WK_FILENAME = WK_DIRECTORY || 'PICKO9.txt';
              WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE);
           END
           IF (WK_RESULT <> 0) THEN
           BEGIN
              WK_FILENAME = WK_DIRECTORY || 'PICKOA.txt';
              WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE);
           END
        END
     END
     ELSE
     BEGIN
     
        /* 
           if WK_LABEL <> ''
           then print/reprint label
           if WK_LABEL = ''
           then print all allocated unprinted for device
   
            if WK_QTY = 1 
            then reprint label or if WK_LABEL = '' print all allocated ...
            if WK_QTY = 0
            then no reprint just print label or all allocated
        */
        IF (WK_QTY = 1) THEN
        BEGIN
           /* reprint so for each label only create file */
           IF (WK_LABEL =  '') THEN
           BEGIN
              SELECT COUNT(*) 
                  FROM PICK_ITEM
                  WHERE DEVICE_ID = :WK_DEVICE
                  INTO :WK_LINE_CNT; 
              FOR SELECT PICK_LABEL_NO 
                  FROM PICK_ITEM
                  WHERE DEVICE_ID = :WK_DEVICE
                  INTO :WK_PI_LABEL 
              DO
              BEGIN
                 SELECT PI.PICK_ORDER_QTY, 
                        PI.PICK_ORDER, 
                        PI.PROD_ID, 
                        PI.CONTACT_NAME, 
                        PI.PICK_LOCATION,
                        PI.WH_ID,
                        PI.PICK_ORDER_LINE_NO,
                        PO.CUSTOMER_PO_WO, 
                        PO.CONTACT_NAME,
                        PO.P_ADDRESS_LINE1,
                        PO.P_ADDRESS_LINE2,
                        PO.P_CITY,
                        PO.P_STATE,
                        PO.P_POST_CODE,
                        PP.SHORT_DESC   
                 FROM PICK_ITEM PI 
                 JOIN PICK_ORDER PO ON PI.PICK_ORDER = PO.PICK_ORDER
                 JOIN PROD_PROFILE PP ON PP.PROD_ID = PI.PROD_ID
                 WHERE PI.PICK_LABEL_NO = :WK_PI_LABEL
                 INTO :WK_PI_PICK_ORDER_QTY,
                      :WK_PI_PICK_ORDER,
                      :WK_PI_PROD_ID,
                      :WK_PI_CONTACT,
                      :WK_PI_LOCN_ID,
                      :WK_PI_WH_ID,
                      :WK_PI_LINE_NO,
                      :WK_PO_CUSTOMER_PO,
                      :WK_PO_CONTACT,
                      :WK_PD_ADDRESS,
                      :WK_PD_ADDRESS2,
                      :WK_PD_ADDRESS3,
                      :WK_PD_ADDRESS4,
                      :WK_PD_ADDRESS5,
                      :WK_PP_DESC;
                 /* must get 1st 2 locations for this product */
                 WK_ISSN_CNT = 0;
                 WK_IS_WH_ID1 = '';
                 WK_IS_LOCN_ID1 = '';
                 WK_IS_QTY1 = 0;
                 WK_IS_WH_ID2 = '';
                 WK_IS_LOCN_ID2 = '';
                 WK_IS_QTY2 = 0;
                 FOR SELECT FIRST 2 WH_ID, LOCN_ID, SUM(CURRENT_QTY)
                     FROM ISSN
                     WHERE PROD_ID = :WK_PI_PROD_ID
                       AND WH_ID < 'X '
                       AND ISSN_STATUS IN ('ST','PA','AL','PG','PL')
                       GROUP BY WH_ID, LOCN_ID
                     INTO :WK_IS_WH_ID, :WK_IS_LOCN_ID, :WK_IS_QTY
                 DO
                 BEGIN
                    IF (WK_ISSN_CNT = 0) THEN
                    BEGIN
                       WK_IS_WH_ID1 = WK_IS_WH_ID;
                       WK_IS_LOCN_ID1 = WK_IS_LOCN_ID;
                       WK_IS_QTY1 = WK_IS_QTY;
                    END
                    ELSE
                    BEGIN
                       WK_IS_WH_ID2 = WK_IS_WH_ID;
                       WK_IS_LOCN_ID2 = WK_IS_LOCN_ID;
                       WK_IS_QTY2 = WK_IS_QTY;
                    END
                    WK_ISSN_CNT = WK_ISSN_CNT + 1;
                 END
                 WK_CUSTOMER_NULL = 0;
                 SELECT 1
                 FROM PICK_ITEM PI 
                 WHERE PI.PICK_LABEL_NO = :WK_PI_LABEL
                   AND CONTACT_NAME IS NULL
                 INTO :WK_CUSTOMER_NULL;
                 IF (WK_CUSTOMER_NULL = 1) THEN
                 BEGIN
                    WK_PI_CONTACT = WK_PO_CONTACT;
                 END
                  
                 BEGIN
                         /* DQUOTEDSTR(WK_PI_WH_ID || WK_PI_LOCN_ID) || ',' || */
                     WK_FILENAME = WK_DIRECTORY || 'PICK.txt';
                     WK_LABEL_LINE = '"' || WK_PI_LABEL || '",' ||
                         WK_PI_PICK_ORDER_QTY || ',"' ||
                         WK_PI_PICK_ORDER || '","' ||
                         WK_PO_CUSTOMER_PO || '","' ||
                         WK_PI_PROD_ID || '","' ||
                         WK_PP_DESC || '","' ||
                         WK_PI_CONTACT || '","' ||
                         WK_PD_ADDRESS || '","' ||
                         WK_PD_ADDRESS2 || '","' ||
                         WK_PD_ADDRESS3 || '","' ||
                         WK_PD_ADDRESS4 || '","' ||
                         WK_PD_ADDRESS5 || '","' ||
                         WK_IS_WH_ID1 || WK_IS_LOCN_ID1 || '",' ||
                         WK_IS_QTY || ',"' ||
                         WK_IS_WH_ID2 || WK_IS_LOCN_ID2 || '",' ||
                         WK_IS_QTY2 || ',"' ||
                         WK_PI_LINE_NO || '",' ||
                         WK_LINE_CNT || ',"' ||
                         WK_USER || '","' ||
                         SUBSTR(WK_PRINTER,2,2) || '"';
                     WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE);
                     IF (WK_RESULT <> 0) THEN
                     BEGIN
                        WK_FILENAME = WK_DIRECTORY || 'PICK.2xt';
                        WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE);
                     END
                  END
              END
           END
           ELSE
           BEGIN
              WK_PI_LABEL = WK_LABEL;
              SELECT PI.PICK_ORDER_QTY, 
                     PI.PICK_ORDER, 
                     PI.PROD_ID, 
                     PI.CONTACT_NAME, 
                     PI.PICK_LOCATION,
                     PI.WH_ID,
                     PI.PICK_ORDER_LINE_NO,
                     PO.CUSTOMER_PO_WO, 
                     PO.CONTACT_NAME,
                     PO.P_ADDRESS_LINE1,
                     PO.P_ADDRESS_LINE2,
                     PO.P_CITY,
                     PO.P_STATE,
                     PO.P_POST_CODE,
                     PP.SHORT_DESC   
              FROM PICK_ITEM PI 
              JOIN PICK_ORDER PO ON PI.PICK_ORDER = PO.PICK_ORDER
              JOIN PROD_PROFILE PP ON PP.PROD_ID = PI.PROD_ID
              WHERE PI.PICK_LABEL_NO = :WK_PI_LABEL
              INTO :WK_PI_PICK_ORDER_QTY,
                   :WK_PI_PICK_ORDER,
                   :WK_PI_PROD_ID,
                   :WK_PI_CONTACT,
                   :WK_PI_LOCN_ID,
                   :WK_PI_WH_ID,
                   :WK_PI_LINE_NO,
                   :WK_PO_CUSTOMER_PO,
                   :WK_PO_CONTACT,
                   :WK_PD_ADDRESS,
                   :WK_PD_ADDRESS2,
                   :WK_PD_ADDRESS3,
                   :WK_PD_ADDRESS4,
                   :WK_PD_ADDRESS5,
                   :WK_PP_DESC;
              /* must get 1st 2 locations for this product */
              WK_ISSN_CNT = 0;
              WK_IS_WH_ID1 = '';
              WK_IS_LOCN_ID1 = '';
              WK_IS_QTY1 = 0;
              WK_IS_WH_ID2 = '';
              WK_IS_LOCN_ID2 = '';
              WK_IS_QTY2 = 0;
              FOR SELECT FIRST 2 WH_ID, LOCN_ID, SUM(CURRENT_QTY)
                  FROM ISSN
                  WHERE PROD_ID = :WK_PI_PROD_ID
                    AND WH_ID < 'X '
                    AND ISSN_STATUS IN ('ST','PA','AL','PG','PL')
                    GROUP BY WH_ID, LOCN_ID
                  INTO :WK_IS_WH_ID, :WK_IS_LOCN_ID, :WK_IS_QTY
              DO
              BEGIN
                 IF (WK_ISSN_CNT = 0) THEN
                 BEGIN
                    WK_IS_WH_ID1 = WK_IS_WH_ID;
                    WK_IS_LOCN_ID1 = WK_IS_LOCN_ID;
                    WK_IS_QTY1 = WK_IS_QTY;
                 END
                 ELSE
                 BEGIN
                    WK_IS_WH_ID2 = WK_IS_WH_ID;
                    WK_IS_LOCN_ID2 = WK_IS_LOCN_ID;
                    WK_IS_QTY2 = WK_IS_QTY;
                 END
                 WK_ISSN_CNT = WK_ISSN_CNT + 1;
              END
              WK_CUSTOMER_NULL = 0;
              SELECT 1
              FROM PICK_ITEM PI 
              WHERE PI.PICK_LABEL_NO = :WK_PI_LABEL
                AND CONTACT_NAME IS NULL
              INTO :WK_CUSTOMER_NULL;
              IF (WK_CUSTOMER_NULL = 1) THEN
              BEGIN
                 WK_PI_CONTACT = WK_PO_CONTACT;
              END
               
              BEGIN
                  WK_FILENAME = WK_DIRECTORY || 'PICK.txt';
   /*                   DQUOTEDSTR(WK_PI_WH_ID || WK_PI_LOCN_ID) || ',' || */
                  WK_LABEL_LINE = '"' || WK_PI_LABEL || '",' ||
                         WK_PI_PICK_ORDER_QTY || ',"' ||
                         WK_PI_PICK_ORDER || '","' ||
                         WK_PO_CUSTOMER_PO || '","' ||
                         WK_PI_PROD_ID || '","' ||
                         WK_PP_DESC || '","' ||
                         WK_PI_CONTACT || '","' ||
                         WK_PD_ADDRESS || '","' ||
                         WK_PD_ADDRESS2 || '","' ||
                         WK_PD_ADDRESS3 || '","' ||
                         WK_PD_ADDRESS4 || '","' ||
                         WK_PD_ADDRESS5 || '","' ||
                         WK_IS_WH_ID1 || WK_IS_LOCN_ID1 || '",' ||
                         WK_IS_QTY || ',"' ||
                         WK_IS_WH_ID2 || WK_IS_LOCN_ID2 || '",' ||
                         WK_IS_QTY2 || ',"' ||
                         WK_PI_LINE_NO || '",' ||
                         '1,"' ||
                         WK_USER || '","' ||
                         SUBSTR(WK_PRINTER,2,2) || '"';
                  WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE);
                  IF (WK_RESULT <> 0) THEN
                  BEGIN
                     WK_FILENAME = WK_DIRECTORY || 'PICK.2xt';
                     WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE);
                  END
              END
           END
        END
        ELSE
        BEGIN
           /* no reprint so for each label must also update item */
           IF (WK_LABEL =  '') THEN
           BEGIN
              SELECT COUNT(*) 
                  FROM PICK_ITEM
                  WHERE DEVICE_ID = :WK_DEVICE
                    AND PICK_LABEL_DATE IS NULL
                  INTO :WK_LINE_CNT; 
              FOR SELECT PICK_LABEL_NO 
                  FROM PICK_ITEM
                  WHERE DEVICE_ID = :WK_DEVICE
                    AND PICK_LABEL_DATE IS NULL
                  INTO :WK_PI_LABEL 
              DO
              BEGIN
                 SELECT PI.PICK_ORDER_QTY, 
                        PI.PICK_ORDER, 
                        PI.PROD_ID, 
                        PI.CONTACT_NAME, 
                        PI.PICK_LOCATION,
                        PI.WH_ID,
                        PI.PICK_ORDER_LINE_NO,
                        PO.CUSTOMER_PO_WO, 
                        PO.CONTACT_NAME,
                        PO.P_ADDRESS_LINE1,
                        PO.P_ADDRESS_LINE2,
                        PO.P_CITY,
                        PO.P_STATE,
                        PO.P_POST_CODE,
                        PP.SHORT_DESC   
                 FROM PICK_ITEM PI 
                 JOIN PICK_ORDER PO ON PI.PICK_ORDER = PO.PICK_ORDER
                 JOIN PROD_PROFILE PP ON PP.PROD_ID = PI.PROD_ID
                 WHERE PI.PICK_LABEL_NO = :WK_PI_LABEL
                 INTO :WK_PI_PICK_ORDER_QTY,
                      :WK_PI_PICK_ORDER,
                      :WK_PI_PROD_ID,
                      :WK_PI_CONTACT,
                      :WK_PI_LOCN_ID,
                      :WK_PI_WH_ID,
                      :WK_PI_LINE_NO,
                      :WK_PO_CUSTOMER_PO,
                      :WK_PO_CONTACT,
                      :WK_PD_ADDRESS,
                      :WK_PD_ADDRESS2,
                      :WK_PD_ADDRESS3,
                      :WK_PD_ADDRESS4,
                      :WK_PD_ADDRESS5,
                      :WK_PP_DESC;
                 /* must get 1st 2 locations for this product */
                 WK_ISSN_CNT = 0;
                 WK_IS_WH_ID1 = '';
                 WK_IS_LOCN_ID1 = '';
                 WK_IS_QTY1 = 0;
                 WK_IS_WH_ID2 = '';
                 WK_IS_LOCN_ID2 = '';
                 WK_IS_QTY2 = 0;
                 FOR SELECT FIRST 2 WH_ID, LOCN_ID, SUM(CURRENT_QTY)
                     FROM ISSN
                     WHERE PROD_ID = :WK_PI_PROD_ID
                       AND WH_ID < 'X '
                       AND ISSN_STATUS IN ('ST','PA','AL','PG','PL')
                       GROUP BY WH_ID, LOCN_ID
                     INTO :WK_IS_WH_ID, :WK_IS_LOCN_ID, :WK_IS_QTY
                 DO
                 BEGIN
                    IF (WK_ISSN_CNT = 0) THEN
                    BEGIN
                       WK_IS_WH_ID1 = WK_IS_WH_ID;
                       WK_IS_LOCN_ID1 = WK_IS_LOCN_ID;
                       WK_IS_QTY1 = WK_IS_QTY;
                    END
                    ELSE
                    BEGIN
                       WK_IS_WH_ID2 = WK_IS_WH_ID;
                       WK_IS_LOCN_ID2 = WK_IS_LOCN_ID;
                       WK_IS_QTY2 = WK_IS_QTY;
                    END
                    WK_ISSN_CNT = WK_ISSN_CNT + 1;
                 END
                 WK_CUSTOMER_NULL = 0;
                 SELECT 1
                 FROM PICK_ITEM PI 
                 WHERE PI.PICK_LABEL_NO = :WK_PI_LABEL
                   AND CONTACT_NAME IS NULL
                 INTO :WK_CUSTOMER_NULL;
                 IF (WK_CUSTOMER_NULL = 1) THEN
                 BEGIN
                    WK_PI_CONTACT = WK_PO_CONTACT;
                 END
                  
                 BEGIN
                     WK_FILENAME = WK_DIRECTORY || 'PICK.txt';
   /*                      DQUOTEDSTR(WK_PI_WH_ID || WK_PI_LOCN_ID) || ',' || */
                     WK_LABEL_LINE = '"' || WK_PI_LABEL || '",' ||
                         WK_PI_PICK_ORDER_QTY || ',"' ||
                         WK_PI_PICK_ORDER || '","' ||
                         WK_PO_CUSTOMER_PO || '","' ||
                         WK_PI_PROD_ID || '","' ||
                         WK_PP_DESC || '","' ||
                         WK_PI_CONTACT || '","' ||
                         WK_PD_ADDRESS || '","' ||
                         WK_PD_ADDRESS2 || '","' ||
                         WK_PD_ADDRESS3 || '","' ||
                         WK_PD_ADDRESS4 || '","' ||
                         WK_PD_ADDRESS5 || '","' ||
                         WK_IS_WH_ID1 || WK_IS_LOCN_ID1 || '",' ||
                         WK_IS_QTY || ',"' ||
                         WK_IS_WH_ID2 || WK_IS_LOCN_ID2 || '",' ||
                         WK_IS_QTY2 || ',"' ||
                         WK_PI_LINE_NO || '",' ||
                         WK_LINE_CNT || ',"' ||
                         WK_USER || '","' ||
                         SUBSTR(WK_PRINTER,2,2) || '"';
                     WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE);
                     IF (WK_RESULT <> 0) THEN
                     BEGIN
                        WK_FILENAME = WK_DIRECTORY || 'PICK.2xt';
                        WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE);
                     END
                  END
                 UPDATE PICK_ITEM SET PICK_LABEL_DATE = :WK_DATE 
                 WHERE PICK_LABEL_NO = :WK_PI_LABEL;
              END
           END
           ELSE
           BEGIN
              WK_PI_LABEL = WK_LABEL;
              SELECT PI.PICK_ORDER_QTY, 
                     PI.PICK_ORDER, 
                     PI.PROD_ID, 
                     PI.CONTACT_NAME, 
                     PI.PICK_LOCATION,
                     PI.WH_ID,
                     PI.PICK_ORDER_LINE_NO,
                     PO.CUSTOMER_PO_WO, 
                     PO.CONTACT_NAME,
                     PO.P_ADDRESS_LINE1,
                     PO.P_ADDRESS_LINE2,
                     PO.P_CITY,
                     PO.P_STATE,
                     PO.P_POST_CODE,
                     PP.SHORT_DESC   
              FROM PICK_ITEM PI 
              JOIN PICK_ORDER PO ON PI.PICK_ORDER = PO.PICK_ORDER
              JOIN PROD_PROFILE PP ON PP.PROD_ID = PI.PROD_ID
              WHERE PI.PICK_LABEL_NO = :WK_PI_LABEL
              INTO :WK_PI_PICK_ORDER_QTY,
                   :WK_PI_PICK_ORDER,
                   :WK_PI_PROD_ID,
                   :WK_PI_CONTACT,
                   :WK_PI_LOCN_ID,
                   :WK_PI_WH_ID,
                   :WK_PI_LINE_NO,
                   :WK_PO_CUSTOMER_PO,
                   :WK_PO_CONTACT,
                   :WK_PD_ADDRESS,
                   :WK_PD_ADDRESS2,
                   :WK_PD_ADDRESS3,
                   :WK_PD_ADDRESS4,
                   :WK_PD_ADDRESS5,
                   :WK_PP_DESC;
                 /* must get 1st 2 locations for this product */
                 WK_ISSN_CNT = 0;
                 WK_IS_WH_ID1 = '';
                 WK_IS_LOCN_ID1 = '';
                 WK_IS_QTY1 = 0;
                 WK_IS_WH_ID2 = '';
                 WK_IS_LOCN_ID2 = '';
                 WK_IS_QTY2 = 0;
                 FOR SELECT FIRST 2 WH_ID, LOCN_ID, SUM(CURRENT_QTY)
                     FROM ISSN
                     WHERE PROD_ID = :WK_PI_PROD_ID
                       AND WH_ID < 'X '
                       AND ISSN_STATUS IN ('ST','PA','AL','PG','PL')
                       GROUP BY WH_ID, LOCN_ID
                     INTO :WK_IS_WH_ID, :WK_IS_LOCN_ID, :WK_IS_QTY
                 DO
                 BEGIN
                    IF (WK_ISSN_CNT = 0) THEN
                    BEGIN
                       WK_IS_WH_ID1 = WK_IS_WH_ID;
                       WK_IS_LOCN_ID1 = WK_IS_LOCN_ID;
                       WK_IS_QTY1 = WK_IS_QTY;
                    END
                    ELSE
                    BEGIN
                       WK_IS_WH_ID2 = WK_IS_WH_ID;
                       WK_IS_LOCN_ID2 = WK_IS_LOCN_ID;
                       WK_IS_QTY2 = WK_IS_QTY;
                    END
                    WK_ISSN_CNT = WK_ISSN_CNT + 1;
                 END
              WK_CUSTOMER_NULL = 0;
              SELECT 1
              FROM PICK_ITEM PI 
              WHERE PI.PICK_LABEL_NO = :WK_PI_LABEL
                AND CONTACT_NAME IS NULL
              INTO :WK_CUSTOMER_NULL;
              IF (WK_CUSTOMER_NULL = 1) THEN
              BEGIN
                 WK_PI_CONTACT = WK_PO_CONTACT;
              END
               
              BEGIN
                  WK_FILENAME = WK_DIRECTORY || 'PICK.txt';
   /*                      DQUOTEDSTR(WK_PI_WH_ID || WK_PI_LOCN_ID) || ',' || */
                  WK_LABEL_LINE = '"' || WK_PI_LABEL || '",' ||
                         WK_PI_PICK_ORDER_QTY || ',"' ||
                         WK_PI_PICK_ORDER || '","' ||
                         WK_PO_CUSTOMER_PO || '","' ||
                         WK_PI_PROD_ID || '","' ||
                         WK_PP_DESC || '","' ||
                         WK_PI_CONTACT || '","' ||
                         WK_PD_ADDRESS || '","' ||
                         WK_PD_ADDRESS2 || '","' ||
                         WK_PD_ADDRESS3 || '","' ||
                         WK_PD_ADDRESS4 || '","' ||
                         WK_PD_ADDRESS5 || '","' ||
                         WK_IS_WH_ID1 || WK_IS_LOCN_ID1 || '",' ||
                         WK_IS_QTY1 || ',"' ||
                         WK_IS_WH_ID2 || WK_IS_LOCN_ID2 || '",' ||
                         WK_IS_QTY2 || ',"' ||
                         WK_PI_LINE_NO || '",' ||
                         '1,"' ||
                         WK_USER || '","' ||
                         SUBSTR(WK_PRINTER,2,2) || '"';
                  WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE);
                  IF (WK_RESULT <> 0) THEN
                  BEGIN
                     WK_FILENAME = WK_DIRECTORY || 'PICK.2xt';
                     WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE);
                  END
              END
              UPDATE PICK_ITEM SET PICK_LABEL_DATE = :WK_DATE 
              WHERE PICK_LABEL_NO = :WK_PI_LABEL;
           END
        END
     END
   EXECUTE PROCEDURE UPDATE_TRAN (WK_RECORD, 'T','Processed successfully');
   EXECUTE PROCEDURE TRAN_ARCHIVE;
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_NIRM FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 55 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_FOUND INTEGER;
DECLARE VARIABLE WK_OBJECT VARCHAR(30);
DECLARE VARIABLE WK_SSN_TYPE VARCHAR(40);
DECLARE VARIABLE WK_GENERIC VARCHAR(40);
DECLARE VARIABLE WK_BRAND VARCHAR(40);
DECLARE VARIABLE WK_MODEL VARCHAR(40);
DECLARE VARIABLE WK_PROD_ID VARCHAR(30);
DECLARE VARIABLE WK_SUPPLIER_ID VARCHAR(50);
DECLARE VARIABLE WK_OTHER6 VARCHAR(50);
DECLARE VARIABLE WK_OTHER7 VARCHAR(50);
DECLARE VARIABLE WK_OTHER8 VARCHAR(50);
DECLARE VARIABLE WK_OTHER9 VARCHAR(50);
DECLARE VARIABLE WK_OTHER10 VARCHAR(50);
DECLARE VARIABLE WK_DESCRIPTION VARCHAR(50);
DECLARE VARIABLE WK_RESULT INTEGER;
DECLARE VARIABLE WK_PRINTER CHAR(2);
DECLARE VARIABLE WK_DIRECTORY VARCHAR(75);
DECLARE VARIABLE WK_FILENAME VARCHAR(255);
DECLARE VARIABLE WK_LABEL_LINE VARCHAR(250);
DECLARE VARIABLE WK_RECORD_ID INTEGER;
DECLARE VARIABLE WK_USER VARCHAR(8);
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'NIRM') THEN
  BEGIN
   WK_RECORD_ID = NEW.RECORD_ID;
   WK_USER = NEW.PERSON_ID;
   IF (SUBSTR(NEW.REFERENCE,1,5) = 'GROUP') THEN
   BEGIN
    WK_FOUND = 0;
    WK_OBJECT = NEW.OBJECT;
    SELECT SSN.SSN_TYPE, 
       SSN.GENERIC, 
       SSN.BRAND, 
       SSN.MODEL, 
       SSN.PROD_ID, 
       SSN.SUPPLIER_ID, 
       SSN.OTHER6, 
       SSN.OTHER7, 
       SSN.OTHER8, 
       SSN.OTHER9, 
       SSN.OTHER10 
    FROM ISSN 
    JOIN SSN ON ISSN.ORIGINAL_SSN = SSN.SSN_ID 
    WHERE ISSN.SSN_ID = :WK_OBJECT
    INTO :WK_SSN_TYPE, 
         :WK_GENERIC, 
         :WK_BRAND, 
         :WK_MODEL, 
         :WK_PROD_ID, 
         :WK_SUPPLIER_ID, 
         :WK_OTHER6, 
         :WK_OTHER7, 
         :WK_OTHER8, 
         :WK_OTHER9, 
         :WK_OTHER10; 
    SELECT 1 FROM GROUP_COPY WHERE CODE = :WK_OBJECT INTO :WK_FOUND;
    IF (WK_FOUND = 0) THEN
    BEGIN
       INSERT INTO GROUP_COPY(CODE, 
          SSN_TYPE, 
          GENERIC, 
          BRAND, 
          MODEL, 
          PROD_ID, 
          SUPPLIER_ID, 
          OTHER6, 
          OTHER7, 
          OTHER8, 
          OTHER9, 
          OTHER10, 
          DESCRIPTION) VALUES (:WK_OBJECT,
         :WK_SSN_TYPE, 
         :WK_GENERIC, 
         :WK_BRAND, 
         :WK_MODEL, 
         :WK_PROD_ID, 
         :WK_SUPPLIER_ID, 
         :WK_OTHER6, 
         :WK_OTHER7, 
         :WK_OTHER8, 
         :WK_OTHER9, 
         :WK_OTHER10, 
         :WK_OBJECT); 
    END
    ELSE
    BEGIN
       UPDATE GROUP_COPY SET SSN_TYPE = :WK_SSN_TYPE, 
          GENERIC = :WK_GENERIC, 
          BRAND = :WK_BRAND, 
          MODEL = :WK_MODEL, 
          PROD_ID = :WK_PROD_ID, 
          SUPPLIER_ID = :WK_SUPPLIER_ID, 
          OTHER6 = :WK_OTHER6, 
          OTHER7 = :WK_OTHER7, 
          OTHER8 = :WK_OTHER8, 
          OTHER9 = :WK_OTHER9, 
          OTHER10 = :WK_OTHER10 
       WHERE CODE = :WK_OBJECT;
    END
   WK_PRINTER = SUBSTR(NEW.REFERENCE,7,8);
    /* need the directory for this label set */
    SELECT WORKING_DIRECTORY FROM SYS_EQUIP 
        WHERE DEVICE_ID = :WK_PRINTER
        INTO :WK_DIRECTORY;
    /* append the file name to the directory*/
    BEGIN
       WK_FILENAME = WK_DIRECTORY || 'DESCRIPTION.txt';
       WK_LABEL_LINE = DQUOTEDSTR('/O' || WK_OBJECT) || ',' ||
          DQUOTEDSTR('GROUP CODE') ;
       WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE);
       IF (WK_RESULT <> 0) THEN
       BEGIN
          WK_FILENAME = WK_DIRECTORY || 'DESCRIPTION.2xt';
          WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE);
       END
    END
    EXECUTE PROCEDURE UPDATE_TRAN (:WK_RECORD_ID, 'T', 'Processed successfully'); 
   END
   EXECUTE PROCEDURE TRAN_ARCHIVE;
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_PKIL FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 56 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_DEVICE CHAR(2);
DECLARE VARIABLE WK_USER VARCHAR(10);
DECLARE VARIABLE WK_RECORD INTEGER;
DECLARE VARIABLE WK_LABEL_NO VARCHAR(10);
DECLARE VARIABLE WK_WH_ID CHAR(2);
DECLARE VARIABLE WK_LOCN_ID VARCHAR(10);
DECLARE VARIABLE WK_OBJECT VARCHAR(30);
DECLARE VARIABLE WK_REF VARCHAR(40);
DECLARE VARIABLE WK_QTY INTEGER;
DECLARE VARIABLE WK_DATE TIMESTAMP;
DECLARE VARIABLE WK_PID_ID INTEGER;
DECLARE VARIABLE WK_SSN_ID VARCHAR(20);
DECLARE VARIABLE WK_LOCN_TYPE CHAR(2);
DECLARE VARIABLE WK_PI_STATUS CHAR(2);
DECLARE VARIABLE WK_PI_STATUS2 CHAR(2);
DECLARE VARIABLE WK_TRN_TYPE VARCHAR(4);
DECLARE VARIABLE WK_TRN_CODE CHAR(1);
DECLARE VARIABLE WK_AUDIT_DESC VARCHAR(40);
DECLARE VARIABLE WK_DESC VARCHAR(80);
DECLARE VARIABLE WK_ORDER VARCHAR(15);
DECLARE VARIABLE WK_FROM_LOCN VARCHAR(40);
DECLARE VARIABLE WK_FROM_WH_ID VARCHAR(40);
DECLARE VARIABLE WK_DUMMY CHAR(1);
DECLARE VARIABLE WK_LOG VARCHAR(255);
DECLARE VARIABLE WK_DATE_TXT VARCHAR(25);
DECLARE VARIABLE WK_PL_WH_ID CHAR(2);
DECLARE VARIABLE WK_PL_LOCN_ID VARCHAR(10);
DECLARE VARIABLE WK_ISS_ISSN_ID VARCHAR(20);

BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'PKIL') THEN
  BEGIN
     WK_DEVICE = NEW.DEVICE_ID;
     WK_LABEL_NO = NEW.SUB_LOCN_ID;
     WK_WH_ID = NEW.WH_ID;
     WK_LOCN_ID = NEW.LOCN_ID;
     WK_USER = NEW.PERSON_ID;
     WK_OBJECT = NEW.OBJECT;
     WK_QTY = NEW.QTY;
     WK_DATE = NEW.TRN_DATE;
     WK_RECORD = NEW.RECORD_ID;
     WK_TRN_CODE = NEW.TRN_CODE;
     WK_TRN_TYPE = NEW.TRN_TYPE;
     WK_REF = NEW.REFERENCE;
     WK_DATE_TXT = CAST(CAST('NOW' AS TIMESTAMP) AS CHAR(24));
     WK_LOG = 'TRN_TYPE ' || NEW.TRN_TYPE ||
     ' TRN_CODE ' || NEW.TRN_CODE || ' date ' || WK_DATE_TXT ||
     ' OBJECT ' || NEW.OBJECT || ' date ' || WK_DATE_TXT || ' start ';
     /* INSERT INTO LOG(DESCRIPTION) VALUES(:WK_LOG); */

/*
have 5 transaction classes
 for picking (ie it is on my device)
 M - transfer all on device
 D - transfer all for pick_label in sub_locn_id
 I - transfer all for issn in object
 P - transfer all for product in object
 for assembly (ie its not on my device)
 G - transfer all of product in object 
     for order in the sub_locn_id
     only take from the location specified in the reference
     across all devices 
 for pre checking (ie its on the device of the conveyor)
 L - transfer all from the location specified in the reference
     for the order in the object
 change the ssn status to DS if for a despatch location
 and the pick_item .. to PC or PS
 do the updates as happen already for pick_item and issn
 02/08/2010 
 if any pick_locations records for the issns moved (current location) 
 and location becomes empty then must update the status of the pick_locations record to 'DS'
 I have done this only to 'G' trn_code since only this form does the finishing of pick
 when using the allocated scanned trolley location
*/

     /* WK_LOCN_TYPE = 'DS'; */
     WK_LOCN_TYPE = 'PL';
     SELECT STORE_AREA
        FROM LOCATION
        WHERE LOCN_ID = :WK_LOCN_ID
          AND WH_ID = :WK_WH_ID
         INTO :WK_LOCN_TYPE; 
     IF (WK_LOCN_TYPE = 'DS') THEN
     BEGIN
        WK_PI_STATUS = 'DS';
     END
     ELSE
     BEGIN
        WK_PI_STATUS = 'PL';
     END

     WK_AUDIT_DESC = 'Picked to Location ' || :WK_LOCN_ID ;
     IF (NEW.TRN_CODE = 'M') THEN
     BEGIN
        FOR SELECT PICK_DETAIL_ID, SSN_ID 
           FROM PICK_ITEM_DETAIL 
           WHERE DEVICE_ID = :WK_DEVICE 
             AND PICK_DETAIL_STATUS = 'PL'
            INTO :WK_PID_ID, :WK_SSN_ID
        DO
        BEGIN
           UPDATE ISSN SET ISSN_STATUS = :WK_PI_STATUS,
               PREV_PREV_WH_ID = PREV_WH_ID,
               PREV_PREV_LOCN_ID = PREV_LOCN_ID,
               PREV_WH_ID = WH_ID,
               PREV_LOCN_ID = LOCN_ID,
               WH_ID = :WK_WH_ID,
               LOCN_ID = :WK_LOCN_ID
           WHERE SSN_ID = :WK_SSN_ID;
           UPDATE PICK_ITEM_DETAIL SET DESPATCH_LOCATION = :WK_LOCN_ID
           WHERE PICK_DETAIL_ID = :WK_PID_ID;
           EXECUTE PROCEDURE ADD_SSN_HIST(:WK_WH_ID, :WK_LOCN_ID, :WK_SSN_ID, :WK_TRN_TYPE, :WK_TRN_CODE, :WK_DATE,
                  :WK_AUDIT_DESC , '', :WK_QTY, :WK_USER, :WK_DEVICE); 
        END
        /* update item to PL or  DS  
        */
        IF (WK_PI_STATUS = 'DS') THEN
        BEGIN
           UPDATE PICK_ITEM SET DESPATCH_LOCATION = :WK_LOCN_ID,
              PICK_PICK_FINISH = :WK_DATE,
              PICK_LINE_STATUS = 'DS'
              WHERE DEVICE_ID = :WK_DEVICE 
              AND PICK_LINE_STATUS = 'PL';
        END
        ELSE
        BEGIN
           UPDATE PICK_ITEM SET DESPATCH_LOCATION = :WK_LOCN_ID
              WHERE DEVICE_ID = :WK_DEVICE 
              AND PICK_LINE_STATUS = 'PL';
        END
        IF (WK_PI_STATUS = 'DS') THEN
        BEGIN
           /* UPDATE PICK_ITEM_DETAIL SET PICK_DETAIL_STATUS = :WK_PI_STATUS */
           UPDATE PICK_ITEM_DETAIL SET DESPATCH_LOCATION = :WK_LOCN_ID,
              PICK_DETAIL_STATUS = :WK_PI_STATUS
              WHERE DEVICE_ID = :WK_DEVICE 
              AND PICK_DETAIL_STATUS = 'PL';
        END
     END
     ELSE
     BEGIN
        IF (NEW.TRN_CODE = 'D') THEN
        BEGIN
           FOR SELECT PICK_DETAIL_ID, SSN_ID 
              FROM PICK_ITEM_DETAIL 
              WHERE DEVICE_ID = :WK_DEVICE 
                AND PICK_DETAIL_STATUS = 'PL'
                AND PICK_LABEL_NO = :WK_LABEL_NO
               INTO :WK_PID_ID, :WK_SSN_ID
           DO
           BEGIN
              UPDATE ISSN SET ISSN_STATUS = :WK_PI_STATUS,
                  PREV_PREV_WH_ID = PREV_WH_ID,
                  PREV_PREV_LOCN_ID = PREV_LOCN_ID,
                  PREV_WH_ID = WH_ID,
                  PREV_LOCN_ID = LOCN_ID,
                  WH_ID = :WK_WH_ID,
                  LOCN_ID = :WK_LOCN_ID
              WHERE SSN_ID = :WK_SSN_ID;
              UPDATE PICK_ITEM_DETAIL SET DESPATCH_LOCATION = :WK_LOCN_ID
              WHERE PICK_DETAIL_ID = :WK_PID_ID;
           END
           /* update item to PL or DS  
           */
           IF (WK_PI_STATUS = 'DS') THEN
           BEGIN
              UPDATE PICK_ITEM SET DESPATCH_LOCATION = :WK_LOCN_ID,
                 PICK_LINE_STATUS = 'DS'
                 WHERE DEVICE_ID = :WK_DEVICE 
                 AND PICK_LINE_STATUS = 'PL'
                 AND PICK_LABEL_NO = :WK_LABEL_NO;
           END
           ELSE
           BEGIN
              UPDATE PICK_ITEM SET DESPATCH_LOCATION = :WK_LOCN_ID
                 WHERE DEVICE_ID = :WK_DEVICE 
                 AND PICK_LABEL_NO = :WK_LABEL_NO
                 AND PICK_LINE_STATUS = 'PL';
           END
           IF (WK_PI_STATUS = 'DS') THEN
           BEGIN
              /* UPDATE PICK_ITEM_DETAIL SET PICK_DETAIL_STATUS = :WK_PI_STATUS */
              UPDATE PICK_ITEM_DETAIL SET DESPATCH_LOCATION = :WK_LOCN_ID,
                 PICK_DETAIL_STATUS = :WK_PI_STATUS
                 WHERE DEVICE_ID = :WK_DEVICE 
                 AND PICK_LABEL_NO = :WK_LABEL_NO
                 AND PICK_DETAIL_STATUS = 'PL';
           END
        END
        ELSE
        BEGIN
           IF (NEW.TRN_CODE = 'I') THEN
           BEGIN
              FOR SELECT PICK_DETAIL_ID, SSN_ID 
                 FROM PICK_ITEM_DETAIL 
                 WHERE DEVICE_ID = :WK_DEVICE 
                   AND PICK_DETAIL_STATUS = 'PL'
                   AND SSN_ID = :WK_OBJECT
                  INTO :WK_PID_ID, :WK_SSN_ID
              DO
              BEGIN
                 UPDATE ISSN SET ISSN_STATUS = :WK_PI_STATUS,
                     PREV_PREV_WH_ID = PREV_WH_ID,
                     PREV_PREV_LOCN_ID = PREV_LOCN_ID,
                     PREV_WH_ID = WH_ID,
                     PREV_LOCN_ID = LOCN_ID,
                     WH_ID = :WK_WH_ID,
                     LOCN_ID = :WK_LOCN_ID
                 WHERE SSN_ID = :WK_SSN_ID;
                 UPDATE PICK_ITEM_DETAIL SET DESPATCH_LOCATION = :WK_LOCN_ID
                 WHERE PICK_DETAIL_ID = :WK_PID_ID;
              END
              /* update item to PL or DS 
              */
              IF (WK_PI_STATUS = 'DS') THEN
              BEGIN
                 UPDATE PICK_ITEM SET DESPATCH_LOCATION = :WK_LOCN_ID,
                    PICK_LINE_STATUS = 'DS'
                    WHERE DEVICE_ID = :WK_DEVICE 
                    AND PICK_LINE_STATUS = 'PL'
                    AND SSN_ID = :WK_OBJECT;
              END
              ELSE
              BEGIN
                 UPDATE PICK_ITEM SET DESPATCH_LOCATION = :WK_LOCN_ID
                    WHERE DEVICE_ID = :WK_DEVICE 
                    AND SSN_ID = :WK_OBJECT
                    AND PICK_LINE_STATUS = 'PL';
              END
              IF (WK_PI_STATUS = 'DS') THEN
              BEGIN
                 /* UPDATE PICK_ITEM_DETAIL SET PICK_DETAIL_STATUS = :WK_PI_STATUS */
                 UPDATE PICK_ITEM_DETAIL SET DESPATCH_LOCATION = :WK_LOCN_ID,
                    PICK_DETAIL_STATUS = :WK_PI_STATUS
                    WHERE DEVICE_ID = :WK_DEVICE 
                    AND SSN_ID = :WK_OBJECT
                    AND PICK_DETAIL_STATUS = 'PL';
              END
           END
           ELSE
           BEGIN
              IF (NEW.TRN_CODE = 'P') THEN
              BEGIN
                 /* class is P */
                 FOR SELECT PID.PICK_DETAIL_ID, PID.SSN_ID 
                    FROM PICK_ITEM_DETAIL PID 
                    JOIN ISSN ISS ON ISS.SSN_ID = PID.SSN_ID 
                    WHERE PID.DEVICE_ID = :WK_DEVICE 
                      AND PID.PICK_DETAIL_STATUS = 'PL'
                      AND ISS.PROD_ID = :WK_OBJECT
                     INTO :WK_PID_ID, :WK_SSN_ID
                 DO
                 BEGIN
                    UPDATE ISSN SET ISSN_STATUS = :WK_PI_STATUS,
                        PREV_PREV_WH_ID = PREV_WH_ID,
                        PREV_PREV_LOCN_ID = PREV_LOCN_ID,
                        PREV_WH_ID = WH_ID,
                        PREV_LOCN_ID = LOCN_ID,
                        WH_ID = :WK_WH_ID,
                        LOCN_ID = :WK_LOCN_ID
                    WHERE SSN_ID = :WK_SSN_ID;
                    UPDATE PICK_ITEM_DETAIL SET DESPATCH_LOCATION = :WK_LOCN_ID
                    WHERE PICK_DETAIL_ID = :WK_PID_ID;
                 END
                 /* update item to PL or DS 
                 */
                 IF (WK_PI_STATUS = 'DS') THEN
                 BEGIN
                    UPDATE PICK_ITEM SET DESPATCH_LOCATION = :WK_LOCN_ID,
                       PICK_LINE_STATUS = 'DS'
                       WHERE DEVICE_ID = :WK_DEVICE 
                       AND PICK_LINE_STATUS = 'PL'
                       AND PROD_ID = :WK_OBJECT;
                 END
                 ELSE
                 BEGIN
                    UPDATE PICK_ITEM SET DESPATCH_LOCATION = :WK_LOCN_ID
                       WHERE DEVICE_ID = :WK_DEVICE 
                       AND PROD_ID = :WK_OBJECT
                       AND PICK_LINE_STATUS = 'PL';
                 END
                 IF (WK_PI_STATUS = 'DS') THEN
                 BEGIN
                    FOR SELECT PID.PICK_DETAIL_ID, PI.PICK_LINE_STATUS  
                       FROM PICK_ITEM_DETAIL  PID 
                       JOIN PICK_ITEM PI 
                       ON PI.PICK_LABEL_NO = PID.PICK_LABEL_NO
                       WHERE PID.DEVICE_ID = :WK_DEVICE 
                         AND PID.PICK_DETAIL_STATUS = 'PL'
                         AND PI.PROD_ID = :WK_OBJECT
                        INTO :WK_PID_ID, :WK_PI_STATUS2
                    DO
                    BEGIN
                       /* UPDATE PICK_ITEM_DETAIL SET PICK_DETAIL_STATUS = :WK_PI_STATUS2 */
                       UPDATE PICK_ITEM_DETAIL SET DESPATCH_LOCATION = :WK_LOCN_ID,
                          PICK_DETAIL_STATUS = :WK_PI_STATUS2
                          WHERE PICK_DETAIL_ID = :WK_PID_ID;
                    END
                 END
              END
              ELSE
              BEGIN
                 IF (NEW.TRN_CODE = 'G') THEN
                 BEGIN
                    /* class is G */
                    WK_FROM_LOCN = ALLTRIM(WK_REF);
                    WK_ORDER = NEW.SUB_LOCN_ID;
                    /*   AND PID.DESPATCH_LOCATION = :WK_FROM_LOCN */
                    FOR SELECT PID.PICK_DETAIL_ID, PID.SSN_ID 
                       FROM PICK_ITEM_DETAIL PID 
                       JOIN PICK_ITEM PI ON PI.PICK_LABEL_NO = PID.PICK_LABEL_NO 
                       JOIN ISSN ISS ON ISS.SSN_ID = PID.SSN_ID 
                       WHERE PID.PICK_DETAIL_STATUS = 'PL'
                         AND PI.PICK_ORDER = :WK_ORDER
                         AND ISS.PROD_ID = :WK_OBJECT
                        INTO :WK_PID_ID, :WK_SSN_ID
                    DO
                    BEGIN
                       UPDATE ISSN SET ISSN_STATUS = :WK_PI_STATUS,
                           PREV_PREV_WH_ID = PREV_WH_ID,
                           PREV_PREV_LOCN_ID = PREV_LOCN_ID,
                           PREV_WH_ID = WH_ID,
                           PREV_LOCN_ID = LOCN_ID,
                           WH_ID = :WK_WH_ID,
                           LOCN_ID = :WK_LOCN_ID
                       WHERE SSN_ID = :WK_SSN_ID;
                       UPDATE PICK_ITEM_DETAIL SET DESPATCH_LOCATION = :WK_LOCN_ID
                       WHERE PICK_DETAIL_ID = :WK_PID_ID;
                    END
                    /* update item to PL or DS 
                    */
                    IF (WK_PI_STATUS = 'DS') THEN
                    BEGIN
                       /* for locations in pick_locations
                          if all issn gone from location
                          then update status */
                       FOR SELECT WH_ID, LOCN_ID 
                           FROM PICK_LOCATION
                           WHERE PICK_ORDER = :WK_ORDER
                           AND PICK_LOCATION_STATUS = 'OP'
                           AND LOCN_ID = :WK_FROM_LOCN
                           INTO :WK_PL_WH_ID, :WK_PL_LOCN_ID
                       DO
                       BEGIN
                          WK_ISS_ISSN_ID = NULL;
                          /*
                          SELECT FIRST 1 SSN_ID
                          FROM ISSN
                          WHERE WH_ID = :WK_PL_WH_ID
                          AND   LOCN_ID = :WK_PL_LOCN_ID
                          AND   CURRENT_QTY > 0
                          AND SSN_ID IN (SELECT PID.SSN_ID 
                                         FROM PICK_ITEM PI 
                                         JOIN PICK_ITEM_DETAIL PID ON PI.PICK_LABEL_NO = PID.PICK_LABEL_NO
                                         WHERE PI.PICK_ORDER = :WK_ORDER
                                         AND PID.PICK_DETAIL_STATUS <> 'XX' 
                                         AND PID.PICK_DETAIL_STATUS <> 'DX' )
                          INTO :WK_ISS_ISSN_ID;
                          */
                          IF (WK_ISS_ISSN_ID IS NULL) THEN
                          BEGIN
                             UPDATE PICK_LOCATION
                             SET PICK_LOCATION_STATUS = 'DS'
                             WHERE PICK_ORDER = :WK_ORDER
                             AND WH_ID = :WK_PL_WH_ID
                             AND   LOCN_ID = :WK_PL_LOCN_ID
                             AND PICK_LOCATION_STATUS = 'OP';
                          END
                       END
                       UPDATE PICK_ITEM SET DESPATCH_LOCATION = :WK_LOCN_ID,
                          PICK_LINE_STATUS = 'DS'
                          WHERE PICK_LINE_STATUS = 'PL'
                          AND PICK_ORDER = :WK_ORDER
                          AND PROD_ID = :WK_OBJECT;
                    END
                    ELSE
                    BEGIN
                       UPDATE PICK_ITEM SET DESPATCH_LOCATION = :WK_LOCN_ID
                          WHERE PICK_LINE_STATUS = 'PL'
                          AND PICK_ORDER = :WK_ORDER
                          AND PROD_ID = :WK_OBJECT;
                    END
                    IF (WK_PI_STATUS = 'DS') THEN
                    BEGIN
                       FOR SELECT PID.PICK_DETAIL_ID, PI.PICK_LINE_STATUS  
                          FROM PICK_ITEM_DETAIL  PID 
                          JOIN PICK_ITEM PI 
                          ON PI.PICK_LABEL_NO = PID.PICK_LABEL_NO
                          WHERE PID.PICK_DETAIL_STATUS = 'PL'
                            AND PI.PICK_ORDER = :WK_ORDER
                            AND PI.PROD_ID = :WK_OBJECT
                           INTO :WK_PID_ID, :WK_PI_STATUS2
                       DO
                       BEGIN
                          /* UPDATE PICK_ITEM_DETAIL SET PICK_DETAIL_STATUS = :WK_PI_STATUS2 */
                          UPDATE PICK_ITEM_DETAIL SET DESPATCH_LOCATION = :WK_LOCN_ID,
                              PICK_DETAIL_STATUS = :WK_PI_STATUS2
                             WHERE PICK_DETAIL_ID = :WK_PID_ID;
                       END
                    END
                 END 
                 ELSE
                 BEGIN
                    /* class is L */
                    IF (NEW.TRN_CODE = 'L') THEN
                    BEGIN
                       EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_REF, 1  RETURNING_VALUES :WK_FROM_WH_ID ; 
                       EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_REF, 2  RETURNING_VALUES :WK_FROM_LOCN ; 
                       WK_ORDER = NEW.OBJECT;
                       /*   AND PID.DESPATCH_LOCATION = :WK_FROM_LOCN */
                       FOR SELECT PID.PICK_DETAIL_ID, PID.SSN_ID 
                          FROM PICK_ITEM PI 
                          JOIN PICK_ITEM_DETAIL PID ON PI.PICK_LABEL_NO = PID.PICK_LABEL_NO 
                          JOIN ISSN ISS ON ISS.SSN_ID = PID.SSN_ID 
                          WHERE PI.PICK_ORDER = :WK_ORDER
                            AND PID.PICK_DETAIL_STATUS = 'PL'
                            AND ISS.WH_ID = :WK_FROM_WH_ID
                            AND ISS.LOCN_ID = :WK_FROM_LOCN
                           INTO :WK_PID_ID, :WK_SSN_ID
                       DO
                       BEGIN
                          UPDATE ISSN SET ISSN_STATUS = :WK_PI_STATUS,
                              PREV_PREV_WH_ID = PREV_WH_ID,
                              PREV_PREV_LOCN_ID = PREV_LOCN_ID,
                              PREV_WH_ID = WH_ID,
                              PREV_LOCN_ID = LOCN_ID,
                              WH_ID = :WK_WH_ID,
                              LOCN_ID = :WK_LOCN_ID
                          WHERE SSN_ID = :WK_SSN_ID;
                          UPDATE PICK_ITEM_DETAIL SET DESPATCH_LOCATION = :WK_LOCN_ID
                          WHERE PICK_DETAIL_ID = :WK_PID_ID;
                       END
                       /* update item to PL or DS 
                       */
                       IF (WK_PI_STATUS = 'DS') THEN
                       BEGIN
                          /* for locations in pick_locations
                             if all issn gone from location
                             then update status */
                          FOR SELECT WH_ID, LOCN_ID 
                              FROM PICK_LOCATION
                              WHERE PICK_ORDER = :WK_ORDER
                              AND PICK_LOCATION_STATUS = 'OP'
                              AND PICK_LOCATION.WH_ID = :WK_FROM_WH_ID
                              AND PICK_LOCATION.LOCN_ID = :WK_FROM_LOCN
                              INTO :WK_PL_WH_ID, :WK_PL_LOCN_ID
                          DO
                          BEGIN
                             WK_ISS_ISSN_ID = NULL;
                             /*
                             SELECT FIRST 1 SSN_ID
                             FROM ISSN
                             WHERE WH_ID = :WK_PL_WH_ID
                             AND   LOCN_ID = :WK_PL_LOCN_ID
                             AND   CURRENT_QTY > 0
                             AND SSN_ID IN (SELECT PID.SSN_ID 
                                            FROM PICK_ITEM PI 
                                            JOIN PICK_ITEM_DETAIL PID ON PI.PICK_LABEL_NO = PID.PICK_LABEL_NO
                                            WHERE PI.PICK_ORDER = :WK_ORDER
                                            AND PID.PICK_DETAIL_STATUS <> 'XX' 
                                            AND PID.PICK_DETAIL_STATUS <> 'DX' )
                             INTO :WK_ISS_ISSN_ID;
                             */
                             IF (WK_ISS_ISSN_ID IS NULL) THEN
                             BEGIN
                                UPDATE PICK_LOCATION
                                SET PICK_LOCATION_STATUS = 'DS'
                                WHERE PICK_ORDER = :WK_ORDER
                                AND WH_ID = :WK_PL_WH_ID
                                AND   LOCN_ID = :WK_PL_LOCN_ID
                                AND PICK_LOCATION_STATUS = 'OP';
                             END
                          END
                          UPDATE PICK_ITEM SET DESPATCH_LOCATION = :WK_LOCN_ID,
                             PICK_LINE_STATUS = 'DS'
                             WHERE PICK_LINE_STATUS = 'PL'
                             AND PICK_ORDER = :WK_ORDER
                             AND EXISTS( SELECT 1 
                                         FROM PICK_ITEM_DETAIL P3 
                                  WHERE  P3.PICK_LABEL_NO = PICK_ITEM.PICK_LABEL_NO
                                  AND   P3.DESPATCH_LOCATION = :WK_PL_LOCN_ID
                                  AND   P3.PICK_DETAIL_STATUS IN ('PG','PL') );
                       END
                       ELSE
                       BEGIN
                          UPDATE PICK_ITEM SET DESPATCH_LOCATION = :WK_LOCN_ID
                             WHERE PICK_LINE_STATUS = 'PL'
                             AND PICK_ORDER = :WK_ORDER
                             AND EXISTS( SELECT 1 
                                         FROM PICK_ITEM_DETAIL P3 
                                  WHERE  P3.PICK_LABEL_NO = PICK_ITEM.PICK_LABEL_NO
                                  AND   P3.DESPATCH_LOCATION = :WK_PL_LOCN_ID
                                  AND   P3.PICK_DETAIL_STATUS IN ('PG','PL') );
                       END
                       IF (WK_PI_STATUS = 'DS') THEN
                       BEGIN
                          FOR SELECT PID.PICK_DETAIL_ID, PI.PICK_LINE_STATUS  
                             FROM PICK_ITEM_DETAIL  PID 
                             JOIN PICK_ITEM PI 
                             ON PI.PICK_LABEL_NO = PID.PICK_LABEL_NO
                             WHERE PID.PICK_DETAIL_STATUS = 'PL'
                               AND PI.PICK_ORDER = :WK_ORDER
                               AND   PID.DESPATCH_LOCATION = :WK_PL_LOCN_ID
                              INTO :WK_PID_ID, :WK_PI_STATUS2
                          DO
                          BEGIN
                             /* UPDATE PICK_ITEM_DETAIL SET PICK_DETAIL_STATUS = :WK_PI_STATUS2 */
                             UPDATE PICK_ITEM_DETAIL SET DESPATCH_LOCATION = :WK_LOCN_ID,
                                PICK_DETAIL_STATUS = :WK_PI_STATUS2
                                WHERE PICK_DETAIL_ID = :WK_PID_ID;
                          END
                       END
                    END
                 END
              END
           END
        END
     END
   EXECUTE PROCEDURE UPDATE_TRAN (WK_RECORD, 'T','Processed successfully');
/*
     WK_DATE_TXT = CAST(CAST('NOW' AS TIMESTAMP) AS CHAR(24));
     WK_LOG = 'TRN_TYPE ' || NEW.TRN_TYPE ||
     ' TRN_CODE ' || NEW.TRN_CODE || ' date ' || WK_DATE_TXT ||
     ' OBJECT ' || NEW.OBJECT || ' date ' || WK_DATE_TXT || ' do pkua ';
     INSERT INTO LOG(DESCRIPTION) VALUES(:WK_LOG);
   had to put pkua back for vb handheld
*/
   EXECUTE PROCEDURE ADD_TRAN(
        :WK_DEVICE,
        '',
        '',
        'PKUA',
        'I',
        :WK_DATE,
        '',
        0,
        'F',
        '',
        'MASTER',
        0,
        '',
        'SSSSSSSSS',
        :WK_USER,
        :WK_DEVICE);
   IF (NEW.COMPLETE = 'f') THEN
   BEGIN
      WK_DUMMY = '1';
   END
   ELSE
   BEGIN
     /* EXECUTE PROCEDURE TRAN_ARCHIVE; */
   END
/*
     WK_DATE_TXT = CAST(CAST('NOW' AS TIMESTAMP) AS CHAR(24));
     WK_LOG = 'TRN_TYPE ' || NEW.TRN_TYPE ||
     ' TRN_CODE ' || NEW.TRN_CODE || ' date ' || WK_DATE_TXT ||
     ' OBJECT ' || NEW.OBJECT || ' date ' || WK_DATE_TXT || ' end ';
     INSERT INTO LOG(DESCRIPTION) VALUES(:WK_LOG);
*/
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_DSOT FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 57 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_RECORD  INTEGER;
DECLARE VARIABLE WK_CARRIER VARCHAR(10);
DECLARE VARIABLE WK_OBJECT  VARCHAR(30);
DECLARE VARIABLE WK_CONSIGNMENT VARCHAR(20);
DECLARE VARIABLE WK_ACCOUNT VARCHAR(10);
DECLARE VARIABLE WK_CLASS CHAR(1);
DECLARE VARIABLE WK_LABEL_QTY INTEGER;
DECLARE VARIABLE WK_REF  VARCHAR(255);
DECLARE VARIABLE WK_SO  VARCHAR(10);
DECLARE VARIABLE WK_WH_ID  VARCHAR(2);
DECLARE VARIABLE WK_LOCN_ID  VARCHAR(10);
DECLARE VARIABLE WK_PALLET_QTYX CHAR(4);
DECLARE VARIABLE WK_PALLET_QTY INTEGER;
DECLARE VARIABLE WK_PALLET_OWNER VARCHAR(10);
DECLARE VARIABLE WK_CARTON_QTYX CHAR(4);
DECLARE VARIABLE WK_CARTON_QTY INTEGER;
DECLARE VARIABLE WK_SATCHEL_QTYX CHAR(4);
DECLARE VARIABLE WK_SATCHEL_QTY INTEGER;
DECLARE VARIABLE WK_WEIGHT_X CHAR(5);
DECLARE VARIABLE WK_WEIGHT INTEGER;
DECLARE VARIABLE WK_WEIGHT_REAL INTEGER;
DECLARE VARIABLE WK_VOLUME_X CHAR(5);
DECLARE VARIABLE WK_VOLUME INTEGER;
DECLARE VARIABLE WK_PAYER CHAR(1);
DECLARE VARIABLE WK_LABEL_TYPE CHAR(1);
DECLARE VARIABLE WK_SERVICE_TYPE CHAR(3);
DECLARE VARIABLE WK_PRINTER CHAR(2);
DECLARE VARIABLE WK_PACK_TYPE CHAR(1);
DECLARE VARIABLE WK_DESPATCH_ID INTEGER;
DECLARE VARIABLE WK_DATE TIMESTAMP;
DECLARE VARIABLE WK_USER VARCHAR(10);
DECLARE VARIABLE WK_DEVICE VARCHAR(2);
DECLARE VARIABLE WK_SENDER_ACCT VARCHAR(10);
DECLARE VARIABLE WK_RECEIVER_ACCT VARCHAR(10);
DECLARE VARIABLE WK_POSTCODE VARCHAR(10);
DECLARE VARIABLE WK_SUBURB VARCHAR(25);
DECLARE VARIABLE WK_LABEL_NO INTEGER;
DECLARE VARIABLE WK_PI_LABEL_NO VARCHAR(10);
DECLARE VARIABLE WK_PACK_ID INTEGER;
DECLARE VARIABLE WK_DETAIL_ID INTEGER;
DECLARE VARIABLE WK_SSN_ID VARCHAR(20);
DECLARE VARIABLE WK_FOUND INTEGER;
DECLARE VARIABLE WK_DO_DSDX CHAR(1);
DECLARE VARIABLE WK_PACK_QTY INTEGER;
DECLARE VARIABLE WK_SERVICE_RECORD_ID INTEGER;
DECLARE VARIABLE WK_SERVICE_RECORD_X  VARCHAR(10);
/*
DECLARE VARIABLE WK_RES INTEGER;
DECLARE VARIABLE WK_BUFFER VARCHAR(1024);
*/
/*
16-07-05 added auto dsdx for bluescope
   this uses the new transaction reruning from a scheduled task
*/
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'DSOT') THEN
  BEGIN
     WK_CARRIER = NEW.SUB_LOCN_ID;
     WK_OBJECT = NEW.OBJECT;
     WK_CONSIGNMENT = substr(WK_OBJECT,1, 20);
     WK_ACCOUNT = substr(WK_OBJECT,21, 30);
     WK_CLASS = NEW.TRN_CODE;
     WK_LABEL_QTY = NEW.QTY;
     WK_WH_ID = NEW.WH_ID;
     WK_LOCN_ID = NEW.LOCN_ID;
     WK_RECORD = NEW.RECORD_ID; 
/*
     WK_BUFFER = 'carrier ' || WK_CARRIER || ' connote ' || WK_CONSIGNMENT || ' account ' || WK_ACCOUNT || ' class ' || WK_CLASS || ' qty ' || WK_LABEL_QTY || ' wh_id ' || WK_WH_ID || ' locn ' || WK_LOCN_ID || ' record ' || WK_RECORD;
*/
     WK_DO_DSDX = 'F';
     SELECT SEND_DSDX FROM CONTROL INTO :WK_DO_DSDX;

     IF (WK_CLASS = 'S') THEN
     BEGIN
        WK_SO = WK_WH_ID || WK_LOCN_ID;
/*
        SELECT PERSON.POST_CODE, PERSON.CITY  
        FROM PICK_ORDER
        JOIN PERSON ON PERSON.PERSON_ID = PICK_ORDER.PERSON_ID
        WHERE PICK_ORDER.PICK_ORDER = :WK_SO
*/
        SELECT PICK_ORDER.P_POST_CODE, PICK_ORDER.P_CITY  
        FROM PICK_ORDER
        WHERE PICK_ORDER.PICK_ORDER = :WK_SO
        INTO :WK_POSTCODE, :WK_SUBURB;
     END
     ELSE
     IF (WK_CLASS = 'L') THEN
     BEGIN
        WK_SO = WK_WH_ID || WK_LOCN_ID;

/*
        SELECT FIRST 1 PICK_ITEM.PICK_ORDER    
        FROM ISSN
        JOIN LOCATION ON LOCATION.WH_ID = ISSN.WH_ID AND LOCATION.LOCN_ID = ISSN.LOCN_ID 
        JOIN PICK_ITEM_DETAIL ON PICK_ITEM_DETAIL.SSN_ID = ISSN.SSN_ID  
        JOIN PICK_ITEM ON PICK_ITEM.PICK_LABEL_NO = PICK_ITEM_DETAIL.PICK_LABEL_NO  
        WHERE ISSN.WH_ID = :WK_WH_ID 
        AND ISSN.LOCN_ID = :WK_LOCN_ID 
        AND ISSN.ISSN_STATUS = 'DS' 
        AND PICK_ITEM.PICK_LINE_STATUS = 'DS'
        AND LOCATION.STORE_AREA = 'DS'
        INTO :WK_SO;
*/
        SELECT FIRST 1 PICK_ITEM.PICK_ORDER    
        FROM PICK_ITEM_DETAIL 
        JOIN PICK_ITEM ON PICK_ITEM.PICK_LABEL_NO = PICK_ITEM_DETAIL.PICK_LABEL_NO  
        WHERE PICK_ITEM_DETAIL.PICK_DETAIL_STATUS = 'DS'
        AND PICK_ITEM_DETAIL.DESPATCH_LOCATION = :WK_LOCN_ID 
        AND PICK_ITEM_DETAIL.DESPATCH_ID IS NULL
        INTO :WK_SO;

/*
        SELECT PERSON.POST_CODE, PERSON.CITY  
        FROM PICK_ORDER
        JOIN PERSON ON PERSON.PERSON_ID = PICK_ORDER.PERSON_ID
        WHERE PICK_ORDER.PICK_ORDER = :WK_SO
*/
        SELECT PICK_ORDER.P_POST_CODE, PICK_ORDER.P_CITY  
        FROM PICK_ORDER
        WHERE PICK_ORDER.PICK_ORDER = :WK_SO
        INTO :WK_POSTCODE, :WK_SUBURB;
     END
     WK_REF = NEW.REFERENCE;
/*
     WK_BUFFER = 'ref [' || WK_REF || ']';
*/

     WK_PALLET_QTYX = SUBSTR(WK_REF,1,4);
     WK_PALLET_OWNER = SUBSTR(WK_REF,5,14);
     WK_CARTON_QTYX = SUBSTR(WK_REF,15,18);
     WK_SATCHEL_QTYX = SUBSTR(WK_REF,19,22);
     WK_WEIGHT_X = SUBSTR(WK_REF,23,27);
     WK_VOLUME_X = SUBSTR(WK_REF,28,32);
     WK_PAYER = SUBSTR(WK_REF,33,33);
     WK_LABEL_TYPE = SUBSTR(WK_REF,34,34);
     WK_SERVICE_TYPE = SUBSTR(WK_REF,35,37);
     WK_PACK_TYPE = SUBSTR(WK_REF,39,39);
     WK_PRINTER = 'P' || SUBSTR(WK_REF,40,40);
     WK_SERVICE_RECORD_X =  SUBSTR(WK_REF,41,50);
     WK_DATE = NEW.TRN_DATE;
     WK_USER = NEW.PERSON_ID;
     WK_DEVICE = NEW.DEVICE_ID;
/*
     WK_BUFFER = 'pallets ' || WK_PALLET_QTYX || ' owner ' || WK_PALLET_OWNER || ' cartons ' || WK_CARTON_QTYX || ' satchels ' || WK_SATCHEL_QTYX || ' weight ' || WK_WEIGHT_X || ' volume ' || WK_VOLUME_X || ' payer ' || WK_PAYER || ' label type ' || WK_LABEL_TYPE || ' service ' || WK_SERVICE_TYPE || ' printer ' || WK_PRINTER ;
*/
     WK_PALLET_QTY = CAST(WK_PALLET_QTYX AS INTEGER);
     WK_CARTON_QTY = CAST(WK_CARTON_QTYX AS INTEGER);
     WK_SATCHEL_QTY = CAST(WK_SATCHEL_QTYX AS INTEGER);
     WK_WEIGHT = CAST(WK_WEIGHT_X AS INTEGER);
     WK_VOLUME = CAST(WK_VOLUME_X AS INTEGER);
     BEGIN
        WK_SERVICE_RECORD_ID = CAST(WK_SERVICE_RECORD_X AS INTEGER);
        WHEN SQLCODE -413
        DO
        BEGIN
           /* No Service Record ID */
           WK_SERVICE_RECORD_ID = NULL;
        END
     END
     WK_WEIGHT_REAL = WK_WEIGHT;
     IF (WK_VOLUME <> 0) THEN
     BEGIN
        WK_WEIGHT = 0;
     END
     /* create pick_despatch */
     IF (WK_PAYER = 'R') THEN
     BEGIN
        WK_SENDER_ACCT = '';
        WK_RECEIVER_ACCT = WK_ACCOUNT;
     END
     ELSE
     IF (WK_PAYER = 'S') THEN
     BEGIN
        WK_SENDER_ACCT = WK_ACCOUNT;
        WK_RECEIVER_ACCT = '';
     END
     WK_PACK_QTY = WK_PALLET_QTY + WK_CARTON_QTY + WK_SATCHEL_QTY;
/*
     WK_BUFFER = 'pallets ' || WK_PALLET_QTY || ' cartons ' || WK_CARTON_QTY || ' satchels ' || WK_SATCHEL_QTY || ' weight ' || WK_WEIGHT || ' volume ' || WK_VOLUME|| ' sender ' || WK_SENDER_ACCT || ' receiver ' || WK_RECEIVER_ACCT || ' payer ' || WK_PAYER ;
*/
     WK_DESPATCH_ID = GEN_ID(DESPATCH_ID_GEN,1); 
     /* create pick_despatch */
     INSERT INTO PICK_DESPATCH
        (DESPATCH_ID ,
        AWB_CONSIGNMENT_NO ,
        PICKD_CARRIER_ID ,
        PICKD_SERVICE_TYPE ,
        PICKD_CHARGE_TO ,
        SENDER_ACCOUNT ,
        RECEIVER_ACCOUNT ,
        PICKD_POST_CODE ,
        PICKD_SUBURB ,
        PICKD_PALLET_QTY ,
        PICKD_CARTON_QTY ,
        PICKD_SATCHEL_QTY ,
        PICKD_WT_CALC ,
        PICKD_WT_ACTUAL ,
        PICKD_VOL_ACTUAL ,
        PICKD_PALLET_OWNER ,
        PICKD_ADDRESS_QTY ,
        PICKD_LABEL_START ,
        PICKD_LABEL_TYPE ,
        USER_ID ,
        DEVICE_ID ,
        CREATE_DATE,
        DESPATCH_STATUS,
        PACK_TYPE ,
        PICKD_SERVICE_RECORD_ID )
        VALUES (
        :WK_DESPATCH_ID,
        :WK_CONSIGNMENT,
        :WK_CARRIER,
        :WK_SERVICE_TYPE,
        :WK_PAYER,
        :WK_SENDER_ACCT,
        :WK_RECEIVER_ACCT,
        :WK_POSTCODE, 
        :WK_SUBURB,
        :WK_PALLET_QTY,
        :WK_CARTON_QTY,
        :WK_SATCHEL_QTY,
        :WK_WEIGHT,
        :WK_WEIGHT_REAL,
        :WK_VOLUME, 
        :WK_PALLET_OWNER,
        :WK_LABEL_QTY,
        NULL , /* no label start since im not printing labels */
        :WK_LABEL_TYPE,
        :WK_USER,
        :WK_DEVICE,
        :WK_DATE,
        'DC',
        :WK_PACK_TYPE,
        :WK_SERVICE_RECORD_ID);
     /* now create label qty of packs - with null label no */   
     WK_LABEL_NO = 0;
     /* WHILE (WK_LABEL_NO < WK_LABEL_QTY) DO */
     IF (WK_PACK_QTY < WK_LABEL_QTY) THEN
     BEGIN
        WK_PACK_QTY = WK_LABEL_QTY;
     END
     WHILE (WK_LABEL_NO < WK_PACK_QTY) DO
     BEGIN
        WK_LABEL_NO = WK_LABEL_NO + 1;
        WK_PACK_ID = GEN_ID(DESPATCH_PACK_ID_GEN,1); 
        INSERT INTO PACK_ID(PACK_ID, DESPATCH_ID, CREATE_DATE)
        VALUES (:WK_PACK_ID, :WK_DESPATCH_ID, :WK_DATE);
     END
     IF (WK_CLASS = 'S') THEN
     BEGIN
        FOR SELECT PICK_ITEM_DETAIL.PICK_DETAIL_ID, PICK_ITEM_DETAIL.SSN_ID, PICK_ITEM_DETAIL.PICK_LABEL_NO
        FROM PICK_ITEM 
        JOIN PICK_ITEM_DETAIL ON PICK_ITEM_DETAIL.PICK_LABEL_NO = PICK_ITEM.PICK_LABEL_NO  
        JOIN ISSN ON ISSN.SSN_ID = PICK_ITEM_DETAIL.SSN_ID
        JOIN LOCATION ON LOCATION.WH_ID = ISSN.WH_ID AND LOCATION.LOCN_ID = ISSN.LOCN_ID 
        WHERE PICK_ITEM.PICK_ORDER = :WK_SO 
        AND PICK_ITEM.PICK_LINE_STATUS = 'DS'
        AND PICK_ITEM_DETAIL.PICK_DETAIL_STATUS = 'DS'
        /* AND PICK_ITEM_DETAIL.DESPATCH_ID IS NULL */
           AND ISSN.ISSN_STATUS = 'DS'  
        AND LOCATION.STORE_AREA = 'DS'
        INTO :WK_DETAIL_ID, :WK_SSN_ID, :WK_PI_LABEL_NO
        DO
        BEGIN
           UPDATE PICK_ITEM_DETAIL 
           SET DESPATCH_ID = :WK_DESPATCH_ID,
               PICK_DETAIL_STATUS = 'DC'
           WHERE PICK_DETAIL_ID = :WK_DETAIL_ID;
           UPDATE ISSN SET ISSN_STATUS = 'DC'
           WHERE SSN_ID = :WK_SSN_ID;
           /* check despatched all of line */
           WK_FOUND = 0;
           SELECT FIRST 1 1 FROM PICK_ITEM_DETAIL
           WHERE PICK_LABEL_NO = :WK_PI_LABEL_NO
             AND PICK_DETAIL_STATUS IN ('DS','PL','PG')
             AND SSN_ID <> ''
           INTO :WK_FOUND;
           IF (WK_FOUND IS NULL) THEN
              WK_FOUND = 0;
           IF (WK_FOUND = 0) THEN
           BEGIN
               /* no undespatched ssns on item */
               UPDATE PICK_ITEM SET PICK_LINE_STATUS = 'DC'
               WHERE PICK_LABEL_NO = :WK_PI_LABEL_NO;
           END
        END
     END
     ELSE
     IF (WK_CLASS = 'L') THEN
     BEGIN
/*
        FOR SELECT PICK_ITEM_DETAIL.PICK_DETAIL_ID, PICK_ITEM_DETAIL.SSN_ID
        FROM ISSN
        JOIN LOCATION ON LOCATION.WH_ID = ISSN.WH_ID AND LOCATION.LOCN_ID = ISSN.LOCN_ID 
        JOIN PICK_ITEM_DETAIL ON PICK_ITEM_DETAIL.SSN_ID = ISSN.SSN_ID  
        JOIN PICK_ITEM ON PICK_ITEM.PICK_LABEL_NO = PICK_ITEM_DETAIL.PICK_LABEL_NO  
        WHERE ISSN.WH_ID = :WK_WH_ID 
        AND ISSN.LOCN_ID = :WK_LOCN_ID 
        AND ISSN.ISSN_STATUS = 'DS' 
        AND PICK_ITEM.PICK_LINE_STATUS = 'DS'
        AND PICK_ITEM_DETAIL.PICK_DETAIL_STATUS = 'DS'
        AND PICK_ITEM_DETAIL.DESPATCH_ID IS NULL
        AND LOCATION.STORE_AREA = 'DS'
        INTO :WK_DETAIL_ID, :WK_SSN_ID
*/
        FOR SELECT PICK_ITEM_DETAIL.PICK_DETAIL_ID, PICK_ITEM_DETAIL.SSN_ID, PICK_ITEM_DETAIL.PICK_LABEL_NO
        FROM PICK_ITEM_DETAIL 
        JOIN PICK_ITEM ON PICK_ITEM.PICK_LABEL_NO = PICK_ITEM_DETAIL.PICK_LABEL_NO  
        WHERE PICK_ITEM_DETAIL.PICK_DETAIL_STATUS = 'DS'
        AND PICK_ITEM_DETAIL.DESPATCH_LOCATION = :WK_LOCN_ID 
        AND PICK_ITEM_DETAIL.DESPATCH_ID IS NULL
        INTO :WK_DETAIL_ID, :WK_SSN_ID, :WK_PI_LABEL_NO
        DO
        BEGIN
           UPDATE PICK_ITEM_DETAIL 
           SET DESPATCH_ID = :WK_DESPATCH_ID,
               PICK_DETAIL_STATUS = 'DC'
           WHERE PICK_DETAIL_ID = :WK_DETAIL_ID;
           UPDATE ISSN SET ISSN_STATUS = 'DC'
           WHERE SSN_ID = :WK_SSN_ID;
           /* check despatched all of line */
           WK_FOUND = 0;
           SELECT FIRST 1 1 FROM PICK_ITEM_DETAIL
           WHERE PICK_LABEL_NO = :WK_PI_LABEL_NO
             AND PICK_DETAIL_STATUS IN ('DS','PL','PG')
             AND SSN_ID <> ''
           INTO :WK_FOUND;
           IF (WK_FOUND IS NULL) THEN
              WK_FOUND = 0;
           IF (WK_FOUND = 0) THEN
           BEGIN
               /* no undespatched ssns on item */
               UPDATE PICK_ITEM SET PICK_LINE_STATUS = 'DC'
               WHERE PICK_LABEL_NO = :WK_PI_LABEL_NO;
           END
        END
     END
     IF (WK_DO_DSDX = 'T') THEN
     BEGIN
        INSERT INTO TRANSACTIONS_ARCHIVE 
           (WH_ID, LOCN_ID, OBJECT, TRN_TYPE, TRN_CODE, TRN_DATE, 
            REFERENCE, QTY, ERROR_TEXT, INSTANCE_ID, EXPORTED, 
            SUB_LOCN_ID, INPUT_SOURCE, PERSON_ID, DEVICE_ID, COMPLETE)
        VALUES ('','','','DSDX','D',NEW.TRN_DATE,
            :WK_CONSIGNMENT, 0, 'ReRun Transaction',NEW.INSTANCE_ID, 0,
            '','SSSSSSSSS',NEW.PERSON_ID,NEW.DEVICE_ID,'R'); 
     END
     UPDATE TRANSACTIONS SET COMPLETE='T',ERROR_TEXT='Processed successfully' WHERE RECORD_ID = :WK_RECORD;

   /* EXECUTE PROCEDURE TRAN_ARCHIVE; */
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_DSST FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 57 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_RECORD  INTEGER;
DECLARE VARIABLE WK_CARRIER VARCHAR(10);
DECLARE VARIABLE WK_OBJECT  VARCHAR(30);
DECLARE VARIABLE WK_CONSIGNMENT VARCHAR(20);
DECLARE VARIABLE WK_ACCOUNT VARCHAR(10);
DECLARE VARIABLE WK_CLASS CHAR(1);
DECLARE VARIABLE WK_LABEL_QTY INTEGER;
DECLARE VARIABLE WK_REF  VARCHAR(40);
DECLARE VARIABLE WK_SO  VARCHAR(10);
DECLARE VARIABLE WK_WH_ID  VARCHAR(2);
DECLARE VARIABLE WK_LOCN_ID  VARCHAR(10);
DECLARE VARIABLE WK_PALLET_QTYX CHAR(4);
DECLARE VARIABLE WK_PALLET_QTY INTEGER;
DECLARE VARIABLE WK_PALLET_OWNER VARCHAR(10);
DECLARE VARIABLE WK_CARTON_QTYX CHAR(4);
DECLARE VARIABLE WK_CARTON_QTY INTEGER;
DECLARE VARIABLE WK_SATCHEL_QTYX CHAR(4);
DECLARE VARIABLE WK_SATCHEL_QTY INTEGER;
DECLARE VARIABLE WK_WEIGHT_X CHAR(5);
DECLARE VARIABLE WK_WEIGHT INTEGER;
DECLARE VARIABLE WK_WEIGHT_REAL INTEGER;
DECLARE VARIABLE WK_VOLUME_X CHAR(5);
DECLARE VARIABLE WK_VOLUME INTEGER;
DECLARE VARIABLE WK_PAYER CHAR(1);
DECLARE VARIABLE WK_LABEL_TYPE CHAR(1);
DECLARE VARIABLE WK_SERVICE_TYPE CHAR(3);
DECLARE VARIABLE WK_PRINTER CHAR(2);
DECLARE VARIABLE WK_PACK_TYPE CHAR(1);
DECLARE VARIABLE WK_DESPATCH_ID INTEGER;
DECLARE VARIABLE WK_DATE TIMESTAMP;
DECLARE VARIABLE WK_USER VARCHAR(10);
DECLARE VARIABLE WK_DEVICE VARCHAR(2);
DECLARE VARIABLE WK_SENDER_ACCT VARCHAR(10);
DECLARE VARIABLE WK_RECEIVER_ACCT VARCHAR(10);
DECLARE VARIABLE WK_POSTCODE VARCHAR(10);
DECLARE VARIABLE WK_SUBURB VARCHAR(25);
DECLARE VARIABLE WK_LABEL_NO INTEGER;
DECLARE VARIABLE WK_PI_LABEL_NO VARCHAR(10);
DECLARE VARIABLE WK_PACK_ID INTEGER;
DECLARE VARIABLE WK_DETAIL_ID INTEGER;
DECLARE VARIABLE WK_SSN_ID VARCHAR(20);
DECLARE VARIABLE WK_FOUND INTEGER;
DECLARE VARIABLE WK_DO_DSDX CHAR(1);
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'DSST') THEN
  BEGIN
     WK_CARRIER = NEW.SUB_LOCN_ID;
     WK_OBJECT = NEW.OBJECT;
     WK_CONSIGNMENT = substr(WK_OBJECT,1, 20);
     WK_ACCOUNT = substr(WK_OBJECT,21, 30);
     WK_CLASS = NEW.TRN_CODE;
     WK_LABEL_QTY = NEW.QTY;
     WK_WH_ID = NEW.WH_ID;
     WK_LOCN_ID = NEW.LOCN_ID;
     WK_RECORD = NEW.RECORD_ID; 
     WK_DO_DSDX = 'F';
     SELECT SEND_DSDX FROM CONTROL INTO :WK_DO_DSDX;
     IF (WK_CLASS = 'S') THEN
     BEGIN
        WK_SO = WK_WH_ID || WK_LOCN_ID;
/*
        SELECT PERSON.POST_CODE, PERSON.CITY  
        FROM PICK_ORDER
        JOIN PERSON ON PERSON.PERSON_ID = PICK_ORDER.PERSON_ID
        WHERE PICK_ORDER.PICK_ORDER = :WK_SO
*/
        SELECT PICK_ORDER.P_POST_CODE, PICK_ORDER.P_CITY  
        FROM PICK_ORDER
        WHERE PICK_ORDER.PICK_ORDER = :WK_SO
        INTO :WK_POSTCODE, :WK_SUBURB;
     END
     ELSE
     IF (WK_CLASS = 'L') THEN
     BEGIN
        WK_SO = WK_WH_ID || WK_LOCN_ID;

/*
        SELECT FIRST 1 PICK_ITEM.PICK_ORDER    
        FROM ISSN
        JOIN LOCATION ON LOCATION.WH_ID = ISSN.WH_ID AND LOCATION.LOCN_ID = ISSN.LOCN_ID 
        JOIN PICK_ITEM_DETAIL ON PICK_ITEM_DETAIL.SSN_ID = ISSN.SSN_ID  
        JOIN PICK_ITEM ON PICK_ITEM.PICK_LABEL_NO = PICK_ITEM_DETAIL.PICK_LABEL_NO  
        WHERE ISSN.WH_ID = :WK_WH_ID 
        AND ISSN.LOCN_ID = :WK_LOCN_ID 
        AND ISSN.ISSN_STATUS = 'DS' 
        AND PICK_ITEM.PICK_LINE_STATUS = 'DS'
        AND LOCATION.STORE_AREA = 'DS'
        INTO :WK_SO;
*/
        SELECT FIRST 1 PICK_ITEM.PICK_ORDER    
        FROM PICK_ITEM_DETAIL 
        JOIN PICK_ITEM ON PICK_ITEM.PICK_LABEL_NO = PICK_ITEM_DETAIL.PICK_LABEL_NO  
        WHERE PICK_ITEM_DETAIL.PICK_DETAIL_STATUS = 'DS'
        AND PICK_ITEM_DETAIL.DESPATCH_LOCATION = :WK_LOCN_ID 
        AND PICK_ITEM_DETAIL.DESPATCH_ID IS NULL
        INTO :WK_SO;

/*
        SELECT PERSON.POST_CODE, PERSON.CITY  
        FROM PICK_ORDER
        JOIN PERSON ON PERSON.PERSON_ID = PICK_ORDER.PERSON_ID
        WHERE PICK_ORDER.PICK_ORDER = :WK_SO
*/
        SELECT PICK_ORDER.P_POST_CODE, PICK_ORDER.P_CITY  
        FROM PICK_ORDER
        WHERE PICK_ORDER.PICK_ORDER = :WK_SO
        INTO :WK_POSTCODE, :WK_SUBURB;
     END
     WK_REF = NEW.REFERENCE;
     WK_PALLET_QTYX = SUBSTR(WK_REF,1,4);
     WK_PALLET_QTY = CAST(WK_PALLET_QTYX AS INTEGER);
     WK_PALLET_OWNER = SUBSTR(WK_REF,5,14);
     WK_CARTON_QTYX = SUBSTR(WK_REF,15,18);
     WK_CARTON_QTY = CAST(WK_CARTON_QTYX AS INTEGER);
     WK_SATCHEL_QTYX = SUBSTR(WK_REF,19,22);
     WK_SATCHEL_QTY = CAST(WK_SATCHEL_QTYX AS INTEGER);
     WK_WEIGHT_X = SUBSTR(WK_REF,23,27);
     WK_WEIGHT = CAST(WK_WEIGHT_X AS INTEGER);
     WK_VOLUME_X = SUBSTR(WK_REF,28,32);
     WK_VOLUME = CAST(WK_VOLUME_X AS INTEGER);
     WK_WEIGHT_REAL = WK_WEIGHT;
     IF (WK_VOLUME <> 0) THEN
     BEGIN
        WK_WEIGHT = 0;
     END
     WK_PAYER = SUBSTR(WK_REF,33,33);
     WK_LABEL_TYPE = SUBSTR(WK_REF,34,34);
     WK_SERVICE_TYPE = SUBSTR(WK_REF,35,37);
     WK_PACK_TYPE = SUBSTR(WK_REF,39,39);
     WK_PRINTER = 'P' || SUBSTR(WK_REF,40,40);
     WK_DATE = NEW.TRN_DATE;
     WK_USER = NEW.PERSON_ID;
     WK_DEVICE = NEW.DEVICE_ID;
     /* create pick_despatch */
     IF (WK_PAYER = 'R') THEN
     BEGIN
        WK_SENDER_ACCT = '';
        WK_RECEIVER_ACCT = WK_ACCOUNT;
     END
     ELSE
     IF (WK_PAYER = 'S') THEN
     BEGIN
        WK_SENDER_ACCT = WK_ACCOUNT;
        WK_RECEIVER_ACCT = '';
     END
     WK_DESPATCH_ID = GEN_ID(DESPATCH_ID_GEN,1); 
     /* create pick_despatch */
     INSERT INTO PICK_DESPATCH
        (DESPATCH_ID ,
        AWB_CONSIGNMENT_NO ,
        PICKD_CARRIER_ID ,
        PICKD_SERVICE_TYPE ,
        PICKD_CHARGE_TO ,
        SENDER_ACCOUNT ,
        RECEIVER_ACCOUNT ,
        PICKD_POST_CODE ,
        PICKD_SUBURB ,
        PICKD_PALLET_QTY ,
        PICKD_CARTON_QTY ,
        PICKD_SATCHEL_QTY ,
        PICKD_WT_CALC ,
        PICKD_WT_ACTUAL ,
        PICKD_VOL_ACTUAL ,
        PICKD_PALLET_OWNER ,
        PICKD_ADDRESS_QTY ,
        PICKD_LABEL_START ,
        PICKD_LABEL_TYPE ,
        USER_ID ,
        DEVICE_ID ,
        CREATE_DATE,
        DESPATCH_STATUS,
        PACK_TYPE )
        VALUES (
        :WK_DESPATCH_ID,
        :WK_CONSIGNMENT,
        :WK_CARRIER,
        :WK_SERVICE_TYPE,
        :WK_PAYER,
        :WK_SENDER_ACCT,
        :WK_RECEIVER_ACCT,
        :WK_POSTCODE, 
        :WK_SUBURB,
        :WK_PALLET_QTY,
        :WK_CARTON_QTY,
        :WK_SATCHEL_QTY,
        :WK_WEIGHT,
        :WK_WEIGHT_REAL,
        :WK_VOLUME,
        :WK_PALLET_OWNER,
        :WK_LABEL_QTY,
        NULL , /* no label start since im not printing labels */
        :WK_LABEL_TYPE,
        :WK_USER,
        :WK_DEVICE,
        :WK_DATE,
        'DC',
        :WK_PACK_TYPE);
     /* now create label qty of packs - with null label no */   
     WK_LABEL_NO = 0;
     WHILE (WK_LABEL_NO < WK_LABEL_QTY) DO
     BEGIN
        WK_LABEL_NO = WK_LABEL_NO + 1;
        WK_PACK_ID = GEN_ID(DESPATCH_PACK_ID_GEN,1); 
        INSERT INTO PACK_ID(PACK_ID, DESPATCH_ID, CREATE_DATE, LABEL_PRINTED_DATE)
        VALUES (:WK_PACK_ID, :WK_DESPATCH_ID, :WK_DATE, :WK_DATE);
     END
     IF (WK_CLASS = 'S') THEN
     BEGIN
        FOR SELECT PICK_ITEM_DETAIL.PICK_DETAIL_ID, PICK_ITEM_DETAIL.SSN_ID, PICK_ITEM_DETAIL.PICK_LABEL_NO
        FROM PICK_ITEM 
        JOIN PICK_ITEM_DETAIL ON PICK_ITEM_DETAIL.PICK_LABEL_NO = PICK_ITEM.PICK_LABEL_NO  
        JOIN ISSN ON ISSN.SSN_ID = PICK_ITEM_DETAIL.SSN_ID
        JOIN LOCATION ON LOCATION.WH_ID = ISSN.WH_ID AND LOCATION.LOCN_ID = ISSN.LOCN_ID 
        WHERE PICK_ITEM.PICK_ORDER = :WK_SO 
        AND PICK_ITEM.PICK_LINE_STATUS = 'DS'
        AND PICK_ITEM_DETAIL.PICK_DETAIL_STATUS = 'DS'
        AND PICK_ITEM_DETAIL.DESPATCH_ID IS NULL
        AND ISSN.ISSN_STATUS = 'DS' 
        AND LOCATION.STORE_AREA = 'DS'
        INTO :WK_DETAIL_ID, :WK_SSN_ID, :WK_PI_LABEL_NO
        DO
        BEGIN
           UPDATE PICK_ITEM_DETAIL 
           SET DESPATCH_ID = :WK_DESPATCH_ID,
               PICK_DETAIL_STATUS = 'DC'
           WHERE PICK_DETAIL_ID = :WK_DETAIL_ID;
           UPDATE ISSN SET ISSN_STATUS = 'DC'
           WHERE SSN_ID = :WK_SSN_ID;
           /* check despatched all of line */
           WK_FOUND = 0;
           SELECT FIRST 1 1 FROM PICK_ITEM_DETAIL
           WHERE PICK_LABEL_NO = :WK_PI_LABEL_NO
             AND PICK_DETAIL_STATUS IN ('DS','PL','PG')
           INTO :WK_FOUND;
           IF (WK_FOUND IS NULL) THEN
              WK_FOUND = 0;
           IF (WK_FOUND = 0) THEN
           BEGIN
               /* no undespatched ssns on item */
               UPDATE PICK_ITEM SET PICK_LINE_STATUS = 'DC'
               WHERE PICK_LABEL_NO = :WK_PI_LABEL_NO;
           END
        END
     END
     ELSE
     IF (WK_CLASS = 'L') THEN
     BEGIN
/*
        FOR SELECT PICK_ITEM_DETAIL.PICK_DETAIL_ID, PICK_ITEM_DETAIL.SSN_ID
        FROM ISSN
        JOIN LOCATION ON LOCATION.WH_ID = ISSN.WH_ID AND LOCATION.LOCN_ID = ISSN.LOCN_ID 
        JOIN PICK_ITEM_DETAIL ON PICK_ITEM_DETAIL.SSN_ID = ISSN.SSN_ID  
        JOIN PICK_ITEM ON PICK_ITEM.PICK_LABEL_NO = PICK_ITEM_DETAIL.PICK_LABEL_NO  
        WHERE ISSN.WH_ID = :WK_WH_ID 
        AND ISSN.LOCN_ID = :WK_LOCN_ID 
        AND ISSN.ISSN_STATUS = 'DS' 
        AND PICK_ITEM.PICK_LINE_STATUS = 'DS'
        AND PICK_ITEM_DETAIL.PICK_DETAIL_STATUS = 'DS'
        AND PICK_ITEM_DETAIL.DESPATCH_ID IS NULL
        AND LOCATION.STORE_AREA = 'DS'
        INTO :WK_DETAIL_ID, :WK_SSN_ID
*/
        FOR SELECT PICK_ITEM_DETAIL.PICK_DETAIL_ID, PICK_ITEM_DETAIL.SSN_ID, PICK_ITEM_DETAIL.PICK_LABEL_NO
        FROM PICK_ITEM_DETAIL 
        JOIN PICK_ITEM ON PICK_ITEM.PICK_LABEL_NO = PICK_ITEM_DETAIL.PICK_LABEL_NO  
        WHERE PICK_ITEM_DETAIL.PICK_DETAIL_STATUS = 'DS'
        AND PICK_ITEM_DETAIL.DESPATCH_LOCATION = :WK_LOCN_ID 
        AND PICK_ITEM_DETAIL.DESPATCH_ID IS NULL
        INTO :WK_DETAIL_ID, :WK_SSN_ID, :WK_PI_LABEL_NO
        DO
        BEGIN
           UPDATE PICK_ITEM_DETAIL 
           SET DESPATCH_ID = :WK_DESPATCH_ID,
               PICK_DETAIL_STATUS = 'DC'
           WHERE PICK_DETAIL_ID = :WK_DETAIL_ID;
           UPDATE ISSN SET ISSN_STATUS = 'DC'
           WHERE SSN_ID = :WK_SSN_ID;
           /* check despatched all of line */
           WK_FOUND = 0;
           SELECT FIRST 1 1 FROM PICK_ITEM_DETAIL
           WHERE PICK_LABEL_NO = :WK_PI_LABEL_NO
             AND PICK_DETAIL_STATUS IN ('DS','PL','PG')
           INTO :WK_FOUND;
           IF (WK_FOUND IS NULL) THEN
              WK_FOUND = 0;
           IF (WK_FOUND = 0) THEN
           BEGIN
               /* no undespatched ssns on item */
               UPDATE PICK_ITEM SET PICK_LINE_STATUS = 'DC'
               WHERE PICK_LABEL_NO = :WK_PI_LABEL_NO;
           END
        END
     END
     IF (WK_DO_DSDX = 'T') THEN
     BEGIN
        INSERT INTO TRANSACTIONS_ARCHIVE 
           (WH_ID, LOCN_ID, OBJECT, TRN_TYPE, TRN_CODE, TRN_DATE, 
            REFERENCE, QTY, ERROR_TEXT, INSTANCE_ID, EXPORTED, 
            SUB_LOCN_ID, INPUT_SOURCE, PERSON_ID, DEVICE_ID, COMPLETE)
        VALUES ('','','','DSDX','D',NEW.TRN_DATE,
            :WK_CONSIGNMENT, 0, 'ReRun Transaction',NEW.INSTANCE_ID, 0,
            '','SSSSSSSSS',NEW.PERSON_ID,NEW.DEVICE_ID,'R'); 
     END
     UPDATE TRANSACTIONS SET COMPLETE='T',ERROR_TEXT='Processed successfully' WHERE RECORD_ID = :WK_RECORD;

   /* EXECUTE PROCEDURE TRAN_ARCHIVE; */
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_EIND FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 58 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_RECORD INTEGER;
DECLARE VARIABLE WK_DATE TIMESTAMP;
DECLARE VARIABLE WK_USER VARCHAR(10);
DECLARE VARIABLE WK_SUB_LOCN VARCHAR(10);
DECLARE VARIABLE WK_OBJECT VARCHAR(30);
DECLARE VARIABLE WK_DEVICE VARCHAR(2);
DECLARE VARIABLE WK_CARD VARCHAR(10);
DECLARE VARIABLE WK_FIRST_NAME VARCHAR(20);
DECLARE VARIABLE WK_LAST_NAME VARCHAR(25);
DECLARE VARIABLE WK_CLASS CHAR(1);
DECLARE VARIABLE WK_WH_ID CHAR(2);
DECLARE VARIABLE WK_LOCN_ID VARCHAR(10);
DECLARE VARIABLE WK_QTY INTEGER;
DECLARE VARIABLE WK_TITLE VARCHAR(12);
DECLARE VARIABLE WK_TITLE_DB VARCHAR(5);
DECLARE VARIABLE WK_REF VARCHAR(40);
DECLARE VARIABLE WK_FOUND INTEGER;
DECLARE VARIABLE WK_DOB_X VARCHAR(10);
DECLARE VARIABLE WK_DOB_STR VARCHAR(10);
DECLARE VARIABLE WK_DOB_DT  TIMESTAMP;
DECLARE VARIABLE WK_SKILL_CODE VARCHAR(10);
DECLARE VARIABLE WK_SKILL_TYPE CHAR(2);
DECLARE VARIABLE WK_SKILL_PUBLISH CHAR(1);
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'EIND') THEN
  BEGIN
     WK_FOUND = 0;
     WK_SUB_LOCN = NEW.SUB_LOCN_ID;
     WK_OBJECT = NEW.OBJECT;
     WK_CARD = alltrim(substr(WK_OBJECT,1, 10));
     WK_FIRST_NAME = alltrim(substr(WK_OBJECT,11, 30));
     WK_CLASS = NEW.TRN_CODE;
     WK_QTY = NEW.QTY;
     WK_WH_ID = NEW.WH_ID;
     WK_LOCN_ID = NEW.LOCN_ID;
     WK_TITLE = WK_WH_ID || WK_LOCN_ID;
     WK_TITLE_DB = alltrim(substr(WK_TITLE,1,5));
     WK_REF = NEW.REFERENCE;
     WK_LAST_NAME = alltrim(substr(WK_REF,1,25));
     WK_DATE = NEW.TRN_DATE;
     WK_USER = NEW.PERSON_ID;
     WK_DOB_X = ALLTRIM(WK_SUB_LOCN);
     WK_RECORD = NEW.RECORD_ID;
     IF (LEN(WK_DOB_X) = 8) THEN
     BEGIN
        WK_DOB_STR = SUBSTR(WK_DOB_X,5,6) || '-' ||   
           SUBSTR(WK_DOB_X,7,8) || '-' ||   
           SUBSTR(WK_DOB_X,1,4) ;  
        WK_DOB_DT = CAST(WK_DOB_STR AS DATE);
     END
     ELSE
     BEGIN
        WK_DOB_DT = NULL;
     END
     SELECT 1
       FROM EMPLOYEE
       WHERE EMPLOYEE_ID = :WK_CARD
       INTO :WK_FOUND;
     IF (WK_FOUND = 1) THEN
     BEGIN
        /* employee exists so update */
        UPDATE EMPLOYEE SET
           FIRST_NAME = :WK_FIRST_NAME,
           LAST_NAME = :WK_LAST_NAME,
           DOB = :WK_DOB_DT,
           TITLE = :WK_TITLE_DB,
           UPDATE_BY = :WK_USER,
           UPDATE_DATE = :WK_DATE
           WHERE EMPLOYEE_ID = :WK_CARD;
     END
     ELSE
     BEGIN
        /* no employee so add */
        INSERT INTO EMPLOYEE (
           EMPLOYEE_ID,
           FIRST_NAME,
           LAST_NAME,
           DOB,
           TITLE,
           CREATE_BY,
           CREATE_DATE)
           VALUES (
           :WK_CARD,
           :WK_FIRST_NAME,
           :WK_LAST_NAME,
           :WK_DOB_DT,
           :WK_TITLE_DB,
           :WK_USER,
           :WK_DATE);
     END
     /* check have compulsory skills */
     FOR SELECT CODE, SKILL_TYPE, PUBLISH   
     FROM SKILL
     WHERE COMPULSORY_SKILL = 'T'
     INTO :WK_SKILL_CODE, :WK_SKILL_TYPE, :WK_SKILL_PUBLISH
     DO
     BEGIN
        /* check skill exists for user */
        WK_FOUND = 0;
        SELECT 1 
          FROM EMPLOYEE_SKILL
          WHERE EMPLOYEE_ID = :WK_CARD
            AND SKILL_CODE = :WK_SKILL_CODE
          INTO :WK_FOUND;
        IF (WK_FOUND = 0) THEN
        BEGIN
           INSERT INTO EMPLOYEE_SKILL (EMPLOYEE_ID, SKILL_CODE, COMPULSORY_SKILL)
           VALUES (:WK_CARD, :WK_SKILL_CODE, 'T');
        END
     END
     /* check person */
     WK_FOUND = 0;
     SELECT 1
       FROM PERSON
       WHERE PERSON_ID = :WK_CARD
       INTO :WK_FOUND;
     IF (WK_FOUND = 1) THEN
     BEGIN
        /* person exists so update */
        /* PERSON_TYPE = 'IN', */
        UPDATE PERSON SET
           FIRST_NAME = :WK_FIRST_NAME,
           LAST_NAME = :WK_LAST_NAME,
           TITLE = :WK_TITLE_DB
           WHERE PERSON_ID = :WK_CARD;
     END
     ELSE
     BEGIN
        /* no person so add */
        INSERT INTO PERSON (
           PERSON_ID,
           FIRST_NAME,
           LAST_NAME,
           TITLE,
           PERSON_TYPE,
           CREATE_DATE)
           VALUES (
           :WK_CARD,
           :WK_FIRST_NAME,
           :WK_LAST_NAME,
           :WK_TITLE,
           'IN',
           :WK_DATE);
     END
    /* Update transactions table */        
    EXECUTE PROCEDURE UPDATE_TRAN (:WK_RECORD, 'T', 'Processed successfully');
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_EIEO FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 59 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_RECORD INTEGER;
DECLARE VARIABLE WK_DATE TIMESTAMP;
DECLARE VARIABLE WK_USER VARCHAR(10);
DECLARE VARIABLE WK_SUB_LOCN VARCHAR(10);
DECLARE VARIABLE WK_OBJECT VARCHAR(30);
DECLARE VARIABLE WK_DEVICE VARCHAR(2);
DECLARE VARIABLE WK_CARD VARCHAR(10);
DECLARE VARIABLE WK_EMPLOYER VARCHAR(10);
DECLARE VARIABLE WK_EMPLOYER_DESC VARCHAR(20);
DECLARE VARIABLE WK_OCCUPATION VARCHAR(30);
DECLARE VARIABLE WK_CLASS CHAR(1);
DECLARE VARIABLE WK_WH_ID CHAR(2);
DECLARE VARIABLE WK_LOCN_ID VARCHAR(10);
DECLARE VARIABLE WK_LOCATION VARCHAR(40);
DECLARE VARIABLE WK_QTY INTEGER;
DECLARE VARIABLE WK_REF VARCHAR(40);
DECLARE VARIABLE WK_FOUND INTEGER;
DECLARE VARIABLE WK_EMPLOYEE_TYPE VARCHAR(10);
DECLARE VARIABLE WK_EMPLOYEE_TYPE_DB VARCHAR(2);
DECLARE VARIABLE WK_DOB_STR VARCHAR(10);
DECLARE VARIABLE WK_DOB_DT  TIMESTAMP;
DECLARE VARIABLE WK_DUMMY INTEGER;
DECLARE VARIABLE WK_SKILL_CODE VARCHAR(10);
DECLARE VARIABLE WK_SKILL_TYPE CHAR(2);
DECLARE VARIABLE WK_SKILL_PUBLISH CHAR(1);
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'EIEO') THEN
  BEGIN
     WK_FOUND = 0;
     WK_SUB_LOCN = NEW.SUB_LOCN_ID;
     WK_EMPLOYEE_TYPE = ALLTRIM(WK_SUB_LOCN);
     WK_EMPLOYEE_TYPE_DB = substr(WK_EMPLOYEE_TYPE,1,2);
     WK_OBJECT = NEW.OBJECT;
     WK_CARD = ALLTRIM(substr(WK_OBJECT,1, 10));
     WK_EMPLOYER = ALLTRIM(substr(WK_OBJECT,11, 20));
     WK_EMPLOYER_DESC = substr(WK_OBJECT,11, 30);
     WK_CLASS = NEW.TRN_CODE;
     WK_QTY = NEW.QTY;
     WK_WH_ID = NEW.WH_ID;
     WK_LOCN_ID = NEW.LOCN_ID;
     WK_LOCATION = alltrim(WK_WH_ID || WK_LOCN_ID);
     WK_REF = NEW.REFERENCE;
     WK_OCCUPATION = alltrim(substr(WK_REF,1,30));
     WK_DATE = NEW.TRN_DATE;
     WK_USER = NEW.PERSON_ID;
     WK_RECORD = NEW.RECORD_ID;
     SELECT 1
       FROM OCCUPATION
       WHERE OCCUPATION_ID = :WK_OCCUPATION
       INTO :WK_FOUND;
     IF (WK_FOUND = 0) THEN
     BEGIN
        INSERT INTO OCCUPATION (OCCUPATION_ID, DESCRIPTION, CREATED_BY, CREATED_DATE)
        VALUES (:WK_OCCUPATION, :WK_OCCUPATION, :WK_USER, :WK_DATE);
     END
     WK_FOUND = 0;
     SELECT 1
       FROM EMPLOYEE
       WHERE EMPLOYEE_ID = :WK_CARD
       INTO :WK_FOUND;
     IF (WK_FOUND = 1) THEN
     BEGIN
        /* employee exists so update */
        UPDATE EMPLOYEE SET
           COMPANY_ID = :WK_EMPLOYER,
           OCCUPATION = :WK_OCCUPATION,
           EMPLOYEE_TYPE = :WK_EMPLOYEE_TYPE,
           LOCATION = :WK_LOCATION,
    UPDATE_BY = :WK_USER,
           UPDATE_DATE = :WK_DATE
           WHERE EMPLOYEE_ID = :WK_CARD;
     END
     ELSE
     BEGIN
        /* no employee so add */
        INSERT INTO EMPLOYEE (
           EMPLOYEE_ID,
           COMPANY_ID,
           OCCUPATION,
           EMPLOYEE_TYPE,
           LOCATION,
           CREATE_BY,
           CREATE_DATE)
           VALUES (
           :WK_CARD,
           :WK_EMPLOYER,
           :WK_OCCUPATION,
           :WK_EMPLOYEE_TYPE,
           :WK_LOCATION,
           :WK_USER,
           :WK_DATE);
     END
     /* check have compulsory skills */
     FOR SELECT CODE, SKILL_TYPE, PUBLISH   
     FROM SKILL
     WHERE COMPULSORY_SKILL = 'T'
     INTO :WK_SKILL_CODE, :WK_SKILL_TYPE, :WK_SKILL_PUBLISH
     DO
     BEGIN
        /* check skill exists for user */
        WK_FOUND = 0;
        SELECT 1 
          FROM EMPLOYEE_SKILL
          WHERE EMPLOYEE_ID = :WK_CARD
            AND SKILL_CODE = :WK_SKILL_CODE
          INTO :WK_FOUND;
        IF (WK_FOUND = 0) THEN
        BEGIN
           INSERT INTO EMPLOYEE_SKILL (EMPLOYEE_ID, SKILL_CODE, COMPULSORY_SKILL)
           VALUES (:WK_CARD, :WK_SKILL_CODE, 'T');
        END
     END
     /* check person */
     WK_FOUND = 0;
     SELECT 1
       FROM PERSON
       WHERE PERSON_ID = :WK_EMPLOYER
       INTO :WK_FOUND;
     IF (WK_FOUND = 1) THEN
     BEGIN
        /* person exists so update */
/*
        dont update companys description
           PERSON_TYPE = 'CE'
        UPDATE PERSON SET
           FIRST_NAME = :WK_EMPLOYER_DESC
           WHERE PERSON_ID = :WK_EMPLOYER;
*/
        WK_DUMMY = 1;
     END
     ELSE
     BEGIN
        /* no person so add */
        INSERT INTO PERSON (
           PERSON_ID,
           FIRST_NAME,
           PERSON_TYPE,
           CREATE_DATE)
           VALUES (
           :WK_EMPLOYER,
           :WK_EMPLOYER_DESC,
           'CE',
           :WK_DATE);
     END
    /* Update transactions table */        
    EXECUTE PROCEDURE UPDATE_TRAN (:WK_RECORD, 'T', 'Processed successfully');
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_GRNX FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 60 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_RECORD  INTEGER;
DECLARE VARIABLE WK_OBJECT  VARCHAR(30);
DECLARE VARIABLE WK_REFERENCE  VARCHAR(40);
DECLARE VARIABLE WK_WH_ID CHAR(2);
DECLARE VARIABLE WK_LOCN_ID  VARCHAR(10);
DECLARE VARIABLE WK_SUBLOCN  VARCHAR(10);
DECLARE VARIABLE WK_COMMENT  VARCHAR(80);
DECLARE VARIABLE WK_QTY  INTEGER;
DECLARE VARIABLE WK_GRN  VARCHAR(10);
DECLARE VARIABLE WK_USER  VARCHAR(10);
DECLARE VARIABLE WK_DEVICE  VARCHAR(2);
DECLARE VARIABLE WK_DATE TIMESTAMP;
DECLARE VARIABLE WK_ERROR_TEXT  VARCHAR(70);
DECLARE VARIABLE WK_CURRENT_COMMENT  VARCHAR(258);
DECLARE VARIABLE WK_NOTE_STR  VARCHAR(258);
DECLARE VARIABLE WK_LEN_NOW  INTEGER;
DECLARE VARIABLE WK_LEN_WAS  INTEGER;
DECLARE VARIABLE WK_START_POSN  INTEGER;
DECLARE VARIABLE WK_END_POSN  INTEGER;
DECLARE VARIABLE WK_GRN_TYPE  CHAR(2);
DECLARE VARIABLE WK_ORDER  VARCHAR(10);
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'GRNX') THEN
  BEGIN
     WK_RECORD = NEW.RECORD_ID; 
     WK_ERROR_TEXT = 'Processed successfully';
     WK_OBJECT = NEW.OBJECT;
     WK_WH_ID = NEW.WH_ID;
     WK_LOCN_ID = NEW.LOCN_ID;
     WK_SUBLOCN = NEW.SUB_LOCN_ID;
     WK_GRN = WK_SUBLOCN;
     WK_REFERENCE = NEW.REFERENCE;
     WK_QTY = NEW.QTY;
     WK_USER = NEW.PERSON_ID;
     WK_DEVICE = NEW.DEVICE_ID;
     WK_DATE = NEW.TRN_DATE;
     WK_COMMENT = WK_OBJECT || WK_WH_ID || WK_LOCN_ID || WK_REFERENCE;
     WK_CURRENT_COMMENT = '';
     SELECT COMMENTS
        FROM GRN
        WHERE GRN = :WK_GRN
        INTO :WK_CURRENT_COMMENT;
     IF (WK_CURRENT_COMMENT IS NULL) THEN
     BEGIN
        WK_CURRENT_COMMENT = '';
     END

 /* get comment in 255 */
     WK_LEN_NOW = STRLEN(WK_COMMENT);
     WK_LEN_WAS = STRLEN(WK_CURRENT_COMMENT);
     IF (255 < (WK_LEN_WAS + WK_LEN_NOW )) THEN
     BEGIN
        /* too long so trim the current */
        WK_END_POSN = WK_LEN_WAS + 1;
        WK_START_POSN = (WK_LEN_WAS + WK_LEN_NOW) - 254;
        WK_CURRENT_COMMENT = WK_CURRENT_COMMENT || '  ';
        WK_NOTE_STR = VSUBSTRING(WK_CURRENT_COMMENT, WK_START_POSN, WK_END_POSN);
     END
     ELSE
     BEGIN
        WK_NOTE_STR = WK_CURRENT_COMMENT;
     END
     UPDATE GRN
       SET COMMENTS = :WK_NOTE_STR || :WK_COMMENT,
       GRN_STATUS = 'CN'
       WHERE GRN = :WK_GRN;
     /* 
         if grn is for a PO
         then update po_receiver to null
     */
     WK_GRN_TYPE = '';
     WK_ORDER = '';
     SELECT GRN_TYPE, ORDER_NO
     FROM GRN 
     WHERE GRN = :WK_GRN
     INTO :WK_GRN_TYPE, :WK_ORDER;
     IF (WK_GRN_TYPE IS NULL) THEN
     BEGIN
        WK_GRN_TYPE = '';
     END
     IF (WK_ORDER IS NULL) THEN
     BEGIN
        WK_ORDER = '';
     END
     IF (WK_GRN_TYPE = 'PO') THEN
     BEGIN
        UPDATE PURCHASE_ORDER SET PO_RECEIVER = NULL
        WHERE PURCHASE_ORDER = :WK_ORDER
        AND PO_RECEIVER = :WK_DEVICE;
     END
     UPDATE TRANSACTIONS SET COMPLETE='T',ERROR_TEXT=:WK_ERROR_TEXT WHERE RECORD_ID = :WK_RECORD;
   /* EXECUTE PROCEDURE TRAN_ARCHIVE; */
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_EIA1 FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 61 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_DATE TIMESTAMP;
DECLARE VARIABLE WK_USER VARCHAR(10);
DECLARE VARIABLE WK_SUB_LOCN VARCHAR(10);
DECLARE VARIABLE WK_OBJECT VARCHAR(30);
DECLARE VARIABLE WK_DEVICE VARCHAR(2);
DECLARE VARIABLE WK_CARD VARCHAR(10);
DECLARE VARIABLE WK_CLASS CHAR(1);
DECLARE VARIABLE WK_WH_ID CHAR(2);
DECLARE VARIABLE WK_LOCN_ID VARCHAR(10);
DECLARE VARIABLE WK_QTY INTEGER;
DECLARE VARIABLE WK_REF VARCHAR(40);
DECLARE VARIABLE WK_FOUND INTEGER;
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'EIA1') THEN
  BEGIN
     WK_FOUND = 0;
     WK_OBJECT = NEW.OBJECT;
     WK_CARD = alltrim(substr(WK_OBJECT,1, 10));
     WK_REF = alltrim(NEW.REFERENCE);
     WK_DATE = NEW.TRN_DATE;
     WK_USER = NEW.PERSON_ID;
     SELECT 1
       FROM EMPLOYEE
       WHERE EMPLOYEE_ID = :WK_CARD
       INTO :WK_FOUND;
     IF (WK_FOUND = 1) THEN
     BEGIN
        /* employee exists so update */
        UPDATE EMPLOYEE SET
           ADDRESS_LINE1 = :WK_REF,
    UPDATE_BY = :WK_USER,
           UPDATE_DATE = :WK_DATE
           WHERE EMPLOYEE_ID = :WK_CARD;
     END
     ELSE
     BEGIN
        /* no employee so add */
        INSERT INTO EMPLOYEE (
           EMPLOYEE_ID,
           ADDRESS_LINE1,
           CREATE_BY,
           CREATE_DATE)
           VALUES (
           :WK_CARD,
           :WK_REF,
           :WK_USER,
           :WK_DATE);
     END
     WK_FOUND = 0;
     SELECT 1
       FROM PERSON
       WHERE PERSON_ID = :WK_CARD
       INTO :WK_FOUND;
     IF (WK_FOUND = 1) THEN
     BEGIN
        /* person exists so update */
        /* PERSON_TYPE = 'IN' */
        UPDATE PERSON SET
           ADDRESS_LINE1 = :WK_REF
           WHERE PERSON_ID = :WK_CARD;
     END
     ELSE
     BEGIN
        /* no person so add */
        INSERT INTO PERSON (
           PERSON_ID,
           ADDRESS_LINE1,
           PERSON_TYPE,
           CREATE_DATE)
           VALUES (
           :WK_CARD,
           :WK_REF,
           'IN',
           :WK_DATE);
     END
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_EIA2 FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 62 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_DATE TIMESTAMP;
DECLARE VARIABLE WK_USER VARCHAR(10);
DECLARE VARIABLE WK_SUB_LOCN VARCHAR(10);
DECLARE VARIABLE WK_OBJECT VARCHAR(30);
DECLARE VARIABLE WK_DEVICE VARCHAR(2);
DECLARE VARIABLE WK_CARD VARCHAR(10);
DECLARE VARIABLE WK_CLASS CHAR(1);
DECLARE VARIABLE WK_WH_ID CHAR(2);
DECLARE VARIABLE WK_LOCN_ID VARCHAR(10);
DECLARE VARIABLE WK_QTY INTEGER;
DECLARE VARIABLE WK_REF VARCHAR(40);
DECLARE VARIABLE WK_FOUND INTEGER;
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'EIA2') THEN
  BEGIN
     WK_FOUND = 0;
     WK_OBJECT = NEW.OBJECT;
     WK_CARD = alltrim(substr(WK_OBJECT,1, 10));
     WK_REF = alltrim(NEW.REFERENCE);
     WK_DATE = NEW.TRN_DATE;
     WK_USER = NEW.PERSON_ID;
     SELECT 1
       FROM EMPLOYEE
       WHERE EMPLOYEE_ID = :WK_CARD
       INTO :WK_FOUND;
     IF (WK_FOUND = 1) THEN
     BEGIN
        /* employee exists so update */
        UPDATE EMPLOYEE SET
           ADDRESS_LINE2 = :WK_REF,
    UPDATE_BY = :WK_USER,
           UPDATE_DATE = :WK_DATE
           WHERE EMPLOYEE_ID = :WK_CARD;
     END
     ELSE
     BEGIN
        /* no employee so add */
        INSERT INTO EMPLOYEE (
           EMPLOYEE_ID,
           ADDRESS_LINE2,
           CREATE_BY,
           CREATE_DATE)
           VALUES (
           :WK_CARD,
           :WK_REF,
           :WK_USER,
           :WK_DATE);
     END
     WK_FOUND = 0;
     SELECT 1
       FROM PERSON
       WHERE PERSON_ID = :WK_CARD
       INTO :WK_FOUND;
     IF (WK_FOUND = 1) THEN
     BEGIN
        /* person exists so update */
        /* PERSON_TYPE = 'IN' */
        UPDATE PERSON SET
           ADDRESS_LINE2 = :WK_REF
           WHERE PERSON_ID = :WK_CARD;
     END
     ELSE
     BEGIN
        /* no person so add */
        INSERT INTO PERSON (
           PERSON_ID,
           ADDRESS_LINE2,
           PERSON_TYPE,
           CREATE_DATE)
           VALUES (
           :WK_CARD,
           :WK_REF,
           'IN',
           :WK_DATE);
     END
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_EIA3 FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 63 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_DATE TIMESTAMP;
DECLARE VARIABLE WK_USER VARCHAR(10);
DECLARE VARIABLE WK_SUB_LOCN VARCHAR(10);
DECLARE VARIABLE WK_OBJECT VARCHAR(30);
DECLARE VARIABLE WK_DEVICE VARCHAR(2);
DECLARE VARIABLE WK_CARD VARCHAR(10);
DECLARE VARIABLE WK_SUBURB VARCHAR(20);
DECLARE VARIABLE WK_STATE  VARCHAR(20);
DECLARE VARIABLE WK_COUNTRY  VARCHAR(25);
DECLARE VARIABLE WK_CLASS CHAR(1);
DECLARE VARIABLE WK_WH_ID CHAR(2);
DECLARE VARIABLE WK_LOCN_ID VARCHAR(10);
DECLARE VARIABLE WK_QTY INTEGER;
DECLARE VARIABLE WK_REF VARCHAR(40);
DECLARE VARIABLE WK_FOUND INTEGER;
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'EIA3') THEN
  BEGIN
     WK_FOUND = 0;
     WK_OBJECT = NEW.OBJECT;
     WK_CARD = alltrim(substr(WK_OBJECT,1, 10));
     WK_SUBURB = alltrim(substr(WK_OBJECT,11, 30));
     WK_WH_ID = NEW.WH_ID;
     WK_LOCN_ID = NEW.LOCN_ID;
     WK_STATE = alltrim(WK_WH_ID || WK_LOCN_ID);
     WK_SUB_LOCN = alltrim(NEW.SUB_LOCN_ID);
     WK_REF = NEW.REFERENCE;
     WK_COUNTRY = alltrim(substr(WK_REF,1, 25));
     WK_DATE = NEW.TRN_DATE;
     WK_USER = NEW.PERSON_ID;
     SELECT 1
       FROM EMPLOYEE
       WHERE EMPLOYEE_ID = :WK_CARD
       INTO :WK_FOUND;
     IF (WK_FOUND = 1) THEN
     BEGIN
        /* employee exists so update */
        UPDATE EMPLOYEE SET
           COUNTRY = :WK_COUNTRY,
           CITY = :WK_SUBURB,
           STATE = :WK_STATE,
           POST_CODE = :WK_SUB_LOCN,
    UPDATE_BY = :WK_USER,
           UPDATE_DATE = :WK_DATE
           WHERE EMPLOYEE_ID = :WK_CARD;
     END
     ELSE
     BEGIN
        /* no employee so add */
        INSERT INTO EMPLOYEE (
           EMPLOYEE_ID,
           COUNTRY ,
           CITY ,
           STATE ,
           POST_CODE ,
           CREATE_BY,
           CREATE_DATE)
           VALUES (
           :WK_CARD,
           :WK_COUNTRY,
           :WK_SUBURB,
           :WK_STATE,
           :WK_SUB_LOCN,
           :WK_USER,
           :WK_DATE);
     END
     WK_FOUND = 0;
     SELECT 1
       FROM PERSON
       WHERE PERSON_ID = :WK_CARD
       INTO :WK_FOUND;
     IF (WK_FOUND = 1) THEN
     BEGIN
        /* person exists so update */
        /* PERSON_TYPE = 'IN' */
        UPDATE PERSON SET
           COUNTRY = :WK_COUNTRY,
           CITY = :WK_SUBURB,
           STATE = :WK_STATE,
           POST_CODE = :WK_SUB_LOCN
           WHERE PERSON_ID = :WK_CARD;
     END
     ELSE
     BEGIN
        /* no person so add */
        INSERT INTO PERSON (
           PERSON_ID,
           COUNTRY ,
           CITY ,
           STATE ,
           POST_CODE ,
           PERSON_TYPE,
           CREATE_DATE)
           VALUES (
           :WK_CARD,
           :WK_COUNTRY,
           :WK_SUBURB,
           :WK_STATE,
           :WK_SUB_LOCN,
           'IN',
           :WK_DATE);
     END
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_EIC3 FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 64 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_DATE TIMESTAMP;
DECLARE VARIABLE WK_USER VARCHAR(10);
DECLARE VARIABLE WK_SUB_LOCN VARCHAR(10);
DECLARE VARIABLE WK_OBJECT VARCHAR(30);
DECLARE VARIABLE WK_DEVICE VARCHAR(2);
DECLARE VARIABLE WK_CARD VARCHAR(10);
DECLARE VARIABLE WK_MOBILE VARCHAR(20);
DECLARE VARIABLE WK_PHONE VARCHAR(20);
DECLARE VARIABLE WK_CLASS CHAR(1);
DECLARE VARIABLE WK_WH_ID CHAR(2);
DECLARE VARIABLE WK_LOCN_ID VARCHAR(10);
DECLARE VARIABLE WK_QTY INTEGER;
DECLARE VARIABLE WK_REF VARCHAR(40);
DECLARE VARIABLE WK_EMAIL VARCHAR(40);
DECLARE VARIABLE WK_FOUND INTEGER;
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'EIC3') THEN
  BEGIN
     WK_FOUND = 0;
     WK_OBJECT = NEW.OBJECT;
     WK_CARD = ALLTRIM(SUBSTR(WK_OBJECT,1,10));
     WK_MOBILE = ALLTRIM(SUBSTR(WK_OBJECT,11,30));
     WK_SUB_LOCN = NEW.SUB_LOCN_ID;
     WK_WH_ID = NEW.WH_ID;
     WK_LOCN_ID = NEW.LOCN_ID;
     WK_PHONE = ALLTRIM(WK_WH_ID) || ALLTRIM(WK_LOCN_ID) || ALLTRIM(WK_SUB_LOCN);
     WK_REF = NEW.REFERENCE;
     WK_EMAIL = ALLTRIM(WK_REF);
     WK_DATE = NEW.TRN_DATE;
     WK_USER = NEW.PERSON_ID;
     SELECT 1
       FROM EMPLOYEE
       WHERE EMPLOYEE_ID = :WK_CARD
       INTO :WK_FOUND;
     IF (WK_FOUND = 1) THEN
     BEGIN
        /* employee exists so update */
        UPDATE EMPLOYEE SET
           FAX_NO = :WK_PHONE,
           MOBILE_NO = :WK_MOBILE,
           EMAIL = :WK_EMAIL,
    UPDATE_BY = :WK_USER,
           UPDATE_DATE = :WK_DATE
           WHERE EMPLOYEE_ID = :WK_CARD;
     END
     ELSE
     BEGIN
        /* no employee so add */
        INSERT INTO EMPLOYEE (
           EMPLOYEE_ID,
           FAX_NO,
           MOBILE_NO,
           EMAIL,
           CREATE_BY,
           CREATE_DATE)
           VALUES (
           :WK_CARD,
           :WK_PHONE,
           :WK_MOBILE,
           :WK_EMAIL,
           :WK_USER,
           :WK_DATE);
     END
     WK_FOUND = 0;
     SELECT 1
       FROM PERSON
       WHERE PERSON_ID = :WK_CARD
       INTO :WK_FOUND;
     IF (WK_FOUND = 1) THEN
     BEGIN
        /* person exists so update */
        UPDATE PERSON SET
           FAX_NO = :WK_PHONE,
           MOBILE_NO = :WK_MOBILE,
           EMAIL = :WK_EMAIL
           WHERE PERSON_ID = :WK_CARD;
     END
     ELSE
     BEGIN
        /* no person so add */
        INSERT INTO PERSON (
           PERSON_ID,
           FAX_NO,
           MOBILE_NO,
           EMAIL,
           PERSON_TYPE,
           CREATE_DATE)
           VALUES (
           :WK_CARD,
           :WK_PHONE,
           :WK_MOBILE,
           :WK_EMAIL,
           'IN',
           :WK_DATE);
     END
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_EICT FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 64 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_DATE TIMESTAMP;
DECLARE VARIABLE WK_USER VARCHAR(10);
DECLARE VARIABLE WK_SUB_LOCN VARCHAR(10);
DECLARE VARIABLE WK_OBJECT VARCHAR(30);
DECLARE VARIABLE WK_DEVICE VARCHAR(2);
DECLARE VARIABLE WK_CARD VARCHAR(10);
DECLARE VARIABLE WK_MOBILE VARCHAR(20);
DECLARE VARIABLE WK_PHONE VARCHAR(20);
DECLARE VARIABLE WK_CLASS CHAR(1);
DECLARE VARIABLE WK_WH_ID CHAR(2);
DECLARE VARIABLE WK_LOCN_ID VARCHAR(10);
DECLARE VARIABLE WK_QTY INTEGER;
DECLARE VARIABLE WK_REF VARCHAR(40);
DECLARE VARIABLE WK_EMAIL VARCHAR(40);
DECLARE VARIABLE WK_FOUND INTEGER;
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'EICT') THEN
  BEGIN
     WK_FOUND = 0;
     WK_OBJECT = NEW.OBJECT;
     WK_CARD = ALLTRIM(SUBSTR(WK_OBJECT,1,10));
     WK_MOBILE = ALLTRIM(SUBSTR(WK_OBJECT,11,30));
     WK_SUB_LOCN = NEW.SUB_LOCN_ID;
     WK_WH_ID = NEW.WH_ID;
     WK_LOCN_ID = NEW.LOCN_ID;
     WK_PHONE = ALLTRIM(WK_WH_ID) || ALLTRIM(WK_LOCN_ID) || ALLTRIM(WK_SUB_LOCN);
     WK_REF = NEW.REFERENCE;
     WK_EMAIL = ALLTRIM(WK_REF);
     WK_DATE = NEW.TRN_DATE;
     WK_USER = NEW.PERSON_ID;
     SELECT 1
       FROM EMPLOYEE
       WHERE EMPLOYEE_ID = :WK_CARD
       INTO :WK_FOUND;
     IF (WK_FOUND = 1) THEN
     BEGIN
        /* employee exists so update */
        UPDATE EMPLOYEE SET
           PHONE_NO = :WK_PHONE,
           MOBILE_NO = :WK_MOBILE,
           EMAIL = :WK_EMAIL,
    UPDATE_BY = :WK_USER,
           UPDATE_DATE = :WK_DATE
           WHERE EMPLOYEE_ID = :WK_CARD;
     END
     ELSE
     BEGIN
        /* no employee so add */
        INSERT INTO EMPLOYEE (
           EMPLOYEE_ID,
           PHONE_NO,
           MOBILE_NO,
           EMAIL,
           CREATE_BY,
           CREATE_DATE)
           VALUES (
           :WK_CARD,
           :WK_PHONE,
           :WK_MOBILE,
           :WK_EMAIL,
           :WK_USER,
           :WK_DATE);
     END
     WK_FOUND = 0;
     SELECT 1
       FROM PERSON
       WHERE PERSON_ID = :WK_CARD
       INTO :WK_FOUND;
     IF (WK_FOUND = 1) THEN
     BEGIN
        /* person exists so update */
        UPDATE PERSON SET
           PHONE_NO = :WK_PHONE,
           MOBILE_NO = :WK_MOBILE,
           EMAIL = :WK_EMAIL
           WHERE PERSON_ID = :WK_CARD;
     END
     ELSE
     BEGIN
        /* no person so add */
        INSERT INTO PERSON (
           PERSON_ID,
           PHONE_NO,
           MOBILE_NO,
           EMAIL,
           PERSON_TYPE,
           CREATE_DATE)
           VALUES (
           :WK_CARD,
           :WK_PHONE,
           :WK_MOBILE,
           :WK_EMAIL,
           'IN',
           :WK_DATE);
     END
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_EIC1 FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 65 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_DATE TIMESTAMP;
DECLARE VARIABLE WK_USER VARCHAR(10);
DECLARE VARIABLE WK_SUB_LOCN VARCHAR(10);
DECLARE VARIABLE WK_OBJECT VARCHAR(30);
DECLARE VARIABLE WK_DEVICE VARCHAR(2);
DECLARE VARIABLE WK_CARD VARCHAR(10);
DECLARE VARIABLE WK_1ST_NAME VARCHAR(25);
DECLARE VARIABLE WK_LAST_NAME VARCHAR(25);
DECLARE VARIABLE WK_PHONE VARCHAR(20);
DECLARE VARIABLE WK_CLASS CHAR(1);
DECLARE VARIABLE WK_WH_ID CHAR(2);
DECLARE VARIABLE WK_LOCN_ID VARCHAR(10);
DECLARE VARIABLE WK_QTY INTEGER;
DECLARE VARIABLE WK_REF VARCHAR(40);
DECLARE VARIABLE WK_EMAIL VARCHAR(40);
DECLARE VARIABLE WK_FOUND INTEGER;
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'EIC1') THEN
  BEGIN
     WK_FOUND = 0;
     WK_OBJECT = NEW.OBJECT;
     WK_CARD = ALLTRIM(SUBSTR(WK_OBJECT,1,10));
     WK_1ST_NAME = ALLTRIM(SUBSTR(WK_OBJECT,11,30));
     WK_SUB_LOCN = NEW.SUB_LOCN_ID;
     WK_WH_ID = NEW.WH_ID;
     WK_LOCN_ID = NEW.LOCN_ID;
     WK_PHONE = ALLTRIM(WK_WH_ID) || ALLTRIM(WK_LOCN_ID) || ALLTRIM(WK_SUB_LOCN);
     WK_REF = NEW.REFERENCE;
     WK_LAST_NAME = ALLTRIM(SUBSTR(WK_REF,1,25));
     WK_DATE = NEW.TRN_DATE;
     WK_USER = NEW.PERSON_ID;
     SELECT 1
       FROM EMPLOYEE
       WHERE EMPLOYEE_ID = :WK_CARD
       INTO :WK_FOUND;
     IF (WK_FOUND = 1) THEN
     BEGIN
        /* employee exists so update */
        UPDATE EMPLOYEE SET
           CONTACT_PHONE = :WK_PHONE,
           CONTACT_FIRST_NAME = :WK_1ST_NAME,
           CONTACT_LAST_NAME = :WK_LAST_NAME,
    UPDATE_BY = :WK_USER,
           UPDATE_DATE = :WK_DATE
           WHERE EMPLOYEE_ID = :WK_CARD;
     END
     ELSE
     BEGIN
        /* no employee so add */
        INSERT INTO EMPLOYEE (
           EMPLOYEE_ID,
           CONTACT_PHONE,
           CONTACT_FIRST_NAME,
           CONTACT_LAST_NAME,
           CREATE_BY,
           CREATE_DATE)
           VALUES (
           :WK_CARD,
           :WK_PHONE,
           :WK_1ST_NAME,
           :WK_LAST_NAME,
           :WK_USER,
           :WK_DATE);
     END
     WK_FOUND = 0;
     SELECT 1
       FROM PERSON
       WHERE PERSON_ID = :WK_CARD
       INTO :WK_FOUND;
     IF (WK_FOUND = 1) THEN
     BEGIN
        /* person exists so update */
        UPDATE PERSON SET
           CONTACT_PHONE = :WK_PHONE,
           CONTACT_FIRST_NAME = :WK_1ST_NAME,
           CONTACT_LAST_NAME = :WK_LAST_NAME
           WHERE PERSON_ID = :WK_CARD;
     END
     ELSE
     BEGIN
        /* no person so add */
        INSERT INTO PERSON (
           PERSON_ID,
           CONTACT_PHONE,
           CONTACT_FIRST_NAME,
           CONTACT_LAST_NAME,
           PERSON_TYPE,
           CREATE_DATE)
           VALUES (
           :WK_CARD,
           :WK_PHONE,
           :WK_1ST_NAME,
           :WK_LAST_NAME,
           'IN',
           :WK_DATE);
     END
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_EIC2 FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 66 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_DATE TIMESTAMP;
DECLARE VARIABLE WK_USER VARCHAR(10);
DECLARE VARIABLE WK_SUB_LOCN VARCHAR(10);
DECLARE VARIABLE WK_OBJECT VARCHAR(30);
DECLARE VARIABLE WK_DEVICE VARCHAR(2);
DECLARE VARIABLE WK_CARD VARCHAR(10);
DECLARE VARIABLE WK_1ST_NAME VARCHAR(25);
DECLARE VARIABLE WK_LAST_NAME VARCHAR(25);
DECLARE VARIABLE WK_PHONE VARCHAR(20);
DECLARE VARIABLE WK_CLASS CHAR(1);
DECLARE VARIABLE WK_WH_ID CHAR(2);
DECLARE VARIABLE WK_LOCN_ID VARCHAR(10);
DECLARE VARIABLE WK_QTY INTEGER;
DECLARE VARIABLE WK_REF VARCHAR(40);
DECLARE VARIABLE WK_EMAIL VARCHAR(40);
DECLARE VARIABLE WK_FOUND INTEGER;
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'EIC2') THEN
  BEGIN
     WK_FOUND = 0;
     WK_OBJECT = NEW.OBJECT;
     WK_CARD = ALLTRIM(SUBSTR(WK_OBJECT,1,10));
     WK_1ST_NAME = ALLTRIM(SUBSTR(WK_OBJECT,11,30));
     WK_SUB_LOCN = NEW.SUB_LOCN_ID;
     WK_WH_ID = NEW.WH_ID;
     WK_LOCN_ID = NEW.LOCN_ID;
     WK_PHONE = ALLTRIM(WK_WH_ID) || ALLTRIM(WK_LOCN_ID) || ALLTRIM(WK_SUB_LOCN);
     WK_REF = NEW.REFERENCE;
     WK_LAST_NAME = ALLTRIM(SUBSTR(WK_REF,1,25));
     WK_DATE = NEW.TRN_DATE;
     WK_USER = NEW.PERSON_ID;
/*
     SELECT 1
       FROM EMPLOYEE
       WHERE EMPLOYEE_ID = :WK_CARD
       INTO :WK_FOUND;
     IF (WK_FOUND = 1) THEN
     BEGIN
        -* employee exists so update *-
        UPDATE EMPLOYEE SET
           SECOND_PHONE_NO = :WK_PHONE,
           SECOND_CONTACT_FIRST_NAME = :WK_1ST_NAME,
           SECOND_CONTACT_LAST_NAME = :WK_LAST_NAME,
    UPDATE_BY = :WK_USER,
           UPDATE_DATE = :WK_DATE
           WHERE EMPLOYEE_ID = :WK_CARD;
     END
     ELSE
     BEGIN
        -* no employee so add *-
        INSERT INTO EMPLOYEE (
           EMPLOYEE_ID,
           SECOND_PHONE_NO,
           SECOND_CONTACT_FIRST_NAME,
           SECOND_CONTACT_LAST_NAME,
           CREATE_BY,
           CREATE_DATE)
           VALUES (
           :WK_CARD,
           :WK_PHONE,
           :WK_1ST_NAME,
           :WK_LAST_NAME,
           :WK_USER,
           :WK_DATE);
     END
*/
     WK_FOUND = 0;
     SELECT 1
       FROM PERSON
       WHERE PERSON_ID = :WK_CARD
       INTO :WK_FOUND;
     IF (WK_FOUND = 1) THEN
     BEGIN
        /* person exists so update */
        UPDATE PERSON SET
           SECOND_PHONE_NO = :WK_PHONE,
           SECOND_CONTACT_FIRST_NAME = :WK_1ST_NAME,
           SECOND_CONTACT_LAST_NAME = :WK_LAST_NAME
           WHERE PERSON_ID = :WK_CARD;
     END
     ELSE
     BEGIN
        /* no person so add */
        INSERT INTO PERSON (
           PERSON_ID,
           SECOND_PHONE_NO,
           SECOND_CONTACT_FIRST_NAME,
           SECOND_CONTACT_LAST_NAME,
           PERSON_TYPE,
           CREATE_DATE)
           VALUES (
           :WK_CARD,
           :WK_PHONE,
           :WK_1ST_NAME,
           :WK_LAST_NAME,
           'IN',
           :WK_DATE);
     END
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_EIP1 FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 67 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_DATE TIMESTAMP;
DECLARE VARIABLE WK_USER VARCHAR(10);
DECLARE VARIABLE WK_SUB_LOCN VARCHAR(10);
DECLARE VARIABLE WK_OBJECT VARCHAR(30);
DECLARE VARIABLE WK_DEVICE VARCHAR(2);
DECLARE VARIABLE WK_CARD VARCHAR(10);
DECLARE VARIABLE WK_CLASS CHAR(1);
DECLARE VARIABLE WK_WH_ID CHAR(2);
DECLARE VARIABLE WK_LOCN_ID VARCHAR(10);
DECLARE VARIABLE WK_QTY INTEGER;
DECLARE VARIABLE WK_REF VARCHAR(40);
DECLARE VARIABLE WK_FOUND INTEGER;
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'EIP1') THEN
  BEGIN
     WK_FOUND = 0;
     WK_OBJECT = NEW.OBJECT;
     WK_CARD = alltrim(substr(WK_OBJECT,1, 10));
     WK_REF = alltrim(NEW.REFERENCE);
     WK_DATE = NEW.TRN_DATE;
     WK_USER = NEW.PERSON_ID;
     SELECT 1
       FROM EMPLOYEE
       WHERE EMPLOYEE_ID = :WK_CARD
       INTO :WK_FOUND;
     IF (WK_FOUND = 1) THEN
     BEGIN
        /* employee exists so update */
        UPDATE EMPLOYEE SET
           MAIL_ADDRESS1 = :WK_REF,
    UPDATE_BY = :WK_USER,
           UPDATE_DATE = :WK_DATE
           WHERE EMPLOYEE_ID = :WK_CARD;
     END
     ELSE
     BEGIN
        /* no employee so add */
        INSERT INTO EMPLOYEE (
           EMPLOYEE_ID,
           MAIL_ADDRESS1,
           CREATE_BY,
           CREATE_DATE)
           VALUES (
           :WK_CARD,
           :WK_REF,
           :WK_USER,
           :WK_DATE);
     END
     WK_FOUND = 0;
     SELECT 1
       FROM PERSON
       WHERE PERSON_ID = :WK_CARD
       INTO :WK_FOUND;
     IF (WK_FOUND = 1) THEN
     BEGIN
        /* person exists so update */
        /* PERSON_TYPE = 'IN' */
        UPDATE PERSON SET
           MAIL_ADDRESS1 = :WK_REF
           WHERE PERSON_ID = :WK_CARD;
     END
     ELSE
     BEGIN
        /* no person so add */
        INSERT INTO PERSON (
           PERSON_ID,
           MAIL_ADDRESS1,
           PERSON_TYPE,
           CREATE_DATE)
           VALUES (
           :WK_CARD,
           :WK_REF,
           'IN',
           :WK_DATE);
     END
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_EIP2 FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 68 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_DATE TIMESTAMP;
DECLARE VARIABLE WK_USER VARCHAR(10);
DECLARE VARIABLE WK_SUB_LOCN VARCHAR(10);
DECLARE VARIABLE WK_OBJECT VARCHAR(30);
DECLARE VARIABLE WK_DEVICE VARCHAR(2);
DECLARE VARIABLE WK_CARD VARCHAR(10);
DECLARE VARIABLE WK_CLASS CHAR(1);
DECLARE VARIABLE WK_WH_ID CHAR(2);
DECLARE VARIABLE WK_LOCN_ID VARCHAR(10);
DECLARE VARIABLE WK_QTY INTEGER;
DECLARE VARIABLE WK_REF VARCHAR(40);
DECLARE VARIABLE WK_FOUND INTEGER;
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'EIP2') THEN
  BEGIN
     WK_FOUND = 0;
     WK_OBJECT = NEW.OBJECT;
     WK_CARD = alltrim(substr(WK_OBJECT,1, 10));
     WK_REF = alltrim(NEW.REFERENCE);
     WK_DATE = NEW.TRN_DATE;
     WK_USER = NEW.PERSON_ID;
     SELECT 1
       FROM EMPLOYEE
       WHERE EMPLOYEE_ID = :WK_CARD
       INTO :WK_FOUND;
     IF (WK_FOUND = 1) THEN
     BEGIN
        /* employee exists so update */
        UPDATE EMPLOYEE SET
           MAIL_ADDRESS2 = :WK_REF,
    UPDATE_BY = :WK_USER,
           UPDATE_DATE = :WK_DATE
           WHERE EMPLOYEE_ID = :WK_CARD;
     END
     ELSE
     BEGIN
        /* no employee so add */
        INSERT INTO EMPLOYEE (
           EMPLOYEE_ID,
           MAIL_ADDRESS2,
           CREATE_BY,
           CREATE_DATE)
           VALUES (
           :WK_CARD,
           :WK_REF,
           :WK_USER,
           :WK_DATE);
     END
     WK_FOUND = 0;
     SELECT 1
       FROM PERSON
       WHERE PERSON_ID = :WK_CARD
       INTO :WK_FOUND;
     IF (WK_FOUND = 1) THEN
     BEGIN
        /* person exists so update */
        /* PERSON_TYPE = 'IN' */
        UPDATE PERSON SET
           MAIL_ADDRESS2 = :WK_REF
           WHERE PERSON_ID = :WK_CARD;
     END
     ELSE
     BEGIN
        /* no person so add */
        INSERT INTO PERSON (
           PERSON_ID,
           MAIL_ADDRESS2,
           PERSON_TYPE,
           CREATE_DATE)
           VALUES (
           :WK_CARD,
           :WK_REF,
           'IN',
           :WK_DATE);
     END
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_EIP3 FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 69 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_DATE TIMESTAMP;
DECLARE VARIABLE WK_USER VARCHAR(10);
DECLARE VARIABLE WK_SUB_LOCN VARCHAR(10);
DECLARE VARIABLE WK_OBJECT VARCHAR(30);
DECLARE VARIABLE WK_DEVICE VARCHAR(2);
DECLARE VARIABLE WK_CARD VARCHAR(10);
DECLARE VARIABLE WK_SUBURB VARCHAR(20);
DECLARE VARIABLE WK_STATE  VARCHAR(20);
DECLARE VARIABLE WK_COUNTRY  VARCHAR(25);
DECLARE VARIABLE WK_CLASS CHAR(1);
DECLARE VARIABLE WK_WH_ID CHAR(2);
DECLARE VARIABLE WK_LOCN_ID VARCHAR(10);
DECLARE VARIABLE WK_QTY INTEGER;
DECLARE VARIABLE WK_REF VARCHAR(40);
DECLARE VARIABLE WK_FOUND INTEGER;
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'EIA3') THEN
  BEGIN
     WK_FOUND = 0;
     WK_OBJECT = NEW.OBJECT;
     WK_CARD = alltrim(substr(WK_OBJECT,1, 10));
     WK_SUBURB = alltrim(substr(WK_OBJECT,11, 30));
     WK_WH_ID = NEW.WH_ID;
     WK_LOCN_ID = NEW.LOCN_ID;
     WK_STATE = alltrim(WK_WH_ID || WK_LOCN_ID);
     WK_SUB_LOCN = alltrim(NEW.SUB_LOCN_ID);
     WK_REF = NEW.REFERENCE;
     WK_COUNTRY = alltrim(substr(WK_REF,1, 25));
     WK_DATE = NEW.TRN_DATE;
     WK_USER = NEW.PERSON_ID;
     SELECT 1
       FROM EMPLOYEE
       WHERE EMPLOYEE_ID = :WK_CARD
       INTO :WK_FOUND;
     IF (WK_FOUND = 1) THEN
     BEGIN
        /* employee exists so update */
        UPDATE EMPLOYEE SET
           MAIL_COUNTRY = :WK_COUNTRY,
           MAIL_CITY = :WK_SUBURB,
           MAIL_STATE = :WK_STATE,
           MAIL_POST_CODE = :WK_SUB_LOCN,
    UPDATE_BY = :WK_USER,
           UPDATE_DATE = :WK_DATE
           WHERE EMPLOYEE_ID = :WK_CARD;
     END
     ELSE
     BEGIN
        /* no employee so add */
        INSERT INTO EMPLOYEE (
           EMPLOYEE_ID,
           MAIL_COUNTRY ,
           MAIL_CITY ,
           MAIL_STATE ,
           MAIL_POST_CODE ,
           CREATE_BY,
           CREATE_DATE)
           VALUES (
           :WK_CARD,
           :WK_COUNTRY,
           :WK_SUBURB,
           :WK_STATE,
           :WK_SUB_LOCN,
           :WK_USER,
           :WK_DATE);
     END
     WK_FOUND = 0;
     SELECT 1
       FROM PERSON
       WHERE PERSON_ID = :WK_CARD
       INTO :WK_FOUND;
     IF (WK_FOUND = 1) THEN
     BEGIN
        /* person exists so update */
        /* PERSON_TYPE = 'IN' */
        UPDATE PERSON SET
           MAIL_COUNTRY = :WK_COUNTRY,
           MAIL_CITY = :WK_SUBURB,
           MAIL_STATE = :WK_STATE,
           MAIL_POST_CODE = :WK_SUB_LOCN
           WHERE PERSON_ID = :WK_CARD;
     END
     ELSE
     BEGIN
        /* no person so add */
        INSERT INTO PERSON (
           PERSON_ID,
           MAIL_COUNTRY ,
           MAIL_CITY ,
           MAIL_STATE ,
           MAIL_POST_CODE ,
           PERSON_TYPE,
           CREATE_DATE)
           VALUES (
           :WK_CARD,
           :WK_COUNTRY,
           :WK_SUBURB,
           :WK_STATE,
           :WK_SUB_LOCN,
           'IN',
           :WK_DATE);
     END
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_EITS FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 70 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_DATE TIMESTAMP;
DECLARE VARIABLE WK_USER VARCHAR(10);
DECLARE VARIABLE WK_SUB_LOCN VARCHAR(10);
DECLARE VARIABLE WK_OBJECT VARCHAR(30);
DECLARE VARIABLE WK_DEVICE VARCHAR(2);
DECLARE VARIABLE WK_CARD VARCHAR(10);
DECLARE VARIABLE WK_CLASS CHAR(1);
DECLARE VARIABLE WK_WH_ID CHAR(2);
DECLARE VARIABLE WK_LOCN_ID VARCHAR(10);
DECLARE VARIABLE WK_CC VARCHAR(10);
DECLARE VARIABLE WK_TRAINER VARCHAR(10);
DECLARE VARIABLE WK_QTY INTEGER;
DECLARE VARIABLE WK_REF VARCHAR(40);
DECLARE VARIABLE WK_SKILL VARCHAR(10);
DECLARE VARIABLE WK_PASS VARCHAR(4);
DECLARE VARIABLE WK_PASS_RESULT CHAR(1);
DECLARE VARIABLE WK_COMPULSORY CHAR(1);
DECLARE VARIABLE WK_FOUND INTEGER;
DECLARE VARIABLE WK_DUMMY INTEGER;
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'EITS') THEN
  BEGIN
     WK_FOUND = 0;
     WK_OBJECT = NEW.OBJECT;
     WK_SKILL = ALLTRIM(SUBSTR(WK_OBJECT,1,10));
     WK_PASS = ALLTRIM(SUBSTR(WK_OBJECT,11,14));
     WK_SUB_LOCN = NEW.SUB_LOCN_ID;
     WK_TRAINER = ALLTRIM(WK_SUB_LOCN);
     WK_WH_ID = NEW.WH_ID;
     WK_LOCN_ID = NEW.LOCN_ID;
     WK_CARD = ALLTRIM(WK_WH_ID) || ALLTRIM(WK_LOCN_ID);
     WK_REF = NEW.REFERENCE;
     WK_CC = ALLTRIM(WK_REF);
     IF (WK_PASS = 'PASS') THEN
     BEGIN
        WK_PASS_RESULT = 'T';
     END
     ELSE
     BEGIN
        WK_PASS_RESULT = 'F';
     END
     
     WK_DATE = NEW.TRN_DATE;
     WK_USER = NEW.PERSON_ID;
     SELECT 1
       FROM EMPLOYEE
       WHERE EMPLOYEE_ID = :WK_CARD
       INTO :WK_FOUND;
     IF (WK_FOUND = 1) THEN
     BEGIN
        /* employee exists so update */
        WK_DUMMY = 1;
     END
     ELSE
     BEGIN
        /* no employee so add */
        INSERT INTO EMPLOYEE (
           EMPLOYEE_ID,
           CREATE_BY,
           CREATE_DATE)
           VALUES (
           :WK_CARD,
           :WK_USER,
           :WK_DATE);
     END
     WK_FOUND = 0;
     SELECT 1
       FROM EMPLOYEE_SKILL
       WHERE EMPLOYEE_ID = :WK_CARD
         AND SKILL_CODE = :WK_SKILL
       INTO :WK_FOUND;
     IF (WK_FOUND = 1) THEN
     BEGIN
        /* skill exists so update */
        UPDATE EMPLOYEE_SKILL SET
           TRAINING_DATE = :WK_DATE,
           TRAINING_BY = :WK_TRAINER,
           TRAINING_LOCATION = :WK_CC,
           TRAINING_PASS = :WK_PASS_RESULT
           WHERE EMPLOYEE_ID = :WK_CARD
             AND SKILL_CODE = :WK_SKILL;
     END
     ELSE
     BEGIN
        /* no employee skill so add */
        /* get whether skill is compulsory */
        SELECT COMPULSORY_SKILL
          FROM SKILL
          WHERE CODE = :WK_SKILL
          INTO :WK_COMPULSORY;
        INSERT INTO EMPLOYEE_SKILL (
           EMPLOYEE_ID ,
           SKILL_CODE ,
           TRAINING_DATE,
           TRAINING_BY,
           TRAINING_LOCATION,
           TRAINING_PASS,
           COMPULSORY_SKILL
           )
           VALUES (
           :WK_CARD,
           :WK_SKILL,
           :WK_DATE,
           :WK_TRAINER,
           :WK_CC,
           :WK_PASS_RESULT,
           :WK_COMPULSORY);
     END
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_EIIP FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 71 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_DATE TIMESTAMP;
DECLARE VARIABLE WK_USER VARCHAR(10);
DECLARE VARIABLE WK_SUB_LOCN VARCHAR(10);
DECLARE VARIABLE WK_COLOR VARCHAR(54);
DECLARE VARIABLE WK_OBJECT VARCHAR(30);
DECLARE VARIABLE WK_DEVICE VARCHAR(2);
DECLARE VARIABLE WK_CARD VARCHAR(10);
DECLARE VARIABLE WK_CARD_TRIM VARCHAR(10);
DECLARE VARIABLE WK_IMAGE_ID VARCHAR(10);
DECLARE VARIABLE WK_LOGO_ID VARCHAR(20);
DECLARE VARIABLE WK_IMAGE_ID2 INTEGER;
DECLARE VARIABLE WK_RECORD INTEGER;
DECLARE VARIABLE WK_CLASS CHAR(1);
DECLARE VARIABLE WK_WH_ID CHAR(2);
DECLARE VARIABLE WK_LOCN_ID VARCHAR(10);
DECLARE VARIABLE WK_EMPLOYER_ID VARCHAR(10);
DECLARE VARIABLE WK_EMPLOYER VARCHAR(12);
DECLARE VARIABLE WK_QTY INTEGER;
DECLARE VARIABLE WK_REF VARCHAR(40);
DECLARE VARIABLE WK_SKILLS VARCHAR(80);
DECLARE VARIABLE WK_SKILL_ID VARCHAR(10);
DECLARE VARIABLE WK_PRINTER CHAR(2);
DECLARE VARIABLE WK_TITLE VARCHAR(10);
DECLARE VARIABLE WK_1ST_NAME VARCHAR(30);
DECLARE VARIABLE WK_2ND_NAME VARCHAR(30);
DECLARE VARIABLE WK_NAME VARCHAR(70);
DECLARE VARIABLE WK_IMAGE_TYPE VARCHAR(5);
DECLARE VARIABLE WK_IMAGE_NAME VARCHAR(16);
DECLARE VARIABLE WK_LINE2 VARCHAR(1024);
DECLARE VARIABLE WK_FOUND INTEGER;
DECLARE VARIABLE WK_DIRECTORY VARCHAR(75);
DECLARE VARIABLE WK_FILENAME VARCHAR(255);
DECLARE VARIABLE WK_FILENAME_OUT VARCHAR(255);
DECLARE VARIABLE WK_LABEL_LINE VARCHAR(250);
DECLARE VARIABLE WK_RESULT INTEGER;
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'EIIP') THEN
  BEGIN
     WK_FOUND = 0;
     WK_RECORD = NEW.RECORD_ID;
     WK_OBJECT = NEW.OBJECT;
/*
     WK_CARD = alltrim(substr(WK_OBJECT,1, 10));
     WK_IMAGE_ID = alltrim(substr(WK_OBJECT,11, 20));
     WK_LOGO_ID = substr(WK_OBJECT,21, 30)
     need to calc wk_card and wk_logo_id
*/
     WK_IMAGE_ID = alltrim(substr(WK_OBJECT,1, 10));
     WK_IMAGE_ID2 = CAST(WK_IMAGE_ID AS INTEGER); 
/*
     WK_WH_ID = NEW.WH_ID;
     WK_LOCN_ID = NEW.LOCN_ID;
     WK_EMPLOYER = WK_WH_ID || WK_LOCN_ID;
     WK_EMPLOYER_ID = substr(WK_EMPLOYER,1, 10);
     WK_SUB_LOCN = NEW.SUB_LOCN_ID;
     WK_COLOR = alltrim(WK_SUB_LOCN) || '.bmp';
     need to calc company and color
*/
     WK_REF = NEW.REFERENCE;
/*
     WK_SKILLS = substr(WK_REF,1,38);
     WK_PRINTER = substr(WK_REF,39,40);
     need to calc skills
*/
     WK_PRINTER = substr(WK_REF,1,2);
     WK_DATE = NEW.TRN_DATE;
     WK_USER = NEW.PERSON_ID;
     WK_QTY = NEW.QTY;
     SELECT PERSON_ID
       FROM EMPLOYEE_IMAGE
       WHERE IMAGE_ID = :WK_IMAGE_ID2
       INTO :WK_CARD;
     WK_CARD_TRIM = ALLTRIM(WK_CARD);
     WK_LOGO_ID = 'ALJV.JPG';
     SELECT TITLE, FIRST_NAME, LAST_NAME, COMPANY_ID, EMP_UDF2
       FROM EMPLOYEE
       WHERE EMPLOYEE_ID = :WK_CARD
       INTO :WK_TITLE, :WK_1ST_NAME, :WK_2ND_NAME, :WK_EMPLOYER_ID, :WK_COLOR;
     /* WK_NAME = NONULL(WK_TITLE) || ' ' || NONULL(WK_1ST_NAME) || ' ' || NONULL(WK_2ND_NAME); */
     SELECT (SELECT *  FROM  NONULLP(:WK_TITLE)) || ' ' || (SELECT * FROM NONULLP(:WK_1ST_NAME)) || ' ' || (SELECT * FROM NONULLP(:WK_2ND_NAME)) FROM CONTROL INTO :WK_NAME;
     /* WK_COLOR = WK_COLOR || '.bmp'; */
     SELECT IMAGE_FORMAT 
       FROM EMPLOYEE_IMAGE
       WHERE IMAGE_ID = :WK_IMAGE_ID2
       INTO :WK_IMAGE_TYPE;
     /* WK_IMAGE_NAME = WK_CARD || '.' || WK_IMAGE_TYPE; */
     WK_IMAGE_NAME = WK_CARD_TRIM || WK_IMAGE_TYPE;
     WK_SKILLS = 'SKILLS =';
     FOR SELECT
        EMPLOYEE_SKILL.SKILL_CODE 
        FROM EMPLOYEE_SKILL 
        JOIN SKILL ON SKILL.CODE = EMPLOYEE_SKILL.SKILL_CODE
        WHERE EMPLOYEE_SKILL.EMPLOYEE_ID = :WK_CARD
        AND SKILL.PUBLISH = 'T'
        ORDER BY EMPLOYEE_SKILL.TRAINING_DATE
        INTO :WK_SKILL_ID
     DO
     BEGIN
        IF (STRLEN(WK_SKILLS) < 69) THEN
        BEGIN
           WK_SKILLS = WK_SKILLS || ' ' || WK_SKILL_ID;
        END
     END
     SELECT DESCRIPTION  
       FROM CARDTEXT      
       WHERE CODE = 'STDBACK'
       INTO :WK_LINE2;
     
   /* need the directory for this label set */
     SELECT WORKING_DIRECTORY FROM SYS_EQUIP 
       WHERE DEVICE_ID = :WK_PRINTER
       INTO :WK_DIRECTORY;
   /* append the file name to the directory*/
     WK_FILENAME = WK_DIRECTORY || 'IDCARD.wxt';
     WK_FILENAME_OUT = WK_DIRECTORY || 'IDCARD.cxt';
     WK_LABEL_LINE = DQUOTEDSTR('1') || ',' ||
         DQUOTEDSTR(WK_LOGO_ID) || ',' ||
         DQUOTEDSTR(WK_COLOR) || ',"",' ||
         DQUOTEDSTR(WK_IMAGE_NAME) || ',' || /* image */
         DQUOTEDSTR(WK_CARD_TRIM) || ',' ||
         DQUOTEDSTR(WK_NAME) || ',"WESTLINK M7 INDUCTION CARD",' ||
         DQUOTEDSTR(WK_EMPLOYER_ID) || ',' ||
         DQUOTEDSTR(WK_SKILLS) || ',' ||
         DQUOTEDSTR(WK_IMAGE_ID)  ;
     WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE);
     IF (WK_RESULT <> 0) THEN
     BEGIN
        WK_FILENAME = WK_DIRECTORY || 'IDCARD.2xt';
        WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE);
     END
     WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LINE2);

     WK_RESULT = FILE_RENAME(WK_FILENAME, WK_FILENAME_OUT);
    /* Update transactions table */        
    EXECUTE PROCEDURE UPDATE_TRAN (:WK_RECORD, 'T', 'Processed successfully');
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_EIEM FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 72 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_DATE TIMESTAMP;
DECLARE VARIABLE WK_USER VARCHAR(10);
DECLARE VARIABLE WK_SUB_LOCN VARCHAR(10);
DECLARE VARIABLE WK_OBJECT VARCHAR(30);
DECLARE VARIABLE WK_DEVICE VARCHAR(2);
DECLARE VARIABLE WK_COMPANY VARCHAR(10);
DECLARE VARIABLE WK_1ST_NAME VARCHAR(255);
DECLARE VARIABLE WK_CLASS CHAR(1);
DECLARE VARIABLE WK_WH_ID CHAR(2);
DECLARE VARIABLE WK_LOCN_ID VARCHAR(10);
DECLARE VARIABLE WK_QTY INTEGER;
DECLARE VARIABLE WK_REF VARCHAR(40);
DECLARE VARIABLE WK_FOUND INTEGER;
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'EIEM') THEN
  BEGIN
     WK_FOUND = 0;
     WK_OBJECT = NEW.OBJECT;
     WK_SUB_LOCN = NEW.SUB_LOCN_ID;
     WK_COMPANY = alltrim(WK_SUB_LOCN);
     WK_REF = NEW.REFERENCE;
     WK_WH_ID = NEW.WH_ID;
     WK_LOCN_ID = NEW.LOCN_ID;
     WK_1ST_NAME = alltrim(WK_OBJECT) || alltrim(WK_WH_ID) || alltrim(WK_LOCN_ID) || alltrim(WK_REF);
     WK_DATE = NEW.TRN_DATE;
     WK_USER = NEW.PERSON_ID;
     SELECT 1
       FROM PERSON
       WHERE PERSON_ID = :WK_COMPANY
       INTO :WK_FOUND;
     IF (WK_FOUND = 1) THEN
     BEGIN
        /* person exists so update */
        /* PERSON_TYPE = 'CE' */
        UPDATE PERSON SET
           FIRST_NAME = :WK_1ST_NAME
           WHERE PERSON_ID = :WK_COMPANY;
     END
     ELSE
     BEGIN
        /* no person so add */
        INSERT INTO PERSON (
           PERSON_ID,
           FIRST_NAME,
           PERSON_TYPE,
           CREATE_DATE)
           VALUES (
           :WK_COMPANY,
           :WK_1ST_NAME,
           'CE',
           :WK_DATE);
     END
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_STLX FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 73 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'STLX') THEN
  BEGIN
   EXECUTE PROCEDURE PC_STLX 
    NEW.RECORD_ID ,
    NEW.WH_ID,
    NEW.LOCN_ID,
    NEW.DEVICE_ID,
    NEW.TRN_DATE;
   /* EXECUTE PROCEDURE TRAN_ARCHIVE; */
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_STLO FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 74 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'STLO') THEN
  BEGIN
   /* open last stocktake location for device */
   EXECUTE PROCEDURE PC_STLX 
    NEW.RECORD_ID ,
    '',
    '',
    NEW.DEVICE_ID,
    NEW.TRN_DATE;
   /* start stocktake of location for device */
   EXECUTE PROCEDURE PC_STLO 
    NEW.RECORD_ID ,
    NEW.WH_ID,
    NEW.LOCN_ID,
    NEW.DEVICE_ID,
    NEW.TRN_DATE;
   /* EXECUTE PROCEDURE TRAN_ARCHIVE; */
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_STOB FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 75 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'STOB') THEN
  BEGIN
   EXECUTE PROCEDURE PC_STOB 
    NEW.RECORD_ID ,
    NEW.WH_ID,
    NEW.LOCN_ID,
    NEW.OBJECT,
    NEW.TRN_TYPE,
    NEW.TRN_CODE,
    NEW.TRN_DATE,
    NEW.REFERENCE,
    NEW.QTY,
    NEW.PERSON_ID,
    NEW.DEVICE_ID,
    NEW.INSTANCE_ID;

   EXECUTE PROCEDURE TRAN_ARCHIVE;
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_STRC FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 76 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'STRC') THEN
  BEGIN
   EXECUTE PROCEDURE PC_STRC 
    NEW.RECORD_ID ,
    NEW.WH_ID,
    NEW.LOCN_ID,
    NEW.OBJECT,
    NEW.TRN_TYPE,
    NEW.TRN_CODE,
    NEW.TRN_DATE,
    NEW.REFERENCE,
    NEW.QTY,
    NEW.PERSON_ID,
    NEW.DEVICE_ID,
    NEW.INSTANCE_ID;

   EXECUTE PROCEDURE TRAN_ARCHIVE;
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_DSOL FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 77 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_OBJECT  VARCHAR(30);
DECLARE VARIABLE WK_CONSIGNMENT VARCHAR(20);
DECLARE VARIABLE WK_CLASS CHAR(1);
DECLARE VARIABLE WK_REF  VARCHAR(40);
DECLARE VARIABLE WK_WH_ID  VARCHAR(2);
DECLARE VARIABLE WK_LOCN_ID  VARCHAR(10);
DECLARE VARIABLE WK_DESPATCH_ID INTEGER;
DECLARE VARIABLE WK_DATE TIMESTAMP;
DECLARE VARIABLE WK_USER VARCHAR(10);
DECLARE VARIABLE WK_DEVICE VARCHAR(2);
DECLARE VARIABLE WK_LABEL_NO INTEGER;
DECLARE VARIABLE WK_PACK_ID INTEGER;
DECLARE VARIABLE WK_DETAIL_ID INTEGER;
DECLARE VARIABLE WK_FOUND INTEGER;
DECLARE VARIABLE WK_LABEL VARCHAR(40);
DECLARE VARIABLE WK_RECORD INTEGER;
DECLARE VARIABLE WK_QTY INTEGER;
DECLARE VARIABLE WK_PREFIX VARCHAR(5);
DECLARE VARIABLE WK_START INTEGER;
DECLARE VARIABLE WK_END INTEGER;
DECLARE VARIABLE WK_BARCODE_LEN INTEGER;
DECLARE VARIABLE WK_CHARS CHAR(37);
DECLARE VARIABLE WK_REM INTEGER;
DECLARE VARIABLE WK_TOT INTEGER;
DECLARE VARIABLE WK_QUOT INTEGER;
DECLARE VARIABLE WK_CHAR CHAR(1);
DECLARE VARIABLE WK_CNT  INTEGER;
DECLARE VARIABLE WK_LABEL_LEN  INTEGER;
DECLARE VARIABLE WK_LABEL_CURRENT  INTEGER;
DECLARE VARIABLE WK_LABEL_START    INTEGER;
DECLARE VARIABLE WK_LABEL_END  INTEGER;
/*
DECLARE VARIABLE WK_RESULT INTEGER;
DECLARE VARIABLE WK_BUFFER VARCHAR(1024);
DECLARE VARIABLE WK_FILENAME VARCHAR(255);
*/
DECLARE VARIABLE WK_LABEL_BASE  INTEGER;

BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'DSOL') THEN
  BEGIN
     WK_OBJECT = NEW.OBJECT;
     WK_CONSIGNMENT = SUBSTR(WK_OBJECT,1, 20);
     WK_CLASS = NEW.TRN_CODE;
     WK_REF = NEW.REFERENCE;
     /* WK_LABEL = SUBSTR(WK_REF,1,20); */
     WK_LABEL = WK_REF;
     WK_DATE = NEW.TRN_DATE;
     WK_USER = NEW.PERSON_ID;
     WK_QTY = NEW.QTY;
     WK_DEVICE = NEW.DEVICE_ID;
     WK_RECORD = NEW.RECORD_ID; 
     WK_FOUND = 0;
     IF (WK_CLASS = 'O') THEN
     BEGIN
        SELECT FIRST 1 CARRIER.PREFIX, CARRIER.START_NO, CARRIER.END_NO , CARRIER.LABEL_NUMBER_BASE
        FROM PICK_DESPATCH
        JOIN CARRIER ON CARRIER.CARRIER_ID = PICK_DESPATCH.PICKD_CARRIER_ID
        WHERE PICK_DESPATCH.AWB_CONSIGNMENT_NO = :WK_CONSIGNMENT
          AND PICK_DESPATCH.DESPATCH_STATUS = 'DC'
        INTO :WK_PREFIX, :WK_START, :WK_END, :WK_LABEL_BASE;
        /* get length of barcode from param */
        SELECT MAX_LENGTH FROM PARAM WHERE DATA_ID = 'DESPATCHADDRESS'
        INTO :WK_BARCODE_LEN; 
        /* remove length of prefix */
        WK_BARCODE_LEN = WK_BARCODE_LEN - LEN(WK_PREFIX);
        WK_CHARS = '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ@';
        IF (WK_LABEL_BASE IS NULL) THEN
        BEGIN
           WK_LABEL_BASE = 10;
        END
        WK_CNT = 0;
        WK_LABEL_NO = 0;
        WK_LABEL = '';
        IF (WK_CNT < WK_QTY) THEN
        BEGIN
           WK_LABEL_START = gen_id(DESPATCH_DSOT,1);
           WK_LABEL_END = gen_id(DESPATCH_DSOT, WK_QTY -1);
           WK_LABEL_CURRENT = WK_LABEL_START;
        END
        WHILE (WK_CNT < WK_QTY) DO
        BEGIN
           /* WK_LABEL_NO = mod(gen_id(DESPATCH_DSOT,1), :WK_END - :WK_START) + :WK_START; */
           WK_LABEL_NO = mod(WK_LABEL_CURRENT, :WK_END - :WK_START) + :WK_START;
           WK_LABEL = '';
           WK_LABEL_LEN = 0;
           WK_TOT = WK_LABEL_NO;
           WHILE (WK_LABEL_LEN < WK_BARCODE_LEN) DO
           BEGIN
              /* do for length remaining */
              /*
              WK_QUOT = modquot(WK_TOT, 36);
              WK_REM = mod(WK_TOT ,36);
              */
              WK_QUOT = modquot(WK_TOT, WK_LABEL_BASE);
              WK_REM = mod(WK_TOT ,WK_LABEL_BASE);
              WK_CHAR = substr(WK_CHARS,WK_REM +1,WK_REM +1);
              WK_LABEL = WK_LABEL || WK_CHAR;
              WK_TOT = WK_QUOT;
              WK_LABEL_LEN = WK_LABEL_LEN + 1;
           END
           /* now swap order */
           WK_LABEL = WK_PREFIX || reverse(WK_LABEL);
   
           SELECT FIRST 1 1,PACK_ID.PACK_ID
           FROM PICK_DESPATCH
           JOIN PACK_ID ON PICK_DESPATCH.DESPATCH_ID = PACK_ID.DESPATCH_ID
           WHERE PICK_DESPATCH.AWB_CONSIGNMENT_NO = :WK_CONSIGNMENT
             AND PACK_ID.DESPATCH_LABEL_NO IS NULL  
            INTO :WK_FOUND, :WK_DETAIL_ID;
           IF (WK_FOUND = 1) THEN
           BEGIN
              UPDATE PACK_ID
              SET DESPATCH_LABEL_NO = :WK_LABEL
              WHERE PACK_ID = :WK_DETAIL_ID;
           END
           WK_CNT = WK_CNT + 1;
           WK_LABEL_CURRENT = WK_LABEL_CURRENT + 1;
           WK_LABEL_CURRENT = mod(WK_LABEL_CURRENT, :WK_END - :WK_START);
        END /* loop for qty required */
     END /* dso type */
     ELSE
     BEGIN
        SELECT 1 
           FROM PICK_DESPATCH
           JOIN PACK_ID ON PICK_DESPATCH.DESPATCH_ID = PACK_ID.DESPATCH_ID
           WHERE PICK_DESPATCH.AWB_CONSIGNMENT_NO = :WK_CONSIGNMENT
           AND PACK_ID.DESPATCH_LABEL_NO = :WK_LABEL
           INTO :WK_FOUND;
        IF (WK_FOUND = 0) THEN
        BEGIN
           SELECT FIRST 1 1,PACK_ID.PACK_ID
           FROM PICK_DESPATCH  
           JOIN PACK_ID ON PICK_DESPATCH.DESPATCH_ID = PACK_ID.DESPATCH_ID
           WHERE PICK_DESPATCH.AWB_CONSIGNMENT_NO = :WK_CONSIGNMENT
           AND PACK_ID.DESPATCH_LABEL_NO IS NULL  
           INTO :WK_FOUND, :WK_DETAIL_ID;
           IF (WK_FOUND = 1) THEN
           BEGIN
              UPDATE PACK_ID
              SET DESPATCH_LABEL_NO = :WK_LABEL
              WHERE PACK_ID = :WK_DETAIL_ID;
           END
        END
     END /* dss type */
     UPDATE TRANSACTIONS SET COMPLETE='T',ERROR_TEXT='Processed successfully' WHERE RECORD_ID = :WK_RECORD;

   /* EXECUTE PROCEDURE TRAN_ARCHIVE; */

  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_ISIZ FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 78 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_DEVICE CHAR(2);
DECLARE VARIABLE WK_USER VARCHAR(10);
DECLARE VARIABLE WK_RECORD INTEGER;
DECLARE VARIABLE WK_ISSUE_TO VARCHAR(10);
DECLARE VARIABLE WK_WH_ID CHAR(2);
DECLARE VARIABLE WK_LOCN_ID VARCHAR(10);
DECLARE VARIABLE WK_ZONE VARCHAR(12);
DECLARE VARIABLE WK_PRODUCT VARCHAR(30);
DECLARE VARIABLE WK_CHARGE_TO VARCHAR(40);
DECLARE VARIABLE WK_QTY INTEGER;
DECLARE VARIABLE WK_TRN_TYPE VARCHAR(4);
DECLARE VARIABLE WK_TRN_CODE CHAR(1);
DECLARE VARIABLE WK_AUDIT_DESC VARCHAR(40);
DECLARE VARIABLE WK_DATE TIMESTAMP;
DECLARE VARIABLE WK_SO_ID VARCHAR(10);

DECLARE VARIABLE WK_PICK_LABEL_NO CHAR(8);
DECLARE VARIABLE WK_PICK_LABEL_START INTEGER;
DECLARE VARIABLE WK_PICK_LABEL_STOP INTEGER;
DECLARE VARIABLE WK_PICK_LABEL_PREFIX INTEGER;
DECLARE VARIABLE WK_LEN_LABEL_NO INTEGER;
DECLARE VARIABLE WK_LABEL_LENGTH INTEGER;
DECLARE VARIABLE WK_PICK_ADJUSTMENT INTEGER;
DECLARE VARIABLE WK_L_PICK_LABEL_NO  VARCHAR(7);
DECLARE VARIABLE WK_QTY_TOGET INTEGER;
DECLARE VARIABLE WK_SSN_QTY INTEGER;
DECLARE VARIABLE WK_SSN_ID VARCHAR(30);
DECLARE VARIABLE WK_REASON VARCHAR(40);
DECLARE VARIABLE iSSN_LENGTH INTEGER;
DECLARE VARIABLE iSSN_ID INTEGER;
DECLARE VARIABLE I_SSN_ID VARCHAR(20);
DECLARE VARIABLE I_LEN_SSN_ID INTEGER;
DECLARE VARIABLE LEN_SSN_ID INTEGER;
DECLARE VARIABLE P_SSN_ID INTEGER;
DECLARE VARIABLE WK_PARENT_SSN_ID VARCHAR(30);
DECLARE VARIABLE WK_SAVE_SSN_ID VARCHAR(30);
DECLARE VARIABLE WK_SAVE_PARENT_SSN_ID VARCHAR(30);
DECLARE VARIABLE WK_SAVE_PRODUCT_SSN VARCHAR(30);
DECLARE VARIABLE WK_RES INTEGER;

BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'ISIZ') THEN
  BEGIN
     WK_DEVICE = NEW.DEVICE_ID;
     WK_ISSUE_TO = NEW.SUB_LOCN_ID;
     WK_WH_ID = NEW.WH_ID;
     WK_LOCN_ID = NEW.LOCN_ID;
     /* WK_ZONE = NONULL(WK_WH_ID) || NONULL(WK_LOCN_ID); */
     WK_ZONE = '';
     IF (WK_WH_ID IS NOT NULL) THEN
     BEGIN
        WK_ZONE = WK_WH_ID;
     END
     IF (WK_LOCN_ID IS NOT NULL) THEN
     BEGIN
        WK_ZONE = WK_ZONE || WK_LOCN_ID;
     END
     WK_USER = NEW.PERSON_ID;
     WK_PRODUCT = NEW.OBJECT;
     WK_CHARGE_TO = NEW.REFERENCE;
     WK_QTY = NEW.QTY;
     WK_DATE = NEW.TRN_DATE;
     WK_RECORD = NEW.RECORD_ID;
     WK_TRN_CODE = NEW.TRN_CODE;
     WK_TRN_TYPE = NEW.TRN_TYPE;
     WK_SAVE_SSN_ID = 'SAVE';
     WK_SAVE_PARENT_SSN_ID = 'SAVE';

     WK_AUDIT_DESC = 'Issued to Device ' || :WK_DEVICE ;
/*
     get order for pick_order
     create order
     get label no for pick_item
     create pick_item

     set qtytoget
     for issn in location for product status PA or ST
     {
          if current_qty > qtytoget
                split the issn so that we take the qtytoget
                and create a pick_item_detail for it
                and change the status to 'DX' and put in the XD repository
                set the qtytoget to 0
          else
                take all current_qty
                create a pick_item_detail
                change status to 'DX' and put in the 'XD' respository
                reduce the qtytoget by the current_qty
          if (qtytoget is zero)
               break
     }

as at 29/02/04 reduce qty in ssn and issn (store into prev qty)
as at 17/03/04 if dont have enough qty
 then create that much product
*/

     EXECUTE PROCEDURE  GET_SALE_ORDER_NO 'I'
             RETURNING_VALUES :WK_SO_ID;

     INSERT INTO PICK_ORDER (PICK_ORDER, PICK_ORDER_TYPE, PERSON_ID, COST_CENTER, PICK_DUE_DATE, CREATE_DATE, CREATED_BY, PICK_STARTED, PICK_STATUS) 
            VALUES (:WK_SO_ID,'IS',:WK_ISSUE_TO,:WK_CHARGE_TO,:WK_DATE,:WK_DATE,:WK_USER,:WK_DATE,'DX');


     /* Get length for label */   
     SELECT MAX_LENGTH
     FROM PARAM
     WHERE DATA_ID = 'PICK'
     INTO :WK_LABEL_LENGTH;
     WK_PICK_LABEL_NO = GEN_ID(PICK_LABEL_GEN, 1);
     WK_PICK_LABEL_START = GEN_ID(PICK_LABEL_START, 0);
     WK_PICK_LABEL_STOP = GEN_ID(PICK_LABEL_STOP, 0);
     WK_PICK_LABEL_PREFIX = GEN_ID(PICK_LABEL_PREFIX , 0);
     IF (WK_PICK_LABEL_NO > WK_PICK_LABEL_STOP) THEN
     BEGIN
        WK_PICK_ADJUSTMENT = WK_PICK_LABEL_START - WK_PICK_LABEL_STOP;
        WK_PICK_LABEL_NO = GEN_ID(PICK_LABEL_GEN, WK_PICK_ADJUSTMENT);
        WK_PICK_LABEL_PREFIX = GEN_ID(PICK_LABEL_PREFIX , 1);
        WK_PICK_LABEL_NO = WK_PICK_LABEL_START;
     END
     WK_LEN_LABEL_NO = STRLEN(ALLTRIM(WK_PICK_LABEL_NO)) + 1;     
     /* Get Label prefix */      
     WK_L_PICK_LABEL_NO = chr(WK_PICK_LABEL_PREFIX);
     /* Padding leading with 0 */
     WHILE (WK_LEN_LABEL_NO < WK_LABEL_LENGTH) DO
     BEGIN
        WK_L_PICK_LABEL_NO = WK_L_PICK_LABEL_NO || '0';      
        WK_LEN_LABEL_NO = WK_LEN_LABEL_NO + 1;
     END
     WK_L_PICK_LABEL_NO = WK_L_PICK_LABEL_NO || ALLTRIM(WK_PICK_LABEL_NO);

     INSERT INTO PICK_ITEM(PICK_LABEL_NO,PICK_ORDER,PROD_ID,PICK_ORDER_QTY,PICKED_QTY,CREATE_DATE,USER_ID,DEVICE_ID,PICK_LINE_STATUS,WH_ID,PICK_LOCATION) 
            VALUES (:WK_L_PICK_LABEL_NO,:WK_SO_ID,:WK_PRODUCT,:WK_QTY,:WK_QTY,:WK_DATE,:WK_USER,:WK_DEVICE,'DX',:WK_WH_ID,:WK_LOCN_ID);

     WK_QTY_TOGET = WK_QTY;
/*           AND SSN.SSN_ID = ISSN.ORIGINAL_SSN */
     FOR SELECT ISSN.SSN_ID, ISSN.CURRENT_QTY, ISSN.WH_ID, ISSN.LOCN_ID, ISSN.ORIGINAL_SSN
         FROM ISSN JOIN LOCATION ON LOCATION.WH_ID = ISSN.WH_ID AND LOCATION.LOCN_ID = ISSN.LOCN_ID
         JOIN SSN ON SSN.SSN_ID = ISSN.ORIGINAL_SSN 
         WHERE ISSN.PROD_ID = :WK_PRODUCT
           AND ISSN.ISSN_STATUS IN ('PA','ST')
           AND LOCATION.ZONE_C = :WK_ZONE
          ORDER BY SSN.INTO_DATE
          INTO :WK_SSN_ID, :WK_SSN_QTY, :WK_WH_ID, :WK_LOCN_ID, :WK_PARENT_SSN_ID
     DO
     BEGIN
        WK_SAVE_SSN_ID = WK_SSN_ID;
        WK_SAVE_PARENT_SSN_ID = WK_PARENT_SSN_ID;
        IF (WK_QTY_TOGET > 0) THEN
        BEGIN
           IF (WK_SSN_QTY > WK_QTY_TOGET) THEN
           BEGIN
              /*  SPlit it */
              /* Get length for Barcode */   
              EXECUTE PROCEDURE GET_BARCODE_LENGTH RETURNING_VALUES iSSN_LENGTH;
              iSSN_ID = GEN_ID(ISSN_SSN_ID, 1);
              P_SSN_ID = iSSN_ID - 1;
              LEN_SSN_ID = STRLEN(P_SSN_ID);
              I_SSN_ID = '';
              I_LEN_SSN_ID = STRLEN(P_SSN_ID);
                 
              /* Padding leading with 0 */
              WHILE (I_LEN_SSN_ID < :iSSN_LENGTH) DO
              BEGIN
                 I_SSN_ID = I_SSN_ID || '0';
                 I_LEN_SSN_ID = I_LEN_SSN_ID + 1;
              END
              I_SSN_ID = I_SSN_ID || P_SSN_ID;
                 
              EXECUTE PROCEDURE PC_TRSS 
              :WK_RECORD ,
              :WK_WH_ID,
              :WK_LOCN_ID,
              :WK_SSN_ID,
              'TRSS',
              'A',
              :WK_DATE,
              :I_SSN_ID,
              :WK_QTY_TOGET,
              :WK_USER,
              :WK_DEVICE;
              /* take all this of the split issn */
              UPDATE ISSN SET ISSN_STATUS = 'DX',
                  PREV_PREV_WH_ID = PREV_WH_ID,
                  PREV_PREV_LOCN_ID = PREV_LOCN_ID,
                  PREV_WH_ID = WH_ID,
                  PREV_LOCN_ID = LOCN_ID,
                  WH_ID = 'XD',
                  PREV_QTY = CURRENT_QTY,
                  CURRENT_QTY = 0
               WHERE SSN_ID = :I_SSN_ID;
               UPDATE SSN SET CURRENT_QTY = CURRENT_QTY - :WK_QTY_TOGET
               WHERE SSN_ID = :WK_PARENT_SSN_ID;
               WK_REASON = 'Issued Split ' || :WK_QTY_TOGET || 'to User ' || :WK_USER ;
               EXECUTE PROCEDURE ADD_SSN_HIST('XD', :WK_LOCN_ID, :WK_PARENT_SSN_ID, 
                       :WK_TRN_TYPE, :WK_TRN_CODE, :WK_DATE,
                       :WK_AUDIT_DESC , :WK_REASON, :WK_QTY_TOGET, :WK_USER, :WK_DEVICE); 
               INSERT INTO PICK_ITEM_DETAIL 
                   (PICK_LABEL_NO, 
                    SSN_ID, 
                    PICK_DETAIL_STATUS, 
                    QTY_PICKED,
                    USER_ID, 
                    DEVICE_ID, 
                    CREATE_DATE)
               VALUES (:WK_L_PICK_LABEL_NO, 
                    :I_SSN_ID,
                    'DX',
                    :WK_QTY_TOGET,
                    :WK_USER,
                    :WK_DEVICE,
                    :WK_DATE);
                WK_QTY_TOGET = 0;
           END
           ELSE
           BEGIN
              /* take all this qty */
              UPDATE ISSN SET ISSN_STATUS = 'DX',
                  PREV_PREV_WH_ID = PREV_WH_ID,
                  PREV_PREV_LOCN_ID = PREV_LOCN_ID,
                  PREV_WH_ID = WH_ID,
                  PREV_LOCN_ID = LOCN_ID,
                  WH_ID = 'XD',
                  PREV_QTY = CURRENT_QTY,
                  CURRENT_QTY = 0
               WHERE SSN_ID = :WK_SSN_ID;
               UPDATE SSN SET CURRENT_QTY = CURRENT_QTY - :WK_SSN_QTY
               WHERE SSN_ID = :WK_PARENT_SSN_ID;
               WK_REASON = 'Issued All ' || :WK_QTY || 'to User ' || :WK_USER ;
               EXECUTE PROCEDURE ADD_SSN_HIST('XD', :WK_LOCN_ID, :WK_PARENT_SSN_ID, 
                       :WK_TRN_TYPE, :WK_TRN_CODE, :WK_DATE,
                       :WK_AUDIT_DESC , :WK_REASON, :WK_QTY, :WK_USER, :WK_DEVICE); 
               INSERT INTO PICK_ITEM_DETAIL 
                   (PICK_LABEL_NO, 
                    SSN_ID, 
                    PICK_DETAIL_STATUS, 
                    QTY_PICKED,
                    USER_ID, 
                    DEVICE_ID, 
                    CREATE_DATE)
               VALUES (:WK_L_PICK_LABEL_NO, 
                    :WK_SSN_ID,
                    'DX',
                    :WK_SSN_QTY,
                    :WK_USER,
                    :WK_DEVICE,
                    :WK_DATE);
                WK_QTY_TOGET = WK_QTY_TOGET - WK_SSN_QTY;
           END
        END
     END

   IF (WK_QTY_TOGET > 0) THEN
   BEGIN
      /* must create wk_qty_toget of product and use this */
      /* check that there is an ssn for this product */
      /* otherwise create one (qty 0 into the 'XD' repository) */
      /* create issn in the 'XD' repository */
      WK_SAVE_PRODUCT_SSN = 'SAVE';
      SELECT FIRST 1 ORIGINAL_SSN 
        FROM ISSN
         WHERE ISSN.PROD_ID = :WK_PRODUCT
          INTO :WK_SAVE_PRODUCT_SSN;
/*
      IF (WK_SAVE_PRODUCT_SSN IS NULL) THEN
      BEGIN
         WK_SAVE_PRODUCT_SSN = 'SAVE';
         -* WK_RES = FILE_WRITELN('isiz.txt','save product is null'); *-
      END
*/
         /* Get length for Barcode */   
      EXECUTE PROCEDURE GET_BARCODE_LENGTH RETURNING_VALUES iSSN_LENGTH;
      iSSN_ID = GEN_ID(ISSN_SSN_ID, 1);
      P_SSN_ID = iSSN_ID - 1;
      LEN_SSN_ID = STRLEN(P_SSN_ID);
      I_SSN_ID = '';
      I_LEN_SSN_ID = STRLEN(P_SSN_ID);
                 
      /* Padding leading with 0 */
      WHILE (I_LEN_SSN_ID < :iSSN_LENGTH) DO
      BEGIN
         I_SSN_ID = I_SSN_ID || '0';
         I_LEN_SSN_ID = I_LEN_SSN_ID + 1;
      END
      I_SSN_ID = I_SSN_ID || P_SSN_ID;
      /* WK_RES = FILE_WRITELN('isiz.txt',I_SSN_ID); */
      IF (WK_SAVE_PRODUCT_SSN = 'SAVE') THEN
      BEGIN
         /* must create ssn */
         /* WK_RES = FILE_WRITELN('isiz.txt','about to create ssn'); */
         INSERT INTO SSN(SSN_ID, WH_ID, LOCN_ID, PROD_ID, CURRENT_QTY, STATUS_SSN)
            VALUES (:I_SSN_ID, 'XD', :WK_ISSUE_TO, :WK_PRODUCT, 0, 'DS');
         WK_SAVE_PRODUCT_SSN = I_SSN_ID;
         /* WK_RES = FILE_WRITELN('isiz.txt','created ssn'); */
      END
/*
      INSERT INTO ISSN(SSN_ID, ORIGINAL_SSN, WH_ID, LOCN_ID, PROD_ID, CURRENT_QTY, PREV_QTY, ISSN_STATUS, ORIGINAL_QTY, CREATE_DATE, USER_ID)
         VALUES (:I_SSN_ID, :WK_SAVE_PRODUCT_SSN, 'XD', :WK_ISSUE_TO, :WK_PRODUCT, 0, :WK_QTY_TOGET, 'DS', :WK_QTY_TOGET, :WK_DATE, :WK_USER );
*/
      INSERT INTO ISSN(SSN_ID, ORIGINAL_SSN, WH_ID, LOCN_ID, PROD_ID, CURRENT_QTY, PREV_QTY, ISSN_STATUS, ORIGINAL_QTY, CREATE_DATE, USER_ID)
         VALUES (:I_SSN_ID, :WK_SAVE_PRODUCT_SSN, 'XD', :WK_ISSUE_TO, :WK_PRODUCT, 0, :WK_QTY_TOGET, 'DS', 0, :WK_DATE, :WK_USER );
      /* WK_RES = FILE_WRITELN('isiz.txt','created issn'); */
      WK_REASON = 'Issued All ' || :WK_QTY_TOGET || 'to User ' || :WK_USER ;
      EXECUTE PROCEDURE ADD_SSN_HIST('XD', :WK_LOCN_ID, :WK_SAVE_PRODUCT_SSN, 
              :WK_TRN_TYPE, :WK_TRN_CODE, :WK_DATE,
              :WK_AUDIT_DESC , :WK_REASON, :WK_QTY_TOGET, :WK_USER, :WK_DEVICE); 
      INSERT INTO PICK_ITEM_DETAIL 
          (PICK_LABEL_NO, 
           SSN_ID, 
           PICK_DETAIL_STATUS, 
           QTY_PICKED,
           USER_ID, 
           DEVICE_ID, 
           CREATE_DATE)
      VALUES (:WK_L_PICK_LABEL_NO, 
           :I_SSN_ID,
           'DX',
           :WK_QTY_TOGET,
           :WK_USER,
           :WK_DEVICE,
           :WK_DATE);

/*
      WK_REASON = 'Still to Issue ' || :WK_QTY_TOGET || ' OF ' || :WK_QTY ;
      EXECUTE PROCEDURE UPDATE_TRAN (WK_RECORD, 'F',:WK_REASON);
      IF (WK_SAVE_SSN_ID <> 'SAVE') THEN
      BEGIN
         UPDATE ISSN SET ISSN_STATUS = 'DX',
                  PREV_QTY = CURRENT_QTY,
                  CURRENT_QTY = CURRENT_QTY - :WK_QTY_TOGET
         WHERE SSN_ID = :WK_SAVE_SSN_ID;
         UPDATE SSN SET CURRENT_QTY = CURRENT_QTY - :WK_QTY_TOGET
             WHERE SSN_ID = :WK_SAVE_PARENT_SSN_ID;
         WK_REASON = 'Issued Negative ' || :WK_QTY_TOGET || 'to User ' || :WK_USER ;
         EXECUTE PROCEDURE ADD_SSN_HIST('XD', :WK_LOCN_ID, :WK_SAVE_PARENT_SSN_ID, 
                       :WK_TRN_TYPE, :WK_TRN_CODE, :WK_DATE,
                       :WK_AUDIT_DESC , :WK_REASON, :WK_QTY_TOGET, :WK_USER, :WK_DEVICE); 
      END
*/
      EXECUTE PROCEDURE UPDATE_TRAN (WK_RECORD, 'T','Processed successfully');
   END
   ELSE
   BEGIN
      EXECUTE PROCEDURE UPDATE_TRAN (WK_RECORD, 'T','Processed successfully');
   END
   EXECUTE PROCEDURE TRAN_ARCHIVE;
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_QANX FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 79 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'QANX') THEN
  BEGIN
   EXECUTE PROCEDURE PC_QANX 
    NEW.RECORD_ID ,
    NEW.WH_ID,
    NEW.LOCN_ID,
    NEW.OBJECT,
    NEW.TRN_TYPE,
    NEW.TRN_CODE,
    NEW.TRN_DATE,
    NEW.REFERENCE,
    NEW.QTY,
    NEW.PERSON_ID,
    NEW.DEVICE_ID,
    NEW.SUB_LOCN_ID;
   EXECUTE PROCEDURE TRAN_ARCHIVE;
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_NINB FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 80 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_RECORD INTEGER;
DECLARE VARIABLE WK_FOUND INTEGER;
DECLARE VARIABLE WK_OBJECT VARCHAR(30);
DECLARE VARIABLE WK_NOTE VARCHAR(120);
DECLARE VARIABLE WK_SSN VARCHAR(30);
DECLARE VARIABLE WK_OLD_NOTE BLOB ;
DECLARE VARIABLE WK_NOTE_STR VARCHAR(32000);
DECLARE VARIABLE WK_NOTE_STR2 VARCHAR(32000);
DECLARE VARIABLE WK_START_POSN INTEGER;
DECLARE VARIABLE WK_END_POSN INTEGER;
DECLARE VARIABLE WK_LEN INTEGER;
DECLARE VARIABLE WK_DATE TIMESTAMP ;
DECLARE VARIABLE WK_LEN1 INTEGER;
DECLARE VARIABLE WK_LEN_TOGET INTEGER;
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'NINB') THEN
  BEGIN
     WK_RECORD = NEW.RECORD_ID;
     WK_OBJECT = ALLTRIM(SUBSTR(NEW.OBJECT,1,20));
     WK_DATE = NEW.TRN_DATE;
/*
     WK_NOTE = CAST(WK_DATE AS CHAR(22))  || 
        ' ' || NEW.DEVICE_ID || 
        ' ' || NEW.PERSON_ID || 
        CHR(10) ||
        ALLTRIM(SUBSTR(NEW.OBJECT,21,30) || 
        NONULL(NEW.WH_ID) ||
        ALLTRIM(NONULL(NEW.LOCN_ID)) ||
        NONULL(NEW.SUB_LOCN_ID) ||
        NONULL(NEW.REFERENCE)) ||
        CHR(10) ;
*/
     WK_NOTE = CAST(WK_DATE AS CHAR(22))  || 
        ' ' || NEW.DEVICE_ID || 
        ' ' || NEW.PERSON_ID || 
        CHR(10) ||
        ALLTRIM(SUBSTR(NEW.OBJECT,21,30)) ; 
        IF (NEW.WH_ID IS NOT NULL) THEN
        BEGIN
           WK_NOTE = WK_NOTE || ALLTRIM( NEW.WH_ID);
        END
        IF (NEW.LOCN_ID IS NOT NULL) THEN
        BEGIN
           WK_NOTE = WK_NOTE || ALLTRIM(NEW.LOCN_ID) ;
        END
        IF (NEW.SUB_LOCN_ID IS NOT NULL) THEN
        BEGIN
           WK_NOTE = WK_NOTE || ALLTRIM(NEW.SUB_LOCN_ID) ;
        END
        IF (NEW.REFERENCE IS NOT NULL) THEN
        BEGIN
           WK_NOTE = WK_NOTE || ALLTRIM(NEW.REFERENCE) ;
        END
        WK_NOTE = WK_NOTE || CHR(10) ;
     SELECT 1, SSN.SSN_ID, SSN.NOTES
        FROM ISSN JOIN SSN ON SSN.SSN_ID = ISSN.ORIGINAL_SSN
        WHERE ISSN.SSN_ID = :WK_OBJECT
        INTO :WK_FOUND, WK_SSN, WK_OLD_NOTE;
      IF (WK_OLD_NOTE IS NULL) THEN
      BEGIN
         UPDATE SSN SET NOTES = :WK_NOTE
            WHERE SSN_ID = :WK_SSN;
      END 
      ELSE
      BEGIN
 /* get note in 32767 */
         WK_START_POSN = 1;
         WK_END_POSN = BLOB_BYTECOUNT(:WK_OLD_NOTE);
         WK_NOTE_STR = '';
         WHILE (WK_START_POSN < WK_END_POSN)
         DO
         BEGIN
            /* note strlen has a max str of 32767 */
            WK_LEN_TOGET = WK_END_POSN - WK_START_POSN + 1;
            IF (WK_LEN_TOGET > 32000) THEN
            BEGIN
               WK_LEN_TOGET = 32000;
            END
            WK_NOTE_STR2 = BLOB_SUBSTR(:WK_OLD_NOTE, :WK_START_POSN, :WK_START_POSN + :WK_LEN_TOGET);
            WK_LEN = STRLEN(WK_NOTE_STR) + STRLEN(WK_NOTE_STR2);
            IF (WK_LEN <= 32000) THEN
            BEGIN 
               WK_NOTE_STR = WK_NOTE_STR || WK_NOTE_STR2;
            END
            ELSE
            BEGIN
               WK_LEN1 = STRLEN(:WK_NOTE_STR2);
               WK_NOTE_STR = :WK_NOTE_STR2;
            END
            WK_START_POSN = WK_START_POSN + WK_LEN_TOGET;
         END
         UPDATE SSN SET NOTES = :WK_NOTE_STR || :WK_NOTE
            WHERE SSN_ID = :WK_SSN;
      END

      EXECUTE PROCEDURE UPDATE_TRAN (WK_RECORD, 'T','Processed successfully');
      EXECUTE PROCEDURE TRAN_ARCHIVE;
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_LINB FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 81 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_DEVICE CHAR(2);
DECLARE VARIABLE WK_USER VARCHAR(10);
DECLARE VARIABLE WK_RECORD INTEGER;
DECLARE VARIABLE WK_WH_ID CHAR(2);
DECLARE VARIABLE WK_LOCN_ID VARCHAR(10);
DECLARE VARIABLE WK_OBJECT VARCHAR(30);
DECLARE VARIABLE WK_SUB_LOCN_ID VARCHAR(10);
DECLARE VARIABLE WK_QTY INTEGER;
DECLARE VARIABLE WK_REFERENCE VARCHAR(40);
DECLARE VARIABLE WK_TRN_TYPE VARCHAR(4);
DECLARE VARIABLE WK_TRN_CODE CHAR(1);
DECLARE VARIABLE WK_AUDIT_DESC VARCHAR(40);
DECLARE VARIABLE WK_DATE TIMESTAMP;
DECLARE VARIABLE WK_NAME VARCHAR(52);
DECLARE VARIABLE WK_STAT VARCHAR(40);
DECLARE VARIABLE WK_FOUND INTEGER;


BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'LINB') THEN
  BEGIN
     WK_DEVICE = NEW.DEVICE_ID;
/*
     WK_NAME = NONULL(NEW.OBJECT) || NONULL(NEW.WH_ID) ||
        ALLTRIM(NONULL(NEW.LOCN_ID)) || NONULL(NEW.SUB_LOCN_ID);
*/
     WK_NAME = '';
     IF (NEW.OBJECT IS NOT NULL) THEN
     BEGIN
        WK_NAME = WK_NAME || NEW.OBJECT;
     END
     IF (NEW.WH_ID IS NOT NULL) THEN
     BEGIN
        WK_NAME = WK_NAME || NEW.WH_ID;
     END
     IF (NEW.LOCN_ID IS NOT NULL) THEN
     BEGIN
        WK_NAME = WK_NAME || ALLTRIM(NEW.LOCN_ID);
     END
     IF (NEW.SUB_LOCN_ID IS NOT NULL) THEN
     BEGIN
        WK_NAME = WK_NAME || NEW.SUB_LOCN_ID;
     END
     WK_USER = NEW.PERSON_ID;
     WK_REFERENCE = NEW.REFERENCE;
     WK_QTY = NEW.QTY;
     WK_DATE = NEW.TRN_DATE;
     WK_RECORD = NEW.RECORD_ID;
     WK_TRN_CODE = NEW.TRN_CODE;
     WK_TRN_TYPE = NEW.TRN_TYPE;

     EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_REFERENCE, 1  RETURNING_VALUES :WK_WH_ID ; 
     EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_REFERENCE, 2  RETURNING_VALUES :WK_LOCN_ID ; 
     EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_REFERENCE, 3  RETURNING_VALUES :WK_STAT ; 
     WK_AUDIT_DESC = 'Location Insert, New Borrower ' || :WK_LOCN_ID ;
     WK_FOUND = 0;
     SELECT 1 FROM LOCATION WHERE WH_ID = :WK_WH_ID AND LOCN_ID = :WK_LOCN_ID INTO :WK_FOUND;
     IF (WK_FOUND = 1) THEN
     BEGIN
        /* location exists - so update it */
        UPDATE LOCATION SET
          LOCN_STAT = :WK_STAT, 
          LOCN_NAME = :WK_NAME
          WHERE
          WH_ID = :WK_WH_ID AND 
          LOCN_ID = :WK_LOCN_ID;
     END
     ELSE
     BEGIN
        /* location dosnt exist - so create it */
        INSERT INTO LOCATION(WH_ID, LOCN_ID, LOCN_STAT, LOCN_NAME)
           VALUES (:WK_WH_ID, :WK_LOCN_ID, :WK_STAT, :WK_NAME);
     END
     EXECUTE PROCEDURE UPDATE_TRAN (WK_RECORD, 'T','Processed successfully');
     EXECUTE PROCEDURE TRAN_ARCHIVE;
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_LINS FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 82 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_DEVICE CHAR(2);
DECLARE VARIABLE WK_USER VARCHAR(10);
DECLARE VARIABLE WK_RECORD INTEGER;
DECLARE VARIABLE WK_WH_ID CHAR(2);
DECLARE VARIABLE WK_LOCN_ID VARCHAR(10);
DECLARE VARIABLE WK_OBJECT VARCHAR(30);
DECLARE VARIABLE WK_SUB_LOCN_ID VARCHAR(10);
DECLARE VARIABLE WK_QTY INTEGER;
DECLARE VARIABLE WK_REFERENCE VARCHAR(40);
DECLARE VARIABLE WK_TRN_TYPE VARCHAR(4);
DECLARE VARIABLE WK_TRN_CODE CHAR(1);
DECLARE VARIABLE WK_AUDIT_DESC VARCHAR(40);
DECLARE VARIABLE WK_DATE TIMESTAMP;
DECLARE VARIABLE WK_NAME VARCHAR(52);
DECLARE VARIABLE WK_STAT VARCHAR(40);
DECLARE VARIABLE WK_FOUND INTEGER;


BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'LINS') THEN
  BEGIN
     WK_DEVICE = NEW.DEVICE_ID;
/*
     WK_NAME = NONULL(NEW.OBJECT) || NONULL(NEW.WH_ID) ||
        ALLTRIM(NONULL(NEW.LOCN_ID)) || NONULL(NEW.SUB_LOCN_ID);
*/
     WK_NAME = '';
     IF (NEW.OBJECT IS NOT NULL) THEN
     BEGIN
        WK_NAME = WK_NAME || NEW.OBJECT;
     END
     IF (NEW.WH_ID IS NOT NULL) THEN
     BEGIN
        WK_NAME = WK_NAME || NEW.WH_ID;
     END
     IF (NEW.LOCN_ID IS NOT NULL) THEN
     BEGIN
        WK_NAME = WK_NAME || ALLTRIM(NEW.LOCN_ID);
     END
     IF (NEW.SUB_LOCN_ID IS NOT NULL) THEN
     BEGIN
        WK_NAME = WK_NAME || NEW.SUB_LOCN_ID;
     END
     WK_USER = NEW.PERSON_ID;
     WK_REFERENCE = NEW.REFERENCE;
     WK_QTY = NEW.QTY;
     WK_DATE = NEW.TRN_DATE;
     WK_RECORD = NEW.RECORD_ID;
     WK_TRN_CODE = NEW.TRN_CODE;
     WK_TRN_TYPE = NEW.TRN_TYPE;

     EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_REFERENCE, 1  RETURNING_VALUES :WK_WH_ID ; 
     EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_REFERENCE, 2  RETURNING_VALUES :WK_LOCN_ID ; 
     EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_REFERENCE, 3  RETURNING_VALUES :WK_STAT ; 
     WK_AUDIT_DESC = 'Location Insert, New Location ' || :WK_WH_ID || :WK_LOCN_ID ;
     WK_FOUND = 0;
     SELECT 1 FROM LOCATION WHERE WH_ID = :WK_WH_ID AND LOCN_ID = :WK_LOCN_ID INTO :WK_FOUND;
     IF (WK_FOUND = 1) THEN
     BEGIN
        /* location exists - so update it */
        UPDATE LOCATION SET
          LOCN_STAT = :WK_STAT, 
          LOCN_NAME = :WK_NAME
          WHERE
          WH_ID = :WK_WH_ID AND 
          LOCN_ID = :WK_LOCN_ID;
     END
     ELSE
     BEGIN
        /* location dosnt exist - so create it */
        INSERT INTO LOCATION(WH_ID, LOCN_ID, LOCN_STAT, LOCN_NAME)
           VALUES (:WK_WH_ID, :WK_LOCN_ID, :WK_STAT, :WK_NAME);
     END
     EXECUTE PROCEDURE UPDATE_TRAN (WK_RECORD, 'T','Processed successfully');
     EXECUTE PROCEDURE TRAN_ARCHIVE;
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_PLBI FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 83 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_DEVICE CHAR(2);
DECLARE VARIABLE WK_USER VARCHAR(10);
DECLARE VARIABLE WK_RECORD INTEGER;
DECLARE VARIABLE WK_NAME VARCHAR(52);
DECLARE VARIABLE WK_REFERENCE VARCHAR(40);
DECLARE VARIABLE WK_QTY INTEGER;
DECLARE VARIABLE WK_QTY2 INTEGER;
DECLARE VARIABLE WK_TRN_TYPE VARCHAR(4);
DECLARE VARIABLE WK_TRN_CODE CHAR(1);
DECLARE VARIABLE WK_DATE TIMESTAMP;
DECLARE VARIABLE WK_RESULT INTEGER;
DECLARE VARIABLE WK_BORROWER_ID VARCHAR(40);
DECLARE VARIABLE WK_PRINTER VARCHAR(40);
DECLARE VARIABLE WK_DIRECTORY VARCHAR(75);
DECLARE VARIABLE WK_FILENAME VARCHAR(255);
DECLARE VARIABLE WK_LABEL_LINE VARCHAR(250);

BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'PLBI') THEN
  BEGIN
     WK_DEVICE = NEW.DEVICE_ID;
/*
     WK_NAME = NONULL(NEW.OBJECT) || NONULL(NEW.WH_ID) ||
        ALLTRIM(NONULL(NEW.LOCN_ID)) || NONULL(NEW.SUB_LOCN_ID);
*/
     WK_NAME = '';
     IF (NEW.OBJECT IS NOT NULL) THEN
     BEGIN
        WK_NAME = WK_NAME || NEW.OBJECT;
     END
     IF (NEW.WH_ID IS NOT NULL) THEN
     BEGIN
        WK_NAME = WK_NAME || NEW.WH_ID;
     END
     IF (NEW.LOCN_ID IS NOT NULL) THEN
     BEGIN
        WK_NAME = WK_NAME || ALLTRIM(NEW.LOCN_ID);
     END
     IF (NEW.SUB_LOCN_ID IS NOT NULL) THEN
     BEGIN
        WK_NAME = WK_NAME || NEW.SUB_LOCN_ID;
     END
     WK_USER = NEW.PERSON_ID;
     WK_REFERENCE = NEW.REFERENCE;
     WK_QTY = NEW.QTY;
     WK_DATE = NEW.TRN_DATE;
     WK_RECORD = NEW.RECORD_ID;
     WK_TRN_CODE = NEW.TRN_CODE;
     WK_TRN_TYPE = NEW.TRN_TYPE;

     WK_QTY2 = CAST(WK_QTY AS VARCHAR(10)); 
     EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_REFERENCE, 1  RETURNING_VALUES :WK_BORROWER_ID ; 
     EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_REFERENCE, 2  RETURNING_VALUES :WK_PRINTER ; 
     /* need the directory for this label set */
     SELECT WORKING_DIRECTORY FROM SYS_EQUIP 
       WHERE DEVICE_ID = :WK_PRINTER
       INTO :WK_DIRECTORY;
     /* append the file name to the directory*/
     BEGIN
        WK_FILENAME = WK_DIRECTORY || 'BORROWER.txt';
        WK_LABEL_LINE = DQUOTEDSTR(WK_BORROWER_ID) || ',' ||
          DQUOTEDSTR(WK_NAME) || ',' ||
          WK_QTY2 || ',' ||
          DQUOTEDSTR(WK_PRINTER);
        WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE);
        IF (WK_RESULT <> 0) THEN
        BEGIN
           WK_FILENAME = WK_DIRECTORY || 'BORROWER2.txt';
           WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE);
        END
     END

     EXECUTE PROCEDURE UPDATE_TRAN (WK_RECORD, 'T','Processed successfully');
     EXECUTE PROCEDURE TRAN_ARCHIVE;
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_PLDM FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 84 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_DEVICE CHAR(2);
DECLARE VARIABLE WK_USER VARCHAR(10);
DECLARE VARIABLE WK_RECORD INTEGER;
DECLARE VARIABLE WK_WH_ID CHAR(2);
DECLARE VARIABLE WK_LOCN_ID VARCHAR(10);
DECLARE VARIABLE WK_REFERENCE VARCHAR(40);
DECLARE VARIABLE WK_QTY INTEGER;
DECLARE VARIABLE WK_TRN_TYPE VARCHAR(4);
DECLARE VARIABLE WK_TRN_CODE CHAR(1);
DECLARE VARIABLE WK_DATE TIMESTAMP;
DECLARE VARIABLE WK_RESULT INTEGER;
DECLARE VARIABLE WK_PRINTER VARCHAR(40);
DECLARE VARIABLE WK_DIRECTORY VARCHAR(75);
DECLARE VARIABLE WK_FILENAME VARCHAR(255);
DECLARE VARIABLE WK_LABEL_LINE VARCHAR(250);
DECLARE VARIABLE WK_DATE_STR VARCHAR(20);

BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'PLDM') THEN
  BEGIN
     WK_DEVICE = NEW.DEVICE_ID;
     WK_WH_ID =  NEW.WH_ID ;
     WK_LOCN_ID =  NEW.LOCN_ID ;
     WK_USER = NEW.PERSON_ID;
     WK_PRINTER = NEW.REFERENCE;
     WK_QTY = NEW.QTY;
     WK_DATE = NEW.TRN_DATE;
     WK_RECORD = NEW.RECORD_ID;
     WK_TRN_CODE = NEW.TRN_CODE;
     WK_TRN_TYPE = NEW.TRN_TYPE;
     WK_DATE_STR = CAST(MER_YEAR(WK_DATE) AS CHAR(4)) ||
        CAST(MER_MONTH(WK_DATE) AS VARCHAR(2)) || 
        CAST(MER_DAY(WK_DATE) AS VARCHAR(2)) || 
        CAST(MER_HOUR(WK_DATE) AS VARCHAR(2)) || 
        CAST(MER_MINUTE(WK_DATE) AS VARCHAR(2)) || 
        CAST(SEC(WK_DATE) AS VARCHAR(2)); 

     /* need the directory for this label set */
     SELECT WORKING_DIRECTORY FROM SYS_EQUIP 
       WHERE DEVICE_ID = :WK_PRINTER
       INTO :WK_DIRECTORY;
     /* append the file name to the directory*/
     BEGIN
        WK_FILENAME = WK_DIRECTORY || 'DM' || WK_DEVICE || '.mnt';
        WK_LABEL_LINE = '"' || NEW.WH_ID || '","' ||
          NEW.LOCN_ID || '","' ||
          NEW.REFERENCE || '"';
        WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE);
        IF (WK_RESULT <> 0) THEN
        BEGIN
           WK_FILENAME = WK_DIRECTORY || 'DM2' || WK_DEVICE || WK_DATE_STR ||  '.mnt';
           WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE);
        END
     END

     EXECUTE PROCEDURE UPDATE_TRAN (WK_RECORD, 'T','Processed successfully');
     EXECUTE PROCEDURE TRAN_ARCHIVE;
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_DSDX FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 85 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'DSDX') THEN
  BEGIN
   EXECUTE PROCEDURE PC_DSDX
    NEW.RECORD_ID ,
    NEW.WH_ID,
    NEW.LOCN_ID,
    NEW.OBJECT,
    NEW.TRN_TYPE,
    NEW.TRN_CODE,
    NEW.TRN_DATE,
    NEW.REFERENCE,
    NEW.QTY,
    NEW.PERSON_ID,
    NEW.DEVICE_ID,
    NEW.SUB_LOCN_ID;
   EXECUTE PROCEDURE TRAN_ARCHIVE;
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_PLAD FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 86 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_DEVICE CHAR(2);
DECLARE VARIABLE WK_USER VARCHAR(10);
DECLARE VARIABLE WK_RECORD INTEGER;
DECLARE VARIABLE WK_QTY INTEGER;
DECLARE VARIABLE WK_DATE TIMESTAMP;
DECLARE VARIABLE WK_REF VARCHAR(40);
DECLARE VARIABLE WK_PRINTER VARCHAR(40);
DECLARE VARIABLE WK_LABEL VARCHAR(40);
DECLARE VARIABLE WK_CONSIGNMENT VARCHAR(40);
DECLARE VARIABLE WK_DIRECTORY VARCHAR(80);
DECLARE VARIABLE WK_FILENAME VARCHAR(80);
DECLARE VARIABLE WK_FILENAME_OUT VARCHAR(80);
DECLARE VARIABLE WK_LABEL_LINE VARCHAR(445);
DECLARE VARIABLE WK_RESULT INTEGER;
DECLARE VARIABLE WK_PD_DESPATCH_ID INTEGER;
DECLARE VARIABLE WK_PD_PALLET_QTY INTEGER;
DECLARE VARIABLE WK_PD_CARTON_QTY INTEGER;
DECLARE VARIABLE WK_PD_SATCHEL_QTY INTEGER;
DECLARE VARIABLE WK_PD_ADDRESS_QTY INTEGER;
DECLARE VARIABLE WK_PI_PICK_ORDER VARCHAR(15);
DECLARE VARIABLE WK_PO_CUSTOMER_PO_WO VARCHAR(20);
DECLARE VARIABLE WK_PD_CONSIGNMENT_NO VARCHAR(20);
DECLARE VARIABLE WK_PP_LABEL_NO VARCHAR(40);
DECLARE VARIABLE WK_PO_CONTACT_NAME VARCHAR(50);
DECLARE VARIABLE WK_PI_CONTACT_NAME VARCHAR(50);
DECLARE VARIABLE WK_PN_ADDRESS_LINE1 VARCHAR(100);
DECLARE VARIABLE WK_PN_ADDRESS_LINE2 VARCHAR(50);
DECLARE VARIABLE WK_PN_CITY VARCHAR(25);
DECLARE VARIABLE WK_PN_STATE VARCHAR(15);
DECLARE VARIABLE WK_PN_POST_CODE VARCHAR(10);
DECLARE VARIABLE WK_PN_PHONE_NO VARCHAR(30);
DECLARE VARIABLE WK_PO_SHIP_VIA VARCHAR(10);
DECLARE VARIABLE WK_PI_SHIP_VIA VARCHAR(10);
DECLARE VARIABLE WK_DEPOT VARCHAR(4);
DECLARE VARIABLE WK_PACKTYPE VARCHAR(8);
DECLARE VARIABLE WK_TOTAL_UNITS INTEGER;
DECLARE VARIABLE WK_FILE_TYPE_U INTEGER;
DECLARE VARIABLE WK_FILE_TYPE_V INTEGER;
/*
DECLARE VARIABLE WK_BUFFER VARCHAR(600);
*/

BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'PLAD') THEN
  BEGIN
     WK_DEVICE = NEW.WH_ID;
     WK_USER = NEW.PERSON_ID;
     WK_DATE = NEW.TRN_DATE;
     WK_LABEL = ALLTRIM(NEW.OBJECT);
     WK_REF = ALLTRIM(NEW.REFERENCE);
     EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_REF, 1  RETURNING_VALUES :WK_CONSIGNMENT ; 
     EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_REF, 2  RETURNING_VALUES :WK_PRINTER ; 
     WK_CONSIGNMENT = ALLTRIM(WK_CONSIGNMENT);
     WK_QTY = NEW.QTY;
     WK_RECORD = NEW.RECORD_ID;

     WK_DIRECTORY = '';
     WK_FILE_TYPE_U = 0;
     WK_FILE_TYPE_V = 0;

     /* 
        if WK_LABEL <> ''
        then print/reprint label
        if WK_LABEL = ''
        then print/reprint all on consignment 

         if WK_QTY = 1 
         then reprint label or if WK_LABEL = '' print all on consignment...
         if WK_QTY = 0
         then no reprint just print label or all on consignment
     */
     IF (STRLEN(WK_PRINTER) > 2) THEN
     BEGIN
        WK_PRINTER = UPPER(SUBSTR(WK_PRINTER,2,3));
     END
     ELSE
     BEGIN
        WK_PRINTER = UPPER(WK_PRINTER);
     END
     /* need the directory for this label set */
     SELECT WORKING_DIRECTORY FROM SYS_EQUIP 
         WHERE DEVICE_ID = :WK_PRINTER
         INTO :WK_DIRECTORY;
/*
     WK_BUFFER = 'printer ' || WK_PRINTER || ' consignment ' || wk_consignment || ' directory ' || WK_DIRECTORY || ' qty ' || WK_QTY || ' label ' || WK_LABEL || ']';
     INSERT INTO LOG(DESCRIPTION) VALUES(:WK_BUFFER);
*/
     IF (WK_QTY = 1) THEN
     BEGIN
        /* reprint connote for each label only create file */
        IF (WK_LABEL =  '') THEN
        BEGIN
        /* reprint all labels for connote - only create file */
/* PACK_ID.DESPATCH_LABEL_NO, */
           FOR SELECT PICK_DESPATCH.DESPATCH_ID,
               PICK_DESPATCH.PICKD_PALLET_QTY,
               PICK_DESPATCH.PICKD_CARTON_QTY,
               PICK_DESPATCH.PICKD_SATCHEL_QTY,
               PICK_DESPATCH.PICKD_ADDRESS_QTY,
               PICK_ITEM.PICK_ORDER,
               PICK_ORDER.CUSTOMER_PO_WO,
               PICK_DESPATCH.AWB_CONSIGNMENT_NO,
               MIN(PACK_ID.DESPATCH_LABEL_NO),
               PICK_ORDER.CONTACT_NAME,
               PICK_ITEM.CONTACT_NAME,
               PICK_ORDER.P_ADDRESS_LINE1,
               PICK_ORDER.P_ADDRESS_LINE2,
               PICK_ORDER.P_CITY,
               PICK_ORDER.P_STATE,
               PICK_ORDER.P_POST_CODE,
               PN.PHONE_NO,
               PICK_ORDER.SHIP_VIA,
               PICK_ITEM.SHIP_VIA
               FROM PICK_DESPATCH
               JOIN PACK_ID ON PACK_ID.DESPATCH_ID = PICK_DESPATCH.DESPATCH_ID
               JOIN PICK_ITEM_DETAIL ON PICK_ITEM_DETAIL.DESPATCH_ID = PICK_DESPATCH.DESPATCH_ID
               LEFT OUTER JOIN PICK_ITEM ON PICK_ITEM.PICK_LABEL_NO = PICK_ITEM_DETAIL.PICK_LABEL_NO
               LEFT OUTER JOIN PICK_ORDER ON PICK_ORDER.PICK_ORDER = PICK_ITEM.PICK_ORDER 
               LEFT OUTER JOIN PERSON PN ON PN.PERSON_ID = PICK_ORDER.PERSON_ID
               WHERE PICK_DESPATCH.AWB_CONSIGNMENT_NO = :WK_CONSIGNMENT
               AND PICK_DESPATCH.DESPATCH_STATUS = 'DC'
               AND PICK_DESPATCH.PICKD_ADDRESS_QTY > 0
               GROUP BY PICK_DESPATCH.DESPATCH_ID,
               PICK_DESPATCH.PICKD_PALLET_QTY,
               PICK_DESPATCH.PICKD_CARTON_QTY,
               PICK_DESPATCH.PICKD_SATCHEL_QTY,
               PICK_DESPATCH.PICKD_ADDRESS_QTY,
               PICK_ITEM.PICK_ORDER,
               PICK_ORDER.CUSTOMER_PO_WO,
               PICK_DESPATCH.AWB_CONSIGNMENT_NO,
               PICK_ORDER.CONTACT_NAME,
               PICK_ITEM.CONTACT_NAME,
               PICK_ORDER.P_ADDRESS_LINE1,
               PICK_ORDER.P_ADDRESS_LINE2,
               PICK_ORDER.P_CITY,
               PICK_ORDER.P_STATE,
               PICK_ORDER.P_POST_CODE,
               PN.PHONE_NO,
               PICK_ORDER.SHIP_VIA,
               PICK_ITEM.SHIP_VIA
               INTO :WK_PD_DESPATCH_ID,
                    :WK_PD_PALLET_QTY,
                    :WK_PD_CARTON_QTY,
                    :WK_PD_SATCHEL_QTY,
                    :WK_PD_ADDRESS_QTY,
                    :WK_PI_PICK_ORDER,
                    :WK_PO_CUSTOMER_PO_WO,
                    :WK_PD_CONSIGNMENT_NO,
                    :WK_PP_LABEL_NO,
                    :WK_PO_CONTACT_NAME,
                    :WK_PI_CONTACT_NAME,
                    :WK_PN_ADDRESS_LINE1,
                    :WK_PN_ADDRESS_LINE2,
                    :WK_PN_CITY,
                    :WK_PN_STATE,
                    :WK_PN_POST_CODE,
                    :WK_PN_PHONE_NO,
                    :WK_PO_SHIP_VIA,
                    :WK_PI_SHIP_VIA
           DO
           BEGIN
              WK_DEPOT = '';
              SELECT DEPOT
                 FROM STARTRACK_DEPOT
                 WHERE POST_CODE = :WK_PN_POST_CODE
                 AND   LOCATION = :WK_PN_CITY
                 INTO :WK_DEPOT;
              IF (WK_DEPOT IS NULL) THEN
              BEGIN
                 WK_DEPOT = '';
              END
              WK_PACKTYPE = '';
              IF (WK_PD_PALLET_QTY > 0) THEN
              BEGIN
                 WK_PACKTYPE = 'Pallets';
              END
              IF (WK_PD_SATCHEL_QTY > 0) THEN
              BEGIN
                 IF (WK_PACKTYPE > '') THEN
                 BEGIN
                    WK_PACKTYPE = 'Mixed';
                 END
                 ELSE
                 BEGIN
                    WK_PACKTYPE = 'Satchels';
                 END
              END
              IF (WK_PD_CARTON_QTY > 0) THEN
              BEGIN
                 IF (WK_PACKTYPE > '') THEN
                 BEGIN
                    WK_PACKTYPE = 'Mixed';
                 END
                 ELSE
                 BEGIN
                    WK_PACKTYPE = 'Cartons';
                 END
              END
              WK_TOTAL_UNITS = WK_PD_PALLET_QTY + WK_PD_CARTON_QTY + WK_PD_SATCHEL_QTY;
              IF (WK_PI_CONTACT_NAME IS NULL) THEN
              BEGIN
                 WK_PI_CONTACT_NAME = WK_PO_CONTACT_NAME;
              END
              IF (WK_PI_SHIP_VIA IS NULL) THEN
              BEGIN
                 WK_PI_SHIP_VIA = WK_PO_SHIP_VIA;
              END
              IF (WK_PO_CUSTOMER_PO_WO IS NULL) THEN
              BEGIN
                 WK_PO_CUSTOMER_PO_WO = '';
              END
              IF (WK_PI_CONTACT_NAME IS NULL) THEN
              BEGIN
                 WK_PI_CONTACT_NAME = '';
              END
              IF (WK_PI_SHIP_VIA IS NULL) THEN
              BEGIN
                 WK_PI_SHIP_VIA = '';
              END
              IF (WK_PN_ADDRESS_LINE1 IS NULL) THEN
              BEGIN
                 WK_PN_ADDRESS_LINE1 = '';
              END
              IF (WK_PN_ADDRESS_LINE2 IS NULL) THEN
              BEGIN
                 WK_PN_ADDRESS_LINE2 = '';
              END
              IF (WK_PN_CITY IS NULL) THEN
              BEGIN
                 WK_PN_CITY = '';
              END
              IF (WK_PN_STATE IS NULL) THEN
              BEGIN
                 WK_PN_STATE = '';
              END
              IF (WK_PN_POST_CODE IS NULL) THEN
              BEGIN
                 WK_PN_POST_CODE = '';
              END
              IF (WK_PN_PHONE_NO IS NULL) THEN
              BEGIN
                 WK_PN_PHONE_NO = '';
              END
              WK_FILENAME = WK_DIRECTORY || 'Address.uxt';
/*
              INSERT INTO LOG(DESCRIPTION) VALUES(:WK_FILENAME);
*/
              WK_LABEL_LINE = '"' || WK_PI_PICK_ORDER || '","' ||
                      WK_PO_CUSTOMER_PO_WO || '","' ||
                      WK_CONSIGNMENT || '","' ||
                      WK_PP_LABEL_NO || '","' ||
                      WK_PI_CONTACT_NAME || '","' ||
                      WK_PN_ADDRESS_LINE1 || '","' ||
                      WK_PN_ADDRESS_LINE2 || '","' ||
                      WK_PN_CITY || '","' ||
                      WK_PN_STATE || '","' ||
                      WK_PN_POST_CODE || '","' ||
                      WK_PN_PHONE_NO || '","' ||
                      WK_DEPOT || '",' ||
                      WK_TOTAL_UNITS || ',' ||
                      1 || ',' ||
                      WK_PD_ADDRESS_QTY || ',"' ||
                      WK_PACKTYPE || '","' ||
                      WK_PI_SHIP_VIA || '","' ||
                      SUBSTR(WK_PRINTER,2,2) || '"' ||
                      CHR(13) || CHR(10);
/*
              INSERT INTO LOG(DESCRIPTION) VALUES(:WK_LABEL_LINE);
*/
              WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE);
              IF (WK_RESULT = 0) THEN
              BEGIN
                 WK_FILE_TYPE_U = 1;
              END
              IF (WK_RESULT <> 0) THEN
              BEGIN
                 WK_FILENAME = WK_DIRECTORY || 'Address.vxt';
                 WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE);
                 WK_FILE_TYPE_V = 1;
              END
           END
        END
        ELSE
        BEGIN
        /* reprint one label for connote - only create file */
           FOR SELECT PICK_DESPATCH.DESPATCH_ID,
               PICK_DESPATCH.PICKD_PALLET_QTY,
               PICK_DESPATCH.PICKD_CARTON_QTY,
               PICK_DESPATCH.PICKD_SATCHEL_QTY,
               PICK_DESPATCH.PICKD_ADDRESS_QTY,
               PICK_ITEM.PICK_ORDER,
               PICK_ORDER.CUSTOMER_PO_WO,
               PICK_DESPATCH.AWB_CONSIGNMENT_NO,
               PACK_ID.DESPATCH_LABEL_NO,
               PICK_ORDER.CONTACT_NAME,
               PICK_ITEM.CONTACT_NAME,
               PICK_ORDER.P_ADDRESS_LINE1,
               PICK_ORDER.P_ADDRESS_LINE2,
               PICK_ORDER.P_CITY,
               PICK_ORDER.P_STATE,
               PICK_ORDER.P_POST_CODE,
               PN.PHONE_NO,
               PICK_ORDER.SHIP_VIA,
               PICK_ITEM.SHIP_VIA
               FROM PICK_DESPATCH
               JOIN PACK_ID ON PACK_ID.DESPATCH_ID = PICK_DESPATCH.DESPATCH_ID
               JOIN PICK_ITEM_DETAIL ON PICK_ITEM_DETAIL.DESPATCH_ID = PICK_DESPATCH.DESPATCH_ID
               LEFT OUTER JOIN PICK_ITEM ON PICK_ITEM.PICK_LABEL_NO = PICK_ITEM_DETAIL.PICK_LABEL_NO
               LEFT OUTER JOIN PICK_ORDER ON PICK_ORDER.PICK_ORDER = PICK_ITEM.PICK_ORDER 
               LEFT OUTER JOIN PERSON PN ON PN.PERSON_ID = PICK_ORDER.PERSON_ID
               WHERE PICK_DESPATCH.AWB_CONSIGNMENT_NO = :WK_CONSIGNMENT
               AND PICK_DESPATCH.DESPATCH_STATUS = 'DC'
               AND PACK_ID.DESPATCH_LABEL_NO = :WK_LABEL
               GROUP BY PICK_DESPATCH.DESPATCH_ID,
               PICK_DESPATCH.PICKD_PALLET_QTY,
               PICK_DESPATCH.PICKD_CARTON_QTY,
               PICK_DESPATCH.PICKD_SATCHEL_QTY,
               PICK_DESPATCH.PICKD_ADDRESS_QTY,
               PICK_ITEM.PICK_ORDER,
               PICK_ORDER.CUSTOMER_PO_WO,
               PICK_DESPATCH.AWB_CONSIGNMENT_NO,
               PACK_ID.DESPATCH_LABEL_NO,
               PICK_ORDER.CONTACT_NAME,
               PICK_ITEM.CONTACT_NAME,
               PICK_ORDER.P_ADDRESS_LINE1,
               PICK_ORDER.P_ADDRESS_LINE2,
               PICK_ORDER.P_CITY,
               PICK_ORDER.P_STATE,
               PICK_ORDER.P_POST_CODE,
               PN.PHONE_NO,
               PICK_ORDER.SHIP_VIA,
               PICK_ITEM.SHIP_VIA
               INTO :WK_PD_DESPATCH_ID,
                    :WK_PD_PALLET_QTY,
                    :WK_PD_CARTON_QTY,
                    :WK_PD_SATCHEL_QTY,
                    :WK_PD_ADDRESS_QTY,
                    :WK_PI_PICK_ORDER,
                    :WK_PO_CUSTOMER_PO_WO,
                    :WK_PD_CONSIGNMENT_NO,
                    :WK_PP_LABEL_NO,
                    :WK_PO_CONTACT_NAME,
                    :WK_PI_CONTACT_NAME,
                    :WK_PN_ADDRESS_LINE1,
                    :WK_PN_ADDRESS_LINE2,
                    :WK_PN_CITY,
                    :WK_PN_STATE,
                    :WK_PN_POST_CODE,
                    :WK_PN_PHONE_NO,
                    :WK_PO_SHIP_VIA,
                    :WK_PI_SHIP_VIA
           DO
           BEGIN
              WK_DEPOT = '';
              SELECT DEPOT
                 FROM STARTRACK_DEPOT
                 WHERE POST_CODE = :WK_PN_POST_CODE
                 AND   LOCATION = :WK_PN_CITY
                 INTO :WK_DEPOT;
              IF (WK_DEPOT IS NULL) THEN
              BEGIN
                 WK_DEPOT = '';
              END
              WK_PACKTYPE = '';
              IF (WK_PD_PALLET_QTY > 0) THEN
              BEGIN
                 WK_PACKTYPE = 'Pallets';
              END
              IF (WK_PD_SATCHEL_QTY > 0) THEN
              BEGIN
                 IF (WK_PACKTYPE > '') THEN
                 BEGIN
                    WK_PACKTYPE = 'Mixed';
                 END
                 ELSE
                 BEGIN
                    WK_PACKTYPE = 'Satchels';
                 END
              END
              IF (WK_PD_CARTON_QTY > 0) THEN
              BEGIN
                 IF (WK_PACKTYPE > '') THEN
                 BEGIN
                    WK_PACKTYPE = 'Mixed';
                 END
                 ELSE
                 BEGIN
                    WK_PACKTYPE = 'Cartons';
                 END
              END
              WK_TOTAL_UNITS = WK_PD_PALLET_QTY + WK_PD_CARTON_QTY + WK_PD_SATCHEL_QTY;
              IF (WK_PI_CONTACT_NAME IS NULL) THEN
              BEGIN
                 WK_PI_CONTACT_NAME = WK_PO_CONTACT_NAME;
              END
              IF (WK_PI_SHIP_VIA IS NULL) THEN
              BEGIN
                 WK_PI_SHIP_VIA = WK_PO_SHIP_VIA;
              END
              IF (WK_PO_CUSTOMER_PO_WO IS NULL) THEN
              BEGIN
                 WK_PO_CUSTOMER_PO_WO = '';
              END
              IF (WK_PI_CONTACT_NAME IS NULL) THEN
              BEGIN
                 WK_PI_CONTACT_NAME = '';
              END
              IF (WK_PI_SHIP_VIA IS NULL) THEN
              BEGIN
                 WK_PI_SHIP_VIA = '';
              END
              IF (WK_PN_ADDRESS_LINE1 IS NULL) THEN
              BEGIN
                 WK_PN_ADDRESS_LINE1 = '';
              END
              IF (WK_PN_ADDRESS_LINE2 IS NULL) THEN
              BEGIN
                 WK_PN_ADDRESS_LINE2 = '';
              END
              IF (WK_PN_CITY IS NULL) THEN
              BEGIN
                 WK_PN_CITY = '';
              END
              IF (WK_PN_STATE IS NULL) THEN
              BEGIN
                 WK_PN_STATE = '';
              END
              IF (WK_PN_POST_CODE IS NULL) THEN
              BEGIN
                 WK_PN_POST_CODE = '';
              END
              IF (WK_PN_PHONE_NO IS NULL) THEN
              BEGIN
                 WK_PN_PHONE_NO = '';
              END
              WK_FILENAME = WK_DIRECTORY || 'Address.uxt';
              WK_LABEL_LINE = '"' || WK_PI_PICK_ORDER || '","' ||
                      WK_PO_CUSTOMER_PO_WO || '","' ||
                      WK_CONSIGNMENT || '","' ||
                      WK_PP_LABEL_NO || '","' ||
                      WK_PI_CONTACT_NAME || '","' ||
                      WK_PN_ADDRESS_LINE1 || '","' ||
                      WK_PN_ADDRESS_LINE2 || '","' ||
                      WK_PN_CITY || '","' ||
                      WK_PN_STATE || '","' ||
                      WK_PN_POST_CODE || '","' ||
                      WK_PN_PHONE_NO || '","' ||
                      WK_DEPOT || '",' ||
                      WK_TOTAL_UNITS || ',' ||
                      1 || ',' ||
                      1 || ',"' ||
                      WK_PACKTYPE || '","' ||
                      WK_PI_SHIP_VIA || '","' ||
                      SUBSTR(WK_PRINTER,2,2) || '"' ||
                      CHR(13) || CHR(10);
              WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE);
              IF (WK_RESULT = 0) THEN
              BEGIN
                 WK_FILE_TYPE_U = 1;
              END
              IF (WK_RESULT <> 0) THEN
              BEGIN
                 WK_FILENAME = WK_DIRECTORY || 'Address.vxt';
                 WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE);
                 WK_FILE_TYPE_V = 1;
              END
           END
        END
     END
     ELSE
     BEGIN
        /* no reprint so for each label must also update item */
        IF (WK_LABEL =  '') THEN
        BEGIN
/* PACK_ID.DESPATCH_LABEL_NO, */
           FOR SELECT PICK_DESPATCH.DESPATCH_ID,
               PICK_DESPATCH.PICKD_PALLET_QTY,
               PICK_DESPATCH.PICKD_CARTON_QTY,
               PICK_DESPATCH.PICKD_SATCHEL_QTY,
               PICK_DESPATCH.PICKD_ADDRESS_QTY,
               PICK_ITEM.PICK_ORDER,
               PICK_ORDER.CUSTOMER_PO_WO,
               PICK_DESPATCH.AWB_CONSIGNMENT_NO,
               MIN(PACK_ID.DESPATCH_LABEL_NO),
               PICK_ORDER.CONTACT_NAME,
               PICK_ITEM.CONTACT_NAME,
               PICK_ORDER.P_ADDRESS_LINE1,
               PICK_ORDER.P_ADDRESS_LINE2,
               PICK_ORDER.P_CITY,
               PICK_ORDER.P_STATE,
               PICK_ORDER.P_POST_CODE,
               PN.PHONE_NO,
               PICK_ORDER.SHIP_VIA,
               PICK_ITEM.SHIP_VIA
               FROM PICK_DESPATCH
               JOIN PACK_ID ON PACK_ID.DESPATCH_ID = PICK_DESPATCH.DESPATCH_ID
               JOIN PICK_ITEM_DETAIL ON PICK_ITEM_DETAIL.DESPATCH_ID = PICK_DESPATCH.DESPATCH_ID
               LEFT OUTER JOIN PICK_ITEM ON PICK_ITEM.PICK_LABEL_NO = PICK_ITEM_DETAIL.PICK_LABEL_NO
               LEFT OUTER JOIN PICK_ORDER ON PICK_ORDER.PICK_ORDER = PICK_ITEM.PICK_ORDER 
               LEFT OUTER JOIN PERSON PN ON PN.PERSON_ID = PICK_ORDER.PERSON_ID
               WHERE PICK_DESPATCH.AWB_CONSIGNMENT_NO = :WK_CONSIGNMENT
               AND PICK_DESPATCH.DESPATCH_STATUS = 'DC'
               AND PICK_DESPATCH.PICKD_ADDRESS_QTY > 0
               AND PACK_ID.LABEL_PRINTED_DATE IS NULL
               GROUP BY PICK_DESPATCH.DESPATCH_ID,
               PICK_DESPATCH.PICKD_PALLET_QTY,
               PICK_DESPATCH.PICKD_CARTON_QTY,
               PICK_DESPATCH.PICKD_SATCHEL_QTY,
               PICK_DESPATCH.PICKD_ADDRESS_QTY,
               PICK_ITEM.PICK_ORDER,
               PICK_ORDER.CUSTOMER_PO_WO,
               PICK_DESPATCH.AWB_CONSIGNMENT_NO,
               PICK_ORDER.CONTACT_NAME,
               PICK_ITEM.CONTACT_NAME,
               PICK_ORDER.P_ADDRESS_LINE1,
               PICK_ORDER.P_ADDRESS_LINE2,
               PICK_ORDER.P_CITY,
               PICK_ORDER.P_STATE,
               PICK_ORDER.P_POST_CODE,
               PN.PHONE_NO,
               PICK_ORDER.SHIP_VIA,
               PICK_ITEM.SHIP_VIA
               INTO :WK_PD_DESPATCH_ID,
                    :WK_PD_PALLET_QTY,
                    :WK_PD_CARTON_QTY,
                    :WK_PD_SATCHEL_QTY,
                    :WK_PD_ADDRESS_QTY,
                    :WK_PI_PICK_ORDER,
                    :WK_PO_CUSTOMER_PO_WO,
                    :WK_PD_CONSIGNMENT_NO,
                    :WK_PP_LABEL_NO,
                    :WK_PO_CONTACT_NAME,
                    :WK_PI_CONTACT_NAME,
                    :WK_PN_ADDRESS_LINE1,
                    :WK_PN_ADDRESS_LINE2,
                    :WK_PN_CITY,
                    :WK_PN_STATE,
                    :WK_PN_POST_CODE,
                    :WK_PN_PHONE_NO,
                    :WK_PO_SHIP_VIA,
                    :WK_PI_SHIP_VIA
           DO
           BEGIN
              WK_DEPOT = '';
              SELECT DEPOT
                 FROM STARTRACK_DEPOT
                 WHERE POST_CODE = :WK_PN_POST_CODE
                 AND   LOCATION = :WK_PN_CITY
                 INTO :WK_DEPOT;
              IF (WK_DEPOT IS NULL) THEN
              BEGIN
                 WK_DEPOT = '';
              END
              WK_PACKTYPE = '';
              IF (WK_PD_PALLET_QTY > 0) THEN
              BEGIN
                 WK_PACKTYPE = 'Pallets';
              END
              IF (WK_PD_SATCHEL_QTY > 0) THEN
              BEGIN
                 IF (WK_PACKTYPE > '') THEN
                 BEGIN
                    WK_PACKTYPE = 'Mixed';
                 END
                 ELSE
                 BEGIN
                    WK_PACKTYPE = 'Satchels';
                 END
              END
              IF (WK_PD_CARTON_QTY > 0) THEN
              BEGIN
                 IF (WK_PACKTYPE > '') THEN
                 BEGIN
                    WK_PACKTYPE = 'Mixed';
                 END
                 ELSE
                 BEGIN
                    WK_PACKTYPE = 'Cartons';
                 END
              END
              WK_TOTAL_UNITS = WK_PD_PALLET_QTY + WK_PD_CARTON_QTY + WK_PD_SATCHEL_QTY;
              IF (WK_PI_CONTACT_NAME IS NULL) THEN
              BEGIN
                 WK_PI_CONTACT_NAME = WK_PO_CONTACT_NAME;
              END
              IF (WK_PI_SHIP_VIA IS NULL) THEN
              BEGIN
                 WK_PI_SHIP_VIA = WK_PO_SHIP_VIA;
              END
              IF (WK_PO_CUSTOMER_PO_WO IS NULL) THEN
              BEGIN
                 WK_PO_CUSTOMER_PO_WO = '';
              END
              IF (WK_PI_CONTACT_NAME IS NULL) THEN
              BEGIN
                 WK_PI_CONTACT_NAME = '';
              END
              IF (WK_PI_SHIP_VIA IS NULL) THEN
              BEGIN
                 WK_PI_SHIP_VIA = '';
              END
              IF (WK_PN_ADDRESS_LINE1 IS NULL) THEN
              BEGIN
                 WK_PN_ADDRESS_LINE1 = '';
              END
              IF (WK_PN_ADDRESS_LINE2 IS NULL) THEN
              BEGIN
                 WK_PN_ADDRESS_LINE2 = '';
              END
              IF (WK_PN_CITY IS NULL) THEN
              BEGIN
                 WK_PN_CITY = '';
              END
              IF (WK_PN_STATE IS NULL) THEN
              BEGIN
                 WK_PN_STATE = '';
              END
              IF (WK_PN_POST_CODE IS NULL) THEN
              BEGIN
                 WK_PN_POST_CODE = '';
              END
              IF (WK_PN_PHONE_NO IS NULL) THEN
              BEGIN
                 WK_PN_PHONE_NO = '';
              END
              WK_FILENAME = WK_DIRECTORY || 'Address.uxt';
              WK_LABEL_LINE = '"' || WK_PI_PICK_ORDER || '","' ||
                      WK_PO_CUSTOMER_PO_WO || '","' ||
                      WK_CONSIGNMENT || '","' ||
                      WK_PP_LABEL_NO || '","' ||
                      WK_PI_CONTACT_NAME || '","' ||
                      WK_PN_ADDRESS_LINE1 || '","' ||
                      WK_PN_ADDRESS_LINE2 || '","' ||
                      WK_PN_CITY || '","' ||
                      WK_PN_STATE || '","' ||
                      WK_PN_POST_CODE || '","' ||
                      WK_PN_PHONE_NO || '","' ||
                      WK_DEPOT || '",' ||
                      WK_TOTAL_UNITS || ',' ||
                      1 || ',' ||
                      WK_PD_ADDRESS_QTY || ',"' ||
                      WK_PACKTYPE || '","' ||
                      WK_PI_SHIP_VIA || '","' ||
                      SUBSTR(WK_PRINTER,2,2) || '"' ||
                      CHR(13) || CHR(10);
              WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE);
              IF (WK_RESULT = 0) THEN
              BEGIN
                 WK_FILE_TYPE_U = 1;
              END
              IF (WK_RESULT <> 0) THEN
              BEGIN
                 WK_FILENAME = WK_DIRECTORY || 'Address.vxt';
                 WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE);
                 WK_FILE_TYPE_V = 1;
              END
              UPDATE PACK_ID SET LABEL_PRINTED_DATE = "NOW" 
              WHERE DESPATCH_ID = :WK_PD_DESPATCH_ID
              AND DESPATCH_LABEL_NO = :WK_PP_LABEL_NO;
           END
        END
        ELSE
        BEGIN
        /* print one label for connote  */
           FOR SELECT PICK_DESPATCH.DESPATCH_ID,
               PICK_DESPATCH.PICKD_PALLET_QTY,
               PICK_DESPATCH.PICKD_CARTON_QTY,
               PICK_DESPATCH.PICKD_SATCHEL_QTY,
               PICK_DESPATCH.PICKD_ADDRESS_QTY,
               PICK_ITEM.PICK_ORDER,
               PICK_ORDER.CUSTOMER_PO_WO,
               PICK_DESPATCH.AWB_CONSIGNMENT_NO,
               PACK_ID.DESPATCH_LABEL_NO,
               PICK_ORDER.CONTACT_NAME,
               PICK_ITEM.CONTACT_NAME,
               PICK_ORDER.P_ADDRESS_LINE1,
               PICK_ORDER.P_ADDRESS_LINE2,
               PICK_ORDER.P_CITY,
               PICK_ORDER.P_STATE,
               PICK_ORDER.P_POST_CODE,
               PN.PHONE_NO,
               PICK_ORDER.SHIP_VIA,
               PICK_ITEM.SHIP_VIA
               FROM PICK_DESPATCH
               JOIN PACK_ID ON PACK_ID.DESPATCH_ID = PICK_DESPATCH.DESPATCH_ID
               JOIN PICK_ITEM_DETAIL ON PICK_ITEM_DETAIL.DESPATCH_ID = PICK_DESPATCH.DESPATCH_ID
               LEFT OUTER JOIN PICK_ITEM ON PICK_ITEM.PICK_LABEL_NO = PICK_ITEM_DETAIL.PICK_LABEL_NO
               LEFT OUTER JOIN PICK_ORDER ON PICK_ORDER.PICK_ORDER = PICK_ITEM.PICK_ORDER 
               LEFT OUTER JOIN PERSON PN ON PN.PERSON_ID = PICK_ORDER.PERSON_ID
               WHERE PICK_DESPATCH.AWB_CONSIGNMENT_NO = :WK_CONSIGNMENT
               AND PICK_DESPATCH.DESPATCH_STATUS = 'DC'
               AND PACK_ID.DESPATCH_LABEL_NO = :WK_LABEL
               AND PACK_ID.LABEL_PRINTED_DATE IS NULL
               GROUP BY PICK_DESPATCH.DESPATCH_ID,
               PICK_DESPATCH.PICKD_PALLET_QTY,
               PICK_DESPATCH.PICKD_CARTON_QTY,
               PICK_DESPATCH.PICKD_SATCHEL_QTY,
               PICK_DESPATCH.PICKD_ADDRESS_QTY,
               PICK_ITEM.PICK_ORDER,
               PICK_ORDER.CUSTOMER_PO_WO,
               PICK_DESPATCH.AWB_CONSIGNMENT_NO,
               PACK_ID.DESPATCH_LABEL_NO,
               PICK_ORDER.CONTACT_NAME,
               PICK_ITEM.CONTACT_NAME,
               PICK_ORDER.P_ADDRESS_LINE1,
               PICK_ORDER.P_ADDRESS_LINE2,
               PICK_ORDER.P_CITY,
               PICK_ORDER.P_STATE,
               PICK_ORDER.P_POST_CODE,
               PN.PHONE_NO,
               PICK_ORDER.SHIP_VIA,
               PICK_ITEM.SHIP_VIA
               INTO :WK_PD_DESPATCH_ID,
                    :WK_PD_PALLET_QTY,
                    :WK_PD_CARTON_QTY,
                    :WK_PD_SATCHEL_QTY,
                    :WK_PD_ADDRESS_QTY,
                    :WK_PI_PICK_ORDER,
                    :WK_PO_CUSTOMER_PO_WO,
                    :WK_PD_CONSIGNMENT_NO,
                    :WK_PP_LABEL_NO,
                    :WK_PO_CONTACT_NAME,
                    :WK_PI_CONTACT_NAME,
                    :WK_PN_ADDRESS_LINE1,
                    :WK_PN_ADDRESS_LINE2,
                    :WK_PN_CITY,
                    :WK_PN_STATE,
                    :WK_PN_POST_CODE,
                    :WK_PN_PHONE_NO,
                    :WK_PO_SHIP_VIA,
                    :WK_PI_SHIP_VIA
           DO
           BEGIN
              WK_DEPOT = '';
              SELECT DEPOT
                 FROM STARTRACK_DEPOT
                 WHERE POST_CODE = :WK_PN_POST_CODE
                 AND   LOCATION = :WK_PN_CITY
                 INTO :WK_DEPOT;
              IF (WK_DEPOT IS NULL) THEN
              BEGIN
                 WK_DEPOT = '';
              END
              WK_PACKTYPE = '';
              IF (WK_PD_PALLET_QTY > 0) THEN
              BEGIN
                 WK_PACKTYPE = 'Pallets';
              END
              IF (WK_PD_SATCHEL_QTY > 0) THEN
              BEGIN
                 IF (WK_PACKTYPE > '') THEN
                 BEGIN
                    WK_PACKTYPE = 'Mixed';
                 END
                 ELSE
                 BEGIN
                    WK_PACKTYPE = 'Satchels';
                 END
              END
              IF (WK_PD_CARTON_QTY > 0) THEN
              BEGIN
                 IF (WK_PACKTYPE > '') THEN
                 BEGIN
                    WK_PACKTYPE = 'Mixed';
                 END
                 ELSE
                 BEGIN
                    WK_PACKTYPE = 'Cartons';
                 END
              END
              WK_TOTAL_UNITS = WK_PD_PALLET_QTY + WK_PD_CARTON_QTY + WK_PD_SATCHEL_QTY;
              IF (WK_PI_CONTACT_NAME IS NULL) THEN
              BEGIN
                 WK_PI_CONTACT_NAME = WK_PO_CONTACT_NAME;
              END
              IF (WK_PI_SHIP_VIA IS NULL) THEN
              BEGIN
                 WK_PI_SHIP_VIA = WK_PO_SHIP_VIA;
              END
              IF (WK_PO_CUSTOMER_PO_WO IS NULL) THEN
              BEGIN
                 WK_PO_CUSTOMER_PO_WO = '';
              END
              IF (WK_PI_CONTACT_NAME IS NULL) THEN
              BEGIN
                 WK_PI_CONTACT_NAME = '';
              END
              IF (WK_PI_SHIP_VIA IS NULL) THEN
              BEGIN
                 WK_PI_SHIP_VIA = '';
              END
              IF (WK_PN_ADDRESS_LINE1 IS NULL) THEN
              BEGIN
                 WK_PN_ADDRESS_LINE1 = '';
              END
              IF (WK_PN_ADDRESS_LINE2 IS NULL) THEN
              BEGIN
                 WK_PN_ADDRESS_LINE2 = '';
              END
              IF (WK_PN_CITY IS NULL) THEN
              BEGIN
                 WK_PN_CITY = '';
              END
              IF (WK_PN_STATE IS NULL) THEN
              BEGIN
                 WK_PN_STATE = '';
              END
              IF (WK_PN_POST_CODE IS NULL) THEN
              BEGIN
                 WK_PN_POST_CODE = '';
              END
              IF (WK_PN_PHONE_NO IS NULL) THEN
              BEGIN
                 WK_PN_PHONE_NO = '';
              END
              WK_FILENAME = WK_DIRECTORY || 'Address.uxt';
              WK_LABEL_LINE = '"' || WK_PI_PICK_ORDER || '","' ||
                      WK_PO_CUSTOMER_PO_WO || '","' ||
                      WK_CONSIGNMENT || '","' ||
                      WK_PP_LABEL_NO || '","' ||
                      WK_PI_CONTACT_NAME || '","' ||
                      WK_PN_ADDRESS_LINE1 || '","' ||
                      WK_PN_ADDRESS_LINE2 || '","' ||
                      WK_PN_CITY || '","' ||
                      WK_PN_STATE || '","' ||
                      WK_PN_POST_CODE || '","' ||
                      WK_PN_PHONE_NO || '","' ||
                      WK_DEPOT || '",' ||
                      WK_TOTAL_UNITS || ',' ||
                      1 || ',' ||
                      1 || ',"' ||
                      WK_PACKTYPE || '","' ||
                      WK_PI_SHIP_VIA || '","' ||
                      SUBSTR(WK_PRINTER,2,2) || '"' ||
                      CHR(13) || CHR(10);
              WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE);
              IF (WK_RESULT = 0) THEN
              BEGIN
                 WK_FILE_TYPE_U = 1;
              END
              IF (WK_RESULT <> 0) THEN
              BEGIN
                 WK_FILENAME = WK_DIRECTORY || 'Address.vxt';
                 WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE);
                 WK_FILE_TYPE_V = 1;
              END
              UPDATE PACK_ID SET LABEL_PRINTED_DATE = "NOW" 
              WHERE DESPATCH_ID = :WK_PD_DESPATCH_ID
              AND DESPATCH_LABEL_NO = :WK_PP_LABEL_NO;
           END
        END
     END
     IF (WK_FILE_TYPE_U = 1) THEN
     BEGIN
        WK_FILENAME = WK_DIRECTORY || 'Address.uxt';
        WK_FILENAME_OUT = WK_DIRECTORY || 'Address.txt';
        WK_RESULT = FILE_RENAME(WK_FILENAME, WK_FILENAME_OUT);
     END
     IF (WK_FILE_TYPE_V = 1) THEN
     BEGIN
        WK_FILENAME = WK_DIRECTORY || 'Address.vxt';
        WK_FILENAME_OUT = WK_DIRECTORY || 'Address.txt';
        WK_RESULT = FILE_RENAME(WK_FILENAME, WK_FILENAME_OUT);
     END
   EXECUTE PROCEDURE UPDATE_TRAN (WK_RECORD, 'T','Processed successfully');
   EXECUTE PROCEDURE TRAN_ARCHIVE;
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_PLAO FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 87 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_DEVICE CHAR(2);
DECLARE VARIABLE WK_CLASS CHAR(1);
DECLARE VARIABLE WK_USER VARCHAR(10);
DECLARE VARIABLE WK_RECORD INTEGER;
DECLARE VARIABLE WK_QTY INTEGER;
DECLARE VARIABLE WK_DATE TIMESTAMP;
DECLARE VARIABLE WK_REF VARCHAR(40);
DECLARE VARIABLE WK_PRINTER VARCHAR(40);
DECLARE VARIABLE WK_OBJECT VARCHAR(30);
DECLARE VARIABLE WK_CONSIGNMENT VARCHAR(40);
DECLARE VARIABLE WK_DIRECTORY VARCHAR(80);
DECLARE VARIABLE WK_FILENAME VARCHAR(80);
DECLARE VARIABLE WK_FILENAME_OUT VARCHAR(80);
DECLARE VARIABLE WK_LABEL_LINE VARCHAR(875);
DECLARE VARIABLE WK_RESULT INTEGER;
DECLARE VARIABLE WK_WH_ID CHAR(2);
DECLARE VARIABLE WK_LOCN_ID VARCHAR(10);
DECLARE VARIABLE WK_SUB_LOCN VARCHAR(10);
DECLARE VARIABLE WK_PERSON VARCHAR(15);
DECLARE VARIABLE WK_LINE1 VARCHAR(40);
DECLARE VARIABLE WK_LINE2 VARCHAR(40);
DECLARE VARIABLE WK_FILE_TYPE_U INTEGER;
DECLARE VARIABLE WK_FILE_TYPE_V INTEGER;
DECLARE VARIABLE WK_CONTACT_FIRST_NAME VARCHAR(50);
DECLARE VARIABLE WK_CONTACT_LAST_NAME VARCHAR(50);
DECLARE VARIABLE WK_ADDRESS_LINE1 VARCHAR(100);
DECLARE VARIABLE WK_ADDRESS_LINE2 VARCHAR(50);
DECLARE VARIABLE WK_ADDRESS_LINE3 VARCHAR(50);
DECLARE VARIABLE WK_ADDRESS_LINE4 VARCHAR(50);
DECLARE VARIABLE WK_ADDRESS_LINE5 VARCHAR(50);
DECLARE VARIABLE WK_TITLE VARCHAR(10);
DECLARE VARIABLE WK_4STATE VARCHAR(255);
DECLARE VARIABLE WK_CITY VARCHAR(25);
DECLARE VARIABLE WK_STATE VARCHAR(15);
DECLARE VARIABLE WK_COUNTRY VARCHAR(25);
DECLARE VARIABLE WK_POST_CODE VARCHAR(10);
DECLARE VARIABLE WK_PHONE_NO VARCHAR(30);
DECLARE VARIABLE WK_MAIL_ADDRESS_LINE1 VARCHAR(50);
DECLARE VARIABLE WK_MAIL_ADDRESS_LINE2 VARCHAR(50);
DECLARE VARIABLE WK_MAIL_CITY VARCHAR(25);
DECLARE VARIABLE WK_MAIL_STATE VARCHAR(15);
DECLARE VARIABLE WK_MAIL_COUNTRY VARCHAR(25);
DECLARE VARIABLE WK_MAIL_POST_CODE VARCHAR(10);
DECLARE VARIABLE WK_CONTACT_PHONE_NO VARCHAR(30);
DECLARE VARIABLE WK_COMPANY VARCHAR(20);
DECLARE VARIABLE WK_FILE_PREFIX VARCHAR(40);
DECLARE VARIABLE WK_EXPORT_CATEGORY CHAR(1);
DECLARE VARIABLE WK_DUMMY_CATEGORY CHAR(1);
DECLARE VARIABLE WK_DO_EXPORT VARCHAR(40);
DECLARE VARIABLE WK_DO_QUEUE CHAR(1);
DECLARE VARIABLE WK_DO_DSDX VARCHAR(40);
DECLARE VARIABLE WK_ZONE CHAR(2);
DECLARE VARIABLE WK_CON_DEVICE CHAR(2);
/*
DECLARE VARIABLE WK_BUFFER VARCHAR(600);
*/

BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'PLAO') THEN
  BEGIN
     /* WK_DEVICE = NEW.WH_ID; */
     WK_DEVICE = NEW.DEVICE_ID;
     WK_USER = NEW.PERSON_ID;
     WK_DATE = NEW.TRN_DATE;
     WK_OBJECT = ALLTRIM(NEW.OBJECT);
     WK_REF = ALLTRIM(NEW.REFERENCE);
     WK_WH_ID = NEW.WH_ID;
     WK_LOCN_ID = NEW.LOCN_ID;
     WK_SUB_LOCN = NEW.SUB_LOCN_ID;
     WK_PERSON = SUBSTR(WK_OBJECT,1,10);
     WK_LINE1 = SUBSTR(WK_OBJECT,11,30) || WK_WH_ID || WK_LOCN_ID || WK_SUB_LOCN;
     EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_REF, 1  RETURNING_VALUES :WK_LINE2 ; 
     EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_REF, 2  RETURNING_VALUES :WK_PRINTER ; 
     WK_LINE2 = ALLTRIM(WK_LINE2);
     IF (SUBSTR(WK_LINE2, LEN(WK_LINE2) -2, LEN(WK_LINE2) - 2) = '|') THEN
     BEGIN
        WK_LINE2 = SUBSTR(WK_LINE2, 1, LEN(WK_LINE2) - 3);
     END
     WK_QTY = NEW.QTY;
     WK_RECORD = NEW.RECORD_ID;
     WK_CLASS = NEW.TRN_CODE;

     WK_DIRECTORY = '';
     WK_FILE_TYPE_U = 0;
     WK_FILE_TYPE_V = 0;
     WK_FILE_PREFIX = '';

     IF (STRLEN(WK_PRINTER) > 2) THEN
     BEGIN
        WK_PRINTER = UPPER(SUBSTR(WK_PRINTER,2,3));
     END
     ELSE
     BEGIN
        WK_PRINTER = UPPER(WK_PRINTER);
     END
     IF (STRLEN(WK_PRINTER) < 2) THEN
     BEGIN
        WK_PRINTER = 'P' || WK_PRINTER;
     END
     /* need the directory for this label set */
     SELECT WORKING_DIRECTORY FROM SYS_EQUIP 
         WHERE DEVICE_ID = :WK_PRINTER
         INTO :WK_DIRECTORY;
     /* print labels */
     WK_CONTACT_FIRST_NAME = '';
     WK_CONTACT_LAST_NAME = '';
     WK_ADDRESS_LINE1 = '';
     WK_ADDRESS_LINE2 = '';
     WK_CITY = '';
     WK_STATE = '';
     WK_COUNTRY = '';
     WK_POST_CODE = '';
     WK_PHONE_NO = '';
     WK_MAIL_ADDRESS_LINE1 = '';
     WK_MAIL_ADDRESS_LINE2 = '';
     WK_MAIL_CITY = '';
     WK_MAIL_STATE = '';
     WK_MAIL_COUNTRY = '';
     WK_MAIL_POST_CODE = '';
     WK_CONTACT_PHONE_NO = '';
     WK_EXPORT_CATEGORY = '';
     IF ((WK_CLASS = 'S') OR (WK_CLASS = 'M')) THEN
     BEGIN
        SELECT CONTACT_FIRST_NAME,
            CONTACT_LAST_NAME,
            ADDRESS_LINE1,
            ADDRESS_LINE2,
            CITY,
            STATE,
            COUNTRY,
            POST_CODE,
            PHONE_NO,
            MAIL_ADDRESS1,
            MAIL_ADDRESS2,
            MAIL_CITY,
            MAIL_STATE,
            MAIL_COUNTRY,
            MAIL_POST_CODE,
            CONTACT_PHONE
            FROM PERSON 
            WHERE PERSON_ID = :WK_PERSON
            INTO :WK_CONTACT_FIRST_NAME,
                 :WK_CONTACT_LAST_NAME,
                 :WK_ADDRESS_LINE1,
                 :WK_ADDRESS_LINE2,
                 :WK_CITY,
                 :WK_STATE,
                 :WK_COUNTRY,
                 :WK_POST_CODE,
                 :WK_PHONE_NO,
                 :WK_MAIL_ADDRESS_LINE1,
                 :WK_MAIL_ADDRESS_LINE2,
                 :WK_MAIL_CITY,
                 :WK_MAIL_STATE,
                 :WK_MAIL_COUNTRY,
                 :WK_MAIL_POST_CODE,
                 :WK_CONTACT_PHONE_NO;
        BEGIN
           IF (WK_CONTACT_FIRST_NAME IS NULL) THEN
           BEGIN
              WK_CONTACT_FIRST_NAME = '';
           END
           IF (WK_CONTACT_LAST_NAME IS NULL) THEN
           BEGIN
              WK_CONTACT_LAST_NAME = '';
           END
           IF (WK_ADDRESS_LINE1 IS NULL) THEN
           BEGIN
              WK_ADDRESS_LINE1 = '';
           END
           IF (WK_ADDRESS_LINE2 IS NULL) THEN
           BEGIN
              WK_ADDRESS_LINE2 = '';
           END
           IF (WK_CITY IS NULL) THEN
           BEGIN
              WK_CITY = '';
           END
           IF (WK_STATE IS NULL) THEN
           BEGIN
              WK_STATE = '';
           END
           IF (WK_COUNTRY IS NULL) THEN
           BEGIN
              WK_COUNTRY = '';
           END
           IF (WK_POST_CODE IS NULL) THEN
           BEGIN
              WK_POST_CODE = '';
           END
           IF (WK_PHONE_NO IS NULL) THEN
           BEGIN
              WK_PHONE_NO = '';
           END
           IF (WK_MAIL_ADDRESS_LINE1 IS NULL) THEN
           BEGIN
              WK_MAIL_ADDRESS_LINE1 = '';
           END
           IF (WK_MAIL_ADDRESS_LINE2 IS NULL) THEN
           BEGIN
              WK_MAIL_ADDRESS_LINE2 = '';
           END
           IF (WK_MAIL_CITY IS NULL) THEN
           BEGIN
              WK_MAIL_CITY = '';
           END
           IF (WK_MAIL_STATE IS NULL) THEN
           BEGIN
              WK_MAIL_STATE = '';
           END
           IF (WK_MAIL_COUNTRY IS NULL) THEN
           BEGIN
              WK_MAIL_COUNTRY = '';
           END
           IF (WK_MAIL_POST_CODE IS NULL) THEN
           BEGIN
              WK_MAIL_POST_CODE = '';
           END
           IF (WK_CONTACT_PHONE_NO IS NULL) THEN
           BEGIN
              WK_CONTACT_PHONE_NO = '';
           END
        END
     END
     IF (WK_CLASS = 'O') THEN
     BEGIN
        SELECT P_TITLE,
            P_FIRST_NAME,
            P_LAST_NAME,
            P_ADDRESS_LINE1,
            P_ADDRESS_LINE2,
            P_ADDRESS_LINE3,
            P_ADDRESS_LINE4,
            P_ADDRESS_LINE5,
            P_AUST_POST_4STATE_ID,
            P_CITY,
            P_STATE,
            P_COUNTRY,
            P_POST_CODE,
            P_PHONE,
            COMPANY_ID,
            EXPORT_CATEGORY
        FROM PICK_ORDER
        WHERE PICK_ORDER = :WK_PERSON
        INTO :WK_TITLE,
             :WK_CONTACT_FIRST_NAME,
             :WK_CONTACT_LAST_NAME,
             :WK_ADDRESS_LINE1,
             :WK_ADDRESS_LINE2,
             :WK_ADDRESS_LINE3,
             :WK_ADDRESS_LINE4,
             :WK_ADDRESS_LINE5,
             :WK_4STATE,
             :WK_CITY,
             :WK_STATE,
             :WK_COUNTRY,
             :WK_POST_CODE,
             :WK_PHONE_NO,
             :WK_COMPANY,
             :WK_EXPORT_CATEGORY;
           IF (WK_TITLE IS NULL) THEN
           BEGIN
              WK_TITLE = '';
           END
           IF (WK_CONTACT_FIRST_NAME IS NULL) THEN
           BEGIN
              WK_CONTACT_FIRST_NAME = '';
           END
           IF (WK_CONTACT_LAST_NAME IS NULL) THEN
           BEGIN
              WK_CONTACT_LAST_NAME = '';
           END
           IF (WK_ADDRESS_LINE1 IS NULL) THEN
           BEGIN
              WK_ADDRESS_LINE1 = '';
           END
           IF (WK_ADDRESS_LINE2 IS NULL) THEN
           BEGIN
              WK_ADDRESS_LINE2 = '';
           END
           IF (WK_ADDRESS_LINE3 IS NULL) THEN
           BEGIN
              WK_ADDRESS_LINE3 = '';
           END
           IF (WK_ADDRESS_LINE4 IS NULL) THEN
           BEGIN
              WK_ADDRESS_LINE4 = '';
           END
           IF (WK_ADDRESS_LINE5 IS NULL) THEN
           BEGIN
              WK_ADDRESS_LINE5 = '';
           END
           IF (WK_4STATE IS NULL) THEN
           BEGIN
              WK_4STATE = '';
           END
           IF (WK_CITY IS NULL) THEN
           BEGIN
              WK_CITY = '';
           END
           IF (WK_STATE IS NULL) THEN
           BEGIN
              WK_STATE = '';
           END
           IF (WK_COUNTRY IS NULL) THEN
           BEGIN
              WK_COUNTRY = '';
           END
           IF (WK_POST_CODE IS NULL) THEN
           BEGIN
              WK_POST_CODE = '';
           END
           IF (WK_PHONE_NO IS NULL) THEN
           BEGIN
              WK_PHONE_NO = '';
           END
           IF (WK_COMPANY IS NULL) THEN
           BEGIN
              WK_COMPANY = '';
           END
           IF (WK_EXPORT_CATEGORY IS NULL) THEN
           BEGIN
              WK_EXPORT_CATEGORY = '';
           END
           SELECT DESCRIPTION
           FROM OPTIONS
           WHERE GROUP_CODE = 'PLAO-PFX'
           AND CODE = (:WK_COMPANY || '|' || :WK_COUNTRY)
           INTO :WK_FILE_PREFIX;
           IF (WK_FILE_PREFIX IS NULL) THEN
           BEGIN
              WK_FILE_PREFIX = '';
           END
           SELECT DESCRIPTION
           FROM OPTIONS
           WHERE GROUP_CODE = 'CMPPKEXP'
           AND CODE = (:WK_COMPANY || '|' || :WK_COUNTRY)
           INTO :WK_DO_EXPORT;
           IF (WK_DO_EXPORT IS NULL) THEN
           BEGIN
              WK_DO_EXPORT = '';
           END
           IF (WK_DO_EXPORT = 'T') THEN
           BEGIN
              WK_DUMMY_CATEGORY = '';
           END
           ELSE
           BEGIN
              WK_EXPORT_CATEGORY = '';
           END
           /* get my zone - for conveyor device */
           WK_ZONE = '';
           SELECT OPERATING_ZONE
           FROM SYS_EQUIP 
           WHERE DEVICE_ID = :WK_DEVICE
           INTO :WK_ZONE;
           IF (WK_ZONE IS NULL) THEN
           BEGIN
              WK_ZONE = '';
           END
           /* get device - for conveyor  */
           WK_CON_DEVICE = '';
           SELECT FIRST 1 DEVICE_ID
           FROM SYS_EQUIP 
           WHERE DEVICE_TYPE = 'HH'
           AND   OPERATING_ZONE = :WK_ZONE
           INTO :WK_CON_DEVICE;
           IF (WK_CON_DEVICE IS NULL) THEN
           BEGIN
              WK_CON_DEVICE = '';
           END
          
           /* if company setup for scanning at dx 
              then change status back to ds - for weighing */
           WK_DO_DSDX = 'F';
           SELECT DESCRIPTION
           FROM OPTIONS
           WHERE GROUP_CODE = 'CMPPKDSDX'
           AND CODE = :WK_COMPANY
           INTO :WK_DO_DSDX;
           IF (WK_DO_DSDX IS NULL) THEN
           BEGIN
              WK_DO_DSDX = 'F';
           END
           IF (WK_DO_DSDX = 'T') THEN
           BEGIN
              UPDATE PICK_ITEM 
              SET PICK_LINE_STATUS = 'DS'     
              WHERE PICK_ORDER = :WK_PERSON
              AND PICK_LINE_STATUS = 'DX'
              AND OVER_SIZED = 'F';
           END

           UPDATE PICK_ORDER 
           SET ADDRESS_LABEL_DATE = :WK_DATE 
           WHERE PICK_ORDER = :WK_PERSON;
           /* do we save to pick queue table */
           WK_DO_QUEUE = 'F';
           SELECT DESCRIPTION
           FROM OPTIONS
           WHERE GROUP_CODE = 'PLAO-QUE'
           AND CODE = (:WK_COMPANY || '|' || :WK_COUNTRY)
           INTO :WK_DO_QUEUE;
           IF (WK_DO_QUEUE IS NULL) THEN
           BEGIN
              WK_DO_QUEUE = 'F';
           END
           IF (WK_DO_QUEUE = 'T') THEN
           BEGIN
/*
              INSERT INTO PICK_QUEUE (PICK_ORDER, CREATE_DATE, PICK_QUEUE_STATUS) VALUES (:WK_PERSON, 'NOW', 'LB');
*/
              INSERT INTO PICK_QUEUE (PICK_ORDER, CREATE_DATE, PICK_QUEUE_STATUS, DEVICE_ID) VALUES (:WK_PERSON, 'NOW', 'LB', :WK_CON_DEVICE);
           END
     END
     /* WK_FILENAME = WK_DIRECTORY || 'AddrOther.txt'; */
     WK_FILENAME = WK_DIRECTORY || WK_FILE_PREFIX || 'AddrOther.vxt';
     WK_FILENAME = WK_DIRECTORY || WK_FILE_PREFIX || 'AddrOther.txt';
     IF (WK_CLASS = 'S') THEN
     BEGIN
        WK_LABEL_LINE = '"' || WK_PERSON || '","' ||
             WK_CONTACT_FIRST_NAME || ' ' || WK_CONTACT_LAST_NAME || '","' ||
             WK_ADDRESS_LINE1 || '","' ||
             WK_ADDRESS_LINE2 || '","' ||
             WK_CITY || '","' ||
             WK_STATE || '","' ||
             WK_COUNTRY || '","' ||
             WK_POST_CODE || '","' ||
             WK_CONTACT_PHONE_NO || '","' ||
             WK_LINE1 || '","' ||
             WK_LINE2 || '",' ||
             WK_QTY || ',"' ||
             SUBSTR(WK_PRINTER,2,2) || '"' ||
             CHR(13) || CHR(10);
     END
     IF (WK_CLASS = 'M') THEN
     BEGIN
        WK_LABEL_LINE = '"' || WK_PERSON || '","' ||
             WK_CONTACT_FIRST_NAME || ' ' || WK_CONTACT_LAST_NAME || '","' ||
             WK_MAIL_ADDRESS_LINE1 || '","' ||
             WK_MAIL_ADDRESS_LINE2 || '","' ||
             WK_MAIL_CITY || '","' ||
             WK_MAIL_STATE || '","' ||
             WK_MAIL_COUNTRY || '","' ||
             WK_MAIL_POST_CODE || '","' ||
             WK_CONTACT_PHONE_NO || '","' ||
             WK_LINE1 || '","' ||
             WK_LINE2 || '",' ||
             WK_QTY || ',"' ||
             SUBSTR(WK_PRINTER,2,2) || '"' ||
             CHR(13) || CHR(10);
     END
     IF (WK_CLASS = 'O') THEN
     BEGIN
        WK_LABEL_LINE = '"' || WK_PERSON || '","' ||
             WK_CONTACT_FIRST_NAME || ' ' || WK_CONTACT_LAST_NAME || '","' ||
             WK_ADDRESS_LINE1 || '","' ||
             WK_ADDRESS_LINE2 || '","' ||
             WK_CITY || '","' ||
             WK_STATE || '","' ||
             WK_COUNTRY || '","' ||
             WK_POST_CODE || '","' ||
             WK_CONTACT_PHONE_NO || '","' ||
             WK_LINE1 || '","' ||
             WK_LINE2 || '",' ||
             WK_QTY || ',"' ||
             SUBSTR(WK_PRINTER,2,2) || '","' ||
             WK_TITLE || '","' ||
             WK_ADDRESS_LINE3 || '","' ||
             WK_ADDRESS_LINE4 || '","' ||
             WK_4STATE || '","' ||
             WK_ADDRESS_LINE5 || '","' ||
             WK_EXPORT_CATEGORY || '"' ||
             CHR(13) || CHR(10);
     END

     WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE);
     IF (WK_RESULT = 0) THEN
     BEGIN
        WK_FILE_TYPE_U = 1;
     END
     IF (WK_RESULT <> 0) THEN
     BEGIN
        /* WK_FILENAME = WK_DIRECTORY || 'AddrOther.vxt'; */
        WK_FILENAME = WK_DIRECTORY || WK_FILE_PREFIX || 'AddrOther.txt';
        WK_FILENAME = WK_DIRECTORY || WK_FILE_PREFIX || 'AddrOther2.txt';
        /* WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE); */ 
        WK_RESULT = FILE_WRITE(WK_FILENAME, WK_LABEL_LINE);
        WK_FILE_TYPE_V = 1;
     END
     IF (WK_RESULT <> 0) THEN
     BEGIN
        WK_FILENAME = WK_DIRECTORY || WK_FILE_PREFIX || 'AddrOther3.txt';
        /* WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE); */ 
        WK_RESULT = FILE_WRITE(WK_FILENAME, WK_LABEL_LINE);
        WK_FILE_TYPE_V = 2;
     END
     IF (WK_RESULT <> 0) THEN
     BEGIN
        WK_FILENAME = WK_DIRECTORY || WK_FILE_PREFIX || 'AddrOther4.txt';
        /* WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE); */ 
        WK_RESULT = FILE_WRITE(WK_FILENAME, WK_LABEL_LINE);
        WK_FILE_TYPE_V = 3;
     END
     IF (WK_RESULT <> 0) THEN
     BEGIN
        WK_FILENAME = WK_DIRECTORY || WK_FILE_PREFIX || 'AddrOther5.txt';
        /* WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE); */ 
        WK_RESULT = FILE_WRITE(WK_FILENAME, WK_LABEL_LINE);
        WK_FILE_TYPE_V = 4;
     END
     IF (WK_RESULT <> 0) THEN
     BEGIN
        WK_FILENAME = WK_DIRECTORY || WK_FILE_PREFIX || 'AddrOther6.txt';
        /* WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE); */ 
        WK_RESULT = FILE_WRITE(WK_FILENAME, WK_LABEL_LINE);
        WK_FILE_TYPE_V = 5;
     END
     IF (WK_RESULT <> 0) THEN
     BEGIN
        WK_FILENAME = WK_DIRECTORY || WK_FILE_PREFIX || 'AddrOther7.txt';
        /* WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE); */ 
        WK_RESULT = FILE_WRITE(WK_FILENAME, WK_LABEL_LINE);
        WK_FILE_TYPE_V = 6;
     END
     IF (WK_RESULT <> 0) THEN
     BEGIN
        WK_FILENAME = WK_DIRECTORY || WK_FILE_PREFIX || 'AddrOther8.txt';
        /* WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE); */ 
        WK_RESULT = FILE_WRITE(WK_FILENAME, WK_LABEL_LINE);
        WK_FILE_TYPE_V = 7;
     END
     IF (WK_RESULT <> 0) THEN
     BEGIN
        WK_FILENAME = WK_DIRECTORY || WK_FILE_PREFIX || 'AddrOther9.txt';
        /* WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE); */ 
        WK_RESULT = FILE_WRITE(WK_FILENAME, WK_LABEL_LINE);
        WK_FILE_TYPE_V = 8;
     END
     IF (WK_RESULT <> 0) THEN
     BEGIN
        WK_FILENAME = WK_DIRECTORY || WK_FILE_PREFIX || 'AddrOtherA.txt';
        /* WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE); */ 
        WK_RESULT = FILE_WRITE(WK_FILENAME, WK_LABEL_LINE);
        WK_FILE_TYPE_V = 9;
     END
     /*
     IF (WK_FILE_TYPE_V = 0) THEN
     BEGIN
        -* WK_FILENAME = WK_DIRECTORY || 'AddrOther.vxt'; *-
        WK_FILENAME = WK_DIRECTORY || WK_FILE_PREFIX || 'AddrOther.vxt';
        -* WK_FILENAME_OUT = WK_DIRECTORY || 'AddrOther.txt'; *-
        WK_FILENAME_OUT = WK_DIRECTORY || WK_FILE_PREFIX || 'AddrOther.txt';
        WK_RESULT = FILE_RENAME(WK_FILENAME, WK_FILENAME_OUT);
     END
     */
   EXECUTE PROCEDURE UPDATE_TRAN (WK_RECORD, 'T','Processed successfully');
   /* EXECUTE PROCEDURE TRAN_ARCHIVE; */
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_NIPP FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 88 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'NIPP') THEN
  BEGIN
   EXECUTE PROCEDURE PC_NIXX 
    NEW.RECORD_ID ,
    NEW.WH_ID,
    NEW.LOCN_ID,
    NEW.OBJECT,
    NEW.TRN_TYPE,
    NEW.TRN_CODE,
    NEW.TRN_DATE,
    NEW.REFERENCE,
    NEW.QTY,
    NEW.PERSON_ID,
    NEW.DEVICE_ID,
    NEW.INSTANCE_ID;
   EXECUTE PROCEDURE TRAN_ARCHIVE;
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_TRIS FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 89 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'TRIS') THEN
  BEGIN
   EXECUTE PROCEDURE PC_TRIS
    NEW.RECORD_ID ,
    NEW.WH_ID,
    NEW.LOCN_ID,
    NEW.OBJECT,
    NEW.TRN_TYPE,
    NEW.TRN_CODE,
    NEW.TRN_DATE,
    NEW.REFERENCE,
    NEW.QTY,
    NEW.SUB_LOCN_ID,
    NEW.PERSON_ID,
    NEW.DEVICE_ID;
   EXECUTE PROCEDURE TRAN_ARCHIVE;
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_NI11 FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 90 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'NI11') THEN
  BEGIN
   EXECUTE PROCEDURE PC_NIXX 
    NEW.RECORD_ID ,
    NEW.WH_ID,
    NEW.LOCN_ID,
    NEW.OBJECT,
    NEW.TRN_TYPE,
    NEW.TRN_CODE,
    NEW.TRN_DATE,
    NEW.REFERENCE,
    NEW.QTY,
    NEW.PERSON_ID,
    NEW.DEVICE_ID,
    NEW.INSTANCE_ID;
   EXECUTE PROCEDURE TRAN_ARCHIVE;
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_NI12 FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 91 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'NI12') THEN
  BEGIN
   EXECUTE PROCEDURE PC_NIXX 
    NEW.RECORD_ID ,
    NEW.WH_ID,
    NEW.LOCN_ID,
    NEW.OBJECT,
    NEW.TRN_TYPE,
    NEW.TRN_CODE,
    NEW.TRN_DATE,
    NEW.REFERENCE,
    NEW.QTY,
    NEW.PERSON_ID,
    NEW.DEVICE_ID,
    NEW.INSTANCE_ID;
   EXECUTE PROCEDURE TRAN_ARCHIVE;
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_NI13 FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 92 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'NI13') THEN
  BEGIN
   EXECUTE PROCEDURE PC_NIXX 
    NEW.RECORD_ID ,
    NEW.WH_ID,
    NEW.LOCN_ID,
    NEW.OBJECT,
    NEW.TRN_TYPE,
    NEW.TRN_CODE,
    NEW.TRN_DATE,
    NEW.REFERENCE,
    NEW.QTY,
    NEW.PERSON_ID,
    NEW.DEVICE_ID,
    NEW.INSTANCE_ID;
   EXECUTE PROCEDURE TRAN_ARCHIVE;
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_NI14 FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 93 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'NI14') THEN
  BEGIN
   EXECUTE PROCEDURE PC_NIXX 
    NEW.RECORD_ID ,
    NEW.WH_ID,
    NEW.LOCN_ID,
    NEW.OBJECT,
    NEW.TRN_TYPE,
    NEW.TRN_CODE,
    NEW.TRN_DATE,
    NEW.REFERENCE,
    NEW.QTY,
    NEW.PERSON_ID,
    NEW.DEVICE_ID,
    NEW.INSTANCE_ID;
   EXECUTE PROCEDURE TRAN_ARCHIVE;
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_NI15 FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 94 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'NI15') THEN
  BEGIN
   EXECUTE PROCEDURE PC_NIXX 
    NEW.RECORD_ID ,
    NEW.WH_ID,
    NEW.LOCN_ID,
    NEW.OBJECT,
    NEW.TRN_TYPE,
    NEW.TRN_CODE,
    NEW.TRN_DATE,
    NEW.REFERENCE,
    NEW.QTY,
    NEW.PERSON_ID,
    NEW.DEVICE_ID,
    NEW.INSTANCE_ID;
   EXECUTE PROCEDURE TRAN_ARCHIVE;
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_NI16 FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 95 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'NI16') THEN
  BEGIN
   EXECUTE PROCEDURE PC_NIXX 
    NEW.RECORD_ID ,
    NEW.WH_ID,
    NEW.LOCN_ID,
    NEW.OBJECT,
    NEW.TRN_TYPE,
    NEW.TRN_CODE,
    NEW.TRN_DATE,
    NEW.REFERENCE,
    NEW.QTY,
    NEW.PERSON_ID,
    NEW.DEVICE_ID,
    NEW.INSTANCE_ID;
   EXECUTE PROCEDURE TRAN_ARCHIVE;
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_NI17 FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 96 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'NI17') THEN
  BEGIN
   EXECUTE PROCEDURE PC_NIXX 
    NEW.RECORD_ID ,
    NEW.WH_ID,
    NEW.LOCN_ID,
    NEW.OBJECT,
    NEW.TRN_TYPE,
    NEW.TRN_CODE,
    NEW.TRN_DATE,
    NEW.REFERENCE,
    NEW.QTY,
    NEW.PERSON_ID,
    NEW.DEVICE_ID,
    NEW.INSTANCE_ID;
   EXECUTE PROCEDURE TRAN_ARCHIVE;
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_NI18 FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 97 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'NI18') THEN
  BEGIN
   EXECUTE PROCEDURE PC_NIXX 
    NEW.RECORD_ID ,
    NEW.WH_ID,
    NEW.LOCN_ID,
    NEW.OBJECT,
    NEW.TRN_TYPE,
    NEW.TRN_CODE,
    NEW.TRN_DATE,
    NEW.REFERENCE,
    NEW.QTY,
    NEW.PERSON_ID,
    NEW.DEVICE_ID,
    NEW.INSTANCE_ID;
   EXECUTE PROCEDURE TRAN_ARCHIVE;
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_NI19 FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 98 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'NI19') THEN
  BEGIN
   EXECUTE PROCEDURE PC_NIXX 
    NEW.RECORD_ID ,
    NEW.WH_ID,
    NEW.LOCN_ID,
    NEW.OBJECT,
    NEW.TRN_TYPE,
    NEW.TRN_CODE,
    NEW.TRN_DATE,
    NEW.REFERENCE,
    NEW.QTY,
    NEW.PERSON_ID,
    NEW.DEVICE_ID,
    NEW.INSTANCE_ID;
   EXECUTE PROCEDURE TRAN_ARCHIVE;
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_NI20 FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 99 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'NI20') THEN
  BEGIN
   EXECUTE PROCEDURE PC_NIXX 
    NEW.RECORD_ID ,
    NEW.WH_ID,
    NEW.LOCN_ID,
    NEW.OBJECT,
    NEW.TRN_TYPE,
    NEW.TRN_CODE,
    NEW.TRN_DATE,
    NEW.REFERENCE,
    NEW.QTY,
    NEW.PERSON_ID,
    NEW.DEVICE_ID,
    NEW.INSTANCE_ID;
   EXECUTE PROCEDURE TRAN_ARCHIVE;
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_TRMI FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 100 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'TRMI') THEN
  BEGIN
   EXECUTE PROCEDURE PC_TRMI
    NEW.RECORD_ID ,
    NEW.WH_ID,
    NEW.LOCN_ID,
    NEW.SUB_LOCN_ID,
    NEW.OBJECT,
    NEW.TRN_TYPE,
    NEW.TRN_CODE,
    NEW.TRN_DATE,
    NEW.REFERENCE,
    NEW.QTY,
    NEW.PERSON_ID,
    NEW.DEVICE_ID;
   /* EXECUTE PROCEDURE TRAN_ARCHIVE; */
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_PPPD FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 105 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_FOUND INTEGER;
DECLARE VARIABLE WK_PROD_ID VARCHAR(30);
DECLARE VARIABLE WK_WH_ID CHAR(2);
DECLARE VARIABLE WK_LOCN_ID VARCHAR(10);
DECLARE VARIABLE WK_SUBLOCN_ID VARCHAR(10);
DECLARE VARIABLE WK_REF_ID VARCHAR(40);
DECLARE VARIABLE WK_QTY INTEGER;
DECLARE VARIABLE WK_USER VARCHAR(10);
DECLARE VARIABLE WK_DEVICE CHAR(2);
DECLARE VARIABLE WK_DATE TIMESTAMP;
DECLARE VARIABLE WK_PROD_TYPE CHAR(2);
DECLARE VARIABLE WK_UOM CHAR(2);
DECLARE VARIABLE WK_ISSUE_UOM CHAR(2);
DECLARE VARIABLE WK_ORDER_UOM CHAR(2);
DECLARE VARIABLE WK_STOCK CHAR(1);
DECLARE VARIABLE WK_TRACK CHAR(1);
DECLARE VARIABLE WK_DESC VARCHAR(50);
DECLARE VARIABLE WK_RECORD_ID INTEGER;
BEGIN
   WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
   IF (WK_AUTORUN = 1) THEN
   BEGIN
      IF (NEW.TRN_TYPE = 'PPPD') THEN
      BEGIN
         /* check exists */
         WK_FOUND = 0;
         WK_PROD_ID = NEW.OBJECT;
         WK_WH_ID = NEW.WH_ID;
         WK_LOCN_ID = NEW.LOCN_ID;
         WK_SUBLOCN_ID = NEW.SUB_LOCN_ID;
         WK_REF_ID = NEW.REFERENCE;
         WK_QTY = NEW.QTY;
         WK_USER = NEW.PERSON_ID;
         WK_DEVICE = NEW.DEVICE_ID;
         WK_DATE = NEW.TRN_DATE;
         WK_RECORD_ID = NEW.RECORD_ID;

         WK_PROD_TYPE = WK_WH_ID;
         WK_UOM = SUBSTR(WK_LOCN_ID, 1, 2);
         WK_ISSUE_UOM = SUBSTR(WK_LOCN_ID, 3, 4);
         WK_ORDER_UOM = SUBSTR(WK_LOCN_ID, 5, 6);
         WK_STOCK = SUBSTR(WK_LOCN_ID, 7, 7);
         WK_TRACK = SUBSTR(WK_LOCN_ID, 8, 8);
         WK_DESC = WK_SUBLOCN_ID || WK_REF_ID;
         SELECT 1 FROM PROD_PROFILE   
         WHERE PROD_ID = :WK_PROD_ID
         INTO :WK_FOUND;
         IF (WK_FOUND IS NULL) THEN
         BEGIN
            WK_FOUND = 0;
         END
         IF (WK_FOUND = 0) THEN
         BEGIN
            INSERT INTO PROD_PROFILE (PROD_ID, SHORT_DESC, PROD_TYPE, STOCK, UOM, ISSUE_UOM, ORDER_UOM, SSN_TRACK, STANDARD_COST, LAST_UPDATE_DATE, LAST_UPDATE_BY)
            VALUES (:WK_PROD_ID, :WK_DESC, :WK_PROD_TYPE, :WK_STOCK, :WK_UOM, :WK_ISSUE_UOM, :WK_ORDER_UOM, :WK_TRACK, :WK_QTY / 100, :WK_DATE, :WK_USER);

         END
         ELSE
         BEGIN
            UPDATE PROD_PROFILE SET  SHORT_DESC =  :WK_DESC, 
            PROD_TYPE =  :WK_PROD_TYPE, 
            STOCK =  :WK_STOCK, 
            UOM =  :WK_UOM, 
            ISSUE_UOM =  :WK_ISSUE_UOM, 
            ORDER_UOM =  :WK_ORDER_UOM, 
            SSN_TRACK =  :WK_TRACK, 
            STANDARD_COST =  :WK_QTY / 100, 
            LAST_UPDATE_DATE =  :WK_DATE, 
            LAST_UPDATE_BY = :WK_USER
            WHERE PROD_ID = :WK_PROD_ID;
         END
         EXECUTE PROCEDURE UPDATE_TRAN (:WK_RECORD_ID, 'T','Processed successfully');
         /* EXECUTE PROCEDURE TRAN_ARCHIVE; */
      END
   END
END ^

CREATE TRIGGER RUN_TRANSACTION_PPSN FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 106 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_FOUND INTEGER;
DECLARE VARIABLE WK_FOUND2 INTEGER;
DECLARE VARIABLE WK_PROD_ID VARCHAR(30);
DECLARE VARIABLE WK_WH_ID CHAR(2);
DECLARE VARIABLE WK_LOCN_ID VARCHAR(10);
DECLARE VARIABLE WK_SUBLOCN_ID VARCHAR(10);
DECLARE VARIABLE WK_REF_ID VARCHAR(40);
DECLARE VARIABLE WK_QTY INTEGER;
DECLARE VARIABLE WK_USER VARCHAR(10);
DECLARE VARIABLE WK_DEVICE CHAR(2);
DECLARE VARIABLE WK_DATE TIMESTAMP;
DECLARE VARIABLE WK_PROD_PREFER VARCHAR(3);
DECLARE VARIABLE WK_SUPPLIER VARCHAR(10);
DECLARE VARIABLE WK_SUPPLIER_PROD VARCHAR(20);
DECLARE VARIABLE WK_RECORD_ID INTEGER;
BEGIN
   WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
   IF (WK_AUTORUN = 1) THEN
   BEGIN
      IF (NEW.TRN_TYPE = 'PPSN') THEN
      BEGIN
         /* check exists */
         WK_FOUND = 0;
         WK_FOUND2 = 0;
         WK_PROD_ID = NEW.OBJECT;
         WK_WH_ID = NEW.WH_ID;
         WK_LOCN_ID = NEW.LOCN_ID;
         WK_SUBLOCN_ID = NEW.SUB_LOCN_ID;
         WK_REF_ID = NEW.REFERENCE;
         WK_QTY = NEW.QTY;
         WK_USER = NEW.PERSON_ID;
         WK_DEVICE = NEW.DEVICE_ID;
         WK_DATE = NEW.TRN_DATE;
         WK_RECORD_ID = NEW.RECORD_ID;

         WK_PROD_PREFER = WK_WH_ID || SUBSTR(WK_LOCN_ID, 1, 1);
         WK_SUPPLIER = WK_SUBLOCN_ID;
         WK_SUPPLIER_PROD = SUBSTR(WK_REF_ID, 1, 20);

         SELECT 1 FROM PROD_PROFILE   
         WHERE PROD_ID = :WK_PROD_ID
         INTO :WK_FOUND;
         IF (WK_FOUND IS NULL) THEN
         BEGIN
            WK_FOUND = 0;
         END
         SELECT 1 FROM PROD_SUPPLIER  
         WHERE PROD_ID = :WK_PROD_ID
         AND SUPPLIER_ID = :WK_SUPPLIER
         INTO :WK_FOUND2;
         IF (WK_FOUND2 IS NULL) THEN
         BEGIN
            WK_FOUND2 = 0;
         END
         IF (WK_FOUND = 0) THEN
         BEGIN
            IF (WK_QTY = 1) THEN
            BEGIN
               INSERT INTO PROD_PROFILE (PROD_ID, SHORT_DESC, SUPPLIER_PREFER, SUPPLIER_NO1, SUPPLIER_NO1_PROD, LAST_UPDATE_DATE, LAST_UPDATE_BY)
               VALUES (:WK_PROD_ID, :WK_PROD_ID, :WK_PROD_PREFER, :WK_SUPPLIER, :WK_SUPPLIER_PROD, :WK_DATE, :WK_USER);
            END
            ELSE
            BEGIN
               IF (WK_QTY = 2) THEN
               BEGIN
                  INSERT INTO PROD_PROFILE (PROD_ID, SHORT_DESC, SUPPLIER_PREFER, SUPPLIER_NO2, SUPPLIER_NO2_PROD, LAST_UPDATE_DATE, LAST_UPDATE_BY)
                  VALUES (:WK_PROD_ID, :WK_PROD_ID, :WK_PROD_PREFER, :WK_SUPPLIER, :WK_SUPPLIER_PROD, :WK_DATE, :WK_USER);
               END
               ELSE
               BEGIN
                  IF (WK_QTY = 3) THEN
                  BEGIN
                     INSERT INTO PROD_PROFILE (PROD_ID, SHORT_DESC, SUPPLIER_PREFER, SUPPLIER_NO3, SUPPLIER_NO3_PROD, LAST_UPDATE_DATE, LAST_UPDATE_BY)
                     VALUES (:WK_PROD_ID, :WK_PROD_ID, :WK_PROD_PREFER, :WK_SUPPLIER, :WK_SUPPLIER_PROD, :WK_DATE, :WK_USER);
                  END
               END
            END

         END
         ELSE
         BEGIN
            IF (WK_QTY = 1) THEN
            BEGIN
               UPDATE PROD_PROFILE SET  
               SUPPLIER_PREFER =  :WK_PROD_PREFER, 
               SUPPLIER_NO1 =  :WK_SUPPLIER, 
               SUPPLIER_NO1_PROD =  :WK_SUPPLIER_PROD, 
               LAST_UPDATE_DATE =  :WK_DATE, 
               LAST_UPDATE_BY = :WK_USER
               WHERE PROD_ID = :WK_PROD_ID;
            END
            ELSE
            BEGIN
               IF (WK_QTY = 2) THEN
               BEGIN
                  UPDATE PROD_PROFILE SET  
                  SUPPLIER_PREFER =  :WK_PROD_PREFER, 
                  SUPPLIER_NO2 =  :WK_SUPPLIER, 
                  SUPPLIER_NO2_PROD =  :WK_SUPPLIER_PROD, 
                  LAST_UPDATE_DATE =  :WK_DATE, 
                  LAST_UPDATE_BY = :WK_USER
                  WHERE PROD_ID = :WK_PROD_ID;
               END
               ELSE
               BEGIN
                  IF (WK_QTY = 3) THEN
                  BEGIN
                     UPDATE PROD_PROFILE SET  
                     SUPPLIER_PREFER =  :WK_PROD_PREFER, 
                     SUPPLIER_NO3 =  :WK_SUPPLIER, 
                     SUPPLIER_NO3_PROD =  :WK_SUPPLIER_PROD, 
                     LAST_UPDATE_DATE =  :WK_DATE, 
                     LAST_UPDATE_BY = :WK_USER
                     WHERE PROD_ID = :WK_PROD_ID;
                  END
               END
            END
         END
         IF (WK_FOUND2 = 0) THEN
         BEGIN
            INSERT INTO PROD_SUPPLIER (PROD_ID, SUPPLIER_ID, SUPPLIER_PROD, LAST_UPDATE_DATE, LAST_UPDATE_BY)
            VALUES (:WK_PROD_ID, :WK_SUPPLIER, :WK_SUPPLIER_PROD, :WK_DATE, :WK_USER);
         END
         ELSE
         BEGIN
            UPDATE PROD_SUPPLIER SET  
            SUPPLIER_PROD =  :WK_SUPPLIER_PROD, 
            LAST_UPDATE_DATE =  :WK_DATE, 
            LAST_UPDATE_BY = :WK_USER
            WHERE PROD_ID = :WK_PROD_ID
            AND SUPPLIER_ID =  :WK_SUPPLIER; 
         END

         EXECUTE PROCEDURE UPDATE_TRAN (:WK_RECORD_ID, 'T','Processed successfully');
         /* EXECUTE PROCEDURE TRAN_ARCHIVE; */
      END
   END
END ^

CREATE TRIGGER RUN_TRANSACTION_PPSI FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 107 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_FOUND INTEGER;
DECLARE VARIABLE WK_PROD_ID VARCHAR(30);
DECLARE VARIABLE WK_WH_ID CHAR(2);
DECLARE VARIABLE WK_LOCN_ID VARCHAR(10);
DECLARE VARIABLE WK_SUBLOCN_ID VARCHAR(10);
DECLARE VARIABLE WK_REF_ID VARCHAR(40);
DECLARE VARIABLE WK_QTY INTEGER;
DECLARE VARIABLE WK_USER VARCHAR(10);
DECLARE VARIABLE WK_DEVICE CHAR(2);
DECLARE VARIABLE WK_DATE TIMESTAMP;
DECLARE VARIABLE WK_PROD_INSTR VARCHAR(50);
DECLARE VARIABLE WK_RECORD_ID INTEGER;
BEGIN
   WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
   IF (WK_AUTORUN = 1) THEN
   BEGIN
      IF (NEW.TRN_TYPE = 'PPSI') THEN
      BEGIN
         /* check exists */
         WK_FOUND = 0;
         WK_PROD_ID = NEW.OBJECT;
         WK_WH_ID = NEW.WH_ID;
         WK_LOCN_ID = NEW.LOCN_ID;
         WK_SUBLOCN_ID = NEW.SUB_LOCN_ID;
         WK_REF_ID = NEW.REFERENCE;
         WK_QTY = NEW.QTY;
         WK_USER = NEW.PERSON_ID;
         WK_DEVICE = NEW.DEVICE_ID;
         WK_DATE = NEW.TRN_DATE;
         WK_RECORD_ID = NEW.RECORD_ID;

         WK_PROD_INSTR = WK_SUBLOCN_ID || WK_REF_ID;

         SELECT 1 FROM PROD_PROFILE   
         WHERE PROD_ID = :WK_PROD_ID
         INTO :WK_FOUND;
         IF (WK_FOUND IS NULL) THEN
         BEGIN
            WK_FOUND = 0;
         END
         IF (WK_FOUND = 0) THEN
         BEGIN
            INSERT INTO PROD_PROFILE (PROD_ID, SHORT_DESC, SPECIAL_INSTR, LAST_UPDATE_DATE, LAST_UPDATE_BY)
            VALUES (:WK_PROD_ID, :WK_PROD_ID, :WK_PROD_INSTR, :WK_DATE, :WK_USER);
         END
         ELSE
         BEGIN
            UPDATE PROD_PROFILE SET  
            SPECIAL_INSTR =  :WK_PROD_INSTR, 
            LAST_UPDATE_DATE =  :WK_DATE, 
            LAST_UPDATE_BY = :WK_USER
            WHERE PROD_ID = :WK_PROD_ID;
         END
         EXECUTE PROCEDURE UPDATE_TRAN (:WK_RECORD_ID, 'T','Processed successfully');
         /* EXECUTE PROCEDURE TRAN_ARCHIVE; */
      END
   END
END ^

CREATE TRIGGER RUN_TRANSACTION_PPAI FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 108 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_FOUND INTEGER;
DECLARE VARIABLE WK_PROD_ID VARCHAR(30);
DECLARE VARIABLE WK_WH_ID CHAR(2);
DECLARE VARIABLE WK_LOCN_ID VARCHAR(10);
DECLARE VARIABLE WK_SUBLOCN_ID VARCHAR(10);
DECLARE VARIABLE WK_REF_ID VARCHAR(40);
DECLARE VARIABLE WK_QTY INTEGER;
DECLARE VARIABLE WK_USER VARCHAR(10);
DECLARE VARIABLE WK_DEVICE CHAR(2);
DECLARE VARIABLE WK_DATE TIMESTAMP;
DECLARE VARIABLE WK_ALTERNATE VARCHAR(30);
DECLARE VARIABLE WK_HOME VARCHAR(12);
DECLARE VARIABLE WK_RECORD_ID INTEGER;
BEGIN
   WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
   IF (WK_AUTORUN = 1) THEN
   BEGIN
      IF (NEW.TRN_TYPE = 'PPAI') THEN
      BEGIN
         /* check exists */
         WK_FOUND = 0;
         WK_PROD_ID = NEW.OBJECT;
         WK_WH_ID = NEW.WH_ID;
         WK_LOCN_ID = NEW.LOCN_ID;
         WK_SUBLOCN_ID = NEW.SUB_LOCN_ID;
         WK_REF_ID = NEW.REFERENCE;
         WK_QTY = NEW.QTY;
         WK_USER = NEW.PERSON_ID;
         WK_DEVICE = NEW.DEVICE_ID;
         WK_DATE = NEW.TRN_DATE;
         WK_RECORD_ID = NEW.RECORD_ID;

         WK_ALTERNATE = SUBSTR(WK_REF_ID, 1, 30);
         WK_HOME = WK_WH_ID || WK_LOCN_ID;

         SELECT 1 FROM PROD_PROFILE   
         WHERE PROD_ID = :WK_PROD_ID
         INTO :WK_FOUND;
         IF (WK_FOUND IS NULL) THEN
         BEGIN
            WK_FOUND = 0;
         END
         IF (WK_FOUND = 0) THEN
         BEGIN
            INSERT INTO PROD_PROFILE (PROD_ID, SHORT_DESC, HOME_LOCN_ID, ALTERNATE_ID, LAST_UPDATE_DATE, LAST_UPDATE_BY)
            VALUES (:WK_PROD_ID, :WK_PROD_ID, :WK_HOME, :WK_ALTERNATE, :WK_DATE, :WK_USER);
         END
         ELSE
         BEGIN
            UPDATE PROD_PROFILE SET  
            HOME_LOCN_ID =  :WK_HOME, 
            ALTERNATE_ID =  :WK_ALTERNATE, 
            LAST_UPDATE_DATE =  :WK_DATE, 
            LAST_UPDATE_BY = :WK_USER
            WHERE PROD_ID = :WK_PROD_ID;
         END
         EXECUTE PROCEDURE UPDATE_TRAN (:WK_RECORD_ID, 'T','Processed successfully');
         /* EXECUTE PROCEDURE TRAN_ARCHIVE; */
      END
   END
END ^

CREATE TRIGGER RUN_TRANSACTION_PPSP FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 109 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_FOUND INTEGER;
DECLARE VARIABLE WK_PROD_ID VARCHAR(30);
DECLARE VARIABLE WK_WH_ID CHAR(2);
DECLARE VARIABLE WK_LOCN_ID VARCHAR(10);
DECLARE VARIABLE WK_SUBLOCN_ID VARCHAR(10);
DECLARE VARIABLE WK_REF_ID VARCHAR(40);
DECLARE VARIABLE WK_QTY INTEGER;
DECLARE VARIABLE WK_USER VARCHAR(10);
DECLARE VARIABLE WK_DEVICE CHAR(2);
DECLARE VARIABLE WK_DATE TIMESTAMP;
DECLARE VARIABLE WK_LOCN_2 VARCHAR(12);
DECLARE VARIABLE WK_REF_2 VARCHAR(60);
DECLARE VARIABLE WK_PALLET_CFG VARCHAR(12);
DECLARE VARIABLE WK_PERM VARCHAR(12);
DECLARE VARIABLE WK_TURNOVER VARCHAR(12);
DECLARE VARIABLE WK_NET_WT INTEGER;
DECLARE VARIABLE WK_MAX_QTY INTEGER;
DECLARE VARIABLE WK_MIN_QTY INTEGER;
DECLARE VARIABLE WK_REORDER_QTY INTEGER;
DECLARE VARIABLE WK_MAX_ISSUE_QTY INTEGER;
DECLARE VARIABLE WK_DEF_ISSUE_QTY INTEGER;
DECLARE VARIABLE WK_NET_WT_X VARCHAR(50);
DECLARE VARIABLE WK_MAX_QTY_X VARCHAR(50);
DECLARE VARIABLE WK_MIN_QTY_X VARCHAR(50);
DECLARE VARIABLE WK_REORDER_QTY_X VARCHAR(50);
DECLARE VARIABLE WK_MAX_ISSUE_QTY_X VARCHAR(50);
DECLARE VARIABLE WK_DEF_ISSUE_QTY_X VARCHAR(50);
DECLARE VARIABLE WK_RECORD_ID INTEGER;
DECLARE VARIABLE WK_ERROR_TEXT  VARCHAR(70);
BEGIN
   WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
   IF (WK_AUTORUN = 1) THEN
   BEGIN
      IF (NEW.TRN_TYPE = 'PPSP') THEN
      BEGIN
         /* check exists */
         WK_FOUND = 0;
         WK_PROD_ID = NEW.OBJECT;
         WK_WH_ID = NEW.WH_ID;
         WK_LOCN_ID = NEW.LOCN_ID;
         WK_SUBLOCN_ID = NEW.SUB_LOCN_ID;
         WK_REF_ID = NEW.REFERENCE;
         WK_QTY = NEW.QTY;
         WK_USER = NEW.PERSON_ID;
         WK_DEVICE = NEW.DEVICE_ID;
         WK_DATE = NEW.TRN_DATE;
         WK_RECORD_ID = NEW.RECORD_ID;

/*
         WK_LOCN_2 = WK_WH_ID || WK_LOCN_ID;
*/
/*
         WK_REF_2 = WK_SUBLOCN_ID || WK_REF_ID;
*/
         WK_REF_2 = WK_WH_ID || WK_LOCN_ID || WK_SUBLOCN_ID || WK_REF_ID;
         EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_REF_2, 1  RETURNING_VALUES :WK_PALLET_CFG ; 
         EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_REF_2, 2  RETURNING_VALUES :WK_PERM ; 
         EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_REF_2, 3  RETURNING_VALUES :WK_TURNOVER ; 

         EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_REF_2, 4  RETURNING_VALUES :WK_NET_WT_X ; 
         EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_REF_2, 5  RETURNING_VALUES :WK_MAX_QTY_X ; 
         EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_REF_2, 6  RETURNING_VALUES :WK_MIN_QTY_X;
         EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_REF_2, 7  RETURNING_VALUES :WK_REORDER_QTY_X;
         EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_REF_2, 8  RETURNING_VALUES :WK_MAX_ISSUE_QTY_X;
         EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_REF_2, 9  RETURNING_VALUES :WK_DEF_ISSUE_QTY_X;
         WK_NET_WT = CAST(WK_NET_WT_X AS INTEGER);
         WK_MAX_QTY = CAST(WK_MAX_QTY_X AS INTEGER);
         WK_MIN_QTY = CAST(WK_MIN_QTY_X AS INTEGER);
         WK_REORDER_QTY = CAST(WK_REORDER_QTY_X AS INTEGER);
         WK_MAX_ISSUE_QTY = CAST(WK_MAX_ISSUE_QTY_X AS INTEGER);
         WK_DEF_ISSUE_QTY = CAST(WK_DEF_ISSUE_QTY_X AS INTEGER);

         SELECT 1 FROM PROD_PROFILE   
         WHERE PROD_ID = :WK_PROD_ID
         INTO :WK_FOUND;
         IF (WK_FOUND IS NULL) THEN
         BEGIN
            WK_FOUND = 0;
         END
         IF (WK_FOUND = 0) THEN
         BEGIN
            INSERT INTO PROD_PROFILE (PROD_ID, SHORT_DESC, PALLET_CFG_C, PERM_LEVEL, TOG_C, NET_WEIGHT, MAX_QTY, MIN_QTY, REORDER_QTY, MAX_ISSUE_QTY, DEFAULT_ISSUE_QTY, SALE_PRICE, LAST_UPDATE_DATE, LAST_UPDATE_BY)
            VALUES (:WK_PROD_ID, :WK_PROD_ID, :WK_PALLET_CFG, :WK_PERM, :WK_TURNOVER, :WK_NET_WT, :WK_MAX_QTY, :WK_MIN_QTY, :WK_REORDER_QTY, :WK_MAX_ISSUE_QTY, :WK_DEF_ISSUE_QTY,  :WK_QTY/100, :WK_DATE, :WK_USER);
         END
         ELSE
         BEGIN
            UPDATE PROD_PROFILE SET  
            PALLET_CFG_C =  :WK_PALLET_CFG, 
            PERM_LEVEL =  :WK_PERM, 
            TOG_C =  :WK_TURNOVER, 
            NET_WEIGHT =  :WK_NET_WT, 
            MAX_QTY =  :WK_MAX_QTY, 
            MIN_QTY =  :WK_MIN_QTY, 
            REORDER_QTY =  :WK_REORDER_QTY, 
            MAX_ISSUE_QTY =  :WK_MAX_ISSUE_QTY, 
            DEFAULT_ISSUE_QTY =  :WK_DEF_ISSUE_QTY, 
            SALE_PRICE =  :WK_QTY / 100, 
            LAST_UPDATE_DATE =  :WK_DATE, 
            LAST_UPDATE_BY = :WK_USER
            WHERE PROD_ID = :WK_PROD_ID;
         END
         /* EXECUTE PROCEDURE UPDATE_TRAN (:WK_RECORD_ID, 'T','Processed successfully'); */
         WK_ERROR_TEXT = 'Processed successfully';
         UPDATE TRANSACTIONS SET COMPLETE='T',ERROR_TEXT=:WK_ERROR_TEXT WHERE RECORD_ID = :WK_RECORD_ID;
         /* EXECUTE PROCEDURE TRAN_ARCHIVE; */
      END
   END
END ^

CREATE TRIGGER RUN_TRANSACTION_GRNC FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 110 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_RECORD  INTEGER;
DECLARE VARIABLE WK_OBJECT  VARCHAR(30);
DECLARE VARIABLE WK_REFERENCE  VARCHAR(40);
DECLARE VARIABLE WK_WH_ID CHAR(2);
DECLARE VARIABLE WK_LOCN_ID  VARCHAR(10);
DECLARE VARIABLE WK_SUBLOCN  VARCHAR(10);
DECLARE VARIABLE WK_COMMENT  VARCHAR(80);
DECLARE VARIABLE WK_COMMENT_TXT  VARCHAR(80);
DECLARE VARIABLE WK_QTY  INTEGER;
DECLARE VARIABLE WK_GRN  VARCHAR(10);
DECLARE VARIABLE WK_USER  VARCHAR(10);
DECLARE VARIABLE WK_DEVICE  VARCHAR(2);
DECLARE VARIABLE WK_DATE TIMESTAMP;
DECLARE VARIABLE WK_ERROR_TEXT  VARCHAR(70);
DECLARE VARIABLE WK_CURRENT_COMMENT  VARCHAR(258);
DECLARE VARIABLE WK_NOTE_STR  VARCHAR(258);
DECLARE VARIABLE WK_LEN_NOW  INTEGER;
DECLARE VARIABLE WK_LEN_WAS  INTEGER;
DECLARE VARIABLE WK_START_POSN  INTEGER;
DECLARE VARIABLE WK_END_POSN  INTEGER;
DECLARE VARIABLE WK_ERROR  VARCHAR(10);
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'GRNC') THEN
  BEGIN
     WK_RECORD = NEW.RECORD_ID; 
     WK_ERROR_TEXT = 'Processed successfully';
     WK_OBJECT = NEW.OBJECT;
     WK_WH_ID = NEW.WH_ID;
     WK_LOCN_ID = NEW.LOCN_ID;
     WK_SUBLOCN = NEW.SUB_LOCN_ID;
     WK_GRN = WK_SUBLOCN;
     WK_REFERENCE = NEW.REFERENCE;
     WK_QTY = NEW.QTY;
     WK_USER = NEW.PERSON_ID;
     WK_DEVICE = NEW.DEVICE_ID;
     WK_DATE = NEW.TRN_DATE;
     WK_COMMENT = WK_OBJECT || WK_WH_ID || WK_LOCN_ID || WK_REFERENCE;
     EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_COMMENT, 1  RETURNING_VALUES :WK_COMMENT_TXT ; 
     EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_COMMENT, 2  RETURNING_VALUES :WK_ERROR ; 
     WK_CURRENT_COMMENT = '';
     SELECT COMMENTS
        FROM GRN
        WHERE GRN = :WK_GRN
        INTO :WK_CURRENT_COMMENT;
     IF (WK_CURRENT_COMMENT IS NULL) THEN
     BEGIN
        WK_CURRENT_COMMENT = '';
     END

 /* get comment in 255 */
     WK_LEN_NOW = STRLEN(WK_COMMENT_TXT);
     WK_LEN_WAS = STRLEN(WK_CURRENT_COMMENT);
     IF (255 < (WK_LEN_WAS + WK_LEN_NOW )) THEN
     BEGIN
        /* too long so trim the current */
        WK_END_POSN = WK_LEN_WAS + 1;
        WK_START_POSN = (WK_LEN_WAS + WK_LEN_NOW) - 254;
        WK_CURRENT_COMMENT = WK_CURRENT_COMMENT || '  ';
        WK_NOTE_STR = VSUBSTRING(WK_CURRENT_COMMENT, WK_START_POSN, WK_END_POSN);
     END
     ELSE
     BEGIN
        WK_NOTE_STR = WK_CURRENT_COMMENT;
     END
     IF (WK_ERROR = 'T') THEN
     BEGIN
        UPDATE GRN
           SET COMMENTS = :WK_NOTE_STR || :WK_COMMENT_TXT,
           RECEIPT_FLAG = 'T'
           WHERE GRN = :WK_GRN;
     END
     ELSE
     BEGIN
        UPDATE GRN
           SET COMMENTS = :WK_NOTE_STR || :WK_COMMENT_TXT
           WHERE GRN = :WK_GRN;
     END
     UPDATE TRANSACTIONS SET COMPLETE='T',ERROR_TEXT=:WK_ERROR_TEXT WHERE RECORD_ID = :WK_RECORD;
   /* EXECUTE PROCEDURE TRAN_ARCHIVE; */
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_NIOC FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 111 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'NIOC') THEN
  BEGIN
   EXECUTE PROCEDURE PC_NIXX 
    NEW.RECORD_ID ,
    NEW.WH_ID,
    NEW.LOCN_ID,
    NEW.OBJECT,
    'NIOK',
    NEW.TRN_CODE,
    NEW.TRN_DATE,
    NEW.REFERENCE,
    NEW.QTY,
    NEW.PERSON_ID,
    NEW.DEVICE_ID,
    NEW.INSTANCE_ID;
   EXECUTE PROCEDURE TRAN_ARCHIVE;
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_NIOD FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 112 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'NIOD') THEN
  BEGIN
   EXECUTE PROCEDURE PC_NIXX 
    NEW.RECORD_ID ,
    NEW.WH_ID,
    NEW.LOCN_ID,
    NEW.OBJECT,
    'NIOL',
    NEW.TRN_CODE,
    NEW.TRN_DATE,
    NEW.REFERENCE,
    NEW.QTY,
    NEW.PERSON_ID,
    NEW.DEVICE_ID,
    NEW.INSTANCE_ID;
   EXECUTE PROCEDURE TRAN_ARCHIVE;
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_PPCP FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 113 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_FOUND INTEGER;
DECLARE VARIABLE WK_PROD_ID VARCHAR(30);
DECLARE VARIABLE WK_WH_ID CHAR(2);
DECLARE VARIABLE WK_LOCN_ID VARCHAR(10);
DECLARE VARIABLE WK_SUBLOCN_ID VARCHAR(10);
DECLARE VARIABLE WK_REF_ID VARCHAR(40);
DECLARE VARIABLE WK_QTY INTEGER;
DECLARE VARIABLE WK_USER VARCHAR(10);
DECLARE VARIABLE WK_DEVICE CHAR(2);
DECLARE VARIABLE WK_DATE TIMESTAMP;
DECLARE VARIABLE WK_COMPANY VARCHAR(10);
DECLARE VARIABLE WK_PROD_RETRIEVE_STATUS VARCHAR(1);
DECLARE VARIABLE WK_RECORD_ID INTEGER;
BEGIN
   WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
   IF (WK_AUTORUN = 1) THEN
   BEGIN
      IF (NEW.TRN_TYPE = 'PPCP') THEN
      BEGIN
         /* check exists */
         WK_FOUND = 0;
         WK_PROD_ID = NEW.OBJECT;
         WK_WH_ID = NEW.WH_ID;
         WK_LOCN_ID = NEW.LOCN_ID;
         WK_SUBLOCN_ID = NEW.SUB_LOCN_ID;
         WK_REF_ID = NEW.REFERENCE;
         WK_QTY = NEW.QTY;
         WK_USER = NEW.PERSON_ID;
         WK_DEVICE = NEW.DEVICE_ID;
         WK_DATE = NEW.TRN_DATE;
         WK_RECORD_ID = NEW.RECORD_ID;

         WK_COMPANY = SUBSTR(WK_REF_ID, 1, 10);
         EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_REF_ID, 1  RETURNING_VALUES :WK_COMPANY ; 
         EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_REF_ID, 2  RETURNING_VALUES :WK_PROD_RETRIEVE_STATUS ; 

         SELECT 1 FROM PROD_PROFILE   
         WHERE PROD_ID = :WK_PROD_ID
         INTO :WK_FOUND;
         IF (WK_FOUND IS NULL) THEN
         BEGIN
            WK_FOUND = 0;
         END
         IF (WK_FOUND = 0) THEN
         BEGIN
            INSERT INTO PROD_PROFILE (PROD_ID, SHORT_DESC, COMPANY_ID, PROD_RETRIEVE_STATUS, LAST_UPDATE_DATE, LAST_UPDATE_BY)
            VALUES (:WK_PROD_ID, :WK_PROD_ID, :WK_COMPANY, :WK_PROD_RETRIEVE_STATUS, :WK_DATE, :WK_USER);
         END
         ELSE
         BEGIN
            UPDATE PROD_PROFILE SET  
            COMPANY_ID =  :WK_COMPANY, 
            PROD_RETRIEVE_STATUS =  :WK_PROD_RETRIEVE_STATUS, 
            LAST_UPDATE_DATE =  :WK_DATE, 
            LAST_UPDATE_BY = :WK_USER
            WHERE PROD_ID = :WK_PROD_ID;
         END
         EXECUTE PROCEDURE UPDATE_TRAN (:WK_RECORD_ID, 'T','Processed successfully');
         /* EXECUTE PROCEDURE TRAN_ARCHIVE; */
      END
   END
END ^

CREATE TRIGGER RUN_TRANSACTION_PPPK FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 114 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_FOUND INTEGER;
DECLARE VARIABLE WK_PROD_ID VARCHAR(30);
DECLARE VARIABLE WK_WH_ID CHAR(2);
DECLARE VARIABLE WK_LOCN_ID VARCHAR(10);
DECLARE VARIABLE WK_SUBLOCN_ID VARCHAR(10);
DECLARE VARIABLE WK_REF_ID VARCHAR(255);
DECLARE VARIABLE WK_QTY INTEGER;
DECLARE VARIABLE WK_USER VARCHAR(10);
DECLARE VARIABLE WK_DEVICE CHAR(2);
DECLARE VARIABLE WK_DATE TIMESTAMP;
DECLARE VARIABLE WK_REF_2 VARCHAR(280);
DECLARE VARIABLE WK_TOG VARCHAR(2);
DECLARE VARIABLE WK_PERM VARCHAR(1);
DECLARE VARIABLE WK_PALLET_CFG_INNER VARCHAR(2);
DECLARE VARIABLE WK_PALLET_CFG VARCHAR(2);
DECLARE VARIABLE WK_ISSUE_X VARCHAR(10);
DECLARE VARIABLE WK_ISSUE INTEGER;
DECLARE VARIABLE WK_ISSUE_UOM VARCHAR(2);
DECLARE VARIABLE WK_ISSUE_PER_INNER_X VARCHAR(10);
DECLARE VARIABLE WK_ISSUE_PER_INNER INTEGER;
DECLARE VARIABLE WK_NET_WEIGHT_UOM VARCHAR(2);
DECLARE VARIABLE WK_NET_WEIGHT_X VARCHAR(10);
DECLARE VARIABLE WK_NET_WEIGHT DECIMAL(4,2);
DECLARE VARIABLE WK_INNER_UOM VARCHAR(2);
DECLARE VARIABLE WK_INNER_WEIGHT_X VARCHAR(10);
DECLARE VARIABLE WK_INNER_WEIGHT DECIMAL(4,2);
DECLARE VARIABLE WK_INNER_WEIGHT_UOM VARCHAR(2);
DECLARE VARIABLE WK_ISSUE_PER_ORDER_X VARCHAR(10);
DECLARE VARIABLE WK_ISSUE_PER_ORDER INTEGER;
DECLARE VARIABLE WK_ORDER_UOM VARCHAR(2);
DECLARE VARIABLE WK_ORDER_WEIGHT_UOM VARCHAR(2);
DECLARE VARIABLE WK_RECORD_ID INTEGER;
BEGIN
   WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
   IF (WK_AUTORUN = 1) THEN
   BEGIN
      IF (NEW.TRN_TYPE = 'PPPK') THEN
      BEGIN
         /* check exists */
         WK_FOUND = 0;
         WK_PROD_ID = NEW.OBJECT;
         WK_WH_ID = NEW.WH_ID;
         WK_LOCN_ID = NEW.LOCN_ID;
         WK_SUBLOCN_ID = NEW.SUB_LOCN_ID;
         WK_REF_ID = NEW.REFERENCE;
         WK_QTY = NEW.QTY;
         WK_USER = NEW.PERSON_ID;
         WK_DEVICE = NEW.DEVICE_ID;
         WK_DATE = NEW.TRN_DATE;
         WK_RECORD_ID = NEW.RECORD_ID;

         WK_REF_2 = WK_WH_ID || WK_LOCN_ID || WK_SUBLOCN_ID || WK_REF_ID;
         WK_TOG = '';
         WK_PERM = '';
         WK_PALLET_CFG_INNER = '';
         WK_PALLET_CFG = '';
         WK_ISSUE_X = '';
         WK_ISSUE_UOM = '';
         WK_NET_WEIGHT_X  = '';
         WK_NET_WEIGHT_UOM  = '';
         WK_ISSUE_PER_INNER_X = '';
         WK_INNER_UOM = '';
         WK_INNER_WEIGHT_X = '';
         WK_INNER_WEIGHT_UOM = '';
         WK_ISSUE_PER_ORDER_X = '';
         WK_ORDER_UOM = '';
         WK_ORDER_WEIGHT_UOM = '';
         /* EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_REF_2, 1  RETURNING_VALUES :WK_TOG ;  */
         /* EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_REF_2, 2  RETURNING_VALUES :WK_PERM; */
         /* EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_REF_2, 3  RETURNING_VALUES :WK_PALLET_CFG_INNER; */
         /* EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_REF_2, 4  RETURNING_VALUES :WK_PALLET_CFG; */
         /* EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_REF_2, 5  RETURNING_VALUES :WK_ISSUE_X; */
         /* EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_REF_2, 6  RETURNING_VALUES :WK_ISSUE_UOM; */
         /* EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_REF_2, 7  RETURNING_VALUES :WK_NET_WEIGHT_X ; */
         /* EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_REF_2, 8  RETURNING_VALUES :WK_NET_WEIGHT_UOM ; */
         /* EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_REF_2, 9  RETURNING_VALUES :WK_ISSUE_PER_INNER_X ;  */
         /* EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_REF_2, 10  RETURNING_VALUES :WK_INNER_UOM; */
         /* EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_REF_2, 11  RETURNING_VALUES :WK_INNER_WEIGHT_X ; */
         /* EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_REF_2, 12  RETURNING_VALUES :WK_INNER_WEIGHT_UOM; */
         /* EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_REF_2, 13  RETURNING_VALUES :WK_ISSUE_PER_ORDER_X ; */
         /* EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_REF_2, 14  RETURNING_VALUES :WK_ORDER_UOM; */
         /* EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_REF_2, 15  RETURNING_VALUES :WK_ORDER_WEIGHT_UOM; */
         SELECT WK_FIELD_TEXT FROM GET_REFERENCE_FIELD4 (:WK_REF_2, 1, '|') INTO :WK_TOG;
         SELECT WK_FIELD_TEXT FROM GET_REFERENCE_FIELD4 (:WK_REF_2, 2, '|') INTO :WK_PERM;
         SELECT WK_FIELD_TEXT FROM GET_REFERENCE_FIELD4 (:WK_REF_2, 3, '|') INTO :WK_PALLET_CFG_INNER;
         SELECT WK_FIELD_TEXT FROM GET_REFERENCE_FIELD4 (:WK_REF_2, 4, '|') INTO :WK_PALLET_CFG;
         SELECT WK_FIELD_TEXT FROM GET_REFERENCE_FIELD4 (:WK_REF_2, 5, '|') INTO :WK_ISSUE_X;
         SELECT WK_FIELD_TEXT FROM GET_REFERENCE_FIELD4 (:WK_REF_2, 6, '|') INTO :WK_ISSUE_UOM;
         SELECT WK_FIELD_TEXT FROM GET_REFERENCE_FIELD4 (:WK_REF_2, 7, '|') INTO :WK_NET_WEIGHT_X ;
         SELECT WK_FIELD_TEXT FROM GET_REFERENCE_FIELD4 (:WK_REF_2, 8, '|') INTO :WK_NET_WEIGHT_UOM ;
         SELECT WK_FIELD_TEXT FROM GET_REFERENCE_FIELD4 (:WK_REF_2, 9, '|') INTO :WK_ISSUE_PER_INNER_X ;
         SELECT WK_FIELD_TEXT FROM GET_REFERENCE_FIELD4 (:WK_REF_2, 10, '|') INTO :WK_INNER_UOM;
         SELECT WK_FIELD_TEXT FROM GET_REFERENCE_FIELD4 (:WK_REF_2, 11, '|') INTO :WK_INNER_WEIGHT_X ;
         SELECT WK_FIELD_TEXT FROM GET_REFERENCE_FIELD4 (:WK_REF_2, 12, '|') INTO :WK_INNER_WEIGHT_UOM ;
         SELECT WK_FIELD_TEXT FROM GET_REFERENCE_FIELD4 (:WK_REF_2, 13, '|') INTO :WK_ISSUE_PER_ORDER_X ;
         SELECT WK_FIELD_TEXT FROM GET_REFERENCE_FIELD4 (:WK_REF_2, 14, '|') INTO :WK_ORDER_UOM ;
         SELECT WK_FIELD_TEXT FROM GET_REFERENCE_FIELD4 (:WK_REF_2, 15, '|') INTO :WK_ORDER_WEIGHT_UOM ;

         IF (WK_ISSUE_PER_INNER_X = '') THEN
            WK_ISSUE_PER_INNER_X = '0';
         IF (WK_ISSUE_X = '') THEN
            WK_ISSUE_X = '0';
         IF (WK_NET_WEIGHT_X = '') THEN
            WK_NET_WEIGHT_X = '0';
         IF (WK_INNER_WEIGHT_X = '') THEN
            WK_INNER_WEIGHT_X = '0';
         IF (WK_ISSUE_PER_ORDER_X = '') THEN
            WK_ISSUE_PER_ORDER_X = '0';

         WK_ISSUE_PER_INNER = CAST(WK_ISSUE_PER_INNER_X AS INTEGER);
         WK_ISSUE = CAST(WK_ISSUE_X AS INTEGER);
         WK_NET_WEIGHT = CAST(WK_NET_WEIGHT_X AS DECIMAL(4,2));
         WK_INNER_WEIGHT = CAST(WK_INNER_WEIGHT_X AS DECIMAL(4,2));
         WK_ISSUE_PER_ORDER = CAST(WK_ISSUE_PER_ORDER_X AS INTEGER);

         SELECT 1 FROM PROD_PROFILE   
         WHERE PROD_ID = :WK_PROD_ID
         INTO :WK_FOUND;
         IF (WK_FOUND IS NULL) THEN
         BEGIN
            WK_FOUND = 0;
         END
         IF (WK_FOUND = 0) THEN
         BEGIN
            INSERT INTO PROD_PROFILE (
               PROD_ID, 
               SHORT_DESC, 
               TOG_C, 
               PERM_LEVEL, 
               PALLET_CFG_INNER, 
               PALLET_CFG_C, 
               ISSUE, 
               ISSUE_UOM, 
               NET_WEIGHT, 
               NET_WEIGHT_UOM, 
               ISSUE_PER_INNER_UNIT, 
               INNER_UOM, 
               INNER_WEIGHT, 
               INNER_WEIGHT_UOM, 
               ISSUE_PER_ORDER_UNIT, 
               ORDER_UOM, 
               ORDER_WEIGHT_UOM, 
               ORDER_WEIGHT, 
               LAST_UPDATE_DATE, 
               LAST_UPDATE_BY)
             VALUES (
               :WK_PROD_ID, 
               :WK_PROD_ID, 
               :WK_TOG, 
               :WK_PERM, 
               :WK_PALLET_CFG_INNER, 
               :WK_PALLET_CFG, 
               :WK_ISSUE, 
               :WK_ISSUE_UOM, 
               :WK_NET_WEIGHT, 
               :WK_NET_WEIGHT_UOM, 
               :WK_ISSUE_PER_INNER ,
               :WK_INNER_UOM, 
               :WK_INNER_WEIGHT, 
               :WK_INNER_WEIGHT_UOM, 
               :WK_ISSUE_PER_ORDER ,
               :WK_ORDER_UOM, 
               :WK_ORDER_WEIGHT_UOM, 
               :WK_QTY,  
               :WK_DATE, 
               :WK_USER);
         END
         ELSE
         BEGIN
            UPDATE PROD_PROFILE SET  
               TOG_C =  :WK_TOG, 
               PERM_LEVEL =  :WK_PERM, 
               PALLET_CFG_INNER =  :WK_PALLET_CFG_INNER, 
               PALLET_CFG_C =  :WK_PALLET_CFG, 
               ISSUE =  :WK_ISSUE, 
               ISSUE_UOM =  :WK_ISSUE_UOM, 
               NET_WEIGHT =  :WK_NET_WEIGHT, 
               NET_WEIGHT_UOM =  :WK_NET_WEIGHT_UOM, 
               ISSUE_PER_INNER_UNIT =  :WK_ISSUE_PER_INNER ,
               INNER_UOM =  :WK_INNER_UOM, 
               INNER_WEIGHT =  :WK_INNER_WEIGHT, 
               INNER_WEIGHT_UOM =  :WK_INNER_WEIGHT_UOM, 
               ISSUE_PER_ORDER_UNIT =  :WK_ISSUE_PER_ORDER ,
               ORDER_UOM =  :WK_ORDER_UOM, 
               ORDER_WEIGHT_UOM =  :WK_ORDER_WEIGHT_UOM, 
               ORDER_WEIGHT =  :WK_QTY,  
               LAST_UPDATE_DATE =  :WK_DATE, 
               LAST_UPDATE_BY = :WK_USER
            WHERE PROD_ID = :WK_PROD_ID;
         END
         EXECUTE PROCEDURE UPDATE_TRAN (:WK_RECORD_ID, 'T','Processed successfully');
         /* EXECUTE PROCEDURE TRAN_ARCHIVE; */
      END
   END
END ^

CREATE TRIGGER RUN_TRANSACTION_PPPP FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 115 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_FOUND INTEGER;
DECLARE VARIABLE WK_PROD_ID VARCHAR(30);
DECLARE VARIABLE WK_WH_ID CHAR(2);
DECLARE VARIABLE WK_LOCN_ID VARCHAR(10);
DECLARE VARIABLE WK_SUBLOCN_ID VARCHAR(10);
DECLARE VARIABLE WK_REF_ID VARCHAR(40);
DECLARE VARIABLE WK_QTY INTEGER;
DECLARE VARIABLE WK_USER VARCHAR(10);
DECLARE VARIABLE WK_DEVICE CHAR(2);
DECLARE VARIABLE WK_DATE TIMESTAMP;
DECLARE VARIABLE WK_REF_2 VARCHAR(60);
DECLARE VARIABLE WK_PALLET_CFG VARCHAR(2);
DECLARE VARIABLE WK_PALLET_CARTONS_X VARCHAR(10);
DECLARE VARIABLE WK_PALLET_CARTONS INTEGER;
DECLARE VARIABLE WK_PALLET_LAYERS_X VARCHAR(10);
DECLARE VARIABLE WK_PALLET_LAYERS INTEGER;
DECLARE VARIABLE WK_PALLET_DESC VARCHAR(50);
DECLARE VARIABLE WK_RECORD_ID INTEGER;
DECLARE VARIABLE WK_DUMMY INTEGER;
BEGIN
   WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
   IF (WK_AUTORUN = 1) THEN
   BEGIN
      IF (NEW.TRN_TYPE = 'PPPP') THEN
      BEGIN
         /* check exists */
         WK_FOUND = 0;
         WK_PROD_ID = NEW.OBJECT;
         WK_WH_ID = NEW.WH_ID;
         WK_LOCN_ID = NEW.LOCN_ID;
         WK_SUBLOCN_ID = NEW.SUB_LOCN_ID;
         WK_REF_ID = NEW.REFERENCE;
         WK_QTY = NEW.QTY;
         WK_USER = NEW.PERSON_ID;
         WK_DEVICE = NEW.DEVICE_ID;
         WK_DATE = NEW.TRN_DATE;
         WK_RECORD_ID = NEW.RECORD_ID;

  WK_REF_2 = WK_WH_ID || WK_LOCN_ID || WK_SUBLOCN_ID ;
         EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_REF_2, 1  RETURNING_VALUES :WK_PALLET_CFG ; 
         EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_REF_2, 2  RETURNING_VALUES :WK_PALLET_CARTONS_X; 
         EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_REF_2, 3  RETURNING_VALUES :WK_PALLET_LAYERS_X; 
  WK_PALLET_DESC = WK_REF_ID ;

         IF (WK_PALLET_CARTONS_X = '') THEN
            WK_DUMMY = 0;
         ELSE
            WK_PALLET_CARTONS = CAST(WK_PALLET_CARTONS_X AS INTEGER);
         IF (WK_PALLET_LAYERS_X = '') THEN
            WK_DUMMY = 0;
         ELSE
            WK_PALLET_LAYERS = CAST(WK_PALLET_LAYERS_X AS INTEGER);
          
         /* do pallet */
         SELECT 1 FROM PALLET_CFG   
         WHERE PALLET_CFG_CODE = :WK_PALLET_CFG
         INTO :WK_FOUND;
         IF (WK_FOUND IS NULL) THEN
         BEGIN
            WK_FOUND = 0;
         END
         IF (WK_FOUND = 0) THEN
         BEGIN
            IF (WK_PALLET_CARTONS_X > '') THEN
            BEGIN
               IF (WK_PALLET_LAYERS_X > '') THEN
               BEGIN
                  IF (WK_PALLET_DESC > '') THEN
                  BEGIN
                     /* have all 3 */
                     INSERT INTO PALLET_CFG(PALLET_CFG_CODE, PALLET_CFG_DESCRIPTION, TOTAL_CARTONS_LAYER, TOTAL_LAYERS) VALUES(:WK_PALLET_CFG, :WK_PALLET_DESC, :WK_PALLET_CARTONS, :WK_PALLET_LAYERS);
                  END
                  ELSE
                  BEGIN
                     /* have all bar desc */
                     INSERT INTO PALLET_CFG(PALLET_CFG_CODE, PALLET_CFG_DESCRIPTION, TOTAL_CARTONS_LAYER, TOTAL_LAYERS) VALUES(:WK_PALLET_CFG, :WK_PALLET_CFG, :WK_PALLET_CARTONS, :WK_PALLET_LAYERS);
                  END
               END
               ELSE
               BEGIN
                  IF (WK_PALLET_DESC > '') THEN
                  BEGIN
                     /* have all bar layers */
                     INSERT INTO PALLET_CFG(PALLET_CFG_CODE, PALLET_CFG_DESCRIPTION, TOTAL_CARTONS_LAYER ) VALUES(:WK_PALLET_CFG, :WK_PALLET_DESC, :WK_PALLET_CARTONS );
                  END
                  ELSE
                  BEGIN
                     /* have only cartons */
                     INSERT INTO PALLET_CFG(PALLET_CFG_CODE, PALLET_CFG_DESCRIPTION, TOTAL_CARTONS_LAYER ) VALUES(:WK_PALLET_CFG, :WK_PALLET_CFG, :WK_PALLET_CARTONS );
                  END
               END
            END
            ELSE
            BEGIN
               IF (WK_PALLET_LAYERS_X > '') THEN
               BEGIN
                  IF (WK_PALLET_DESC > '') THEN
                  BEGIN
                     /* have all bar cartons */
                     INSERT INTO PALLET_CFG(PALLET_CFG_CODE, PALLET_CFG_DESCRIPTION, TOTAL_LAYERS) VALUES(:WK_PALLET_CFG, :WK_PALLET_DESC, :WK_PALLET_LAYERS);
                  END
                  ELSE
                  BEGIN
                     /* have only layers */
                     INSERT INTO PALLET_CFG(PALLET_CFG_CODE, PALLET_CFG_DESCRIPTION, TOTAL_LAYERS) VALUES(:WK_PALLET_CFG, :WK_PALLET_CFG, :WK_PALLET_LAYERS);
                  END
               END
               ELSE
               BEGIN
                  IF (WK_PALLET_DESC > '') THEN
                  BEGIN
                     /* have only desc */
                     INSERT INTO PALLET_CFG(PALLET_CFG_CODE, PALLET_CFG_DESCRIPTION ) VALUES(:WK_PALLET_CFG, :WK_PALLET_DESC );
                  END
                  ELSE
                  BEGIN
                     /* have nothing */
                     INSERT INTO PALLET_CFG(PALLET_CFG_CODE, PALLET_CFG_DESCRIPTION ) VALUES(:WK_PALLET_CFG, :WK_PALLET_CFG );
                  END
               END
            END
         END
         ELSE
         BEGIN
            /* already exists - so update it */
            IF (WK_PALLET_CARTONS_X > '') THEN
            BEGIN
               IF (WK_PALLET_LAYERS_X > '') THEN
               BEGIN
                  IF (WK_PALLET_DESC > '') THEN
                  BEGIN
                     /* have all 3 */
                     UPDATE PALLET_CFG SET 
                        PALLET_CFG_DESCRIPTION = :WK_PALLET_DESC, 
                        TOTAL_CARTONS_LAYER = :WK_PALLET_CARTONS, 
                        TOTAL_LAYERS = :WK_PALLET_LAYERS
                        WHERE PALLET_CFG_CODE = :WK_PALLET_CFG;
                  END
                  ELSE
                  BEGIN
                     /* have all bar desc */
                     UPDATE PALLET_CFG SET 
                        TOTAL_CARTONS_LAYER = :WK_PALLET_CARTONS, 
                        TOTAL_LAYERS = :WK_PALLET_LAYERS
                        WHERE PALLET_CFG_CODE = :WK_PALLET_CFG;
                  END
               END
               ELSE
               BEGIN
                  IF (WK_PALLET_DESC > '') THEN
                  BEGIN
                     /* have all bar layers */
                     UPDATE PALLET_CFG SET 
                        PALLET_CFG_DESCRIPTION = :WK_PALLET_DESC, 
                        TOTAL_CARTONS_LAYER = :WK_PALLET_CARTONS 
                        WHERE PALLET_CFG_CODE = :WK_PALLET_CFG;
                  END
                  ELSE
                  BEGIN
                     /* have only cartons */
                     UPDATE PALLET_CFG SET 
                        TOTAL_CARTONS_LAYER = :WK_PALLET_CARTONS 
                        WHERE PALLET_CFG_CODE = :WK_PALLET_CFG;
                  END
               END
            END
            ELSE
            BEGIN
               IF (WK_PALLET_LAYERS_X > '') THEN
               BEGIN
                  IF (WK_PALLET_DESC > '') THEN
                  BEGIN
                     /* have all bar cartons */
                     UPDATE PALLET_CFG SET 
                        PALLET_CFG_DESCRIPTION = :WK_PALLET_DESC, 
                        TOTAL_LAYERS = :WK_PALLET_LAYERS
                        WHERE PALLET_CFG_CODE = :WK_PALLET_CFG;
                  END
                  ELSE
                  BEGIN
                     /* have only layers */
                     UPDATE PALLET_CFG SET 
                        TOTAL_LAYERS = :WK_PALLET_LAYERS
                        WHERE PALLET_CFG_CODE = :WK_PALLET_CFG;
                  END
               END
               ELSE
               BEGIN
                  IF (WK_PALLET_DESC > '') THEN
                  BEGIN
                     /* have only desc */
                     UPDATE PALLET_CFG SET 
                        PALLET_CFG_DESCRIPTION = :WK_PALLET_DESC 
                        WHERE PALLET_CFG_CODE = :WK_PALLET_CFG;
                  END
                  ELSE
                  BEGIN
                     /* have nothing */
                     WK_DUMMY = 1;
                  END
               END
            END
         END
         /* do product */
         SELECT 1 FROM PROD_PROFILE   
         WHERE PROD_ID = :WK_PROD_ID
         INTO :WK_FOUND;
         IF (WK_FOUND IS NULL) THEN
         BEGIN
            WK_FOUND = 0;
         END
         IF (WK_FOUND = 0) THEN
         BEGIN
            IF (WK_QTY = 1) THEN
            BEGIN
               INSERT INTO PROD_PROFILE (
                  PROD_ID, 
                  SHORT_DESC, 
                  PALLET_CFG_C, 
                  LAST_UPDATE_DATE, 
                  LAST_UPDATE_BY)
                VALUES (
                  :WK_PROD_ID, 
                  :WK_PROD_ID, 
                  :WK_PALLET_CFG, 
                  :WK_DATE, 
                  :WK_USER);
            END
            IF (WK_QTY = 2) THEN
            BEGIN
               INSERT INTO PROD_PROFILE (
                  PROD_ID, 
                  SHORT_DESC, 
                  PALLET_CFG_ALTERNATE, 
                  LAST_UPDATE_DATE, 
                  LAST_UPDATE_BY)
                VALUES (
                  :WK_PROD_ID, 
                  :WK_PROD_ID, 
                  :WK_PALLET_CFG, 
                  :WK_DATE, 
                  :WK_USER);
            END
            IF (WK_QTY = 3) THEN
            BEGIN
               INSERT INTO PROD_PROFILE (
                  PROD_ID, 
                  SHORT_DESC, 
                  PALLET_CFG_INNER, 
                  LAST_UPDATE_DATE, 
                  LAST_UPDATE_BY)
                VALUES (
                  :WK_PROD_ID, 
                  :WK_PROD_ID, 
                  :WK_PALLET_CFG, 
                  :WK_DATE, 
                  :WK_USER);
            END
         END
         ELSE
         BEGIN
            IF (WK_QTY = 1) THEN
            BEGIN
               UPDATE PROD_PROFILE SET  
                  PALLET_CFG_C =  :WK_PALLET_CFG, 
                  LAST_UPDATE_DATE =  :WK_DATE, 
                  LAST_UPDATE_BY = :WK_USER
               WHERE PROD_ID = :WK_PROD_ID;
            END
            IF (WK_QTY = 2) THEN
            BEGIN
               UPDATE PROD_PROFILE SET  
                  PALLET_CFG_ALTERNATE =  :WK_PALLET_CFG, 
                  LAST_UPDATE_DATE =  :WK_DATE, 
                  LAST_UPDATE_BY = :WK_USER
               WHERE PROD_ID = :WK_PROD_ID;
            END
            IF (WK_QTY = 3) THEN
            BEGIN
               UPDATE PROD_PROFILE SET  
                  PALLET_CFG_INNER =  :WK_PALLET_CFG, 
                  LAST_UPDATE_DATE =  :WK_DATE, 
                  LAST_UPDATE_BY = :WK_USER
               WHERE PROD_ID = :WK_PROD_ID;
            END
         END
         EXECUTE PROCEDURE UPDATE_TRAN (:WK_RECORD_ID, 'T','Processed successfully');
         /* EXECUTE PROCEDURE TRAN_ARCHIVE; */
      END
   END
END ^

CREATE TRIGGER RUN_TRANSACTION_PLPR FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 116 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_FOUND INTEGER;
DECLARE VARIABLE WK_PROD_ID VARCHAR(30);
DECLARE VARIABLE WK_WH_ID CHAR(2);
DECLARE VARIABLE WK_LOCN_ID VARCHAR(10);
DECLARE VARIABLE WK_SUBLOCN_ID VARCHAR(10);
DECLARE VARIABLE WK_REF_ID VARCHAR(40);
DECLARE VARIABLE WK_QTY INTEGER;
DECLARE VARIABLE WK_USER VARCHAR(10);
DECLARE VARIABLE WK_DEVICE CHAR(2);
DECLARE VARIABLE WK_DATE TIMESTAMP;
DECLARE VARIABLE WK_RECORD_ID INTEGER;

DECLARE VARIABLE WK_LOCATION VARCHAR(12);
DECLARE VARIABLE WK_LABELS_QTY_1X VARCHAR(40);
DECLARE VARIABLE WK_LABELS_QTY_2X VARCHAR(40);
DECLARE VARIABLE WK_PER_LABEL_QTY_1X VARCHAR(40);
DECLARE VARIABLE WK_PER_LABEL_QTY_2X VARCHAR(40);
DECLARE VARIABLE WK_PRINTER VARCHAR(40);
DECLARE VARIABLE WK_DESC VARCHAR(255);
DECLARE VARIABLE WK_LONG_DESC VARCHAR(255);
DECLARE VARIABLE WK_HOME_LOCN VARCHAR(10);
DECLARE VARIABLE WK_DIRECTORY VARCHAR(75);
DECLARE VARIABLE WK_FILENAME VARCHAR(255);
DECLARE VARIABLE WK_LABEL_LINE VARCHAR(390);
DECLARE VARIABLE WK_INSTRUCTIONS VARCHAR(30);
DECLARE VARIABLE WK_RESULT INTEGER;
BEGIN
   WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
   IF (WK_AUTORUN = 1) THEN
   BEGIN
      IF (NEW.TRN_TYPE = 'PLPR') THEN
      BEGIN
         /* check exists */
         WK_FOUND = 0;
         WK_PROD_ID = NEW.OBJECT;
         WK_WH_ID = NEW.WH_ID;
         WK_LOCN_ID = NEW.LOCN_ID;
         WK_QTY = NEW.QTY;
         WK_USER = NEW.PERSON_ID;
         WK_DEVICE = NEW.DEVICE_ID;
         WK_DATE = NEW.TRN_DATE;
         WK_RECORD_ID = NEW.RECORD_ID;

         WK_LOCATION = WK_WH_ID || WK_LOCN_ID;

         WK_INSTRUCTIONS = '';
         SELECT WK_FIELD_TEXT 
         FROM GET_REFERENCE_FIELD4 (NEW.REFERENCE, 2, '|') 
         INTO :WK_LABELS_QTY_1X;
         SELECT WK_FIELD_TEXT 
         FROM GET_REFERENCE_FIELD4 (NEW.REFERENCE, 3, '|') 
         INTO :WK_PER_LABEL_QTY_1X;
         SELECT WK_FIELD_TEXT 
         FROM GET_REFERENCE_FIELD4 (NEW.REFERENCE, 4, '|') 
         INTO :WK_LABELS_QTY_2X;
         SELECT WK_FIELD_TEXT 
         FROM GET_REFERENCE_FIELD4 (NEW.REFERENCE, 5, '|') 
         INTO :WK_PER_LABEL_QTY_2X;
         SELECT WK_FIELD_TEXT 
         FROM GET_REFERENCE_FIELD4 (NEW.REFERENCE, 6, '|') 
         INTO :WK_PRINTER;

         SELECT SHORT_DESC, LONG_DESC, HOME_LOCN_ID FROM PROD_PROFILE   
         WHERE PROD_ID = :WK_PROD_ID
         INTO :WK_DESC, :WK_LONG_DESC, :WK_HOME_LOCN;
         IF (WK_DESC IS NULL) THEN
         BEGIN
            WK_DESC = '';
         END
         IF (WK_LONG_DESC IS NULL) THEN
         BEGIN
            WK_LONG_DESC = '';
         END
          
         IF (WK_DESC = '') THEN
         BEGIN
            WK_DESC = WK_LONG_DESC;
         END
         IF (WK_HOME_LOCN IS NULL) THEN
         BEGIN
            WK_HOME_LOCN = '';
         END

         /* Need the directory for this label set */
         SELECT WORKING_DIRECTORY FROM SYS_EQUIP 
         WHERE DEVICE_ID = :WK_PRINTER
         INTO :WK_DIRECTORY;
  
         WK_FILENAME = WK_DIRECTORY || 'Prod_ID.txt';
       
         WK_LABEL_LINE = '"' || WK_PROD_ID || '","' ||
             WK_DESC || '","' ||
             WK_PRINTER || '",' || 
             WK_LABELS_QTY_1X || ',' ||
             WK_PER_LABEL_QTY_1X || ',' ||
             WK_QTY || ',"' ||
             WK_LOCATION || '","' ||
             WK_HOME_LOCN || '","' ||
             WK_INSTRUCTIONS || '"' ;
         WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE);
         IF (WK_RESULT <> 0) THEN
         BEGIN
            WK_FILENAME = WK_DIRECTORY || 'Prod_ID2.txt';
            WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE);
         END
         IF (WK_RESULT <> 0) THEN
         BEGIN
            EXECUTE PROCEDURE UPDATE_TRAN (:WK_RECORD_ID, 'F','Failed to write File');
         END
         ELSE
         BEGIN
            EXECUTE PROCEDURE UPDATE_TRAN (:WK_RECORD_ID, 'T','Processed successfully');
         END
         /* EXECUTE PROCEDURE TRAN_ARCHIVE; */
      END
   END
END ^

CREATE TRIGGER RUN_TRANSACTION_STPA FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 117 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_DEVICE CHAR(2);
DECLARE VARIABLE WK_USER VARCHAR(10);
DECLARE VARIABLE WK_RECORD INTEGER;
DECLARE VARIABLE WK_SUB_LOCN VARCHAR(10);
DECLARE VARIABLE WK_WH_ID CHAR(2);
DECLARE VARIABLE WK_LOCN_ID VARCHAR(10);
DECLARE VARIABLE WK_OBJECT VARCHAR(30);
DECLARE VARIABLE WK_REF VARCHAR(40);
DECLARE VARIABLE WK_QTY INTEGER;
DECLARE VARIABLE WK_DATE TIMESTAMP;
DECLARE VARIABLE WK_TRN_TYPE VARCHAR(4);
DECLARE VARIABLE WK_TRN_CODE CHAR(1);

DECLARE VARIABLE WK_AUDIT_DESC VARCHAR(40);
DECLARE VARIABLE WK_QTY_REMAINING INTEGER;
DECLARE VARIABLE WK_ALLOWED_STATUS VARCHAR(40);
DECLARE VARIABLE WK_IS_FOUND INTEGER;

DECLARE VARIABLE WK_IS_QTY INTEGER;
DECLARE VARIABLE WK_QTY_TO_USE INTEGER;
DECLARE VARIABLE WK_IS_SSN VARCHAR(20);
DECLARE VARIABLE WK_IS_ORIGINAL_SSN VARCHAR(20);
DECLARE VARIABLE WK_IS_QTY_REMAINING INTEGER;
DECLARE VARIABLE WK_USED_SSN VARCHAR(20);
DECLARE VARIABLE WK_IS_USED_QTY INTEGER;
DECLARE VARIABLE WK_DO_UASL CHAR(1);
DECLARE VARIABLE WK_RECORD2 INTEGER;
DECLARE VARIABLE WK_ISSN_ID INTEGER;
DECLARE VARIABLE SSN_LENGTH INTEGER;
DECLARE VARIABLE WK_ISSN_VALUE VARCHAR(20);
DECLARE VARIABLE WK_COMPANY VARCHAR(20);
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'STPA') THEN
  BEGIN
     WK_DEVICE = NEW.DEVICE_ID;
     WK_SUB_LOCN = NEW.SUB_LOCN_ID;
     WK_WH_ID = NEW.WH_ID;
     WK_LOCN_ID = NEW.LOCN_ID;
     WK_USER = NEW.PERSON_ID;
     WK_OBJECT = NEW.OBJECT;
     WK_REF = ALLTRIM(NEW.REFERENCE);
     WK_QTY = NEW.QTY;
     WK_DATE = NEW.TRN_DATE;
     WK_RECORD = NEW.RECORD_ID;
     WK_TRN_CODE = NEW.TRN_CODE;
     WK_TRN_TYPE = NEW.TRN_TYPE;

     WK_AUDIT_DESC = 'Adjust Product Qty' ;
/*
     in this transaction
     the object is the product
     the qty is the adjustment qty
     the wh_id and locn_id specify the location
     the reference is a comment for the ssn_hist
     the status to select is in the sub_locn_id

*/
     SELECT SEND_UASL_V4 FROM CONTROL INTO :WK_DO_UASL;

     IF (NEW.TRN_CODE = 'P')  THEN
     BEGIN
/*
         qty remaining = adjustment qty
         while (qty required (remaining) < 0) & not at end of issn's
            get an issn for product in the right location 
            and the right status
            if qty required(remaining) > 0 - current_qty
               update issn current_qty to current_qty + qty required
               increase qty required (remaining) by qty took
            if qty required(remaining) = 0 - current_qty
               take all of the issn
               update issn current qty to 0
               increase reduce qty required (remaining) by qty took
         end while
         if now qty required remaining is still < zero - have problem
         not enough stock - so since the level is now zero is ok   

         if now qty required is > 0
         ie was +ve
         must get the 1st issn for product in the right location 
            and the right status
         increase its current qty by the qty remaining

*/
        WK_QTY_REMAINING = WK_QTY;
        WK_ALLOWED_STATUS = WK_SUB_LOCN;
   
        /* must get issns to make up qty to use */
        WK_IS_QTY_REMAINING = 0 - WK_QTY_REMAINING;
        FOR SELECT CURRENT_QTY, SSN_ID, ORIGINAL_SSN
            FROM ISSN
            WHERE PROD_ID = :WK_OBJECT
            AND WH_ID = :WK_WH_ID
            AND LOCN_ID = :WK_LOCN_ID
            AND ISSN_STATUS = :WK_ALLOWED_STATUS
            AND CURRENT_QTY > 0
            INTO :WK_IS_QTY, :WK_IS_SSN, :WK_IS_ORIGINAL_SSN 
        DO
        BEGIN
           IF (WK_IS_QTY_REMAINING > 0) THEN
           BEGIN
              /* how much can I take */
              /* either issn qty or remaining qty if its less */
              WK_USED_SSN = WK_IS_SSN;
              WK_IS_USED_QTY = WK_IS_QTY;
              IF (WK_IS_QTY_REMAINING < WK_IS_QTY) THEN
              BEGIN
                 WK_IS_USED_QTY = WK_IS_QTY_REMAINING;
                 /*  wk_is_qty_remaining */
                 /* so end of issns that we take */
              END
              UPDATE ISSN SET 
               CURRENT_QTY = CURRENT_QTY - :WK_IS_USED_QTY
               WHERE SSN_ID = :WK_USED_SSN;
              UPDATE SSN SET 
               CURRENT_QTY = CURRENT_QTY - :WK_IS_USED_QTY
               WHERE SSN_ID = :WK_IS_ORIGINAL_SSN;
              /* must reduce wk_is_qty_remaining by wk_is_used_qty */
              WK_IS_QTY_REMAINING = WK_IS_QTY_REMAINING - WK_IS_USED_QTY;
              WK_IS_USED_QTY = 0 - WK_IS_USED_QTY;
              EXECUTE PROCEDURE ADD_SSN_HIST(:WK_WH_ID, :WK_LOCN_ID, :WK_USED_SSN, 
                       :WK_TRN_TYPE, :WK_TRN_CODE, :WK_DATE,
                       :WK_AUDIT_DESC , :WK_REF, :WK_IS_USED_QTY, :WK_USER, :WK_DEVICE); 
           END
        END /* end for issns loop */
        /* IF (WK_IS_QTY_REMAINING < 0) THEN */
        BEGIN
           /* must increase the 1st issn for locn and status */
           WK_IS_FOUND = 0;
           SELECT FIRST 1  1, CURRENT_QTY, SSN_ID, ORIGINAL_QTY
               FROM ISSN
               WHERE PROD_ID = :WK_OBJECT
               AND WH_ID = :WK_WH_ID
               AND LOCN_ID = :WK_LOCN_ID
               AND ISSN_STATUS = :WK_ALLOWED_STATUS
               INTO :WK_IS_FOUND, :WK_IS_QTY, :WK_IS_SSN, :WK_IS_ORIGINAL_SSN; 
           IF (WK_IS_FOUND = 1) THEN
           BEGIN
              WK_IS_USED_QTY = 0 - WK_IS_QTY_REMAINING;
              UPDATE ISSN SET 
               CURRENT_QTY = CURRENT_QTY - :WK_IS_QTY_REMAINING
               WHERE SSN_ID = :WK_IS_SSN;
              UPDATE SSN SET 
               CURRENT_QTY = CURRENT_QTY - :WK_IS_QTY_REMAINING
               WHERE SSN_ID = :WK_IS_ORIGINAL_SSN;
              EXECUTE PROCEDURE ADD_SSN_HIST(:WK_WH_ID, :WK_LOCN_ID, :WK_IS_SSN, 
                       :WK_TRN_TYPE, :WK_TRN_CODE, :WK_DATE,
                       :WK_AUDIT_DESC , :WK_REF, :WK_IS_USED_QTY, :WK_USER, :WK_DEVICE); 
              /* must reduce wk_is_qty_remaining by wk_is_used_qty */
   
              WK_IS_QTY_REMAINING = 0;
           END
           ELSE
           BEGIN
              /* none of product in location so create some */
              /* and set its qty to wk_is_qty_remaining */
              WK_IS_USED_QTY = 0 - WK_IS_QTY_REMAINING;
              WK_COMPANY = '';
              SELECT COMPANY_ID
              FROM PROD_PROFILE
              WHERE PROD_ID = :WK_OBJECT
              INTO :WK_COMPANY;
              WK_RECORD2 = GEN_ID(ISSN_SSN_ID, 1);
              WK_ISSN_ID = WK_RECORD2 - 1 ;
              /* Get length for Barcode */   
              EXECUTE PROCEDURE GET_BARCODE_LENGTH RETURNING_VALUES :SSN_LENGTH;
              WK_ISSN_VALUE =  WK_ISSN_ID;
              WHILE (STRLEN(WK_ISSN_VALUE) < SSN_LENGTH) DO
              BEGIN
                 WK_ISSN_VALUE = '0' || WK_ISSN_VALUE;
              END
              INSERT INTO ISSN   
                (SSN_ID, ORIGINAL_SSN, WH_ID, LOCN_ID, PREV_LOCN_ID, CURRENT_QTY, PREV_QTY,
                 PREV_DATE, ISSN_STATUS, CREATE_DATE, USER_ID, PROD_ID, ORIGINAL_QTY, COMPANY_ID)
        
           VALUES (:WK_ISSN_VALUE, :WK_ISSN_VALUE, :WK_WH_ID, :WK_LOCN_ID,'', :WK_IS_USED_QTY, 0,
                   'NOW', :WK_ALLOWED_STATUS, 'NOW', :WK_USER, :WK_OBJECT , :WK_IS_USED_QTY, :WK_COMPANY);
              INSERT INTO SSN (SSN_ID, WH_ID, LOCN_ID, PROD_ID, COMPANY_ID, CURRENT_QTY, ORIGINAL_QTY, CREATE_DATE, CREATED_BY, STATUS_SSN)    
              VALUES (:WK_ISSN_VALUE, :WK_WH_ID, :WK_LOCN_ID, :WK_OBJECT, :WK_COMPANY, :WK_IS_USED_QTY, :WK_IS_USED_QTY, 'NOW', :WK_USER, :WK_ALLOWED_STATUS);
              EXECUTE PROCEDURE ADD_SSN_HIST(:WK_WH_ID, :WK_LOCN_ID, :WK_ISSN_VALUE, 
                    :WK_TRN_TYPE, :WK_TRN_CODE, :WK_DATE,
                    :WK_AUDIT_DESC , :WK_REF, :WK_IS_USED_QTY, :WK_USER, :WK_DEVICE); 
              /* must reduce wk_is_qty_remaining by wk_is_used_qty */
   
              WK_IS_QTY_REMAINING = 0;
           END
        END
        EXECUTE PROCEDURE UPDATE_TRAN (WK_RECORD, 'T','Processed successfully');
        IF (WK_DO_UASL = 'T') THEN
        BEGIN
           EXECUTE PROCEDURE SEND_PICKABLE_STOCK (:WK_OBJECT,
              :WK_USER,
              :WK_DEVICE,
              :WK_DATE);
        END
     END /* of code P */
   EXECUTE PROCEDURE TRAN_ARCHIVE;
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_TRPK FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 118 
AS
/* Transfer of allocated pick to another handheld */
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_DEVICE CHAR(2);
DECLARE VARIABLE WK_DEVICE_FROM CHAR(2);
DECLARE VARIABLE WK_DEVICE_TO CHAR(2);
DECLARE VARIABLE WK_USER VARCHAR(10);
DECLARE VARIABLE WK_RECORD INTEGER;
DECLARE VARIABLE WK_DATE TIMESTAMP;
DECLARE VARIABLE WK_ORDER VARCHAR(30);
DECLARE VARIABLE WK_PROD VARCHAR(30);
DECLARE VARIABLE WK_OVER_SIZED VARCHAR(10);
DECLARE VARIABLE WK_DO_PLAO VARCHAR(10);
DECLARE VARIABLE WK_PRINTER VARCHAR(10);
DECLARE VARIABLE WK_MYREF VARCHAR(40);
DECLARE VARIABLE WK_LINE_CNT INTEGER;
DECLARE VARIABLE WK_LINE_CNT_X VARCHAR(4);
DECLARE VARIABLE WK_LABELS_X VARCHAR(40);
DECLARE VARIABLE WK_LABELS INTEGER;
DECLARE VARIABLE WK_CO_PICK_STATUS VARCHAR(30);
DECLARE VARIABLE WK_ORDER_WH_ID VARCHAR(2);
DECLARE VARIABLE WK_ORDER_LOCN_ID VARCHAR(10);
DECLARE VARIABLE WK_REFERENCE VARCHAR(255);
DECLARE VARIABLE WK_PI_LABEL VARCHAR(10);
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'TRPK') THEN
  BEGIN
     WK_DEVICE_FROM = NEW.WH_ID;
     WK_USER = NEW.PERSON_ID;
     WK_DEVICE = NEW.DEVICE_ID;
     WK_DATE = NEW.TRN_DATE;
     WK_RECORD = NEW.RECORD_ID;
     /* IF (LEN(NEW.SUB_LOCN_ID) = 2) THEN */
     BEGIN
        WK_DEVICE_TO = NEW.SUB_LOCN_ID;
        SELECT PICK_TRANSFER_STATUS
        FROM CONTROL
        INTO :WK_CO_PICK_STATUS;
        IF (WK_CO_PICK_STATUS IS NULL ) THEN
        BEGIN
           WK_CO_PICK_STATUS = ',AL,PG,OP,PL,';
        END
        /* IF (LEN(NEW.SUB_LOCN_ID) = 2) THEN */
        BEGIN
           IF (NEW.TRN_CODE = ' ' OR NEW.TRN_CODE = 'K') THEN
           BEGIN
              /* transfer all picks from one device to another */
              /*   AND PICK_DETAIL_STATUS IN ('AL', 'PG', 'OP', 'PL') */
              UPDATE PICK_ITEM_DETAIL
                 SET DEVICE_ID = :WK_DEVICE_TO
                 WHERE DEVICE_ID = :WK_DEVICE_FROM
                 AND POS(:WK_CO_PICK_STATUS , PICK_DETAIL_STATUS, 0, 1) > -1; 
              /* AND PICK_LINE_STATUS IN ('AL', 'PG', 'OP', 'PL'); */
              UPDATE PICK_ITEM
                 SET DEVICE_ID = :WK_DEVICE_TO
                 WHERE DEVICE_ID = :WK_DEVICE_FROM
                 AND POS(:WK_CO_PICK_STATUS , PICK_LINE_STATUS, 0, 1) > -1; 
              EXECUTE PROCEDURE UPDATE_TRAN (WK_RECORD, 'T','Processed successfully');
           END
           ELSE
           IF (NEW.TRN_CODE = 'P') THEN
           BEGIN
              /* transfer next product from one device to another */
              WK_PROD = NEW.OBJECT;
              WK_OVER_SIZED = NEW.LOCN_ID;
              UPDATE PICK_ITEM_DETAIL
                 SET DEVICE_ID = :WK_DEVICE_TO
                 WHERE PICK_LABEL_NO IN 
                 (SELECT PICK_LABEL_NO 
                  FROM PICK_ITEM 
                  WHERE PROD_ID = :WK_PROD
                  AND DEVICE_ID = :WK_DEVICE_FROM
                 AND OVER_SIZED = :WK_OVER_SIZED);
              UPDATE PICK_ITEM
                 SET DEVICE_ID = :WK_DEVICE_TO,
                 PICK_LINE_PRIORITY = PICK_LINE_PRIORITY + NEW.QTY
                 WHERE PROD_ID = :WK_PROD
                 AND DEVICE_ID = :WK_DEVICE_FROM
                 AND OVER_SIZED = :WK_OVER_SIZED;
              EXECUTE PROCEDURE UPDATE_TRAN (WK_RECORD, 'T','Processed successfully');
           END
           ELSE
           IF (NEW.TRN_CODE = 'O') THEN
           BEGIN
              /* transfer an order from where ever it is  to another device */
              WK_ORDER = NEW.OBJECT;
              WK_DO_PLAO = SUBSTR(NEW.LOCN_ID,1,1);
              WK_PRINTER = SUBSTR(NEW.LOCN_ID,3,4);
              IF (WK_DO_PLAO = 'T') THEN
              BEGIN
                 SELECT COUNT(*)
                 FROM PICK_ITEM
                 WHERE PICK_ORDER = :WK_ORDER
                 AND PICK_LINE_STATUS IN ('AL', 'PG', 'OP', 'PL')
                 INTO :WK_LINE_CNT;
                 WK_LINE_CNT_X = LPAD(WK_LINE_CNT,'0',3);
                 SELECT FIRST 1 DESCRIPTION
                 FROM OPTIONS
                 WHERE GROUP_CODE = 'CMPPKPRO'
                 AND CODE >= :WK_LINE_CNT_X
                 ORDER BY CODE
                 INTO :WK_LABELS_X;
                 WK_LABELS = CAST(WK_LABELS_X AS INTEGER);
                 WK_MYREF = '                                     |' || WK_PRINTER;
                 /* now do plao for this */
                 EXECUTE PROCEDURE ADD_TRAN(
                    '  ',
                    '        ',
                    :WK_ORDER,
                    'PLAO',
                    'O',
                    :WK_DATE,
                    :WK_MYREF,
                    :WK_LABELS,
                    'F',
                    '',
                    'MASTER',
                    0,
                    '          ',
                    'SSSSSSSSS',
                    :WK_USER,
                    :WK_DEVICE);
              END
              UPDATE PICK_ITEM_DETAIL
                 SET DEVICE_ID = :WK_DEVICE_TO
                 WHERE PICK_LABEL_NO IN 
                 (SELECT PICK_LABEL_NO 
                  FROM PICK_ITEM 
                  WHERE PICK_ORDER = :WK_ORDER
                 /* AND PICK_LINE_STATUS IN ('AL', 'PG', 'OP', 'PL') */
                  AND POS(:WK_CO_PICK_STATUS , PICK_LINE_STATUS, 0, 1) > -1 
                 /* AND OVER_SIZED = :WK_OVER_SIZED */)
                 /* AND PICK_DETAIL_STATUS IN ('AL', 'PG', 'OP', 'PL'); */
                  AND POS(:WK_CO_PICK_STATUS , PICK_DETAIL_STATUS, 0, 1) > -1 ;
              UPDATE PICK_ITEM
                 SET DEVICE_ID = :WK_DEVICE_TO,
                 PICK_LINE_PRIORITY = (SELECT MAX(P2.PICK_LINE_PRIORITY) FROM PICK_ITEM P2 
                    WHERE P2.PICK_ORDER = :WK_ORDER
                    /* AND P2.PICK_LINE_STATUS IN ('AL', 'PG', 'OP', 'PL') */
                    AND POS(:WK_CO_PICK_STATUS , P2.PICK_LINE_STATUS, 0, 1) > -1 
                    AND P2.PICK_LINE_PRIORITY IS NOT NULL) + NEW.QTY,
                 USER_ID = :WK_USER
                 WHERE PICK_ORDER = :WK_ORDER
                 /* AND PICK_LINE_STATUS IN ('AL', 'PG', 'OP', 'PL') */
                 AND POS(:WK_CO_PICK_STATUS , PICK_LINE_STATUS, 0, 1) > -1 
                 AND PICK_LINE_PRIORITY IS NOT NULL
                 /* AND OVER_SIZED = :WK_OVER_SIZED */;
              UPDATE PICK_ITEM
                 SET DEVICE_ID = :WK_DEVICE_TO,
                 PICK_LINE_PRIORITY = NEW.QTY,
                 USER_ID = :WK_USER
                 WHERE PICK_ORDER = :WK_ORDER
                 /* AND PICK_LINE_STATUS IN ('AL', 'PG', 'OP', 'PL') */
                 AND POS(:WK_CO_PICK_STATUS , PICK_LINE_STATUS, 0, 1) > -1 
                 AND PICK_LINE_PRIORITY IS NULL
                 /* AND OVER_SIZED = :WK_OVER_SIZED */;
              UPDATE PICK_ITEM
                 SET PICK_LINE_STATUS = 'AL'
                 WHERE PICK_ORDER = :WK_ORDER
                 AND PICK_LINE_STATUS IN ('OP', 'UP' ) ;
              EXECUTE PROCEDURE UPDATE_TRAN (WK_RECORD, 'T','Processed successfully');
           END
           IF (NEW.TRN_CODE = 'o') THEN
           BEGIN
              /* transfer order  from one device to another */
              WK_ORDER = NEW.OBJECT;
              WK_DEVICE_FROM = NEW.WH_ID;
              WK_USER = NEW.PERSON_ID;
              WK_DEVICE = NEW.DEVICE_ID;
              WK_DATE = NEW.TRN_DATE;
              WK_RECORD = NEW.RECORD_ID;
              WK_DEVICE_TO = NEW.SUB_LOCN_ID;
/*
              UPDATE PICK_ITEM_DETAIL
                 SET DEVICE_ID = :WK_DEVICE_TO
                 WHERE PICK_LABEL_NO IN 
                 (SELECT PICK_LABEL_NO 
                  FROM PICK_ITEM 
                  WHERE PICK_ORDER = :WK_ORDER
                  AND DEVICE_ID = :WK_DEVICE_FROM);
*/
              FOR SELECT PICK_LABEL_NO 
                  FROM PICK_ITEM 
                  WHERE PICK_ORDER = :WK_ORDER
                  AND DEVICE_ID = :WK_DEVICE_FROM
                  INTO :WK_PI_LABEL
              DO
              BEGIN
                 UPDATE PICK_ITEM_DETAIL
                    SET DEVICE_ID = :WK_DEVICE_TO
                    WHERE PICK_LABEL_NO  = :WK_PI_LABEL 
                    AND DEVICE_ID = :WK_DEVICE_FROM;
              END
              UPDATE PICK_ITEM
                 SET DEVICE_ID = :WK_DEVICE_TO,
                 PICK_LINE_PRIORITY = PICK_LINE_PRIORITY + NEW.QTY
                 WHERE PICK_ORDER = :WK_ORDER
                 AND DEVICE_ID = :WK_DEVICE_FROM;
              UPDATE PICK_LOCATION
                 SET DEVICE_ID = :WK_DEVICE_TO
                 WHERE PICK_ORDER = :WK_ORDER
                 AND DEVICE_ID = :WK_DEVICE_FROM;
              EXECUTE PROCEDURE UPDATE_TRAN (WK_RECORD, 'T','Processed successfully');
           END
           IF (NEW.TRN_CODE = 'L') THEN
           BEGIN
              /* transfer orders location  from one device to another */
              WK_ORDER = NEW.OBJECT;
              EXECUTE PROCEDURE GET_REFERENCE_FIELD NEW.REFERENCE, 1  RETURNING_VALUES :WK_ORDER_WH_ID  ; 
              EXECUTE PROCEDURE GET_REFERENCE_FIELD NEW.REFERENCE, 2  RETURNING_VALUES :WK_ORDER_LOCN_ID  ; 
              EXECUTE PROCEDURE GET_REFERENCE_FIELD NEW.REFERENCE, 3  RETURNING_VALUES :WK_REFERENCE ; 
              UPDATE PICK_LOCATION
                 SET DEVICE_ID = :WK_DEVICE_TO
                 WHERE PICK_ORDER = :WK_ORDER
                 AND DEVICE_ID = :WK_DEVICE_FROM
                 AND WH_ID = :WK_ORDER_WH_ID
                 AND LOCN_ID = :WK_ORDER_LOCN_ID;
              EXECUTE PROCEDURE UPDATE_TRAN (WK_RECORD, 'T','Processed successfully');
           END
        END
     END
/*
     ELSE
     BEGIN
        -* invalid length for device *-
        EXECUTE PROCEDURE UPDATE_TRAN (WK_RECORD, 'F','Invalid To Device');
     END
*/
     /*
   EXECUTE PROCEDURE TRAN_ARCHIVE;
   */
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_STKA FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 119 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_DEVICE CHAR(2);
DECLARE VARIABLE WK_USER VARCHAR(10);
DECLARE VARIABLE WK_RECORD INTEGER;
DECLARE VARIABLE WK_SUB_LOCN VARCHAR(10);
DECLARE VARIABLE WK_WH_ID CHAR(2);
DECLARE VARIABLE WK_LOCN_ID VARCHAR(10);
DECLARE VARIABLE WK_OBJECT VARCHAR(30);
DECLARE VARIABLE WK_REF VARCHAR(40);
DECLARE VARIABLE WK_QTY INTEGER;
DECLARE VARIABLE WK_DATE TIMESTAMP;
DECLARE VARIABLE WK_TRN_TYPE VARCHAR(4);
DECLARE VARIABLE WK_TRN_CODE CHAR(1);

DECLARE VARIABLE WK_WK_WH_ID CHAR(2);
DECLARE VARIABLE WK_WK_LOCN_ID VARCHAR(10);
DECLARE VARIABLE WK_CREATE_QTY INTEGER;
DECLARE VARIABLE WK_STATUS VARCHAR(40);
DECLARE VARIABLE WK_COMPONENT_ID VARCHAR(30);
DECLARE VARIABLE WK_COMPONENT_QTY INTEGER;
DECLARE VARIABLE WK_NEED_QTY INTEGER;
DECLARE VARIABLE WK_AUDIT_DESC VARCHAR(40);
DECLARE VARIABLE WK_QTY_REMAINING INTEGER;
DECLARE VARIABLE WK_ALLOWED_STATUS VARCHAR(40);
DECLARE VARIABLE WK_IS_FOUND INTEGER;

DECLARE VARIABLE WK_IS_QTY INTEGER;
DECLARE VARIABLE WK_QTY_TO_USE INTEGER;
DECLARE VARIABLE WK_IS_SSN VARCHAR(20);
DECLARE VARIABLE WK_IS_ORIGINAL_SSN VARCHAR(20);
DECLARE VARIABLE WK_IS_QTY_REMAINING INTEGER;
DECLARE VARIABLE WK_USED_SSN VARCHAR(20);
DECLARE VARIABLE WK_IS_USED_QTY INTEGER;
DECLARE VARIABLE WK_LOG VARCHAR(120);
DECLARE VARIABLE WK_DUMMY INTEGER;
DECLARE VARIABLE WK_SN_FOUND INTEGER;
DECLARE VARIABLE WK_SN_SSN VARCHAR(20);
DECLARE VARIABLE WK_OWNER VARCHAR(20);
DECLARE VARIABLE WK_SUPPLIER VARCHAR(40);
DECLARE VARIABLE WK_PROD_TYPE VARCHAR(10);
DECLARE VARIABLE WK_PROD_DESC VARCHAR(50);
DECLARE VARIABLE SSN_LENGTH INTEGER;
DECLARE VARIABLE P_SSN_ID INTEGER;
DECLARE VARIABLE LEN_SSN_ID INTEGER;
DECLARE VARIABLE W_SSN_ID VARCHAR(20);
DECLARE VARIABLE WK_DO_UASL CHAR(1);
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'STKA') THEN
  BEGIN
     WK_DEVICE = NEW.DEVICE_ID;
     WK_SUB_LOCN = NEW.SUB_LOCN_ID;
     WK_WH_ID = NEW.WH_ID;
     WK_LOCN_ID = NEW.LOCN_ID;
     WK_USER = NEW.PERSON_ID;
     WK_OBJECT = NEW.OBJECT;
     WK_REF = ALLTRIM(NEW.REFERENCE);
     WK_QTY = NEW.QTY;
     WK_DATE = NEW.TRN_DATE;
     WK_RECORD = NEW.RECORD_ID;
     WK_TRN_CODE = NEW.TRN_CODE;
     WK_TRN_TYPE = NEW.TRN_TYPE;

     WK_AUDIT_DESC = 'Create Kitted Product Qty' ;
/*
     in this transaction
     the object is the product
     the qty is the create qty
     the wh_id and locn_id specify the location
     the reference is a comment for the ssn_hist

     here we must create a qty of a kit
     in order to do this we must transfer 
     qtys of its components from the locations with most stock
     and only a pickable status
     (in product_kit status = 'OK'
      need prod_qty * create qty in transaction)
      for all components involved
      only when we have all the components can we merge them
      into the new product kit
      the status of the new product must be the store area of the 
      location

     So see if we have enough of the 1st level components for this

     if so then remove from the locations involved
     create 1 ssn and issn for the kit


*/

     IF (NEW.TRN_CODE = 'P')  THEN
     BEGIN
        SELECT SEND_UASL_V4 FROM CONTROL INTO :WK_DO_UASL;

        WK_CREATE_QTY = WK_QTY;
        WK_STATUS = 'OK';

        FOR SELECT PROD_ID, PROD_QTY
           FROM PRODUCT_KIT
           WHERE KIT_ID = :WK_OBJECT
           AND STATUS = 'OK'
        INTO :WK_COMPONENT_ID, :WK_COMPONENT_QTY
        DO 
        BEGIN
           WK_NEED_QTY = WK_CREATE_QTY * WK_COMPONENT_QTY;
           /* do we have this much pickable */
           WK_IS_QTY = 0;
           SELECT SUM(ISSN.CURRENT_QTY)
           FROM ISSN
           JOIN CONTROL ON CONTROL.RECORD_ID = 1
           WHERE ISSN.PROD_ID = :WK_COMPONENT_ID
           AND (POS(CONTROL.PICK_IMPORT_SSN_STATUS,ISSN.ISSN_STATUS,0,1) > -1)
           INTO :WK_IS_QTY;
           IF (WK_IS_QTY IS NULL) THEN
           BEGIN
              WK_IS_QTY = 0;
           END
           IF (WK_IS_QTY >= WK_NEED_QTY) THEN
           BEGIN
              /* ok we have enough */
              WK_DUMMY = 1;
           END
           ELSE
           BEGIN
              /* dont have enough */
              WK_STATUS = 'NOTOK';
              WK_LOG = 'Not enough of Product ' || WK_COMPONENT_ID || '(' || WK_IS_QTY || ') (' || WK_NEED_QTY || ') to Make ' || WK_OBJECT || ' (' || WK_CREATE_QTY || ')';
           END
        END
        IF (WK_STATUS = 'NOTOK') THEN
        BEGIN
           IF (LEN(WK_LOG) > 70) THEN
           BEGIN
              WK_LOG = SUBSTR(WK_LOG, 1,70);
           END
           EXECUTE PROCEDURE UPDATE_TRAN (WK_RECORD, 'F',WK_LOG);
        END
        ELSE
        BEGIN
           /* ok we have enough - so go and get the components
              taking from locations in order of size of product */
           FOR SELECT PROD_ID, PROD_QTY
              FROM PRODUCT_KIT
              WHERE KIT_ID = :WK_OBJECT
              AND STATUS = 'OK'
              INTO :WK_COMPONENT_ID, :WK_COMPONENT_QTY
           DO 
           BEGIN
              /* DELETE FROM TRANSACTIONS_WORK
              WHERE RECORD_ID = :WK_RECORD; */
              WK_NEED_QTY = WK_CREATE_QTY * WK_COMPONENT_QTY;
              WK_QTY_REMAINING = WK_NEED_QTY;
              WK_IS_QTY_REMAINING = WK_QTY_REMAINING;

              /* calc the qtys for this product */
              FOR SELECT SUM(CURRENT_QTY), WH_ID, LOCN_ID 
                  FROM ISSN
                  JOIN CONTROL ON CONTROL.RECORD_ID = 1
                  WHERE PROD_ID = :WK_COMPONENT_ID
                  AND (POS(CONTROL.PICK_IMPORT_SSN_STATUS,ISSN.ISSN_STATUS,0,1) > -1)
                  AND CURRENT_QTY > 0
                  GROUP BY WH_ID, LOCN_ID
                  INTO :WK_IS_QTY, :WK_WK_WH_ID, :WK_WK_LOCN_ID 
              DO
              BEGIN
                 INSERT INTO TRANSACTIONS_WORK(
                    RECORD_ID,
                    WH_ID,
                    LOCN_ID,
                    OBJECT,
                    QTY)
                    VALUES(
                    :WK_RECORD,
                    :WK_WK_WH_ID,
                    :WK_WK_LOCN_ID,
                    :WK_COMPONENT_ID,
                    :WK_IS_QTY);
              END
              /* get the  qtys for this product in order of qty 
                 in transactions_work */
              FOR SELECT ISSN.CURRENT_QTY, ISSN.SSN_ID, ISSN.ORIGINAL_SSN
                  FROM TRANSACTIONS_WORK
                  JOIN ISSN ON ISSN.WH_ID = TRANSACTIONS_WORK.WH_ID
                  AND ISSN.LOCN_ID = TRANSACTIONS_WORK.LOCN_ID  
                  AND ISSN.PROD_ID = TRANSACTIONS_WORK.OBJECT
                  JOIN CONTROL ON CONTROL.RECORD_ID = 1
                  WHERE TRANSACTIONS_WORK.OBJECT = :WK_COMPONENT_ID
                  AND TRANSACTIONS_WORK.RECORD_ID = :WK_RECORD
                  AND (POS(CONTROL.PICK_IMPORT_SSN_STATUS,ISSN.ISSN_STATUS,0,1) > -1)
                  AND ISSN.CURRENT_QTY > 0
                  ORDER BY TRANSACTIONS_WORK.QTY DESC
                  INTO :WK_IS_QTY, :WK_IS_SSN, :WK_IS_ORIGINAL_SSN 
              DO
              BEGIN
                 IF (WK_IS_QTY_REMAINING > 0) THEN
                 BEGIN
                    /* how much can I take */
                    /* either issn qty or remaining qty if its less */
                    WK_USED_SSN = WK_IS_SSN;
                    WK_IS_USED_QTY = WK_IS_QTY;
                    IF (WK_IS_QTY_REMAINING < WK_IS_QTY) THEN
                    BEGIN
                       WK_IS_USED_QTY = WK_IS_QTY_REMAINING;
                       /*  wk_is_qty_remaining */
                       /* so end of issns that we take */
                    END
                    UPDATE ISSN SET 
                     CURRENT_QTY = CURRENT_QTY - :WK_IS_USED_QTY
                     WHERE SSN_ID = :WK_USED_SSN;
                    UPDATE SSN SET 
                     CURRENT_QTY = CURRENT_QTY - :WK_IS_USED_QTY
                     WHERE SSN_ID = :WK_IS_ORIGINAL_SSN;
                    /* must reduce wk_is_qty_remaining by wk_is_used_qty */
                    WK_IS_QTY_REMAINING = WK_IS_QTY_REMAINING - WK_IS_USED_QTY;
                    WK_IS_USED_QTY = 0 - WK_IS_USED_QTY;
                    EXECUTE PROCEDURE ADD_SSN_HIST(:WK_WK_WH_ID, :WK_WK_LOCN_ID, :WK_USED_SSN, 
                             :WK_TRN_TYPE, :WK_TRN_CODE, :WK_DATE,
                             :WK_AUDIT_DESC , :WK_REF, :WK_IS_USED_QTY, :WK_USER, :WK_DEVICE); 
                 END
              END /* end for issns loop */
              IF (WK_DO_UASL = 'T') THEN
              BEGIN
                 /* send of tot of avail of the make prod */
                 EXECUTE PROCEDURE SEND_PICKABLE_STOCK (:WK_COMPONENT_ID,
                    :WK_USER,
                    :WK_DEVICE,
                    :WK_DATE);
              END
           END
           /* ok now have taken enough of all the components 
              so create ssn and issn for the new kit */
          WK_ALLOWED_STATUS = '';
          SELECT MOVE_STAT
          FROM LOCATION
          WHERE WH_ID = :WK_WH_ID
          AND LOCN_ID = :WK_LOCN_ID
          INTO :WK_ALLOWED_STATUS;
          IF (WK_ALLOWED_STATUS IS NULL) THEN
          BEGIN
             SELECT NEW_PROD_STATUS
             FROM CONTROL
             INTO :WK_ALLOWED_STATUS;
          END
          WK_SN_FOUND = 0;
          SELECT FIRST 1 1, SSN_ID
          FROM SSN
          WHERE PROD_ID = :WK_OBJECT
          INTO :WK_SN_FOUND, :WK_SN_SSN;
          
          WK_IS_FOUND = 0;
          SELECT FIRST 1 1, SSN_ID, ORIGINAL_SSN
          FROM ISSN
          WHERE PROD_ID = :WK_OBJECT
          AND ISSN_STATUS = :WK_ALLOWED_STATUS
          AND WH_ID = :WK_WH_ID
          AND LOCN_ID = :WK_LOCN_ID
          INTO :WK_IS_FOUND, :WK_IS_SSN, :WK_IS_ORIGINAL_SSN;
          /* if I dont have any of this product in the location
             of the right status */
          IF (WK_IS_FOUND = 0) THEN
          BEGIN
             SELECT SHORT_DESC, SUPPLIER_NO1, PROD_TYPE, COMPANY_ID
             FROM PROD_PROFILE
             WHERE PROD_ID = :WK_OBJECT
             INTO :WK_PROD_DESC, :WK_SUPPLIER, :WK_PROD_TYPE, :WK_OWNER;
             IF (WK_OWNER IS NULL) THEN
             BEGIN
                SELECT COMPANY_ID FROM CONTROL INTO :WK_OWNER;
             END
             /* Get length for Barcode */   
             EXECUTE PROCEDURE GET_BARCODE_LENGTH RETURNING_VALUES SSN_LENGTH;
             P_SSN_ID = GEN_ID(ISSN_SSN_ID, 1) -1;
             LEN_SSN_ID = STRLEN(P_SSN_ID);     
         
             W_SSN_ID = '';
             /* Padding leading with 0 */
             WHILE (LEN_SSN_ID < :SSN_LENGTH) DO
             BEGIN
                W_SSN_ID = W_SSN_ID || '0';      
                LEN_SSN_ID = LEN_SSN_ID + 1;
             END
             W_SSN_ID = W_SSN_ID || P_SSN_ID;
   
             IF (WK_SN_FOUND = 0) THEN
             BEGIN
                INSERT INTO ISSN (SSN_ID, ORIGINAL_SSN, WH_ID, LOCN_ID, CURRENT_QTY,ISSN_STATUS, PROD_ID, COMPANY_ID, ORIGINAL_QTY, CREATE_DATE,USER_ID, INTO_DATE)
                VALUES (:W_SSN_ID, :W_SSN_ID, :WK_WH_ID, :WK_LOCN_ID, :WK_QTY, :WK_ALLOWED_STATUS, :WK_OBJECT, :WK_OWNER, :WK_QTY, :WK_DATE, :WK_USER, :WK_DATE ); 
                /* create new ssn */
                INSERT INTO SSN (SSN_ID, WH_ID, LOCN_ID, STATUS_SSN, ORIGINAL_QTY,
                    CURRENT_QTY, PROD_ID, SSN_DESCRIPTION, SUPPLIER_ID, COMPANY_ID, SSN_TYPE)
                VALUES (:W_SSN_ID, :WK_WH_ID, :WK_LOCN_ID, :WK_ALLOWED_STATUS, :WK_QTY, :WK_QTY, :WK_OBJECT,:WK_PROD_DESC, :WK_SUPPLIER, :WK_OWNER, :WK_PROD_TYPE);     
             END
             ELSE
             BEGIN
                INSERT INTO ISSN (SSN_ID, ORIGINAL_SSN, WH_ID, LOCN_ID, CURRENT_QTY,ISSN_STATUS, PROD_ID, COMPANY_ID, ORIGINAL_QTY, CREATE_DATE,USER_ID, INTO_DATE)
                VALUES (:W_SSN_ID, :WK_SN_SSN, :WK_WH_ID, :WK_LOCN_ID, :WK_QTY, :WK_ALLOWED_STATUS, :WK_OBJECT, :WK_OWNER, :WK_QTY, :WK_DATE, :WK_USER, :WK_DATE ); 
                UPDATE SSN SET 
                 CURRENT_QTY = CURRENT_QTY + :WK_QTY
                 WHERE SSN_ID = :WK_SN_SSN;
             END
          END
          ELSE
          BEGIN
              /* update qty of issn and ssn */
              UPDATE ISSN SET 
               CURRENT_QTY = CURRENT_QTY + :WK_QTY
               WHERE SSN_ID = :WK_IS_SSN;
              UPDATE SSN SET 
               CURRENT_QTY = CURRENT_QTY + :WK_QTY
               WHERE SSN_ID = :WK_IS_ORIGINAL_SSN;
          END
          EXECUTE PROCEDURE UPDATE_TRAN (WK_RECORD, 'T','Processed successfully');
          IF (WK_DO_UASL = 'T') THEN
          BEGIN
             /* send of tot of avail of the make prod */
             EXECUTE PROCEDURE SEND_PICKABLE_STOCK (:WK_OBJECT,
                :WK_USER,
                :WK_DEVICE,
                :WK_DATE);
          END
       END
    END /* of code P */
   EXECUTE PROCEDURE TRAN_ARCHIVE;
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_PKAO FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 120 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_DEVICE CHAR(2);
DECLARE VARIABLE WK_DEVICE_WH CHAR(2);
DECLARE VARIABLE WK_PI_PICKED_QTY INTEGER;
DECLARE VARIABLE WK_PID_PICKED_QTY INTEGER;
DECLARE VARIABLE WK_LABEL_NO VARCHAR(10);
DECLARE VARIABLE WK_PI_STATUS CHAR(2);
DECLARE VARIABLE WK_PI_SSN VARCHAR(20);
DECLARE VARIABLE WK_PI_PROD VARCHAR(30);
DECLARE VARIABLE WK_PI_ORDER_QTY INTEGER;
DECLARE VARIABLE WK_PI_PICK_QTY INTEGER;
DECLARE VARIABLE WK_PI_PICK_QTY2 INTEGER;
DECLARE VARIABLE WK_PI_DESPATCH_LOCN VARCHAR(10);
DECLARE VARIABLE WK_PIR_PROD VARCHAR(30);
DECLARE VARIABLE WK_PIR_ORDER_QTY INTEGER;
DECLARE VARIABLE WK_RECORD INTEGER;
DECLARE VARIABLE WK_PID_SSN VARCHAR(20);
DECLARE VARIABLE WK_DATE TIMESTAMP;
DECLARE VARIABLE WK_USER VARCHAR(10);
DECLARE VARIABLE WK_FOUND INTEGER;
DECLARE VARIABLE WK_CANCEL CHAR(1);
DECLARE VARIABLE WK_ADJUST_TYPE CHAR(1);
DECLARE VARIABLE WK_PID_FROM_WH CHAR(2);
DECLARE VARIABLE WK_PID_FROM_LOCN VARCHAR(10);
DECLARE VARIABLE WK_ORDER VARCHAR(30);
DECLARE VARIABLE WK_FROM_WH CHAR(2);
DECLARE VARIABLE WK_FROM_LOCN VARCHAR(10);
DECLARE VARIABLE WK_TOPICK_QTY INTEGER;
DECLARE VARIABLE WK_USED_SSN VARCHAR(20);
DECLARE VARIABLE WK_IS_USED_QTY INTEGER;
DECLARE VARIABLE WK_DEFAULT_DESPATCH_LOCN VARCHAR(10);
DECLARE VARIABLE WK_DEFAULT_DESPATCH_WH CHAR(2);

BEGIN
/*
trn_type = PKAO
trn_code = 'O'
object = order
ref = comment
wh_id and locn_id = from_location (in pick_item_detail)

at the initial stage just cancel the order
*/

/*
then populate the changes to the pick_item from the pick_item_revised
*/

/*
must get diferrence between pick_item and pick_item_revised
for pick_order_qty (diff = pick_item.pick_order_qty - pick_item_revised.pick_order_qty)
later on - II
unpick that difference (similar to PKCN) diff > 0
*/

/*
then pick the required remaining qty (diff < 0)
*/

/*
now cancels all of line if some are required to go back
leaves matching lines 
leaves lines required to pick or pick more
then picks from new issues the required amount
where qty comes from pick_qty_difference or pick_qty_difference2
*/
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'PKAO') THEN
  BEGIN
     WK_DEVICE = NEW.DEVICE_ID;
     WK_DATE = NEW.TRN_DATE;
     WK_USER = NEW.PERSON_ID;
     WK_RECORD = NEW.RECORD_ID;
     WK_ADJUST_TYPE = NEW.TRN_CODE;
     WK_CANCEL = 'C';
     WK_ORDER = NEW.OBJECT;
     WK_FROM_WH = NEW.WH_ID;
     WK_FROM_LOCN = NEW.LOCN_ID;

     /* first recalc the pick_item difference qty */
  
     FOR SELECT
        PI.PROD_ID, SUM(PI.PICK_ORDER_QTY)
        FROM PICK_ITEM PI
        WHERE PI.PICK_ORDER = :WK_ORDER
        AND PI.PICK_LINE_STATUS IN ('OP','UP','CN','PG','PL','AL')
        AND (PI.PROD_ID IS NOT NULL)
        GROUP BY PI.PROD_ID 
        INTO :WK_PI_PROD, :WK_PI_ORDER_QTY
     DO
     BEGIN
        IF (WK_PI_ORDER_QTY IS NULL) THEN
        BEGIN
           WK_PI_ORDER_QTY = 0;
        END
        WK_PIR_ORDER_QTY = 0;
        SELECT PIR.PROD_ID, SUM(PIR.PICK_ORDER_QTY)
        FROM PICK_ITEM_REVISED PIR
        WHERE PIR.PICK_ORDER = :WK_ORDER
        AND PIR.PICK_LINE_STATUS IN ('OP','UP','CN')
        AND (PIR.PROD_ID = :WK_PI_PROD)
        GROUP BY PIR.PROD_ID 
        INTO :WK_PIR_PROD, :WK_PIR_ORDER_QTY;
        IF (WK_PIR_ORDER_QTY IS NULL) THEN
        BEGIN
           WK_PIR_ORDER_QTY = 0;
        END
        /* force to pick ALL on order since we cancel all */
        /* SET PICK_QTY_DIFFERENCE = ( 0 - :WK_PIR_ORDER_QTY ) */
        /* now only pick required extras order since we cancel  only extras */
        UPDATE PICK_ITEM 
        SET PICK_QTY_DIFFERENCE = ( :WK_PI_ORDER_QTY - :WK_PIR_ORDER_QTY ) ,
        PICK_QTY_DIFFERENCE2 = ( 0 - :WK_PIR_ORDER_QTY ) 
        WHERE PICK_ORDER = :WK_ORDER
        AND PICK_LINE_STATUS IN ('OP','UP','CN','PG','PL','AL')
        AND PROD_ID = :WK_PI_PROD;
     END /* end do */
     FOR SELECT
        PIR.PROD_ID, SUM(PIR.PICK_ORDER_QTY)
        FROM PICK_ITEM_REVISED PIR
        WHERE PIR.PICK_ORDER = :WK_ORDER
        AND PIR.PICK_LINE_STATUS IN ('OP','UP','CN')
        AND (PIR.PROD_ID IS NOT NULL)
        GROUP BY PIR.PROD_ID 
        INTO :WK_PIR_PROD, :WK_PIR_ORDER_QTY
     DO
     BEGIN
        IF (WK_PIR_ORDER_QTY IS NULL) THEN
        BEGIN
           WK_PIR_ORDER_QTY = 0;
        END
        WK_PI_ORDER_QTY = 0;
        SELECT PI.PROD_ID, SUM(PI.PICK_ORDER_QTY)
        FROM PICK_ITEM PI
        WHERE PI.PICK_ORDER = :WK_ORDER
        AND PI.PICK_LINE_STATUS IN ('OP','UP','CN','AL','PG','PL')
        AND (PI.PROD_ID = :WK_PIR_PROD)
        GROUP BY PI.PROD_ID 
        INTO :WK_PI_PROD, :WK_PI_ORDER_QTY;
        IF (WK_PI_ORDER_QTY IS NULL) THEN
        BEGIN
           WK_PI_ORDER_QTY = 0;
        END
        IF ((WK_PI_ORDER_QTY = 0) AND (WK_PIR_ORDER_QTY > 0)) THEN
        BEGIN
           UPDATE PICK_ITEM 
           SET PICK_QTY_DIFFERENCE = ( :WK_PI_ORDER_QTY - :WK_PIR_ORDER_QTY ),
           PICK_QTY_DIFFERENCE2 = ( 0 - :WK_PIR_ORDER_QTY )
           WHERE PICK_ORDER = :WK_ORDER
           AND PICK_LINE_STATUS IN ('OP','UP','CN','AL','PG','PL')
           AND PROD_ID = :WK_PIR_PROD;
           UPDATE PICK_ITEM_REVISED 
           SET PICK_QTY_DIFFERENCE = ( :WK_PI_ORDER_QTY - :WK_PIR_ORDER_QTY )
           WHERE PICK_ORDER = :WK_ORDER
           AND PICK_LINE_STATUS IN ('OP','UP','CN','AL','PG','PL')
           AND PROD_ID = :WK_PIR_PROD;
           
        END
     END /* do */
     /* end of difference calc */

     /* cancel starts here */
     /* save prev status  and from location in issn for move back */
     FOR SELECT PID.SSN_ID , PI.SSN_ID, PI.PROD_ID, PID.FROM_WH_ID, PID.FROM_LOCN_ID
         FROM PICK_ITEM_DETAIL PID
         JOIN PICK_ITEM PI ON PI.PICK_LABEL_NO = PID.PICK_LABEL_NO
         WHERE PI.PICK_ORDER = :WK_ORDER 
           AND PI.PICK_QTY_DIFFERENCE > 0
           AND (PID.PICK_DETAIL_STATUS = 'PG'
           OR PID.PICK_DETAIL_STATUS = 'PL')
         INTO :WK_PID_SSN, :WK_PI_SSN, :WK_PI_PROD, :WK_PID_FROM_WH, :WK_PID_FROM_LOCN
     DO
     BEGIN
        IF (WK_PI_SSN IS NOT NULL) THEN
        BEGIN
           IF (WK_CANCEL = 'C') THEN
           BEGIN
              UPDATE ISSN SET ISSN_STATUS = 'PA',
                  WH_ID = :WK_PID_FROM_WH,
                  LOCN_ID = :WK_PID_FROM_LOCN,
                  PICK_ORDER = NULL
               WHERE SSN_ID = :WK_PID_SSN;
           END
           ELSE
           BEGIN
              UPDATE ISSN SET ISSN_STATUS = 'RS',
                  WH_ID = :WK_PID_FROM_WH,
                  LOCN_ID = :WK_PID_FROM_LOCN
               WHERE SSN_ID = :WK_PID_SSN;
           END
        END
        ELSE
        BEGIN
           UPDATE ISSN SET ISSN_STATUS = 'PA',
                  WH_ID = :WK_PID_FROM_WH,
                  LOCN_ID = :WK_PID_FROM_LOCN
            WHERE SSN_ID = :WK_PID_SSN;
        END
     END
     FOR SELECT SUM(PID.QTY_PICKED), PID.PICK_LABEL_NO 
         FROM PICK_ITEM_DETAIL PID
         JOIN PICK_ITEM PI ON PI.PICK_LABEL_NO = PID.PICK_LABEL_NO
         WHERE PI.PICK_ORDER = :WK_ORDER 
           AND PI.PICK_QTY_DIFFERENCE > 0
           AND (PID.PICK_DETAIL_STATUS = 'PG'
           OR PID.PICK_DETAIL_STATUS = 'PL')
         GROUP BY PID.PICK_LABEL_NO
         INTO :WK_PID_PICKED_QTY, :WK_LABEL_NO
     DO
     BEGIN
        SELECT PICKED_QTY 
        FROM PICK_ITEM
        WHERE PICK_LABEL_NO = :WK_LABEL_NO
         INTO :WK_PI_PICKED_QTY;
        WK_PI_PICKED_QTY = WK_PI_PICKED_QTY - WK_PID_PICKED_QTY; 
        /* recalc pick_item status */
        IF (WK_PI_PICKED_QTY = 0) THEN
        BEGIN
           IF (WK_CANCEL = 'C') THEN
           BEGIN
              WK_PI_STATUS = 'CN';
           END
           ELSE
           BEGIN
              WK_PI_STATUS = 'OP';
           END
        END
        ELSE
        BEGIN
           WK_PI_STATUS = 'PG';
        END
        UPDATE PICK_ITEM
        SET  PICK_LINE_STATUS = :WK_PI_STATUS,
             PICKED_QTY = :WK_PI_PICKED_QTY
        WHERE PICK_LABEL_NO = :WK_LABEL_NO;
     END
     IF (WK_CANCEL = 'C') THEN
     BEGIN
        WK_PI_STATUS = 'CN';
     END
     ELSE
     BEGIN
        WK_PI_STATUS = 'UP';
     END
     FOR SELECT PICK_LABEL_NO 
         FROM PICK_ITEM
         WHERE PICK_ORDER = :WK_ORDER 
           AND PICK_QTY_DIFFERENCE > 0
           AND (PICK_LINE_STATUS = 'PG'
           OR PICK_LINE_STATUS = 'PL')
         INTO :WK_LABEL_NO
     DO
     BEGIN
        WK_FOUND = 0;
        SELECT COUNT(*) FROM PICK_ITEM_DETAIL
           WHERE (PICK_DETAIL_STATUS = 'PG'
           OR PICK_DETAIL_STATUS = 'PL')
             AND PICK_LABEL_NO = :WK_LABEL_NO
           INTO :WK_FOUND;
        IF (WK_FOUND = 0) THEN
        BEGIN
           /* no details for pick item */
           UPDATE PICK_ITEM
           SET  PICK_LINE_STATUS = :WK_PI_STATUS,
                DEVICE_ID = NULL
           WHERE PICK_LABEL_NO = :WK_LABEL_NO;
        END
     END
     UPDATE PICK_ITEM
     SET  PICK_LINE_STATUS = :WK_PI_STATUS,
          DEVICE_ID = NULL
     WHERE PICK_ORDER = :WK_ORDER 
       AND PICK_LINE_STATUS IN ('AL');
     UPDATE PICK_ITEM_DETAIL
     SET  PICK_DETAIL_STATUS = 'CN'
     WHERE PICK_LABEL_NO IN (SELECT PICK_LABEL_NO FROM PICK_ITEM WHERE PICK_ORDER = :WK_ORDER) 
        AND PICK_DETAIL_STATUS = 'XX' ;
     UPDATE PICK_ITEM_DETAIL
     SET  PICK_DETAIL_STATUS = 'XX',
          DEVICE_ID = LOWER(DEVICE_ID) 
     WHERE PICK_LABEL_NO IN ( 
        SELECT PICK_LABEL_NO 
        FROM PICK_ITEM 
        WHERE PICK_ORDER = :WK_ORDER 
           AND PICK_QTY_DIFFERENCE > 0) 
        AND (PICK_DETAIL_STATUS = 'PG'
        OR PICK_DETAIL_STATUS = 'PL');
     /* cancel ends here */
     
     EXECUTE PROCEDURE UPDATE_TRAN (WK_RECORD, 'T','Processed successfully');
/*
   EXECUTE PROCEDURE ADD_TRAN(
        :WK_DEVICE,
        '',
        '',
        'PKUA',
        'I',
        :WK_DATE,
        '',
        0,
        'F',
        '',
        'MASTER',
        0,
        '',
        'SSSSSSSSS',
        :WK_USER,
        :WK_DEVICE);
*/
     /* ok have canceled the order */
     /* so now put the changes to the order into the pick item */
  
     FOR SELECT
        PI.PROD_ID, SUM(PI.PICK_ORDER_QTY)
        FROM PICK_ITEM PI
        WHERE PI.PICK_ORDER = :WK_ORDER
        AND PI.PICK_LINE_STATUS IN ('OP','UP','CN','PG','PL')
        AND (PI.PROD_ID IS NOT NULL)
        GROUP BY PI.PROD_ID 
        INTO :WK_PI_PROD, :WK_PI_ORDER_QTY
     DO
     BEGIN
        IF (WK_PI_ORDER_QTY IS NULL) THEN
        BEGIN
           WK_PI_ORDER_QTY = 0;
        END
        WK_PIR_ORDER_QTY = 0;
        SELECT PIR.PROD_ID, SUM(PIR.PICK_ORDER_QTY)
        FROM PICK_ITEM_REVISED PIR
        WHERE PIR.PICK_ORDER = :WK_ORDER
        AND PIR.PICK_LINE_STATUS IN ('OP','UP','CN')
        AND (PIR.PROD_ID = :WK_PI_PROD)
        GROUP BY PIR.PROD_ID 
        INTO :WK_PIR_PROD, :WK_PIR_ORDER_QTY;
        IF (WK_PIR_ORDER_QTY IS NULL) THEN
        BEGIN
           WK_PIR_ORDER_QTY = 0;
        END
        IF (WK_PI_ORDER_QTY = WK_PIR_ORDER_QTY) THEN
        BEGIN
           /* match in both tables */
           UPDATE PICK_ITEM 
           SET PICK_LINE_STATUS = 'OP'
           WHERE PICK_ORDER = :WK_ORDER
           AND PICK_LINE_STATUS IN ('CN')
           AND PROD_ID = :WK_PI_PROD;
        END
        ELSE
        BEGIN
           IF (WK_PIR_ORDER_QTY > 0) THEN
           BEGIN
              UPDATE PICK_ITEM 
              SET PICK_LINE_STATUS = 'OP',
                  PICK_ORDER_QTY = :WK_PIR_ORDER_QTY
              WHERE PICK_ORDER = :WK_ORDER
              AND PICK_LINE_STATUS IN ('CN')
              AND PROD_ID = :WK_PI_PROD;
              UPDATE PICK_ITEM 
              SET PICK_ORDER_QTY = :WK_PIR_ORDER_QTY
              WHERE PICK_ORDER = :WK_ORDER
              AND PICK_LINE_STATUS IN ('PL','PG')
              AND PROD_ID = :WK_PI_PROD;
           END
           ELSE
           BEGIN
              UPDATE PICK_ITEM 
              SET PICK_ORDER_QTY = :WK_PIR_ORDER_QTY
              WHERE PICK_ORDER = :WK_ORDER
              AND PICK_LINE_STATUS IN ('CN','PL','PG')
              AND PROD_ID = :WK_PI_PROD;
           END
        END
     END /* end do */
     FOR SELECT
        PIR.PROD_ID, SUM(PIR.PICK_ORDER_QTY)
        FROM PICK_ITEM_REVISED PIR
        WHERE PIR.PICK_ORDER = :WK_ORDER
        AND PIR.PICK_LINE_STATUS IN ('OP','UP','CN')
        AND (PIR.PROD_ID IS NOT NULL)
        GROUP BY PIR.PROD_ID 
        INTO :WK_PIR_PROD, :WK_PIR_ORDER_QTY
     DO
     BEGIN
        IF (WK_PIR_ORDER_QTY IS NULL) THEN
        BEGIN
           WK_PIR_ORDER_QTY = 0;
        END
        WK_PI_ORDER_QTY = 0;
        SELECT PI.PROD_ID, SUM(PI.PICK_ORDER_QTY)
        FROM PICK_ITEM PI
        WHERE PI.PICK_ORDER = :WK_ORDER
        AND PI.PICK_LINE_STATUS IN ('OP','UP','CN','PL','PG')
        AND (PI.PROD_ID = :WK_PIR_PROD)
        GROUP BY PI.PROD_ID 
        INTO :WK_PI_PROD, :WK_PI_ORDER_QTY;
        IF (WK_PI_ORDER_QTY IS NULL) THEN
        BEGIN
           WK_PI_ORDER_QTY = 0;
        END
        IF ((WK_PI_ORDER_QTY = 0) AND (WK_PIR_ORDER_QTY > 0)) THEN
        BEGIN
           IF (WK_PI_PROD IS NULL) THEN
           BEGIN
              /* only in revised table */
              /* add to pick_item */
              INSERT INTO PICK_ITEM(
                 PICK_ORDER, 
                 PICK_LABEL_NO,
                 PICK_ORDER_LINE_NO,
                 PICK_LINE_STATUS, 
                 PICK_ORDER_QTY, 
                 PROD_ID,
                 PICK_RETRIEVE_STATUS,
                 CREATE_DATE,
                 USER_ID,
                 SSN_CONFIRM,
                 PICK_QTY_DIFFERENCE)
              SELECT 
                 PICK_ORDER, 
                 PICK_LABEL_NO,
                 PICK_ORDER_LINE_NO,
                 PICK_LINE_STATUS, 
                 PICK_ORDER_QTY, 
                 PROD_ID,
                 PICK_RETRIEVE_STATUS,
                 CREATE_DATE,
                 USER_ID,
                 SSN_CONFIRM,
                 PICK_QTY_DIFFERENCE
              FROM PICK_ITEM_REVISED
              WHERE PICK_ORDER = :WK_ORDER
              AND PROD_ID = :WK_PIR_PROD;
           END
           ELSE
           BEGIN
              UPDATE PICK_ITEM 
              SET PICK_LINE_STATUS = 'OP',
                  PICK_ORDER_QTY = :WK_PIR_ORDER_QTY
              WHERE PICK_ORDER = :WK_ORDER
              AND PICK_LINE_STATUS IN ('CN')
              AND PROD_ID = :WK_PIR_PROD;
              UPDATE PICK_ITEM 
              SET PICK_ORDER_QTY = :WK_PIR_ORDER_QTY
              WHERE PICK_ORDER = :WK_ORDER
              AND PICK_LINE_STATUS IN ('PL','PG')
              AND PROD_ID = :WK_PIR_PROD;
           END
           
        END
     END /* end do */
     /* ok have adjusted the pick item for the differences */
     /* so must pick it - to despatch */
     SELECT FIRST 1 WH_ID 
     FROM LOCATION
     WHERE LOCN_ID = :WK_DEVICE
     INTO WK_DEVICE_WH;
     SELECT DEFAULT_DESPATCH_LOCATION
     FROM CONTROL
     INTO :WK_DEFAULT_DESPATCH_LOCN;
     WK_DEFAULT_DESPATCH_WH = SUBSTR(WK_DEFAULT_DESPATCH_LOCN, 1, 2);

     FOR SELECT  PROD_ID, PICK_QTY_DIFFERENCE, PICK_LABEL_NO, PICKED_QTY, DESPATCH_LOCATION , PICK_QTY_DIFFERENCE2
     FROM PICK_ITEM
     WHERE PICK_ORDER = :WK_ORDER
     AND PICK_LINE_STATUS IN ('OP','UP','PL','PG')
     AND (PICK_QTY_DIFFERENCE < 0 
     OR (PICK_QTY_DIFFERENCE > 0 AND PICK_QTY_DIFFERENCE2 < 0))
     INTO :WK_PI_PROD, :WK_PI_PICK_QTY, :WK_LABEL_NO, :WK_PI_PICKED_QTY, :WK_PI_DESPATCH_LOCN, :WK_PI_PICK_QTY2
     DO
     BEGIN
        IF (WK_PI_PICK_QTY < 0) THEN
        BEGIN
           WK_TOPICK_QTY = 0 - WK_PI_PICK_QTY;
        END
        ELSE
        BEGIN
           WK_TOPICK_QTY = 0 - WK_PI_PICK_QTY2;
        END

        IF (WK_PI_PICKED_QTY IS NULL) THEN
        BEGIN
           WK_PI_PICKED_QTY = 0;
        END
        /* ok have pick line */
        /* allocate it to me */
        UPDATE PICK_ITEM 
        SET USER_ID = :WK_USER,
            DEVICE_ID = :WK_DEVICE,
            PICK_LINE_STATUS = 'AL'
        WHERE PICK_LABEL_NO = :WK_LABEL_NO;
        /* create the stock */
        /* do pkol */
        WK_PI_STATUS = 'PL';
        EXECUTE PROCEDURE ADD_ISSN ('' ,
              :WK_FROM_WH,
              :WK_FROM_LOCN,
              '',
              :WK_TOPICK_QTY,
              :WK_TOPICK_QTY,
              'NOW',
              'ST',
              '',
              'NOW',
              :WK_USER ,
              :WK_PI_PROD,
              1);
        SELECT FIRST 1 CURRENT_QTY, SSN_ID
            FROM ISSN
            WHERE PROD_ID = :WK_PI_PROD
            AND WH_ID = :WK_FROM_WH
            AND LOCN_ID = :WK_FROM_LOCN
            AND ISSN.ISSN_STATUS = 'ST'
            AND CURRENT_QTY = :WK_TOPICK_QTY
            INTO :WK_IS_USED_QTY, :WK_USED_SSN;
        UPDATE ISSN SET ISSN_STATUS = :WK_PI_STATUS,
            PREV_PREV_WH_ID = PREV_WH_ID,
            PREV_PREV_LOCN_ID = PREV_LOCN_ID,
            PREV_WH_ID = WH_ID,
            PREV_LOCN_ID = LOCN_ID,
            WH_ID = :WK_DEVICE_WH,
            LOCN_ID = :WK_DEVICE
         WHERE SSN_ID = :WK_USED_SSN;
        EXECUTE PROCEDURE ADD_SSN_HIST(:WK_DEVICE_WH, :WK_DEVICE, :WK_USED_SSN, 
                 'PKOL', 'P', :WK_DATE,
                 'Automatic Pick' , '', :WK_IS_USED_QTY, :WK_USER, :WK_DEVICE); 
        /* no detail record */
        INSERT INTO PICK_ITEM_DETAIL 
            (PICK_LABEL_NO, 
             SSN_ID, 
             PICK_DETAIL_STATUS, 
             QTY_PICKED,
             USER_ID, 
             DEVICE_ID, 
             CREATE_DATE,
             FROM_WH_ID,
             FROM_LOCN_ID)
        VALUES (:WK_LABEL_NO, 
             :WK_USED_SSN,
             :WK_PI_STATUS,
             :WK_IS_USED_QTY,
             :WK_USER,
             :WK_DEVICE,
             :WK_DATE,
             :WK_FROM_WH,
             :WK_FROM_LOCN);
        WK_PI_PICKED_QTY = WK_PI_PICKED_QTY + WK_TOPICK_QTY;
        UPDATE PICK_ITEM
        SET  PICK_LINE_STATUS =
                :WK_PI_STATUS,
                PICKED_QTY = :WK_PI_PICKED_QTY
        WHERE PICK_LABEL_NO = :WK_LABEL_NO;
        /* do pkil */
        IF (WK_PI_DESPATCH_LOCN IS NULL) THEN
        BEGIN
           WK_PI_DESPATCH_LOCN = SUBSTR(WK_DEFAULT_DESPATCH_LOCN,3,10);
        END
        EXECUTE PROCEDURE ADD_TRAN(
             :WK_DEFAULT_DESPATCH_WH,
             :WK_PI_DESPATCH_LOCN,
             :WK_PI_PROD,
             'PKIL',
             'P',
             :WK_DATE,
             '',
             :WK_PI_PICKED_QTY,
             'f',
             '',
             'MASTER',
             0,
             '',
             'SSSSSSSSS',
             :WK_USER,
             :WK_DEVICE);
        
     END
   /* EXECUTE PROCEDURE TRAN_ARCHIVE; */
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_NISU FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 121 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'NISU') THEN
  BEGIN
   EXECUTE PROCEDURE PC_NIXX 
    NEW.RECORD_ID ,
    NEW.WH_ID,
    NEW.LOCN_ID,
    NEW.OBJECT,
    'NISU',
    NEW.TRN_CODE,
    NEW.TRN_DATE,
    NEW.REFERENCE,
    NEW.QTY,
    NEW.PERSON_ID,
    NEW.DEVICE_ID,
    NEW.INSTANCE_ID;
   /* EXECUTE PROCEDURE TRAN_ARCHIVE; */
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_PKBS FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 122 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_PROD_CNT INTEGER;
DECLARE VARIABLE WK_ORDER_CNT INTEGER;
DECLARE VARIABLE WK_RECORD INTEGER;
DECLARE VARIABLE WK_FROM_DEVICE CHAR(2);
DECLARE VARIABLE WK_PROD VARCHAR(30);
DECLARE VARIABLE WK_ORDER VARCHAR(30);
DECLARE VARIABLE WK_LOCN_SEQ DECIMAL(7,3);

DECLARE VARIABLE WK_DEVICE CHAR(2);
DECLARE VARIABLE WK_USER VARCHAR(10);
DECLARE VARIABLE WK_DATE TIMESTAMP;
DECLARE VARIABLE WK_REFERENCE VARCHAR(40);
DECLARE VARIABLE WK_ERROR_TEXT VARCHAR(255);
DECLARE VARIABLE WK_ALLOCATE_DEVICE VARCHAR(40);
DECLARE VARIABLE WK_PICK_USER VARCHAR(40);
BEGIN
/* 27-02-07 add the locn seq from the chosen location
            to the pick_item for faster selection */
/*
zero value for pick_locn_seq means 
no locn_seq for the locations where product was found
!!!!
should this be set to 9999999
*/

 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'PKBS') THEN
  BEGIN
     WK_RECORD = NEW.RECORD_ID;
     WK_PROD_CNT = 0;
     WK_ORDER_CNT = 0;
     IF (NEW.TRN_CODE = 'P') THEN
     BEGIN
         FOR SELECT ZONE.DEFAULT_DEVICE_ID   
         FROM COMPANY 
         JOIN OPTIONS ON OPTIONS.GROUP_CODE = 'CMPPKPROD' AND OPTIONS.CODE = COMPANY.COMPANY_ID AND OPTIONS.DESCRIPTION = 'P' 
         JOIN ZONE ON ZONE.COMPANY_ID = COMPANY.COMPANY_ID 
         INTO :WK_FROM_DEVICE
         DO
         BEGIN
            FOR SELECT DISTINCT(P1.PROD_ID)
            FROM PICK_ITEM P1
            JOIN PICK_ORDER P2 ON P2.PICK_ORDER = P1.PICK_ORDER 
            JOIN ISSN I1 ON I1.PROD_ID = P1.PROD_ID 
            JOIN LOCATION L1 ON L1.WH_ID = I1.WH_ID AND L1.LOCN_ID = I1.LOCN_ID 
            JOIN CONTROL C1 ON RECORD_ID = 1
            WHERE P1.PICK_LINE_STATUS IN ('AL') 
            AND  P1.PICK_ORDER_QTY > 0   
            AND  P1.DEVICE_ID = :WK_FROM_DEVICE
            AND P1.OVER_SIZED = 'T'
            AND P2.PICK_STATUS IN ('OP','DA')
            AND (I1.WH_ID < 'X' OR I1.WH_ID > 'X~')
            AND (POS(C1.PICK_IMPORT_SSN_STATUS,I1.ISSN_STATUS,0,1) > -1)
            AND (I1.CURRENT_QTY > 0)
            ORDER BY P2.PICK_PRIORITY, P2.WIP_ORDERING, L1.LOCN_SEQ, P1.WIP_POSTLOCN_ORDERING 
            INTO :WK_PROD
            DO
            BEGIN
               WK_PROD_CNT = WK_PROD_CNT + 1;
               /* get the locn seq for this prod */
               WK_LOCN_SEQ = 0;
               SELECT MIN(L1.LOCN_SEQ)
               FROM ISSN I1 
               JOIN LOCATION L1 ON L1.WH_ID = I1.WH_ID AND L1.LOCN_ID = I1.LOCN_ID 
               JOIN CONTROL C1 ON RECORD_ID = 1
               WHERE I1.PROD_ID = :WK_PROD 
               AND (I1.WH_ID < 'X' OR I1.WH_ID > 'X~')
               AND (POS(C1.PICK_IMPORT_SSN_STATUS,I1.ISSN_STATUS,0,1) > -1)
               AND (I1.CURRENT_QTY > 0)
               INTO :WK_LOCN_SEQ;
               IF (WK_LOCN_SEQ IS NULL) THEN
               BEGIN
                  WK_LOCN_SEQ = 0;
               END
               UPDATE PICK_ITEM 
               SET PICK_LINE_PRIORITY = :WK_PROD_CNT,
                   PICK_LOCN_SEQ = :WK_LOCN_SEQ
               WHERE PROD_ID = :WK_PROD
               AND DEVICE_ID = :WK_FROM_DEVICE
               AND PICK_LINE_STATUS = 'AL'
               AND OVER_SIZED = 'T';
            END /* end for 2 */
         END /* end for 1 */
         FOR SELECT ZONE.DEFAULT_DEVICE_ID   
         FROM COMPANY 
         JOIN OPTIONS ON OPTIONS.GROUP_CODE = 'CMPPKPROD' AND OPTIONS.CODE = COMPANY.COMPANY_ID AND OPTIONS.DESCRIPTION = 'O' 
         JOIN ZONE ON ZONE.COMPANY_ID = COMPANY.COMPANY_ID 
         INTO :WK_FROM_DEVICE
         DO
         BEGIN
            FOR SELECT DISTINCT(P1.PICK_ORDER)
            FROM PICK_ITEM P1
            JOIN PICK_ORDER P2 ON P2.PICK_ORDER = P1.PICK_ORDER 
            JOIN ISSN I1 ON I1.PROD_ID = P1.PROD_ID 
            JOIN LOCATION L1 ON L1.WH_ID = I1.WH_ID AND L1.LOCN_ID = I1.LOCN_ID 
            JOIN CONTROL C1 ON RECORD_ID = 1
            WHERE P1.PICK_LINE_STATUS IN ('AL') 
            AND  P1.PICK_ORDER_QTY > 0   
            AND  P1.DEVICE_ID = :WK_FROM_DEVICE
            AND P2.PICK_STATUS IN ('OP','DA')
            AND (I1.WH_ID < 'X' OR I1.WH_ID > 'X~')
            AND (POS(C1.PICK_IMPORT_SSN_STATUS,I1.ISSN_STATUS,0,1) > -1)
            ORDER BY LPAD(MER_DAY(P1.CREATE_DATE),'0',2),LPAD(MER_HOUR(P1.CREATE_DATE),'0',2)  
            /* AND P1.OVER_SIZED = 'T' */
            /* ORDER BY LPAD(MER_DAY(P1.CREATED_DATE),'0',2),LPAD(MER_HOUR(P1.CREATED_DATE),'0',2),number of lines */  
            /* ORDER BY P2.PICK_PRIORITY, P2.WIP_ORDERING, L1.LOCN_SEQ, P1.WIP_POSTLOCN_ORDERING */ 
            INTO :WK_ORDER
            DO
            BEGIN
               WK_ORDER_CNT = WK_ORDER_CNT + 1;
               UPDATE PICK_ITEM 
               SET PICK_LINE_PRIORITY = :WK_ORDER_CNT
               WHERE PICK_ORDER = :WK_ORDER
               AND DEVICE_ID = :WK_FROM_DEVICE
               AND PICK_LINE_STATUS = 'AL'
               /* AND OVER_SIZED = 'T' */;
            END /* end for 2 */
         END /* end for 1 */
         EXECUTE PROCEDURE UPDATE_TRAN (:WK_RECORD, 'T','Processed successfully');
         /* EXECUTE PROCEDURE TRAN_ARCHIVE; */
     END /* code P */
     IF (NEW.TRN_CODE = 'D') THEN
     BEGIN
        /* for products on the device set the locn seq and priority - so pick across all orders a product - we do not seperate oversized products here */
        WK_REFERENCE = NEW.REFERENCE;
        WK_USER = NEW.PERSON_ID;
        WK_DEVICE = NEW.DEVICE_ID;
        WK_ERROR_TEXT = '';

        EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_REFERENCE, 1  RETURNING_VALUES :WK_PICK_USER ; 
        EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_REFERENCE, 2  RETURNING_VALUES :WK_ALLOCATE_DEVICE ; 
        IF (WK_PICK_USER = '') THEN
        BEGIN
           WK_PICK_USER = WK_USER;
        END
        IF (WK_ALLOCATE_DEVICE = '') THEN
        BEGIN
           WK_ALLOCATE_DEVICE = WK_DEVICE;
        END
        WK_FROM_DEVICE = WK_ALLOCATE_DEVICE;
         BEGIN
            FOR SELECT DISTINCT(P1.PROD_ID)
            FROM PICK_ITEM P1
            JOIN PICK_ORDER P2 ON P2.PICK_ORDER = P1.PICK_ORDER 
            JOIN ISSN I1 ON I1.PROD_ID = P1.PROD_ID 
            JOIN LOCATION L1 ON L1.WH_ID = I1.WH_ID AND L1.LOCN_ID = I1.LOCN_ID 
            JOIN CONTROL C1 ON RECORD_ID = 1
            WHERE P1.PICK_LINE_STATUS IN ('AL') 
            AND  P1.PICK_ORDER_QTY > 0   
            AND  P1.DEVICE_ID = :WK_FROM_DEVICE
            AND P2.PICK_STATUS IN ('OP','DA')
            AND (I1.WH_ID < 'X' OR I1.WH_ID > 'X~')
            AND (POS(C1.PICK_IMPORT_SSN_STATUS,I1.ISSN_STATUS,0,1) > -1)
            AND (I1.CURRENT_QTY > 0)
            ORDER BY P2.PICK_PRIORITY, P2.WIP_ORDERING, L1.LOCN_SEQ, P1.WIP_POSTLOCN_ORDERING 
            INTO :WK_PROD
            DO
            BEGIN
               WK_PROD_CNT = WK_PROD_CNT + 1;
               /* get the locn seq for this prod */
               WK_LOCN_SEQ = 0;
               SELECT MIN(L1.LOCN_SEQ)
               FROM ISSN I1 
               JOIN LOCATION L1 ON L1.WH_ID = I1.WH_ID AND L1.LOCN_ID = I1.LOCN_ID 
               JOIN CONTROL C1 ON RECORD_ID = 1
               WHERE I1.PROD_ID = :WK_PROD 
               AND (I1.WH_ID < 'X' OR I1.WH_ID > 'X~')
               AND (POS(C1.PICK_IMPORT_SSN_STATUS,I1.ISSN_STATUS,0,1) > -1)
               AND (I1.CURRENT_QTY > 0)
               INTO :WK_LOCN_SEQ;
               IF (WK_LOCN_SEQ IS NULL) THEN
               BEGIN
                  WK_LOCN_SEQ = 0;
               END
               UPDATE PICK_ITEM 
               SET PICK_LINE_PRIORITY = :WK_PROD_CNT,
                   PICK_LOCN_SEQ = :WK_LOCN_SEQ
               WHERE PROD_ID = :WK_PROD
               AND DEVICE_ID = :WK_FROM_DEVICE
               AND PICK_LINE_STATUS = 'AL';
            END /* end for 2 */
         END /* end for 1 */
         EXECUTE PROCEDURE UPDATE_TRAN (:WK_RECORD, 'T','Processed successfully');
         /* EXECUTE PROCEDURE TRAN_ARCHIVE; */
     END /* code D */
  END /* PKBS */
 END /* AUTORUN */
END ^

CREATE TRIGGER RUN_TRANSACTION_NIPD FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 123 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'NIPD') THEN
  BEGIN
   EXECUTE PROCEDURE PC_NIXX 
    NEW.RECORD_ID ,
    NEW.WH_ID,
    NEW.LOCN_ID,
    NEW.OBJECT,
    NEW.TRN_TYPE,
    NEW.TRN_CODE,
    NEW.TRN_DATE,
    NEW.REFERENCE,
    NEW.QTY,
    NEW.PERSON_ID,
    NEW.DEVICE_ID,
    NEW.INSTANCE_ID;
   /* EXECUTE PROCEDURE TRAN_ARCHIVE; */
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_NID3 FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 124 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'NID3') THEN
  BEGIN
   EXECUTE PROCEDURE PC_NIXX 
    NEW.RECORD_ID ,
    NEW.WH_ID,
    NEW.LOCN_ID,
    NEW.OBJECT,
    NEW.TRN_TYPE,
    NEW.TRN_CODE,
    NEW.TRN_DATE,
    NEW.REFERENCE,
    NEW.QTY,
    NEW.PERSON_ID,
    NEW.DEVICE_ID,
    NEW.INSTANCE_ID;
   /* EXECUTE PROCEDURE TRAN_ARCHIVE; */
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_PKUS FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 125 
AS
/* Update pick_order or items status */
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_DEVICE CHAR(2);
DECLARE VARIABLE WK_STATUS_FROM VARCHAR(40);
DECLARE VARIABLE WK_STATUS_TO VARCHAR(40);
DECLARE VARIABLE WK_USER VARCHAR(10);
DECLARE VARIABLE WK_RECORD INTEGER;
DECLARE VARIABLE WK_ORDER VARCHAR(30);
DECLARE VARIABLE WK_REF VARCHAR(40);
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'PKUS') THEN
  BEGIN
     WK_DEVICE = NEW.WH_ID;
     WK_USER = NEW.PERSON_ID;
     WK_RECORD = NEW.RECORD_ID;
     WK_ORDER = NEW.OBJECT;
     WK_REF = NEW.REFERENCE;
     EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_REF, 1  RETURNING_VALUES :WK_STATUS_FROM ; 
     EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_REF, 2  RETURNING_VALUES :WK_STATUS_TO ; 
     IF (NEW.TRN_CODE = 'O') THEN
     BEGIN
        /* transfer all picks from one device to another */
        UPDATE PICK_ORDER
           SET PICK_STATUS = :WK_STATUS_TO
           WHERE PICK_ORDER = :WK_ORDER
           AND PICK_STATUS = :WK_STATUS_FROM;
        EXECUTE PROCEDURE UPDATE_TRAN (WK_RECORD, 'T','Processed successfully');
     END
     ELSE
     IF (NEW.TRN_CODE = 'L') THEN
     BEGIN
        UPDATE PICK_ITEM
           SET PICK_LINE_STATUS = :WK_STATUS_TO
           WHERE PICK_ORDER = :WK_ORDER
           AND PICK_LINE_STATUS = :WK_STATUS_FROM;
        EXECUTE PROCEDURE UPDATE_TRAN (WK_RECORD, 'T','Processed successfully');
     END
     /*
   EXECUTE PROCEDURE TRAN_ARCHIVE;
   */
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_STPZ FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 126 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_DEVICE CHAR(2);
DECLARE VARIABLE WK_USER VARCHAR(10);
DECLARE VARIABLE WK_RECORD INTEGER;
DECLARE VARIABLE WK_SUB_LOCN VARCHAR(10);
DECLARE VARIABLE WK_WH_ID CHAR(2);
DECLARE VARIABLE WK_LOCN_ID VARCHAR(10);
DECLARE VARIABLE WK_OBJECT VARCHAR(30);
DECLARE VARIABLE WK_REF VARCHAR(40);
DECLARE VARIABLE WK_QTY INTEGER;
DECLARE VARIABLE WK_DATE TIMESTAMP;
DECLARE VARIABLE WK_TRN_TYPE VARCHAR(4);
DECLARE VARIABLE WK_TRN_CODE CHAR(1);

DECLARE VARIABLE WK_AUDIT_DESC VARCHAR(40);
DECLARE VARIABLE WK_QTY_REMAINING INTEGER;
DECLARE VARIABLE WK_IS_FOUND INTEGER;

DECLARE VARIABLE WK_IS_QTY INTEGER;
DECLARE VARIABLE WK_QTY_TO_USE INTEGER;
DECLARE VARIABLE WK_IS_SSN VARCHAR(20);
DECLARE VARIABLE WK_IS_ORIGINAL_SSN VARCHAR(20);
DECLARE VARIABLE WK_IS_QTY_REMAINING INTEGER;
DECLARE VARIABLE WK_USED_SSN VARCHAR(20);
DECLARE VARIABLE WK_IS_USED_QTY INTEGER;
DECLARE VARIABLE WK_DO_UASL CHAR(1);
DECLARE VARIABLE WK_RECORD2 INTEGER;
DECLARE VARIABLE WK_ISSN_ID INTEGER;
DECLARE VARIABLE SSN_LENGTH INTEGER;
DECLARE VARIABLE WK_ISSN_VALUE VARCHAR(20);
DECLARE VARIABLE WK_COMPANY VARCHAR(20);
DECLARE VARIABLE WK_NEW_PROD_STATUS VARCHAR(2);
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'STPZ') THEN
  BEGIN
     WK_DEVICE = NEW.DEVICE_ID;
     WK_SUB_LOCN = NEW.SUB_LOCN_ID;
     WK_WH_ID = NEW.WH_ID;
     WK_LOCN_ID = NEW.LOCN_ID;
     WK_USER = NEW.PERSON_ID;
     WK_OBJECT = NEW.OBJECT;
     WK_REF = ALLTRIM(NEW.REFERENCE);
     WK_QTY = NEW.QTY;
     WK_DATE = NEW.TRN_DATE;
     WK_RECORD = NEW.RECORD_ID;
     WK_TRN_CODE = NEW.TRN_CODE;
     WK_TRN_TYPE = NEW.TRN_TYPE;

     WK_AUDIT_DESC = 'Adjust Product Qty ignoring status' ;
/*
     in this transaction
     the object is the product
     the qty is the adjustment qty
     the wh_id and locn_id specify the location
     the reference is a comment for the ssn_hist

*/
     SELECT SEND_UASL_V4,NEW_PROD_STATUS 
     FROM CONTROL 
     INTO :WK_DO_UASL, :WK_NEW_PROD_STATUS;

     IF (NEW.TRN_CODE = 'P')  THEN
     BEGIN
/*
         qty remaining = adjustment qty
         while (qty required (remaining) < 0) & not at end of issn's
            get an issn for product in the right location 
            and the right status
            if qty required(remaining) > 0 - current_qty
               update issn current_qty to current_qty + qty required
               increase qty required (remaining) by qty took
            if qty required(remaining) = 0 - current_qty
               take all of the issn
               update issn current qty to 0
               increase reduce qty required (remaining) by qty took
         end while
         if now qty required remaining is still < zero - have problem
         not enough stock - so since the level is now zero is ok   

         if now qty required is > 0
         ie was +ve
         must get the 1st issn for product in the right location 
            and the right status
         increase its current qty by the qty remaining

*/
        WK_QTY_REMAINING = WK_QTY;
   
        /* must get issns to make up qty to use */
        WK_IS_QTY_REMAINING = 0 - WK_QTY_REMAINING;
        FOR SELECT CURRENT_QTY, SSN_ID, ORIGINAL_SSN
            FROM ISSN
            WHERE PROD_ID = :WK_OBJECT
            AND WH_ID = :WK_WH_ID
            AND LOCN_ID = :WK_LOCN_ID
            AND CURRENT_QTY > 0
            INTO :WK_IS_QTY, :WK_IS_SSN, :WK_IS_ORIGINAL_SSN 
        DO
        BEGIN
           IF (WK_IS_QTY_REMAINING > 0) THEN
           BEGIN
              /* how much can I take */
              /* either issn qty or remaining qty if its less */
              WK_USED_SSN = WK_IS_SSN;
              WK_IS_USED_QTY = WK_IS_QTY;
              IF (WK_IS_QTY_REMAINING < WK_IS_QTY) THEN
              BEGIN
                 WK_IS_USED_QTY = WK_IS_QTY_REMAINING;
                 /*  wk_is_qty_remaining */
                 /* so end of issns that we take */
              END
              UPDATE ISSN SET 
               CURRENT_QTY = CURRENT_QTY - :WK_IS_USED_QTY
               WHERE SSN_ID = :WK_USED_SSN;
              UPDATE SSN SET 
               CURRENT_QTY = CURRENT_QTY - :WK_IS_USED_QTY
               WHERE SSN_ID = :WK_IS_ORIGINAL_SSN;
              /* must reduce wk_is_qty_remaining by wk_is_used_qty */
              WK_IS_QTY_REMAINING = WK_IS_QTY_REMAINING - WK_IS_USED_QTY;
              WK_IS_USED_QTY = 0 - WK_IS_USED_QTY;
              EXECUTE PROCEDURE ADD_SSN_HIST(:WK_WH_ID, :WK_LOCN_ID, :WK_USED_SSN, 
                       :WK_TRN_TYPE, :WK_TRN_CODE, :WK_DATE,
                       :WK_AUDIT_DESC , :WK_REF, :WK_IS_USED_QTY, :WK_USER, :WK_DEVICE); 
           END
        END /* end for issns loop */
        /* IF (WK_IS_QTY_REMAINING < 0) THEN */
        BEGIN
           /* must increase the 1st issn for locn and status */
           WK_IS_FOUND = 0;
           SELECT FIRST 1  1, CURRENT_QTY, SSN_ID, ORIGINAL_QTY
               FROM ISSN
               WHERE PROD_ID = :WK_OBJECT
               AND WH_ID = :WK_WH_ID
               AND LOCN_ID = :WK_LOCN_ID
               INTO :WK_IS_FOUND, :WK_IS_QTY, :WK_IS_SSN, :WK_IS_ORIGINAL_SSN; 
           IF (WK_IS_FOUND = 1) THEN
           BEGIN
              WK_IS_USED_QTY = 0 - WK_IS_QTY_REMAINING;
              UPDATE ISSN SET 
               CURRENT_QTY = CURRENT_QTY - :WK_IS_QTY_REMAINING
               WHERE SSN_ID = :WK_IS_SSN;
              UPDATE SSN SET 
               CURRENT_QTY = CURRENT_QTY - :WK_IS_QTY_REMAINING
               WHERE SSN_ID = :WK_IS_ORIGINAL_SSN;
              EXECUTE PROCEDURE ADD_SSN_HIST(:WK_WH_ID, :WK_LOCN_ID, :WK_IS_SSN, 
                       :WK_TRN_TYPE, :WK_TRN_CODE, :WK_DATE,
                       :WK_AUDIT_DESC , :WK_REF, :WK_IS_USED_QTY, :WK_USER, :WK_DEVICE); 
              /* must reduce wk_is_qty_remaining by wk_is_used_qty */
   
              WK_IS_QTY_REMAINING = 0;
           END
           ELSE
           BEGIN
              /* none of product in location so create some */
              /* and set its qty to wk_is_qty_remaining */
              WK_IS_USED_QTY = 0 - WK_IS_QTY_REMAINING;
              WK_COMPANY = '';
              SELECT COMPANY_ID
              FROM PROD_PROFILE
              WHERE PROD_ID = :WK_OBJECT
              INTO :WK_COMPANY;
              WK_RECORD2 = GEN_ID(ISSN_SSN_ID, 1);
              WK_ISSN_ID = WK_RECORD2 - 1 ;
              /* Get length for Barcode */   
              EXECUTE PROCEDURE GET_BARCODE_LENGTH RETURNING_VALUES :SSN_LENGTH;
              WK_ISSN_VALUE =  WK_ISSN_ID;
              WHILE (STRLEN(WK_ISSN_VALUE) < SSN_LENGTH) DO
              BEGIN
                 WK_ISSN_VALUE = '0' || WK_ISSN_VALUE;
              END
              INSERT INTO ISSN   
                (SSN_ID, ORIGINAL_SSN, WH_ID, LOCN_ID, PREV_LOCN_ID, CURRENT_QTY, PREV_QTY,
                 PREV_DATE, ISSN_STATUS, CREATE_DATE, USER_ID, PROD_ID, ORIGINAL_QTY, COMPANY_ID)
        
           VALUES (:WK_ISSN_VALUE, :WK_ISSN_VALUE, :WK_WH_ID, :WK_LOCN_ID,'', :WK_IS_USED_QTY, 0,
                   'NOW', :WK_NEW_PROD_STATUS, 'NOW', :WK_USER, :WK_OBJECT , :WK_IS_USED_QTY, :WK_COMPANY);
              INSERT INTO SSN (SSN_ID, WH_ID, LOCN_ID, PROD_ID, COMPANY_ID, CURRENT_QTY, ORIGINAL_QTY, CREATE_DATE, CREATED_BY, STATUS_SSN)    
              VALUES (:WK_ISSN_VALUE, :WK_WH_ID, :WK_LOCN_ID, :WK_OBJECT, :WK_COMPANY, :WK_IS_USED_QTY, :WK_IS_USED_QTY, 'NOW', :WK_USER, :WK_NEW_PROD_STATUS);
              EXECUTE PROCEDURE ADD_SSN_HIST(:WK_WH_ID, :WK_LOCN_ID, :WK_ISSN_VALUE, 
                    :WK_TRN_TYPE, :WK_TRN_CODE, :WK_DATE,
                    :WK_AUDIT_DESC , :WK_REF, :WK_IS_USED_QTY, :WK_USER, :WK_DEVICE); 
              /* must reduce wk_is_qty_remaining by wk_is_used_qty */
   
              WK_IS_QTY_REMAINING = 0;
           END
        END
        EXECUTE PROCEDURE UPDATE_TRAN (WK_RECORD, 'T','Processed successfully');
        IF (WK_DO_UASL = 'T') THEN
        BEGIN
           EXECUTE PROCEDURE SEND_PICKABLE_STOCK (:WK_OBJECT,
              :WK_USER,
              :WK_DEVICE,
              :WK_DATE);
        END
     END /* of code P */
   EXECUTE PROCEDURE TRAN_ARCHIVE;
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_PKUP FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 127 
AS
/* update a picks pick_line_priority */
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_DEVICE CHAR(2);
DECLARE VARIABLE WK_USER VARCHAR(10);
DECLARE VARIABLE WK_RECORD INTEGER;
DECLARE VARIABLE WK_DATE TIMESTAMP;
DECLARE VARIABLE WK_LABEL VARCHAR(10);
DECLARE VARIABLE WK_PROD VARCHAR(30);
DECLARE VARIABLE WK_ORDER VARCHAR(15);
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'PKUP') THEN
  BEGIN
     WK_USER = NEW.PERSON_ID;
     WK_DEVICE = NEW.DEVICE_ID;
     WK_DATE = NEW.TRN_DATE;
     WK_RECORD = NEW.RECORD_ID;
     IF (NEW.TRN_CODE = 'L') THEN
     BEGIN
        /* update a picks pick_line_priority */
        WK_LABEL = NEW.OBJECT;
        UPDATE PICK_ITEM
           SET PICK_LINE_PRIORITY = PICK_LINE_PRIORITY + NEW.QTY
           WHERE PICK_LABEL_NO = :WK_LABEL
           AND PICK_LINE_PRIORITY IS NOT NULL;
        UPDATE PICK_ITEM
           SET PICK_LINE_PRIORITY = NEW.QTY
           WHERE PICK_LABEL_NO = :WK_LABEL
           AND PICK_LINE_PRIORITY IS NULL;
        EXECUTE PROCEDURE UPDATE_TRAN (WK_RECORD, 'T','Processed successfully');
     END
     ELSE
     BEGIN
        IF (NEW.TRN_CODE = 'P') THEN
        BEGIN
           /* update a picks pick_line_priority */
           WK_PROD = NEW.OBJECT;
           UPDATE PICK_ITEM
              SET PICK_LINE_PRIORITY = PICK_LINE_PRIORITY + NEW.QTY
              WHERE DEVICE_ID = :WK_DEVICE
              AND PROD_ID = :WK_PROD
              AND PICK_LINE_PRIORITY IS NOT NULL;
           UPDATE PICK_ITEM
              SET PICK_LINE_PRIORITY = NEW.QTY
              WHERE DEVICE_ID = :WK_DEVICE
              AND PROD_ID = :WK_PROD
              AND PICK_LINE_PRIORITY IS NULL;
           EXECUTE PROCEDURE UPDATE_TRAN (WK_RECORD, 'T','Processed successfully');
        END
        ELSE
        BEGIN
           IF (NEW.TRN_CODE = 'O') THEN
           BEGIN
              /* update a picks pick_line_priority */
              WK_ORDER = NEW.OBJECT;
              UPDATE PICK_ITEM
                 SET PICK_LINE_PRIORITY = PICK_LINE_PRIORITY + NEW.QTY
                 WHERE DEVICE_ID = :WK_DEVICE
                 AND PICK_ORDER  = :WK_ORDER
                 AND PICK_LINE_PRIORITY IS NOT NULL;
              UPDATE PICK_ITEM
                 SET PICK_LINE_PRIORITY = NEW.QTY
                 WHERE DEVICE_ID = :WK_DEVICE
                 AND PICK_ORDER  = :WK_ORDER
                 AND PICK_LINE_PRIORITY IS NULL;
              EXECUTE PROCEDURE UPDATE_TRAN (WK_RECORD, 'T','Processed successfully');
           END
        END
     END
     /*
   EXECUTE PROCEDURE TRAN_ARCHIVE;
   */
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_PKOZ FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 128 
AS
/* Pick a whole order using the imported locns   
   only if order has status OP or DA
   transfer the order to the device 
   031006 -  can only do this to pick a whole line
   for lines in this order
       with statuses AL PG PL
            and over_sized = 'F'
       do a PKOL for the wh_id and pick_location
          for the min of the required qty (order qty - picked)
              and qty in location
              if this is not the required qty then 
                 dont do the pkol
    at the end of this for
    if all picked OK
    do a PKIL (M) to the default despatch location
             make status 'AL' and device the default one
    
*/

DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_DEVICE CHAR(2);
DECLARE VARIABLE WK_USER VARCHAR(10);
DECLARE VARIABLE WK_RECORD INTEGER;
DECLARE VARIABLE WK_DATE TIMESTAMP;
DECLARE VARIABLE WK_ORDER VARCHAR(30);
DECLARE VARIABLE WK_DEVICE_2 CHAR(2);
DECLARE VARIABLE WK_PO_STATUS CHAR(2);
DECLARE VARIABLE WK_PO_COMPANY VARCHAR(20);
DECLARE VARIABLE WK_PO_COUNTRY VARCHAR(25);
DECLARE VARIABLE WK_PI_PROD VARCHAR(30);
DECLARE VARIABLE WK_PI_ORDER_QTY INTEGER;
DECLARE VARIABLE WK_PI_PICKED_QTY INTEGER;
DECLARE VARIABLE WK_PI_WH_ID CHAR(2);
DECLARE VARIABLE WK_PI_LOCN_ID VARCHAR(10);
DECLARE VARIABLE WK_PI_DEVICE CHAR(2);
DECLARE VARIABLE WK_PI_STATUS CHAR(2);
DECLARE VARIABLE WK_DOIT CHAR(1);
DECLARE VARIABLE WK_IMPORTSTATUS VARCHAR(40);
DECLARE VARIABLE WK_CURRENT_QTY INTEGER;
DECLARE VARIABLE WK_TOPICK_QTY INTEGER;
DECLARE VARIABLE WK_DESPATCH_LOCATION VARCHAR(10);
DECLARE VARIABLE WK_DESPATCH_WH CHAR(2);
DECLARE VARIABLE WK_DESPATCH_LOCN VARCHAR(10);
DECLARE VARIABLE WK_FOUND INTEGER;
DECLARE VARIABLE WK_LOG VARCHAR(255);
DECLARE VARIABLE WK_PI_LABEL_NO VARCHAR(10);
DECLARE VARIABLE WK_DO_DSDX VARCHAR(40);
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'PKOZ') THEN
  BEGIN
     WK_USER = NEW.PERSON_ID;
     WK_DEVICE = NEW.DEVICE_ID;
     WK_DATE = NEW.TRN_DATE;
     WK_RECORD = NEW.RECORD_ID;
     WK_ORDER = NEW.OBJECT;
     WK_DOIT = 'T';
     SELECT PICK_IMPORT_SSN_STATUS, DEFAULT_DESPATCH_LOCATION
     FROM CONTROL
     INTO :WK_IMPORTSTATUS, :WK_DESPATCH_LOCATION; 
     WK_DESPATCH_WH = SUBSTR(WK_DESPATCH_LOCATION,1,2);
     WK_DESPATCH_LOCN = SUBSTR(WK_DESPATCH_LOCATION,3,10);
     SELECT PICK_STATUS, COMPANY_ID, P_COUNTRY
     FROM PICK_ORDER
     WHERE PICK_ORDER = :WK_ORDER
     INTO :WK_PO_STATUS, :WK_PO_COMPANY, :WK_PO_COUNTRY;
     IF (WK_PO_STATUS IS NULL) THEN
     BEGIN
        WK_PO_STATUS = '';
     END
     IF ((WK_PO_STATUS = 'OP') OR (WK_PO_STATUS = 'DA')) THEN
     BEGIN
        UPDATE PICK_ORDER SET PICK_ORDER_STARTED = 'NOW'
        WHERE PICK_ORDER = :WK_ORDER;   
        UPDATE PICK_ITEM 
        SET DEVICE_ID = :WK_DEVICE
        WHERE PICK_ORDER = :WK_ORDER    
        AND PICK_LINE_STATUS IN ('AL','PG','PL')
        AND OVER_SIZED = 'F';
/*
        UPDATE PICK_ITEM_DETAIL
        SET DEVICE_ID = :WK_DEVICE
        WHERE PICK_LABEL_NO IN 
           (SELECT PICK_LABEL_NO FROM PICK_ITEM
            WHERE PICK_ORDER = :WK_ORDER    
            AND DEVICE_ID = :WK_DEVICE);
*/
        FOR SELECT PICK_LABEL_NO
            FROM PICK_ITEM
            WHERE PICK_ORDER = :WK_ORDER    
            AND DEVICE_ID = :WK_DEVICE
            INTO :WK_PI_LABEL_NO
        DO
        BEGIN
           UPDATE PICK_ITEM_DETAIL
           SET DEVICE_ID = :WK_DEVICE
           WHERE PICK_LABEL_NO =  :WK_PI_LABEL_NO;
        END
        FOR SELECT PROD_ID, 
           PICK_ORDER_QTY, 
           PICKED_QTY,  
           WH_ID, 
           PICK_LOCATION,
           DEVICE_ID,
           PICK_LINE_STATUS
        FROM PICK_ITEM
        WHERE PICK_ORDER = :WK_ORDER    
        AND DEVICE_ID = :WK_DEVICE
        AND (PICK_LINE_STATUS IN ('AL','PG')
 OR   (PICK_LINE_STATUS ='PL' AND PICKED_QTY < PICK_ORDER_QTY AND (REASON = '' OR REASON IS NULL))) 
        AND OVER_SIZED = 'F'
        INTO :WK_PI_PROD, :WK_PI_ORDER_QTY, :WK_PI_PICKED_QTY, :WK_PI_WH_ID, :WK_PI_LOCN_ID, :WK_PI_DEVICE, WK_PI_STATUS
        DO
        BEGIN
           IF (WK_DOIT = 'T') THEN
           BEGIN
              WK_DOIT = 'L';
           END
           IF (WK_PI_ORDER_QTY IS NULL) THEN
           BEGIN
              WK_PI_ORDER_QTY = 0;
           END
           IF (WK_PI_PICKED_QTY IS NULL) THEN
           BEGIN
              WK_PI_PICKED_QTY = 0;
           END
           SELECT SUM( ISSN.CURRENT_QTY ) 
              FROM ISSN
              WHERE ISSN.PROD_ID = :WK_PI_PROD
              AND WH_ID = :WK_PI_WH_ID
              AND LOCN_ID = :WK_PI_LOCN_ID
              AND (POS(:WK_IMPORTSTATUS,ISSN.ISSN_STATUS,0,1) > -1) 
              INTO :WK_CURRENT_QTY;
           IF (WK_CURRENT_QTY IS NULL) THEN
           BEGIN
              WK_CURRENT_QTY = 0;
           END
           WK_TOPICK_QTY =  WK_PI_ORDER_QTY - WK_PI_PICKED_QTY;
           IF (WK_TOPICK_QTY > WK_CURRENT_QTY) THEN
           BEGIN
              /* WK_TOPICK_QTY = WK_CURRENT_QTY; */
              WK_TOPICK_QTY = 0;
           END
           IF (WK_TOPICK_QTY > 0) THEN
           BEGIN
              /* have something to pick */
              /* do pkol */
              EXECUTE PROCEDURE ADD_TRAN(
                 :WK_PI_WH_ID,
                 :WK_PI_LOCN_ID,
                 :WK_PI_PROD,
                 'PKOL',
                 'P',
                 'NOW',
                 '',
                 :WK_TOPICK_QTY,
                 'F',
                 '',
                 'MASTER',
                 0,
                 '',
                 'SSSSSSSSS',
                 :WK_USER,
                 :WK_DEVICE);
           END
        END /* for */
        IF (WK_DOIT = 'T') THEN
        BEGIN
           /* do we have any PL lines */
           WK_FOUND = 0;
           SELECT FIRST 1  1 
           FROM PICK_ITEM
           WHERE PICK_ORDER = :WK_ORDER    
           AND DEVICE_ID = :WK_DEVICE
           AND PICK_LINE_STATUS = 'PL'
           AND OVER_SIZED = 'F'
           INTO :WK_FOUND;
           IF (WK_FOUND = 1) THEN
           BEGIN
              WK_DOIT = 'K';
           END
        END
        IF ((WK_DOIT = 'L') OR (WK_DOIT = 'K')) THEN
        BEGIN
           /* do pkil */
             EXECUTE PROCEDURE ADD_TRAN(
                :WK_DESPATCH_WH,
                :WK_DESPATCH_LOCN,
                :WK_ORDER,
                'PKIL',
                'M',
                 'NOW',
                '',
                1,
                'F',
                '',
                'MASTER',
                0,
                :WK_DEVICE,
                'SSSSSSSSS',
                :WK_USER,
                :WK_DEVICE);
        END

        SELECT FIRST 1 ZONE.DEFAULT_DEVICE_ID   
        FROM COMPANY 
        JOIN ZONE ON ZONE.COMPANY_ID = COMPANY.COMPANY_ID 
        WHERE COMPANY.COMPANY_ID = :WK_PO_COMPANY
        INTO :WK_DEVICE_2;
        /* if company  set up for scanning at dx */
        WK_DO_DSDX = 'F';
        SELECT DESCRIPTION
        FROM OPTIONS
        WHERE GROUP_CODE = 'CMPPKDSDX'
        AND CODE = :WK_PO_COMPANY
        INTO :WK_DO_DSDX;
        IF (WK_DO_DSDX IS NULL) THEN
        BEGIN
           WK_DO_DSDX = 'F';
        END
        IF (WK_DO_DSDX = 'T') THEN
        BEGIN
           /* now change the status of the DS lines to DX */
           UPDATE PICK_ITEM 
           SET DEVICE_ID = :WK_DEVICE_2,
               PICK_LINE_STATUS = 'DX'
           WHERE PICK_ORDER = :WK_ORDER    
           AND DEVICE_ID = :WK_DEVICE
           AND OVER_SIZED = 'F'
           AND PICK_LINE_STATUS = 'DS';
        END
        /* return order to original device */
        UPDATE PICK_ITEM 
        SET DEVICE_ID = :WK_DEVICE_2
        WHERE PICK_ORDER = :WK_ORDER    
        AND DEVICE_ID = :WK_DEVICE
        AND OVER_SIZED = 'F';
        UPDATE PICK_ITEM_DETAIL
        SET DEVICE_ID = :WK_DEVICE_2
        WHERE DEVICE_ID = :WK_DEVICE
        AND PICK_LABEL_NO IN 
           (SELECT PICK_LABEL_NO FROM PICK_ITEM
            WHERE PICK_ORDER = :WK_ORDER);  
     END
     ELSE
     BEGIN
        WK_DOIT = 'X';
        EXECUTE PROCEDURE UPDATE_TRAN (:WK_RECORD, 'F', 'Cannot Pick Invalid Order Status'); 

     END 
     IF (WK_DOIT = 'T') THEN
     BEGIN
        EXECUTE PROCEDURE UPDATE_TRAN (:WK_RECORD, 'F', 'Nothing to Pick See Line Statuses'); 
     END
     IF ((WK_DOIT = 'L') OR (WK_DOIT = 'K')) THEN
     BEGIN
        EXECUTE PROCEDURE UPDATE_TRAN (:WK_RECORD, 'T', 'Processed successfully'); 
     END
     /*
   EXECUTE PROCEDURE TRAN_ARCHIVE;
   */
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_PKCR FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 129 
AS
/* Allow repick of an order */
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_DEVICE CHAR(2);
DECLARE VARIABLE WK_USER VARCHAR(10);
DECLARE VARIABLE WK_RECORD INTEGER;
DECLARE VARIABLE WK_DATE TIMESTAMP;
DECLARE VARIABLE WK_ORDER VARCHAR(30);
DECLARE VARIABLE WK_PO_STATUS CHAR(2);
DECLARE VARIABLE WK_DOIT CHAR(1);
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'PKCR') THEN
  BEGIN
     WK_USER = NEW.PERSON_ID;
     WK_DEVICE = NEW.DEVICE_ID;
     WK_DATE = NEW.TRN_DATE;
     WK_RECORD = NEW.RECORD_ID;
     WK_ORDER = NEW.OBJECT;
     WK_DOIT = 'F';
     /* get the default device */
     SELECT PICK_STATUS
     FROM PICK_ORDER 
     WHERE PICK_ORDER = :WK_ORDER
     INTO :WK_PO_STATUS;
     IF (WK_PO_STATUS IS NULL) THEN
     BEGIN
        WK_PO_STATUS = '';
        EXECUTE PROCEDURE UPDATE_TRAN (WK_RECORD, 'F','Order Not yet Confirmed - cannot repick');
     END
     IF (WK_PO_STATUS = 'HD' OR WK_PO_STATUS = 'CN') THEN
     BEGIN
        EXECUTE PROCEDURE UPDATE_TRAN (WK_RECORD, 'F','Order is Cancelled - cannot repick');
     END
     IF (WK_PO_STATUS = 'CF' OR WK_PO_STATUS = 'UC') THEN
     BEGIN
        EXECUTE PROCEDURE UPDATE_TRAN (WK_RECORD, 'F','Order is Not yet Approved for Picking - cannot repick');
     END
     IF (WK_PO_STATUS = 'DI' OR WK_PO_STATUS = 'DX') THEN
     BEGIN
        /* previously  gone out - reset to allow pick */
        UPDATE PICK_ORDER SET PICK_STATUS = 'DA'
        WHERE PICK_ORDER = :WK_ORDER;
        WK_DOIT = 'T';
     END
     IF (WK_PO_STATUS = 'OP' OR WK_PO_STATUS = 'DA') THEN
     BEGIN
        WK_DOIT = 'T';
     END
     IF (WK_DOIT = 'T') THEN
     BEGIN
        UPDATE PICK_ITEM
           SET PICKED_QTY = NULL, 
           PICK_LINE_STATUS = 'AL',
           DEVICE_ID = (SELECT ZONE.DEFAULT_DEVICE_ID
              FROM LOCATION
              JOIN ZONE ON ZONE.CODE = LOCATION.ZONE_C
              WHERE LOCATION.WH_ID = PICK_ITEM.WH_ID
              AND LOCATION.LOCN_ID = PICK_ITEM.PICK_LOCATION) 
           WHERE PICK_ORDER = :WK_ORDER
           AND PICK_LINE_STATUS IN ('AL', 'PG', 'OP', 'PL', 'UP', 'DS','DC','DX','DI');
        EXECUTE PROCEDURE UPDATE_TRAN (WK_RECORD, 'T','Processed successfully');
     END
     /*
   EXECUTE PROCEDURE TRAN_ARCHIVE;
   */
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_RTAL FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 130 
AS
/* Transfer of allocated pick to another handheld */
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_DEVICE CHAR(2);
DECLARE VARIABLE WK_USER VARCHAR(10);
DECLARE VARIABLE WK_RECORD INTEGER;
DECLARE VARIABLE WK_DATE TIMESTAMP;
DECLARE VARIABLE WK_PROD VARCHAR(30);
DECLARE VARIABLE WK_PICK_QTY INTEGER;
DECLARE VARIABLE WK_LINE_CNT INTEGER;
DECLARE VARIABLE WK_COMPANY VARCHAR(30);
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'RTAL') THEN
  BEGIN
     WK_USER = NEW.PERSON_ID;
     WK_DEVICE = NEW.DEVICE_ID;
     WK_DATE = NEW.TRN_DATE;
     WK_RECORD = NEW.RECORD_ID;
     IF (NEW.TRN_CODE = 'Q') THEN
     BEGIN
        WK_COMPANY = NEW.OBJECT;
        IF (WK_COMPANY IS NULL) THEN
        BEGIN
           WK_COMPANY = '';
        END
        /* get qty to allocate */
        WK_PICK_QTY = 0;
        IF (NEW.QTY = 0) THEN
        BEGIN
           SELECT PICK_ALLOCATE_QTY
               FROM CONTROL
               INTO :WK_PICK_QTY;
        END
        ELSE
        BEGIN
           WK_PICK_QTY = NEW.QTY;
        END
        /* transfer transfer request to device */
        WK_LINE_CNT = 0;
        WHILE (WK_LINE_CNT < WK_PICK_QTY)
        DO
        BEGIN
           WK_LINE_CNT = WK_LINE_CNT + 1;
           IF (WK_COMPANY = '') THEN
           BEGIN
              SELECT FIRST 1 P1.PROD_ID
              FROM TRANSFER_REQUEST P1
              WHERE  P1.TRN_STATUS IN ('OP')
              ORDER BY P1.TRN_PRIORITY
              INTO :WK_PROD; 
           END
           ELSE
           BEGIN
              SELECT FIRST 1 P1.PROD_ID
              FROM TRANSFER_REQUEST P1
              JOIN PROD_PROFILE P2 ON P2.PROD_ID = P1.PROD_ID
              WHERE  P1.TRN_STATUS IN ('OP')
              AND P2.COMPANY_ID = :WK_COMPANY
              ORDER BY P1.TRN_PRIORITY
              INTO :WK_PROD; 
           END
           IF (WK_PROD IS NULL) THEN
           BEGIN
              WK_PROD = '';
              WK_LINE_CNT = WK_PICK_QTY;
           END
           ELSE
           BEGIN
              UPDATE TRANSFER_REQUEST 
                 SET DEVICE_ID = :WK_DEVICE,
                 TRN_STATUS = 'AL'
                 WHERE PROD_ID =  :WK_PROD
                 AND TRN_STATUS IN ('OP');
           END
        END /* while */
        EXECUTE PROCEDURE UPDATE_TRAN (WK_RECORD, 'T','Processed successfully');
     END
     /*
   EXECUTE PROCEDURE TRAN_ARCHIVE;
   */
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_TRRT FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 131 
AS
/* Transfer of allocated replenish to another handheld */
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_DEVICE CHAR(2);
DECLARE VARIABLE WK_DEVICE_FROM CHAR(2);
DECLARE VARIABLE WK_DEVICE_TO VARCHAR(10);
DECLARE VARIABLE WK_USER VARCHAR(10);
DECLARE VARIABLE WK_RECORD INTEGER;
DECLARE VARIABLE WK_DATE TIMESTAMP;
DECLARE VARIABLE WK_PROD VARCHAR(30);
DECLARE VARIABLE WK_MYREF VARCHAR(40);
DECLARE VARIABLE WK_HAS_SSN INTEGER;
DECLARE VARIABLE WK_WH_FROM CHAR(2);
DECLARE VARIABLE WK_WH_TO CHAR(2);
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'TRRT') THEN
  BEGIN
     WK_DEVICE_FROM = NEW.WH_ID;
     WK_USER = NEW.PERSON_ID;
     WK_DEVICE = NEW.DEVICE_ID;
     WK_DATE = NEW.TRN_DATE;
     WK_RECORD = NEW.RECORD_ID;
     BEGIN
        WK_DEVICE_TO = NEW.SUB_LOCN_ID;
        SELECT WH_ID 
        FROM LOCATION
        WHERE LOCN_ID = :WK_DEVICE_FROM
        INTO :WK_WH_FROM;
        IF (NEW.TRN_CODE = ' ' OR NEW.TRN_CODE = 'K') THEN
        BEGIN
           /* transfer all picks from one device to another */
           IF (LEN(NEW.SUB_LOCN_ID) = 2) THEN
           BEGIN
              SELECT WH_ID 
              FROM LOCATION
              WHERE LOCN_ID = :WK_DEVICE_TO
              INTO :WK_WH_TO;
              UPDATE TRANSFER_REQUEST
                 SET DEVICE_ID = :WK_DEVICE_TO
                 WHERE DEVICE_ID = :WK_DEVICE_FROM;
              UPDATE ISSN SET WH_ID = :WK_WH_TO,
                 LOCN_ID = :WK_DEVICE_TO
                 WHERE WH_ID = :WK_WH_FROM
                 AND LOCN_ID = :WK_DEVICE_FROM;
              EXECUTE PROCEDURE UPDATE_TRAN (WK_RECORD, 'T','Processed successfully');
           END
        END
        ELSE
        IF (NEW.TRN_CODE = 'P') THEN
        BEGIN
           /* transfer next product from one device to another */
           WK_PROD = NEW.OBJECT;
           WK_HAS_SSN = 0;

           IF (WK_DEVICE_TO = 'NULL') THEN
           BEGIN
              SELECT FIRST 1 1 FROM ISSN
                 WHERE WH_ID = :WK_WH_FROM
                 AND LOCN_ID = :WK_DEVICE_FROM
                 INTO :WK_HAS_SSN;
              IF (WK_HAS_SSN IS NULL) THEN
              BEGIN
                 WK_HAS_SSN = 0;
              END
              IF (WK_HAS_SSN = 0) THEN
              BEGIN
                 UPDATE TRANSFER_REQUEST
                    SET DEVICE_ID = NULL,
                    TRN_STATUS = 'OP',
                    TRN_PRIORITY = TRN_PRIORITY + NEW.QTY
                    WHERE PROD_ID = :WK_PROD
                    AND DEVICE_ID = :WK_DEVICE_FROM;
                 EXECUTE PROCEDURE UPDATE_TRAN (WK_RECORD, 'T','Processed successfully');
              END
              ELSE
              BEGIN
                 EXECUTE PROCEDURE UPDATE_TRAN (WK_RECORD, 'F','Cannot Transfer has Unfinished SSNs');
              END
           END
           ELSE
           BEGIN
              SELECT WH_ID 
              FROM LOCATION
              WHERE LOCN_ID = :WK_DEVICE_TO
              INTO :WK_WH_TO;
              UPDATE TRANSFER_REQUEST
                 SET DEVICE_ID = :WK_DEVICE_TO,
                 TRN_PRIORITY = TRN_PRIORITY + NEW.QTY
                 WHERE PROD_ID = :WK_PROD
                 AND DEVICE_ID = :WK_DEVICE_FROM;
              UPDATE ISSN SET WH_ID = :WK_WH_TO,
                 LOCN_ID = :WK_DEVICE_TO
                 WHERE WH_ID = :WK_WH_FROM
                 AND LOCN_ID = :WK_DEVICE_FROM;
           END
           EXECUTE PROCEDURE UPDATE_TRAN (WK_RECORD, 'T','Processed successfully');
        END
     END
     /*
   EXECUTE PROCEDURE TRAN_ARCHIVE;
   */
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_PRCW FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 132 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_RECORD INTEGER;
DECLARE VARIABLE WK_PROD VARCHAR(30);
DECLARE VARIABLE WK_PRINTER CHAR(2);
DECLARE VARIABLE WK_DIRECTORY VARCHAR(75);
DECLARE VARIABLE WK_FILENAME VARCHAR(255);
DECLARE VARIABLE WK_LABEL_LINE VARCHAR(250);
DECLARE VARIABLE WK_RESULT INTEGER;
BEGIN

 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'PRCW') THEN
  BEGIN
     WK_RECORD = NEW.RECORD_ID;
     WK_PROD = NEW.OBJECT;
     WK_PRINTER = NEW.WH_ID;
     /* need the directory for this label set */
     SELECT WORKING_DIRECTORY FROM SYS_EQUIP 
       WHERE DEVICE_ID = :WK_PRINTER
       INTO :WK_DIRECTORY;
   /* append the file name to the directory*/
     WK_FILENAME = WK_DIRECTORY || 'PRODUCTWT.txt';
     WK_LABEL_LINE = WK_PROD ;
     WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE);
     IF (WK_RESULT <> 0) THEN
     BEGIN
        WK_FILENAME = WK_DIRECTORY || 'PRODUCTWT.2xt';
        WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE);
     END
     IF (WK_RESULT <> 0) THEN
     BEGIN
        WK_FILENAME = WK_DIRECTORY || 'PRODUCTWT.3xt';
        WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE);
     END
     IF (WK_RESULT <> 0) THEN
     BEGIN
        WK_FILENAME = WK_DIRECTORY || 'PRODUCTWT.4xt';
        WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE);
     END
     IF (WK_RESULT <> 0) THEN
     BEGIN
        WK_FILENAME = WK_DIRECTORY || 'PRODUCTWT.5xt';
        WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE);
     END
     IF (WK_RESULT <> 0) THEN
     BEGIN
        WK_FILENAME = WK_DIRECTORY || 'PRODUCTWT.6xt';
        WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE);
     END
     IF (WK_RESULT <> 0) THEN
     BEGIN
        WK_FILENAME = WK_DIRECTORY || 'PRODUCTWT.7xt';
        WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE);
     END
     IF (WK_RESULT <> 0) THEN
     BEGIN
        WK_FILENAME = WK_DIRECTORY || 'PRODUCTWT.8xt';
        WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE);
     END
     IF (WK_RESULT <> 0) THEN
     BEGIN
        WK_FILENAME = WK_DIRECTORY || 'PRODUCTWT.9xt';
        WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE);
     END
     IF (WK_RESULT <> 0) THEN
     BEGIN
        WK_FILENAME = WK_DIRECTORY || 'PRODUCTWT.0xt';
        WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE);
     END
     EXECUTE PROCEDURE UPDATE_TRAN (:WK_RECORD, 'T','Processed successfully');
     /* EXECUTE PROCEDURE TRAN_ARCHIVE; */
  END /* PRCW */
 END /* AUTORUN */
END ^

CREATE TRIGGER RUN_TRANSACTION_DSRA FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 133 
AS
/* Consume queue in pick_queue table */
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_DEVICE CHAR(2);
DECLARE VARIABLE WK_USER VARCHAR(10);
DECLARE VARIABLE WK_RECORD INTEGER;
DECLARE VARIABLE WK_DATE TIMESTAMP;
DECLARE VARIABLE WK_FIRST_DATE TIMESTAMP;
DECLARE VARIABLE WK_ORDER VARCHAR(30);
DECLARE VARIABLE WK_FIRST_ORDER VARCHAR(30);
DECLARE VARIABLE WK_ERROR VARCHAR(70);
DECLARE VARIABLE WK_ZONE CHAR(2);
DECLARE VARIABLE WK_CON_DEVICE CHAR(2);
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'DSRA') THEN
  BEGIN
     WK_USER = NEW.PERSON_ID;
     WK_DEVICE = NEW.DEVICE_ID;
     WK_DATE = NEW.TRN_DATE;
     WK_RECORD = NEW.RECORD_ID;
     IF (NEW.TRN_CODE = 'O') THEN
     BEGIN
        /* consume it */
        WK_ORDER = NEW.OBJECT;
        IF (WK_ORDER IS NULL) THEN
        BEGIN
           WK_ORDER = '';
        END

        /* get my zone - for conveyor device */
        WK_ZONE = '';
        SELECT OPERATING_ZONE
        FROM SYS_EQUIP 
        WHERE DEVICE_ID = :WK_DEVICE
        INTO :WK_ZONE;
        IF (WK_ZONE IS NULL) THEN
        BEGIN
           WK_ZONE = '';
        END
        /* get device - for conveyor  */
        WK_CON_DEVICE = '';
        SELECT FIRST 1 DEVICE_ID
        FROM SYS_EQUIP 
        WHERE DEVICE_TYPE = 'HH'
        AND   OPERATING_ZONE = :WK_ZONE
        INTO :WK_CON_DEVICE;
        IF (WK_CON_DEVICE IS NULL) THEN
        BEGIN
           WK_CON_DEVICE = '';
        END
          
        /* 
           must check that its the top order
           for the specific device queue 
        */
        WK_FIRST_ORDER = '';
        SELECT FIRST 1 
           PICK_ORDER
        FROM PICK_QUEUE
        WHERE PICK_QUEUE_STATUS = 'LB'
        AND   DEVICE_ID = :WK_CON_DEVICE
        INTO :WK_FIRST_ORDER;
        IF (WK_FIRST_ORDER IS NULL) THEN
        BEGIN
           WK_FIRST_ORDER = '';
        END
        IF (WK_FIRST_ORDER = WK_ORDER) THEN
        BEGIN
           UPDATE PICK_QUEUE 
              SET PICK_QUEUE_STATUS = 'SN',
                  SEEN_DATE = :WK_DATE,
                  USER_ID = :WK_USER
           WHERE PICK_ORDER = :WK_ORDER
           AND PICK_QUEUE_STATUS = 'LB';
           EXECUTE PROCEDURE UPDATE_TRAN (WK_RECORD, 'T','Processed successfully');
        END
        ELSE
        BEGIN
           WK_ERROR = 'Expected Order ' || WK_FIRST_ORDER;
           EXECUTE PROCEDURE UPDATE_TRAN (WK_RECORD, 'F',WK_ERROR );
        END
     END
     ELSE
     BEGIN
        IF (NEW.TRN_CODE = 'X') THEN
        BEGIN
           /* cancel  all or 1 in queue it */
           WK_ORDER = NEW.OBJECT;
           IF (WK_ORDER IS NULL) THEN
           BEGIN
              WK_ORDER = '';
           END
           IF (WK_ORDER = '') THEN
           BEGIN
              /* get my zone - for conveyor device */
              WK_ZONE = '';
              SELECT OPERATING_ZONE
              FROM SYS_EQUIP 
              WHERE DEVICE_ID = :WK_DEVICE
              INTO :WK_ZONE;
              IF (WK_ZONE IS NULL) THEN
              BEGIN
                 WK_ZONE = '';
              END
              /* get device - for conveyor  */
              WK_CON_DEVICE = '';
              SELECT FIRST 1 DEVICE_ID
              FROM SYS_EQUIP 
              WHERE DEVICE_TYPE = 'HH'
              AND   OPERATING_ZONE = :WK_ZONE
              INTO :WK_CON_DEVICE;
              IF (WK_CON_DEVICE IS NULL) THEN
              BEGIN
                 WK_CON_DEVICE = '';
              END
          
              /* check that there are any to do */
              WK_FIRST_DATE = 'NOW';
              SELECT FIRST 1 
                 CREATE_DATE
              FROM PICK_QUEUE
              WHERE PICK_QUEUE_STATUS = 'LB'
              AND   DEVICE_ID = :WK_CON_DEVICE
              INTO :WK_FIRST_DATE;
              IF (WK_FIRST_DATE IS NULL) THEN
              BEGIN
                 WK_ERROR = 'There are NO Labels to Cancel in your Device ' || WK_CON_DEVICE;
                 EXECUTE PROCEDURE UPDATE_TRAN (WK_RECORD, 'F',WK_ERROR );
              END
              ELSE
              BEGIN
                 UPDATE PICK_QUEUE 
                    SET PICK_QUEUE_STATUS = 'CN',
                        SEEN_DATE = :WK_DATE,
                        USER_ID = :WK_USER
                 WHERE PICK_QUEUE_STATUS = 'LB'
                 AND   DEVICE_ID = :WK_CON_DEVICE;
                 EXECUTE PROCEDURE UPDATE_TRAN (WK_RECORD, 'T','Processed successfully');
              END
           END
           ELSE
           BEGIN
              UPDATE PICK_QUEUE 
                 SET PICK_QUEUE_STATUS = 'CN',
                     SEEN_DATE = :WK_DATE,
                     USER_ID = :WK_USER
              WHERE PICK_ORDER = :WK_ORDER
              AND   PICK_QUEUE_STATUS = 'LB';
              EXECUTE PROCEDURE UPDATE_TRAN (WK_RECORD, 'T','Processed successfully');
           END
        END
     END
     /*
   EXECUTE PROCEDURE TRAN_ARCHIVE;
   */
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_PKWT FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 134 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_DEVICE CHAR(2);
DECLARE VARIABLE WK_CLASS CHAR(1);
DECLARE VARIABLE WK_USER VARCHAR(10);
DECLARE VARIABLE WK_RECORD INTEGER;
DECLARE VARIABLE WK_QTY INTEGER;
DECLARE VARIABLE WK_DATE TIMESTAMP;
DECLARE VARIABLE WK_REF VARCHAR(40);
DECLARE VARIABLE WK_PRINTER VARCHAR(40);
DECLARE VARIABLE WK_OBJECT VARCHAR(30);
DECLARE VARIABLE WK_DIRECTORY VARCHAR(80);
DECLARE VARIABLE WK_FILENAME VARCHAR(80);
DECLARE VARIABLE WK_FILENAME_OUT VARCHAR(80);
DECLARE VARIABLE WK_LABEL_LINE VARCHAR(875);
DECLARE VARIABLE WK_RESULT INTEGER;
DECLARE VARIABLE WK_WH_ID CHAR(2);
DECLARE VARIABLE WK_LOCN_ID VARCHAR(10);
DECLARE VARIABLE WK_SUB_LOCN VARCHAR(10);
DECLARE VARIABLE WK_FILE_TYPE_U INTEGER;
DECLARE VARIABLE WK_FILE_TYPE_V INTEGER;
DECLARE VARIABLE WK_EXPORT_CATEGORY CHAR(1);
DECLARE VARIABLE WK_DUMMY_CATEGORY CHAR(1);
/*
DECLARE VARIABLE WK_BUFFER VARCHAR(600);
*/

BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'PKWT') THEN
  BEGIN
     /* WK_DEVICE = NEW.WH_ID; */
     WK_DEVICE = NEW.DEVICE_ID;
     WK_USER = NEW.PERSON_ID;
     WK_DATE = NEW.TRN_DATE;
     WK_OBJECT = ALLTRIM(NEW.OBJECT);
     WK_PRINTER = NEW.WH_ID;
     WK_RECORD = NEW.RECORD_ID;

     WK_DIRECTORY = '';
     WK_FILE_TYPE_U = 0;
     WK_FILE_TYPE_V = 0;

     IF (STRLEN(WK_PRINTER) > 2) THEN
     BEGIN
        WK_PRINTER = UPPER(SUBSTR(WK_PRINTER,2,3));
     END
     ELSE
     BEGIN
        WK_PRINTER = UPPER(WK_PRINTER);
     END
     IF (STRLEN(WK_PRINTER) < 2) THEN
     BEGIN
        WK_PRINTER = 'P' || WK_PRINTER;
     END
     /* need the directory for this label set */
     SELECT WORKING_DIRECTORY FROM SYS_EQUIP 
         WHERE DEVICE_ID = :WK_PRINTER
         INTO :WK_DIRECTORY;
     /* print labels */
     /* WK_FILENAME = WK_DIRECTORY || 'ProdWeight.txt'; */
     WK_FILENAME = WK_DIRECTORY || 'ProdWeight.vxt';
     WK_FILENAME = WK_DIRECTORY || 'ProdWeight.txt';
     BEGIN
        WK_LABEL_LINE = '"' || WK_OBJECT || '","' ||
             SUBSTR(WK_PRINTER,2,2) || '"' ||
             CHR(13) || CHR(10);
     END

     WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE);
     IF (WK_RESULT = 0) THEN
     BEGIN
        WK_FILE_TYPE_U = 1;
     END
     IF (WK_RESULT <> 0) THEN
     BEGIN
        /* WK_FILENAME = WK_DIRECTORY || 'ProdWeight.vxt'; */
        WK_FILENAME = WK_DIRECTORY || 'ProdWeight.txt';
        WK_FILENAME = WK_DIRECTORY || 'ProdWeight2.txt';
        /* WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE); */ 
        WK_RESULT = FILE_WRITE(WK_FILENAME, WK_LABEL_LINE);
        WK_FILE_TYPE_V = 1;
     END
     IF (WK_RESULT <> 0) THEN
     BEGIN
        WK_FILENAME = WK_DIRECTORY || 'ProdWeight3.txt';
        /* WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE); */ 
        WK_RESULT = FILE_WRITE(WK_FILENAME, WK_LABEL_LINE);
        WK_FILE_TYPE_V = 2;
     END
     IF (WK_RESULT <> 0) THEN
     BEGIN
        WK_FILENAME = WK_DIRECTORY || 'ProdWeight4.txt';
        /* WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE); */ 
        WK_RESULT = FILE_WRITE(WK_FILENAME, WK_LABEL_LINE);
        WK_FILE_TYPE_V = 3;
     END
     IF (WK_RESULT <> 0) THEN
     BEGIN
        WK_FILENAME = WK_DIRECTORY || 'ProdWeight5.txt';
        /* WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE); */ 
        WK_RESULT = FILE_WRITE(WK_FILENAME, WK_LABEL_LINE);
        WK_FILE_TYPE_V = 4;
     END
     IF (WK_RESULT <> 0) THEN
     BEGIN
        WK_FILENAME = WK_DIRECTORY || 'ProdWeight6.txt';
        /* WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE); */ 
        WK_RESULT = FILE_WRITE(WK_FILENAME, WK_LABEL_LINE);
        WK_FILE_TYPE_V = 5;
     END
     IF (WK_RESULT <> 0) THEN
     BEGIN
        WK_FILENAME = WK_DIRECTORY || 'ProdWeight7.txt';
        /* WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE); */ 
        WK_RESULT = FILE_WRITE(WK_FILENAME, WK_LABEL_LINE);
        WK_FILE_TYPE_V = 6;
     END
     IF (WK_RESULT <> 0) THEN
     BEGIN
        WK_FILENAME = WK_DIRECTORY || 'ProdWeight8.txt';
        /* WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE); */ 
        WK_RESULT = FILE_WRITE(WK_FILENAME, WK_LABEL_LINE);
        WK_FILE_TYPE_V = 7;
     END
     IF (WK_RESULT <> 0) THEN
     BEGIN
        WK_FILENAME = WK_DIRECTORY || 'ProdWeight9.txt';
        /* WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE); */ 
        WK_RESULT = FILE_WRITE(WK_FILENAME, WK_LABEL_LINE);
        WK_FILE_TYPE_V = 8;
     END
     IF (WK_RESULT <> 0) THEN
     BEGIN
        WK_FILENAME = WK_DIRECTORY || 'ProdWeightA.txt';
        /* WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_LABEL_LINE); */ 
        WK_RESULT = FILE_WRITE(WK_FILENAME, WK_LABEL_LINE);
        WK_FILE_TYPE_V = 9;
     END
     /*
     IF (WK_FILE_TYPE_V = 0) THEN
     BEGIN
        -* WK_FILENAME = WK_DIRECTORY || 'ProdWeight.vxt'; *-
        WK_FILENAME = WK_DIRECTORY || 'ProdWeight.vxt';
        -* WK_FILENAME_OUT = WK_DIRECTORY || 'ProdWeight.txt'; *-
        WK_FILENAME_OUT = WK_DIRECTORY || 'ProdWeight.txt';
        WK_RESULT = FILE_RENAME(WK_FILENAME, WK_FILENAME_OUT);
     END
     */
   EXECUTE PROCEDURE UPDATE_TRAN (WK_RECORD, 'T','Processed successfully');
   /* EXECUTE PROCEDURE TRAN_ARCHIVE; */
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_DSSS FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 135 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_DEVICE CHAR(2);
DECLARE VARIABLE WK_USER VARCHAR(10);
DECLARE VARIABLE WK_RECORD INTEGER;
DECLARE VARIABLE WK_LABEL_NO VARCHAR(10);
DECLARE VARIABLE WK_WH_ID CHAR(2);
DECLARE VARIABLE WK_LOCN_ID VARCHAR(10);
DECLARE VARIABLE WK_OBJECT VARCHAR(30);
DECLARE VARIABLE WK_REF VARCHAR(40);
DECLARE VARIABLE WK_REASON VARCHAR(40);
DECLARE VARIABLE WK_QTY INTEGER;
DECLARE VARIABLE WK_PID_FOUND INTEGER;
DECLARE VARIABLE WK_PID_QTY INTEGER;
DECLARE VARIABLE WK_PI_STATUS CHAR(2);
DECLARE VARIABLE WK_DETAIL_ID INTEGER;
DECLARE VARIABLE WK_DATE TIMESTAMP;
DECLARE VARIABLE WK_PI_PICKED_QTY INTEGER;
DECLARE VARIABLE WK_PI_ORDER_QTY INTEGER;
DECLARE VARIABLE WK_PI_ORDER VARCHAR(15);
DECLARE VARIABLE WK_IS_QTY INTEGER;
DECLARE VARIABLE iSSN_LENGTH INTEGER;
DECLARE VARIABLE iSSN_ID INTEGER;
DECLARE VARIABLE I_SSN_ID VARCHAR(20);
DECLARE VARIABLE I_LEN_SSN_ID INTEGER;
DECLARE VARIABLE LEN_SSN_ID INTEGER;
DECLARE VARIABLE WK_OLD_SSN_ID VARCHAR(30);
DECLARE VARIABLE P_SSN_ID INTEGER;
DECLARE VARIABLE WK_PID_SSN VARCHAR(20);
DECLARE VARIABLE WK_DEVICE_WH CHAR(2);
DECLARE VARIABLE WK_PI_PICKED_QTY_NULL INTEGER;
DECLARE VARIABLE WK_TRN_TYPE VARCHAR(4);
DECLARE VARIABLE WK_TRN_CODE CHAR(1);
DECLARE VARIABLE WK_AUDIT_DESC VARCHAR(40);

DECLARE VARIABLE WK_PI_SSN VARCHAR(20);
DECLARE VARIABLE WK_PI_WH CHAR(2);
DECLARE VARIABLE WK_QTY_REMAINING INTEGER;
DECLARE VARIABLE WK_PI_LINE_QTY_REMAINING INTEGER;
DECLARE VARIABLE WK_QTY_TO_USE INTEGER;
DECLARE VARIABLE WK_ALLOWED_STATUS VARCHAR(40);
DECLARE VARIABLE WK_IS_SSN VARCHAR(20);
DECLARE VARIABLE WK_IS_QTY_REMAINING INTEGER;
DECLARE VARIABLE WK_USED_SSN VARCHAR(20);
DECLARE VARIABLE WK_IS_USED_QTY INTEGER;
DECLARE VARIABLE WK_LOG VARCHAR(255);
DECLARE VARIABLE WK_DO_UASL CHAR(1);
DECLARE VARIABLE WK_CURRENT_WH_ID CHAR(2);
DECLARE VARIABLE WK_CURRENT_LOCN_ID VARCHAR(10);
DECLARE VARIABLE WK_IS_TAKEN CHAR(1);
DECLARE VARIABLE WK_GENERATE_SSN_METHOD VARCHAR(25);
DECLARE VARIABLE WK_PALLET_NO VARCHAR(3);
DECLARE VARIABLE WK_PALLET_NO_INT INTEGER;
DECLARE VARIABLE WK_SSN_PREFIX VARCHAR(30);
DECLARE VARIABLE WK_ORIGINAL_SSN VARCHAR(20);
DECLARE VARIABLE WK_LAST_SSN VARCHAR(20);
DECLARE VARIABLE WK_LAST2_SSN VARCHAR(20);
DECLARE VARIABLE GRN VARCHAR(10);
DECLARE VARIABLE WK_FILENAME VARCHAR(255);
DECLARE VARIABLE WK_RESULT INTEGER;
DECLARE VARIABLE WK_RESPONSE_FINAL VARCHAR(70);
DECLARE VARIABLE WK_OWNER VARCHAR(20);
DECLARE VARIABLE WK_OWNER_GRN VARCHAR(10);
DECLARE VARIABLE WK_OWNER_PFX CHAR(2);
DECLARE VARIABLE P_LAST_LINE_NO VARCHAR(10);
DECLARE VARIABLE WK_GRN_TYPE CHAR(2);
DECLARE VARIABLE WK_LOADNO VARCHAR(10);
DECLARE VARIABLE WK_GRN_LOT VARCHAR(30);
DECLARE VARIABLE WK_LAST_LOT_PALLET_NO INTEGER;
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'DSSS') THEN
  BEGIN
     WK_DEVICE = NEW.DEVICE_ID;
     WK_PI_STATUS = NEW.SUB_LOCN_ID;
     WK_WH_ID = NEW.WH_ID;
     WK_LOCN_ID = NEW.LOCN_ID;
     WK_USER = NEW.PERSON_ID;
     WK_OBJECT = NEW.OBJECT;
     WK_REF = ALLTRIM(NEW.REFERENCE);
     EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_REF, 1  RETURNING_VALUES :WK_PI_ORDER; 
     EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_REF, 2  RETURNING_VALUES :WK_REASON; 
     WK_QTY = NEW.QTY;
     WK_DATE = NEW.TRN_DATE;
     WK_RECORD = NEW.RECORD_ID;
     WK_TRN_CODE = NEW.TRN_CODE;
     WK_TRN_TYPE = NEW.TRN_TYPE;

     WK_AUDIT_DESC = 'Split to Device ' || :WK_DEVICE ;
           /*  SPlit it */
           /* calculate the next ssn id */
           SELECT GENERATE_SSN_METHOD FROM CONTROL INTO :WK_GENERATE_SSN_METHOD;

           /* IF ((WK_GENERATE_SSN_METHOD IS NULL) OR (WK_GENERATE_SSN_METHOD <> '|GRN=4|LINE=2|SUFFIX=2,3|')) THEN */
           IF ((WK_GENERATE_SSN_METHOD IS NULL) OR ((WK_GENERATE_SSN_METHOD <> '|GRN=4|LINE=2|SUFFIX=2,3|') AND 
               (WK_GENERATE_SSN_METHOD <> 'CMP=2|GRN=6|LINE=2|SFX=2' ))) THEN
           BEGIN
              /* Get length for Barcode */   
              EXECUTE PROCEDURE GET_BARCODE_LENGTH RETURNING_VALUES iSSN_LENGTH;
              iSSN_ID = GEN_ID(ISSN_SSN_ID, 1);
              P_SSN_ID = iSSN_ID - 1;
              LEN_SSN_ID = STRLEN(P_SSN_ID);
              I_SSN_ID = '';
              I_LEN_SSN_ID = STRLEN(P_SSN_ID);
              
              /* Padding leading with 0 */
              WHILE (I_LEN_SSN_ID < :iSSN_LENGTH) DO
              BEGIN
                 I_SSN_ID = I_SSN_ID || '0';
                 I_LEN_SSN_ID = I_LEN_SSN_ID + 1;
              END
              I_SSN_ID = I_SSN_ID || P_SSN_ID;
           END
      WK_FILENAME = '/tmp/pkol.log';
           IF (WK_GENERATE_SSN_METHOD = '|GRN=4|LINE=2|SUFFIX=2,3|' ) THEN
           BEGIN
      /* WK_RESULT = FILE_WRITELN(WK_FILENAME, 'pkol start - grn style ssn id'); */
              /* the prefix (length 6 is the current issn ssn_id) */
              WK_SSN_PREFIX = SUBSTR(WK_OBJECT,1,6);
      /* WK_RESULT = FILE_WRITELN(WK_FILENAME, 'prefix ' || wk_ssn_prefix); */
              /* want the max pallet no for that prefix */  
              /* SELECT GRN FROM SSN WHERE SSN_ID = :WK_ORIGINAL_SSN INTO :GRN; */
              GRN = SUBSTR(WK_OBJECT,1,4);
      /* WK_RESULT = FILE_WRITELN(WK_FILENAME, 'grn ' || grn); */
              /*
              SELECT MAX(SSN_ID) FROM ISSN WHERE SSN_ID STARTING :WK_SSN_PREFIX AND (WH_ID < 'X ' OR WH_ID > 'X~') INTO :WK_LAST_SSN;
              WK_LAST2_SSN = '';
              -* if the pallet no roled over 99 then the length as gone to 9 *-
              EXECUTE PROCEDURE GET_BARCODE_LENGTH RETURNING_VALUES iSSN_LENGTH;
              SELECT MAX(SSN_ID) FROM ISSN WHERE SSN_ID STARTING :WK_SSN_PREFIX AND LEN(SSN_ID) > :iSSN_LENGTH AND (WH_ID < 'X ' OR WH_ID > 'X~') INTO :WK_LAST2_SSN;
              IF (WK_LAST2_SSN IS NULL) THEN
              BEGIN
                 WK_PALLET_NO = SUBSTR(WK_LAST_SSN,iSSN_LENGTH - 1,iSSN_LENGTH);
              END
              ELSE
              BEGIN
                 WK_PALLET_NO = SUBSTR(WK_LAST2_SSN,iSSN_LENGTH - 1,iSSN_LENGTH + 1);
              END
              */
              SELECT LAST_PALLET_NO FROM GRN WHERE GRN = :GRN INTO :WK_PALLET_NO_INT;
      /* WK_RESULT = FILE_WRITELN(WK_FILENAME, 'have pallet ' ); */
              IF (WK_PALLET_NO_INT IS NULL) THEN
              BEGIN
                 WK_PALLET_NO_INT = 0;
              END
                
      /* WK_RESULT = FILE_WRITELN(WK_FILENAME, 'pallet 2 ' ); */
              /* WK_PALLET_NO = WK_PALLET_NO + 1; */
              WK_PALLET_NO_INT = WK_PALLET_NO_INT + 1;
      /* WK_RESULT = FILE_WRITELN(WK_FILENAME, 'pallet 3 ' ); */
              UPDATE GRN SET LAST_PALLET_NO = :WK_PALLET_NO_INT WHERE GRN = :GRN;
      /* WK_RESULT = FILE_WRITELN(WK_FILENAME, 'update grn' ); */
              WK_PALLET_NO = WK_PALLET_NO_INT;
      /* WK_RESULT = FILE_WRITELN(WK_FILENAME, ' pallet no is ' || WK_PALLET_NO ); */
              IF (WK_PALLET_NO < 10) THEN
              BEGIN
                 WK_PALLET_NO = LPAD(WK_PALLET_NO,'0',2);
              END
      /* WK_RESULT = FILE_WRITELN(WK_FILENAME, 'after lpad' ); */
              I_SSN_ID = WK_SSN_PREFIX || WK_PALLET_NO;
      /* WK_RESULT = FILE_WRITELN(WK_FILENAME, 'set issn ' || :I_SSN_ID ); */
           END /* if ssn method is |GRN=4|LINE=2|SUFFIX=2,3| */

           IF (WK_GENERATE_SSN_METHOD = 'CMP=2|GRN=6|LINE=2|SFX=2' ) THEN
           BEGIN
              GRN = '';
              WK_ORIGINAL_SSN = '';
              /* the prefix (length 6 is the current issn ssn_id) */
              WK_SSN_PREFIX = SUBSTR(WK_OBJECT,1,6);
      /* WK_RESULT = FILE_WRITELN(WK_FILENAME, 'prefix ' || wk_ssn_prefix); */
              /* want the max pallet no for that prefix */  
              SELECT ORIGINAL_SSN FROM ISSN WHERE SSN_ID = :WK_OBJECT INTO :WK_ORIGINAL_SSN; 
              SELECT GRN FROM SSN WHERE SSN_ID = :WK_ORIGINAL_SSN INTO :GRN; 
              /* GRN = SUBSTR(WK_OBJECT,1,4); */
              WK_GRN_TYPE = '';
              WK_LOADNO = '';
              WK_GRN_LOT = '';
              SELECT GRN_TYPE, ORDER_NO , LAST_LOT_NO
              FROM GRN 
              WHERE GRN = :GRN
              INTO :WK_GRN_TYPE, :WK_LOADNO, :WK_GRN_LOT;
              IF (WK_GRN_LOT IS NULL) THEN
              BEGIN
                 WK_GRN_LOT = '';
              END
              SELECT LAST_PALLET_NO FROM GRN WHERE GRN = :GRN INTO :WK_PALLET_NO_INT;
              IF (WK_PALLET_NO_INT IS NULL) THEN
              BEGIN
                 WK_PALLET_NO_INT = 0;
              END
              IF (STRLEN(WK_GRN_LOT) > 0) THEN
              BEGIN
                 WK_LAST_LOT_PALLET_NO = 0;
                 /* SELECT MAX(LAST_PALLET_NO) FROM GRN WHERE LAST_LOT_NO = :WK_GRN_LOT INTO :WK_LAST_LOT_PALLET_NO; */
                 SELECT MAX(LAST_PALLET_NO) FROM GRN WHERE LAST_LOT_NO STARTING SUBSTR(:WK_GRN_LOT,1,8) INTO :WK_LAST_LOT_PALLET_NO;
                 IF (WK_LAST_LOT_PALLET_NO IS NULL) THEN
                 BEGIN
                    WK_LAST_LOT_PALLET_NO = WK_PALLET_NO_INT;
                 END
                 IF (WK_LAST_LOT_PALLET_NO > WK_PALLET_NO_INT) THEN
                 BEGIN
                    WK_PALLET_NO_INT = WK_LAST_LOT_PALLET_NO;
                 END
              END
              WK_PALLET_NO_INT = WK_PALLET_NO_INT + 1;
              UPDATE GRN SET LAST_PALLET_NO = :WK_PALLET_NO_INT WHERE GRN = :GRN;
              WK_PALLET_NO = WK_PALLET_NO_INT;
              IF (WK_PALLET_NO < 10) THEN
              BEGIN
                 WK_PALLET_NO = LPAD(WK_PALLET_NO,'0',2);
              END
              WK_OWNER = '';
              WK_OWNER_PFX = '';
              IF ((WK_GRN_TYPE = 'PO') OR
                  (WK_GRN_TYPE = 'RA') OR  
                  (WK_GRN_TYPE = 'TR') OR
                  (WK_GRN_TYPE = 'WO')) THEN
              BEGIN
                 SELECT COMPANY_ID, PO_LEGACY_OWNER_ID 
                 FROM PURCHASE_ORDER 
                 WHERE PURCHASE_ORDER = :WK_LOADNO
                 INTO :WK_OWNER, :WK_OWNER_PFX;
                 IF (WK_OWNER_PFX IS NULL) THEN
                 BEGIN
                    WK_OWNER_PFX = '';
                 END
              END
              IF (WK_OWNER IS NULL OR WK_OWNER = '') THEN
              BEGIN
                 SELECT OWNER_ID 
                 FROM GRN 
                 WHERE GRN = :GRN
                 INTO :WK_OWNER;
              END
              IF (WK_OWNER_PFX = '') THEN
              BEGIN
                 SELECT COMPANY_ID_PREFIX 
                 FROM COMPANY 
                 WHERE COMPANY_ID = :WK_OWNER 
                 INTO :WK_OWNER_PFX;
        
                 IF (WK_OWNER_PFX IS NULL) THEN
                 BEGIN
                    WK_OWNER_PFX = '';
                 END
              END
              LEN_SSN_ID = STRLEN(WK_OWNER_PFX);
              WHILE (LEN_SSN_ID < 2) DO
              BEGIN
                 WK_OWNER_PFX = '0' || WK_OWNER_PFX;
                 LEN_SSN_ID = LEN_SSN_ID + 1;
              END
              LEN_SSN_ID = STRLEN(GRN);
              WK_OWNER_GRN = GRN;
              WHILE (LEN_SSN_ID < 6) DO
              BEGIN
                 WK_OWNER_GRN = '0' || WK_OWNER_GRN;
                 LEN_SSN_ID = LEN_SSN_ID + 1;
              END
              P_LAST_LINE_NO = SUBSTR(WK_OBJECT,STRLEN(WK_OBJECT) - 3,STRLEN(WK_OBJECT) - 2);
            
              IF (STRLEN(WK_GRN_LOT) > 0) THEN
              BEGIN
                 WK_OWNER_PFX = SUBSTR(WK_OBJECT, 1, 2);
                 WK_OWNER_GRN = SUBSTR(WK_OBJECT,3, STRLEN(WK_OBJECT) - 4);
              END
              /* I_SSN_ID = WK_SSN_PREFIX || WK_PALLET_NO; */
              I_SSN_ID = WK_OWNER_PFX || WK_OWNER_GRN || P_LAST_LINE_NO || WK_PALLET_NO;
           END /* if ssn method is 'CMP=2|GRN=6|LINE=2|SFX=2' */
           /* end of get next ssn id */
              
           EXECUTE PROCEDURE PC_TRSS 
           :WK_RECORD ,
           :WK_WH_ID,
           :WK_LOCN_ID,
           :WK_OBJECT,
           'TRSS',
           'A',
           :WK_DATE,
           :I_SSN_ID,
           :WK_QTY,
           :WK_USER,
           :WK_DEVICE;
           WK_OLD_SSN_ID = WK_OBJECT;
           WK_OBJECT = I_SSN_ID;
      /* WK_RESULT = FILE_WRITELN(WK_FILENAME, 'after pc_trss ' || :I_SSN_ID ); */
           /* UPDATE ISSN SET OTHER1 = (SELECT OTHER1 FROM ISSN WHERE SSN_ID=:WK_OLD_SSN_ID), OTHER2 = 'Split ' || :WK_OLD_SSN_ID WHERE SSN_ID = :I_SSN_ID; */
           UPDATE ISSN SET OTHER1 = (SELECT OTHER1 FROM ISSN WHERE SSN_ID=:WK_OLD_SSN_ID), OTHER2 = 'SplIT ' || :WK_OLD_SSN_ID || ' Order ' || :WK_PI_ORDER WHERE SSN_ID = :I_SSN_ID;
      /* WK_RESULT = FILE_WRITELN(WK_FILENAME, 'after set other2 '  ); */
   
        /* use wh_id of device */
        WK_DEVICE_WH = WK_WH_ID;
        SELECT WH_ID FROM LOCATION WHERE LOCN_ID = :WK_DEVICE
        INTO :WK_DEVICE_WH;
   
/*
        UPDATE ISSN SET ISSN_STATUS = :WK_PI_STATUS,
            PREV_PREV_WH_ID = PREV_WH_ID,
            PREV_PREV_LOCN_ID = PREV_LOCN_ID,
            PREV_WH_ID = WH_ID,
            PREV_LOCN_ID = LOCN_ID,
            WH_ID = :WK_DEVICE_WH,
            LOCN_ID = :WK_DEVICE
         WHERE SSN_ID = :WK_OBJECT;
*/
        UPDATE ISSN SET ISSN_STATUS = :WK_PI_STATUS
         WHERE SSN_ID = :WK_OBJECT;

         EXECUTE PROCEDURE ADD_SSN_HIST(:WK_DEVICE_WH, :WK_DEVICE, :WK_OBJECT, 
                 :WK_TRN_TYPE, :WK_TRN_CODE, :WK_DATE,
                 :WK_AUDIT_DESC , :WK_REASON, :WK_QTY, :WK_USER, :WK_DEVICE); 
   
       WK_RESPONSE_FINAL = :WK_OBJECT || '|' || 'Processed successfully';
       EXECUTE PROCEDURE UPDATE_TRAN (:WK_RECORD, 'T', :WK_RESPONSE_FINAL);

   /* EXECUTE PROCEDURE TRAN_ARCHIVE; */
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_DSUQ FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 136 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_DEVICE CHAR(2);
DECLARE VARIABLE WK_USER VARCHAR(10);
DECLARE VARIABLE WK_RECORD INTEGER;
DECLARE VARIABLE WK_WH_ID CHAR(2);
DECLARE VARIABLE WK_LOCN_ID VARCHAR(10);
DECLARE VARIABLE WK_OBJECT VARCHAR(30);
DECLARE VARIABLE WK_REF VARCHAR(40);
DECLARE VARIABLE WK_QTY INTEGER;
DECLARE VARIABLE WK_CONSIGNMENT VARCHAR(30);
DECLARE VARIABLE WK_DATE TIMESTAMP;

DECLARE VARIABLE WK_DESPATCH_ID INTEGER;
DECLARE VARIABLE WK_PACK_ID INTEGER;
DECLARE VARIABLE WK_SSN_ID VARCHAR(20);
DECLARE VARIABLE WK_PACK_QTY INTEGER;

DECLARE VARIABLE WK_FILENAME VARCHAR(255);
DECLARE VARIABLE WK_RESULT INTEGER;
DECLARE VARIABLE WK_RESPONSE_FINAL VARCHAR(70);

BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'DSUQ') THEN
  BEGIN
     WK_DEVICE = NEW.DEVICE_ID;
     WK_OBJECT = NEW.OBJECT;
     WK_CONSIGNMENT = WK_OBJECT;
     WK_WH_ID = NEW.WH_ID;
     WK_LOCN_ID = NEW.LOCN_ID;
     WK_USER = NEW.PERSON_ID;
     WK_REF = ALLTRIM(NEW.REFERENCE);
     WK_QTY = NEW.QTY;
     WK_DATE = NEW.TRN_DATE;
     WK_RECORD = NEW.RECORD_ID;
     WK_FILENAME = '/tmp/dsuq.log';
     /* for consignment no
        get the despatch ids not DX or DI ie DC
        for the pack ids in these despatches
        update the issn current qty to the despatch qty
        any other issn in the pick_item_detail
        for the despatch id are updated to zero qty
     */
     FOR SELECT DESPATCH_ID
         FROM PICK_DESPATCH
         WHERE AWB_CONSIGNMENT_NO = :WK_CONSIGNMENT
         AND DESPATCH_STATUS = 'DC'
         INTO :WK_DESPATCH_ID
     DO
     BEGIN
        FOR SELECT SSN_ID
            FROM PICK_ITEM_DETAIL
            WHERE DESPATCH_ID = :WK_DESPATCH_ID
            AND PICK_DETAIL_STATUS <> 'XX'
            AND PICK_DETAIL_STATUS <> 'xx'
            INTO :WK_SSN_ID 
        DO
        BEGIN
           IF (WK_SSN_ID IS NOT NULL) THEN
           BEGIN
              UPDATE ISSN SET PICKED_QTY = CURRENT_QTY, CURRENT_QTY = 0, ISSN_STATUS = 'DC'
              WHERE SSN_ID = :WK_SSN_ID
              AND ISSN_STATUS = 'DQ';
           END
        END
        FOR SELECT PACK_ID, SSN_ID, QTY
            FROM PACK_ID
            WHERE DESPATCH_ID = :WK_DESPATCH_ID
            INTO :WK_PACK_ID, :WK_SSN_ID, :WK_PACK_QTY
        DO
        BEGIN
           IF (WK_SSN_ID IS NOT NULL) THEN
           BEGIN
              UPDATE ISSN SET PICKED_QTY = CURRENT_QTY, CURRENT_QTY = :WK_PACK_QTY, ISSN_STATUS = 'DQ'
              WHERE SSN_ID = :WK_SSN_ID;
           END
        END
        FOR SELECT SSN_ID
            FROM PICK_ITEM_DETAIL
            WHERE DESPATCH_ID = :WK_DESPATCH_ID
            AND PICK_DETAIL_STATUS <> 'XX'
            AND PICK_DETAIL_STATUS <> 'xx'
            INTO :WK_SSN_ID 
        DO
        BEGIN
           IF (WK_SSN_ID IS NOT NULL) THEN
           BEGIN
              UPDATE ISSN SET PICKED_QTY = CURRENT_QTY, CURRENT_QTY = 0, ISSN_STATUS = 'CN'
              WHERE SSN_ID = :WK_SSN_ID
              AND ISSN_STATUS <> 'DQ';
           END
        END
     END

   
     WK_RESPONSE_FINAL = 'Processed successfully';
     EXECUTE PROCEDURE UPDATE_TRAN (:WK_RECORD, 'T', :WK_RESPONSE_FINAL);

   /* EXECUTE PROCEDURE TRAN_ARCHIVE; */
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_STIS FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 140 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_LOCN_ID VARCHAR(10);
BEGIN
  IF (NEW.TRN_TYPE = 'STIS') THEN
  BEGIN
   WK_LOCN_ID = NEW.LOCN_ID;
   EXECUTE PROCEDURE PC_STIS
    NEW.RECORD_ID ,
    NEW.WH_ID,
    :WK_LOCN_ID,
    NEW.OBJECT,
    NEW.TRN_TYPE,
    NEW.TRN_CODE,
    NEW.TRN_DATE,
    NEW.REFERENCE,
    NEW.QTY;
   /* EXECUTE PROCEDURE TRAN_ARCHIVE; */
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_STUA FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 141 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_LOCN_ID VARCHAR(10);
BEGIN
  IF (NEW.TRN_TYPE = 'STUA') THEN
  BEGIN
   WK_LOCN_ID = NEW.LOCN_ID;
   EXECUTE PROCEDURE PC_STUA
    NEW.RECORD_ID ,
    NEW.WH_ID,
    NEW.LOCN_ID,
    NEW.OBJECT,
    NEW.TRN_TYPE,
    NEW.TRN_CODE,
    NEW.TRN_DATE,
    NEW.REFERENCE,
    NEW.QTY,
    NEW.SUB_LOCN_ID;
   /* EXECUTE PROCEDURE TRAN_ARCHIVE; */
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_STAV FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 143 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_LOCN_ID VARCHAR(10);
BEGIN
  IF (NEW.TRN_TYPE = 'STAV') THEN
  BEGIN
   WK_LOCN_ID = NEW.LOCN_ID;
   EXECUTE PROCEDURE PC_STAV
    NEW.RECORD_ID ,
    NEW.WH_ID,
    NEW.LOCN_ID,
    NEW.OBJECT,
    NEW.TRN_TYPE,
    NEW.TRN_CODE,
    NEW.TRN_DATE,
    NEW.REFERENCE,
    NEW.QTY,
    NEW.SUB_LOCN_ID;
   /* EXECUTE PROCEDURE TRAN_ARCHIVE; */
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_NITS FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 144 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_DEVICE CHAR(2);
DECLARE VARIABLE WK_WH_ID CHAR(2);
DECLARE VARIABLE WK_LOCN_ID VARCHAR(10);
DECLARE VARIABLE WK_USER VARCHAR(10);
DECLARE VARIABLE WK_SSN VARCHAR(30);
DECLARE VARIABLE WK_REFERENCE VARCHAR(40);
DECLARE VARIABLE WK_QTY INTEGER;
DECLARE VARIABLE WK_DATE TIMESTAMP;
DECLARE VARIABLE WK_RECORD INTEGER;
DECLARE VARIABLE WK_TRN_CODE CHAR(1);
DECLARE VARIABLE WK_TRN_TYPE VARCHAR(4);
DECLARE VARIABLE WK_TEST_DATE_X VARCHAR(40);
DECLARE VARIABLE WK_TEST_DATE_FMT VARCHAR(40);
DECLARE VARIABLE WK_TEST_DATE TIMESTAMP;
DECLARE VARIABLE WK_PASSED CHAR(1);
DECLARE VARIABLE WK_STATUS CHAR(2);
DECLARE VARIABLE WK_GLOBAL VARCHAR(40);
DECLARE VARIABLE WK_AUDIT_DESC VARCHAR(40) ;
BEGIN
   WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
   IF (WK_AUTORUN = 1) THEN
   BEGIN
      IF (NEW.TRN_TYPE = 'NITS') THEN
      BEGIN
         WK_DEVICE = NEW.DEVICE_ID;
         WK_WH_ID = NEW.WH_ID;
         WK_LOCN_ID = NEW.LOCN_ID;
         WK_USER = NEW.PERSON_ID;
         WK_SSN = NEW.OBJECT;
         WK_REFERENCE = NEW.REFERENCE;
         WK_QTY = NEW.QTY;
         WK_DATE = NEW.TRN_DATE;
         WK_RECORD = NEW.RECORD_ID;
         WK_TRN_CODE = NEW.TRN_CODE;
         WK_TRN_TYPE = NEW.TRN_TYPE;
         WK_TEST_DATE_X = '';
         WK_TEST_DATE_FMT = '';
	/* object = ssn
	   locn and wh_id for where
	   reference = 'timestamp|' or 
	               '' -> failed test
	               'timestamp|date format|' for different timestamp
	   update ssn's loan_safety_check_date
	                loan_status ='XS' if failed test
	                other2 -> global conditions description for '2'
                                  'P' or 'F' for failed
           what about pick order of type for 'LS'
	*/
         EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_REFERENCE, 1  RETURNING_VALUES :WK_TEST_DATE_X ; 
         EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_REFERENCE, 2  RETURNING_VALUES :WK_TEST_DATE_FMT ; 
         WK_TEST_DATE_X = ALLTRIM(WK_TEST_DATE_X); 
         WK_TEST_DATE_FMT = ALLTRIM(WK_TEST_DATE_FMT); 
         IF (WK_TEST_DATE_FMT = '') THEN
         BEGIN
            WK_TEST_DATE_FMT = 'YYYY/MM/DD HH:MM:SS';
         END
         WK_TEST_DATE  = WK_DATE;
         IF (WK_TEST_DATE_X = '') THEN
         BEGIN
            /* failed test */
            WK_PASSED = 'F';
            WK_STATUS = 'XS';
         END
         ELSE
         BEGIN
            /* passed test */
            WK_PASSED = 'P';
            WK_STATUS = 'PS';
         END
         IF (WK_TEST_DATE_FMT = 'YYYY/MM/DD HH:MM:SS') THEN
         BEGIN
            WK_TEST_DATE = CAST(WK_TEST_DATE_X AS TIMESTAMP);
            WK_PASSED = 'P';
         END
         EXECUTE PROCEDURE GET_GLOBAL_CONDITION 2, :WK_PASSED RETURNING_VALUES :WK_GLOBAL;
         IF (WK_PASSED = 'P') THEN
         BEGIN
            UPDATE SSN
            SET OTHER2 = :WK_GLOBAL,
                LOAN_LAST_SAFETY_CHECK_DATE = :WK_TEST_DATE
            WHERE SSN_ID = :WK_SSN;
         END
         ELSE
         BEGIN
            UPDATE SSN
            SET OTHER2 = :WK_GLOBAL,
                LOAN_STATUS = :WK_STATUS
            WHERE SSN_ID = :WK_SSN;
         END
         WK_AUDIT_DESC = ' Safety Test '  ;
         EXECUTE PROCEDURE ADD_SSN_HIST(:WK_WH_ID, :WK_LOCN_ID, :WK_SSN, 
                       :WK_TRN_TYPE, :WK_TRN_CODE, :WK_DATE,
                       :WK_AUDIT_DESC , :WK_REFERENCE, :WK_QTY, :WK_USER, :WK_DEVICE); 
         EXECUTE PROCEDURE UPDATE_TRAN (WK_RECORD, 'T','Processed successfully');
         /* EXECUTE PROCEDURE TRAN_ARCHIVE; */
      END
   END
END ^

CREATE TRIGGER RUN_TRANSACTION_NITC FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 145 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_DEVICE CHAR(2);
DECLARE VARIABLE WK_WH_ID CHAR(2);
DECLARE VARIABLE WK_LOCN_ID VARCHAR(10);
DECLARE VARIABLE WK_USER VARCHAR(10);
DECLARE VARIABLE WK_SSN VARCHAR(30);
DECLARE VARIABLE WK_REFERENCE VARCHAR(40);
DECLARE VARIABLE WK_QTY INTEGER;
DECLARE VARIABLE WK_DATE TIMESTAMP;
DECLARE VARIABLE WK_RECORD INTEGER;
DECLARE VARIABLE WK_TRN_CODE CHAR(1);
DECLARE VARIABLE WK_TRN_TYPE VARCHAR(4);
DECLARE VARIABLE WK_TEST_DATE_X VARCHAR(40);
DECLARE VARIABLE WK_TEST_DATE_FMT VARCHAR(40);
DECLARE VARIABLE WK_TEST_DATE TIMESTAMP;
DECLARE VARIABLE WK_PASSED CHAR(1);
DECLARE VARIABLE WK_STATUS CHAR(2);
DECLARE VARIABLE WK_GLOBAL VARCHAR(40);
DECLARE VARIABLE WK_AUDIT_DESC VARCHAR(40) ;
BEGIN
   WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
   IF (WK_AUTORUN = 1) THEN
   BEGIN
      IF (NEW.TRN_TYPE = 'NITC') THEN
      BEGIN
         WK_DEVICE = NEW.DEVICE_ID;
         WK_WH_ID = NEW.WH_ID;
         WK_LOCN_ID = NEW.LOCN_ID;
         WK_USER = NEW.PERSON_ID;
         WK_SSN = NEW.OBJECT;
         WK_REFERENCE = NEW.REFERENCE;
         WK_QTY = NEW.QTY;
         WK_DATE = NEW.TRN_DATE;
         WK_RECORD = NEW.RECORD_ID;
         WK_TRN_CODE = NEW.TRN_CODE;
         WK_TRN_TYPE = NEW.TRN_TYPE;
         WK_TEST_DATE_X = '';
         WK_TEST_DATE_FMT = '';
	/* object = ssn
	   locn and wh_id for where
	   reference = 'timestamp|' or 
	               '' -> failed test
	               'timestamp|date format|' for different timestamp
	   update ssn's loan_safety_calibrate_date
	                loan_status ='XS' if failed test
	                other2 -> global conditions description for '2'
                                  'P' or 'F' for failed
           what about pick order of type for 'LC'
	*/
         EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_REFERENCE, 1  RETURNING_VALUES :WK_TEST_DATE_X ; 
         EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_REFERENCE, 2  RETURNING_VALUES :WK_TEST_DATE_FMT ; 
         WK_TEST_DATE_X = ALLTRIM(WK_TEST_DATE_X); 
         WK_TEST_DATE_FMT = ALLTRIM(WK_TEST_DATE_FMT); 
         IF (WK_TEST_DATE_FMT = '') THEN
         BEGIN
            WK_TEST_DATE_FMT = 'YYYY/MM/DD HH:MM:SS';
         END
         WK_TEST_DATE  = WK_DATE;
         IF (WK_TEST_DATE_X = '') THEN
         BEGIN
            /* failed test */
            WK_PASSED = 'F';
            WK_STATUS = 'XS';
         END
         ELSE
         BEGIN
            /* passed test */
            WK_PASSED = 'P';
            WK_STATUS = 'PS';
         END
         IF (WK_TEST_DATE_FMT = 'YYYY/MM/DD HH:MM:SS') THEN
         BEGIN
            WK_TEST_DATE = CAST(WK_TEST_DATE_X AS TIMESTAMP);
            WK_PASSED = 'P';
         END
         EXECUTE PROCEDURE GET_GLOBAL_CONDITION 2, :WK_PASSED RETURNING_VALUES :WK_GLOBAL;
         IF (WK_PASSED = 'P') THEN
         BEGIN
            UPDATE SSN
            SET OTHER2 = :WK_GLOBAL,
                LOAN_LAST_CALIBRATE_CHECK_DATE = :WK_TEST_DATE
            WHERE SSN_ID = :WK_SSN;
         END
         ELSE
         BEGIN
            UPDATE SSN
            SET OTHER2 = :WK_GLOBAL,
                LOAN_STATUS = :WK_STATUS
            WHERE SSN_ID = :WK_SSN;
         END
         WK_AUDIT_DESC = ' Calibration Test '  ;
         EXECUTE PROCEDURE ADD_SSN_HIST(:WK_WH_ID, :WK_LOCN_ID, :WK_SSN, 
                       :WK_TRN_TYPE, :WK_TRN_CODE, :WK_DATE,
                       :WK_AUDIT_DESC , :WK_REFERENCE, :WK_QTY, :WK_USER, :WK_DEVICE); 
         EXECUTE PROCEDURE UPDATE_TRAN (WK_RECORD, 'T','Processed successfully');
         /* EXECUTE PROCEDURE TRAN_ARCHIVE; */
      END
   END
END ^

CREATE TRIGGER RUN_TRANSACTION_PKTR FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 146 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_DEVICE CHAR(2);
DECLARE VARIABLE WK_USER VARCHAR(10);
DECLARE VARIABLE WK_RECORD INTEGER;
DECLARE VARIABLE WK_ISSUE_TO VARCHAR(10);
DECLARE VARIABLE WK_WH_ID CHAR(2);
DECLARE VARIABLE WK_LOCN_ID VARCHAR(10);
DECLARE VARIABLE WK_PRODUCT VARCHAR(30);
DECLARE VARIABLE WK_ISSN_ID VARCHAR(30);
DECLARE VARIABLE WK_QTY INTEGER;
DECLARE VARIABLE WK_TRN_TYPE VARCHAR(4);
DECLARE VARIABLE WK_TRN_CODE CHAR(1);
DECLARE VARIABLE WK_AUDIT_DESC VARCHAR(40);
DECLARE VARIABLE WK_DATE TIMESTAMP;
DECLARE VARIABLE WK_SO_ID VARCHAR(10);

DECLARE VARIABLE WK_PICK_LABEL_NO CHAR(8);
DECLARE VARIABLE WK_PICK_LABEL_START INTEGER;
DECLARE VARIABLE WK_PICK_LABEL_STOP INTEGER;
DECLARE VARIABLE WK_PICK_LABEL_PREFIX INTEGER;
DECLARE VARIABLE WK_LEN_LABEL_NO INTEGER;
DECLARE VARIABLE WK_LABEL_LENGTH INTEGER;
DECLARE VARIABLE WK_PICK_ADJUSTMENT INTEGER;
DECLARE VARIABLE WK_L_PICK_LABEL_NO  VARCHAR(7);
DECLARE VARIABLE WK_PI_PICK_LABEL_NO  VARCHAR(7);
DECLARE VARIABLE WK_PI_NEW  CHAR(1);
DECLARE VARIABLE WK_QTY_TOGET INTEGER;
DECLARE VARIABLE WK_SSN_QTY INTEGER;
DECLARE VARIABLE WK_SSN_ID VARCHAR(30);
DECLARE VARIABLE WK_SSN_PICK_ORDER VARCHAR(30);
DECLARE VARIABLE WK_SSN_STATUS CHAR(2);
DECLARE VARIABLE WK_SSN_OK CHAR(1);
DECLARE VARIABLE WK_REASON VARCHAR(40);
DECLARE VARIABLE WK_REFERENCE VARCHAR(40);
DECLARE VARIABLE iSSN_LENGTH INTEGER;
DECLARE VARIABLE iSSN_ID INTEGER;
DECLARE VARIABLE I_SSN_ID VARCHAR(20);
DECLARE VARIABLE I_LEN_SSN_ID INTEGER;
DECLARE VARIABLE LEN_SSN_ID INTEGER;
DECLARE VARIABLE P_SSN_ID INTEGER;
DECLARE VARIABLE WK_PARENT_SSN_ID VARCHAR(30);
DECLARE VARIABLE WK_SAVE_SSN_ID VARCHAR(30);
DECLARE VARIABLE WK_SAVE_PARENT_SSN_ID VARCHAR(30);
DECLARE VARIABLE WK_FROM_WH_ID CHAR(2);
DECLARE VARIABLE WK_FROM_LOCN_ID VARCHAR(10);
DECLARE VARIABLE WK_PICK_LINE_NO  CHAR(4);

BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'PKTR') THEN
  BEGIN
     WK_DEVICE = NEW.DEVICE_ID;
     WK_SO_ID = NEW.SUB_LOCN_ID;
     WK_WH_ID = NEW.WH_ID;
     WK_LOCN_ID = NEW.LOCN_ID;
     WK_USER = NEW.PERSON_ID;
     WK_ISSN_ID = NEW.OBJECT;
     WK_REFERENCE = NEW.REFERENCE;
     IF (WK_REFERENCE IS NULL) THEN
     BEGIN
        WK_REFERENCE = 'Transfer Picked to ';
     END
     WK_QTY = NEW.QTY;
     IF (WK_QTY IS NULL) THEN
     BEGIN
        WK_QTY = 0;
     END
     WK_DATE = NEW.TRN_DATE;
     WK_RECORD = NEW.RECORD_ID;
     WK_TRN_CODE = NEW.TRN_CODE;
     WK_TRN_TYPE = NEW.TRN_TYPE;
     WK_SAVE_SSN_ID = 'SAVE';
     WK_SAVE_PARENT_SSN_ID = 'SAVE';

     WK_AUDIT_DESC = :WK_REFERENCE || :WK_DEVICE ;
/*
     get order that is passed
     if passed issn is a product
     then use that product in the pick item
     else use the issns ssn_id
     does the record for ssn or product exist in the order
     then update it
         if it is for a product just add to the total
     else
         get label no for pick_item
         create pick_item
    'DS' status 

     set qtytoget from qty passed
     if null or zero use the issn's qty

          if current_qty > qtytoget
                split the issn so that we take the qtytoget
                and create a pick_item_detail for it
                and change the status to 'DS' 
                set the qtytoget to 0
          else
                take all current_qty
                create a pick_item_detail
                change status to 'DS' 
                reduce the qtytoget by the current_qty
          if (qtytoget is zero)
               break
*/
     WK_SSN_ID = '';
     WK_SSN_QTY = 0;
     WK_PARENT_SSN_ID = '';
     WK_PRODUCT = '';
     WK_SSN_PICK_ORDER = '';
     SELECT SSN_ID, CURRENT_QTY, ORIGINAL_SSN, PROD_ID, PICK_ORDER, ISSN_STATUS, PREV_WH_ID, PREV_LOCN_ID
         FROM ISSN
         WHERE SSN_ID = :WK_ISSN_ID
          INTO :WK_SSN_ID, :WK_SSN_QTY, :WK_PARENT_SSN_ID, :WK_PRODUCT, :WK_SSN_PICK_ORDER, :WK_SSN_STATUS, :WK_FROM_WH_ID, :WK_FROM_LOCN_ID;
     IF (WK_PRODUCT IS NULL) THEN
     BEGIN
        WK_PRODUCT = '';
     END
     IF ((WK_SSN_PICK_ORDER IS NULL) OR (WK_SSN_PICK_ORDER = '')) THEN
     BEGIN
        WK_SSN_OK = 'T';
     END
     ELSE
     BEGIN
        EXECUTE PROCEDURE UPDATE_TRAN (:WK_RECORD, 'F', 'Invalid ISSN - Already Reserved');
        EXIT;
     END
     IF ((WK_SSN_QTY IS NULL) OR (WK_SSN_QTY = 0)) THEN
     BEGIN
        EXECUTE PROCEDURE UPDATE_TRAN (:WK_RECORD, 'F', 'Invalid ISSN - No Qty');
        EXIT;
     END
     WK_L_PICK_LABEL_NO = '';
     WK_PI_PICK_LABEL_NO = '';
     IF (WK_PRODUCT = '') THEN
     BEGIN
        /* ok want to use the qty as orders qty for this issn */
        FOR SELECT PICK_LABEL_NO 
        FROM PICK_ITEM 
        WHERE PICK_ORDER = :WK_SO_ID
        AND   SSN_ID = :WK_ISSN_ID
        AND   PICK_LINE_STATUS IN ('DS','PG','PL','AL','OP')
        INTO :WK_PI_PICK_LABEL_NO
        DO
        BEGIN
           WK_L_PICK_LABEL_NO = :WK_PI_PICK_LABEL_NO;
        END
     END
     ELSE
     BEGIN
        /* ok want to add the qty to orders qty for this product */
        FOR SELECT PICK_LABEL_NO 
        FROM PICK_ITEM 
        WHERE PICK_ORDER = :WK_SO_ID
        AND   PROD_ID = :WK_PRODUCT
        AND   PICK_LINE_STATUS IN ('DS','PG','PL','AL','OP')
        INTO :WK_PI_PICK_LABEL_NO
        DO
        BEGIN
           WK_L_PICK_LABEL_NO = :WK_PI_PICK_LABEL_NO;
        END
     END

     WK_PI_NEW = 'F';
     IF (WK_L_PICK_LABEL_NO = '') THEN
     BEGIN
        /* no pick item search get the next label */ 
        WK_PI_NEW = 'T';
        /* Get length for label */   
        SELECT MAX_LENGTH
        FROM PARAM
        WHERE DATA_ID = 'PICK'
        INTO :WK_LABEL_LENGTH;
        WK_PICK_LABEL_NO = GEN_ID(PICK_LABEL_GEN, 1);
        WK_PICK_LABEL_START = GEN_ID(PICK_LABEL_START, 0);
        WK_PICK_LABEL_STOP = GEN_ID(PICK_LABEL_STOP, 0);
        WK_PICK_LABEL_PREFIX = GEN_ID(PICK_LABEL_PREFIX , 0);
        IF (WK_PICK_LABEL_NO > WK_PICK_LABEL_STOP) THEN
        BEGIN
           WK_PICK_ADJUSTMENT = WK_PICK_LABEL_START - WK_PICK_LABEL_STOP;
           WK_PICK_LABEL_NO = GEN_ID(PICK_LABEL_GEN, WK_PICK_ADJUSTMENT);
           WK_PICK_LABEL_PREFIX = GEN_ID(PICK_LABEL_PREFIX , 1);
           WK_PICK_LABEL_NO = WK_PICK_LABEL_START;
        END
        WK_LEN_LABEL_NO = STRLEN(ALLTRIM(WK_PICK_LABEL_NO)) + 1;     
        /* Get Label prefix */      
        WK_L_PICK_LABEL_NO = chr(WK_PICK_LABEL_PREFIX);
        /* Padding leading with 0 */
        WHILE (WK_LEN_LABEL_NO < WK_LABEL_LENGTH) DO
        BEGIN
           WK_L_PICK_LABEL_NO = WK_L_PICK_LABEL_NO || '0';      
           WK_LEN_LABEL_NO = WK_LEN_LABEL_NO + 1;
        END
        WK_L_PICK_LABEL_NO = WK_L_PICK_LABEL_NO || ALLTRIM(WK_PICK_LABEL_NO);
     END

     WK_QTY_TOGET = WK_QTY;
     IF (WK_QTY_TOGET = 0) THEN
     BEGIN
        WK_QTY_TOGET = WK_SSN_QTY;
     END
     /* add pick item */
     IF (WK_PI_NEW = 'T') THEN
     BEGIN
        SELECT PICK_ORDER_LINE_NO 
        FROM GET_SALE_LINES_NO(:WK_SO_ID) 
        INTO :WK_PICK_LINE_NO ;
        /* a new record is required */
        IF (WK_PRODUCT = '') THEN
        BEGIN
           INSERT INTO PICK_ITEM(PICK_LABEL_NO,PICK_ORDER,SSN_ID,PICK_ORDER_QTY,PICKED_QTY,CREATE_DATE,USER_ID,DEVICE_ID,PICK_LINE_STATUS,WH_ID,PICK_LOCATION,DESPATCH_LOCATION,SSN_CONFIRM,PICK_ORDER_LINE_NO) 
                  VALUES (:WK_L_PICK_LABEL_NO,:WK_SO_ID,:WK_ISSN_ID,:WK_QTY_TOGET,:WK_QTY_TOGET,:WK_DATE,:WK_USER,:WK_DEVICE,'DS',:WK_WH_ID,:WK_LOCN_ID,:WK_LOCN_ID,'F',:WK_PICK_LINE_NO);
        END
        ELSE
        BEGIN
           INSERT INTO PICK_ITEM(PICK_LABEL_NO,PICK_ORDER,PROD_ID,PICK_ORDER_QTY,PICKED_QTY,CREATE_DATE,USER_ID,DEVICE_ID,PICK_LINE_STATUS,WH_ID,PICK_LOCATION,DESPATCH_LOCATION,SSN_CONFIRM,PICK_ORDER_LINE_NO) 
                  VALUES (:WK_L_PICK_LABEL_NO,:WK_SO_ID,:WK_PRODUCT,:WK_QTY_TOGET,:WK_QTY_TOGET,:WK_DATE,:WK_USER,:WK_DEVICE,'DS',:WK_WH_ID,:WK_LOCN_ID,:WK_LOCN_ID,'F',:WK_PICK_LINE_NO);
        END
     END
     ELSE
     BEGIN
        /* an old record exists */
        IF (WK_PRODUCT = '') THEN
        BEGIN
           UPDATE PICK_ITEM
           SET PICK_ORDER_QTY =  :WK_QTY_TOGET,
           PICKED_QTY =  :WK_QTY_TOGET,
           USER_ID =  :WK_USER,
           DEVICE_ID = :WK_DEVICE,
           PICK_LINE_STATUS = 'DS',
           WH_ID = :WK_WH_ID,
           PICK_LOCATION = :WK_LOCN_ID,
           DESPATCH_LOCATION = :WK_LOCN_ID
           WHERE PICK_LABEL_NO =  :WK_L_PICK_LABEL_NO ;
        END
        ELSE
        BEGIN
           UPDATE PICK_ITEM
           SET PICK_ORDER_QTY = PICK_ORDER_QTY +  :WK_QTY_TOGET,
           PICKED_QTY = PICKED_QTY +  :WK_QTY_TOGET,
           USER_ID =  :WK_USER,
           DEVICE_ID = :WK_DEVICE,
           PICK_LINE_STATUS = 'DS',
           WH_ID = :WK_WH_ID,
           PICK_LOCATION = :WK_LOCN_ID,
           DESPATCH_LOCATION = :WK_LOCN_ID
           WHERE PICK_LABEL_NO =  :WK_L_PICK_LABEL_NO
           AND (PICKED_QTY IS NOT NULL);
           UPDATE PICK_ITEM
           SET PICK_ORDER_QTY = PICK_ORDER_QTY +  :WK_QTY_TOGET,
           PICKED_QTY =  :WK_QTY_TOGET,
           USER_ID =  :WK_USER,
           DEVICE_ID = :WK_DEVICE,
           PICK_LINE_STATUS = 'DS',
           WH_ID = :WK_WH_ID,
           PICK_LOCATION = :WK_LOCN_ID,
           DESPATCH_LOCATION = :WK_LOCN_ID
           WHERE PICK_LABEL_NO =  :WK_L_PICK_LABEL_NO
           AND PICKED_QTY IS  NULL;
        END
     END
     /* reserve issn */
     UPDATE ISSN 
     SET PICK_ORDER = :WK_L_PICK_LABEL_NO,
     PREV_PREV_PACK_ID = PREV_PACK_ID,
     PREV_PACK_ID = PACK_ID,
     PACK_ID = NULL,
     PREV_PREV_DESPATCH_ID = PREV_DESPATCH_ID,
     PREV_DESPATCH_ID = DESPATCH_ID,
     DESPATCH_ID = NULL
     WHERE SSN_ID = :WK_ISSN_ID;

     BEGIN
        WK_SAVE_SSN_ID = WK_SSN_ID;
        WK_SAVE_PARENT_SSN_ID = WK_PARENT_SSN_ID;
        IF (WK_QTY_TOGET > 0) THEN
        BEGIN
           IF (WK_SSN_QTY > WK_QTY_TOGET) THEN
           BEGIN
              /*  SPlit it */
              /* Get length for Barcode */   
              EXECUTE PROCEDURE GET_BARCODE_LENGTH RETURNING_VALUES iSSN_LENGTH;
              iSSN_ID = GEN_ID(ISSN_SSN_ID, 1);
              P_SSN_ID = iSSN_ID - 1;
              LEN_SSN_ID = STRLEN(P_SSN_ID);
              I_SSN_ID = '';
              I_LEN_SSN_ID = STRLEN(P_SSN_ID);
                 
              /* Padding leading with 0 */
              WHILE (I_LEN_SSN_ID < :iSSN_LENGTH) DO
              BEGIN
                 I_SSN_ID = I_SSN_ID || '0';
                 I_LEN_SSN_ID = I_LEN_SSN_ID + 1;
              END
              I_SSN_ID = I_SSN_ID || P_SSN_ID;
                 
              EXECUTE PROCEDURE PC_TRSS 
              :WK_RECORD ,
              :WK_WH_ID,
              :WK_LOCN_ID,
              :WK_SSN_ID,
              'TRSS',
              'A',
              :WK_DATE,
              :I_SSN_ID,
              :WK_QTY_TOGET,
              :WK_USER,
              :WK_DEVICE;
              /* take all this of the split issn */
              UPDATE ISSN SET ISSN_STATUS = 'DS'
               WHERE SSN_ID = :I_SSN_ID;
               WK_REASON = 'Issued Split ' || :WK_QTY_TOGET || 'to User ' || :WK_USER ;
               EXECUTE PROCEDURE ADD_SSN_HIST(:WK_WH_ID, :WK_LOCN_ID, :WK_PARENT_SSN_ID, 
                       :WK_TRN_TYPE, :WK_TRN_CODE, :WK_DATE,
                       :WK_AUDIT_DESC , :WK_REASON, :WK_QTY_TOGET, :WK_USER, :WK_DEVICE); 
               INSERT INTO PICK_ITEM_DETAIL 
                   (PICK_LABEL_NO, 
                    SSN_ID, 
                    PICK_DETAIL_STATUS, 
                    QTY_PICKED,
                    USER_ID, 
                    DEVICE_ID, 
                    CREATE_DATE,
                    FROM_WH_ID,
                    FROM_LOCN_ID,
                    DESPATCH_LOCATION)
               VALUES (:WK_L_PICK_LABEL_NO, 
                    :I_SSN_ID,
                    'DS',
                    :WK_QTY_TOGET,
                    :WK_USER,
                    :WK_DEVICE,
                    :WK_DATE,
                    :WK_FROM_WH_ID,
                    :WK_FROM_LOCN_ID,
                    :WK_LOCN_ID);
                WK_QTY_TOGET = 0;
           END
           ELSE
           BEGIN
              /* take all this qty */
              UPDATE ISSN SET ISSN_STATUS = 'DS'
               WHERE SSN_ID = :WK_SSN_ID;
               WK_REASON = 'Issued All ' || :WK_QTY || 'to User ' || :WK_USER ;
               EXECUTE PROCEDURE ADD_SSN_HIST(:WK_WH_ID, :WK_LOCN_ID, :WK_SSN_ID, 
                       :WK_TRN_TYPE, :WK_TRN_CODE, :WK_DATE,
                       :WK_AUDIT_DESC , :WK_REASON, :WK_QTY, :WK_USER, :WK_DEVICE); 
               INSERT INTO PICK_ITEM_DETAIL 
                   (PICK_LABEL_NO, 
                    SSN_ID, 
                    PICK_DETAIL_STATUS, 
                    QTY_PICKED,
                    USER_ID, 
                    DEVICE_ID, 
                    CREATE_DATE,
                    FROM_WH_ID,
                    FROM_LOCN_ID,
                    DESPATCH_LOCATION)
               VALUES (:WK_L_PICK_LABEL_NO, 
                    :WK_SSN_ID,
                    'DS',
                    :WK_SSN_QTY,
                    :WK_USER,
                    :WK_DEVICE,
                    :WK_DATE,
                    :WK_FROM_WH_ID,
                    :WK_FROM_LOCN_ID,
                    :WK_LOCN_ID);
                WK_QTY_TOGET = WK_QTY_TOGET - WK_SSN_QTY;
           END
        END
     END

   IF (WK_QTY_TOGET > 0) THEN
   BEGIN
      WK_REASON = 'Still to Pick ' || :WK_QTY_TOGET || ' OF ' || :WK_QTY ;
      EXECUTE PROCEDURE UPDATE_TRAN (WK_RECORD, 'F',:WK_REASON);
      IF (WK_SAVE_SSN_ID <> 'SAVE') THEN
      BEGIN
         UPDATE ISSN SET ISSN_STATUS = 'DS'
         WHERE SSN_ID = :WK_SAVE_SSN_ID;
         WK_REASON = 'Issued Negative ' || :WK_QTY_TOGET || 'to User ' || :WK_USER ;
         EXECUTE PROCEDURE ADD_SSN_HIST(:WK_WH_ID, :WK_LOCN_ID, :WK_SAVE_PARENT_SSN_ID, 
                       :WK_TRN_TYPE, :WK_TRN_CODE, :WK_DATE,
                       :WK_AUDIT_DESC , :WK_REASON, :WK_QTY_TOGET, :WK_USER, :WK_DEVICE); 
      END
   END
   ELSE
   BEGIN
      EXECUTE PROCEDURE UPDATE_TRAN (WK_RECORD, 'T','Processed successfully');
   END
   /* EXECUTE PROCEDURE TRAN_ARCHIVE; */
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_MDAC FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 147 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_DEVICE CHAR(2);
DECLARE VARIABLE WK_USER VARCHAR(10);
DECLARE VARIABLE WK_RECORD INTEGER;
DECLARE VARIABLE WK_SUB_LOCN VARCHAR(10);
DECLARE VARIABLE WK_WH_ID CHAR(2);
DECLARE VARIABLE WK_LOCN_ID VARCHAR(10);
DECLARE VARIABLE WK_OBJECT VARCHAR(30);
DECLARE VARIABLE WK_QTY INTEGER;
DECLARE VARIABLE WK_TRN_TYPE VARCHAR(4);
DECLARE VARIABLE WK_TRN_CODE CHAR(1);
DECLARE VARIABLE WK_DATE TIMESTAMP;
DECLARE VARIABLE WK_REFERENCE VARCHAR(40);

DECLARE VARIABLE WK_CARRIER_ID VARCHAR(12);
DECLARE VARIABLE WK_PERSON_TYPE CHAR(2);
DECLARE VARIABLE WK_PERSON_FIRST_NAME VARCHAR(30);
DECLARE VARIABLE WK_CARRIER_TYPE VARCHAR(10);
DECLARE VARIABLE WK_CARRIER_SERVICE VARCHAR(10);
DECLARE VARIABLE WK_CONTACT_FIRST_NAME VARCHAR(40);
DECLARE VARIABLE WK_CONTACT_LAST_NAME VARCHAR(40);
DECLARE VARIABLE WK_FOUND  INTEGER;
DECLARE VARIABLE WK_AUDIT_DESC VARCHAR(40);
DECLARE VARIABLE WK_REASON VARCHAR(40);
DECLARE VARIABLE WK_TRY_CNT INTEGER;
DECLARE VARIABLE WK_LABEL VARCHAR(40);
DECLARE VARIABLE WK_LABEL_TRY VARCHAR(40);
DECLARE VARIABLE WK_TEST_NAME VARCHAR(255); 
DECLARE VARIABLE WK_LOG_FILENAME VARCHAR(255);
DECLARE VARIABLE WK_LOG_RESULT INTEGER;
DECLARE VARIABLE WK_RESPONSE_TXT VARCHAR(255);
BEGIN
/*
add/update a supplier
ie person record person type = CA
supplier record
supplier service if a supplier service entered
*/
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'MDAC') THEN
  BEGIN
     WK_LOG_FILENAME = '/tmp/mdac.log';
     WK_DEVICE = NEW.DEVICE_ID;
     WK_SUB_LOCN = NEW.SUB_LOCN_ID;
     IF (WK_SUB_LOCN  IS NULL) THEN
     BEGIN
        WK_SUB_LOCN   = ' | ';
     END
     WK_WH_ID = NEW.WH_ID;
     WK_LOCN_ID = NEW.LOCN_ID;
     WK_USER = NEW.PERSON_ID;
     WK_OBJECT = NEW.OBJECT;
     WK_REFERENCE = NEW.REFERENCE;
     IF (WK_REFERENCE IS NULL) THEN
     BEGIN
        WK_REFERENCE = ' | ';
     END
     WK_QTY = NEW.QTY;
     IF (WK_QTY IS NULL) THEN
     BEGIN
        WK_QTY = 0;
     END
     WK_DATE = NEW.TRN_DATE;
     WK_RECORD = NEW.RECORD_ID;
     WK_TRN_CODE = NEW.TRN_CODE;
     WK_TRN_TYPE = NEW.TRN_TYPE;
     WK_CARRIER_ID = WK_WH_ID;
     IF (WK_CARRIER_ID IS NULL) THEN
     BEGIN
        WK_CARRIER_ID = '';
     END
     IF (WK_LOCN_ID IS NOT NULL) THEN
     BEGIN
        WK_CARRIER_ID = WK_CARRIER_ID || WK_LOCN_ID;
     END
     IF (STRLEN(WK_CARRIER_ID) > 10) THEN
     BEGIN
        WK_CARRIER_ID = SUBSTR(WK_CARRIER_ID,1,10);
     END
     WK_PERSON_TYPE = 'CA';
     WK_PERSON_FIRST_NAME = WK_OBJECT;
     WK_CARRIER_TYPE = '';
     WK_CARRIER_SERVICE = '';
     WK_CONTACT_FIRST_NAME = '';
     WK_CONTACT_LAST_NAME = '';
     EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_SUB_LOCN , 1  RETURNING_VALUES :WK_CARRIER_TYPE ; 
     EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_SUB_LOCN , 2  RETURNING_VALUES :WK_CARRIER_SERVICE ; 
     EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_REFERENCE , 1  RETURNING_VALUES :WK_CONTACT_FIRST_NAME ; 
     EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_REFERENCE, 2  RETURNING_VALUES :WK_CONTACT_LAST_NAME ; 
     WK_CARRIER_TYPE = ALLTRIM(WK_CARRIER_TYPE);
     WK_CARRIER_SERVICE = ALLTRIM(WK_CARRIER_SERVICE);
     WK_CONTACT_FIRST_NAME = ALLTRIM(WK_CONTACT_FIRST_NAME);
     WK_CONTACT_LAST_NAME = ALLTRIM(WK_CONTACT_LAST_NAME);
   WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, '1:' || wk_user || wk_device || wk_trn_type || wk_trn_code);
   WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, '2 wh:' || wk_wh_id || ' locn:' || wk_locn_id || ' object:' || wk_object || ' ref:' || wk_reference);
   WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, '3 subtype:' || wk_sub_locn);
   WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, '4 carrier:' || wk_carrier_id);
     IF (WK_CARRIER_ID = '') THEN
     BEGIN
            WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, '5 carrier is empty' );
            /* must calculate the next company id  */
            /* need 10 bytes  soundex returns 4 bytes */
            WK_TRY_CNT = 0;
            WK_FOUND = 1;
            WK_TEST_NAME = '';
            IF (WK_PERSON_FIRST_NAME IS NOT NULL) THEN
            BEGIN
               WK_TEST_NAME = WK_PERSON_FIRST_NAME;
            END
            WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, '6 test:' || wk_test_name );
            IF (WK_CONTACT_FIRST_NAME IS NOT NULL) THEN
            BEGIN
               WK_TEST_NAME = WK_TEST_NAME || ' ' ||  WK_CONTACT_FIRST_NAME;
            END
            WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, '7 test:' || wk_test_name );
            IF (WK_CONTACT_LAST_NAME IS NOT NULL) THEN
            BEGIN
               WK_TEST_NAME = WK_TEST_NAME || ' ' ||  WK_CONTACT_LAST_NAME;
            END
            WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, '8 test:' || wk_test_name );
            WK_LABEL = FUD_SOUNDEX(WK_TEST_NAME) ;
            WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, '9 sound:' || wk_label );
            /* try up to 100 next labels */
            WHILE (WK_FOUND > 0 AND WK_TRY_CNT < 200)
            DO
            BEGIN
               WK_LABEL_TRY = WK_LABEL || WK_TRY_CNT;
               /* now try this */
               WK_TRY_CNT = WK_TRY_CNT + 1;
               WK_FOUND = 0;
               SELECT 1  FROM PERSON
               WHERE PERSON_ID = :WK_LABEL_TRY
               INTO :WK_FOUND ;
               WK_CARRIER_ID = WK_LABEL_TRY;
            WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, '10 carrier:' || wk_carrier_id );
               IF (WK_FOUND = 0) THEN
               BEGIN
                  /* ok use this carrier id */
                  WK_CARRIER_ID = WK_LABEL_TRY;
            WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, '11 new carrier:' || wk_carrier_id );
               END
            END
     END
            WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, '12 carrier:' || wk_carrier_id );
     /* do person record */
     WK_FOUND = 0;
     SELECT 1 FROM PERSON 
         WHERE PERSON_ID = :WK_CARRIER_ID
         INTO :WK_FOUND;
     IF (WK_FOUND = 0) THEN
     BEGIN
        /* NO PERSON SO INSERT IT */
        INSERT INTO PERSON (PERSON_ID, 
            PERSON_TYPE, 
            FIRST_NAME, 
            LAST_NAME, 
            CONTACT_FIRST_NAME, 
            CONTACT_LAST_NAME 
            )
        VALUES (:WK_CARRIER_ID, 
            :WK_PERSON_TYPE, 
            :WK_PERSON_FIRST_NAME, 
            '', 
            :WK_CONTACT_FIRST_NAME, 
            :WK_CONTACT_LAST_NAME 
            );
     END
     ELSE
     BEGIN
        UPDATE PERSON  SET PERSON_TYPE = :WK_PERSON_TYPE, 
            FIRST_NAME = :WK_PERSON_FIRST_NAME, 
            LAST_NAME = '', 
            CONTACT_FIRST_NAME = :WK_CONTACT_FIRST_NAME, 
            CONTACT_LAST_NAME = :WK_CONTACT_LAST_NAME 
          WHERE PERSON_ID = :WK_CARRIER_ID;
     END
     /* do carrier record */
     WK_FOUND = 0;
     SELECT 1 FROM CARRIER 
         WHERE CARRIER_ID = :WK_CARRIER_ID
         INTO :WK_FOUND;
     IF (WK_FOUND = 0) THEN
     BEGIN
        /* NO CARRIER SO INSERT IT */
        INSERT INTO CARRIER (CARRIER_ID, 
            PREFIX, 
            FILE_EXT, 
            START_NO, 
            END_NO, 
            TRN_TYPE 
            )
        VALUES (:WK_CARRIER_ID, 
            '', 
            '', 
            '0', 
            '999999999', 
            :WK_CARRIER_TYPE 
            );
     END
     ELSE
     BEGIN
        UPDATE CARRIER  SET TRN_TYPE = :WK_CARRIER_TYPE 
          WHERE CARRIER_ID = :WK_CARRIER_ID;
     END
     /* do carrier service record */
     IF (STRLEN(WK_CARRIER_SERVICE) = 0) THEN
     BEGIN
        WK_CARRIER_SERVICE = 'EXP';
     END
     WK_FOUND = 0;
     SELECT 1 FROM CARRIER_SERVICE 
         WHERE CARRIER_ID = :WK_CARRIER_ID
         AND SERVICE_TYPE = :WK_CARRIER_SERVICE
         INTO :WK_FOUND;
     IF (WK_FOUND = 0) THEN
     BEGIN
        /* NO CARRIER SERVICE SO INSERT IT */
        INSERT INTO CARRIER_SERVICE (CARRIER_ID, 
            SERVICE_TYPE, 
            DESCRIPTION 
            )
        VALUES (:WK_CARRIER_ID, 
            :WK_CARRIER_SERVICE, 
            :WK_CARRIER_SERVICE 
            );
     END
     
     WK_RESPONSE_TXT = WK_CARRIER_ID || '|Processed successfully';
     /* EXECUTE PROCEDURE UPDATE_TRAN (WK_RECORD, 'T','Processed successfully'); */
      EXECUTE PROCEDURE UPDATE_TRAN (WK_RECORD, 'T',WK_RESPONSE_TXT);
   /* EXECUTE PROCEDURE TRAN_ARCHIVE; */
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_MDPE FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 148 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_DEVICE CHAR(2);
DECLARE VARIABLE WK_USER VARCHAR(10);
DECLARE VARIABLE WK_RECORD INTEGER;
DECLARE VARIABLE WK_SUB_LOCN VARCHAR(10);
DECLARE VARIABLE WK_WH_ID CHAR(2);
DECLARE VARIABLE WK_LOCN_ID VARCHAR(10);
DECLARE VARIABLE WK_OBJECT VARCHAR(30);
DECLARE VARIABLE WK_QTY INTEGER;
DECLARE VARIABLE WK_TRN_TYPE VARCHAR(4);
DECLARE VARIABLE WK_TRN_CODE CHAR(1);
DECLARE VARIABLE WK_DATE TIMESTAMP;
DECLARE VARIABLE WK_REFERENCE VARCHAR(255);

DECLARE VARIABLE WK_PERSON_ID VARCHAR(12);
DECLARE VARIABLE WK_PERSON_TYPE CHAR(2);
DECLARE VARIABLE WK_PERSON_FIRST_NAME VARCHAR(125);
DECLARE VARIABLE WK_CONTACT_FIRST_NAME VARCHAR(100);
DECLARE VARIABLE WK_CONTACT_LAST_NAME VARCHAR(100);
DECLARE VARIABLE WK_FOUND  INTEGER;
DECLARE VARIABLE WK_TRY_CNT INTEGER;
DECLARE VARIABLE WK_LABEL VARCHAR(40);
DECLARE VARIABLE WK_LABEL_TRY VARCHAR(40);
DECLARE VARIABLE WK_TEST_NAME VARCHAR(255); 
DECLARE VARIABLE WK_LOG_FILENAME VARCHAR(255);
DECLARE VARIABLE WK_LOG_RESULT INTEGER;
DECLARE VARIABLE WK_RESPONSE_TXT VARCHAR(255);
BEGIN
/*
add/update a person record
*/
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'MDPE') THEN
  BEGIN
     WK_LOG_FILENAME = '/tmp/mdpe.log';
     WK_DEVICE = NEW.DEVICE_ID;
     WK_SUB_LOCN = NEW.SUB_LOCN_ID;
     WK_WH_ID = NEW.WH_ID;
     WK_LOCN_ID = NEW.LOCN_ID;
     WK_USER = NEW.PERSON_ID;
     WK_OBJECT = NEW.OBJECT;
     WK_REFERENCE = NEW.REFERENCE;
     IF (WK_REFERENCE IS NULL) THEN
     BEGIN
        WK_REFERENCE = ' | ';
     END
     WK_QTY = NEW.QTY;
     IF (WK_QTY IS NULL) THEN
     BEGIN
        WK_QTY = 0;
     END
     WK_DATE = NEW.TRN_DATE;
     WK_RECORD = NEW.RECORD_ID;
     WK_TRN_CODE = NEW.TRN_CODE;
     WK_TRN_TYPE = NEW.TRN_TYPE;
     WK_PERSON_ID = WK_WH_ID;
     IF (WK_PERSON_ID IS NULL) THEN
     BEGIN
        WK_PERSON_ID = '';
     END
     IF (WK_LOCN_ID IS NOT NULL) THEN
     BEGIN
        WK_PERSON_ID = WK_PERSON_ID || WK_LOCN_ID;
     END
     IF (STRLEN(WK_PERSON_ID) > 10) THEN
     BEGIN
        WK_PERSON_ID = SUBSTR(WK_PERSON_ID,1,10);
     END
     WK_PERSON_TYPE = WK_SUB_LOCN;
     WK_PERSON_FIRST_NAME = WK_OBJECT;
     WK_CONTACT_FIRST_NAME = '';
     WK_CONTACT_LAST_NAME = '';
     EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_REFERENCE , 1  RETURNING_VALUES :WK_CONTACT_FIRST_NAME ; 
     EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_REFERENCE, 2  RETURNING_VALUES :WK_CONTACT_LAST_NAME ; 
     WK_CONTACT_FIRST_NAME = ALLTRIM(WK_CONTACT_FIRST_NAME);
     WK_CONTACT_LAST_NAME = ALLTRIM(WK_CONTACT_LAST_NAME);
   WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, '1:' || wk_user || wk_device || wk_trn_type || wk_trn_code);
   WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, '2 wh:' || wk_wh_id || ' locn:' || wk_locn_id || ' object:' || wk_object || ' ref:' || wk_reference);
   WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, '3 subtype:' || wk_sub_locn);
   WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, '4 person:' || wk_person_id);
     IF (WK_PERSON_ID = '') THEN
     BEGIN
            WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, '5 person is empty' );
            /* must calculate the next company id  */
            /* need 10 bytes  soundex returns 4 bytes */
            WK_TRY_CNT = 0;
            WK_FOUND = 1;
            WK_TEST_NAME = '';
            IF (WK_PERSON_FIRST_NAME IS NOT NULL) THEN
            BEGIN
               WK_TEST_NAME = WK_PERSON_FIRST_NAME;
            END
            WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, '6 test:' || wk_test_name );
            IF (WK_CONTACT_FIRST_NAME IS NOT NULL) THEN
            BEGIN
               WK_TEST_NAME = WK_TEST_NAME || ' ' ||  WK_CONTACT_FIRST_NAME;
            END
            WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, '7 test:' || wk_test_name );
            IF (WK_CONTACT_LAST_NAME IS NOT NULL) THEN
            BEGIN
               WK_TEST_NAME = WK_TEST_NAME || ' ' ||  WK_CONTACT_LAST_NAME;
            END
            WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, '8 test:' || wk_test_name );
            WK_LABEL = FUD_SOUNDEX(WK_TEST_NAME) ;
            WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, '9 sound:' || wk_label );
            /* try up to 100 next labels */
            WHILE (WK_FOUND > 0 AND WK_TRY_CNT < 200)
            DO
            BEGIN
               WK_LABEL_TRY = WK_LABEL || WK_TRY_CNT;
               /* now try this */
               WK_TRY_CNT = WK_TRY_CNT + 1;
               WK_FOUND = 0;
               SELECT 1  FROM PERSON
               WHERE PERSON_ID = :WK_LABEL_TRY
               INTO :WK_FOUND ;
               WK_PERSON_ID = WK_LABEL_TRY;
            WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, '10 person:' || wk_person_id );
               IF (WK_FOUND = 0) THEN
               BEGIN
                  /* ok use this carrier id */
                  WK_PERSON_ID = WK_LABEL_TRY;
            WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, '11 new person:' || wk_person_id );
               END
            END
     END
            WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, '12 person:' || wk_person_id );
     /* do person record */
     WK_FOUND = 0;
     SELECT 1 FROM PERSON 
         WHERE PERSON_ID = :WK_PERSON_ID
         INTO :WK_FOUND;
     IF (WK_FOUND = 0) THEN
     BEGIN
        /* NO PERSON SO INSERT IT */
        INSERT INTO PERSON (PERSON_ID, 
            PERSON_TYPE, 
            FIRST_NAME, 
            LAST_NAME, 
            CONTACT_FIRST_NAME, 
            CONTACT_LAST_NAME 
            )
        VALUES (:WK_PERSON_ID, 
            :WK_PERSON_TYPE, 
            :WK_PERSON_FIRST_NAME, 
            '', 
            :WK_CONTACT_FIRST_NAME, 
            :WK_CONTACT_LAST_NAME 
            );
     END
     ELSE
     BEGIN
        UPDATE PERSON  SET PERSON_TYPE = :WK_PERSON_TYPE, 
            FIRST_NAME = :WK_PERSON_FIRST_NAME, 
            LAST_NAME = '', 
            CONTACT_FIRST_NAME = :WK_CONTACT_FIRST_NAME, 
            CONTACT_LAST_NAME = :WK_CONTACT_LAST_NAME 
          WHERE PERSON_ID = :WK_PERSON_ID;
     END
     WK_RESPONSE_TXT = WK_PERSON_ID || '|Processed successfully';
     /* EXECUTE PROCEDURE UPDATE_TRAN (WK_RECORD, 'T','Processed successfully'); */
      EXECUTE PROCEDURE UPDATE_TRAN (WK_RECORD, 'T',WK_RESPONSE_TXT);
   /* EXECUTE PROCEDURE TRAN_ARCHIVE; */
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_TRBK FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 149 
AS
/* Transfer of issn back to warehouse 
   ie a return 
   from DX status to PA 
   amend qty which should be less than the prev_qty

   then do transfer to location 
   that will optionally change the qty if its zero
   release the issn from the previous order (as in DI returns)
   change its status
   note that glen was talking about using a receive location
   ie 'RC' move stat

   then print issn label
   if control.external_script_4_label = 'T'
   {
      here an external php script creates the labels or bartender files
      if control.generate_label_text = 'T'
      {
          create a file for bartender to use - from the error text of this transaction
      }
      else
      {
          create a file for label to use - from the error text of this transaction
      }
   }
   else
   {
      if control.generate_label_text = 'T'
      {
          if the issn is a product 
          {
              use pc_label_product to cronstuct a file for bartender to use
          }
          else
          {
              use pc_label_issn    to cronstuct a file for bartender to use
          }
      }
      else
      {
          use pc_label to create a label
      }
   }
   10/AUG/2009
   using the printer device in the sub_locn field
   13/AUG/2009
   if qty <> current qty or prev qty
        then do a split of the original issn
        put the remaing qty in this issn
        and add a zero qty picked record in pick_item_detail for this
   adjust the error text to send the ssn used and qty

   adjust the despatch id of the credit records
   only allow 1 trbk on an issn in an order
 */
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_DEVICE CHAR(2);
DECLARE VARIABLE WK_WH_ID CHAR(2);
DECLARE VARIABLE WK_LOCN_ID VARCHAR(10);
DECLARE VARIABLE WK_USER VARCHAR(10);
DECLARE VARIABLE WK_RECORD INTEGER;
DECLARE VARIABLE WK_DATE TIMESTAMP;
DECLARE VARIABLE WK_OBJECT VARCHAR(30);
DECLARE VARIABLE WK_REFERENCE VARCHAR(40);
DECLARE VARIABLE WK_QTY INTEGER;
DECLARE VARIABLE WK_SUB_LOCN_ID VARCHAR(10);
DECLARE VARIABLE WK_ISSN VARCHAR(20);
DECLARE VARIABLE WK_ISSN_PICK_ORDER VARCHAR(20);
DECLARE VARIABLE WK_ISSN_PROD VARCHAR(30);
DECLARE VARIABLE WK_ISSN_WH_ID CHAR(2);
DECLARE VARIABLE WK_ISSN_LOCN_ID VARCHAR(10);
DECLARE VARIABLE WK_ISSN_CURRENT_QTY INTEGER;
DECLARE VARIABLE WK_ISSN_ORIGINAL_SSN VARCHAR(20);
DECLARE VARIABLE WK_PREV_QTY INTEGER;
DECLARE VARIABLE WK_DEFAULT_SSN_STATUS CHAR(2);
DECLARE VARIABLE WK_DEFAULT_PROD_STATUS CHAR(2);
DECLARE VARIABLE WK_NEW_STATUS CHAR(2);
DECLARE VARIABLE WK_DO_CREDIT CHAR(1);
DECLARE VARIABLE WK_CREDIT_QTY INTEGER;
DECLARE VARIABLE WK_DESPATCH_LOCATION VARCHAR(10);
DECLARE VARIABLE WK_FROM_LOCATION VARCHAR(10);
DECLARE VARIABLE WK_PI_PICK_ORDER VARCHAR(15);
DECLARE VARIABLE WK_PI_PICK_ORDER2 VARCHAR(15);
DECLARE VARIABLE WK_PI_SPLIT_LABEL VARCHAR(8);
DECLARE VARIABLE WK_PI_CREDIT_LABEL VARCHAR(8);
DECLARE VARIABLE WK_PI_LABEL VARCHAR(8);
DECLARE VARIABLE WK_SSN_QTY_ADJ INTEGER;
DECLARE VARIABLE WK_LABEL_TYPE CHAR(1);
DECLARE VARIABLE WK_LABEL_USE_EXTERNAL CHAR(1);
DECLARE VARIABLE WK_LABEL_FIELD_WRAPPER CHAR(1);
DECLARE VARIABLE WK_RESULT INTEGER;
DECLARE VARIABLE WK_BUFFER VARCHAR(40);
DECLARE VARIABLE WK_LABEL_PRINTER CHAR(2);
DECLARE VARIABLE WK_ERROR_TEXT VARCHAR(1024);
DECLARE VARIABLE WK_LABEL_DATA VARCHAR(32000);
DECLARE VARIABLE WK_LABEL_PART VARCHAR(32000);
DECLARE VARIABLE WK_WHERE VARCHAR(100);
DECLARE VARIABLE WK_DUMMY INTEGER;
DECLARE VARIABLE WK_LOG_FILENAME VARCHAR(80);
DECLARE VARIABLE WK_ISSN_RESPONSE VARCHAR(255);
DECLARE VARIABLE WK_PID_DESPATCH_ID INTEGER;
DECLARE VARIABLE WK_PID_DESPATCH_ID2 INTEGER;
DECLARE VARIABLE WK_PID_DETAIL_ID INTEGER;
DECLARE VARIABLE WK_PID_DETAIL_ID2 INTEGER;
DECLARE VARIABLE WK_PID_ORIGINAL_QTY_PICKED INTEGER;
DECLARE VARIABLE WK_PID_QTY_RECEIVED INTEGER;
DECLARE VARIABLE WK_PID_QTY_PICKED INTEGER;
DECLARE VARIABLE WK_FOUND INTEGER;
DECLARE VARIABLE WK_PI_SALE_PRICE DOUBLE PRECISION;
DECLARE VARIABLE WK_PI_DISCOUNT   DOUBLE PRECISION;
DECLARE VARIABLE WK_PI_LINE_TOTAL DOUBLE PRECISION;
DECLARE VARIABLE WK_PI_TAX_AMOUNT DOUBLE PRECISION;
DECLARE VARIABLE WK_PI_TAX_RATE   DOUBLE PRECISION;
DECLARE VARIABLE WK_PD_PACK_ID    INTEGER;
BEGIN
  WK_LOG_FILENAME = '/tmp/trbk.log';
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'TRBK') THEN
  BEGIN
     WK_ERROR_TEXT = '';
     WK_WH_ID = NEW.WH_ID;
     WK_LOCN_ID = NEW.LOCN_ID;
     WK_USER = NEW.PERSON_ID;
     WK_DEVICE = NEW.DEVICE_ID;
     WK_DATE = NEW.TRN_DATE;
     WK_RECORD = NEW.RECORD_ID;
     WK_OBJECT = NEW.OBJECT;
     WK_REFERENCE = NEW.REFERENCE;
     WK_QTY = NEW.QTY;
     WK_SUB_LOCN_ID = NEW.SUB_LOCN_ID;
     WK_ISSN_RESPONSE = NULL;
     WK_PI_CREDIT_LABEL = NULL;
     WK_PI_SPLIT_LABEL = NULL;
     WK_PI_LABEL = NULL;
     IF (NEW.TRN_CODE = 'A') THEN
     BEGIN
        WK_ISSN = WK_OBJECT;
        WK_PREV_QTY = 0;
        SELECT PREV_QTY
        FROM ISSN
        WHERE SSN_ID = :WK_ISSN
        INTO :WK_PREV_QTY ;
        IF (WK_PREV_QTY IS NULL OR WK_PREV_QTY = 0 ) THEN
        BEGIN
           WK_PREV_QTY = 1;
        END
        IF (WK_QTY IS NULL OR WK_QTY = 0) THEN
        BEGIN
           WK_QTY = WK_PREV_QTY;
        END
        IF (WK_QTY IS NULL OR WK_QTY = 0) THEN
        BEGIN
           WK_QTY = 1;
        END
        WK_ISSN_PICK_ORDER = '';
        WK_ISSN_PROD = '';
        WK_ISSN_WH_ID = '';
        WK_ISSN_LOCN_ID = '';
        WK_ISSN_CURRENT_QTY = 0;
        WK_ISSN_ORIGINAL_SSN = '';
        SELECT PICK_ORDER, PROD_ID, WH_ID, LOCN_ID, CURRENT_QTY, ORIGINAL_SSN
        FROM ISSN
        WHERE SSN_ID = :WK_ISSN
        INTO :WK_ISSN_PICK_ORDER, :WK_ISSN_PROD , WK_ISSN_WH_ID, :WK_ISSN_LOCN_ID, :WK_ISSN_CURRENT_QTY, :WK_ISSN_ORIGINAL_SSN;
        IF (WK_ISSN_WH_ID IS NULL) THEN
        BEGIN
           WK_ISSN_WH_ID = '';
        END
        IF (WK_ISSN_LOCN_ID IS NULL) THEN
        BEGIN
           WK_ISSN_LOCN_ID = '';
        END
        IF (WK_ISSN_CURRENT_QTY IS NULL) THEN
        BEGIN
           WK_ISSN_CURRENT_QTY = 0;
        END
        IF (WK_ISSN_ORIGINAL_SSN IS NULL) THEN
        BEGIN
           WK_ISSN_ORIGINAL_SSN = '';
        END
        WK_DO_CREDIT = 'F';
        SELECT NEW_SSN_STATUS, 
               NEW_PROD_STATUS, 
               RETURN_GENERATES_CREDIT, 
               GENERATE_LABEL_TEXT, 
               EXTERNAL_SCRIPT_4_LABEL,
               DEFAULT_RECEIVE_PRINTER,
               LABEL_FIELD_WRAPPER 
        FROM CONTROL
        INTO :WK_DEFAULT_SSN_STATUS, 
             :WK_DEFAULT_PROD_STATUS, 
             :WK_DO_CREDIT, 
             :WK_LABEL_TYPE, 
             :WK_LABEL_USE_EXTERNAL,
             :WK_LABEL_PRINTER,
             :WK_LABEL_FIELD_WRAPPER;
        IF (WK_DO_CREDIT IS NULL) THEN
        BEGIN
           WK_DO_CREDIT = 'F';
        END
        IF (WK_LABEL_TYPE IS NULL) THEN
        BEGIN
           WK_LABEL_TYPE = 'F';
        END
        IF (WK_LABEL_TYPE = '') THEN
        BEGIN
           WK_LABEL_TYPE = 'F';
        END
        IF (WK_LABEL_USE_EXTERNAL IS NULL) THEN
        BEGIN
           WK_LABEL_USE_EXTERNAL = 'F';
        END
        IF (WK_LABEL_USE_EXTERNAL = '') THEN
        BEGIN
           WK_LABEL_USE_EXTERNAL = 'F';
        END
        IF (WK_LABEL_FIELD_WRAPPER IS NULL) THEN
        BEGIN
           WK_LABEL_FIELD_WRAPPER = '%';
        END
        IF (WK_LABEL_PRINTER IS NULL) THEN
        BEGIN
           WK_LABEL_PRINTER = 'PA';
        END
        IF (WK_SUB_LOCN_ID IS NULL) THEN
        BEGIN
           WK_DUMMY = 1;
        END
        ELSE
        BEGIN
           IF (WK_SUB_LOCN_ID > '') THEN
           BEGIN
              WK_LABEL_PRINTER = SUBSTR(WK_SUB_LOCN_ID,1,2);
           END 
        END

        IF (WK_ISSN_PROD IS NOT NULL) THEN
        BEGIN
           WK_NEW_STATUS = :WK_DEFAULT_PROD_STATUS;
        END
        ELSE
        BEGIN
           WK_NEW_STATUS = :WK_DEFAULT_SSN_STATUS;
        END
        BEGIN
            /* must calculate the pick order to use */
            WK_PI_PICK_ORDER = '';
            WK_PID_DESPATCH_ID = NULL;
            WK_PID_DETAIL_ID = NULL;
            /* if the original order was for an ssn */
            SELECT PICK_ORDER 
            FROM PICK_ITEM
            WHERE  PICK_ITEM.PICK_LABEL_NO = :WK_ISSN_PICK_ORDER 
            INTO :WK_PI_PICK_ORDER;
            IF (WK_PI_PICK_ORDER IS NULL) THEN
            BEGIN
               WK_PI_PICK_ORDER = '';
            END
            /* if the original order was for a product */
            IF (WK_PI_PICK_ORDER = '' OR WK_PID_DESPATCH_ID IS NULL) THEN 
            BEGIN
               WK_PI_PICK_ORDER2 = '';
               WK_PID_DESPATCH_ID2 = NULL;
               WK_PID_DETAIL_ID2 = NULL;
               FOR SELECT P3.PICK_ORDER, P2.DESPATCH_ID, P2.PICK_DETAIL_ID 
               FROM PICK_ITEM_DETAIL P2
               LEFT OUTER JOIN  PICK_ITEM P3 ON P2.PICK_LABEL_NO = P3.PICK_LABEL_NO 
               WHERE  P2.SSN_ID = :WK_ISSN
               AND P2.PICK_DETAIL_STATUS IN ('DX','Dl','DL')
               ORDER BY P3.LAST_UPDATE_DATE DESC
               INTO :WK_PI_PICK_ORDER2, :WK_PID_DESPATCH_ID2, :WK_PID_DETAIL_ID2
               DO
               BEGIN
                  IF (WK_PI_PICK_ORDER2 IS NULL) THEN
                  BEGIN
                     WK_PI_PICK_ORDER2 = '';
                  END
                  IF (WK_PI_PICK_ORDER = '') THEN
                  BEGIN
                     IF (WK_PI_PICK_ORDER2 <> '') THEN 
                     BEGIN
                        WK_PI_PICK_ORDER = WK_PI_PICK_ORDER2;
                     END
                  END
                  IF (WK_PID_DESPATCH_ID IS NULL) THEN
                  BEGIN
                     IF (WK_PID_DESPATCH_ID2 IS NOT NULL) THEN 
                     BEGIN
                        WK_PID_DESPATCH_ID = WK_PID_DESPATCH_ID2;
                     END
                  END
                  IF (WK_PID_DETAIL_ID IS NULL) THEN
                  BEGIN
                     IF (WK_PID_DETAIL_ID2 IS NOT NULL) THEN 
                     BEGIN
                        WK_PID_DETAIL_ID = WK_PID_DETAIL_ID2;
                     END
                  END
               END
            END
            IF (WK_PI_PICK_ORDER = '' OR WK_PID_DESPATCH_ID IS NULL) THEN 
            BEGIN
               WK_PI_PICK_ORDER2 = '';
               WK_PID_DESPATCH_ID2 = NULL;
               WK_PID_DETAIL_ID2 = NULL;
               FOR SELECT P3.PICK_ORDER, P2.DESPATCH_ID, P2.PICK_DETAIL_ID 
               FROM PICK_ITEM_DETAIL P2
               LEFT OUTER JOIN  PICK_ITEM P3 ON P2.PICK_LABEL_NO = P3.PICK_LABEL_NO 
               WHERE  P2.SSN_ID = :WK_ISSN
               ORDER BY P3.LAST_UPDATE_DATE DESC
               INTO :WK_PI_PICK_ORDER2, :WK_PID_DESPATCH_ID2, :WK_PID_DETAIL_ID2
               DO
               BEGIN
                  IF (WK_PI_PICK_ORDER2 IS NULL) THEN
                  BEGIN
                     WK_PI_PICK_ORDER2 = '';
                  END
                  IF (WK_PI_PICK_ORDER = '') THEN
                  BEGIN
                     IF (WK_PI_PICK_ORDER2 <> '') THEN 
                     BEGIN
                        WK_PI_PICK_ORDER = WK_PI_PICK_ORDER2;
                     END
                  END
                  IF (WK_PID_DESPATCH_ID IS NULL) THEN
                  BEGIN
                     IF (WK_PID_DESPATCH_ID2 IS NOT NULL) THEN 
                     BEGIN
                        WK_PID_DESPATCH_ID = WK_PID_DESPATCH_ID2;
                     END
                  END
                  IF (WK_PID_DETAIL_ID IS  NULL) THEN
                  BEGIN
                     IF (WK_PID_DETAIL_ID2 IS NOT NULL) THEN 
                     BEGIN
                        WK_PID_DETAIL_ID = WK_PID_DETAIL_ID2;
                     END
                  END
               END
            END
        END
        SELECT PICK_LABEL_NO
        FROM PICK_ITEM_DETAIL
        WHERE PICK_DETAIL_ID = :WK_PID_DETAIL_ID
        INTO :WK_PI_LABEL;
        BEGIN
           /* check the qty is ok */
            WK_ERROR_TEXT = '';
            WK_PID_ORIGINAL_QTY_PICKED = 0;
            WK_PID_QTY_RECEIVED = 0;
            SELECT QTY_PICKED 
            FROM PICK_ITEM_DETAIL
            WHERE PICK_DETAIL_ID = :WK_PID_DETAIL_ID
            INTO :WK_PID_QTY_PICKED;
            IF (WK_PID_QTY_PICKED IS NULL) THEN
            BEGIN
               WK_PID_QTY_PICKED = 0;
            END
            IF (WK_QTY < 0) THEN
            BEGIN
               /* receiving a negative qty */
               WK_ERROR_TEXT = 'Cannot Return a negative number of Units';
            END
            ELSE
            BEGIN
               IF (WK_QTY = 0) THEN
               BEGIN
                  /* receiving nothing */
                  WK_ERROR_TEXT = 'Trying to Return Nothing';
               END
               ELSE
               BEGIN
                  IF (WK_QTY > WK_PID_QTY_PICKED) THEN
                  BEGIN
                     /* receiving more than original picked  (less returned on order) */
                     WK_ERROR_TEXT = 'Trying to Return more than the Qty Still Outstanding (' || :WK_PID_QTY_PICKED || ',' || :WK_PID_DETAIL_ID ||')';
                  END
               END
            END
            IF (WK_ERROR_TEXT <> '') THEN
            BEGIN
               WK_ERROR_TEXT = WK_ISSN || '|1|' || :WK_QTY || '|' || WK_ERROR_TEXT;
               EXECUTE PROCEDURE UPDATE_TRAN (:WK_RECORD, 'F',:WK_ERROR_TEXT);
               EXIT;
            END
        END

        IF (WK_QTY < WK_PREV_QTY) THEN
        BEGIN
           /* split the original issn */
           WK_SSN_QTY_ADJ = WK_PREV_QTY - WK_QTY ;
           EXECUTE PROCEDURE UPDATE_ISSN(:WK_ISSN, 'UISS', 'A', :WK_REFERENCE, :WK_DATE,:WK_USER, :WK_SSN_QTY_ADJ) RETURNING_VALUES :WK_ISSN_RESPONSE;
           /* add a pick item detail for the split issn */
            BEGIN
               WK_FROM_LOCATION = :WK_WH_ID || WK_LOCN_ID;
               WK_DESPATCH_LOCATION = :WK_ISSN_WH_ID || WK_ISSN_LOCN_ID;
               EXECUTE PROCEDURE ADD_PICK_SSN_DESPATCH_ITEMS(
                   :WK_PI_PICK_ORDER,
                   'DX',
                   :WK_ISSN_RESPONSE,
                   '',
                   :WK_SSN_QTY_ADJ,
                   :WK_DESPATCH_LOCATION,
                   :WK_FROM_LOCATION,
                   :WK_DATE,
                   :WK_USER,
                   :WK_PID_DESPATCH_ID,
                   :WK_DEVICE)
                  RETURNING_VALUES :WK_PI_SPLIT_LABEL;
            END
        END
        BEGIN
            /* now must adjust the original qty picked down to wk_qty */
            /* must save original qty picked */
            WK_PID_ORIGINAL_QTY_PICKED = 0;
            WK_PID_QTY_RECEIVED = 0;
            SELECT ORIGINAL_QTY_PICKED, QTY_RECEIVED
            FROM PICK_ITEM_DETAIL
            WHERE PICK_DETAIL_ID = :WK_PID_DETAIL_ID
            INTO :WK_PID_ORIGINAL_QTY_PICKED, :WK_PID_QTY_RECEIVED;
            IF (WK_PID_ORIGINAL_QTY_PICKED IS NULL) THEN
            BEGIN
               IF (WK_PID_QTY_RECEIVED IS NULL) THEN
               BEGIN
                  UPDATE PICK_ITEM_DETAIL
                  SET ORIGINAL_QTY_PICKED = QTY_PICKED,
                      QTY_RECEIVED = :WK_QTY,
                      QTY_PICKED = 0
                  WHERE PICK_DETAIL_ID = :WK_PID_DETAIL_ID;
               END
               ELSE
               BEGIN
                  UPDATE PICK_ITEM_DETAIL
                  SET ORIGINAL_QTY_PICKED = QTY_PICKED,
                      QTY_RECEIVED = QTY_RECEIVED + :WK_QTY,
                      QTY_PICKED = 0
                  WHERE PICK_DETAIL_ID = :WK_PID_DETAIL_ID;
               END
            END
            ELSE
            BEGIN
               IF (WK_PID_QTY_RECEIVED IS NULL) THEN
               BEGIN
                  UPDATE PICK_ITEM_DETAIL
                  SET QTY_PICKED = 0,
                      QTY_RECEIVED = :WK_QTY
                  WHERE PICK_DETAIL_ID = :WK_PID_DETAIL_ID;
               END
               ELSE
               BEGIN
                  UPDATE PICK_ITEM_DETAIL
                  SET QTY_PICKED = 0,
                      QTY_RECEIVED = QTY_RECEIVED +  :WK_QTY
                  WHERE PICK_DETAIL_ID = :WK_PID_DETAIL_ID;
               END
            END
        END
        /* update the issn */
        UPDATE ISSN
        SET CURRENT_QTY = :WK_QTY,
            PREV_QTY = :WK_PREV_QTY,
            ISSN_STATUS = :WK_NEW_STATUS,
            PREV_PREV_PICK_ORDER = PREV_PICK_ORDER,
            PREV_PICK_ORDER = PICK_ORDER,
            PICK_ORDER = NULL,
            PREV_PREV_PACK_ID = PREV_PACK_ID,
            PREV_PACK_ID = PACK_ID,
            PACK_ID = NULL,
            PREV_PREV_DESPATCH_ID = PREV_DESPATCH_ID,
            PREV_DESPATCH_ID = DESPATCH_ID,
            DESPATCH_ID = NULL,
            WH_ID = :WK_WH_ID,
            LOCN_ID = :WK_LOCN_ID,
            INTO_DATE = :WK_DATE
           WHERE SSN_ID = :WK_ISSN;
        IF (WK_ISSN_PICK_ORDER IS NOT NULL) THEN
        BEGIN
           UPDATE PICK_ITEM SET PICK_LINE_STATUS = 'CL' 
            WHERE PICK_ITEM.SSN_ID = :WK_ISSN
            AND   PICK_ITEM.PICK_LABEL_NO = :WK_ISSN_PICK_ORDER ;
        END
        /* what about the added pick item and pick item detail for the credit of this */
        IF (WK_DO_CREDIT = 'T') THEN
        BEGIN
            /* must calculate the pick order to use */
            WK_PI_PICK_ORDER = '';
            WK_PID_DESPATCH_ID = NULL;
            /* if the original order was for an ssn */
            SELECT PICK_ORDER 
            FROM PICK_ITEM
            WHERE  PICK_ITEM.PICK_LABEL_NO = :WK_ISSN_PICK_ORDER 
            INTO :WK_PI_PICK_ORDER;
            IF (WK_PI_PICK_ORDER IS NULL) THEN
            BEGIN
               WK_PI_PICK_ORDER = '';
            END
            /* if the original order was for a product */
            IF (WK_PI_PICK_ORDER = '' OR WK_PID_DESPATCH_ID IS NULL) THEN 
            BEGIN
               WK_PI_PICK_ORDER2 = '';
               WK_PID_DESPATCH_ID2 = NULL;
               FOR SELECT P3.PICK_ORDER, P2.DESPATCH_ID 
               FROM PICK_ITEM_DETAIL P2
               LEFT OUTER JOIN  PICK_ITEM P3 ON P2.PICK_LABEL_NO = P3.PICK_LABEL_NO 
               WHERE  P2.SSN_ID = :WK_ISSN
               AND P2.PICK_DETAIL_STATUS IN ('DX','Dl','DL')
               ORDER BY P3.LAST_UPDATE_DATE DESC
               INTO :WK_PI_PICK_ORDER2, :WK_PID_DESPATCH_ID2
               DO
               BEGIN
                  IF (WK_PI_PICK_ORDER2 IS NULL) THEN
                  BEGIN
                     WK_PI_PICK_ORDER2 = '';
                  END
                  IF (WK_PI_PICK_ORDER = '') THEN
                  BEGIN
                     IF (WK_PI_PICK_ORDER2 <> '') THEN 
                     BEGIN
                        WK_PI_PICK_ORDER = WK_PI_PICK_ORDER2;
                     END
                  END
                  IF (WK_PID_DESPATCH_ID IS NULL) THEN
                  BEGIN
                     IF (WK_PID_DESPATCH_ID2 IS NOT NULL) THEN 
                     BEGIN
                        WK_PID_DESPATCH_ID = WK_PID_DESPATCH_ID2;
                     END
                  END
               END
            END
            IF (WK_PI_PICK_ORDER = '' OR WK_PID_DESPATCH_ID IS NULL) THEN 
            BEGIN
               WK_PI_PICK_ORDER2 = '';
               WK_PID_DESPATCH_ID2 = NULL;
               FOR SELECT P3.PICK_ORDER, P2.DESPATCH_ID 
               FROM PICK_ITEM_DETAIL P2
               LEFT OUTER JOIN  PICK_ITEM P3 ON P2.PICK_LABEL_NO = P3.PICK_LABEL_NO 
               WHERE  P2.SSN_ID = :WK_ISSN
               ORDER BY P3.LAST_UPDATE_DATE DESC
               INTO :WK_PI_PICK_ORDER2, :WK_PID_DESPATCH_ID2
               DO
               BEGIN
                  IF (WK_PI_PICK_ORDER2 IS NULL) THEN
                  BEGIN
                     WK_PI_PICK_ORDER2 = '';
                  END
                  IF (WK_PI_PICK_ORDER = '') THEN
                  BEGIN
                     IF (WK_PI_PICK_ORDER2 <> '') THEN 
                     BEGIN
                        WK_PI_PICK_ORDER = WK_PI_PICK_ORDER2;
                     END
                  END
                  IF (WK_PID_DESPATCH_ID IS NULL) THEN
                  BEGIN
                     IF (WK_PID_DESPATCH_ID2 IS NOT NULL) THEN 
                     BEGIN
                        WK_PID_DESPATCH_ID = WK_PID_DESPATCH_ID2;
                     END
                  END
               END
            END
            WK_CREDIT_QTY = 0 - WK_QTY;
            WK_DESPATCH_LOCATION = :WK_WH_ID || WK_LOCN_ID;
            WK_FROM_LOCATION = :WK_ISSN_WH_ID || WK_ISSN_LOCN_ID;
            IF (WK_PI_PICK_ORDER <> '') THEN
            BEGIN
               EXECUTE PROCEDURE ADD_PICK_SSN_DESPATCH_ITEMS(
                   :WK_PI_PICK_ORDER,
                   'CR',
                   :WK_ISSN,
                   '',
                   :WK_CREDIT_QTY,
                   :WK_DESPATCH_LOCATION,
                   :WK_DESPATCH_LOCATION,
                   :WK_DATE,
                   :WK_USER,
                   :WK_PID_DESPATCH_ID,
                   :WK_DEVICE)
                  RETURNING_VALUES :WK_PI_CREDIT_LABEL;
            END
        END
        WK_SSN_QTY_ADJ = WK_QTY - WK_ISSN_CURRENT_QTY;
        UPDATE SSN
        SET CURRENT_QTY = CURRENT_QTY + :WK_SSN_QTY_ADJ
        WHERE SSN_ID = :WK_ISSN_ORIGINAL_SSN;
        IF (WK_PI_LABEL IS NOT NULL) THEN
        BEGIN
           WK_PI_SALE_PRICE = NULL;
           WK_PI_DISCOUNT   = NULL;
           WK_PI_LINE_TOTAL = NULL;
           WK_PI_TAX_AMOUNT = NULL;
           WK_PI_TAX_RATE   = NULL;
           WK_PD_PACK_ID    = NULL;
           SELECT SALE_PRICE,
                  DISCOUNT,
                  LINE_TOTAL,
                  TAX_AMOUNT,
                  TAX_RATE
           FROM PICK_ITEM
           WHERE PICK_LABEL_NO = :WK_PI_LABEL
           INTO   :WK_PI_SALE_PRICE,
                  :WK_PI_DISCOUNT,
                  :WK_PI_LINE_TOTAL,
                  :WK_PI_TAX_AMOUNT,
                  :WK_PI_TAX_RATE;
           SELECT  FIRST 1 PACK_ID 
           FROM PACK_ID
           WHERE DESPATCH_ID = :WK_PID_DESPATCH_ID
           AND SSN_ID = :WK_ISSN
           INTO :WK_PD_PACK_ID;
           UPDATE PICK_ITEM
           SET PICKED_QTY = PICKED_QTY - :WK_QTY
           WHERE PICK_LABEL_NO = :WK_PI_LABEL;
           IF (WK_PI_CREDIT_LABEL IS NOT NULL) THEN
           BEGIN
              UPDATE PICK_ITEM
              SET REASON = :WK_REFERENCE,
                  SALE_PRICE = :WK_PI_SALE_PRICE,
                  DISCOUNT   = :WK_PI_DISCOUNT,
                  LINE_TOTAL = :WK_PI_LINE_TOTAL,
                  TAX_AMOUNT = :WK_PI_TAX_AMOUNT,
                  TAX_RATE   = :WK_PI_TAX_RATE,
                  DESPATCH_PALLET_NO = :WK_PD_PACK_ID, 
                  WH_ID = :WK_WH_ID 
              WHERE PICK_LABEL_NO = :WK_PI_CREDIT_LABEL;
           END
           IF (WK_PI_SPLIT_LABEL IS NOT NULL) THEN
           BEGIN
              UPDATE PICK_ITEM
              SET REASON = :WK_REFERENCE,
                  SALE_PRICE = :WK_PI_SALE_PRICE,
                  DISCOUNT   = :WK_PI_DISCOUNT,
                  LINE_TOTAL = :WK_PI_LINE_TOTAL,
                  TAX_AMOUNT = :WK_PI_TAX_AMOUNT,
                  TAX_RATE   = :WK_PI_TAX_RATE,
                  DESPATCH_PALLET_NO = :WK_PD_PACK_ID, 
                  WH_ID = :WK_WH_ID 
              WHERE PICK_LABEL_NO = :WK_PI_SPLIT_LABEL;
           END

        END
        /* now must print a label */
        WK_RESULT = 0;
        IF (WK_LABEL_USE_EXTERNAL = 'F') THEN
        BEGIN
           IF (WK_LABEL_TYPE = 'F') THEN
           BEGIN
              /* use pc_label for label creation */
              WK_RESULT = 0;
              WK_LABEL_DATA = '';
              WK_LABEL_PART = '';
              WK_WHERE = " WHERE SSN_ID='" || WK_ISSN || "'";
              EXECUTE PROCEDURE GET_TABLE_DATA ('ISSN', WK_LABEL_FIELD_WRAPPER, '|', :WK_WHERE)
              RETURNING_VALUES :WK_LABEL_PART;
              IF (WK_LABEL_PART IS NULL) THEN
              BEGIN
                 WK_LABEL_PART = '';
              END
              WK_LABEL_DATA = WK_LABEL_DATA || :WK_LABEL_PART;
              WK_WHERE = " WHERE SSN_ID='" || WK_ISSN_ORIGINAL_SSN || "'";
              EXECUTE PROCEDURE GET_TABLE_DATA ('SSN', WK_LABEL_FIELD_WRAPPER, '|', :WK_WHERE)
              RETURNING_VALUES :WK_LABEL_PART;
              IF (WK_LABEL_PART IS NULL) THEN
              BEGIN
                 WK_LABEL_PART = '';
              END
              WK_LABEL_DATA = WK_LABEL_DATA || :WK_LABEL_PART;
              WK_WHERE = " WHERE PROD_ID='" || WK_ISSN_PROD  || "'";
              EXECUTE PROCEDURE GET_TABLE_DATA ('PROD_PROFILE', WK_LABEL_FIELD_WRAPPER, '|', :WK_WHERE)
              RETURNING_VALUES :WK_LABEL_PART;
              IF (WK_LABEL_PART IS NULL) THEN
              BEGIN
                 WK_LABEL_PART = '';
              END
              WK_LABEL_DATA = WK_LABEL_DATA || :WK_LABEL_PART;

              EXECUTE  PROCEDURE PC_LABEL (:WK_LABEL_PRINTER ,
                       'ISSN' , 
                       1 ,
                       NULL ,
                       :WK_LABEL_DATA ,
                       :WK_USER )
              RETURNING_VALUES :WK_RESULT ,
                                :WK_ERROR_TEXT ;
           END
           ELSE
           BEGIN
              /* use bartender for printing */
              IF (WK_ISSN_PROD IS NOT NULL) THEN
              BEGIN
                 /* use pc_label_product for label creation */
                 WK_BUFFER = WK_LABEL_PRINTER  || WK_ISSN;
                 EXECUTE PROCEDURE PC_LABEL_PRODUCT WK_BUFFER RETURNING_VALUES :WK_RESULT;
              END
              ELSE
              BEGIN
                 /* use pc_label_issn for label creation */
                 WK_BUFFER = WK_LABEL_PRINTER  || WK_ISSN;
                 EXECUTE PROCEDURE PC_LABEL_ISSN WK_BUFFER RETURNING_VALUES :WK_RESULT;
              END
           END
        END
        ELSE
        BEGIN
           IF (WK_LABEL_TYPE = 'F') THEN
           BEGIN
              /* use error text to pass back data for label creation */
           END
           ELSE
           BEGIN
              /* use bartender for printing */
           END
        END
        EXECUTE PROCEDURE ADD_SSN_HIST (:WK_WH_ID ,
           :WK_LOCN_ID ,
           :WK_ISSN ,
           NEW.TRN_TYPE ,
           NEW.TRN_CODE ,
           :WK_DATE ,
           ' Received Back into Warehouse' ,
           :WK_REFERENCE ,
           :WK_QTY ,
           :WK_USER ,
           :WK_DEVICE );
        IF (WK_ERROR_TEXT = '') THEN
        BEGIN
           WK_ERROR_TEXT = 'Processed successfully';
        END
        IF (WK_RESULT <> 0) THEN
        BEGIN
           WK_ERROR_TEXT = WK_ERROR_TEXT || ' result :' || :WK_RESULT;
        END
        ELSE
        BEGIN
           WK_ERROR_TEXT = 'Processed successfully';
        END
        WK_ERROR_TEXT = WK_ISSN || '|1|' || :WK_QTY || '|' || WK_ERROR_TEXT;
        IF (WK_RESULT = 0) THEN
        BEGIN
           EXECUTE PROCEDURE UPDATE_TRAN (:WK_RECORD, 'T',:WK_ERROR_TEXT);
        END
        ELSE
        BEGIN
           EXECUTE PROCEDURE UPDATE_TRAN (:WK_RECORD, 'F',:WK_ERROR_TEXT);
        END
     END
     /*
   EXECUTE PROCEDURE TRAN_ARCHIVE;
   */
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_NICI FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 150 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'NICI') THEN
  BEGIN
   EXECUTE PROCEDURE PC_NIXX 
    NEW.RECORD_ID ,
    NEW.WH_ID,
    NEW.LOCN_ID,
    NEW.OBJECT,
    NEW.TRN_TYPE,
    NEW.TRN_CODE,
    NEW.TRN_DATE,
    NEW.REFERENCE,
    NEW.QTY,
    NEW.PERSON_ID,
    NEW.DEVICE_ID,
    NEW.INSTANCE_ID;
   /* EXECUTE PROCEDURE TRAN_ARCHIVE; */
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_NLBI FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 151 
AS
/* Add/ Update a borrowers location */
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_DEVICE CHAR(2);
DECLARE VARIABLE WK_WH_ID CHAR(2);
DECLARE VARIABLE WK_LOCN_ID VARCHAR(10);
DECLARE VARIABLE WK_USER VARCHAR(10);
DECLARE VARIABLE WK_RECORD INTEGER;
DECLARE VARIABLE WK_DATE TIMESTAMP;
DECLARE VARIABLE WK_OBJECT VARCHAR(30);
DECLARE VARIABLE WK_REFERENCE VARCHAR(40);
DECLARE VARIABLE WK_QTY INTEGER;
DECLARE VARIABLE WK_SUB_LOCN_ID VARCHAR(10);
DECLARE VARIABLE WK_FOUND INTEGER;
DECLARE VARIABLE WK_LOCN_STATUS CHAR(2);
DECLARE VARIABLE WK_LOCN_LABEL_DATE TIMESTAMP;
DECLARE VARIABLE WK_LOCN_OLD_DATE TIMESTAMP;
DECLARE VARIABLE WK_IN_LABEL_DATE VARCHAR(30);
DECLARE VARIABLE WK_ERROR_TEXT VARCHAR(1024);
DECLARE VARIABLE WK_RESULT INTEGER ;
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'NLBI') THEN
  BEGIN
     WK_ERROR_TEXT = '';
     WK_WH_ID = NEW.WH_ID;
     WK_LOCN_ID = NEW.LOCN_ID;
     WK_USER = NEW.PERSON_ID;
     WK_DEVICE = NEW.DEVICE_ID;
     WK_DATE = NEW.TRN_DATE;
     WK_RECORD = NEW.RECORD_ID;
     WK_OBJECT = NEW.OBJECT;
     WK_REFERENCE = NEW.REFERENCE;
     WK_QTY = NEW.QTY;
     WK_SUB_LOCN_ID = NEW.SUB_LOCN_ID;
     WK_RESULT = 0;
     IF (NEW.TRN_CODE = 'B') THEN
     BEGIN
        WK_LOCN_STATUS = 'XX';
        IF (WK_QTY IS NULL ) THEN
        BEGIN
           WK_QTY = 0;
        END
        IF (WK_QTY = 0) THEN
        BEGIN
           WK_LOCN_STATUS = 'CL';
        END
        IF (WK_QTY = 1) THEN
        BEGIN
           WK_LOCN_STATUS = 'OK';
        END
        /* get the label date */
        WK_IN_LABEL_DATE = '';
        WK_LOCN_LABEL_DATE = NULL;
        EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_OBJECT, 2  RETURNING_VALUES :WK_IN_LABEL_DATE ; 
        IF (LEN(WK_IN_LABEL_DATE) > 0) THEN
        BEGIN
           WK_LOCN_LABEL_DATE = CAST(WK_IN_LABEL_DATE AS TIMESTAMP);
           WHEN SQLCODE -413
           DO
           BEGIN
              /* No Ship date */
              WK_LOCN_LABEL_DATE = NULL;
           END
        END
        WK_FOUND = 0;
        SELECT 1, LABEL_DATE
        FROM LOCATION
        WHERE WH_ID = :WK_WH_ID
        AND   LOCN_ID = :WK_LOCN_ID
        INTO :WK_FOUND, :WK_LOCN_OLD_DATE;
        IF (WK_FOUND IS NULL) THEN
        BEGIN
           WK_FOUND = 0;
        END
        IF (WK_FOUND = 0) THEN
        BEGIN
           /* no location so add it */
           INSERT INTO LOCATION (
               LOCN_NAME , 
               LOCN_OWNER , 
               LOCN_STAT , 
               LABEL_DATE , 
               WH_ID , 
               LOCN_ID ) 
           VALUES (
               :WK_REFERENCE,
               :WK_SUB_LOCN_ID,
               :WK_LOCN_STATUS,
               :WK_LOCN_LABEL_DATE,
               :WK_WH_ID ,
               :WK_LOCN_ID);
        END
        ELSE
        BEGIN
           IF (WK_LOCN_LABEL_DATE IS NULL) THEN
           BEGIN
              WK_LOCN_LABEL_DATE = WK_LOCN_OLD_DATE;
           END
           /* location found so update it */
           UPDATE LOCATION
           SET LOCN_NAME = :WK_REFERENCE,
               LOCN_OWNER = :WK_SUB_LOCN_ID,
               LOCN_STAT = :WK_LOCN_STATUS,
               LABEL_DATE = :WK_LOCN_LABEL_DATE
              WHERE WH_ID = :WK_WH_ID 
              AND   LOCN_ID = :WK_LOCN_ID;
        END
        IF (WK_ERROR_TEXT = '') THEN
        BEGIN
           WK_ERROR_TEXT = 'Processed successfully';
        END
        IF (WK_RESULT <> 0) THEN
        BEGIN
           WK_ERROR_TEXT = WK_ERROR_TEXT || ' result :' || :WK_RESULT;
        END
        ELSE
        BEGIN
           WK_ERROR_TEXT = 'Processed successfully';
        END
        IF (WK_RESULT = 0) THEN
        BEGIN
           EXECUTE PROCEDURE UPDATE_TRAN (:WK_RECORD, 'T',:WK_ERROR_TEXT);
        END
        ELSE
        BEGIN
           EXECUTE PROCEDURE UPDATE_TRAN (:WK_RECORD, 'F',:WK_ERROR_TEXT);
        END
     END
     /*
   EXECUTE PROCEDURE TRAN_ARCHIVE;
   */
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_GRCI FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 152 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
BEGIN
   WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
   IF (WK_AUTORUN = 1) THEN
   BEGIN
      IF (NEW.TRN_TYPE = 'GRCI') THEN
      BEGIN
         IF ((NEW.TRN_CODE = 'G') OR 
             (NEW.TRN_CODE = 'P')) THEN
         BEGIN 
            EXECUTE PROCEDURE ADD_SSN_ISSN_GRCI     
            NEW.WH_ID,
            NEW.LOCN_ID,
            NEW.OBJECT,
            NEW.TRN_DATE,
            NEW.QTY,
            NEW.SUB_LOCN_ID,    
            NEW.REFERENCE,    
            NEW.INPUT_SOURCE,    
            NEW.RECORD_ID;    
         END
         /* EXECUTE PROCEDURE TRAN_ARCHIVE; */
      END
   END
END ^

CREATE TRIGGER RUN_TRANSACTION_POAL FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 152 
AS
/* Transfer of mobile location to an order  */
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_DEVICE CHAR(2);
DECLARE VARIABLE WK_USER VARCHAR(10);
DECLARE VARIABLE WK_RECORD INTEGER;
DECLARE VARIABLE WK_DATE TIMESTAMP;
DECLARE VARIABLE WK_ORDER VARCHAR(30);
DECLARE VARIABLE WK_WH_ID CHAR(2);
DECLARE VARIABLE WK_LOCN_ID VARCHAR(10);
DECLARE VARIABLE WK_REFERENCE VARCHAR(255);

DECLARE VARIABLE WK_ALLOCATE_DEVICE VARCHAR(40);
DECLARE VARIABLE WK_PICK_USER VARCHAR(40);
DECLARE VARIABLE WK_LOCN_GROUP VARCHAR(10);
DECLARE VARIABLE WK_LOCN_MOVEABLE CHAR(1);
DECLARE VARIABLE WK_CURRENT_WH_ID CHAR(2);
DECLARE VARIABLE WK_CURRENT_PARENT VARCHAR(10);
DECLARE VARIABLE WK_TROLLEY_WH_ID CHAR(2);
DECLARE VARIABLE WK_TROLLEY_LOCN_ID VARCHAR(10);
DECLARE VARIABLE WK_ERROR_TEXT VARCHAR(255);
DECLARE VARIABLE WK_FOUND INTEGER;
DECLARE VARIABLE WK_PL_PICK_ORDER  VARCHAR(15);
DECLARE VARIABLE WK_PL_DEVICE_ID   VARCHAR(2);
DECLARE VARIABLE WK_PL_RECORD_ID   INTEGER ;

BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'POAL') THEN
  BEGIN
     IF (NEW.TRN_CODE = 'O') THEN
     BEGIN
   /*
   transfer mobile location to location of the trolley
   update the order to have that despatch_locn_group (trolley)
   add/update pick_location    for that order to have the location
   */
        WK_WH_ID = NEW.WH_ID;
        WK_LOCN_ID = NEW.LOCN_ID;
        WK_USER = NEW.PERSON_ID;
        WK_DEVICE = NEW.DEVICE_ID;
        WK_DATE = NEW.TRN_DATE;
        WK_RECORD = NEW.RECORD_ID;
        WK_LOCN_GROUP = NEW.SUB_LOCN_ID;
        WK_ORDER = NEW.OBJECT;
        WK_REFERENCE = NEW.REFERENCE;
        WK_ERROR_TEXT = '';
   
        EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_REFERENCE, 1  RETURNING_VALUES :WK_PICK_USER ; 
        EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_REFERENCE, 2  RETURNING_VALUES :WK_ALLOCATE_DEVICE ; 
        IF (WK_PICK_USER = '') THEN
        BEGIN
           WK_PICK_USER = WK_USER;
        END
        IF (WK_ALLOCATE_DEVICE = '') THEN
        BEGIN
           WK_ALLOCATE_DEVICE = WK_DEVICE;
        END
        WK_CURRENT_WH_ID = NULL;
        WK_CURRENT_PARENT = NULL;
        WK_LOCN_MOVEABLE = NULL; 
        WK_TROLLEY_WH_ID = NULL;
        WK_TROLLEY_LOCN_ID = NULL;
        /* get mobile  location */
        SELECT CURRENT_WH_ID, PARENT_LOCN_ID, MOVEABLE_LOCN
        FROM LOCATION
        WHERE WH_ID = :WK_WH_ID
        AND   LOCN_ID = :WK_LOCN_ID
        INTO :WK_CURRENT_WH_ID, :WK_CURRENT_PARENT, :WK_LOCN_MOVEABLE;
        IF (WK_LOCN_MOVEABLE = 'T' ) THEN
        BEGIN
           WK_FOUND = 2;
        END
        ELSE
        BEGIN
           /* not a mobile location */
           /* WK_ERROR_TEXT = WK_ERROR_TEXT || ' Location is Not a Moveable Location'; */
           WK_ERROR_TEXT = WK_ERROR_TEXT || ' Location ' || WK_WH_ID || ' ' || WK_LOCN_ID || ' is Not a Moveable Location';
        END
        /* get trolleys fixed location */
        SELECT LOCN_ID 
        FROM SYS_EQUIP
        WHERE DEVICE_ID = :WK_LOCN_GROUP
        INTO :WK_TROLLEY_LOCN_ID;
        IF (WK_TROLLEY_LOCN_ID IS NULL) THEN
        BEGIN
           SELECT DEFAULT_EQUIP_LOCN_ID
           FROM CONTROL
           INTO :WK_TROLLEY_LOCN_ID;
        END
        /* now get the wh_id for the trolley location */
        SELECT FIRST 1 WH_ID 
        FROM LOCATION
        WHERE LOCN_ID = :WK_TROLLEY_LOCN_ID
        INTO :WK_TROLLEY_WH_ID ;
        IF (WK_TROLLEY_WH_ID IS NULL) THEN
        BEGIN
           /* not a trolley location */
           WK_ERROR_TEXT = WK_ERROR_TEXT || ' Trolley has No Fixed WH_ID';
        END
        IF (WK_TROLLEY_LOCN_ID IS NULL) THEN
        BEGIN
           /* not a trolley location */
           WK_ERROR_TEXT = WK_ERROR_TEXT || ' Trolley has No Fixed LOCN_ID';
        END
        BEGIN
           WK_FOUND = 0;
           WK_PL_PICK_ORDER = NULL;
           WK_PL_DEVICE_ID = NULL;
           SELECT FIRST 1 1, PICK_ORDER, DEVICE_ID
           FROM PICK_LOCATION
           WHERE  WH_ID = :WK_WH_ID
           AND LOCN_ID = :WK_LOCN_ID
           AND PICK_LOCATION_STATUS IN ( 'OP', 'DS')
           INTO :WK_FOUND, :WK_PL_PICK_ORDER, :WK_PL_DEVICE_ID;
           IF (WK_FOUND IS NULL) THEN
           BEGIN
              WK_FOUND = 0;
           END
           IF (WK_FOUND = 1) THEN
           BEGIN
              /* location already in use */
              IF (WK_PL_PICK_ORDER IS NULL) THEN
              BEGIN
                 WK_PL_PICK_ORDER = '';
              END
              IF (WK_PL_DEVICE_ID  IS NULL) THEN
              BEGIN
                 WK_PL_DEVICE_ID  = '';
              END
              IF (WK_PL_DEVICE_ID = :WK_WH_ID ) THEN
              BEGIN
                 /* on this device */
              END
              ELSE
              BEGIN
                 /*
                 WK_ERROR_TEXT = WK_ERROR_TEXT || ' Location ' || WK_WH_ID || ' ' || WK_LOCN_ID || ':' || WK_ORDER || ' Already in use by ' || WK_PL_PICK_ORDER || ':' || WK_PL_DEVICE_ID ;
                 */
                 /* change this to check whether any issns in the location. if not then its free */
/*
                 WK_FOUND = 0;
                 SELECT FIRST 1 1 
                 FROM ISSN 
                 WHERE  WH_ID = :WK_WH_ID
                 AND LOCN_ID = :WK_LOCN_ID
                 INTO :WK_FOUND ;
                 IF (WK_FOUND IS NULL) THEN
                 BEGIN
                    WK_FOUND = 0;
                 END
                 IF (WK_FOUND = 1) THEN
                 BEGIN
                    WK_ERROR_TEXT = WK_ERROR_TEXT || ' Location ' || WK_WH_ID || ' ' || WK_LOCN_ID || ':' || WK_ORDER || ' Already in use by ' || WK_PL_PICK_ORDER || ':' || WK_PL_DEVICE_ID ;
                 END
                 ELSE
*/
                 BEGIN
                    UPDATE  PICK_LOCATION
                    SET PICK_LOCATION_STATUS = 'XX',
                    LAST_UPDATED_BY = :WK_PICK_USER
                    WHERE WH_ID = :WK_WH_ID
                    AND LOCN_ID = :WK_LOCN_ID 
                    AND PICK_LOCATION_STATUS IN ( 'OP' ,'DS')
                    AND PICK_ORDER = :WK_ORDER;
                 END
              END
           END
        END
        IF (WK_ERROR_TEXT = '') THEN
        BEGIN
           /* move the mobile location */
           UPDATE LOCATION
           SET CURRENT_WH_ID = :WK_TROLLEY_WH_ID, PARENT_LOCN_ID = :WK_TROLLEY_LOCN_ID
           WHERE WH_ID = :WK_WH_ID
           AND   LOCN_ID = :WK_LOCN_ID;
           /* update the orders locn group */
           UPDATE PICK_ITEM
           SET DESPATCH_LOCATION_GROUP = :WK_LOCN_GROUP
           WHERE PICK_ORDER = :WK_ORDER
           AND   DEVICE_ID = :WK_ALLOCATE_DEVICE;
           UPDATE PICK_ORDER
           SET DESPATCH_LOCATION_GROUP = :WK_LOCN_GROUP
           WHERE PICK_ORDER = :WK_ORDER;
           WK_FOUND = 0;
           SELECT FIRST 1 1, RECORD_ID
           FROM PICK_LOCATION
           WHERE WH_ID = :WK_WH_ID
           AND LOCN_ID = :WK_LOCN_ID
           AND PICK_LOCATION_STATUS In ( 'OP','DS')
           INTO :WK_FOUND, :WK_PL_RECORD_ID;
           IF (WK_FOUND IS NULL) THEN
           BEGIN
              WK_FOUND = 0;
           END
           IF (WK_FOUND = 0) THEN
           BEGIN
              INSERT INTO PICK_LOCATION (
                  PICK_ORDER,            
                  WH_ID,                
                  LOCN_ID,             
                  PICK_LOCATION_STATUS,
                  CREATED_DATE,        
                  CREATED_BY,          
                  LAST_UPDATE_DATE,    
                  LAST_UPDATED_BY,
                  DEVICE_ID)     
              VALUES (
                  :WK_ORDER,
                  :WK_WH_ID,
                  :WK_LOCN_ID,
                  'OP',
                  :WK_DATE,
                  :WK_PICK_USER,
                  :WK_DATE,
                  :WK_PICK_USER, 
                  :WK_ALLOCATE_DEVICE);
           END
           ELSE
           BEGIN
              UPDATE  PICK_LOCATION
              SET 
              LAST_UPDATED_BY = :WK_PICK_USER,
              DEVICE_ID =  :WK_ALLOCATE_DEVICE,
              PICK_ORDER = :WK_ORDER,
              PICK_LOCATION_STATUS = 'OP'
              WHERE RECORD_ID = :WK_PL_RECORD_ID;
           END
           EXECUTE PROCEDURE UPDATE_TRAN (WK_RECORD, 'T','Processed successfully');
        END
        ELSE
        BEGIN
           EXECUTE PROCEDURE UPDATE_TRAN (WK_RECORD, 'F',:WK_ERROR_TEXT);
        END
        /*
        EXECUTE PROCEDURE TRAN_ARCHIVE;
      */
     END /* code O */
     IF (NEW.TRN_CODE = 'U') THEN
     BEGIN
   /*
   remove pick location for the  order and  location passed 
   update pick_location    for that order to not have the location any more
   */
        WK_WH_ID = NEW.WH_ID;
        WK_LOCN_ID = NEW.LOCN_ID;
        WK_USER = NEW.PERSON_ID;
        WK_DEVICE = NEW.DEVICE_ID;
        WK_DATE = NEW.TRN_DATE;
        WK_RECORD = NEW.RECORD_ID;
        WK_LOCN_GROUP = NEW.SUB_LOCN_ID;
        WK_ORDER = NEW.OBJECT;
        WK_REFERENCE = NEW.REFERENCE;
        WK_ERROR_TEXT = '';
   
        EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_REFERENCE, 1  RETURNING_VALUES :WK_PICK_USER ; 
        EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_REFERENCE, 2  RETURNING_VALUES :WK_ALLOCATE_DEVICE ; 
        IF (WK_PICK_USER = '') THEN
        BEGIN
           WK_PICK_USER = WK_USER;
        END
        IF (WK_ALLOCATE_DEVICE = '') THEN
        BEGIN
           WK_ALLOCATE_DEVICE = WK_DEVICE;
        END
        IF (WK_ERROR_TEXT = '') THEN
        BEGIN
              UPDATE  PICK_LOCATION
              SET PICK_LOCATION_STATUS = 'CN',
              LAST_UPDATED_BY = :WK_PICK_USER
              WHERE WH_ID = :WK_WH_ID
              AND LOCN_ID = :WK_LOCN_ID 
              AND PICK_LOCATION_STATUS = 'OP' 
              AND DEVICE_ID =  :WK_ALLOCATE_DEVICE
              AND PICK_ORDER = :WK_ORDER;
           EXECUTE PROCEDURE UPDATE_TRAN (WK_RECORD, 'T','Processed successfully');
        END
        ELSE
        BEGIN
           EXECUTE PROCEDURE UPDATE_TRAN (WK_RECORD, 'F',:WK_ERROR_TEXT);
        END
        /*
        EXECUTE PROCEDURE TRAN_ARCHIVE;
      */
     END /* code O */
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_PINV FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 153 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_RECORD  INTEGER;
DECLARE VARIABLE WK_INVOICE_NO VARCHAR(10);
DECLARE VARIABLE WK_OBJECT  VARCHAR(30);
DECLARE VARIABLE WK_CLASS CHAR(1);
DECLARE VARIABLE WK_REF  VARCHAR(255);
DECLARE VARIABLE WK_WH_ID  VARCHAR(2);
DECLARE VARIABLE WK_LOCN_ID  VARCHAR(10);
DECLARE VARIABLE WK_DATE TIMESTAMP;
DECLARE VARIABLE WK_USER VARCHAR(10);
DECLARE VARIABLE WK_DEVICE VARCHAR(2);

DECLARE VARIABLE WK_NEW_INVOICE CHAR(1);
DECLARE VARIABLE WK_FOUND INTEGER;
DECLARE VARIABLE WK_INVOICE_TYPE CHAR(2);
DECLARE VARIABLE WK_PRINTER_ID CHAR(2);
DECLARE VARIABLE WK_OUTPUT_TYPE VARCHAR(4);
DECLARE VARIABLE WK_DO_INVOICE CHAR(1);
DECLARE VARIABLE WK_INVOICE_ID INTEGER;

DECLARE VARIABLE WK_SO  VARCHAR(10);
DECLARE VARIABLE WK_SO_LEGACY_LEDGER_ADMIN_FEE    VARCHAR(40) ;
DECLARE VARIABLE WK_SO_LEGACY_LEDGER_FREIGHT      VARCHAR(40) ;
DECLARE VARIABLE WK_SO_LEGACY_LEDGER_DEPOSIT      VARCHAR(40) ;
DECLARE VARIABLE WK_SO_SUB_TOTAL_AMOUNT           NUMERIC(9, 2) ;
DECLARE VARIABLE WK_SO_SUB_TOTAL_TAX              NUMERIC(9, 2) ;
DECLARE VARIABLE WK_SO_FREIGHT                    NUMERIC(9, 2) ;
DECLARE VARIABLE WK_SO_FREIGHT_TAX_AMOUNT         NUMERIC(9, 2) ;
DECLARE VARIABLE WK_SO_ADMIN_FEE_RATE             DOUBLE PRECISION ;
DECLARE VARIABLE WK_SO_ADMIN_FEE_AMOUNT           NUMERIC(9, 2) ;
DECLARE VARIABLE WK_SO_ADMIN_TAX_AMOUNT           NUMERIC(9, 2) ;
DECLARE VARIABLE WK_SO_TAX_RATE                   DOUBLE PRECISION ;
DECLARE VARIABLE WK_SO_TAX_AMOUNT                 NUMERIC(9, 2) ;
DECLARE VARIABLE WK_SO_DUE_AMOUNT                 NUMERIC(9, 2) ;
DECLARE VARIABLE WK_SO_AMOUNT_PAID                NUMERIC(9, 2) ;
DECLARE VARIABLE WK_SO_COMPANY_ID                 VARCHAR(20);
DECLARE VARIABLE WK_SO_WH_ID                      VARCHAR(2);
DECLARE VARIABLE WK_SO_SHIPPING_METHOD            VARCHAR(10);

DECLARE VARIABLE WK_PD_DESPATCH_ID INTEGER;
DECLARE VARIABLE WK_PI_LABEL_NO VARCHAR(10);
DECLARE VARIABLE WK_DETAIL_ID INTEGER;
DECLARE VARIABLE WK_LABEL_QTY INTEGER;
DECLARE VARIABLE WK_PI2_INV_TOTAL_AMOUNT NUMERIC(13,2);

DECLARE VARIABLE WK_RES INTEGER;
DECLARE VARIABLE WK_BUFFER VARCHAR(1024);

DECLARE VARIABLE WK_ERROR_TEXT VARCHAR(255);
DECLARE VARIABLE WK_FIELD_NO  INTEGER;
DECLARE VARIABLE WK_TRN_DELIMITER  CHAR(1);
DECLARE VARIABLE WK_REF_CMD VARCHAR(255);
DECLARE VARIABLE WK_WORK_END  CHAR(1);
DECLARE VARIABLE WK_WORK_FIELD  VARCHAR(255);
DECLARE VARIABLE WK_WORK_LABEL  VARCHAR(255);
DECLARE VARIABLE WK_WORK_DATA   VARCHAR(255);
DECLARE VARIABLE WK_OP_DESC     VARCHAR(50);
DECLARE VARIABLE WK_OP_TABLE    VARCHAR(50);
DECLARE VARIABLE WK_OP_FIELD    VARCHAR(50);

DECLARE VARIABLE WK_IN_STATUS                     VARCHAR(2) ;
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'PINV') THEN
  BEGIN
     WK_CLASS = NEW.TRN_CODE;
     /* has values C create P print E export U update */ 
     WK_INVOICE_NO = NEW.SUB_LOCN_ID;
     WK_OBJECT = NEW.OBJECT;
     WK_LABEL_QTY = NEW.QTY;
     WK_WH_ID = NEW.WH_ID;
     WK_LOCN_ID = NEW.LOCN_ID;
     WK_RECORD = NEW.RECORD_ID; 
     WK_DATE = NEW.TRN_DATE;
     WK_USER = NEW.PERSON_ID;
     WK_REF = NEW.REFERENCE;
     WK_DO_INVOICE  = 'F';
     SELECT USE_INVOICE FROM CONTROL INTO :WK_DO_INVOICE ;
     IF (WK_DO_INVOICE IS NULL) THEN
     BEGIN 
        WK_DO_INVOICE = 'F';
     END
     IF (WK_DO_INVOICE <> 'T') THEN
     BEGIN 
        UPDATE TRANSACTIONS SET COMPLETE='T',ERROR_TEXT='| Cannot Invoice :Invoicing Turned Off' WHERE RECORD_ID = :WK_RECORD;
        EXIT;
     END

     IF ((WK_CLASS = 'C') OR (WK_CLASS = 'U')) THEN
     BEGIN
        /* create */
        EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_OBJECT, 1  RETURNING_VALUES :WK_SO ; 
        EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_OBJECT, 2  RETURNING_VALUES :WK_INVOICE_TYPE ; 
        EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_OBJECT, 3  RETURNING_VALUES :WK_PRINTER_ID   ; 
        EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_OBJECT, 4  RETURNING_VALUES :WK_OUTPUT_TYPE ; 
        IF (WK_INVOICE_NO IS NULL) THEN
        BEGIN
           WK_INVOICE_NO = '';
        END
        WK_NEW_INVOICE = 'F';
        IF (WK_INVOICE_NO = '') THEN
        BEGIN
           WK_NEW_INVOICE = 'T';
           /* calculate the next invoice no to use */
           EXECUTE PROCEDURE  GET_PICK_INVOICE_NO RETURNING_VALUES :WK_INVOICE_NO ;
           WK_INVOICE_ID = GEN_ID(PICK_INVOICE_ID_GEN,1); 
        END
        ELSE
        BEGIN
           SELECT FIRST 1 INVOICE_ID 
           FROM PICK_INVOICE
           WHERE INVOICE_NO = :WK_INVOICE_NO
           AND   INVOICE_TYPE = :WK_INVOICE_TYPE
           INTO WK_INVOICE_ID; 
           IF (WK_INVOICE_ID IS NULL) THEN
           BEGIN
              WK_NEW_INVOICE = 'T';
              WK_INVOICE_ID = GEN_ID(PICK_INVOICE_ID_GEN,1); 
           END
        END
        SELECT
           LEGACY_LEDGER_ADMIN_FEE_CODE,  
           LEGACY_LEDGER_FREIGHT_CODE,   
           LEGACY_LEDGER_DEPOSIT_CODE,  
           SUB_TOTAL_AMOUNT,          
           /* SUB_TOTAL_TAX, */         
           FREIGHT,                 
           FREIGHT_TAX_AMOUNT,     
           ADMIN_FEE_RATE,        
           ADMIN_FEE_AMOUNT,    
           /* ADMIN_TAX_AMOUNT, */
           TAX_RATE,          
           TAX_AMOUNT,       
           DUE_AMOUNT,      
           AMOUNT_PAID,
           COMPANY_ID,
           WH_ID    
           FROM PICK_ORDER
           WHERE PICK_ORDER = :WK_SO
           INTO 
              :WK_SO_LEGACY_LEDGER_ADMIN_FEE,  
              :WK_SO_LEGACY_LEDGER_FREIGHT,   
              :WK_SO_LEGACY_LEDGER_DEPOSIT,  
              :WK_SO_SUB_TOTAL_AMOUNT,          
              /* :WK_SO_SUB_TOTAL_TAX, */           
              :WK_SO_FREIGHT,                 
              :WK_SO_FREIGHT_TAX_AMOUNT,     
              :WK_SO_ADMIN_FEE_RATE,        
              :WK_SO_ADMIN_FEE_AMOUNT,    
              /* :WK_SO_ADMIN_TAX_AMOUNT, */
              :WK_SO_TAX_RATE,          
              :WK_SO_TAX_AMOUNT,       
              :WK_SO_DUE_AMOUNT,      
              :WK_SO_AMOUNT_PAID,
              :WK_SO_COMPANY_ID,
              :WK_SO_WH_ID;   
        WK_IN_STATUS = 'NC';
        WK_SO_SUB_TOTAL_TAX = 0; /* from the lines in pick_invoice_lines ie in pick_item_detail that we include */
        WK_SO_ADMIN_TAX_AMOUNT = WK_SO_ADMIN_FEE_AMOUNT * WK_SO_TAX_RATE; 
        /* WK_PI2_INV_TOTAL_AMOUNT = WK_SO_DUE_AMOUNT - WK_SO_DEPOSIT_AMOUNT_PAID; */
        WK_PI2_INV_TOTAL_AMOUNT = WK_SO_DUE_AMOUNT  ; 
        /*
        now for groups in the reference field
        split the code=value out
        lookup the code in the options table
        gives the field to be populated
        */
         WK_FIELD_NO = 1;
         WK_WORK_END = 'F';
         WK_TRN_DELIMITER = '|';
         WHILE (WK_WORK_END = 'F') DO
         BEGIN
            SELECT WK_FIELD_TEXT , WK_AT_END
            FROM GET_REFERENCE_FIELD4 (NEW.REFERENCE, :WK_FIELD_NO, :WK_TRN_DELIMITER) 
            INTO :WK_WORK_FIELD, :WK_WORK_END;
            /* now for this field get the label and data */
            SELECT WK_FIELD_LABEL, WK_FIELD_DATA 
            FROM GET_DATA_REFERENCE_FIELD4 (:WK_WORK_FIELD, '=')
            INTO :WK_WORK_LABEL, :WK_WORK_DATA;

            SELECT DESCRIPTION
            FROM OPTIONS
            WHERE GROUP_CODE = 'REF_CODE'
            AND CODE = :WK_WORK_LABEL
            INTO :WK_OP_DESC;
            IF (WK_OP_DESC IS NULL) THEN
            BEGIN
               WK_OP_DESC = '';
            END
            IF (WK_OP_DESC <> '') THEN
            BEGIN
               SELECT WK_FIELD_LABEL, WK_FIELD_DATA 
               FROM GET_DATA_REFERENCE_FIELD4 (:WK_OP_DESC, '.')
               INTO :WK_OP_TABLE, :WK_OP_FIELD;
               /* WK_REF_CMD = WK_REF_CMD || WK_OP_DESC || " = '" || WK_WORK_DATA || "',"; */
               IF (WK_OP_FIELD =  'INVOICE_STATUS') THEN
               BEGIN
                  WK_IN_STATUS = WK_WORK_DATA;
               END
               IF (WK_OP_FIELD =  'LEGACY_LEDGER_ADMIN_FEE_CODE') THEN
               BEGIN
                  WK_SO_LEGACY_LEDGER_ADMIN_FEE  = WK_WORK_DATA;
               END
               IF (WK_OP_FIELD =  'LEGACY_LEDGER_FREIGHT_CODE') THEN
               BEGIN
                  WK_SO_LEGACY_LEDGER_FREIGHT    = WK_WORK_DATA;
               END
               IF (WK_OP_FIELD =  'LEGACY_LEDGER_DEPOSIT_CODE') THEN
               BEGIN
                  WK_SO_LEGACY_LEDGER_DEPOSIT    = WK_WORK_DATA;
               END
               IF (WK_OP_FIELD =  'SUB_TOTAL_AMOUNT') THEN
               BEGIN
                   WK_SO_SUB_TOTAL_AMOUNT = WK_WORK_DATA;
               END
               IF (WK_OP_FIELD =  'SUB_TOTAL_TAX') THEN
               BEGIN
                   WK_SO_SUB_TOTAL_TAX    = WK_WORK_DATA;
               END
               IF (WK_OP_FIELD =  'FREIGHT') THEN
               BEGIN
                   WK_SO_FREIGHT          = WK_WORK_DATA;
               END
               IF (WK_OP_FIELD =  'FREIGHT_TAX_AMOUNT') THEN
               BEGIN
                   WK_SO_FREIGHT_TAX_AMOUNT = WK_WORK_DATA;
               END
               IF (WK_OP_FIELD =  'ADMIN_TAX_AMOUNT') THEN
               BEGIN
                   WK_SO_ADMIN_TAX_AMOUNT = WK_WORK_DATA;
               END
               IF (WK_OP_FIELD =  'ADMIN_FEE_AMOUNT') THEN
               BEGIN
                   WK_SO_ADMIN_FEE_AMOUNT = WK_WORK_DATA;
               END
               IF (WK_OP_FIELD =  'ADMIN_FEE_RATE') THEN
               BEGIN
                   WK_SO_ADMIN_FEE_RATE   = WK_WORK_DATA;
               END
               IF (WK_OP_FIELD =  'TAX_RATE') THEN
               BEGIN
                   WK_SO_TAX_RATE   = WK_WORK_DATA;
               END
               IF (WK_OP_FIELD =  'TAX_AMOUNT') THEN
               BEGIN
                   WK_SO_TAX_AMOUNT = WK_WORK_DATA;
               END
               IF (WK_OP_FIELD =  'DUE_AMOUNT') THEN
               BEGIN
                   WK_SO_DUE_AMOUNT = WK_WORK_DATA;
               END
               IF (WK_OP_FIELD =  'AMOUNT_PAID') THEN
               BEGIN
                   WK_SO_AMOUNT_PAID = WK_WORK_DATA;
               END
               IF (WK_OP_FIELD =  'INV_TOTAL_AMOUNT') THEN
               BEGIN
                   WK_PI2_INV_TOTAL_AMOUNT = WK_WORK_DATA;
               END
               IF (WK_OP_FIELD =  'COMPANY_ID') THEN
               BEGIN
                   WK_SO_COMPANY_ID = WK_WORK_DATA;
               END
               IF (WK_OP_FIELD =  'WH_ID') THEN
               BEGIN
                   WK_SO_WH_ID = WK_WORK_DATA;
               END
               IF (WK_OP_FIELD =  'SHIPPING_METHOD') THEN
               BEGIN
                   WK_SO_SHIPPING_METHOD = WK_WORK_DATA;
               END
            END
            WK_FIELD_NO = WK_FIELD_NO + 1;
         END

        /* create the invoice record */
        IF (WK_NEW_INVOICE = 'T') THEN
        BEGIN
           INSERT INTO PICK_INVOICE (
              INVOICE_ID,  
              INVOICE_NO, 
              INVOICE_TYPE,  
              INVOICE_STATUS,
              PICK_ORDER,     
              LEGACY_LEDGER_ADMIN_FEE_CODE,  
              LEGACY_LEDGER_FREIGHT_CODE,   
              LEGACY_LEDGER_DEPOSIT_CODE,  
              SUB_TOTAL_AMOUNT,          
              SUB_TOTAL_TAX,            
              FREIGHT,                 
              FREIGHT_TAX_AMOUNT,     
              ADMIN_FEE_RATE,        
              ADMIN_FEE_AMOUNT,    
              ADMIN_TAX_AMOUNT,   
              TAX_RATE,          
              TAX_AMOUNT,       
              DUE_AMOUNT,      
              AMOUNT_PAID,    
              INV_TOTAL_AMOUNT,      
              CREATE_DATE,            
              CREATED_BY,            
              LAST_UPDATE_DATE,     
              LAST_UPDATE_BY ,
              COMPANY_ID,
              WH_ID,
              SHIPPING_METHOD)
           VALUES (:WK_INVOICE_ID,
                   :WK_INVOICE_NO,
                   :WK_INVOICE_TYPE,
                   :WK_IN_STATUS,
                   :WK_SO,
                   :WK_SO_LEGACY_LEDGER_ADMIN_FEE,  
                   :WK_SO_LEGACY_LEDGER_FREIGHT,   
                   :WK_SO_LEGACY_LEDGER_DEPOSIT,  
                   :WK_SO_SUB_TOTAL_AMOUNT,          
                   :WK_SO_SUB_TOTAL_TAX,            
                   :WK_SO_FREIGHT,                 
                   :WK_SO_FREIGHT_TAX_AMOUNT,     
                   :WK_SO_ADMIN_FEE_RATE,        
                   :WK_SO_ADMIN_FEE_AMOUNT,    
                   :WK_SO_ADMIN_TAX_AMOUNT,   
                   :WK_SO_TAX_RATE,          
                   :WK_SO_TAX_AMOUNT,       
                   :WK_SO_DUE_AMOUNT,      
                   :WK_SO_AMOUNT_PAID,    
                   :WK_PI2_INV_TOTAL_AMOUNT,      
                   :WK_DATE,
                   :WK_USER,
                   :WK_DATE,
                   :WK_USER,
                   :WK_SO_COMPANY_ID,
                   :WK_SO_WH_ID, 
                   :WK_SO_SHIPPING_METHOD); 
        END
        ELSE
        BEGIN
           UPDATE PICK_INVOICE SET
              INVOICE_NO =                   :WK_INVOICE_NO,
              INVOICE_TYPE =                 :WK_INVOICE_TYPE,
              INVOICE_STATUS =               :WK_IN_STATUS,
              PICK_ORDER =                   :WK_SO,
              LEGACY_LEDGER_ADMIN_FEE_CODE = :WK_SO_LEGACY_LEDGER_ADMIN_FEE,  
              LEGACY_LEDGER_FREIGHT_CODE =   :WK_SO_LEGACY_LEDGER_FREIGHT,   
              LEGACY_LEDGER_DEPOSIT_CODE =   :WK_SO_LEGACY_LEDGER_DEPOSIT,  
              SUB_TOTAL_AMOUNT =             :WK_SO_SUB_TOTAL_AMOUNT,          
              SUB_TOTAL_TAX =                :WK_SO_SUB_TOTAL_TAX,            
              FREIGHT =                      :WK_SO_FREIGHT,                 
              FREIGHT_TAX_AMOUNT =           :WK_SO_FREIGHT_TAX_AMOUNT,     
              ADMIN_FEE_RATE =               :WK_SO_ADMIN_FEE_RATE,        
              ADMIN_FEE_AMOUNT =             :WK_SO_ADMIN_FEE_AMOUNT,    
              ADMIN_TAX_AMOUNT =             :WK_SO_ADMIN_TAX_AMOUNT,   
              TAX_RATE =                     :WK_SO_TAX_RATE,          
              TAX_AMOUNT =                   :WK_SO_TAX_AMOUNT,       
              DUE_AMOUNT =                   :WK_SO_DUE_AMOUNT,      
              AMOUNT_PAID =                  :WK_SO_AMOUNT_PAID,    
              INV_TOTAL_AMOUNT =             :WK_PI2_INV_TOTAL_AMOUNT ,     
              LAST_UPDATE_DATE =             :WK_DATE,
              LAST_UPDATE_BY =               :WK_USER,
              COMPANY_ID =                   :WK_SO_COMPANY_ID,
              WH_ID =                        :WK_SO_WH_ID,
              SHIPPING_METHOD =              :WK_SO_SHIPPING_METHOD
              WHERE INVOICE_ID = :WK_INVOICE_ID;
        END
        /* so update /insert the pick_invoice */
        /* now get the pick_despatches for this order
           that are not on an invoice 
           then put them on this invoice */
        IF (WK_INVOICE_TYPE = 'TI') THEN
        BEGIN
           FOR SELECT PD.DESPATCH_ID
           FROM PICK_ORDER PO
           JOIN PICK_ITEM PI ON PO.PICK_ORDER = PI.PICK_ORDER
           JOIN PICK_ITEM_DETAIL PID ON PI.PICK_LABEL_NO = PID.PICK_LABEL_NO
           JOIN PICK_DESPATCH PD ON PID.DESPATCH_ID = PD.DESPATCH_ID
           WHERE PO.PICK_ORDER = :WK_SO
           AND (PD.INVOICE_TYPE IS NULL
                OR PD.INVOICE_TYPE = 'QT')
           INTO :WK_PD_DESPATCH_ID
           DO 
           BEGIN
              UPDATE PICK_DESPATCH
              SET INVOICE_ID = :WK_INVOICE_ID,
                  INVOICE_NO = :WK_INVOICE_NO,
                  INVOICE_TYPE = :WK_INVOICE_TYPE
              WHERE DESPATCH_ID = :WK_PD_DESPATCH_ID;
              /* add in pick_invoice_line for this ssn_id */
           END
        END
        ELSE
        BEGIN
           FOR SELECT PD.DESPATCH_ID
           FROM PICK_ORDER PO
           JOIN PICK_ITEM PI ON PO.PICK_ORDER = PI.PICK_ORDER
           JOIN PICK_ITEM_DETAIL PID ON PI.PICK_LABEL_NO = PID.PICK_LABEL_NO
           JOIN PICK_DESPATCH PD ON PID.DESPATCH_ID = PD.DESPATCH_ID
           WHERE PO.PICK_ORDER = :WK_SO
           AND PD.INVOICE_TYPE IS NULL
           INTO :WK_PD_DESPATCH_ID
           DO 
           BEGIN
              UPDATE PICK_DESPATCH
              SET INVOICE_ID = :WK_INVOICE_ID,
                  INVOICE_NO = :WK_INVOICE_NO,
                  INVOICE_TYPE = :WK_INVOICE_TYPE
              WHERE DESPATCH_ID = :WK_PD_DESPATCH_ID;
              /* add in pick_invoice_line for this ssn_id */
           END
        END
        /* update the invoice for the ssns added the lines tax amount */
        UPDATE PICK_INVOICE SET
        SUB_TOTAL_TAX =                :WK_SO_SUB_TOTAL_TAX            
        WHERE INVOICE_ID = :WK_INVOICE_ID;
        /* WK_ERROR_TEXT = 'Created ' || :WK_INVOICE_NO || '|Processed successfully' ; */
        IF (WK_NEW_INVOICE = 'T') THEN
        BEGIN
           WK_ERROR_TEXT = 'Created ' || :WK_INVOICE_NO || '|Processed successfully' ;
        END
        ELSE
        BEGIN
           WK_ERROR_TEXT = 'Updated ' || :WK_INVOICE_NO || '|Processed successfully' ;
        END
     END
     ELSE
     IF (WK_CLASS = 'E') THEN
     BEGIN
        /* export */
        WK_ERROR_TEXT = 'Export but not yet ' || :WK_INVOICE_NO || '|Not Processed successfully' ;
     END
     ELSE
     IF (WK_CLASS = 'P') THEN
     BEGIN
        /* print  but how */
        WK_ERROR_TEXT = 'Cannot Print Here ' || :WK_INVOICE_NO || '|Run from Minder PHP' ;
     END

     UPDATE TRANSACTIONS SET COMPLETE='T',ERROR_TEXT=:WK_ERROR_TEXT WHERE RECORD_ID = :WK_RECORD;

   /* EXECUTE PROCEDURE TRAN_ARCHIVE; */
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_PILN FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 154 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_RECORD  INTEGER;
DECLARE VARIABLE WK_OBJECT  VARCHAR(30);
DECLARE VARIABLE WK_CLASS CHAR(1);
DECLARE VARIABLE WK_REF  VARCHAR(255);
DECLARE VARIABLE WK_WH_ID  VARCHAR(2);
DECLARE VARIABLE WK_LOCN_ID  VARCHAR(10);
DECLARE VARIABLE WK_DATE TIMESTAMP;
DECLARE VARIABLE WK_USER VARCHAR(10);
DECLARE VARIABLE WK_DEVICE VARCHAR(2);
DECLARE VARIABLE WK_SUB_LOCN_ID VARCHAR(10);

DECLARE VARIABLE WK_NEW_INVOICE CHAR(1);
DECLARE VARIABLE WK_FOUND INTEGER;
DECLARE VARIABLE WK_INVOICE_NO VARCHAR(10);
DECLARE VARIABLE WK_INVOICE_TYPE CHAR(2);
DECLARE VARIABLE WK_DO_INVOICE CHAR(1);
DECLARE VARIABLE WK_INVOICE_ID INTEGER;
DECLARE VARIABLE WK_NEW_INVOICE_LINE CHAR(1);

DECLARE VARIABLE WK_SO  VARCHAR(10);

DECLARE VARIABLE WK_PIL_LINE_ID                    INTEGER;
DECLARE VARIABLE WK_PIL_LEGACY_LEDGER_CODE         VARCHAR(40) ;
DECLARE VARIABLE WK_PIL_PICK_LABEL_NO              VARCHAR(10) ;
DECLARE VARIABLE WK_PIL_PICK_ID                    VARCHAR(50) ;
DECLARE VARIABLE WK_PIL_PICK_TYPE                  VARCHAR(2) ;
DECLARE VARIABLE WK_PIL_LINE_TYPE                  VARCHAR(2) ;
DECLARE VARIABLE WK_PIL_QTY                        NUMERIC(9, 2) ;
DECLARE VARIABLE WK_PIL_SALE_PRICE                 NUMERIC(13, 2) ;
DECLARE VARIABLE WK_PIL_DISCOUNT                   NUMERIC(13, 2) ;
DECLARE VARIABLE WK_PIL_LINE_TOTAL                 NUMERIC(13, 2) ;
DECLARE VARIABLE WK_PIL_TAX_RATE                   DOUBLE PRECISION;
DECLARE VARIABLE WK_PIL_UNIT_COST                  NUMERIC(13, 2) ;
DECLARE VARIABLE WK_PIL_TOTAL_COST                 NUMERIC(13, 2) ;
DECLARE VARIABLE WK_PIL_TAX_AMOUNT                 NUMERIC(9, 2) ;

DECLARE VARIABLE WK_PD_DESPATCH_ID INTEGER;
DECLARE VARIABLE WK_PI_LABEL_NO VARCHAR(10);
DECLARE VARIABLE WK_PI_PROD_ID  VARCHAR(30);
DECLARE VARIABLE WK_PI_SSN_ID   VARCHAR(20);
DECLARE VARIABLE WK_DETAIL_ID INTEGER;
DECLARE VARIABLE WK_LABEL_QTY INTEGER;

DECLARE VARIABLE WK_RES INTEGER;
DECLARE VARIABLE WK_BUFFER VARCHAR(1024);

DECLARE VARIABLE WK_ERROR_TEXT VARCHAR(255);
DECLARE VARIABLE WK_FIELD_NO  INTEGER;
DECLARE VARIABLE WK_TRN_DELIMITER  CHAR(1);
DECLARE VARIABLE WK_REF_CMD VARCHAR(255);
DECLARE VARIABLE WK_WORK_END  CHAR(1);
DECLARE VARIABLE WK_WORK_FIELD  VARCHAR(255);
DECLARE VARIABLE WK_WORK_LABEL  VARCHAR(255);
DECLARE VARIABLE WK_WORK_DATA   VARCHAR(255);
DECLARE VARIABLE WK_OP_DESC     VARCHAR(50);
DECLARE VARIABLE WK_OP_TABLE    VARCHAR(50);
DECLARE VARIABLE WK_OP_FIELD    VARCHAR(50);

DECLARE VARIABLE WK_IN_STATUS                     VARCHAR(2) ;

DECLARE VARIABLE WK_LOG_FILENAME                  VARCHAR(80) ;
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'PILN') THEN
  BEGIN
     WK_LOG_FILENAME = '/tmp/piln.log';
     WK_CLASS = NEW.TRN_CODE;
     /* has values C create U update */ 
     WK_INVOICE_TYPE = NEW.SUB_LOCN_ID;
     WK_OBJECT = NEW.OBJECT;
     WK_LABEL_QTY = NEW.QTY;
     WK_WH_ID = NEW.WH_ID;
     WK_LOCN_ID = NEW.LOCN_ID;
     WK_RECORD = NEW.RECORD_ID; 
     WK_DATE = NEW.TRN_DATE;
     WK_USER = NEW.PERSON_ID;
     WK_REF = NEW.REFERENCE;
     WK_DO_INVOICE  = 'F';
     SELECT USE_INVOICE FROM CONTROL INTO :WK_DO_INVOICE ;
     IF (WK_DO_INVOICE IS NULL) THEN
     BEGIN 
        WK_DO_INVOICE = 'F';
     END
     IF (WK_DO_INVOICE <> 'T') THEN
     BEGIN 
        UPDATE TRANSACTIONS SET COMPLETE='T',ERROR_TEXT='| Cannot Invoice :Invoicing Turned Off' WHERE RECORD_ID = :WK_RECORD;
        EXIT;
     END

     IF ((WK_CLASS = 'C') OR (WK_CLASS = 'U')) THEN
     BEGIN
        /* create */
        EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_OBJECT, 1  RETURNING_VALUES :WK_SO ; 
        EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_OBJECT, 2  RETURNING_VALUES :WK_INVOICE_NO ; 
        WK_NEW_INVOICE = 'F';
        IF (WK_INVOICE_NO = '') THEN
        BEGIN
           WK_NEW_INVOICE = 'T';
           /* calculate the next invoice no to use */
           EXECUTE PROCEDURE  GET_PICK_INVOICE_NO RETURNING_VALUES :WK_INVOICE_NO ;
           WK_INVOICE_ID = GEN_ID(DESPATCH_ID_GEN,1); 
        END
        ELSE
        BEGIN
           SELECT FIRST 1 INVOICE_ID 
           FROM PICK_INVOICE
           WHERE INVOICE_NO = :WK_INVOICE_NO
           AND   INVOICE_TYPE = :WK_INVOICE_TYPE
           INTO WK_INVOICE_ID; 
           IF (WK_INVOICE_ID IS NULL) THEN
           BEGIN
              WK_NEW_INVOICE = 'T';
              WK_INVOICE_ID = GEN_ID(DESPATCH_ID_GEN,1); 
           END
        END
        WK_BUFFER = 'SO:' || WK_SO;
        WK_BUFFER = 'INvoice:' || WK_INVOICE_NO;
        WK_IN_STATUS = 'NC';
        WK_PIL_LINE_ID               = NULL ;
        WK_PIL_LEGACY_LEDGER_CODE    = NULL ;
        WK_PIL_PICK_LABEL_NO         = NULL ;
        WK_PIL_PICK_ID               = NULL ;
        WK_PIL_PICK_TYPE             = NULL ;
        WK_PIL_LINE_TYPE             = NULL ;
        WK_PIL_QTY                   = NULL ;
        WK_PIL_SALE_PRICE            = NULL ;
        WK_PIL_DISCOUNT              = NULL ;
        WK_PIL_LINE_TOTAL            = NULL ;
        WK_PIL_TAX_RATE              = NULL ;
        WK_PIL_UNIT_COST             = NULL ;
        WK_PIL_TOTAL_COST            = NULL ;
        WK_PIL_TAX_AMOUNT            = NULL ;
        /*
        now for groups in the reference field
        split the code=value out
        lookup the code in the options table
        gives the field to be populated
        */
         WK_FIELD_NO = 1;
         WK_WORK_END = 'F';
         WK_TRN_DELIMITER = '|';
         WK_BUFFER = 'reference:' || NEW.REFERENCE;
         WHILE (WK_WORK_END = 'F') DO
         BEGIN
            SELECT WK_FIELD_TEXT , WK_AT_END
            FROM GET_REFERENCE_FIELD4 (NEW.REFERENCE, :WK_FIELD_NO, :WK_TRN_DELIMITER) 
            INTO :WK_WORK_FIELD, :WK_WORK_END;
            WK_BUFFER = 'Work Field:' || WK_WORK_FIELD;
            WK_BUFFER = 'Work End:' || WK_WORK_END;
            /* now for this field get the label and data */
            SELECT WK_FIELD_LABEL, WK_FIELD_DATA 
            FROM GET_DATA_REFERENCE_FIELD4 (:WK_WORK_FIELD, '=')
            INTO :WK_WORK_LABEL, :WK_WORK_DATA;
            WK_BUFFER = 'Work Label:' || WK_WORK_LABEL;
            WK_BUFFER = 'Work data:' || WK_WORK_LABEL;

            SELECT DESCRIPTION
            FROM OPTIONS
            WHERE GROUP_CODE = 'REF_CODE'
            AND CODE = :WK_WORK_LABEL
            INTO :WK_OP_DESC;
            IF (WK_OP_DESC IS NULL) THEN
            BEGIN
               WK_OP_DESC = '';
            END
            WK_BUFFER = 'Op Desc:' || WK_OP_DESC;
            IF (WK_OP_DESC <> '') THEN
            BEGIN
               SELECT WK_FIELD_LABEL, WK_FIELD_DATA 
               FROM GET_DATA_REFERENCE_FIELD4 (:WK_OP_DESC, '.')
               INTO :WK_OP_TABLE, :WK_OP_FIELD;
               WK_BUFFER = 'Op Table:' || WK_OP_TABLE;
               WK_BUFFER = 'Op Field:' || WK_OP_FIELD;
               IF (WK_OP_FIELD =  'INVLINE_LEGACY_LEDGER_CODE') THEN
               BEGIN
                  WK_PIL_LEGACY_LEDGER_CODE  = WK_WORK_DATA;
               END
               IF (WK_OP_FIELD =  'INVLINE_PICK_LABEL_NO') THEN
               BEGIN
                  WK_PIL_PICK_LABEL_NO       = WK_WORK_DATA;
               END
               IF (WK_OP_FIELD =  'INVLINE_PICK_ID') THEN
               BEGIN
                  WK_PIL_PICK_ID             = WK_WORK_DATA;
               END
               IF (WK_OP_FIELD =  'INVLINE_PICK_TYPE') THEN
               BEGIN
                   WK_PIL_PICK_TYPE       = WK_WORK_DATA;
               END
               IF (WK_OP_FIELD =  'INVLINE_LINE_TYPE') THEN
               BEGIN
                   WK_PIL_LINE_TYPE       = WK_WORK_DATA;
               END
               IF (WK_OP_FIELD =  'INVLINE_QTY') THEN
               BEGIN
                   WK_PIL_QTY             = WK_WORK_DATA;
               END
               IF (WK_OP_FIELD =  'INVLINE_SALE_PRICE') THEN
               BEGIN
                   WK_PIL_SALE_PRICE        = WK_WORK_DATA;
               END
               IF (WK_OP_FIELD =  'INVLINE_DISCOUNT') THEN
               BEGIN
                   WK_PIL_DISCOUNT        = WK_WORK_DATA;
               END
               IF (WK_OP_FIELD =  'INVLINE_LINE_TOTAL') THEN
               BEGIN
                   WK_PIL_LINE_TOTAL      = WK_WORK_DATA;
               END
               IF (WK_OP_FIELD =  'INVLINE_TAX_RATE') THEN
               BEGIN
                   WK_PIL_TAX_RATE   = WK_WORK_DATA;
               END
               IF (WK_OP_FIELD =  'INVLINE_TAX_AMOUNT') THEN
               BEGIN
                   WK_PIL_TAX_AMOUNT = WK_WORK_DATA;
               END
               IF (WK_OP_FIELD =  'INVLINE_UNIT_COST') THEN
               BEGIN
                   WK_PIL_UNIT_COST = WK_WORK_DATA;
               END
               IF (WK_OP_FIELD =  'INVLINE_TOTAL_COST') THEN
               BEGIN
                   WK_PIL_TOTAL_COST       = WK_WORK_DATA;
               END
            END
            WK_FIELD_NO = WK_FIELD_NO + 1;
         END

        /* create the invoice record */
        IF (WK_NEW_INVOICE = 'T') THEN
        BEGIN
           INSERT INTO PICK_INVOICE (
              INVOICE_ID,  
              INVOICE_NO, 
              INVOICE_TYPE,  
              INVOICE_STATUS,
              PICK_ORDER,     
              CREATE_DATE,            
              CREATED_BY,            
              LAST_UPDATE_DATE,     
              LAST_UPDATE_BY )
           VALUES (:WK_INVOICE_ID,
                   :WK_INVOICE_NO,
                   :WK_INVOICE_TYPE,
                   :WK_IN_STATUS,
                   :WK_SO,
                   :WK_DATE,
                   :WK_USER,
                   :WK_DATE,
                   :WK_USER); 
        END
        /* now if label no populated this must be a pick_id */
        IF (WK_PIL_PICK_ID IS NULL) THEN
        BEGIN
           IF (WK_PIL_PICK_LABEL_NO IS NOT NULL) THEN
           BEGIN
              SELECT SSN_ID, PROD_ID 
              FROM PICK_ITEM 
              WHERE PICK_LABEL_NO = :WK_PIL_PICK_LABEL_NO
              INTO :WK_PI_SSN_ID, :WK_PI_PROD_ID;
              IF (WK_PI_SSN_ID IS NOT NULL) THEN
              BEGIN
                 WK_PIL_PICK_TYPE = 'I';
                 WK_PIL_PICK_ID = WK_PI_SSN_ID;
              END
              IF (WK_PI_PROD_ID IS NOT NULL) THEN
              BEGIN
                 WK_PIL_PICK_TYPE = 'P';
                 WK_PIL_PICK_ID = WK_PI_PROD_ID;
              END
           END
        END
	/* check the pick invoice line exists */
        SELECT FIRST 1 INVLINE_LINE_ID
        FROM PICK_INVOICE_LINE
        WHERE INVLINE_INVOICE_NO = :WK_INVOICE_NO
        AND   INVLINE_PICK_ORDER = :WK_SO
        AND   INVLINE_INVOICE_ID = :WK_INVOICE_ID
        AND   (INVLINE_PICK_LABEL_NO = :WK_PIL_PICK_LABEL_NO OR ( 
              INVLINE_PICK_ID = :WK_PIL_PICK_ID 
        AND INVLINE_PICK_TYPE = :WK_PIL_PICK_TYPE   
        AND INVLINE_PICK_LABEL_NO  IS NULL  )) 
        INTO :WK_PIL_LINE_ID;

        IF (WK_PIL_LINE_ID IS  NULL) THEN
        BEGIN
           WK_NEW_INVOICE_LINE = 'T';
        END
        ELSE
        BEGIN
           WK_NEW_INVOICE_LINE = 'F';
        END
        /* create the invoice record */
        IF (WK_NEW_INVOICE_LINE = 'T') THEN
        BEGIN
           WK_PIL_LINE_ID =  GEN_ID(PICK_INVOICE_LINE_ID_GEN,1);
           INSERT INTO PICK_INVOICE_LINE (
              INVLINE_INVOICE_NO           , 
              INVLINE_PICK_ORDER           , 
              INVLINE_PICK_LABEL_NO        , 
              INVLINE_PICK_ID              , 
              INVLINE_PICK_TYPE            , 
              INVLINE_LINE_TYPE            , 
              INVLINE_QTY                  , 
              INVLINE_SALE_PRICE           , 
              INVLINE_DISCOUNT             , 
              INVLINE_LINE_TOTAL           , 
              INVLINE_TAX_RATE             , 
              INVLINE_UNIT_COST            , 
              INVLINE_TOTAL_COST           , 
              INVLINE_LEGACY_LEDGER_CODE   , 
              INVLINE_UPDATE_DATE          , 
              INVLINE_UPDATED_BY           , 
              INVLINE_INVOICE_ID           , 
              INVLINE_CREATED_DATE         , 
              INVLINE_CREATED_BY           , 
              INVLINE_LINE_ID )              
           VALUES (
              :WK_INVOICE_NO,
              :WK_SO,
              :WK_PIL_PICK_LABEL_NO,
              :WK_PIL_PICK_ID,
              :WK_PIL_PICK_TYPE,
              :WK_PIL_LINE_TYPE,
              :WK_PIL_QTY,       
              :WK_PIL_SALE_PRICE,
              :WK_PIL_DISCOUNT,
              :WK_PIL_LINE_TOTAL,
              :WK_PIL_TAX_RATE,
              :WK_PIL_UNIT_COST,
              :WK_PIL_TOTAL_COST,
              :WK_PIL_LEGACY_LEDGER_CODE, 
              :WK_DATE, 
              :WK_USER, 
              :WK_INVOICE_ID,
              :WK_DATE,
              :WK_USER, 
              :WK_PIL_LINE_ID );
        END
        ELSE
        BEGIN
           UPDATE PICK_INVOICE_LINE SET
              INVLINE_INVOICE_NO           = :WK_INVOICE_NO,
              INVLINE_PICK_ORDER           = :WK_SO,
              INVLINE_PICK_LABEL_NO        = :WK_PIL_PICK_LABEL_NO,
              INVLINE_PICK_ID              = :WK_PIL_PICK_ID,
              INVLINE_PICK_TYPE            = :WK_PIL_PICK_TYPE,
              INVLINE_LINE_TYPE            = :WK_PIL_LINE_TYPE,
              INVLINE_QTY                  = :WK_PIL_QTY,       
              INVLINE_SALE_PRICE           = :WK_PIL_SALE_PRICE,
              INVLINE_DISCOUNT             = :WK_PIL_DISCOUNT,
              INVLINE_LINE_TOTAL           = :WK_PIL_LINE_TOTAL,
              INVLINE_TAX_RATE             = :WK_PIL_TAX_RATE,
              INVLINE_UNIT_COST            = :WK_PIL_UNIT_COST,
              INVLINE_TOTAL_COST           = :WK_PIL_TOTAL_COST,
              INVLINE_LEGACY_LEDGER_CODE   = :WK_PIL_LEGACY_LEDGER_CODE, 
              INVLINE_UPDATE_DATE          = :WK_DATE, 
              INVLINE_UPDATED_BY           = :WK_USER, 
              INVLINE_INVOICE_ID           = :WK_INVOICE_ID
              WHERE INVLINE_LINE_ID = :WK_PIL_LINE_ID;
        END
        /* so update /insert the pick_invoice */
        IF (WK_NEW_INVOICE_LINE = 'T') THEN
        BEGIN
           WK_ERROR_TEXT = 'Created ' || :WK_INVOICE_NO || '|Line ' || :WK_PIL_LINE_ID || '|Processed successfully' ;
           WK_ERROR_TEXT = 'Processed successfully' ;
        END
        ELSE
        BEGIN
           WK_ERROR_TEXT = 'Updated ' || :WK_INVOICE_NO || '|Line ' || :WK_PIL_LINE_ID || '|Processed successfully' ;
           WK_ERROR_TEXT = 'Processed successfully' ;
        END
     END

     UPDATE TRANSACTIONS SET COMPLETE='T',ERROR_TEXT=:WK_ERROR_TEXT WHERE RECORD_ID = :WK_RECORD;

   /* EXECUTE PROCEDURE TRAN_ARCHIVE; */
  END
 END
END ^

CREATE TRIGGER RUN_TRANSACTION_PKUL FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 155 
AS
/* unallocate of allocated pick  */
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_DEVICE CHAR(2);
DECLARE VARIABLE WK_DEVICE_FROM CHAR(2);
DECLARE VARIABLE WK_DEVICE_TO CHAR(2);
DECLARE VARIABLE WK_USER VARCHAR(10);
DECLARE VARIABLE WK_RECORD INTEGER;
DECLARE VARIABLE WK_DATE TIMESTAMP;
DECLARE VARIABLE WK_ORDER VARCHAR(30);
DECLARE VARIABLE WK_PROD VARCHAR(30);
DECLARE VARIABLE WK_OVER_SIZED VARCHAR(10);
DECLARE VARIABLE WK_DO_PLAO VARCHAR(10);
DECLARE VARIABLE WK_PRINTER VARCHAR(10);
DECLARE VARIABLE WK_MYREF VARCHAR(40);
DECLARE VARIABLE WK_LINE_CNT INTEGER;
DECLARE VARIABLE WK_LINE_CNT_X VARCHAR(4);
DECLARE VARIABLE WK_LABELS_X VARCHAR(40);
DECLARE VARIABLE WK_LABELS INTEGER;
DECLARE VARIABLE WK_CO_PICK_STATUS VARCHAR(30);
DECLARE VARIABLE WK_CO_WARN_PRIORITY INTEGER;
DECLARE VARIABLE WK_REFERENCE VARCHAR(255);
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'PKUL') THEN
  BEGIN
     WK_USER = NEW.PERSON_ID;
     WK_DEVICE = NEW.DEVICE_ID;
     WK_DEVICE_FROM = NEW.DEVICE_ID;
     WK_DEVICE_TO = NULL;
     WK_DATE = NEW.TRN_DATE;
     WK_RECORD = NEW.RECORD_ID;
     SELECT WARN_PICK_PRIORITY
     FROM CONTROL
     INTO :WK_CO_WARN_PRIORITY;
     IF (WK_CO_WARN_PRIORITY IS NULL ) THEN
     BEGIN
        WK_CO_WARN_PRIORITY = 10;
     END
     WK_CO_PICK_STATUS = ',AL,OP,';
     IF (NEW.TRN_CODE = ' ' OR NEW.TRN_CODE = 'K') THEN
     BEGIN
        /* unallocate all picks  */
        UPDATE PICK_ORDER 
           SET PICK_ORDER.PICK_PRIORITY = :WK_CO_WARN_PRIORITY
           WHERE PICK_ORDER.PICK_ORDER IN (SELECT PICK_ITEM.PICK_ORDER 
              FROM PICK_ITEM 
              WHERE PICK_ITEM.DEVICE_ID = :WK_DEVICE_FROM
              AND POS(:WK_CO_PICK_STATUS , PICK_ITEM.PICK_LINE_STATUS, 0, 1) > -1
              GROUP BY PICK_ITEM.PICK_ORDER); 
        UPDATE PICK_ITEM
           SET DEVICE_ID = :WK_DEVICE_TO,
           PICK_LINE_STATUS = 'OP'
           WHERE DEVICE_ID = :WK_DEVICE_FROM
           AND POS(:WK_CO_PICK_STATUS , PICK_LINE_STATUS, 0, 1) > -1; 
        UPDATE PICK_LOCATION
        SET PICK_LOCATION_STATUS='CN'
        WHERE  DEVICE_ID = :WK_DEVICE_FROM 
        AND PICK_LOCATION_STATUS = 'OP';
        EXECUTE PROCEDURE UPDATE_TRAN (WK_RECORD, 'T','Processed successfully');
     END
     ELSE
     IF (NEW.TRN_CODE = 'P') THEN
     BEGIN
        /* unallocate product  */
        WK_PROD = NEW.OBJECT;
        WK_OVER_SIZED = NEW.LOCN_ID;
        UPDATE PICK_ORDER 
           SET PICK_ORDER.PICK_PRIORITY = :WK_CO_WARN_PRIORITY
           WHERE PICK_ORDER.PICK_ORDER IN (SELECT PICK_ITEM.PICK_ORDER 
              FROM PICK_ITEM 
              WHERE PICK_ITEM.PROD_ID = :WK_PROD
              AND   PICK_ITEM.DEVICE_ID = :WK_DEVICE_FROM
              AND POS(:WK_CO_PICK_STATUS , PICK_ITEM.PICK_LINE_STATUS, 0, 1) > -1
              AND PICK_ITEM.OVER_SIZED = :WK_OVER_SIZED
              GROUP BY PICK_ITEM.PICK_ORDER); 
        UPDATE PICK_ITEM
           SET DEVICE_ID = :WK_DEVICE_TO,
           PICK_LINE_STATUS = 'OP',
           PICK_LINE_PRIORITY = PICK_LINE_PRIORITY + NEW.QTY
           WHERE PROD_ID = :WK_PROD
           AND DEVICE_ID = :WK_DEVICE_FROM
           AND POS(:WK_CO_PICK_STATUS , PICK_ITEM.PICK_LINE_STATUS, 0, 1) > -1
           AND OVER_SIZED = :WK_OVER_SIZED;
        EXECUTE PROCEDURE UPDATE_TRAN (WK_RECORD, 'T','Processed successfully');
     END
     ELSE
     IF (NEW.TRN_CODE = 'O') THEN
     BEGIN
        /* unallocate  an order from where ever it is   */
        WK_ORDER = NEW.OBJECT;
        WK_DO_PLAO = SUBSTR(NEW.LOCN_ID,1,1);
        WK_PRINTER = SUBSTR(NEW.LOCN_ID,3,4);
        IF (WK_DO_PLAO = 'T') THEN
        BEGIN
           SELECT COUNT(*)
           FROM PICK_ITEM
           WHERE PICK_ORDER = :WK_ORDER
           AND PICK_LINE_STATUS IN ('AL', 'PG', 'OP', 'PL')
           INTO :WK_LINE_CNT;
           WK_LINE_CNT_X = LPAD(WK_LINE_CNT,'0',3);
           SELECT FIRST 1 DESCRIPTION
           FROM OPTIONS
           WHERE GROUP_CODE = 'CMPPKPRO'
           AND CODE >= :WK_LINE_CNT_X
           ORDER BY CODE
           INTO :WK_LABELS_X;
           WK_LABELS = CAST(WK_LABELS_X AS INTEGER);
           WK_MYREF = '                                     |' || WK_PRINTER;
           /* now do plao for this */
           EXECUTE PROCEDURE ADD_TRAN(
                    '  ',
                    '        ',
                    :WK_ORDER,
                    'PLAO',
                    'O',
                    :WK_DATE,
                    :WK_MYREF,
                    :WK_LABELS,
                    'F',
                    '',
                    'MASTER',
                    0,
                    '          ',
                    'SSSSSSSSS',
                    :WK_USER,
                    :WK_DEVICE);
        END
        UPDATE PICK_ORDER 
           SET PICK_ORDER.PICK_PRIORITY = :WK_CO_WARN_PRIORITY
           WHERE PICK_ORDER.PICK_ORDER = :WK_ORDER; 
        UPDATE PICK_ITEM
           SET DEVICE_ID = :WK_DEVICE_TO,
           PICK_LINE_STATUS = 'OP',
           PICK_LINE_PRIORITY = (SELECT MAX(P2.PICK_LINE_PRIORITY) FROM PICK_ITEM P2 
              WHERE P2.PICK_ORDER = :WK_ORDER
              AND POS(:WK_CO_PICK_STATUS , P2.PICK_LINE_STATUS, 0, 1) > -1 
              AND P2.PICK_LINE_PRIORITY IS NOT NULL) + NEW.QTY,
           USER_ID = :WK_USER
           WHERE PICK_ORDER = :WK_ORDER
           AND POS(:WK_CO_PICK_STATUS , PICK_LINE_STATUS, 0, 1) > -1 
           AND PICK_LINE_PRIORITY IS NOT NULL
           ;
        UPDATE PICK_ITEM
           SET DEVICE_ID = :WK_DEVICE_TO,
           PICK_LINE_STATUS = 'OP',
           PICK_LINE_PRIORITY = NEW.QTY,
           USER_ID = :WK_USER
           WHERE PICK_ORDER = :WK_ORDER
           AND POS(:WK_CO_PICK_STATUS , PICK_LINE_STATUS, 0, 1) > -1 
           AND PICK_LINE_PRIORITY IS NULL
           ;
        EXECUTE PROCEDURE UPDATE_TRAN (WK_RECORD, 'T','Processed successfully');
     END
     ELSE
     IF (NEW.TRN_CODE = 'o') THEN
     BEGIN
        /* unallocate order   - no plao */
        WK_ORDER = NEW.OBJECT;
        UPDATE PICK_ORDER 
           SET PICK_ORDER.PICK_PRIORITY = :WK_CO_WARN_PRIORITY
           WHERE PICK_ORDER.PICK_ORDER = :WK_ORDER; 
        UPDATE PICK_ITEM
           SET  
        /*   DEVICE_ID = :WK_DEVICE_TO, */
        /*   PICK_LINE_STATUS = 'OP', */
           PICK_LINE_PRIORITY = PICK_LINE_PRIORITY + NEW.QTY
           WHERE PICK_ORDER = :WK_ORDER
           AND DEVICE_ID = :WK_DEVICE_FROM;
        UPDATE PICK_LOCATION
        SET PICK_LOCATION_STATUS='CN'
        WHERE PICK_ORDER = :WK_ORDER
        AND   DEVICE_ID = :WK_DEVICE_FROM 
        AND PICK_LOCATION_STATUS = 'OP';
/* now unpick this order */
           EXECUTE PROCEDURE ADD_TRAN(
                    '  ',
                    '        ',
                    :WK_ORDER,
                    'PKCO',
                    'D',
                    :WK_DATE,
                    'Unpick for UnAllocate',
                    0,
                    'F',
                    '',
                    'MASTER',
                    0,
                    '          ',
                    'SSSSSSSSS',
                    :WK_USER,
                    :WK_DEVICE);
        EXECUTE PROCEDURE UPDATE_TRAN (WK_RECORD, 'T','Processed successfully');
     END
     /*
   EXECUTE PROCEDURE TRAN_ARCHIVE;
   */
  END
 END
END ^

CREATE TRIGGER ADD_TRANS4_SOURCE FOR TRANSACTIONS4 
ACTIVE BEFORE INSERT POSITION 0 
AS
BEGIN
   IF (NEW.TRN_CLASS = 'C') THEN
   BEGIN
      NEW.INPUT_SOURCE = NEW.INPUT_SOURCE || 'ss';
   END
END ^

CREATE TRIGGER RUN_TRANSACTION_PRCL FOR TRANSACTIONS4 
ACTIVE AFTER INSERT POSITION 1 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_DATA_FIELDS INTEGER;
DECLARE VARIABLE WK_FIELD_NO INTEGER;
DECLARE VARIABLE WK_WORK_DATA VARCHAR(1024);
DECLARE VARIABLE WK_WORK_LABEL VARCHAR(1024);
DECLARE VARIABLE WK_WORK_FIELD VARCHAR(1024);
DECLARE VARIABLE WK_ORDER VARCHAR(15);
DECLARE VARIABLE WK_STATUS VARCHAR(5);
BEGIN
   WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
   IF (WK_AUTORUN = 1) THEN
   BEGIN
      IF ((NEW.TRN_TYPE = 'PRCL') AND (NEW.TRN_CLASS = 'C')) THEN
      BEGIN
         /* 
            for the data fields must split out the labeltype of data
            and data portions after the first '>'
            field 1 is the order 
            field 2 is the print status 
         */
         WK_DATA_FIELDS = STRLEN(NEW.INPUT_SOURCE) ;
         WK_FIELD_NO = 1;
         WHILE (WK_FIELD_NO < WK_DATA_FIELDS) DO
         BEGIN
            SELECT WK_FIELD_TEXT 
            FROM GET_REFERENCE_FIELD4 (NEW.TRN_DATA, :WK_FIELD_NO, NEW.TRN_DELIMITER) 
            INTO :WK_WORK_FIELD;
            /* now for this field get the label and data */
            SELECT WK_FIELD_LABEL, WK_FIELD_DATA 
            FROM GET_DATA_REFERENCE_FIELD4 (:WK_WORK_FIELD, '>')
            INTO :WK_WORK_LABEL, :WK_WORK_DATA;

            IF (WK_WORK_LABEL = 'ContactInstanceID') THEN
            BEGIN
               WK_ORDER = WK_WORK_DATA;
            END
            IF (WK_WORK_LABEL = 'PrintStatus') THEN
            BEGIN
               WK_STATUS = WK_WORK_DATA;
            END
            WK_FIELD_NO = WK_FIELD_NO + 1;
         END
         IF (WK_STATUS = 'true') THEN
         BEGIN
            WK_STATUS = 'T';
         END
         ELSE
         BEGIN
            WK_STATUS = 'F';
         END
         UPDATE PICK_ORDER 
         SET PRINTED_DATE = NEW.TRN_DATE,
             PRINTED_STATUS = :WK_STATUS
         WHERE PICK_ORDER = :WK_ORDER;
         /* Update transactions table */        
         EXECUTE PROCEDURE UPDATE_TRAN4 (NEW.RECORD_ID, 'T', 'Processed successfully');
         EXECUTE PROCEDURE TRAN4_ARCHIVE;
      END
   END
END ^

CREATE TRIGGER RUN_TRANSACTION_GCLO FOR TRANSACTIONS4 
ACTIVE AFTER INSERT POSITION 2 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_DATA_FIELDS INTEGER;
DECLARE VARIABLE WK_FIELD_NO INTEGER;
DECLARE VARIABLE WK_WORK_DATA VARCHAR(1024);
DECLARE VARIABLE WK_WORK_LABEL VARCHAR(1024);
DECLARE VARIABLE WK_WORK_FIELD VARCHAR(1024);
DECLARE VARIABLE WK_WORK_END CHAR(1);
DECLARE VARIABLE WK_ORDER VARCHAR(15);
DECLARE VARIABLE WK_PROD_ID VARCHAR(30);
DECLARE VARIABLE WK_PROD VARCHAR(30);
DECLARE VARIABLE WK_EXTENSION VARCHAR(6);
DECLARE VARIABLE WK_QTY_X VARCHAR(10);
DECLARE VARIABLE WK_QTY INTEGER;
DECLARE VARIABLE WK_STATUS VARCHAR(5);
DECLARE VARIABLE WK_ORDER_STATUS VARCHAR(5);
DECLARE VARIABLE WK_FOUND INTEGER;
DECLARE VARIABLE WK_PICK_LABEL VARCHAR(7);
DECLARE VARIABLE WK_LABEL_LENGTH INTEGER;
DECLARE VARIABLE WK_LAST_LINE INTEGER;
DECLARE VARIABLE WK_LEN_LINE_NO INTEGER;
DECLARE VARIABLE WK_PICK_LINE_NO VARCHAR(4);
DECLARE VARIABLE WK_L_PICK_LINE_NO VARCHAR(4);
DECLARE VARIABLE WK_LINE_NO VARCHAR(4);
DECLARE VARIABLE WK_ORDER_TYPE CHAR(2);
DECLARE VARIABLE WK_TERM VARCHAR(20);
DECLARE VARIABLE WK_PAYMENT VARCHAR(20);
DECLARE VARIABLE WK_CARRIER VARCHAR(10);
DECLARE VARIABLE WK_DO_UASL CHAR(1);
DECLARE VARIABLE WK_DONTDO_LINE INTEGER;
DECLARE VARIABLE WK_PICK_STATUS CHAR(2);
BEGIN
   WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
   IF (WK_AUTORUN = 1) THEN
   BEGIN
      IF ((NEW.TRN_TYPE = 'GCLO') AND (NEW.TRN_CLASS = 'C')) THEN
      BEGIN
         /* 
            for the data fields must split out the labeltype of data
            and data portions after the first '>'
            field 1 is the order 
            field 2 is the product code (EAN)
            field 3 is the quantity 
            field 4 is the Extension (EAN Extension)
            field 5 is the retrieve status 
         */
/*         INSERT INTO LOG(DESCRIPTION) VALUES('GOT GCLO'); */
         WK_ORDER = '';
         WK_STATUS = '';
         WK_PROD = '';
         WK_QTY_X = '';
         WK_QTY = 0;
         WK_EXTENSION = '';
         WK_LINE_NO = '';
         WK_ORDER_TYPE = 'SO';
         /* WK_DATA_FIELDS = STRLEN(NEW.INPUT_SOURCE) ; */
         WK_FIELD_NO = 1;
         WK_WORK_END = 'F';
         /* WHILE (WK_FIELD_NO < WK_DATA_FIELDS) DO */
         WHILE (WK_WORK_END = 'F') DO
         BEGIN
            SELECT WK_FIELD_TEXT , WK_AT_END
            FROM GET_REFERENCE_FIELD4 (NEW.TRN_DATA, :WK_FIELD_NO, NEW.TRN_DELIMITER) 
            INTO :WK_WORK_FIELD, :WK_WORK_END;
            /* now for this field get the label and data */
            SELECT WK_FIELD_LABEL, WK_FIELD_DATA 
            FROM GET_DATA_REFERENCE_FIELD4 (:WK_WORK_FIELD, '>')
            INTO :WK_WORK_LABEL, :WK_WORK_DATA;

            IF (WK_WORK_LABEL = '<ContactInstanceID') THEN
            BEGIN
               WK_ORDER = WK_WORK_DATA;
/*         INSERT INTO LOG(DESCRIPTION) VALUES(:WK_ORDER); */
            END
            IF (WK_WORK_LABEL = '<EANNumber') THEN
            BEGIN
               WK_PROD = WK_WORK_DATA;
            END
            IF (WK_WORK_LABEL = '<Quantity') THEN
            BEGIN
               WK_QTY_X = WK_WORK_DATA;
               WK_QTY = CAST(WK_QTY_X AS INTEGER);
            END
            IF (WK_WORK_LABEL = '<EANExtension') THEN
            BEGIN
               WK_EXTENSION = WK_WORK_DATA;
            END
            IF (WK_WORK_LABEL = '<ContactInstanceRetrieveStatus') THEN
            BEGIN
               WK_STATUS = WK_WORK_DATA;
/*         INSERT INTO LOG(DESCRIPTION) VALUES('have status '); */
/*         INSERT INTO LOG(DESCRIPTION) VALUES(:WK_STATUS); */
            END
            WK_FIELD_NO = WK_FIELD_NO + 1;
         END
         IF (WK_STATUS = 'true') THEN
         BEGIN
            WK_STATUS = 'T';
         END
         ELSE
         BEGIN
            WK_STATUS = 'F';
         END
/*         INSERT INTO LOG(DESCRIPTION) VALUES('now status '); */
/*         INSERT INTO LOG(DESCRIPTION) VALUES(:WK_STATUS); */
         IF (WK_EXTENSION = '0') THEN
         BEGIN
            WK_EXTENSION = '';
         END
         /* get default values from control */
         SELECT DEFAULT_TERM, DEFAULT_PAYMENT_METHOD, DEFAULT_CARRIER_ID
         FROM CONTROL
         INTO :WK_TERM, :WK_PAYMENT, :WK_CARRIER;
         /* does order exist */
         WK_FOUND = 0;
         SELECT 1, PICK_RETRIEVE_STATUS, PICK_STATUS  FROM PICK_ORDER
         WHERE PICK_ORDER = :WK_ORDER
         INTO :WK_FOUND, :WK_ORDER_STATUS, :WK_PICK_STATUS;
         IF (WK_ORDER_STATUS IS NULL) THEN
         BEGIN
            WK_ORDER_STATUS = 'F';
         END
/*         INSERT INTO LOG(DESCRIPTION) VALUES('found '); */
/*         INSERT INTO LOG(DESCRIPTION) VALUES(:WK_FOUND); */

         IF (WK_FOUND = 0) THEN
         BEGIN
            IF (WK_STATUS = 'T') THEN
            BEGIN
               /* no order - so probably an urgent */
               WK_ORDER_STATUS = WK_STATUS;
               INSERT INTO PICK_ORDER(PICK_ORDER, 
                  PICK_STATUS, 
                  PICK_RETRIEVE_STATUS,
                  CREATE_DATE,
                  CREATED_BY,
                  PICK_ORDER_TYPE,
                  UPDATE_ID,
                  TERMS,
                  PAYMENT_METHOD,
                  SHIP_VIA,
                  APPROVED_DESP_DATE,
                  APPROVED_DATE)
               VALUES (:WK_ORDER, 
                  'DA', 
                  :WK_STATUS,
                  NEW.TRN_DATE,
                  NEW.PERSON_ID,
                  :WK_ORDER_TYPE,
                  NEW.MESSAGE_ID,
                  :WK_TERM,
                  :WK_PAYMENT,
                  :WK_CARRIER,
                  NEW.TRN_DATE,
                  NEW.TRN_DATE);
            END
            ELSE
            BEGIN
               /*
               INSERT INTO PICK_ORDER(PICK_ORDER, 
                  PICK_STATUS, 
                  PICK_RETRIEVE_STATUS, 
                  CREATE_DATE, 
                  CREATED_BY, 
                  PICK_ORDER_TYPE, 
                  UPDATE_ID,
                  TERMS,
                  PAYMENT_METHOD,
                  SHIP_VIA)
               VALUES (:WK_ORDER, 
                  'HD', 
                  :WK_STATUS , 
                  NEW.TRN_DATE, 
                  NEW.PERSON_ID, 
                  :WK_ORDER_TYPE , 
                  NEW.MESSAGE_ID ,
                  :WK_TERM,
                  :WK_PAYMENT,
                  :WK_CARRIER);
               */
               WK_ORDER_STATUS = WK_STATUS;
            END
         END
         ELSE
         BEGIN
            IF (WK_STATUS = 'F') THEN
            BEGIN
               UPDATE PICK_ORDER
               SET PICK_RETRIEVE_STATUS = :WK_STATUS,
                   UPDATE_ID = NEW.MESSAGE_ID
               WHERE PICK_ORDER = :WK_ORDER;
               WK_ORDER_STATUS = WK_STATUS;
            END
            ELSE
            BEGIN
               IF (WK_PICK_STATUS = 'HD') THEN
               BEGIN
                  UPDATE PICK_ORDER
                  SET PICK_RETRIEVE_STATUS = :WK_STATUS,
                      PICK_STATUS='DA',
                      UPDATE_ID = NEW.MESSAGE_ID,
                      APPROVED_DESP_DATE = NEW.TRN_DATE,
                      APPROVED_DATE = NEW.TRN_DATE
                  WHERE PICK_ORDER = :WK_ORDER;
               END
               ELSE
               BEGIN
                  UPDATE PICK_ORDER
                  SET PICK_RETRIEVE_STATUS = :WK_STATUS,
                      UPDATE_ID = NEW.MESSAGE_ID
                  WHERE PICK_ORDER = :WK_ORDER;
               END
            END
         END
         /* do line stuff */
         IF (WK_PROD = '') THEN
         BEGIN
            WK_PROD = 'NOPROD';
            IF (WK_QTY = 0) THEN
            BEGIN
               WK_QTY = 1;
            END
/*
            IF (WK_STATUS = 'F') THEN
            BEGIN
               WK_STATUS = 'T';
            END
*/
         END
         WK_DONTDO_LINE = 0;
         SELECT FIRST 1 1
         FROM PICK_ITEM
         WHERE PICK_LINE_STATUS NOT IN ('OP','UP')
           AND PICK_ORDER = :WK_ORDER
         INTO :WK_DONTDO_LINE;
         IF (WK_PICK_STATUS = 'CN') THEN
         BEGIN
            WK_DONTDO_LINE = 0;
         END
         IF (WK_DONTDO_LINE = 0) THEN
         BEGIN
            IF (WK_PROD > '') THEN
            BEGIN
               EXECUTE PROCEDURE ADD_PICK_ITEMS (
                  WK_ORDER ,
                  WK_ORDER_STATUS ,
                  WK_STATUS ,
                  WK_PROD ,
                  WK_EXTENSION ,
                  WK_LINE_NO ,
                  WK_QTY ,
                  NEW.TRN_DATE ,
                  NEW.PERSON_ID ,
                  0 );
               /* send uasl for product */
               SELECT SEND_UASL_V4 FROM CONTROL INTO :WK_DO_UASL;
               IF (WK_DO_UASL = 'T') THEN
               BEGIN
                  IF (WK_STATUS = 'T') THEN
                  BEGIN
                     EXECUTE PROCEDURE SEND_PICKABLE_STOCK (:WK_PROD,
                        NEW.PERSON_ID,
                        NEW.DEVICE_ID,
                        NEW.TRN_DATE);
                  END
               END
            END
         END

         /* Update transactions table */        
         EXECUTE PROCEDURE UPDATE_TRAN4 (NEW.RECORD_ID, 'T', 'Processed successfully');
         EXECUTE PROCEDURE TRAN4_ARCHIVE;
      END
      ELSE
      IF ((NEW.TRN_TYPE = 'GCLO') AND (NEW.TRN_CLASS = 'S')) THEN
      BEGIN
         /* 
            for the data fields must split out the labeltype of data
            and data portions after the first '>'
            field 1 is the order 
         */
         WK_ORDER = '';
         WK_ORDER_TYPE = 'SO';
         WK_DATA_FIELDS = STRLEN(NEW.INPUT_SOURCE) ;
         WK_FIELD_NO = 1;
         WHILE (WK_FIELD_NO < WK_DATA_FIELDS) DO
         BEGIN
            SELECT WK_FIELD_TEXT 
            FROM GET_REFERENCE_FIELD4 (NEW.TRN_DATA, :WK_FIELD_NO, NEW.TRN_DELIMITER) 
            INTO :WK_WORK_FIELD;
            /* now for this field get the label and data */
            SELECT WK_FIELD_LABEL, WK_FIELD_DATA 
            FROM GET_DATA_REFERENCE_FIELD4 (:WK_WORK_FIELD, '>')
            INTO :WK_WORK_LABEL, :WK_WORK_DATA;

            IF (WK_WORK_LABEL = '<ContactInstanceID') THEN
            BEGIN
               WK_ORDER = WK_WORK_DATA;
            END
            WK_FIELD_NO = WK_FIELD_NO + 1;
         END
         UPDATE PICK_ITEM
            SET PICK_ORDER_QTY = 0
         WHERE PICK_ORDER = :WK_ORDER
            AND (PICK_LINE_STATUS IN ('UC','CF','OP','UP')
              OR PICK_LINE_STATUS IS NULL);
      END
   END
END ^

CREATE TRIGGER RUN_TRANSACTION_UCIS FOR TRANSACTIONS4 
ACTIVE AFTER INSERT POSITION 3 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_DATA_FIELDS INTEGER;
DECLARE VARIABLE WK_FIELD_NO INTEGER;
DECLARE VARIABLE WK_WORK_DATA VARCHAR(1024);
DECLARE VARIABLE WK_WORK_LABEL VARCHAR(1024);
DECLARE VARIABLE WK_WORK_FIELD VARCHAR(1024);
DECLARE VARIABLE WK_ORDER VARCHAR(15);
DECLARE VARIABLE WK_STATUS VARCHAR(5);
DECLARE VARIABLE WK_ORDER_STATUS VARCHAR(5);
DECLARE VARIABLE WK_FOUND INTEGER;
BEGIN
   WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
   IF (WK_AUTORUN = 1) THEN
   BEGIN
      IF ((NEW.TRN_TYPE = 'UCIS') AND (NEW.TRN_CLASS = 'C')) THEN
      BEGIN
         /* 
            for the data fields must split out the labeltype of data
            and data portions after the first '>'
            field 1 is the order 
            field 2 is the retrieve status 
         */
         WK_ORDER = '';
         WK_STATUS = '';
         WK_DATA_FIELDS = STRLEN(NEW.INPUT_SOURCE) ;
         WK_FIELD_NO = 1;
         WHILE (WK_FIELD_NO < WK_DATA_FIELDS) DO
         BEGIN
            SELECT WK_FIELD_TEXT 
            FROM GET_REFERENCE_FIELD4 (NEW.TRN_DATA, :WK_FIELD_NO, NEW.TRN_DELIMITER) 
            INTO :WK_WORK_FIELD;
            /* now for this field get the label and data */
            SELECT WK_FIELD_LABEL, WK_FIELD_DATA 
            FROM GET_DATA_REFERENCE_FIELD4 (:WK_WORK_FIELD, '>')
            INTO :WK_WORK_LABEL, :WK_WORK_DATA;

            IF (WK_WORK_LABEL = '<ContactInstanceID') THEN
            BEGIN
               WK_ORDER = WK_WORK_DATA;
            END
            IF (WK_WORK_LABEL = '<UpdateContactInstanceStatus') THEN
            BEGIN
               WK_STATUS = WK_WORK_DATA;
            END
            WK_FIELD_NO = WK_FIELD_NO + 1;
         END
         IF (WK_STATUS = 'true') THEN
         BEGIN
            WK_STATUS = 'T';
         END
         ELSE
         BEGIN
            WK_STATUS = 'F';
         END
         /* does order exist */
         WK_FOUND = 0;
         SELECT 1, PICK_RETRIEVE_STATUS  FROM PICK_ORDER
         WHERE PICK_ORDER = :WK_ORDER
         INTO :WK_FOUND, :WK_ORDER_STATUS;
         IF (WK_ORDER_STATUS IS NULL) THEN
         BEGIN
            WK_ORDER_STATUS = 'F';
         END
         IF (WK_FOUND = 0) THEN
         BEGIN
            IF (WK_STATUS = 'T') THEN
            BEGIN
               /* no order - so probably an urgent */
               INSERT INTO PICK_ORDER(PICK_ORDER, PICK_STATUS, PICK_RETRIEVE_STATUS)
               VALUES (:WK_ORDER, 'DA', :WK_STATUS );
               WK_ORDER_STATUS = WK_STATUS;
            END
            ELSE
            BEGIN
               INSERT INTO PICK_ORDER(PICK_ORDER, PICK_STATUS, PICK_RETRIEVE_STATUS)
               VALUES (:WK_ORDER, 'DA', :WK_STATUS );
               WK_ORDER_STATUS = WK_STATUS;
            END
         END
         ELSE
         BEGIN
            IF (WK_STATUS = 'F') THEN
            BEGIN
               /* SET PICK_STATUS='HD', */
               UPDATE PICK_ORDER
               SET PICK_RETRIEVE_STATUS = :WK_STATUS
               WHERE PICK_ORDER = :WK_ORDER;
               WK_ORDER_STATUS = WK_STATUS;
            END
         END
         /* if the status changed to true must recalc the orders retrieve status */
         IF ((WK_STATUS = 'T') AND (WK_ORDER_STATUS = 'F')) THEN
         BEGIN
            WK_FOUND = 0;
            SELECT FIRST 1 1
            FROM PICK_ITEM 
            WHERE PICK_ORDER = :WK_ORDER
              AND (PICK_LINE_STATUS IN ('UC','CF','OP')
              OR PICK_LINE_STATUS IS NULL)
              AND (PICK_RETRIEVE_STATUS = 'F'
              OR PICK_RETRIEVE_STATUS IS NULL)
            INTO :WK_FOUND;
            IF (WK_FOUND = 0) THEN
            BEGIN
               /* have no more failures */
               UPDATE PICK_ORDER
               SET PICK_STATUS='DA',
                   PICK_RETRIEVE_STATUS = :WK_STATUS
               WHERE PICK_ORDER = :WK_ORDER;
            END
         END

         /* Update transactions table */        
         EXECUTE PROCEDURE UPDATE_TRAN4 (NEW.RECORD_ID, 'T', 'Processed successfully');
         EXECUTE PROCEDURE TRAN4_ARCHIVE;
      END
   END
END ^

CREATE TRIGGER RUN_TRANSACTION_UASL FOR TRANSACTIONS4 
ACTIVE AFTER INSERT POSITION 4 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_DATA_FIELDS INTEGER;
DECLARE VARIABLE WK_FIELD_NO INTEGER;
DECLARE VARIABLE WK_WORK_DATA VARCHAR(1024);
DECLARE VARIABLE WK_WORK_LABEL VARCHAR(1024);
DECLARE VARIABLE WK_WORK_FIELD VARCHAR(1024);
DECLARE VARIABLE WK_PROD_ID VARCHAR(30);
DECLARE VARIABLE WK_PROD VARCHAR(30);
DECLARE VARIABLE WK_EXTENSION VARCHAR(6);
DECLARE VARIABLE WK_STATUS VARCHAR(5);
DECLARE VARIABLE WK_FOUND INTEGER;
BEGIN
   WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
   IF (WK_AUTORUN = 1) THEN
   BEGIN
      IF ((NEW.TRN_TYPE = 'UASL') AND (NEW.TRN_CLASS = 'C')) THEN
      BEGIN
         /* 
            for the data fields must split out the labeltype of data
            and data portions after the first '>'
            field 1 is the product code (EAN)
            field 2 is the Extension (EAN Extension)
            field 3 is the retrieve status 
         */
         WK_STATUS = '';
         WK_PROD = 'NOPROD';
         WK_EXTENSION = '';
         WK_DATA_FIELDS = STRLEN(NEW.INPUT_SOURCE) ;
         WK_FIELD_NO = 1;
         WHILE (WK_FIELD_NO < WK_DATA_FIELDS) DO
         BEGIN
            SELECT WK_FIELD_TEXT 
            FROM GET_REFERENCE_FIELD4 (NEW.TRN_DATA, :WK_FIELD_NO, NEW.TRN_DELIMITER) 
            INTO :WK_WORK_FIELD;
            /* now for this field get the label and data */
            SELECT WK_FIELD_LABEL, WK_FIELD_DATA 
            FROM GET_DATA_REFERENCE_FIELD4 (:WK_WORK_FIELD, '>')
            INTO :WK_WORK_LABEL, :WK_WORK_DATA;

            IF (WK_WORK_LABEL = '<EANNumber') THEN
            BEGIN
               WK_PROD = WK_WORK_DATA;
            END
            IF (WK_WORK_LABEL = '<EANextension') THEN
            BEGIN
               WK_EXTENSION = WK_WORK_DATA;
            END
            IF (WK_WORK_LABEL = '<UpdateAvailableStock') THEN
            BEGIN
               WK_STATUS = WK_WORK_DATA;
            END
            WK_FIELD_NO = WK_FIELD_NO + 1;
         END
         IF (WK_STATUS = 'true') THEN
         BEGIN
            WK_STATUS = 'T';
         END
         ELSE
         BEGIN
            WK_STATUS = 'F';
         END
         WK_PROD_ID = WK_PROD || WK_EXTENSION;
         /* does product exist */
         WK_FOUND = 0;
         SELECT 1 FROM PROD_PROFILE
         WHERE PROD_ID = :WK_PROD_ID
         INTO :WK_FOUND;
         IF (WK_FOUND = 0) THEN
         BEGIN
            /* no prod profile - so create a dummy */
            INSERT INTO PROD_PROFILE(PROD_ID, SHORT_DESC, PROD_RETRIEVE_STATUS )
            VALUES (:WK_PROD_ID, :WK_PROD_ID, :WK_STATUS);
         END
         ELSE
         BEGIN
            UPDATE PROD_PROFILE 
            SET PROD_RETRIEVE_STATUS = :WK_STATUS
            WHERE PROD_ID = :WK_PROD_ID;
         END
         WK_FOUND = 0;
         SELECT 1 FROM PROD_EAN
         WHERE PROD_EAN = :WK_PROD AND 
               PROD_EAN_EXTENSION = :WK_EXTENSION
         INTO :WK_FOUND;
         IF (WK_FOUND = 0) THEN
         BEGIN
            /* no prod ean - so create one */
            INSERT INTO PROD_EAN(PROD_ID, PROD_EAN, PROD_EAN_EXTENSION)
            VALUES (:WK_PROD_ID, :WK_PROD, :WK_EXTENSION);
         END

         /* Update transactions table */        
         EXECUTE PROCEDURE UPDATE_TRAN4 (NEW.RECORD_ID, 'T', 'Processed successfully');
         EXECUTE PROCEDURE TRAN4_ARCHIVE;
      END
   END
END ^

CREATE TRIGGER RUN_TRANSACTION_GLPP FOR TRANSACTIONS4 
ACTIVE AFTER INSERT POSITION 5 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_DATA_FIELDS INTEGER;
DECLARE VARIABLE WK_FIELD_NO INTEGER;
DECLARE VARIABLE WK_WORK_DATA VARCHAR(1024);
DECLARE VARIABLE WK_WORK_LABEL VARCHAR(1024);
DECLARE VARIABLE WK_WORK_FIELD VARCHAR(1024);
DECLARE VARIABLE WK_PROD_ID VARCHAR(30);
DECLARE VARIABLE WK_CHILD_PROD_ID VARCHAR(30);
DECLARE VARIABLE WK_PARENT_PROD VARCHAR(30);
DECLARE VARIABLE WK_PARENT_EXTENSION VARCHAR(6);
DECLARE VARIABLE WK_CHILD1_PROD VARCHAR(30);
DECLARE VARIABLE WK_CHILD1_EXTENSION VARCHAR(6);
DECLARE VARIABLE WK_QTY_X VARCHAR(10);
DECLARE VARIABLE WK_CHILD1_QTY INTEGER;
DECLARE VARIABLE WK_CHILD2_PROD VARCHAR(30);
DECLARE VARIABLE WK_CHILD2_EXTENSION VARCHAR(6);
DECLARE VARIABLE WK_CHILD2_QTY INTEGER;
DECLARE VARIABLE WK_CHILD3_PROD VARCHAR(30);
DECLARE VARIABLE WK_CHILD3_EXTENSION VARCHAR(6);
DECLARE VARIABLE WK_CHILD3_QTY INTEGER;
DECLARE VARIABLE WK_CHILD4_PROD VARCHAR(30);
DECLARE VARIABLE WK_CHILD4_EXTENSION VARCHAR(6);
DECLARE VARIABLE WK_CHILD4_QTY INTEGER;
DECLARE VARIABLE WK_CHILD5_PROD VARCHAR(30);
DECLARE VARIABLE WK_CHILD5_EXTENSION VARCHAR(6);
DECLARE VARIABLE WK_CHILD5_QTY INTEGER;
DECLARE VARIABLE WK_CHILD6_PROD VARCHAR(30);
DECLARE VARIABLE WK_CHILD6_EXTENSION VARCHAR(6);
DECLARE VARIABLE WK_CHILD6_QTY INTEGER;
DECLARE VARIABLE WK_CHILD7_PROD VARCHAR(30);
DECLARE VARIABLE WK_CHILD7_EXTENSION VARCHAR(6);
DECLARE VARIABLE WK_CHILD7_QTY INTEGER;
DECLARE VARIABLE WK_CHILD8_PROD VARCHAR(30);
DECLARE VARIABLE WK_CHILD8_EXTENSION VARCHAR(6);
DECLARE VARIABLE WK_CHILD8_QTY INTEGER;
DECLARE VARIABLE WK_CHILD9_PROD VARCHAR(30);
DECLARE VARIABLE WK_CHILD9_EXTENSION VARCHAR(6);
DECLARE VARIABLE WK_CHILD9_QTY INTEGER;
DECLARE VARIABLE WK_CHILD10_PROD VARCHAR(30);
DECLARE VARIABLE WK_CHILD10_EXTENSION VARCHAR(6);
DECLARE VARIABLE WK_CHILD10_QTY INTEGER;
DECLARE VARIABLE WK_CHILD_NO INTEGER;
DECLARE VARIABLE WK_STATUS VARCHAR(5);
DECLARE VARIABLE WK_FOUND INTEGER;
DECLARE VARIABLE WK_KIT_MESSAGE VARCHAR(10);
DECLARE VARIABLE WK_RES INTEGER;
DECLARE VARIABLE WK_WORK_END CHAR(1);
DECLARE VARIABLE WK_PROD_DESC VARCHAR(50);
BEGIN
   WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
   IF (WK_AUTORUN = 1) THEN
   BEGIN
      IF ((NEW.TRN_TYPE = 'GLPP') AND (NEW.TRN_CLASS = 'C')) THEN
      BEGIN
         /* 
            for the data fields must split out the labeltype of data
            and data portions after the first '>'
            field 1 is the parent product code (EAN)
            field 2 is the parent Extension (EAN Extension)
            upto 10 child prod groups
            field 3 is the child product code (EAN)
            field 4 is the child Extension (EAN Extension)
            field 5 is the child Quantity 
            field 6 is the child product code (EAN)
            field 7 is the child Extension (EAN Extension)
            field 8 is the child Quantity 
            field 9 is the child product code (EAN)
            field 10 is the child Extension (EAN Extension)
            field 11 is the child Quantity 
            field 12 is the child product code (EAN)
            field 13 is the child Extension (EAN Extension)
            field 14 is the child Quantity 
            field 15 is the child product code (EAN)
            field 16 is the child Extension (EAN Extension)
            field 17 is the child Quantity 
            field 18 is the child product code (EAN)
            field 19 is the child Extension (EAN Extension)
            field 20 is the child Quantity 
            field 21 is the child product code (EAN)
            field 22 is the child Extension (EAN Extension)
            field 23 is the child Quantity 
            field 24 is the child product code (EAN)
            field 25 is the child Extension (EAN Extension)
            field 26 is the child Quantity 
            field 27 is the child product code (EAN)
            field 28 is the child Extension (EAN Extension)
            field 29 is the child Quantity 
            field 30 is the child product code (EAN)
            field 31 is the child Extension (EAN Extension)
            field 32 is the child Quantity 
            field 33 is the retrieve status 
         */
         WK_STATUS = '';
         WK_PARENT_PROD = 'NOPROD';
         WK_PARENT_EXTENSION = '';
         WK_CHILD1_PROD = '';
         WK_CHILD1_EXTENSION = '';
         WK_CHILD1_QTY = 1;
         WK_CHILD2_PROD = '';
         WK_CHILD2_EXTENSION = '';
         WK_CHILD2_QTY = 1;
         WK_CHILD3_PROD = '';
         WK_CHILD3_EXTENSION = '';
         WK_CHILD3_QTY = 1;
         WK_CHILD4_PROD = '';
         WK_CHILD4_EXTENSION = '';
         WK_CHILD4_QTY = 1;
         WK_CHILD5_PROD = '';
         WK_CHILD5_EXTENSION = '';
         WK_CHILD5_QTY = 1;
         WK_CHILD6_PROD = '';
         WK_CHILD6_EXTENSION = '';
         WK_CHILD6_QTY = 1;
         WK_CHILD7_PROD = '';
         WK_CHILD7_EXTENSION = '';
         WK_CHILD7_QTY = 1;
         WK_CHILD8_PROD = '';
         WK_CHILD8_EXTENSION = '';
         WK_CHILD8_QTY = 1;
         WK_CHILD9_PROD = '';
         WK_CHILD9_EXTENSION = '';
         WK_CHILD9_QTY = 1;
         WK_CHILD10_PROD = '';
         WK_CHILD10_EXTENSION = '';
         WK_CHILD10_QTY = 1;
         /* WK_DATA_FIELDS = STRLEN(NEW.INPUT_SOURCE) ; */
         WK_FIELD_NO = 1;
         WK_WORK_END = 'F';
         /* WHILE (WK_FIELD_NO < WK_DATA_FIELDS) DO */
         WHILE (WK_WORK_END = 'F') DO
         BEGIN
            SELECT WK_FIELD_TEXT , WK_AT_END
            FROM GET_REFERENCE_FIELD4 (NEW.TRN_DATA, :WK_FIELD_NO, NEW.TRN_DELIMITER) 
            INTO :WK_WORK_FIELD, :WK_WORK_END;
            /* now for this field get the label and data */
            SELECT WK_FIELD_LABEL, WK_FIELD_DATA 
            FROM GET_DATA_REFERENCE_FIELD4 (:WK_WORK_FIELD, '>')
            INTO :WK_WORK_LABEL, :WK_WORK_DATA;

            IF (WK_WORK_LABEL = '<ParentEANNumber') THEN
            BEGIN
               WK_PARENT_PROD = WK_WORK_DATA;
               WK_CHILD_NO = 0;
            END
            IF (WK_WORK_LABEL = '<ParentEANextension') THEN
            BEGIN
               WK_PARENT_EXTENSION = WK_WORK_DATA;
            END
            IF (WK_WORK_LABEL = '<ChildEANnumber') THEN
            BEGIN
               WK_CHILD_NO = WK_CHILD_NO + 1;
               IF (WK_CHILD_NO = 1) THEN
               BEGIN
                  WK_CHILD1_PROD = WK_WORK_DATA;
               END
               ELSE
               IF (WK_CHILD_NO = 2) THEN
               BEGIN
                  WK_CHILD2_PROD = WK_WORK_DATA;
               END
               ELSE
               IF (WK_CHILD_NO = 3) THEN
               BEGIN
                  WK_CHILD3_PROD = WK_WORK_DATA;
               END
               ELSE
               IF (WK_CHILD_NO = 4) THEN
               BEGIN
                  WK_CHILD4_PROD = WK_WORK_DATA;
               END
               ELSE
               IF (WK_CHILD_NO = 5) THEN
               BEGIN
                  WK_CHILD5_PROD = WK_WORK_DATA;
               END
               ELSE
               IF (WK_CHILD_NO = 6) THEN
               BEGIN
                  WK_CHILD6_PROD = WK_WORK_DATA;
               END
               ELSE
               IF (WK_CHILD_NO = 7) THEN
               BEGIN
                  WK_CHILD7_PROD = WK_WORK_DATA;
               END
               ELSE
               IF (WK_CHILD_NO = 8) THEN
               BEGIN
                  WK_CHILD8_PROD = WK_WORK_DATA;
               END
               ELSE
               IF (WK_CHILD_NO = 9) THEN
               BEGIN
                  WK_CHILD9_PROD = WK_WORK_DATA;
               END
               ELSE
               IF (WK_CHILD_NO = 10) THEN
               BEGIN
                  WK_CHILD10_PROD = WK_WORK_DATA;
               END
            END
            IF (WK_WORK_LABEL = '<ChildEANextension') THEN
            BEGIN
               IF (WK_CHILD_NO = 1) THEN
                  WK_CHILD1_EXTENSION = WK_WORK_DATA;
               ELSE
               IF (WK_CHILD_NO = 2) THEN
                  WK_CHILD2_EXTENSION = WK_WORK_DATA;
               ELSE
               IF (WK_CHILD_NO = 3) THEN
                  WK_CHILD3_EXTENSION = WK_WORK_DATA;
               ELSE
               IF (WK_CHILD_NO = 4) THEN
                  WK_CHILD4_EXTENSION = WK_WORK_DATA;
               ELSE
               IF (WK_CHILD_NO = 5) THEN
                  WK_CHILD5_EXTENSION = WK_WORK_DATA;
               ELSE
               IF (WK_CHILD_NO = 6) THEN
                  WK_CHILD6_EXTENSION = WK_WORK_DATA;
               ELSE
               IF (WK_CHILD_NO = 7) THEN
                  WK_CHILD7_EXTENSION = WK_WORK_DATA;
               ELSE
               IF (WK_CHILD_NO = 8) THEN
                  WK_CHILD8_EXTENSION = WK_WORK_DATA;
               ELSE
               IF (WK_CHILD_NO = 9) THEN
                  WK_CHILD9_EXTENSION = WK_WORK_DATA;
               ELSE
               IF (WK_CHILD_NO = 10) THEN
                  WK_CHILD10_EXTENSION = WK_WORK_DATA;
            END
            IF (WK_WORK_LABEL = '<ChildQuantity') THEN
            BEGIN
               WK_QTY_X = WK_WORK_DATA;
               IF (WK_CHILD_NO = 1) THEN
                  WK_CHILD1_QTY = CAST(WK_QTY_X AS INTEGER);
               ELSE
               IF (WK_CHILD_NO = 2) THEN
                  WK_CHILD2_QTY = CAST(WK_QTY_X AS INTEGER);
               ELSE
               IF (WK_CHILD_NO = 3) THEN
                  WK_CHILD3_QTY = CAST(WK_QTY_X AS INTEGER);
               ELSE
               IF (WK_CHILD_NO = 4) THEN
                  WK_CHILD4_QTY = CAST(WK_QTY_X AS INTEGER);
               ELSE
               IF (WK_CHILD_NO = 5) THEN
                  WK_CHILD5_QTY = CAST(WK_QTY_X AS INTEGER);
               ELSE
               IF (WK_CHILD_NO = 6) THEN
                  WK_CHILD6_QTY = CAST(WK_QTY_X AS INTEGER);
               ELSE
               IF (WK_CHILD_NO = 7) THEN
                  WK_CHILD7_QTY = CAST(WK_QTY_X AS INTEGER);
               ELSE
               IF (WK_CHILD_NO = 8) THEN
                  WK_CHILD8_QTY = CAST(WK_QTY_X AS INTEGER);
               ELSE
               IF (WK_CHILD_NO = 9) THEN
                  WK_CHILD9_QTY = CAST(WK_QTY_X AS INTEGER);
               ELSE
               IF (WK_CHILD_NO = 10) THEN
                  WK_CHILD10_QTY = CAST(WK_QTY_X AS INTEGER);
            END
            IF (WK_WORK_LABEL = '<ParentRetrievePrePackStatus') THEN
            BEGIN
               WK_STATUS = WK_WORK_DATA;
            END
            WK_FIELD_NO = WK_FIELD_NO + 1;
         END
         IF (WK_STATUS = 'true') THEN
         BEGIN
            WK_STATUS = 'T';
         END
         ELSE
         BEGIN
            WK_STATUS = 'F';
         END
         IF (WK_PARENT_EXTENSION = '0') THEN
         BEGIN
            WK_PARENT_EXTENSION = '';
         END
         IF (WK_CHILD1_EXTENSION = '0') THEN
         BEGIN
            WK_CHILD1_EXTENSION = '';
         END
         IF (WK_CHILD2_EXTENSION = '0') THEN
         BEGIN
            WK_CHILD2_EXTENSION = '';
         END
         IF (WK_CHILD3_EXTENSION = '0') THEN
         BEGIN
            WK_CHILD3_EXTENSION = '';
         END
         IF (WK_CHILD4_EXTENSION = '0') THEN
         BEGIN
            WK_CHILD4_EXTENSION = '';
         END
         IF (WK_CHILD5_EXTENSION = '0') THEN
         BEGIN
            WK_CHILD5_EXTENSION = '';
         END
         IF (WK_CHILD6_EXTENSION = '0') THEN
         BEGIN
            WK_CHILD6_EXTENSION = '';
         END
         IF (WK_CHILD7_EXTENSION = '0') THEN
         BEGIN
            WK_CHILD7_EXTENSION = '';
         END
         IF (WK_CHILD8_EXTENSION = '0') THEN
         BEGIN
            WK_CHILD8_EXTENSION = '';
         END
         IF (WK_CHILD9_EXTENSION = '0') THEN
         BEGIN
            WK_CHILD9_EXTENSION = '';
         END
         IF (WK_CHILD10_EXTENSION = '0') THEN
         BEGIN
            WK_CHILD10_EXTENSION = '';
         END
         WK_PROD_ID = WK_PARENT_PROD || WK_PARENT_EXTENSION;
         /* does product exist */
         WK_FOUND = 0;
         SELECT 1 FROM PROD_PROFILE
         WHERE PROD_ID = :WK_PROD_ID
         INTO :WK_FOUND;
         IF (WK_FOUND = 0) THEN
         BEGIN
            /* no prod profile - so create a dummy */
            INSERT INTO PROD_PROFILE(PROD_ID, SHORT_DESC, PROD_RETRIEVE_STATUS )
            VALUES (:WK_PROD_ID, :WK_PROD_ID, :WK_STATUS);
            WK_PROD_DESC = WK_PROD_ID;
         END
         ELSE
         BEGIN
            UPDATE PROD_PROFILE 
            SET PROD_RETRIEVE_STATUS = :WK_STATUS
            WHERE PROD_ID = :WK_PROD_ID;
            SELECT SHORT_DESC  FROM PROD_PROFILE
            WHERE PROD_ID = :WK_PROD_ID
            INTO :WK_PROD_DESC;
         END
         WK_FOUND = 0;
         SELECT 1 FROM PROD_EAN
         WHERE PROD_EAN = :WK_PARENT_PROD AND 
               PROD_EAN_EXTENSION = :WK_PARENT_EXTENSION
         INTO :WK_FOUND;
         IF (WK_FOUND = 0) THEN
         BEGIN
            /* no prod ean - so create one */
            INSERT INTO PROD_EAN(PROD_ID, PROD_EAN, PROD_EAN_EXTENSION)
            VALUES (:WK_PROD_ID, :WK_PARENT_PROD, :WK_PARENT_EXTENSION);
         END
         /* check kit exists */
         WK_FOUND = 0;
         SELECT 1, UPDATE_ID
         FROM KIT
         WHERE KIT_ID = :WK_PROD_ID
         INTO :WK_FOUND, :WK_KIT_MESSAGE;
         IF (WK_FOUND = 0) THEN
         BEGIN
            /* no kit - so create a dummy */
            /* VALUES (:WK_PROD_ID, :WK_PROD_ID, NEW.PERSON_ID, NEW.TRN_DATE, NEW.MESSAGE_ID); */
            INSERT INTO KIT(KIT_ID, DESCRIPTION, CREATED_BY, CREATED_DATE, UPDATE_ID )
            VALUES (:WK_PROD_ID, :WK_PROD_DESC, NEW.PERSON_ID, NEW.TRN_DATE, NEW.MESSAGE_ID);
/*
            DELETE FROM PRODUCT_KIT
            WHERE KIT_ID = :WK_PROD_ID;
*/
            UPDATE PRODUCT_KIT SET STATUS = 'NC'
            WHERE KIT_ID = :WK_PROD_ID;
         END
         ELSE
         BEGIN
            /* kit already exists */
            IF (WK_KIT_MESSAGE  IS NULL) THEN
            BEGIN
               WK_KIT_MESSAGE = '';
            END
            IF (WK_KIT_MESSAGE = NEW.MESSAGE_ID) THEN
            BEGIN
               WK_FOUND = 2;
               UPDATE KIT 
               SET DESCRIPTION = :WK_PROD_DESC
               WHERE KIT_ID = :WK_PROD_ID;
            END
            ELSE
            BEGIN
/*             
               DELETE FROM PRODUCT_KIT
               WHERE KIT_ID = :WK_PROD_ID;
*/
               UPDATE PRODUCT_KIT SET STATUS = 'NC'
               WHERE KIT_ID = :WK_PROD_ID;
               
               UPDATE KIT 
               SET UPDATE_ID = NEW.MESSAGE_ID,
               DESCRIPTION = :WK_PROD_DESC
               WHERE KIT_ID = :WK_PROD_ID;
            END
         END
         /* check child1 product kit exists */
         IF (WK_CHILD1_PROD > '') THEN
         BEGIN
            EXECUTE PROCEDURE ADD_CHILD_KIT (WK_CHILD1_PROD ,
               WK_CHILD1_EXTENSION ,
               WK_STATUS ,
               WK_PROD_ID ,
               WK_CHILD1_QTY ,
               NEW.PERSON_ID ,
               NEW.TRN_DATE );
         END
         /* check child2 product kit exists */
         IF (WK_CHILD2_PROD > '') THEN
         BEGIN
            EXECUTE PROCEDURE ADD_CHILD_KIT (WK_CHILD2_PROD ,
               WK_CHILD2_EXTENSION ,
               WK_STATUS ,
               WK_PROD_ID ,
               WK_CHILD2_QTY ,
               NEW.PERSON_ID ,
               NEW.TRN_DATE );
         END
         /* check child3 product kit exists */
         IF (WK_CHILD3_PROD > '') THEN
         BEGIN
            EXECUTE PROCEDURE ADD_CHILD_KIT (WK_CHILD3_PROD ,
               WK_CHILD3_EXTENSION ,
               WK_STATUS ,
               WK_PROD_ID ,
               WK_CHILD3_QTY ,
               NEW.PERSON_ID ,
               NEW.TRN_DATE );
         END
         /* check child4 product kit exists */
         IF (WK_CHILD1_PROD > '') THEN
         BEGIN
            EXECUTE PROCEDURE ADD_CHILD_KIT (WK_CHILD4_PROD ,
               WK_CHILD4_EXTENSION ,
               WK_STATUS ,
               WK_PROD_ID ,
               WK_CHILD4_QTY ,
               NEW.PERSON_ID ,
               NEW.TRN_DATE );
         END
         /* check child5 product kit exists */
         IF (WK_CHILD5_PROD > '') THEN
         BEGIN
            EXECUTE PROCEDURE ADD_CHILD_KIT (WK_CHILD5_PROD ,
               WK_CHILD5_EXTENSION ,
               WK_STATUS ,
               WK_PROD_ID ,
               WK_CHILD5_QTY ,
               NEW.PERSON_ID ,
               NEW.TRN_DATE );
         END
         /* check child6 product kit exists */
         IF (WK_CHILD6_PROD > '') THEN
         BEGIN
            EXECUTE PROCEDURE ADD_CHILD_KIT (WK_CHILD6_PROD ,
               WK_CHILD6_EXTENSION ,
               WK_STATUS ,
               WK_PROD_ID ,
               WK_CHILD6_QTY ,
               NEW.PERSON_ID ,
               NEW.TRN_DATE );
         END
         /* check child7 product kit exists */
         IF (WK_CHILD7_PROD > '') THEN
         BEGIN
            EXECUTE PROCEDURE ADD_CHILD_KIT (WK_CHILD7_PROD ,
               WK_CHILD7_EXTENSION ,
               WK_STATUS ,
               WK_PROD_ID ,
               WK_CHILD7_QTY ,
               NEW.PERSON_ID ,
               NEW.TRN_DATE );
         END
         /* check child8 product kit exists */
         IF (WK_CHILD8_PROD > '') THEN
         BEGIN
            EXECUTE PROCEDURE ADD_CHILD_KIT (WK_CHILD8_PROD ,
               WK_CHILD8_EXTENSION ,
               WK_STATUS ,
               WK_PROD_ID ,
               WK_CHILD8_QTY ,
               NEW.PERSON_ID ,
               NEW.TRN_DATE );
         END
         /* check child9 product kit exists */
         IF (WK_CHILD9_PROD > '') THEN
         BEGIN
            EXECUTE PROCEDURE ADD_CHILD_KIT (WK_CHILD9_PROD ,
               WK_CHILD9_EXTENSION ,
               WK_STATUS ,
               WK_PROD_ID ,
               WK_CHILD9_QTY ,
               NEW.PERSON_ID ,
               NEW.TRN_DATE );
         END
         /* check child10 product kit exists */
         IF (WK_CHILD10_PROD > '') THEN
         BEGIN
            EXECUTE PROCEDURE ADD_CHILD_KIT (WK_CHILD10_PROD ,
               WK_CHILD10_EXTENSION ,
               WK_STATUS ,
               WK_PROD_ID ,
               WK_CHILD10_QTY ,
               NEW.PERSON_ID ,
               NEW.TRN_DATE );
         END

         /* Update transactions table */        
         EXECUTE PROCEDURE UPDATE_TRAN4 (NEW.RECORD_ID, 'T', 'Processed successfully');
         EXECUTE PROCEDURE TRAN4_ARCHIVE;
      END
   END
END ^

CREATE TRIGGER RUN_TRANSACTION_GLTD FOR TRANSACTIONS4 
ACTIVE AFTER INSERT POSITION 6 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_DATA_FIELDS INTEGER;
DECLARE VARIABLE WK_FIELD_NO INTEGER;
DECLARE VARIABLE WK_WORK_DATA VARCHAR(1024);
DECLARE VARIABLE WK_WORK_LABEL VARCHAR(1024);
DECLARE VARIABLE WK_WORK_FIELD VARCHAR(1024);
DECLARE VARIABLE WK_PROD_ID VARCHAR(30);
DECLARE VARIABLE WK_PROD VARCHAR(30);
DECLARE VARIABLE WK_EXTENSION VARCHAR(6);
DECLARE VARIABLE WK_BUSINESS_ID VARCHAR(10);
DECLARE VARIABLE WK_BUSINESS_NAME VARCHAR(50);
DECLARE VARIABLE WK_CURRENT_COMPANY VARCHAR(50);
/* DECLARE VARIABLE WK_SHORT_DESC VARCHAR(50); */
DECLARE VARIABLE WK_SHORT_DESC VARCHAR(255);
DECLARE VARIABLE WK_OWNERS_NAME_ID VARCHAR(10);
DECLARE VARIABLE WK_OWNERS_NAME VARCHAR(255);
DECLARE VARIABLE WK_CURRENT_OWNER VARCHAR(255);
DECLARE VARIABLE WK_TITLE VARCHAR(255);
DECLARE VARIABLE WK_PROD_TYPE VARCHAR(50);
DECLARE VARIABLE WK_PROD_TYPE_ID CHAR(2);
DECLARE VARIABLE WK_PROD_STATUS VARCHAR(2);
DECLARE VARIABLE WK_QTY_X VARCHAR(10);
DECLARE VARIABLE WK_PACK_QTY INTEGER;
DECLARE VARIABLE WK_INNER_PACK_QTY INTEGER;
DECLARE VARIABLE WK_WEIGHT INTEGER;
DECLARE VARIABLE WK_WEIGHT_UOM VARCHAR(2);
DECLARE VARIABLE WK_INNER_PACK_UOM VARCHAR(2);
DECLARE VARIABLE WK_PACK_UOM VARCHAR(2);
DECLARE VARIABLE WK_ISSUE_UOM VARCHAR(2);
DECLARE VARIABLE WK_ISSUE INTEGER;
DECLARE VARIABLE WK_PACK_WEIGHT INTEGER;
DECLARE VARIABLE WK_PACK_WEIGHT_UOM VARCHAR(2);
DECLARE VARIABLE WK_STATUS VARCHAR(5);
DECLARE VARIABLE WK_FOUND INTEGER;
/* new prod type generation */
DECLARE VARIABLE WK_CHARS VARCHAR(40);
DECLARE VARIABLE WK_START INTEGER;
DECLARE VARIABLE WK_END INTEGER;
DECLARE VARIABLE WK_TRY_CNT INTEGER;
DECLARE VARIABLE WK_LABEL_CURRENT INTEGER;
DECLARE VARIABLE WK_LABEL_NO INTEGER;
DECLARE VARIABLE WK_LABEL VARCHAR(10);
DECLARE VARIABLE WK_LABEL_TRY VARCHAR(10);
DECLARE VARIABLE WK_LABEL_LEN INTEGER;
DECLARE VARIABLE WK_TOT INTEGER;
DECLARE VARIABLE WK_QUOT INTEGER;
DECLARE VARIABLE WK_REM INTEGER;
DECLARE VARIABLE WK_CHAR VARCHAR(5);
DECLARE VARIABLE WK_RESULT INTEGER;

DECLARE VARIABLE WK_LAST_SHORT_DESC VARCHAR(255);
DECLARE VARIABLE WK_LAST_BUSINESS_ID VARCHAR(10);
DECLARE VARIABLE WK_LAST_OWNERS_NAME_ID VARCHAR(10);
DECLARE VARIABLE WK_LAST_TITLE VARCHAR(255);
DECLARE VARIABLE WK_LAST_STATUS VARCHAR(5);
DECLARE VARIABLE WK_LAST_PROD_TYPE_ID CHAR(2);
DECLARE VARIABLE WK_LAST_PROD_STATUS VARCHAR(2);
DECLARE VARIABLE WK_LAST_PACK_QTY INTEGER;
DECLARE VARIABLE WK_LAST_INNER_PACK_QTY INTEGER;
DECLARE VARIABLE WK_LAST_PACK_UOM VARCHAR(2);
DECLARE VARIABLE WK_LAST_ISSUE INTEGER;
DECLARE VARIABLE WK_LAST_ISSUE_UOM VARCHAR(2);
DECLARE VARIABLE WK_LAST_WEIGHT INTEGER;
DECLARE VARIABLE WK_LAST_PACK_WEIGHT INTEGER;
DECLARE VARIABLE WK_LAST_WEIGHT_UOM VARCHAR(2);
DECLARE VARIABLE WK_LAST_PACK_WEIGHT_UOM VARCHAR(2);
DECLARE VARIABLE WK_LAST_INNER_PACK_UOM VARCHAR(2);
BEGIN
   WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
   IF (WK_AUTORUN = 1) THEN
   BEGIN
      IF ((NEW.TRN_TYPE = 'GLTD') AND (NEW.TRN_CLASS = 'C')) THEN
      BEGIN
         /* 
            for the data fields must split out the labeltype of data
            and data portions after the first '>'
            field 1 is the product code (EAN)
            field 2 is the Extension (EAN Extension)
            field 3 is the Business Unit ID
            field 4 is the Business Unit Name
            field 5 is the Literature External Title
            field 6 is the Literature Owners Name ID
            field 7 is the Literature Owners Name
            field 8 is the Literature Short Description
            field 9 is the Literature Type
            field 10 is the Literature Status
            field 11 is the Literature Pack Quantity
            field 12 is the Literature Inner Pack Quantity
            field 13 is the Literature Unit Weight
            field 14 is the Literature Unit Weight UOM
            field 15 is the Literature Inner Pack UOM
            field 16 is the Literature Pack UOM
            field 17 is the Literature Pack Weight
            field 18 is the Literature Pack Weight UOM
            field 19 is the retrieve status 
         */
         WK_STATUS = '';
         WK_PROD = 'NOPROD';
         WK_EXTENSION = '';
         WK_BUSINESS_ID = '';
         WK_BUSINESS_NAME = '';
         WK_SHORT_DESC = '';
         WK_OWNERS_NAME_ID = '';
         WK_OWNERS_NAME = '';
         WK_TITLE = '';
         WK_PROD_TYPE = '';
         WK_PROD_STATUS = '';
         WK_PACK_QTY = 1;
         WK_INNER_PACK_QTY = 1;
         WK_WEIGHT = 0;
         WK_WEIGHT_UOM = '';
         WK_INNER_PACK_UOM = '';
         WK_PACK_UOM = '';
         WK_PACK_WEIGHT = 0;
         WK_PACK_WEIGHT_UOM = '';

         WK_DATA_FIELDS = STRLEN(NEW.INPUT_SOURCE) ;
         WK_FIELD_NO = 1;
         WHILE (WK_FIELD_NO < WK_DATA_FIELDS) DO
         BEGIN
            SELECT WK_FIELD_TEXT 
            FROM GET_REFERENCE_FIELD4 (NEW.TRN_DATA, :WK_FIELD_NO, NEW.TRN_DELIMITER) 
            INTO :WK_WORK_FIELD;
            /* now for this field get the label and data */
            SELECT WK_FIELD_LABEL, WK_FIELD_DATA 
            FROM GET_DATA_REFERENCE_FIELD4 (:WK_WORK_FIELD, '>')
            INTO :WK_WORK_LABEL, :WK_WORK_DATA;

            IF (WK_WORK_LABEL = '<EANNumber') THEN
            BEGIN
               WK_PROD = WK_WORK_DATA;
            END
            IF (WK_WORK_LABEL = '<EANextension') THEN
            BEGIN
               WK_EXTENSION = WK_WORK_DATA;
            END
            IF (WK_WORK_LABEL = '<BusinessUnitNameID') THEN
            BEGIN
               WK_BUSINESS_ID = WK_WORK_DATA;
            END
            IF (WK_WORK_LABEL = '<BusinessUnitName') THEN
            BEGIN
               WK_BUSINESS_NAME = WK_WORK_DATA;
            END
            IF (WK_WORK_LABEL = '<LiteratureExternalTitle') THEN
            BEGIN
               WK_TITLE = WK_WORK_DATA;
            END
            IF (WK_WORK_LABEL = '<LiteratureOwnersNameID') THEN
            BEGIN
               WK_OWNERS_NAME_ID = WK_WORK_DATA;
            END
            IF (WK_WORK_LABEL = '<LiteratureOwnersName') THEN
            BEGIN
               WK_OWNERS_NAME = WK_WORK_DATA;
            END
            IF (WK_WORK_LABEL = '<LiteratureShortDescription') THEN
            BEGIN
               WK_SHORT_DESC = WK_WORK_DATA;
            END
            IF (WK_WORK_LABEL = '<LiteratureType') THEN
            BEGIN
               WK_PROD_TYPE = WK_WORK_DATA;
            END
            IF (WK_WORK_LABEL = '<LiteratureStatus') THEN
            BEGIN
               WK_PROD_STATUS = WK_WORK_DATA;
            END
            IF (WK_WORK_LABEL = '<LiteraturePackQuantity') THEN
            BEGIN
               WK_QTY_X = WK_WORK_DATA;
               WK_PACK_QTY = CAST(WK_QTY_X AS INTEGER);
            END
            IF (WK_WORK_LABEL = '<LiteratureInnerPackQuantity') THEN
            BEGIN
               WK_QTY_X = WK_WORK_DATA;
               WK_INNER_PACK_QTY = CAST(WK_QTY_X AS INTEGER);
            END
            IF (WK_WORK_LABEL = '<LiteratureUnitWeight') THEN
            BEGIN
               WK_QTY_X = WK_WORK_DATA;
               WK_WEIGHT = CAST(WK_QTY_X AS INTEGER);
            END
            IF (WK_WORK_LABEL = '<LiteratureUnitWeightUOM') THEN
            BEGIN
               WK_WEIGHT_UOM = WK_WORK_DATA;
            END
            IF (WK_WORK_LABEL = '<LiteratureInnerPackUOM') THEN
            BEGIN
               WK_INNER_PACK_UOM = WK_WORK_DATA;
            END
            IF (WK_WORK_LABEL = '<LiteraturePackUOM') THEN
            BEGIN
               WK_PACK_UOM = WK_WORK_DATA;
            END
            IF (WK_WORK_LABEL = '<LiteraturePackWeight') THEN
            BEGIN
               WK_QTY_X = WK_WORK_DATA;
               WK_PACK_WEIGHT = CAST(WK_QTY_X AS INTEGER);
            END
            IF (WK_WORK_LABEL = '<LiteraturePackWeightUOM') THEN
            BEGIN
               WK_PACK_WEIGHT_UOM = WK_WORK_DATA;
            END
            IF (WK_WORK_LABEL = '<GetLiteratureDetailStatus') THEN
            BEGIN
               WK_STATUS = WK_WORK_DATA;
            END
            WK_FIELD_NO = WK_FIELD_NO + 1;
         END
         IF (WK_STATUS = 'true') THEN
         BEGIN
            WK_STATUS = 'T';
         END
         ELSE
         BEGIN
            WK_STATUS = 'F';
         END
         IF (WK_EXTENSION = '0') THEN
         BEGIN
            WK_EXTENSION = '';
         END
         IF (WK_SHORT_DESC = '') THEN
         BEGIN
            IF (LEN(WK_TITLE) < 51) THEN
            BEGIN
               WK_SHORT_DESC = WK_TITLE;
            END
            ELSE
            BEGIN
               WK_SHORT_DESC = VSUBSTRING(WK_TITLE, 1, 48);
            END
         END
         IF (LEN(WK_SHORT_DESC) > 50) THEN
         BEGIN
            WK_SHORT_DESC = VSUBSTRING(WK_SHORT_DESC, 1, 48);
         END
         IF (WK_PROD_TYPE = '') THEN
         BEGIN
            SELECT DEFAULT_PROD_TYPE
            FROM CONTROL
            INTO :WK_PROD_TYPE;
            IF (WK_PROD_TYPE IS NULL) THEN
            BEGIN
               WK_PROD_TYPE = '';
            END
         END
         WK_PROD_ID = WK_PROD || WK_EXTENSION;
         /* does company exist */
         /* they do not have business id so I must use the name */
         WK_FOUND = 0;
         /*
         SELECT 1, NAME 
         FROM COMPANY
         WHERE COMPANY_ID = :WK_BUSINESS_ID 
         INTO :WK_FOUND, :WK_CURRENT_COMPANY ;
         */
         SELECT FIRST 1 1, COMPANY_ID 
         FROM COMPANY
         WHERE NAME = :WK_BUSINESS_NAME
         INTO :WK_FOUND, :WK_BUSINESS_ID;
         IF (WK_FOUND = 0) THEN
         BEGIN
            /* must calculate the next company id  */
            /* need 10 bytes  soundex returns 4 bytes */
            WK_TRY_CNT = 0;
            WK_FOUND = 1;
            WK_LABEL = FUD_SOUNDEX(WK_BUSINESS_NAME) ;
            /* try up to 100 next labels */
            WHILE (WK_FOUND > 0 AND WK_TRY_CNT < 100)
            DO
            BEGIN
               WK_LABEL_TRY = WK_LABEL || WK_TRY_CNT;
               /* now try this */
               WK_TRY_CNT = WK_TRY_CNT + 1;
               WK_FOUND = 0;
               SELECT 1  FROM COMPANY
               WHERE COMPANY_ID = :WK_LABEL_TRY
               INTO :WK_FOUND ;
               WK_BUSINESS_ID = WK_LABEL_TRY;
               IF (WK_FOUND = 0) THEN
               BEGIN
                  INSERT INTO COMPANY(COMPANY_ID, NAME)
                  VALUES (:WK_BUSINESS_ID, :WK_BUSINESS_NAME);
               END
            END
         END
         /* does owner person type exist */
         WK_FOUND = 0;
         SELECT 1 FROM PERSON_TYPE
         WHERE CODE = 'CV'
         INTO :WK_FOUND ;
         IF (WK_FOUND = 0) THEN
         BEGIN
            INSERT INTO PERSON_TYPE(CODE, DESCRIPTION)
            VALUES ('CV', 'Company - Vendor');
         END
         /* does prod type exist */
         WK_FOUND = 0;
         SELECT 1, CODE FROM PROD_TYPE
         WHERE DESCRIPTION = :WK_PROD_TYPE
         INTO :WK_FOUND, :WK_PROD_TYPE_ID ;
         IF (WK_FOUND = 0) THEN
         BEGIN
            /* need 2 bytes = 36*36 = 1200 so use a single generator */
            WK_CHARS = '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ@';
            WK_START = 0;
            WK_END = 1295;
            WK_TRY_CNT = 0;
            WK_FOUND = 1;
            /* try up to 4 next labels */
            WHILE (WK_FOUND > 0 AND WK_TRY_CNT < 4)
            DO
            BEGIN
               WK_LABEL_CURRENT = GEN_ID(PROD_TYPE_GEN, 1);
               WK_LABEL_NO = mod(WK_LABEL_CURRENT, :WK_END - :WK_START) + :WK_START;
               WK_LABEL = '';
               WK_LABEL_LEN = 0;
               WK_TOT = WK_LABEL_NO;
               WHILE (WK_LABEL_LEN < 2) DO
               BEGIN
                  /* do for length remaining */
                  WK_QUOT = modquot(WK_TOT, 36);
                  WK_REM = mod(WK_TOT ,36);
                  WK_CHAR = substr(WK_CHARS,WK_REM +1,WK_REM +1);
                  WK_LABEL = WK_LABEL || WK_CHAR;
                  WK_TOT = WK_QUOT;
                  WK_LABEL_LEN = WK_LABEL_LEN + 1;
               END
               /* now swap order */
               WK_LABEL = reverse(WK_LABEL);
               /* now try this */
               WK_TRY_CNT = WK_TRY_CNT + 1;
               WK_FOUND = 0;
               SELECT 1  FROM PROD_TYPE
               WHERE CODE = :WK_LABEL
               INTO :WK_FOUND ;
               WK_PROD_TYPE_ID = WK_LABEL;
               IF (WK_FOUND = 0) THEN
               BEGIN
                  INSERT INTO PROD_TYPE(CODE, DESCRIPTION)
                  VALUES (:WK_PROD_TYPE_ID, :WK_PROD_TYPE );
               END
               ELSE
               BEGIN
                  IF (WK_TRY_CNT = 4) THEN
                  BEGIN
                     UPDATE PROD_TYPE SET DESCRIPTION = :WK_PROD_TYPE
                     WHERE CODE = :WK_PROD_TYPE_ID;
                  END
               END
            END
         END
         /* does owner exist */
         WK_FOUND = 0;
         IF (WK_OWNERS_NAME_ID <> '0') THEN
         BEGIN
            SELECT 1, FIRST_NAME FROM PERSON
            WHERE PERSON_ID = :WK_OWNERS_NAME_ID
            INTO :WK_FOUND, :WK_CURRENT_OWNER;
            IF (WK_FOUND = 0) THEN
            BEGIN
               INSERT INTO PERSON(PERSON_ID, FIRST_NAME, PERSON_TYPE)
               VALUES (:WK_OWNERS_NAME_ID, :WK_OWNERS_NAME, 'CV');
            END
            ELSE
            BEGIN
               IF (WK_CURRENT_OWNER IS NULL) THEN
                  WK_CURRENT_OWNER = '';
               IF ( NOT(WK_CURRENT_OWNER = WK_OWNERS_NAME)) THEN
               BEGIN
                  UPDATE PERSON SET FIRST_NAME = :WK_OWNERS_NAME
                  WHERE PERSON_ID = :WK_OWNERS_NAME_ID;
               END
            END
         END
         ELSE
         BEGIN
            SELECT FIRST 1 1, PERSON_ID 
            FROM PERSON
            WHERE FIRST_NAME = :WK_OWNERS_NAME
              AND PERSON_TYPE = 'CV'
            INTO :WK_FOUND, :WK_OWNERS_NAME_ID;
            IF (WK_FOUND = 0) THEN
            BEGIN
               /* calc the next owners name to use */
               /* need 10 bytes  soundex returns 4 bytes */
               WK_TRY_CNT = 0;
               WK_FOUND = 1;
               WK_LABEL = FUD_SOUNDEX(WK_BUSINESS_NAME) ;
               /* try up to 100 next labels */
               WHILE (WK_FOUND > 0 AND WK_TRY_CNT < 100)
               DO
               BEGIN
                  WK_LABEL_TRY = WK_LABEL || WK_TRY_CNT;
                  /* now try this */
                  WK_TRY_CNT = WK_TRY_CNT + 1;
                  WK_FOUND = 0;
                  SELECT 1  FROM PERSON
                  WHERE PERSON_ID = :WK_LABEL_TRY
                  INTO :WK_FOUND ;
                  WK_OWNERS_NAME_ID = WK_LABEL_TRY;
                  IF (WK_FOUND = 0) THEN
                  BEGIN
                     INSERT INTO PERSON(PERSON_ID, FIRST_NAME, PERSON_TYPE)
                     VALUES (:WK_OWNERS_NAME_ID, :WK_OWNERS_NAME, 'CV');
                  END
               END
            END
         END

         /* does pack uom exist */
         WK_FOUND = 0;
         SELECT 1 FROM UOM
         WHERE CODE = :WK_PACK_UOM
         INTO :WK_FOUND;
         IF (WK_FOUND = 0) THEN
         BEGIN
            INSERT INTO UOM(CODE, DESCRIPTION, UOM_TYPE) VALUES (:WK_PACK_UOM, :WK_PACK_UOM, 'UT');
         END
         /* issue uom = ea */
         WK_ISSUE_UOM = 'EA';
         WK_ISSUE = 1;
         WK_FOUND = 0;
         SELECT 1 FROM UOM
         WHERE CODE = :WK_ISSUE_UOM
         INTO :WK_FOUND;
         IF (WK_FOUND = 0) THEN
         BEGIN
            INSERT INTO UOM(CODE, DESCRIPTION, UOM_TYPE) VALUES (:WK_ISSUE_UOM, :WK_ISSUE_UOM, 'UT');
         END
         /* does pack weight uom exist */
         WK_FOUND = 0;
         SELECT 1 FROM UOM
         WHERE CODE = :WK_PACK_WEIGHT_UOM
         INTO :WK_FOUND;
         IF (WK_FOUND = 0) THEN
         BEGIN
            INSERT INTO UOM(CODE, DESCRIPTION, UOM_TYPE) VALUES (:WK_PACK_WEIGHT_UOM, :WK_PACK_WEIGHT_UOM, 'WT');
         END
         /* does inner pack uom exist */
         WK_FOUND = 0;
         SELECT 1 FROM UOM
         WHERE CODE = :WK_INNER_PACK_UOM
         INTO :WK_FOUND;
         IF (WK_FOUND = 0) THEN
         BEGIN
            INSERT INTO UOM(CODE, DESCRIPTION, UOM_TYPE) VALUES (:WK_INNER_PACK_UOM, :WK_INNER_PACK_UOM, 'UT');
         END
         /* does unit weight uom exist */
         WK_FOUND = 0;
         SELECT 1 FROM UOM
         WHERE CODE = :WK_WEIGHT_UOM
         INTO :WK_FOUND;
         IF (WK_FOUND = 0) THEN
         BEGIN
            INSERT INTO UOM(CODE, DESCRIPTION, UOM_TYPE) VALUES (:WK_WEIGHT_UOM, :WK_WEIGHT_UOM, 'WT');
         END

         /* does product exist */
         WK_FOUND = 0;
         SELECT 1 FROM PROD_PROFILE
         WHERE PROD_ID = :WK_PROD_ID
         INTO :WK_FOUND;
         IF (WK_FOUND = 0) THEN
         BEGIN
            /* no prod profile - so create a dummy */
            INSERT INTO PROD_PROFILE(PROD_ID, 
               SHORT_DESC, 
               COMPANY_ID, 
               SUPPLIER_NO1, 
               LONG_DESC, 
               PROD_TYPE, 
               STOCK, 
               ISSUE_PER_ORDER_UNIT, 
               ISSUE_PER_INNER_UNIT, 
               ORDER_UOM, 
               ISSUE_UOM, 
               ISSUE, 
               NET_WEIGHT, 
               ORDER_WEIGHT, 
               NET_WEIGHT_UOM, 
               ORDER_WEIGHT_UOM, 
               INNER_UOM, 
               PROD_RETRIEVE_STATUS )
            VALUES (:WK_PROD_ID, 
               :WK_SHORT_DESC, 
               :WK_BUSINESS_ID, 
               :WK_OWNERS_NAME_ID,
               :WK_TITLE, 
               :WK_PROD_TYPE_ID, 
               :WK_PROD_STATUS, 
               :WK_PACK_QTY, 
               :WK_INNER_PACK_QTY, 
               :WK_PACK_UOM, 
               :WK_ISSUE_UOM, 
               :WK_ISSUE, 
               :WK_WEIGHT, 
               :WK_PACK_WEIGHT, 
               :WK_WEIGHT_UOM, 
               :WK_PACK_WEIGHT_UOM, 
               :WK_INNER_PACK_UOM, 
               :WK_STATUS);
         END
         ELSE
         BEGIN
            SELECT  SHORT_DESC ,
            COMPANY_ID ,
            SUPPLIER_NO1, 
            LONG_DESC ,
            PROD_RETRIEVE_STATUS, 
            PROD_TYPE ,
            STOCK ,
            ISSUE_PER_ORDER_UNIT, 
            ISSUE_PER_INNER_UNIT, 
            ORDER_UOM ,
            ISSUE ,
            ISSUE_UOM ,
            NET_WEIGHT ,
            ORDER_WEIGHT, 
            NET_WEIGHT_UOM, 
            ORDER_WEIGHT_UOM, 
            INNER_UOM 
            FROM PROD_PROFILE
            WHERE PROD_ID = :WK_PROD_ID
            INTO  :WK_LAST_SHORT_DESC, 
                  :WK_LAST_BUSINESS_ID, 
                  :WK_LAST_OWNERS_NAME_ID, 
                  :WK_LAST_TITLE, 
                  :WK_LAST_STATUS,
                  :WK_LAST_PROD_TYPE_ID,
                  :WK_LAST_PROD_STATUS,
                  :WK_LAST_PACK_QTY,
                  :WK_LAST_INNER_PACK_QTY,
                  :WK_LAST_PACK_UOM,
                  :WK_LAST_ISSUE,
                  :WK_LAST_ISSUE_UOM,
                  :WK_LAST_WEIGHT,
                  :WK_LAST_PACK_WEIGHT,
                  :WK_LAST_WEIGHT_UOM,
                  :WK_LAST_PACK_WEIGHT_UOM,
                  :WK_LAST_INNER_PACK_UOM;
            IF (WK_SHORT_DESC = '') THEN
            BEGIN
               WK_SHORT_DESC = WK_LAST_SHORT_DESC;
            END
            IF (WK_BUSINESS_ID = '') THEN
            BEGIN
               WK_BUSINESS_ID = WK_LAST_BUSINESS_ID;
            END
            IF (WK_OWNERS_NAME_ID = '') THEN
            BEGIN
               WK_OWNERS_NAME_ID = WK_LAST_OWNERS_NAME_ID;
            END
            IF (WK_TITLE = '') THEN
            BEGIN
               WK_TITLE = WK_LAST_TITLE;
            END
            IF (WK_STATUS = '') THEN
            BEGIN
               WK_STATUS = WK_LAST_STATUS;
            END
            IF (WK_PROD_TYPE_ID = '') THEN
            BEGIN
               WK_PROD_TYPE_ID = WK_LAST_PROD_TYPE_ID ;
            END
            IF (WK_PROD_STATUS  = '') THEN
            BEGIN
               WK_PROD_STATUS  = WK_LAST_PROD_STATUS ;
            END
            IF (WK_PACK_UOM  = '') THEN
            BEGIN
               WK_PACK_UOM   = WK_LAST_PACK_UOM ;
            END
            IF (WK_ISSUE_UOM  = '') THEN
            BEGIN
               WK_ISSUE_UOM   = WK_LAST_ISSUE_UOM ;
            END
            IF (WK_WEIGHT_UOM  = '') THEN
            BEGIN
               WK_WEIGHT_UOM   = WK_LAST_WEIGHT_UOM ;
            END
            IF (WK_PACK_WEIGHT_UOM  = '') THEN
            BEGIN
               WK_PACK_WEIGHT_UOM   = WK_LAST_PACK_WEIGHT_UOM ;
            END
            IF (WK_INNER_PACK_UOM  = '') THEN
            BEGIN
               WK_INNER_PACK_UOM   = WK_LAST_INNER_PACK_UOM ;
            END
            IF (WK_PACK_QTY  = 0) THEN
            BEGIN
               WK_PACK_QTY   = WK_LAST_PACK_QTY ;
            END
            IF (WK_INNER_PACK_QTY  = 0) THEN
            BEGIN
               WK_INNER_PACK_QTY   = WK_LAST_INNER_PACK_QTY ;
            END
            IF (WK_ISSUE  = 0) THEN
            BEGIN
               WK_ISSUE = WK_LAST_ISSUE ;
            END
            IF (WK_WEIGHT  = 0) THEN
            BEGIN
               WK_WEIGHT = WK_LAST_WEIGHT ;
            END
            IF (WK_PACK_WEIGHT  = 0) THEN
            BEGIN
               WK_PACK_WEIGHT = WK_LAST_PACK_WEIGHT ;
            END

            UPDATE PROD_PROFILE 
            SET SHORT_DESC = :WK_SHORT_DESC, 
            COMPANY_ID = :WK_BUSINESS_ID, 
            SUPPLIER_NO1 = :WK_OWNERS_NAME_ID, 
            LONG_DESC = :WK_TITLE, 
            PROD_RETRIEVE_STATUS = :WK_STATUS,
            PROD_TYPE = :WK_PROD_TYPE_ID,
            STOCK = :WK_PROD_STATUS,
            ISSUE_PER_ORDER_UNIT = :WK_PACK_QTY,
            ISSUE_PER_INNER_UNIT = :WK_INNER_PACK_QTY,
            ORDER_UOM = :WK_PACK_UOM,
            ISSUE = :WK_ISSUE,
            ISSUE_UOM = :WK_ISSUE_UOM,
            NET_WEIGHT = :WK_WEIGHT,
            ORDER_WEIGHT = :WK_PACK_WEIGHT,
            NET_WEIGHT_UOM = :WK_WEIGHT_UOM,
            ORDER_WEIGHT_UOM = :WK_PACK_WEIGHT_UOM,
            INNER_UOM = :WK_INNER_PACK_UOM
            WHERE PROD_ID = :WK_PROD_ID;
         END
         WK_FOUND = 0;
         SELECT 1 FROM PROD_EAN
         WHERE PROD_EAN = :WK_PROD AND 
               PROD_EAN_EXTENSION = :WK_EXTENSION
         INTO :WK_FOUND;
         IF (WK_FOUND = 0) THEN
         BEGIN
            /* no prod ean - so create one */
            INSERT INTO PROD_EAN(PROD_ID, PROD_EAN, PROD_EAN_EXTENSION)
            VALUES (:WK_PROD_ID, :WK_PROD, :WK_EXTENSION);
         END

         /* Update transactions table */        
         EXECUTE PROCEDURE UPDATE_TRAN4 (NEW.RECORD_ID, 'T', 'Processed successfully');
         EXECUTE PROCEDURE TRAN4_ARCHIVE;
      END
   END
END ^

CREATE TRIGGER RUN_TRANSACTION_GPLD FOR TRANSACTIONS4 
ACTIVE AFTER INSERT POSITION 7 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_DATA_FIELDS INTEGER;
DECLARE VARIABLE WK_FIELD_NO INTEGER;
DECLARE VARIABLE WK_WORK_DATA VARCHAR(1024);
DECLARE VARIABLE WK_WORK_LABEL VARCHAR(1024);
DECLARE VARIABLE WK_WORK_FIELD VARCHAR(1024);
DECLARE VARIABLE WK_WORK_END CHAR(1);
DECLARE VARIABLE WK_MODE VARCHAR(10);
DECLARE VARIABLE WK_WH_ID CHAR(2);
DECLARE VARIABLE WK_ORDER VARCHAR(15);
DECLARE VARIABLE WK_ORDER_DATE VARCHAR(50);
DECLARE VARIABLE WK_ORDER_DATE2 VARCHAR(50);
DECLARE VARIABLE WK_ORDER_DATE3 VARCHAR(20);
DECLARE VARIABLE WK_ORDER_DATET TIMESTAMP;
DECLARE VARIABLE WK_PROD_ID VARCHAR(30);
DECLARE VARIABLE WK_PROD1 VARCHAR(30);
DECLARE VARIABLE WK_PROD2 VARCHAR(30);
DECLARE VARIABLE WK_PROD3 VARCHAR(30);
DECLARE VARIABLE WK_PROD4 VARCHAR(30);
DECLARE VARIABLE WK_PROD5 VARCHAR(30);
DECLARE VARIABLE WK_PROD6 VARCHAR(30);
DECLARE VARIABLE WK_PROD7 VARCHAR(30);
DECLARE VARIABLE WK_PROD8 VARCHAR(30);
DECLARE VARIABLE WK_PROD9 VARCHAR(30);
DECLARE VARIABLE WK_PROD10 VARCHAR(30);
DECLARE VARIABLE WK_EXTENSION1 VARCHAR(6);
DECLARE VARIABLE WK_EXTENSION2 VARCHAR(6);
DECLARE VARIABLE WK_EXTENSION3 VARCHAR(6);
DECLARE VARIABLE WK_EXTENSION4 VARCHAR(6);
DECLARE VARIABLE WK_EXTENSION5 VARCHAR(6);
DECLARE VARIABLE WK_EXTENSION6 VARCHAR(6);
DECLARE VARIABLE WK_EXTENSION7 VARCHAR(6);
DECLARE VARIABLE WK_EXTENSION8 VARCHAR(6);
DECLARE VARIABLE WK_EXTENSION9 VARCHAR(6);
DECLARE VARIABLE WK_EXTENSION10 VARCHAR(6);
DECLARE VARIABLE WK_QTY_X VARCHAR(10);
DECLARE VARIABLE WK_QTY1 INTEGER;
DECLARE VARIABLE WK_QTY2 INTEGER;
DECLARE VARIABLE WK_QTY3 INTEGER;
DECLARE VARIABLE WK_QTY4 INTEGER;
DECLARE VARIABLE WK_QTY5 INTEGER;
DECLARE VARIABLE WK_QTY6 INTEGER;
DECLARE VARIABLE WK_QTY7 INTEGER;
DECLARE VARIABLE WK_QTY8 INTEGER;
DECLARE VARIABLE WK_QTY9 INTEGER;
DECLARE VARIABLE WK_QTY10 INTEGER;
DECLARE VARIABLE WK_STATUS VARCHAR(5);
DECLARE VARIABLE WK_SUPPLIERLIST VARCHAR(5);
DECLARE VARIABLE WK_SPECIALMAIL VARCHAR(5);
DECLARE VARIABLE WK_PRIORITY VARCHAR(5);
DECLARE VARIABLE WK_PICK_PRIORITY SMALLINT;
DECLARE VARIABLE WK_ORDER_STATUS VARCHAR(5);
DECLARE VARIABLE WK_LINE_NO1 VARCHAR(4);
DECLARE VARIABLE WK_LINE_NO2 VARCHAR(4);
DECLARE VARIABLE WK_LINE_NO3 VARCHAR(4);
DECLARE VARIABLE WK_LINE_NO4 VARCHAR(4);
DECLARE VARIABLE WK_LINE_NO5 VARCHAR(4);
DECLARE VARIABLE WK_LINE_NO6 VARCHAR(4);
DECLARE VARIABLE WK_LINE_NO7 VARCHAR(4);
DECLARE VARIABLE WK_LINE_NO8 VARCHAR(4);
DECLARE VARIABLE WK_LINE_NO9 VARCHAR(4);
DECLARE VARIABLE WK_LINE_NO10 VARCHAR(4);
DECLARE VARIABLE WK_FOUND INTEGER;
DECLARE VARIABLE WK_PICK_LABEL VARCHAR(7);
DECLARE VARIABLE WK_LABEL_LENGTH INTEGER;
DECLARE VARIABLE WK_LAST_LINE INTEGER;
DECLARE VARIABLE WK_LEN_LINE_NO INTEGER;
DECLARE VARIABLE WK_PICK_LINE_NO VARCHAR(4);
DECLARE VARIABLE WK_L_PICK_LINE_NO VARCHAR(4);
DECLARE VARIABLE WK_POSN INTEGER;
DECLARE VARIABLE WK_LAST_LINE_NO INTEGER;
DECLARE VARIABLE WK_ORDER_TYPE CHAR(2);
DECLARE VARIABLE WK_PICK_STATUS CHAR(2);
DECLARE VARIABLE WK_TERM VARCHAR(20);
DECLARE VARIABLE WK_PAYMENT VARCHAR(20);
DECLARE VARIABLE WK_CARRIER VARCHAR(10);
DECLARE VARIABLE WK_DONTDO_LINE INTEGER;
DECLARE VARIABLE WK_FILENAME VARCHAR(80);
DECLARE VARIABLE WK_RESULT INTEGER;
BEGIN
   WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
   IF (WK_AUTORUN = 1) THEN
   BEGIN
      IF ((NEW.TRN_TYPE = 'GPLD') AND (NEW.TRN_CLASS = 'C')) THEN
      BEGIN
         /* 
            for the data fields must split out the labeltype of data
            and data portions after the first '>'
            for multiple lines have
            field 1 is the picking mode
            field 2 is the warehouse id 
            *field 3 is the retrieve status 
            *field 4 is the order 
            field 5 is the order date time 
            field 6 is the supplier list flag
            field 7 is the special mailout flag
            field 8 is the order priority (maybe empty)
            up to 10 lines
            field 9 is the pick line no (maybe empty)
            *field 10 is the product code (EAN)
            *field 11 is the Extension (EAN Extension)
            *field 12 is the quantity 
         */
         WK_ORDER_TYPE = 'SO';
         WK_MODE = '';
         WK_WH_ID = '';
         WK_ORDER = '';
         WK_ORDER_DATET = 'NOW';
         WK_STATUS = '';
         WK_SUPPLIERLIST = '';
         WK_SPECIALMAIL = '';
         WK_PRIORITY = '';
         WK_LINE_NO1 = '';
         WK_LINE_NO2 = '';
         WK_LINE_NO3 = '';
         WK_LINE_NO4 = '';
         WK_LINE_NO5 = '';
         WK_LINE_NO6 = '';
         WK_LINE_NO7 = '';
         WK_LINE_NO8 = '';
         WK_LINE_NO9 = '';
         WK_LINE_NO10 = '';
         WK_PROD1 = '';
         WK_PROD2 = '';
         WK_PROD3 = '';
         WK_PROD4 = '';
         WK_PROD5 = '';
         WK_PROD6 = '';
         WK_PROD7 = '';
         WK_PROD8 = '';
         WK_PROD9 = '';
         WK_PROD10 = '';
         WK_QTY_X = '';
         WK_QTY1 = 0;
         WK_QTY2 = 0;
         WK_QTY3 = 0;
         WK_QTY4 = 0;
         WK_QTY5 = 0;
         WK_QTY6 = 0;
         WK_QTY7 = 0;
         WK_QTY8 = 0;
         WK_QTY9 = 0;
         WK_QTY10 = 0;
         WK_EXTENSION1 = '';
         WK_EXTENSION2 = '';
         WK_EXTENSION3 = '';
         WK_EXTENSION4 = '';
         WK_EXTENSION5 = '';
         WK_EXTENSION6 = '';
         WK_EXTENSION7 = '';
         WK_EXTENSION8 = '';
         WK_EXTENSION9 = '';
         WK_EXTENSION10 = '';
         /* WK_DATA_FIELDS = STRLEN(NEW.INPUT_SOURCE) ; */
         WK_FIELD_NO = 1;
         WK_WORK_END = 'F';
         /* WHILE (WK_FIELD_NO < WK_DATA_FIELDS) DO */
         WHILE (WK_WORK_END = 'F') DO
         BEGIN
            SELECT WK_FIELD_TEXT , WK_AT_END
            FROM GET_REFERENCE_FIELD4 (NEW.TRN_DATA, :WK_FIELD_NO, NEW.TRN_DELIMITER) 
            INTO :WK_WORK_FIELD, :WK_WORK_END;
            /* now for this field get the label and data */
            SELECT WK_FIELD_LABEL, WK_FIELD_DATA 
            FROM GET_DATA_REFERENCE_FIELD4 (:WK_WORK_FIELD, '>')
            INTO :WK_WORK_LABEL, :WK_WORK_DATA;

            IF (WK_WORK_LABEL = '<PickingMode') THEN
            BEGIN
               WK_MODE = WK_WORK_DATA;
            END
            IF (WK_WORK_LABEL = '<WareHouseID') THEN
            BEGIN
               WK_WH_ID = WK_WORK_DATA;
            END
/*
            IF (WK_WORK_LABEL = '<RetrieveStatus') THEN
*/
            IF (WK_WORK_LABEL = '<PickingListDetailRetrieveStatus') THEN
            BEGIN
               WK_STATUS = WK_WORK_DATA;
            END
            IF (WK_WORK_LABEL = '<ContactInstanceID') THEN
            BEGIN
               WK_ORDER = WK_WORK_DATA;
               WK_LAST_LINE_NO = 0;
            END
            IF (WK_WORK_LABEL = '<OrderDateTime') THEN
            BEGIN
               WK_ORDER_DATE = WK_WORK_DATA;
               WK_POSN = POS(WK_ORDER_DATE, 'T', 0, 1);
               WK_ORDER_DATE2 = SUBSTR(WK_ORDER_DATE, 1, WK_POSN) || ' ' ||
               SUBSTR(WK_ORDER_DATE, WK_POSN + 2, LEN(WK_ORDER_DATE));
               WK_ORDER_DATE3 = SUBSTR(WK_ORDER_DATE2, 1, 19);
               WK_ORDER_DATET = CAST(WK_ORDER_DATE3 AS TIMESTAMP);

            END
            IF (WK_WORK_LABEL = '<SupplierListFlag') THEN
            BEGIN
               WK_SUPPLIERLIST = WK_WORK_DATA;
            END
            IF (WK_WORK_LABEL = '<SpecialMailoutFlag') THEN
            BEGIN
               WK_SPECIALMAIL = WK_WORK_DATA;
            END
            IF (WK_WORK_LABEL = '<OrderPriority') THEN
            BEGIN
               WK_PRIORITY = WK_WORK_DATA;
            END
            IF (WK_WORK_LABEL = '<PickLineNumber') THEN
            BEGIN
               WK_LAST_LINE_NO = WK_LAST_LINE_NO + 1;
               IF (WK_LAST_LINE_NO = 1) THEN
                  WK_LINE_NO1 = WK_WORK_DATA;
               ELSE
               IF (WK_LAST_LINE_NO = 2) THEN
                  WK_LINE_NO2 = WK_WORK_DATA;
               ELSE
               IF (WK_LAST_LINE_NO = 3) THEN
                  WK_LINE_NO3 = WK_WORK_DATA;
               ELSE
               IF (WK_LAST_LINE_NO = 4) THEN
                  WK_LINE_NO4 = WK_WORK_DATA;
               ELSE
               IF (WK_LAST_LINE_NO = 5) THEN
                  WK_LINE_NO5 = WK_WORK_DATA;
               ELSE
               IF (WK_LAST_LINE_NO = 6) THEN
                  WK_LINE_NO6 = WK_WORK_DATA;
               ELSE
               IF (WK_LAST_LINE_NO = 7) THEN
                  WK_LINE_NO7 = WK_WORK_DATA;
               ELSE
               IF (WK_LAST_LINE_NO = 8) THEN
                  WK_LINE_NO8 = WK_WORK_DATA;
               ELSE
               IF (WK_LAST_LINE_NO = 9) THEN
                  WK_LINE_NO9 = WK_WORK_DATA;
               ELSE
               IF (WK_LAST_LINE_NO = 10) THEN
                  WK_LINE_NO10 = WK_WORK_DATA;
            END

            IF (WK_WORK_LABEL = '<EANNumber') THEN
            BEGIN
               IF (WK_LAST_LINE_NO = 1) THEN
                  WK_PROD1 = WK_WORK_DATA;
               ELSE
               IF (WK_LAST_LINE_NO = 2) THEN
                  WK_PROD2 = WK_WORK_DATA;
               ELSE
               IF (WK_LAST_LINE_NO = 3) THEN
                  WK_PROD3 = WK_WORK_DATA;
               ELSE
               IF (WK_LAST_LINE_NO = 4) THEN
                  WK_PROD4 = WK_WORK_DATA;
               ELSE
               IF (WK_LAST_LINE_NO = 5) THEN
                  WK_PROD5 = WK_WORK_DATA;
               ELSE
               IF (WK_LAST_LINE_NO = 6) THEN
                  WK_PROD6 = WK_WORK_DATA;
               ELSE
               IF (WK_LAST_LINE_NO = 7) THEN
                  WK_PROD7 = WK_WORK_DATA;
               ELSE
               IF (WK_LAST_LINE_NO = 8) THEN
                  WK_PROD8 = WK_WORK_DATA;
               ELSE
               IF (WK_LAST_LINE_NO = 9) THEN
                  WK_PROD9 = WK_WORK_DATA;
               ELSE
               IF (WK_LAST_LINE_NO = 10) THEN
                  WK_PROD10 = WK_WORK_DATA;
            END
            IF (WK_WORK_LABEL = '<Quantity') THEN
            BEGIN
               WK_QTY_X = WK_WORK_DATA;
               IF (WK_LAST_LINE_NO = 1) THEN
                  WK_QTY1 = CAST(WK_QTY_X AS INTEGER);
               ELSE
               IF (WK_LAST_LINE_NO = 2) THEN
                  WK_QTY2 = CAST(WK_QTY_X AS INTEGER);
               ELSE
               IF (WK_LAST_LINE_NO = 3) THEN
                  WK_QTY3 = CAST(WK_QTY_X AS INTEGER);
               ELSE
               IF (WK_LAST_LINE_NO = 4) THEN
                  WK_QTY4 = CAST(WK_QTY_X AS INTEGER);
               ELSE
               IF (WK_LAST_LINE_NO = 5) THEN
                  WK_QTY5 = CAST(WK_QTY_X AS INTEGER);
               ELSE
               IF (WK_LAST_LINE_NO = 6) THEN
                  WK_QTY6 = CAST(WK_QTY_X AS INTEGER);
               ELSE
               IF (WK_LAST_LINE_NO = 7) THEN
                  WK_QTY7 = CAST(WK_QTY_X AS INTEGER);
               ELSE
               IF (WK_LAST_LINE_NO = 8) THEN
                  WK_QTY8 = CAST(WK_QTY_X AS INTEGER);
               ELSE
               IF (WK_LAST_LINE_NO = 9) THEN
                  WK_QTY9 = CAST(WK_QTY_X AS INTEGER);
               ELSE
               IF (WK_LAST_LINE_NO = 10) THEN
                  WK_QTY10 = CAST(WK_QTY_X AS INTEGER);
            END
            IF (WK_WORK_LABEL = '<EANExtension') THEN
            BEGIN
               IF (WK_LAST_LINE_NO = 1) THEN
                  WK_EXTENSION1 = WK_WORK_DATA;
               ELSE
               IF (WK_LAST_LINE_NO = 2) THEN
                  WK_EXTENSION2 = WK_WORK_DATA;
               ELSE
               IF (WK_LAST_LINE_NO = 3) THEN
                  WK_EXTENSION3 = WK_WORK_DATA;
               ELSE
               IF (WK_LAST_LINE_NO = 4) THEN
                  WK_EXTENSION4 = WK_WORK_DATA;
               ELSE
               IF (WK_LAST_LINE_NO = 5) THEN
                  WK_EXTENSION5 = WK_WORK_DATA;
               ELSE
               IF (WK_LAST_LINE_NO = 6) THEN
                  WK_EXTENSION6 = WK_WORK_DATA;
               ELSE
               IF (WK_LAST_LINE_NO = 7) THEN
                  WK_EXTENSION7 = WK_WORK_DATA;
               ELSE
               IF (WK_LAST_LINE_NO = 8) THEN
                  WK_EXTENSION8 = WK_WORK_DATA;
               ELSE
               IF (WK_LAST_LINE_NO = 9) THEN
                  WK_EXTENSION9 = WK_WORK_DATA;
               ELSE
               IF (WK_LAST_LINE_NO = 10) THEN
                  WK_EXTENSION10 = WK_WORK_DATA;
            END
            WK_FIELD_NO = WK_FIELD_NO + 1;
         END
         IF (WK_STATUS = 'true') THEN
         BEGIN
            WK_STATUS = 'T';
         END
         ELSE
         BEGIN
            WK_STATUS = 'F';
         END
         IF (WK_SUPPLIERLIST = 'true') THEN
         BEGIN
            WK_SUPPLIERLIST = 'T';
         END
         ELSE
         BEGIN
            WK_SUPPLIERLIST = 'F';
         END
         IF (WK_SPECIALMAIL = 'true') THEN
         BEGIN
            WK_SPECIALMAIL = 'T';
         END
         ELSE
         BEGIN
            WK_SPECIALMAIL = 'F';
         END
         IF (WK_EXTENSION1 = '0') THEN
         BEGIN
            WK_EXTENSION1 = '';
         END
         IF (WK_EXTENSION2 = '0') THEN
         BEGIN
            WK_EXTENSION2 = '';
         END
         IF (WK_EXTENSION3 = '0') THEN
         BEGIN
            WK_EXTENSION3 = '';
         END
         IF (WK_EXTENSION4 = '0') THEN
         BEGIN
            WK_EXTENSION4 = '';
         END
         IF (WK_EXTENSION5 = '0') THEN
         BEGIN
            WK_EXTENSION5 = '';
         END
         IF (WK_EXTENSION6 = '0') THEN
         BEGIN
            WK_EXTENSION6 = '';
         END
         IF (WK_EXTENSION7 = '0') THEN
         BEGIN
            WK_EXTENSION7 = '';
         END
         IF (WK_EXTENSION8 = '0') THEN
         BEGIN
            WK_EXTENSION8 = '';
         END
         IF (WK_EXTENSION9 = '0') THEN
         BEGIN
            WK_EXTENSION9 = '';
         END
         IF (WK_EXTENSION10 = '0') THEN
         BEGIN
            WK_EXTENSION10 = '';
         END
         IF (WK_PRIORITY = '') THEN
         BEGIN
            SELECT DEFAULT_PICK_PRIORITY 
            FROM CONTROL
            INTO :WK_PICK_PRIORITY;
         END
         ELSE
         BEGIN
            WK_PICK_PRIORITY = CAST(WK_PRIORITY AS INTEGER);
         END
         /* get default values from control */
         SELECT DEFAULT_TERM, DEFAULT_PAYMENT_METHOD, DEFAULT_CARRIER_ID
         FROM CONTROL
         INTO :WK_TERM, :WK_PAYMENT, :WK_CARRIER;
/*====================================================================*/
         /* does order exist */
         WK_FOUND = 0;
         SELECT 1, PICK_RETRIEVE_STATUS, PICK_STATUS
         FROM PICK_ORDER
         WHERE PICK_ORDER = :WK_ORDER
         INTO :WK_FOUND, :WK_ORDER_STATUS, :WK_PICK_STATUS;
         IF (WK_ORDER_STATUS IS NULL) THEN
         BEGIN
            WK_ORDER_STATUS = 'F';
         END
         IF (WK_FOUND = 0) THEN
         BEGIN
            IF (WK_STATUS = 'T') THEN
            BEGIN
               /* no order  */
               INSERT INTO PICK_ORDER(PICK_ORDER, 
                  PICK_STATUS, 
                  PICK_RETRIEVE_STATUS,
                  PICK_PRIORITY,
                  SUPPLIER_LIST,
                  SPECIAL_INSTRUCTIONS,
                  CREATE_DATE,
                  CREATED_BY,
                  PICK_DUE_DATE,
                  PICK_ORDER_TYPE,
                  WH_ID,
                  UPDATE_ID,
                  TERMS,
                  PAYMENT_METHOD,
                  SHIP_VIA,
                  APPROVED_DESP_DATE,
                  APPROVED_DATE)
               VALUES (:WK_ORDER, 
                  'DA', 
                  :WK_STATUS,
                  :WK_PICK_PRIORITY,
                  :WK_SUPPLIERLIST,
                  :WK_SPECIALMAIL,
                  NEW.TRN_DATE,
                  NEW.PERSON_ID,
                  :WK_ORDER_DATET,
                  :WK_ORDER_TYPE,
                  :WK_WH_ID,
                  NEW.MESSAGE_ID ,
                  :WK_TERM,
                  :WK_PAYMENT,
                  :WK_CARRIER,
                  NEW.TRN_DATE,
                  NEW.TRN_DATE);
               WK_ORDER_STATUS = WK_STATUS;
            END
            ELSE
            BEGIN
            /*
               INSERT INTO PICK_ORDER(PICK_ORDER, 
                  PICK_STATUS, 
                  PICK_RETRIEVE_STATUS, 
                  PICK_ORDER_TYPE, 
                  CREATE_DATE, 
                  CREATED_BY, 
                  UPDATE_ID,
                  TERMS,
                  PAYMENT_METHOD,
                  SHIP_VIA)
               VALUES (:WK_ORDER, 
                  'DA', 
                  :WK_STATUS ,
                  :WK_ORDER_TYPE, 
                  NEW.TRN_DATE, 
                  NEW.PERSON_ID , 
                  NEW.MESSAGE_ID,
                  :WK_TERM,
                  :WK_PAYMENT,
                  :WK_CARRIER);
            */
               WK_ORDER_STATUS = WK_STATUS;
            END
         END
         ELSE
         BEGIN
            IF (WK_STATUS = 'F') THEN
            BEGIN
               UPDATE PICK_ORDER
               SET PICK_STATUS='DA',
                   PICK_RETRIEVE_STATUS = :WK_STATUS,
                   UPDATE_ID = NEW.MESSAGE_ID,
                   APPROVED_DESP_DATE = NEW.TRN_DATE
               WHERE PICK_ORDER = :WK_ORDER;
               WK_ORDER_STATUS = WK_STATUS;
            END
            ELSE
            BEGIN
               IF ( (WK_PICK_STATUS IS NULL)) THEN
               BEGIN
                  UPDATE PICK_ORDER
                  SET PICK_STATUS='DA',
                      PICK_RETRIEVE_STATUS = :WK_STATUS,
                      WH_ID = :WK_WH_ID,
                      PICK_PRIORITY = :WK_PICK_PRIORITY,
                      SUPPLIER_LIST = :WK_SUPPLIERLIST,
                      SPECIAL_INSTRUCTIONS = :WK_SPECIALMAIL,
                      PICK_DUE_DATE = :WK_ORDER_DATET,
                      PICK_ORDER_TYPE = :WK_ORDER_TYPE,
                      UPDATE_ID = NEW.MESSAGE_ID,
                      APPROVED_DESP_DATE = NEW.TRN_DATE
                  WHERE PICK_ORDER = :WK_ORDER;
               END
               ELSE
               BEGIN
                  UPDATE PICK_ORDER
                  SET PICK_RETRIEVE_STATUS = :WK_STATUS,
                      WH_ID = :WK_WH_ID,
                      PICK_PRIORITY = :WK_PICK_PRIORITY,
                      SUPPLIER_LIST = :WK_SUPPLIERLIST,
                      SPECIAL_INSTRUCTIONS = :WK_SPECIALMAIL,
                      PICK_DUE_DATE = :WK_ORDER_DATET,
                      PICK_ORDER_TYPE = :WK_ORDER_TYPE,
                      UPDATE_ID = NEW.MESSAGE_ID
                  WHERE PICK_ORDER = :WK_ORDER;
               END
            END
         END

/*====================================================================*/
         /* do line stuff */
         IF (WK_PROD1 = '') THEN
         BEGIN
            WK_PROD1 = 'NOPROD';
            IF (WK_QTY1 = 0) THEN
            BEGIN
               WK_QTY1 = 1;
            END
            /*
            IF (WK_STATUS = 'F') THEN
            BEGIN
               WK_STATUS = 'T';
            END
            */
         END
         WK_DONTDO_LINE = 0;
         SELECT FIRST 1 1
         FROM PICK_ITEM
         WHERE PICK_LINE_STATUS NOT IN ('OP','UP')
           AND PICK_ORDER = :WK_ORDER
         INTO :WK_DONTDO_LINE;
         IF (WK_DONTDO_LINE = 0) THEN
         BEGIN
            IF (WK_PROD1 > '') THEN
            BEGIN
               EXECUTE PROCEDURE ADD_PICK_ITEMS (
                  WK_ORDER ,
                  WK_ORDER_STATUS ,
                  WK_STATUS ,
                  WK_PROD1 ,
                  WK_EXTENSION1 ,
                  WK_LINE_NO1 ,
                  WK_QTY1 ,
                  NEW.TRN_DATE ,
                  NEW.PERSON_ID ,
                  0 );
            END
            IF (WK_PROD2 > '') THEN
            BEGIN
               EXECUTE PROCEDURE ADD_PICK_ITEMS (
                  WK_ORDER ,
                  WK_ORDER_STATUS ,
                  WK_STATUS ,
                  WK_PROD2 ,
                  WK_EXTENSION2 ,
                  WK_LINE_NO2 ,
                  WK_QTY2 ,
                  NEW.TRN_DATE ,
                  NEW.PERSON_ID ,
                  0 );
            END
            IF (WK_PROD3 > '') THEN
            BEGIN
               EXECUTE PROCEDURE ADD_PICK_ITEMS (
                  WK_ORDER ,
                  WK_ORDER_STATUS ,
                  WK_STATUS ,
                  WK_PROD3 ,
                  WK_EXTENSION3 ,
                  WK_LINE_NO3 ,
                  WK_QTY3 ,
                  NEW.TRN_DATE ,
                  NEW.PERSON_ID ,
                  0 );
            END
            IF (WK_PROD4 > '') THEN
            BEGIN
               EXECUTE PROCEDURE ADD_PICK_ITEMS (
                  WK_ORDER ,
                  WK_ORDER_STATUS ,
                  WK_STATUS ,
                  WK_PROD4 ,
                  WK_EXTENSION4 ,
                  WK_LINE_NO4 ,
                  WK_QTY4 ,
                  NEW.TRN_DATE ,
                  NEW.PERSON_ID ,
                  0 );
            END
            IF (WK_PROD5 > '') THEN
            BEGIN
               EXECUTE PROCEDURE ADD_PICK_ITEMS (
                  WK_ORDER ,
                  WK_ORDER_STATUS ,
                  WK_STATUS ,
                  WK_PROD5 ,
                  WK_EXTENSION5 ,
                  WK_LINE_NO5 ,
                  WK_QTY5 ,
                  NEW.TRN_DATE ,
                  NEW.PERSON_ID ,
                  0 );
            END
            IF (WK_PROD6 > '') THEN
            BEGIN
               EXECUTE PROCEDURE ADD_PICK_ITEMS (
                  WK_ORDER ,
                  WK_ORDER_STATUS ,
                  WK_STATUS ,
                  WK_PROD6 ,
                  WK_EXTENSION6 ,
                  WK_LINE_NO6 ,
                  WK_QTY6 ,
                  NEW.TRN_DATE ,
                  NEW.PERSON_ID ,
                  0 );
            END
            IF (WK_PROD7 > '') THEN
            BEGIN
               EXECUTE PROCEDURE ADD_PICK_ITEMS (
                  WK_ORDER ,
                  WK_ORDER_STATUS ,
                  WK_STATUS ,
                  WK_PROD7 ,
                  WK_EXTENSION7 ,
                  WK_LINE_NO7 ,
                  WK_QTY7 ,
                  NEW.TRN_DATE ,
                  NEW.PERSON_ID ,
                  0 );
            END
            IF (WK_PROD8 > '') THEN
            BEGIN
               EXECUTE PROCEDURE ADD_PICK_ITEMS (
                  WK_ORDER ,
                  WK_ORDER_STATUS ,
                  WK_STATUS ,
                  WK_PROD8 ,
                  WK_EXTENSION8 ,
                  WK_LINE_NO8 ,
                  WK_QTY8 ,
                  NEW.TRN_DATE ,
                  NEW.PERSON_ID ,
                  0 );
            END
            IF (WK_PROD9 > '') THEN
            BEGIN
               EXECUTE PROCEDURE ADD_PICK_ITEMS (
                  WK_ORDER ,
                  WK_ORDER_STATUS ,
                  WK_STATUS ,
                  WK_PROD9 ,
                  WK_EXTENSION9 ,
                  WK_LINE_NO9 ,
                  WK_QTY9 ,
                  NEW.TRN_DATE ,
                  NEW.PERSON_ID ,
                  0 );
            END
            IF (WK_PROD10 > '') THEN
            BEGIN
               EXECUTE PROCEDURE ADD_PICK_ITEMS (
                  WK_ORDER ,
                  WK_ORDER_STATUS ,
                  WK_STATUS ,
                  WK_PROD10 ,
                  WK_EXTENSION10 ,
                  WK_LINE_NO10 ,
                  WK_QTY10 ,
                  NEW.TRN_DATE ,
                  NEW.PERSON_ID ,
                  0 );
            END
         END
/*====================================================================*/
         /* Update transactions table */        
         EXECUTE PROCEDURE UPDATE_TRAN4 (NEW.RECORD_ID, 'T', 'Processed successfully');
         EXECUTE PROCEDURE TRAN4_ARCHIVE;
      END
   END
END ^

CREATE TRIGGER RUN_TRANSACTION_GCPD FOR TRANSACTIONS4 
ACTIVE AFTER INSERT POSITION 8 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_DATA_FIELDS INTEGER;
DECLARE VARIABLE WK_FIELD_NO INTEGER;
DECLARE VARIABLE WK_WORK_DATA VARCHAR(1024);
DECLARE VARIABLE WK_WORK_LABEL VARCHAR(1024);
DECLARE VARIABLE WK_WORK_FIELD VARCHAR(1024);
DECLARE VARIABLE WK_STATUS VARCHAR(5);
DECLARE VARIABLE WK_CAMPAIGN VARCHAR(10);
DECLARE VARIABLE WK_TITLE VARCHAR(100);
DECLARE VARIABLE WK_FOUND INTEGER;
BEGIN
   WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
   IF (WK_AUTORUN = 1) THEN
   BEGIN
      IF ((NEW.TRN_TYPE = 'GCPD') AND (NEW.TRN_CLASS = 'C')) THEN
      BEGIN
         /* 
            for the data fields must split out the labeltype of data
            and data portions after the first '>'
            field 1 is the campaign ID
            field 2 is the campaign Title
         */
         WK_STATUS = '';
         WK_CAMPAIGN = '';
         WK_TITLE = '';

         WK_DATA_FIELDS = STRLEN(NEW.INPUT_SOURCE) ;
         WK_FIELD_NO = 1;
         WHILE (WK_FIELD_NO < WK_DATA_FIELDS) DO
         BEGIN
            SELECT WK_FIELD_TEXT 
            FROM GET_REFERENCE_FIELD4 (NEW.TRN_DATA, :WK_FIELD_NO, NEW.TRN_DELIMITER) 
            INTO :WK_WORK_FIELD;
            /* now for this field get the label and data */
            SELECT WK_FIELD_LABEL, WK_FIELD_DATA 
            FROM GET_DATA_REFERENCE_FIELD4 (:WK_WORK_FIELD, '>')
            INTO :WK_WORK_LABEL, :WK_WORK_DATA;

            IF (WK_WORK_LABEL = '<CampaignID') THEN
            BEGIN
               WK_CAMPAIGN = WK_WORK_DATA;
            END
            IF (WK_WORK_LABEL = '<CampaignTitle') THEN
            BEGIN
               WK_TITLE = WK_WORK_DATA;
            END
            WK_FIELD_NO = WK_FIELD_NO + 1;
         END
         /* does owner person type exist */
         WK_FOUND = 0;
         SELECT 1 FROM ORDER_GROUP
         WHERE ORDER_GROUP_ID = :WK_CAMPAIGN
         INTO :WK_FOUND ;
         IF (WK_FOUND = 0) THEN
         BEGIN
            INSERT INTO ORDER_GROUP(ORDER_GROUP_ID, DESCRIPTION, UPDATE_ID, CREATE_DATE, CREATED_BY, PICK_RETRIEVE_STATUS, STATUS)
            VALUES (:WK_CAMPAIGN, :WK_TITLE, NEW.MESSAGE_ID, 'NOW',NEW.PERSON_ID, 'T', 'OK');
         END
         ELSE
         BEGIN
            UPDATE ORDER_GROUP
            SET DESCRIPTION = :WK_TITLE,
            PICK_RETRIEVE_STATUS = 'T',
            STATUS = 'OK'
            WHERE ORDER_GROUP_ID = :WK_CAMPAIGN;
         END

         /* Update transactions table */        
         EXECUTE PROCEDURE UPDATE_TRAN4 (NEW.RECORD_ID, 'T', 'Processed successfully');
         EXECUTE PROCEDURE TRAN4_ARCHIVE;
      END
      ELSE
      IF ((NEW.TRN_TYPE = 'GCPD') AND (NEW.TRN_CLASS = 'S')) THEN
      BEGIN
         /* do any campaigns exist - */
         WK_FOUND = 0;
         SELECT FIRST 1 1  FROM ORDER_GROUP
         INTO :WK_FOUND ;
         IF (WK_FOUND = 1) THEN
         BEGIN
            /* have old campaigns */
            /* so must delete them - this also deletes PICK_ORDER_GROUP */
            UPDATE ORDER_GROUP SET STATUS = 'NC';

            UPDATE PICK_ORDER_GROUP SET STATUS = 'NC';

         END
      END
   END
END ^

CREATE TRIGGER RUN_TRANSACTION_GCID FOR TRANSACTIONS4 
ACTIVE AFTER INSERT POSITION 9 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_DATA_FIELDS INTEGER;
DECLARE VARIABLE WK_FIELD_NO INTEGER;
DECLARE VARIABLE WK_WORK_DATA VARCHAR(1024);
DECLARE VARIABLE WK_WORK_LABEL VARCHAR(1024);
DECLARE VARIABLE WK_WORK_FIELD VARCHAR(1024);
DECLARE VARIABLE WK_STATUS VARCHAR(5);
DECLARE VARIABLE WK_CAMPAIGN VARCHAR(10);
DECLARE VARIABLE WK_LAST_ORDER INTEGER;
DECLARE VARIABLE WK_ORDER1 VARCHAR(15);
DECLARE VARIABLE WK_ORDER2 VARCHAR(15);
DECLARE VARIABLE WK_ORDER3 VARCHAR(15);
DECLARE VARIABLE WK_ORDER4 VARCHAR(15);
DECLARE VARIABLE WK_ORDER5 VARCHAR(15);
DECLARE VARIABLE WK_ORDER6 VARCHAR(15);
DECLARE VARIABLE WK_ORDER7 VARCHAR(15);
DECLARE VARIABLE WK_ORDER8 VARCHAR(15);
DECLARE VARIABLE WK_ORDER9 VARCHAR(15);
DECLARE VARIABLE WK_ORDER10 VARCHAR(15);
DECLARE VARIABLE WK_ORDER11 VARCHAR(15);
DECLARE VARIABLE WK_ORDER12 VARCHAR(15);
DECLARE VARIABLE WK_ORDER13 VARCHAR(15);
DECLARE VARIABLE WK_ORDER14 VARCHAR(15);
DECLARE VARIABLE WK_ORDER15 VARCHAR(15);
DECLARE VARIABLE WK_ORDER16 VARCHAR(15);
DECLARE VARIABLE WK_ORDER17 VARCHAR(15);
DECLARE VARIABLE WK_ORDER18 VARCHAR(15);
DECLARE VARIABLE WK_ORDER19 VARCHAR(15);
DECLARE VARIABLE WK_ORDER20 VARCHAR(15);
DECLARE VARIABLE WK_ORDER21 VARCHAR(15);
DECLARE VARIABLE WK_ORDER22 VARCHAR(15);
DECLARE VARIABLE WK_ORDER23 VARCHAR(15);
DECLARE VARIABLE WK_ORDER24 VARCHAR(15);
DECLARE VARIABLE WK_ORDER25 VARCHAR(15);
DECLARE VARIABLE WK_ORDER26 VARCHAR(15);
DECLARE VARIABLE WK_ORDER27 VARCHAR(15);
DECLARE VARIABLE WK_ORDER28 VARCHAR(15);
DECLARE VARIABLE WK_ORDER29 VARCHAR(15);
DECLARE VARIABLE WK_ORDER30 VARCHAR(15);
DECLARE VARIABLE WK_ORDER31 VARCHAR(15);
DECLARE VARIABLE WK_ORDER32 VARCHAR(15);
DECLARE VARIABLE WK_ORDER33 VARCHAR(15);
DECLARE VARIABLE WK_ORDER34 VARCHAR(15);
DECLARE VARIABLE WK_ORDER35 VARCHAR(15);
DECLARE VARIABLE WK_ORDER36 VARCHAR(15);
DECLARE VARIABLE WK_ORDER37 VARCHAR(15);
DECLARE VARIABLE WK_ORDER38 VARCHAR(15);
DECLARE VARIABLE WK_ORDER39 VARCHAR(15);
DECLARE VARIABLE WK_ORDER40 VARCHAR(15);
DECLARE VARIABLE WK_ORDER41 VARCHAR(15);
DECLARE VARIABLE WK_ORDER42 VARCHAR(15);
DECLARE VARIABLE WK_ORDER43 VARCHAR(15);
DECLARE VARIABLE WK_ORDER44 VARCHAR(15);
DECLARE VARIABLE WK_ORDER45 VARCHAR(15);
DECLARE VARIABLE WK_ORDER46 VARCHAR(15);
DECLARE VARIABLE WK_FOUND INTEGER;
BEGIN
   WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
   IF (WK_AUTORUN = 1) THEN
   BEGIN
      IF ((NEW.TRN_TYPE = 'GCID') AND (NEW.TRN_CLASS = 'C')) THEN
      BEGIN
         /* 
            for the data fields must split out the labeltype of data
            and data portions after the first '>'
            field 1 is the Campaign ID
            field 2 is the retrieve status
            up to 34 Contact Instance IDs (if they are length 8)
            or to 33 Contact Instance IDs (if they are length 9)
            or to 46 Contact Instance IDs (if they are length 1)
            field 3-35 is the ContactInstanceID

         */
         WK_STATUS = '';
         WK_CAMPAIGN = '';
         WK_LAST_ORDER = 0;
         WK_ORDER1 = '';
         WK_ORDER2 = '';
         WK_ORDER3 = '';
         WK_ORDER4 = '';
         WK_ORDER5 = '';
         WK_ORDER6 = '';
         WK_ORDER7 = '';
         WK_ORDER8 = '';
         WK_ORDER9 = '';
         WK_ORDER10 = '';
         WK_ORDER11 = '';
         WK_ORDER12 = '';
         WK_ORDER13 = '';
         WK_ORDER14 = '';
         WK_ORDER15 = '';
         WK_ORDER16 = '';
         WK_ORDER17 = '';
         WK_ORDER18 = '';
         WK_ORDER19 = '';
         WK_ORDER20 = '';
         WK_ORDER21 = '';
         WK_ORDER22 = '';
         WK_ORDER23 = '';
         WK_ORDER24 = '';
         WK_ORDER25 = '';
         WK_ORDER26 = '';
         WK_ORDER27 = '';
         WK_ORDER28 = '';
         WK_ORDER29 = '';
         WK_ORDER30 = '';
         WK_ORDER31 = '';
         WK_ORDER32 = '';
         WK_ORDER33 = '';
         WK_ORDER34 = '';
         WK_ORDER35 = '';
         WK_ORDER36 = '';
         WK_ORDER37 = '';
         WK_ORDER38 = '';
         WK_ORDER39 = '';
         WK_ORDER40 = '';
         WK_ORDER41 = '';
         WK_ORDER42 = '';
         WK_ORDER43 = '';
         WK_ORDER44 = '';
         WK_ORDER45 = '';
         WK_ORDER46 = '';

         WK_DATA_FIELDS = STRLEN(NEW.INPUT_SOURCE) ;
         WK_FIELD_NO = 1;
         WHILE (WK_FIELD_NO < WK_DATA_FIELDS) DO
         BEGIN
            SELECT WK_FIELD_TEXT 
            FROM GET_REFERENCE_FIELD4 (NEW.TRN_DATA, :WK_FIELD_NO, NEW.TRN_DELIMITER) 
            INTO :WK_WORK_FIELD;
            /* now for this field get the label and data */
            SELECT WK_FIELD_LABEL, WK_FIELD_DATA 
            FROM GET_DATA_REFERENCE_FIELD4 (:WK_WORK_FIELD, '>')
            INTO :WK_WORK_LABEL, :WK_WORK_DATA;

            IF (WK_WORK_LABEL = '<CampaignID') THEN
            BEGIN
               WK_CAMPAIGN = WK_WORK_DATA;
               WK_LAST_ORDER = 0;
            END
            IF (WK_WORK_LABEL = '<CampaignContactInstanceRetrieveStatus') THEN
            BEGIN
               WK_STATUS = WK_WORK_DATA;
            END
            IF (WK_WORK_LABEL = '<ContactInstanceID') THEN
            BEGIN
               WK_LAST_ORDER = WK_LAST_ORDER + 1;
               IF (WK_LAST_ORDER = 1) THEN
                  WK_ORDER1 = WK_WORK_DATA;
               ELSE
               IF (WK_LAST_ORDER = 2) THEN
                  WK_ORDER2 = WK_WORK_DATA;
               ELSE
               IF (WK_LAST_ORDER = 3) THEN
                  WK_ORDER3 = WK_WORK_DATA;
               ELSE
               IF (WK_LAST_ORDER = 4) THEN
                  WK_ORDER4 = WK_WORK_DATA;
               ELSE
               IF (WK_LAST_ORDER = 5) THEN
                  WK_ORDER5 = WK_WORK_DATA;
               ELSE
               IF (WK_LAST_ORDER = 6) THEN
                  WK_ORDER6 = WK_WORK_DATA;
               ELSE
               IF (WK_LAST_ORDER = 7) THEN
                  WK_ORDER7 = WK_WORK_DATA;
               ELSE
               IF (WK_LAST_ORDER = 8) THEN
                  WK_ORDER8 = WK_WORK_DATA;
               ELSE
               IF (WK_LAST_ORDER = 9) THEN
                  WK_ORDER9 = WK_WORK_DATA;
               ELSE
               IF (WK_LAST_ORDER = 10) THEN
                  WK_ORDER10 = WK_WORK_DATA;
               ELSE
               IF (WK_LAST_ORDER = 11) THEN
                  WK_ORDER11 = WK_WORK_DATA;
               ELSE
               IF (WK_LAST_ORDER = 12) THEN
                  WK_ORDER12 = WK_WORK_DATA;
               ELSE
               IF (WK_LAST_ORDER = 13) THEN
                  WK_ORDER13 = WK_WORK_DATA;
               ELSE
               IF (WK_LAST_ORDER = 14) THEN
                  WK_ORDER14 = WK_WORK_DATA;
               ELSE
               IF (WK_LAST_ORDER = 15) THEN
                  WK_ORDER15 = WK_WORK_DATA;
               ELSE
               IF (WK_LAST_ORDER = 16) THEN
                  WK_ORDER16 = WK_WORK_DATA;
               ELSE
               IF (WK_LAST_ORDER = 17) THEN
                  WK_ORDER17 = WK_WORK_DATA;
               ELSE
               IF (WK_LAST_ORDER = 18) THEN
                  WK_ORDER18 = WK_WORK_DATA;
               ELSE
               IF (WK_LAST_ORDER = 19) THEN
                  WK_ORDER19 = WK_WORK_DATA;
               ELSE
               IF (WK_LAST_ORDER = 20) THEN
                  WK_ORDER20 = WK_WORK_DATA;
               ELSE
               IF (WK_LAST_ORDER = 21) THEN
                  WK_ORDER21 = WK_WORK_DATA;
               ELSE
               IF (WK_LAST_ORDER = 22) THEN
                  WK_ORDER22 = WK_WORK_DATA;
               ELSE
               IF (WK_LAST_ORDER = 23) THEN
                  WK_ORDER23 = WK_WORK_DATA;
               ELSE
               IF (WK_LAST_ORDER = 24) THEN
                  WK_ORDER24 = WK_WORK_DATA;
               ELSE
               IF (WK_LAST_ORDER = 25) THEN
                  WK_ORDER25 = WK_WORK_DATA;
               ELSE
               IF (WK_LAST_ORDER = 26) THEN
                  WK_ORDER26 = WK_WORK_DATA;
               ELSE
               IF (WK_LAST_ORDER = 27) THEN
                  WK_ORDER27 = WK_WORK_DATA;
               ELSE
               IF (WK_LAST_ORDER = 28) THEN
                  WK_ORDER28 = WK_WORK_DATA;
               ELSE
               IF (WK_LAST_ORDER = 29) THEN
                  WK_ORDER29 = WK_WORK_DATA;
               ELSE
               IF (WK_LAST_ORDER = 30) THEN
                  WK_ORDER30 = WK_WORK_DATA;
               ELSE
               IF (WK_LAST_ORDER = 31) THEN
                  WK_ORDER31 = WK_WORK_DATA;
               ELSE
               IF (WK_LAST_ORDER = 32) THEN
                  WK_ORDER32 = WK_WORK_DATA;
               ELSE
               IF (WK_LAST_ORDER = 33) THEN
                  WK_ORDER33 = WK_WORK_DATA;
               ELSE
               IF (WK_LAST_ORDER = 34) THEN
                  WK_ORDER34 = WK_WORK_DATA;
               ELSE
               IF (WK_LAST_ORDER = 35) THEN
                  WK_ORDER35 = WK_WORK_DATA;
               ELSE
               IF (WK_LAST_ORDER = 36) THEN
                  WK_ORDER36 = WK_WORK_DATA;
               ELSE
               IF (WK_LAST_ORDER = 37) THEN
                  WK_ORDER37 = WK_WORK_DATA;
               ELSE
               IF (WK_LAST_ORDER = 38) THEN
                  WK_ORDER38 = WK_WORK_DATA;
               ELSE
               IF (WK_LAST_ORDER = 39) THEN
                  WK_ORDER39 = WK_WORK_DATA;
               ELSE
               IF (WK_LAST_ORDER = 40) THEN
                  WK_ORDER40 = WK_WORK_DATA;
               ELSE
               IF (WK_LAST_ORDER = 41) THEN
                  WK_ORDER41 = WK_WORK_DATA;
               ELSE
               IF (WK_LAST_ORDER = 42) THEN
                  WK_ORDER42 = WK_WORK_DATA;
               ELSE
               IF (WK_LAST_ORDER = 43) THEN
                  WK_ORDER43 = WK_WORK_DATA;
               ELSE
               IF (WK_LAST_ORDER = 44) THEN
                  WK_ORDER44 = WK_WORK_DATA;
               ELSE
               IF (WK_LAST_ORDER = 45) THEN
                  WK_ORDER45 = WK_WORK_DATA;
               ELSE
               IF (WK_LAST_ORDER = 46) THEN
                  WK_ORDER46 = WK_WORK_DATA;

            END
            WK_FIELD_NO = WK_FIELD_NO + 1;
         END
         IF (WK_STATUS = 'true') THEN
         BEGIN
            WK_STATUS = 'T';
         END
         ELSE
         BEGIN
            WK_STATUS = 'F';
         END
         /* do pick campaigns for this campaign */
         IF (WK_ORDER1 > '') THEN
         BEGIN
            EXECUTE PROCEDURE ADD_ORDER_GROUP_PICK(:WK_CAMPAIGN, :WK_ORDER1, NEW.PERSON_ID);
         END
         IF (WK_ORDER2 > '') THEN
         BEGIN
            EXECUTE PROCEDURE ADD_ORDER_GROUP_PICK(:WK_CAMPAIGN, :WK_ORDER2, NEW.PERSON_ID);
         END
         IF (WK_ORDER3 > '') THEN
         BEGIN
            EXECUTE PROCEDURE ADD_ORDER_GROUP_PICK(:WK_CAMPAIGN, :WK_ORDER3, NEW.PERSON_ID);
         END
         IF (WK_ORDER4 > '') THEN
         BEGIN
            EXECUTE PROCEDURE ADD_ORDER_GROUP_PICK(:WK_CAMPAIGN, :WK_ORDER4, NEW.PERSON_ID);
         END
         IF (WK_ORDER5 > '') THEN
         BEGIN
            EXECUTE PROCEDURE ADD_ORDER_GROUP_PICK(:WK_CAMPAIGN, :WK_ORDER5, NEW.PERSON_ID);
         END
         IF (WK_ORDER6 > '') THEN
         BEGIN
            EXECUTE PROCEDURE ADD_ORDER_GROUP_PICK(:WK_CAMPAIGN, :WK_ORDER6, NEW.PERSON_ID);
         END
         IF (WK_ORDER7 > '') THEN
         BEGIN
            EXECUTE PROCEDURE ADD_ORDER_GROUP_PICK(:WK_CAMPAIGN, :WK_ORDER7, NEW.PERSON_ID);
         END
         IF (WK_ORDER8 > '') THEN
         BEGIN
            EXECUTE PROCEDURE ADD_ORDER_GROUP_PICK(:WK_CAMPAIGN, :WK_ORDER8, NEW.PERSON_ID);
         END
         IF (WK_ORDER9 > '') THEN
         BEGIN
            EXECUTE PROCEDURE ADD_ORDER_GROUP_PICK(:WK_CAMPAIGN, :WK_ORDER9, NEW.PERSON_ID);
         END
         IF (WK_ORDER10 > '') THEN
         BEGIN
            EXECUTE PROCEDURE ADD_ORDER_GROUP_PICK(:WK_CAMPAIGN, :WK_ORDER10, NEW.PERSON_ID);
         END
         IF (WK_ORDER11 > '') THEN
         BEGIN
            EXECUTE PROCEDURE ADD_ORDER_GROUP_PICK(:WK_CAMPAIGN, :WK_ORDER11, NEW.PERSON_ID);
         END
         IF (WK_ORDER12 > '') THEN
         BEGIN
            EXECUTE PROCEDURE ADD_ORDER_GROUP_PICK(:WK_CAMPAIGN, :WK_ORDER12, NEW.PERSON_ID);
         END
         IF (WK_ORDER13 > '') THEN
         BEGIN
            EXECUTE PROCEDURE ADD_ORDER_GROUP_PICK(:WK_CAMPAIGN, :WK_ORDER13, NEW.PERSON_ID);
         END
         IF (WK_ORDER14 > '') THEN
         BEGIN
            EXECUTE PROCEDURE ADD_ORDER_GROUP_PICK(:WK_CAMPAIGN, :WK_ORDER14, NEW.PERSON_ID);
         END
         IF (WK_ORDER15 > '') THEN
         BEGIN
            EXECUTE PROCEDURE ADD_ORDER_GROUP_PICK(:WK_CAMPAIGN, :WK_ORDER15, NEW.PERSON_ID);
         END
         IF (WK_ORDER16 > '') THEN
         BEGIN
            EXECUTE PROCEDURE ADD_ORDER_GROUP_PICK(:WK_CAMPAIGN, :WK_ORDER16, NEW.PERSON_ID);
         END
         IF (WK_ORDER17 > '') THEN
         BEGIN
            EXECUTE PROCEDURE ADD_ORDER_GROUP_PICK(:WK_CAMPAIGN, :WK_ORDER17, NEW.PERSON_ID);
         END
         IF (WK_ORDER18 > '') THEN
         BEGIN
            EXECUTE PROCEDURE ADD_ORDER_GROUP_PICK(:WK_CAMPAIGN, :WK_ORDER18, NEW.PERSON_ID);
         END
         IF (WK_ORDER19 > '') THEN
         BEGIN
            EXECUTE PROCEDURE ADD_ORDER_GROUP_PICK(:WK_CAMPAIGN, :WK_ORDER19, NEW.PERSON_ID);
         END
         IF (WK_ORDER20 > '') THEN
         BEGIN
            EXECUTE PROCEDURE ADD_ORDER_GROUP_PICK(:WK_CAMPAIGN, :WK_ORDER20, NEW.PERSON_ID);
         END
         IF (WK_ORDER21 > '') THEN
         BEGIN
            EXECUTE PROCEDURE ADD_ORDER_GROUP_PICK(:WK_CAMPAIGN, :WK_ORDER21, NEW.PERSON_ID);
         END
         IF (WK_ORDER22 > '') THEN
         BEGIN
            EXECUTE PROCEDURE ADD_ORDER_GROUP_PICK(:WK_CAMPAIGN, :WK_ORDER22, NEW.PERSON_ID);
         END
         IF (WK_ORDER23 > '') THEN
         BEGIN
            EXECUTE PROCEDURE ADD_ORDER_GROUP_PICK(:WK_CAMPAIGN, :WK_ORDER23, NEW.PERSON_ID);
         END
         IF (WK_ORDER24 > '') THEN
         BEGIN
            EXECUTE PROCEDURE ADD_ORDER_GROUP_PICK(:WK_CAMPAIGN, :WK_ORDER24, NEW.PERSON_ID);
         END
         IF (WK_ORDER25 > '') THEN
         BEGIN
            EXECUTE PROCEDURE ADD_ORDER_GROUP_PICK(:WK_CAMPAIGN, :WK_ORDER25, NEW.PERSON_ID);
         END
         IF (WK_ORDER26 > '') THEN
         BEGIN
            EXECUTE PROCEDURE ADD_ORDER_GROUP_PICK(:WK_CAMPAIGN, :WK_ORDER26, NEW.PERSON_ID);
         END
         IF (WK_ORDER27 > '') THEN
         BEGIN
            EXECUTE PROCEDURE ADD_ORDER_GROUP_PICK(:WK_CAMPAIGN, :WK_ORDER27, NEW.PERSON_ID);
         END
         IF (WK_ORDER28 > '') THEN
         BEGIN
            EXECUTE PROCEDURE ADD_ORDER_GROUP_PICK(:WK_CAMPAIGN, :WK_ORDER28, NEW.PERSON_ID);
         END
         IF (WK_ORDER29 > '') THEN
         BEGIN
            EXECUTE PROCEDURE ADD_ORDER_GROUP_PICK(:WK_CAMPAIGN, :WK_ORDER29, NEW.PERSON_ID);
         END
         IF (WK_ORDER30 > '') THEN
         BEGIN
            EXECUTE PROCEDURE ADD_ORDER_GROUP_PICK(:WK_CAMPAIGN, :WK_ORDER30, NEW.PERSON_ID);
         END
         IF (WK_ORDER31 > '') THEN
         BEGIN
            EXECUTE PROCEDURE ADD_ORDER_GROUP_PICK(:WK_CAMPAIGN, :WK_ORDER31, NEW.PERSON_ID);
         END
         IF (WK_ORDER32 > '') THEN
         BEGIN
            EXECUTE PROCEDURE ADD_ORDER_GROUP_PICK(:WK_CAMPAIGN, :WK_ORDER32, NEW.PERSON_ID);
         END
         IF (WK_ORDER33 > '') THEN
         BEGIN
            EXECUTE PROCEDURE ADD_ORDER_GROUP_PICK(:WK_CAMPAIGN, :WK_ORDER33, NEW.PERSON_ID);
         END
         IF (WK_ORDER34 > '') THEN
         BEGIN
            EXECUTE PROCEDURE ADD_ORDER_GROUP_PICK(:WK_CAMPAIGN, :WK_ORDER34, NEW.PERSON_ID);
         END
         IF (WK_ORDER35 > '') THEN
         BEGIN
            EXECUTE PROCEDURE ADD_ORDER_GROUP_PICK(:WK_CAMPAIGN, :WK_ORDER35, NEW.PERSON_ID);
         END
         IF (WK_ORDER36 > '') THEN
         BEGIN
            EXECUTE PROCEDURE ADD_ORDER_GROUP_PICK(:WK_CAMPAIGN, :WK_ORDER36, NEW.PERSON_ID);
         END
         IF (WK_ORDER37 > '') THEN
         BEGIN
            EXECUTE PROCEDURE ADD_ORDER_GROUP_PICK(:WK_CAMPAIGN, :WK_ORDER37, NEW.PERSON_ID);
         END
         IF (WK_ORDER38 > '') THEN
         BEGIN
            EXECUTE PROCEDURE ADD_ORDER_GROUP_PICK(:WK_CAMPAIGN, :WK_ORDER38, NEW.PERSON_ID);
         END
         IF (WK_ORDER39 > '') THEN
         BEGIN
            EXECUTE PROCEDURE ADD_ORDER_GROUP_PICK(:WK_CAMPAIGN, :WK_ORDER39, NEW.PERSON_ID);
         END
         IF (WK_ORDER40 > '') THEN
         BEGIN
            EXECUTE PROCEDURE ADD_ORDER_GROUP_PICK(:WK_CAMPAIGN, :WK_ORDER40, NEW.PERSON_ID);
         END
         IF (WK_ORDER41 > '') THEN
         BEGIN
            EXECUTE PROCEDURE ADD_ORDER_GROUP_PICK(:WK_CAMPAIGN, :WK_ORDER41, NEW.PERSON_ID);
         END
         IF (WK_ORDER42 > '') THEN
         BEGIN
            EXECUTE PROCEDURE ADD_ORDER_GROUP_PICK(:WK_CAMPAIGN, :WK_ORDER42, NEW.PERSON_ID);
         END
         IF (WK_ORDER43 > '') THEN
         BEGIN
            EXECUTE PROCEDURE ADD_ORDER_GROUP_PICK(:WK_CAMPAIGN, :WK_ORDER43, NEW.PERSON_ID);
         END
         IF (WK_ORDER44 > '') THEN
         BEGIN
            EXECUTE PROCEDURE ADD_ORDER_GROUP_PICK(:WK_CAMPAIGN, :WK_ORDER44, NEW.PERSON_ID);
         END
         IF (WK_ORDER45 > '') THEN
         BEGIN
            EXECUTE PROCEDURE ADD_ORDER_GROUP_PICK(:WK_CAMPAIGN, :WK_ORDER45, NEW.PERSON_ID);
         END
         IF (WK_ORDER46 > '') THEN
         BEGIN
            EXECUTE PROCEDURE ADD_ORDER_GROUP_PICK(:WK_CAMPAIGN, :WK_ORDER46, NEW.PERSON_ID);
         END
         /* update the status */
         UPDATE ORDER_GROUP
         SET PICK_RETRIEVE_STATUS = :WK_STATUS
         WHERE ORDER_GROUP_ID = :WK_CAMPAIGN;

         /* Update transactions table */        
         EXECUTE PROCEDURE UPDATE_TRAN4 (NEW.RECORD_ID, 'T', 'Processed successfully');
         EXECUTE PROCEDURE TRAN4_ARCHIVE;
      END
   END
END ^

CREATE TRIGGER RUN_TRANSACTION_GSMD FOR TRANSACTIONS4 
ACTIVE AFTER INSERT POSITION 10 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_DATA_FIELDS INTEGER;
DECLARE VARIABLE WK_FIELD_NO INTEGER;
DECLARE VARIABLE WK_WORK_DATA VARCHAR(1024);
DECLARE VARIABLE WK_WORK_LABEL VARCHAR(1024);
DECLARE VARIABLE WK_WORK_FIELD VARCHAR(1024);
DECLARE VARIABLE WK_STATUS VARCHAR(5);
DECLARE VARIABLE WK_ORDER VARCHAR(15);
DECLARE VARIABLE WK_INSTRUCTION VARCHAR(1024);
DECLARE VARIABLE WK_FOUND INTEGER;
BEGIN
   WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
   IF (WK_AUTORUN = 1) THEN
   BEGIN
      IF ((NEW.TRN_TYPE = 'GSMD') AND (NEW.TRN_CLASS = 'C')) THEN
      BEGIN
         /* 
            for the data fields must split out the labeltype of data
            and data portions after the first '>'
            field 1 is the Order No
            field 2 is the Instruction
            field 3 is the Retrieve Status
         */
         WK_STATUS = '';
         WK_ORDER = '';
         WK_INSTRUCTION = '';

         WK_DATA_FIELDS = STRLEN(NEW.INPUT_SOURCE) ;
         WK_FIELD_NO = 1;
         WHILE (WK_FIELD_NO < WK_DATA_FIELDS) DO
         BEGIN
            SELECT WK_FIELD_TEXT 
            FROM GET_REFERENCE_FIELD4 (NEW.TRN_DATA, :WK_FIELD_NO, NEW.TRN_DELIMITER) 
            INTO :WK_WORK_FIELD;
            /* now for this field get the label and data */
            SELECT WK_FIELD_LABEL, WK_FIELD_DATA 
            FROM GET_DATA_REFERENCE_FIELD4 (:WK_WORK_FIELD, '>')
            INTO :WK_WORK_LABEL, :WK_WORK_DATA;

            IF (WK_WORK_LABEL = '<ContactInstanceID') THEN
            BEGIN
               WK_ORDER = WK_WORK_DATA;
            END
            IF (WK_WORK_LABEL = '<InstructionText') THEN
            BEGIN
               WK_INSTRUCTION = WK_WORK_DATA;
            END
            IF (WK_WORK_LABEL = '<SpecialMailoutRetrieveStatus') THEN
            BEGIN
               WK_STATUS = WK_WORK_DATA;
            END
            WK_FIELD_NO = WK_FIELD_NO + 1;
         END
         IF (WK_STATUS = 'true') THEN
         BEGIN
            WK_STATUS = 'T';
         END
         ELSE
         BEGIN
            WK_STATUS = 'F';
         END
/*
         IF (STRLEN(WK_INSTRUCTION) > 255) THEN
         BEGIN
            WK_INSTRUCTION = V4SUBSTRING(WK_INSTRUCTION, 1, 255);
         END
*/
         /* does owner person type exist */
         WK_FOUND = 0;
         SELECT 1 FROM PICK_ORDER
         WHERE PICK_ORDER = :WK_ORDER
         INTO :WK_FOUND ;
         IF (WK_FOUND = 0) THEN
         BEGIN
            INSERT INTO PICK_ORDER(PICK_ORDER, PICK_STATUS, SPECIAL_INSTRUCTIONS2, CREATE_DATE, CREATED_BY, PICK_RETRIEVE_STATUS, SPECIAL_INSTRUCTIONS)
            VALUES (:WK_ORDER, 'UC', :WK_INSTRUCTION, 'NOW',NEW.PERSON_ID, :WK_STATUS, :WK_STATUS);
         END
         ELSE
         BEGIN
            UPDATE PICK_ORDER
            SET SPECIAL_INSTRUCTIONS2 = :WK_INSTRUCTION,
            SPECIAL_INSTRUCTIONS = :WK_STATUS,
            PICK_RETRIEVE_STATUS = :WK_STATUS
            WHERE PICK_ORDER = :WK_ORDER;
         END

         /* Update transactions table */        
         EXECUTE PROCEDURE UPDATE_TRAN4 (NEW.RECORD_ID, 'T', 'Processed successfully');
         EXECUTE PROCEDURE TRAN4_ARCHIVE;
      END
   END
END ^

CREATE TRIGGER RUN_TRANSACTION_GCNA FOR TRANSACTIONS4 
ACTIVE AFTER INSERT POSITION 11 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_DATA_FIELDS INTEGER;
DECLARE VARIABLE WK_FIELD_NO INTEGER;
DECLARE VARIABLE WK_WORK_DATA VARCHAR(1024);
DECLARE VARIABLE WK_WORK_LABEL VARCHAR(1024);
DECLARE VARIABLE WK_WORK_FIELD VARCHAR(1024);
DECLARE VARIABLE WK_STATUS VARCHAR(5);
DECLARE VARIABLE WK_ORDER VARCHAR(15);
DECLARE VARIABLE WK_PERSON VARCHAR(10);
DECLARE VARIABLE WK_TITLE VARCHAR(10);
DECLARE VARIABLE WK_FIRST_NAME VARCHAR(255);
DECLARE VARIABLE WK_SHORT_FIRST_NAME VARCHAR(50);
DECLARE VARIABLE WK_LAST_NAME VARCHAR(50);
DECLARE VARIABLE WK_LINE1 VARCHAR(100);
DECLARE VARIABLE WK_LINE2 VARCHAR(50);
DECLARE VARIABLE WK_LINE3 VARCHAR(50);
DECLARE VARIABLE WK_LINE4 VARCHAR(50);
DECLARE VARIABLE WK_4STATE_ID VARCHAR(255);
DECLARE VARIABLE WK_FOUND INTEGER;
BEGIN
   WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
   IF (WK_AUTORUN = 1) THEN
   BEGIN
      IF ((NEW.TRN_TYPE = 'GCNA') AND (NEW.TRN_CLASS = 'C')) THEN
      BEGIN
         /* 
            for the data fields must split out the labeltype of data
            and data portions after the first '>'
            field 1 is the Order No
            field 2 is the Retrieve Status
            field 3 is the Salutation
            field 4 is the First Name
            field 5 is the Last Name
            field 6 is the Address Line1
            field 7 is the Address Line2
            field 8 is the Address Line3
            field 9 is the Address Line4
            field 10 is the Australian Post 4 State Code
         */
         WK_STATUS = '';
         WK_ORDER = '';
         WK_TITLE = '';
         WK_FIRST_NAME = '';
         WK_SHORT_FIRST_NAME = '';
         WK_LAST_NAME = '';
         WK_LINE1 = '';
         WK_LINE2 = '';
         WK_LINE3 = '';
         WK_LINE4 = '';
         WK_4STATE_ID = '';
         WK_PERSON = '';

         WK_DATA_FIELDS = STRLEN(NEW.INPUT_SOURCE) ;
         WK_FIELD_NO = 1;
         WHILE (WK_FIELD_NO < WK_DATA_FIELDS) DO
         BEGIN
            SELECT WK_FIELD_TEXT 
            FROM GET_REFERENCE_FIELD4 (NEW.TRN_DATA, :WK_FIELD_NO, NEW.TRN_DELIMITER) 
            INTO :WK_WORK_FIELD;
            /* now for this field get the label and data */
            SELECT WK_FIELD_LABEL, WK_FIELD_DATA 
            FROM GET_DATA_REFERENCE_FIELD4 (:WK_WORK_FIELD, '>')
            INTO :WK_WORK_LABEL, :WK_WORK_DATA;

            IF ((WK_WORK_LABEL = 'ContactInstanceID') OR
                (WK_WORK_LABEL = '<ContactInstanceID')) THEN
            BEGIN
               WK_ORDER = WK_WORK_DATA;
            END
            IF ((WK_WORK_LABEL = 'ContactInstanceNameAndAddressRetrieveStatus') OR
                (WK_WORK_LABEL = '<ContactInstanceNameAndAddressRetrieveStatus')) THEN
            BEGIN
               WK_STATUS = WK_WORK_DATA;
            END
            IF ((WK_WORK_LABEL = 'Salutation') OR
                (WK_WORK_LABEL = '<Salutation')) THEN
            BEGIN
               WK_TITLE = WK_WORK_DATA;
            END
            IF ((WK_WORK_LABEL = 'FirstName') OR
                (WK_WORK_LABEL = '<FirstName')) THEN
            BEGIN
               WK_FIRST_NAME = WK_WORK_DATA;
               IF (STRLEN(WK_FIRST_NAME) < 51) THEN
               BEGIN
                  WK_SHORT_FIRST_NAME = WK_FIRST_NAME;
               END
               ELSE
               BEGIN
                  WK_SHORT_FIRST_NAME = V4SUBSTRING(WK_FIRST_NAME, 1, 50);
               END
            END
            IF ((WK_WORK_LABEL = 'LastName') OR
                (WK_WORK_LABEL = '<LastName')) THEN
            BEGIN
               WK_LAST_NAME = WK_WORK_DATA;
            END
            IF ((WK_WORK_LABEL = 'Line1') OR
                (WK_WORK_LABEL = '<Line1')) THEN
            BEGIN
               WK_LINE1 = WK_WORK_DATA;
            END
            IF ((WK_WORK_LABEL = 'Line2') OR
                (WK_WORK_LABEL = '<Line2')) THEN
            BEGIN
               WK_LINE2 = WK_WORK_DATA;
            END
            IF ((WK_WORK_LABEL = 'Line3') OR
                (WK_WORK_LABEL = '<Line3')) THEN
            BEGIN
               WK_LINE3 = WK_WORK_DATA;
            END
            IF ((WK_WORK_LABEL = 'Line4') OR
                (WK_WORK_LABEL = '<Line4')) THEN
            BEGIN
               WK_LINE4 = WK_WORK_DATA;
            END
            IF ((WK_WORK_LABEL = 'AustPost4StateID') OR
                (WK_WORK_LABEL = '<AustPost4StateID')) THEN
            BEGIN
               WK_4STATE_ID = WK_WORK_DATA;
            END
            WK_FIELD_NO = WK_FIELD_NO + 1;
         END
         IF (WK_STATUS = 'true') THEN
         BEGIN
            WK_STATUS = 'T';
         END
         ELSE
         BEGIN
            WK_STATUS = 'F';
         END
         /* does order exist */
         WK_FOUND = 0;
         SELECT 1, PERSON_ID FROM PICK_ORDER
         WHERE PICK_ORDER = :WK_ORDER
         INTO :WK_FOUND, :WK_PERSON ;
         IF (WK_FOUND = 0) THEN
         BEGIN
            WK_PERSON = 'UNKNOWN';
            INSERT INTO PICK_ORDER(PICK_ORDER, 
               PICK_STATUS, 
               PERSON_ID, 
               P_TITLE, 
               P_FIRST_NAME, 
               P_LAST_NAME, 
               P_ADDRESS_LINE1, 
               P_ADDRESS_LINE2, 
               P_ADDRESS_LINE3, 
               P_ADDRESS_LINE4, 
               P_AUST_POST_4STATE_ID, 
               D_TITLE, 
               D_FIRST_NAME, 
               D_LAST_NAME, 
               D_ADDRESS_LINE1, 
               D_ADDRESS_LINE2, 
               D_ADDRESS_LINE3, 
               D_ADDRESS_LINE4, 
               P_SAME_AS_INVOICE_TO,
               CREATE_DATE, 
               CREATED_BY, 
               PICK_RETRIEVE_STATUS)
            VALUES (:WK_ORDER, 
               'UC', 
               :WK_PERSON, 
               :WK_TITLE, 
               :WK_SHORT_FIRST_NAME, 
               :WK_LAST_NAME, 
               :WK_LINE1, 
               :WK_LINE2, 
               :WK_LINE3, 
               :WK_LINE4, 
               :WK_4STATE_ID, 
               :WK_TITLE, 
               :WK_SHORT_FIRST_NAME, 
               :WK_LAST_NAME, 
               :WK_LINE1, 
               :WK_LINE2, 
               :WK_LINE3, 
               :WK_LINE4, 
               'T',
               'NOW',
               NEW.PERSON_ID, 
               :WK_STATUS);
         END
         ELSE
         BEGIN
            IF (WK_PERSON IS NULL) THEN
            BEGIN
               WK_PERSON = 'UNKNOWN';
               UPDATE PICK_ORDER
               SET P_TITLE = :WK_TITLE, 
                  PERSON_ID = :WK_PERSON, 
                  P_FIRST_NAME = :WK_SHORT_FIRST_NAME, 
                  P_LAST_NAME = :WK_LAST_NAME, 
                  P_ADDRESS_LINE1 = :WK_LINE1, 
                  P_ADDRESS_LINE2 = :WK_LINE2, 
                  P_ADDRESS_LINE3 = :WK_LINE3, 
                  P_ADDRESS_LINE4 = :WK_LINE4, 
                  P_AUST_POST_4STATE_ID = :WK_4STATE_ID, 
                  D_TITLE = :WK_TITLE, 
                  D_FIRST_NAME = :WK_SHORT_FIRST_NAME, 
                  D_LAST_NAME = :WK_LAST_NAME, 
                  D_ADDRESS_LINE1 = :WK_LINE1, 
                  D_ADDRESS_LINE2 = :WK_LINE2, 
                  D_ADDRESS_LINE3 = :WK_LINE3, 
                  D_ADDRESS_LINE4 = :WK_LINE4, 
                  P_SAME_AS_INVOICE_TO = 'T',
               PICK_RETRIEVE_STATUS = :WK_STATUS
               WHERE PICK_ORDER = :WK_ORDER;
            END
            ELSE
            BEGIN
               UPDATE PICK_ORDER
               SET P_TITLE = :WK_TITLE, 
                  P_FIRST_NAME = :WK_SHORT_FIRST_NAME, 
                  P_LAST_NAME = :WK_LAST_NAME, 
                  P_ADDRESS_LINE1 = :WK_LINE1, 
                  P_ADDRESS_LINE2 = :WK_LINE2, 
                  P_ADDRESS_LINE3 = :WK_LINE3, 
                  P_ADDRESS_LINE4 = :WK_LINE4, 
                  P_AUST_POST_4STATE_ID = :WK_4STATE_ID, 
                  D_TITLE = :WK_TITLE, 
                  D_FIRST_NAME = :WK_SHORT_FIRST_NAME, 
                  D_LAST_NAME = :WK_LAST_NAME, 
                  D_ADDRESS_LINE1 = :WK_LINE1, 
                  D_ADDRESS_LINE2 = :WK_LINE2, 
                  D_ADDRESS_LINE3 = :WK_LINE3, 
                  D_ADDRESS_LINE4 = :WK_LINE4, 
                  P_SAME_AS_INVOICE_TO = 'T',
               PICK_RETRIEVE_STATUS = :WK_STATUS
               WHERE PICK_ORDER = :WK_ORDER;
            END
         END

         /* does person exist */
         WK_FOUND = 0;
         /* dont add all these for mailroom
         SELECT 1 FROM PERSON
         WHERE PERSON_ID = :WK_PERSON
         INTO :WK_FOUND ;
         IF (WK_FOUND = 0) THEN
         BEGIN
            INSERT INTO PERSON(PERSON_ID, 
               TITLE, 
               FIRST_NAME, 
               LAST_NAME, 
               ADDRESS_LINE1, 
               ADDRESS_LINE2, 
               ADDRESS_LINE3, 
               ADDRESS_LINE4, 
               AUST_POST_4STATE_ID, 
               CREATE_DATE, 
               CREATE_BY )
            VALUES (:WK_PERSON,
               :WK_TITLE, 
               :WK_FIRST_NAME, 
               :WK_LAST_NAME, 
               :WK_LINE1, 
               :WK_LINE2, 
               :WK_LINE3, 
               :WK_LINE4, 
               :WK_4STATE_ID, 
               'NOW',
               NEW.PERSON_ID );
         END
         ELSE
         BEGIN
            UPDATE PERSON
            SET TITLE = :WK_TITLE, 
               FIRST_NAME = :WK_FIRST_NAME, 
               LAST_NAME = :WK_LAST_NAME, 
               ADDRESS_LINE1 = :WK_LINE1, 
               ADDRESS_LINE2 = :WK_LINE2, 
               ADDRESS_LINE3 = :WK_LINE3, 
               ADDRESS_LINE4 = :WK_LINE4, 
               AUST_POST_4STATE_ID = :WK_4STATE_ID 
            WHERE PERSON_ID = :WK_PERSON;
         END
         */

         /* Update transactions table */        
         EXECUTE PROCEDURE UPDATE_TRAN4 (NEW.RECORD_ID, 'T', 'Processed successfully');
         EXECUTE PROCEDURE TRAN4_ARCHIVE;
      END
   END
END ^

CREATE TRIGGER RUN_TRANSACTION_GCLM FOR TRANSACTIONS4 
ACTIVE AFTER INSERT POSITION 12 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_DATA_FIELDS INTEGER;
DECLARE VARIABLE WK_FIELD_NO INTEGER;
DECLARE VARIABLE WK_WORK_DATA VARCHAR(1024);
DECLARE VARIABLE WK_WORK_LABEL VARCHAR(1024);
DECLARE VARIABLE WK_WORK_FIELD VARCHAR(1024);
DECLARE VARIABLE WK_ORDER VARCHAR(15);
DECLARE VARIABLE WK_PROD_ID VARCHAR(30);
DECLARE VARIABLE WK_PROD VARCHAR(30);
DECLARE VARIABLE WK_EXTENSION VARCHAR(6);
DECLARE VARIABLE WK_QTY_X VARCHAR(10);
DECLARE VARIABLE WK_QTY INTEGER;
DECLARE VARIABLE WK_STATUS VARCHAR(5);
DECLARE VARIABLE WK_ORDER_STATUS VARCHAR(5);
DECLARE VARIABLE WK_FOUND INTEGER;
DECLARE VARIABLE WK_PICK_LABEL VARCHAR(7);
DECLARE VARIABLE WK_LABEL_LENGTH INTEGER;
DECLARE VARIABLE WK_LAST_LINE INTEGER;
DECLARE VARIABLE WK_LEN_LINE_NO INTEGER;
DECLARE VARIABLE WK_PICK_LINE_NO VARCHAR(4);
DECLARE VARIABLE WK_L_PICK_LINE_NO VARCHAR(4);
DECLARE VARIABLE WK_LINE_NO VARCHAR(4);
DECLARE VARIABLE WK_ORDER_TYPE CHAR(2);
DECLARE VARIABLE WK_TERM VARCHAR(20);
DECLARE VARIABLE WK_PAYMENT VARCHAR(20);
DECLARE VARIABLE WK_CARRIER VARCHAR(10);
BEGIN
   WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
   IF (WK_AUTORUN = 1) THEN
   BEGIN
      IF ((NEW.TRN_TYPE = 'GCLM') AND (NEW.TRN_CLASS = 'C')) THEN
      BEGIN
         /* 
            for the data fields must split out the labeltype of data
            and data portions after the first '>'
            field 1 is the order 
            field 2 is the product code (EAN)
            field 3 is the quantity 
            field 4 is the Extension (EAN Extension)
            field 5 is the retrieve status 
         */
         WK_ORDER = '';
         WK_STATUS = '';
         WK_PROD = '';
         WK_QTY_X = '';
         WK_QTY = 0;
         WK_EXTENSION = '';
         WK_LINE_NO = '';
         WK_ORDER_TYPE = 'SO';
         WK_DATA_FIELDS = STRLEN(NEW.INPUT_SOURCE) ;
         WK_FIELD_NO = 1;
         WHILE (WK_FIELD_NO < WK_DATA_FIELDS) DO
         BEGIN
            SELECT WK_FIELD_TEXT 
            FROM GET_REFERENCE_FIELD4 (NEW.TRN_DATA, :WK_FIELD_NO, NEW.TRN_DELIMITER) 
            INTO :WK_WORK_FIELD;
            /* now for this field get the label and data */
            SELECT WK_FIELD_LABEL, WK_FIELD_DATA 
            FROM GET_DATA_REFERENCE_FIELD4 (:WK_WORK_FIELD, '>')
            INTO :WK_WORK_LABEL, :WK_WORK_DATA;

            IF (WK_WORK_LABEL = '<ContactInstanceID') THEN
            BEGIN
               WK_ORDER = WK_WORK_DATA;
            END
            IF (WK_WORK_LABEL = '<EANNumber') THEN
            BEGIN
               WK_PROD = WK_WORK_DATA;
            END
            IF (WK_WORK_LABEL = '<Quantity') THEN
            BEGIN
               WK_QTY_X = WK_WORK_DATA;
               WK_QTY = CAST(WK_QTY_X AS INTEGER);
            END
            IF (WK_WORK_LABEL = '<EANExtension') THEN
            BEGIN
               WK_EXTENSION = WK_WORK_DATA;
            END
            IF (WK_WORK_LABEL = '<ContactInstanceRetrieveStatus') THEN
            BEGIN
               WK_STATUS = WK_WORK_DATA;
            END
            WK_FIELD_NO = WK_FIELD_NO + 1;
         END
         IF (WK_STATUS = 'true') THEN
         BEGIN
            WK_STATUS = 'T';
         END
         ELSE
         BEGIN
            WK_STATUS = 'F';
         END
         IF (WK_EXTENSION = '0') THEN
         BEGIN
            WK_EXTENSION = '';
         END
         /* get default values from control */
         SELECT DEFAULT_TERM, DEFAULT_PAYMENT_METHOD, DEFAULT_CARRIER_ID
         FROM CONTROL
         INTO :WK_TERM, :WK_PAYMENT, :WK_CARRIER;
         /* does order exist */
         WK_FOUND = 0;
         SELECT 1, PICK_RETRIEVE_STATUS  FROM PICK_ORDER
         WHERE PICK_ORDER = :WK_ORDER
         INTO :WK_FOUND, :WK_ORDER_STATUS;
         IF (WK_ORDER_STATUS IS NULL) THEN
         BEGIN
            WK_ORDER_STATUS = 'F';
         END
         IF (WK_FOUND = 0) THEN
         BEGIN
            IF (WK_STATUS = 'T') THEN
            BEGIN
               /* no order - so probably an urgent */
               WK_ORDER_STATUS = WK_STATUS;
               INSERT INTO PICK_ORDER(PICK_ORDER, 
                  PICK_STATUS, 
                  PICK_RETRIEVE_STATUS,
                  CREATE_DATE,
                  CREATED_BY,
                  PICK_ORDER_TYPE,
                  UPDATE_ID,
                  TERMS,
                  PAYMENT_METHOD,
                  SHIP_VIA)
               VALUES (:WK_ORDER, 
                  'DA', 
                  :WK_STATUS,
                  NEW.TRN_DATE,
                  NEW.PERSON_ID,
                  :WK_ORDER_TYPE,
                  NEW.MESSAGE_ID,
                  :WK_TERM,
                  :WK_PAYMENT,
                  :WK_CARRIER);
            END
            ELSE
            BEGIN
               INSERT INTO PICK_ORDER(PICK_ORDER, 
                  PICK_STATUS, 
                  PICK_RETRIEVE_STATUS, 
                  CREATE_DATE, 
                  CREATED_BY, 
                  PICK_ORDER_TYPE, 
                  UPDATE_ID,
                  TERMS,
                  PAYMENT_METHOD,
                  SHIP_VIA)
               VALUES (:WK_ORDER, 
                  'DA', 
                  :WK_STATUS , 
                  NEW.TRN_DATE, 
                  NEW.PERSON_ID, 
                  :WK_ORDER_TYPE , 
                  NEW.MESSAGE_ID ,
                  :WK_TERM,
                  :WK_PAYMENT,
                  :WK_CARRIER);
               WK_ORDER_STATUS = WK_STATUS;
            END
         END
         /* do line stuff */
         IF (WK_PROD = '') THEN
         BEGIN
            WK_PROD = 'NOPROD';
            IF (WK_QTY = 0) THEN
            BEGIN
               WK_QTY = 1;
            END
/*
            IF (WK_STATUS = 'F') THEN
            BEGIN
               WK_STATUS = 'T';
            END
*/
         END
         IF (WK_PROD > '') THEN
         BEGIN
            EXECUTE PROCEDURE ADD_PICK_REVISED_ITEMS (
               WK_ORDER ,
               WK_ORDER_STATUS ,
               WK_STATUS ,
               WK_PROD ,
               WK_EXTENSION ,
               WK_LINE_NO ,
               WK_QTY ,
               NEW.TRN_DATE ,
               NEW.PERSON_ID );
         END

         /* Update transactions table */        
         EXECUTE PROCEDURE UPDATE_TRAN4 (NEW.RECORD_ID, 'T', 'Processed successfully');
         EXECUTE PROCEDURE TRAN4_ARCHIVE;
      END
      ELSE
      IF ((NEW.TRN_TYPE = 'GCLM') AND (NEW.TRN_CLASS = 'S')) THEN
      BEGIN
         /* 
            for the data fields must split out the labeltype of data
            and data portions after the first '>'
            field 1 is the order 
         */
         WK_ORDER = '';
         WK_ORDER_TYPE = 'SO';
         WK_DATA_FIELDS = STRLEN(NEW.INPUT_SOURCE) ;
         WK_FIELD_NO = 1;
         WHILE (WK_FIELD_NO < WK_DATA_FIELDS) DO
         BEGIN
            SELECT WK_FIELD_TEXT 
            FROM GET_REFERENCE_FIELD4 (NEW.TRN_DATA, :WK_FIELD_NO, NEW.TRN_DELIMITER) 
            INTO :WK_WORK_FIELD;
            /* now for this field get the label and data */
            SELECT WK_FIELD_LABEL, WK_FIELD_DATA 
            FROM GET_DATA_REFERENCE_FIELD4 (:WK_WORK_FIELD, '>')
            INTO :WK_WORK_LABEL, :WK_WORK_DATA;

            IF (WK_WORK_LABEL = '<ContactInstanceID') THEN
            BEGIN
               WK_ORDER = WK_WORK_DATA;
            END
            WK_FIELD_NO = WK_FIELD_NO + 1;
         END
         /* DELETE FROM PICK_ITEM_REVISED WHERE PICK_ORDER = :WK_ORDER; */
         UPDATE PICK_ITEM_REVISED 
            SET PICK_ORDER_QTY = 0
         WHERE PICK_ORDER = :WK_ORDER;
      END
   END
END ^

CREATE TRIGGER RUN_TRANSACTION_PPA2 FOR TRANSACTIONS4 
ACTIVE AFTER INSERT POSITION 13 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_DATA_FIELDS INTEGER;
DECLARE VARIABLE WK_FIELD_NO INTEGER;
DECLARE VARIABLE WK_WORK_DATA VARCHAR(1024);
DECLARE VARIABLE WK_WORK_LABEL VARCHAR(1024);
DECLARE VARIABLE WK_WORK_FIELD VARCHAR(1024);
DECLARE VARIABLE WK_PROD VARCHAR(30);
DECLARE VARIABLE WK_ALT_PROD VARCHAR(30);
DECLARE VARIABLE WK_COMPANY VARCHAR(20);
DECLARE VARIABLE WK_ALT_COMPANY VARCHAR(20);
DECLARE VARIABLE WK_DESC VARCHAR(50);
DECLARE VARIABLE WK_LONG_DESC VARCHAR(255);
DECLARE VARIABLE WK_WEIGHT_X VARCHAR(10);
DECLARE VARIABLE WK_WEIGHT DECIMAL(9,3);
DECLARE VARIABLE WK_VOLUME_X VARCHAR(10);
DECLARE VARIABLE WK_VOLUME DECIMAL(9,3);
DECLARE VARIABLE WK_STATUS VARCHAR(5);
DECLARE VARIABLE WK_FOUND INTEGER;
DECLARE VARIABLE WK_SIZE VARCHAR(10);
DECLARE VARIABLE WK_COST_X VARCHAR(10);
DECLARE VARIABLE WK_COST NUMERIC(9,2);
DECLARE VARIABLE WK_BUFFER VARCHAR(512);
DECLARE VARIABLE WK_FILENAME VARCHAR(80);
DECLARE VARIABLE WK_RESULT INTEGER;
DECLARE VARIABLE WK_DESC2 VARCHAR(50);
DECLARE VARIABLE WK_DESC3 VARCHAR(50);
DECLARE VARIABLE WK_PROD_TYPE VARCHAR(50);
DECLARE VARIABLE WK_PROD_TYPE_ID CHAR(2);
DECLARE VARIABLE WK_WEIGHT_UOM VARCHAR(2);
BEGIN
   WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
   IF (WK_AUTORUN = 1) THEN
   BEGIN
      IF (NEW.TRN_TYPE = 'PPA2') THEN
      BEGIN
         /* WK_FILENAME = 'd:\tmp\ppa2.log'; */
         WK_FILENAME = '/tmp/ppa2.log';
         /* 
            for the data fields must split out the labeltype of data
            and data portions after the first '>'
            field 1 is the product code
            field 2 is the company code 
            field 3 is the alternate product code
            field 4 is the alternate company code 
            field 5 is the short description
            field 6 is the weight 
            field 7 is the volume
            field 8 is the active (stock) 
            field 9 is the size
            field 10 is the standard cost 
            field 11 is the long description
            field 12 is the weight uom
         */
         WK_STATUS = '';
         WK_PROD = '';
         WK_COMPANY = '';
         WK_ALT_PROD = '';
         WK_ALT_COMPANY = '';
         WK_DESC = '';
         WK_WEIGHT_X = '';
         WK_WEIGHT = 0;
         WK_WEIGHT_UOM = '';
         WK_VOLUME_X = '';
         WK_VOLUME = 0;
         WK_DATA_FIELDS = STRLEN(NEW.INPUT_SOURCE) ;
         WK_FIELD_NO = 1;
         WK_PROD_TYPE = '';
         WHILE (WK_FIELD_NO < WK_DATA_FIELDS) DO
         BEGIN
            SELECT WK_FIELD_TEXT 
            FROM GET_REFERENCE_FIELD4 (NEW.TRN_DATA, :WK_FIELD_NO, NEW.TRN_DELIMITER) 
            INTO :WK_WORK_FIELD;
            /* now for this field get the label and data */
            SELECT WK_FIELD_LABEL, WK_FIELD_DATA 
            FROM GET_DATA_REFERENCE_FIELD4 (:WK_WORK_FIELD, '>')
            INTO :WK_WORK_LABEL, :WK_WORK_DATA;

            IF (WK_WORK_LABEL = '<EANNumber') THEN
            BEGIN
               WK_BUFFER = 'have EANNumber ' || WK_WORK_DATA;
/*               WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_BUFFER);*/
               WK_PROD = WK_WORK_DATA;
            END
            IF (WK_WORK_LABEL = '<Company') THEN
            BEGIN
               WK_BUFFER = 'have Company ' || WK_WORK_DATA;
/*               WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_BUFFER);*/
               WK_COMPANY = WK_WORK_DATA;
            END
            IF (WK_WORK_LABEL = '<AltEANNumber') THEN
            BEGIN
               WK_BUFFER = 'have AltEANNumber ' || WK_WORK_DATA;
/*               WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_BUFFER);*/
               WK_ALT_PROD = WK_WORK_DATA;
            END
            IF (WK_WORK_LABEL = '<AltCompany') THEN
            BEGIN
               WK_BUFFER = 'have AltCompany ' || WK_WORK_DATA;
/*               WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_BUFFER);*/
               WK_ALT_COMPANY = WK_WORK_DATA;
            END
            IF (WK_WORK_LABEL = '<ShortDescription') THEN
            BEGIN
               WK_BUFFER = 'have Description ' || WK_WORK_DATA;
/*               WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_BUFFER);*/
               WK_DESC = WK_WORK_DATA;
            END
            IF (WK_WORK_LABEL = '<LongDescription') THEN
            BEGIN
               WK_BUFFER = 'have longDescription ' || WK_WORK_DATA;
/*               WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_BUFFER);*/
               WK_LONG_DESC = WK_WORK_DATA;
            END
            IF (WK_WORK_LABEL = '<Weight') THEN
            BEGIN
               WK_BUFFER = 'have Weight ' || WK_WORK_DATA;
/*               WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_BUFFER);*/
               WK_WEIGHT_X = WK_WORK_DATA;
               WK_WEIGHT = CAST(WK_WEIGHT_X AS DECIMAL(9,3));
               WHEN SQLCODE -413
               DO
               BEGIN
                  /* No Number */
                  WK_WEIGHT = 0;
               END
            END
            IF (WK_WORK_LABEL = '<Volume') THEN
            BEGIN
               WK_BUFFER = 'have Volume ' || WK_WORK_DATA;
/*               WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_BUFFER);*/
               WK_VOLUME_X = WK_WORK_DATA;
               WK_VOLUME = CAST(WK_VOLUME_X AS DECIMAL(9,3));
               WHEN SQLCODE -413
               DO
               BEGIN
                  /* No Number */
                  WK_VOLUME = 0;
               END
            END
            IF (WK_WORK_LABEL = '<StockStatus') THEN
            BEGIN
               WK_BUFFER = 'have StockStatus ' || WK_WORK_DATA;
/*               WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_BUFFER);*/
               WK_STATUS = WK_WORK_DATA;
            END
            IF (WK_WORK_LABEL = '<Size') THEN
            BEGIN
               WK_BUFFER = 'have Size ' || WK_WORK_DATA;
/*               WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_BUFFER);*/
               WK_SIZE = WK_WORK_DATA;
            END
            IF (WK_WORK_LABEL = '<StandardCost') THEN
            BEGIN
               WK_BUFFER = 'have Cost ' || WK_WORK_DATA;
/*               WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_BUFFER);*/
               WK_COST_X = WK_WORK_DATA;
               WK_COST = CAST(WK_COST_X AS NUMERIC(9,2));
               WHEN SQLCODE -413
               DO
               BEGIN
                  /* No Number */
                  WK_COST = 0;
               END
            END
            IF (WK_WORK_LABEL = '<WeightUOM') THEN
            BEGIN
               WK_BUFFER = 'have Weight UOM ' || WK_WORK_DATA;
/*               WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_BUFFER);*/
               WK_WEIGHT_UOM = WK_WORK_DATA;
            END
            WK_FIELD_NO = WK_FIELD_NO + 1;
         END
         IF (WK_PROD_TYPE = '') THEN
         BEGIN
            SELECT DEFAULT_PROD_TYPE
            FROM CONTROL
            INTO :WK_PROD_TYPE;
            IF (WK_PROD_TYPE IS NULL) THEN
            BEGIN
               WK_PROD_TYPE = '';
            END
         END
         /* does prod type exist */
         WK_FOUND = 0;
         SELECT 1, CODE FROM PROD_TYPE
         WHERE DESCRIPTION = :WK_PROD_TYPE
         INTO :WK_FOUND, :WK_PROD_TYPE_ID ;
         /* does product exist */
/*         WK_RESULT = FILE_WRITELN(WK_FILENAME, 'past input');*/
         WK_FOUND = 0;
         SELECT 1 
         FROM PROD_PROFILE
         WHERE PROD_ID = :WK_PROD
         INTO :WK_FOUND ;
         IF (WK_FOUND = 0) THEN
         BEGIN
            /* no product */
/*            WK_RESULT = FILE_WRITELN(WK_FILENAME, 'insert prod');*/
            INSERT INTO PROD_PROFILE(PROD_ID, 
               COMPANY_ID, 
               ALTERNATE_ID,
               ALTERNATE_COMPANY_ID,
               SHORT_DESC,
               NET_WEIGHT,
               VOLUME,
               STOCK,
               UOM_SIZE,
               STANDARD_COST,
               PROD_TYPE,
               LONG_DESC,
               NET_WEIGHT_UOM)
            VALUES (:WK_PROD, 
               :WK_COMPANY, 
               :WK_ALT_PROD, 
               :WK_ALT_COMPANY, 
               :WK_DESC,
               :WK_WEIGHT,
               :WK_VOLUME,
               :WK_STATUS,
               :WK_SIZE,
               :WK_COST,
               :WK_PROD_TYPE_ID,
               :WK_LONG_DESC,
               :WK_WEIGHT_UOM);
         END
         ELSE
         BEGIN
/*            WK_RESULT = FILE_WRITELN(WK_FILENAME, 'update prod');*/
            IF (WK_WEIGHT_X = '') THEN
            BEGIN
               /* no weight */
               UPDATE PROD_PROFILE SET
                  COMPANY_ID = :WK_COMPANY, 
                  ALTERNATE_ID = :WK_ALT_PROD, 
                  ALTERNATE_COMPANY_ID = :WK_ALT_COMPANY, 
                  SHORT_DESC = :WK_DESC,
                  LONG_DESC = :WK_LONG_DESC,
                  VOLUME = :WK_VOLUME,
                  STOCK = :WK_STATUS,
                  UOM_SIZE = :WK_SIZE,
                  STANDARD_COST = :WK_COST
               WHERE PROD_ID = :WK_PROD; 
            END
            ELSE
            BEGIN
               UPDATE PROD_PROFILE SET
                  COMPANY_ID = :WK_COMPANY, 
                  ALTERNATE_ID = :WK_ALT_PROD, 
                  ALTERNATE_COMPANY_ID = :WK_ALT_COMPANY, 
                  SHORT_DESC = :WK_DESC,
                  LONG_DESC = :WK_LONG_DESC,
                  NET_WEIGHT = :WK_WEIGHT,
                  VOLUME = :WK_VOLUME,
                  STOCK = :WK_STATUS,
                  UOM_SIZE = :WK_SIZE,
                  STANDARD_COST = :WK_COST,
                  NET_WEIGHT_UOM = :WK_WEIGHT_UOM
               WHERE PROD_ID = :WK_PROD; 
            END
         END

         /* Update transactions table */        
         EXECUTE PROCEDURE UPDATE_TRAN4 (NEW.RECORD_ID, 'T', 'Processed successfully');
         EXECUTE PROCEDURE TRAN4_ARCHIVE;
      END
   END
END ^

CREATE TRIGGER RUN_TRANSACTION_PPA3 FOR TRANSACTIONS4 
ACTIVE AFTER INSERT POSITION 13 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_DATA_FIELDS INTEGER;
DECLARE VARIABLE WK_FIELD_NO INTEGER;
DECLARE VARIABLE WK_WORK_DATA VARCHAR(1024);
DECLARE VARIABLE WK_WORK_LABEL VARCHAR(1024);
DECLARE VARIABLE WK_WORK_FIELD VARCHAR(1024);
DECLARE VARIABLE WK_PROD VARCHAR(30);
DECLARE VARIABLE WK_STATUS VARCHAR(5);
DECLARE VARIABLE WK_FOUND INTEGER;
DECLARE VARIABLE WK_COST_X VARCHAR(10);
DECLARE VARIABLE WK_COST NUMERIC(9,2);
DECLARE VARIABLE WK_BUFFER VARCHAR(512);
DECLARE VARIABLE WK_FILENAME VARCHAR(80);
DECLARE VARIABLE WK_RESULT INTEGER;
DECLARE VARIABLE WK_DUMMY  INTEGER;
BEGIN
   WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
   IF (WK_AUTORUN = 1) THEN
   BEGIN
      IF (NEW.TRN_TYPE = 'PPA3') THEN
      BEGIN
         /* WK_FILENAME = 'd:\tmp\PPA3.log'; */
         /* 
            for the data fields must split out the labeltype of data
            and data portions after the first '>'
            field 1 is the product code
            field 2 is the standard cost 
         */
         WK_PROD = '';
         WK_DATA_FIELDS = STRLEN(NEW.INPUT_SOURCE) ;
         WK_FIELD_NO = 1;
         WHILE (WK_FIELD_NO < WK_DATA_FIELDS) DO
         BEGIN
            SELECT WK_FIELD_TEXT 
            FROM GET_REFERENCE_FIELD4 (NEW.TRN_DATA, :WK_FIELD_NO, NEW.TRN_DELIMITER) 
            INTO :WK_WORK_FIELD;
            /* now for this field get the label and data */
            SELECT WK_FIELD_LABEL, WK_FIELD_DATA 
            FROM GET_DATA_REFERENCE_FIELD4 (:WK_WORK_FIELD, '>')
            INTO :WK_WORK_LABEL, :WK_WORK_DATA;

            IF (WK_WORK_LABEL = '<EANNumber') THEN
            BEGIN
               WK_BUFFER = 'have EANNumber ' || WK_WORK_DATA;
/*               WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_BUFFER);*/
               WK_PROD = WK_WORK_DATA;
            END
            IF (WK_WORK_LABEL = '<StandardCost') THEN
            BEGIN
               WK_BUFFER = 'have Cost ' || WK_WORK_DATA;
/*               WK_RESULT = FILE_WRITELN(WK_FILENAME, WK_BUFFER);*/
               WK_COST_X = WK_WORK_DATA;
               WK_COST = CAST(WK_COST_X AS NUMERIC(9,2));
               WHEN SQLCODE -413
               DO
               BEGIN
                  /* No Number */
                  WK_COST = 0;
               END
            END
            WK_FIELD_NO = WK_FIELD_NO + 1;
         END
         WK_FOUND = 0;
         SELECT 1 
         FROM PROD_PROFILE
         WHERE PROD_ID = :WK_PROD
         INTO :WK_FOUND ;
         IF (WK_FOUND = 0) THEN
         BEGIN
            /* no product */
/*            WK_RESULT = FILE_WRITELN(WK_FILENAME, 'insert prod');*/
/*
            INSERT INTO PROD_PROFILE(PROD_ID, 
               STANDARD_COST)
            VALUES (:WK_PROD, 
               :WK_COST);
*/
             WK_DUMMY = 1;
         END
         ELSE
         BEGIN
/*            WK_RESULT = FILE_WRITELN(WK_FILENAME, 'update prod');*/
            UPDATE PROD_PROFILE SET
               STANDARD_COST = :WK_COST
            WHERE PROD_ID = :WK_PROD; 
         END

         /* Update transactions table */        
         EXECUTE PROCEDURE UPDATE_TRAN4 (NEW.RECORD_ID, 'T', 'Processed successfully');
         EXECUTE PROCEDURE TRAN4_ARCHIVE;
      END
   END
END ^

CREATE TRIGGER TRANSFER_REQUEST_TRN_LINE_NO FOR TRANSFER_REQUEST 
ACTIVE BEFORE INSERT POSITION 0 
AS
BEGIN
  IF (NEW.TRN_LINE_NO IS NULL) THEN
      NEW.TRN_LINE_NO = GEN_ID(TRN_LINE_NO_GEN, 1);
  NEW.CREATE_DATE = 'NOW';
  NEW.TRN_STATUS = 'OP';
END ^

CREATE TRIGGER AI_VALID_RESPONSES_RESPONSE_ID FOR VALID_RESPONSES 
ACTIVE BEFORE INSERT POSITION 0 
AS
BEGIN
  IF (NEW.RESPONSE_ID IS NULL) THEN
      NEW.RESPONSE_ID = GEN_ID(VALID_RESPONSES_RECORD_ID_GEN, 1);
  IF (NEW.VALID_RESPONSE IS NULL) THEN
      NEW.VALID_RESPONSE = '';
  ELSE
      NEW.VALID_RESPONSE = ALLTRIM(NEW.VALID_RESPONSE);
END ^

CREATE TRIGGER AU_VALID_RESPONSES_RESPONSE FOR VALID_RESPONSES 
ACTIVE BEFORE UPDATE POSITION 0 
AS
BEGIN
  IF (NEW.VALID_RESPONSE IS NULL) THEN
      NEW.VALID_RESPONSE = '';
  ELSE
      NEW.VALID_RESPONSE = ALLTRIM(NEW.VALID_RESPONSE);
END ^

COMMIT WORK ^
SET TERM ; ^

/* Grant permissions for this database */
GRANT SELECT ON ACCOUNT_PERIODS TO USER REPORT;
GRANT SELECT ON AISLES TO USER REPORT;
GRANT DELETE, INSERT, SELECT, UPDATE, REFERENCES ON AUDIT_CODE TO USER REPORT;
GRANT SELECT ON BAYS TO USER REPORT;
GRANT DELETE, INSERT, SELECT, UPDATE, REFERENCES ON BRAND TO USER REPORT;
GRANT SELECT ON CARDTEXT TO USER REPORT;
GRANT SELECT ON CARRIER TO USER REPORT;
GRANT SELECT ON CARRIER_SERVICE TO USER REPORT;
GRANT SELECT ON COMPANY TO USER REPORT;
GRANT SELECT ON COMPARTMENTS TO USER REPORT;
GRANT DELETE, INSERT, SELECT, UPDATE, REFERENCES ON CONTROL TO USER REPORT;
GRANT DELETE, INSERT, SELECT, UPDATE, REFERENCES ON COST_CENTRE TO USER REPORT;
GRANT SELECT ON DATA_COLLECTION TO USER REPORT;
GRANT SELECT ON DATA_COLLECT_HEADER TO USER REPORT;
GRANT DELETE, INSERT, SELECT, UPDATE, REFERENCES ON DEPARTMENT TO USER REPORT;
GRANT SELECT ON DEPRECIATION TO USER REPORT;
GRANT SELECT ON DEP_METHODS TO USER REPORT;
GRANT DELETE, INSERT, SELECT, UPDATE, REFERENCES ON DESCRIPTION_LAYOUT TO USER REPORT;
GRANT DELETE, INSERT, SELECT, UPDATE, REFERENCES ON DIVISION TO USER REPORT;
GRANT DELETE, INSERT, SELECT, UPDATE, REFERENCES ON EMPLOYEE TO USER REPORT;
GRANT DELETE, INSERT, SELECT, UPDATE, REFERENCES ON EMPLOYEE_IMAGE TO USER REPORT;
GRANT DELETE, INSERT, SELECT, UPDATE, REFERENCES ON EMPLOYEE_SKILL TO USER REPORT;
GRANT DELETE, INSERT, SELECT, UPDATE, REFERENCES ON GENERIC TO USER REPORT;
GRANT DELETE, INSERT, SELECT, UPDATE, REFERENCES ON GLOBAL_CONDITIONS TO USER REPORT;
GRANT DELETE, INSERT, SELECT, UPDATE, REFERENCES ON GRN TO USER REPORT;
GRANT DELETE, INSERT, SELECT, UPDATE, REFERENCES ON GRN_ORDER TO USER REPORT;
GRANT DELETE, INSERT, SELECT, UPDATE, REFERENCES ON GROUP_COPY TO USER REPORT;
GRANT SELECT ON IMAGES TO USER REPORT;
GRANT DELETE, INSERT, SELECT, UPDATE, REFERENCES ON INSP_HIST TO USER REPORT;
GRANT DELETE, INSERT, SELECT, UPDATE, REFERENCES ON ISSN TO USER REPORT;
GRANT DELETE, INSERT, SELECT, UPDATE, REFERENCES ON ISSN_PUTAWAY TO USER REPORT;
GRANT SELECT ON ITEM_CLASS TO USER REPORT;
GRANT DELETE, INSERT, SELECT, UPDATE, REFERENCES ON LABEL_LOCATION TO USER REPORT;
GRANT DELETE, INSERT, SELECT, UPDATE, REFERENCES ON LEGACY TO USER REPORT;
GRANT DELETE, INSERT, SELECT, UPDATE, REFERENCES ON LOAN_CHARGE_TO TO USER REPORT;
GRANT DELETE, INSERT, SELECT, UPDATE, REFERENCES ON LOAN_HISTORY TO USER REPORT;
GRANT DELETE, INSERT, SELECT, UPDATE, REFERENCES ON LOAN_ORDER TO USER REPORT;
GRANT DELETE, INSERT, SELECT, UPDATE, REFERENCES ON LOAN_ORDER_LINE TO USER REPORT;
GRANT DELETE, INSERT, SELECT, UPDATE, REFERENCES ON LOCATION TO USER REPORT;
GRANT SELECT ON LOCN_ADDRESS TO USER REPORT;
GRANT DELETE, INSERT, SELECT, UPDATE, REFERENCES ON LOCN_STATUS TO USER REPORT;
GRANT DELETE, INSERT, SELECT, UPDATE, REFERENCES ON LOG TO USER REPORT;
GRANT DELETE, INSERT, SELECT, UPDATE, REFERENCES ON METRICS TO USER REPORT;
GRANT DELETE, INSERT, SELECT, UPDATE, REFERENCES ON MODEL TO USER REPORT;
GRANT DELETE, INSERT, SELECT, UPDATE, REFERENCES ON MOVE_STATUS TO USER REPORT;
GRANT SELECT ON OBJECT_IMAGE TO USER REPORT;
GRANT DELETE, INSERT, SELECT, UPDATE, REFERENCES ON OCCUPATION TO USER REPORT;
GRANT DELETE, INSERT, SELECT, UPDATE, REFERENCES ON OPTIONS TO USER REPORT;
GRANT DELETE, INSERT, SELECT, UPDATE, REFERENCES ON ORDER_GROUP TO USER REPORT;
GRANT DELETE, INSERT, SELECT, UPDATE, REFERENCES ON PACK_ID TO USER REPORT;
GRANT SELECT ON PALLETS TO USER REPORT;
GRANT DELETE, INSERT, SELECT, UPDATE, REFERENCES ON PALLET_CFG TO USER REPORT;
GRANT SELECT ON PARAM TO USER REPORT;
GRANT DELETE, INSERT, SELECT, UPDATE, REFERENCES ON PERSON TO USER REPORT;
GRANT DELETE, INSERT, SELECT, UPDATE, REFERENCES ON PERSON_TYPE TO USER REPORT;
GRANT DELETE, INSERT, SELECT, UPDATE, REFERENCES ON PICK_DESPATCH TO USER REPORT;
GRANT DELETE, INSERT, SELECT, UPDATE, REFERENCES ON PICK_ITEM TO USER REPORT;
GRANT DELETE, INSERT, SELECT, UPDATE, REFERENCES ON PICK_ITEM_DETAIL TO USER REPORT;
GRANT DELETE, INSERT, SELECT, UPDATE, REFERENCES ON PICK_ITEM_LINE_NO TO USER REPORT;
GRANT SELECT ON PICK_LOCATIONS TO USER REPORT;
GRANT DELETE, INSERT, SELECT, UPDATE, REFERENCES ON PICK_ORDER TO USER REPORT;
GRANT SELECT ON PICK_ORDER_ITEM_TEMP TO USER REPORT;
GRANT SELECT ON PICK_QTYS TO USER REPORT;
GRANT SELECT ON PICK_UP TO USER REPORT;
GRANT SELECT ON PRINT_SELECTION TO USER REPORT;
GRANT SELECT ON PRIVILIGES TO USER REPORT;
GRANT DELETE, INSERT, SELECT, UPDATE, REFERENCES ON PRODUCT_CONDITION TO USER REPORT;
GRANT DELETE, INSERT, SELECT, UPDATE, REFERENCES ON PRODUCT_COND_STATUS TO USER REPORT;
GRANT DELETE, INSERT, SELECT, UPDATE, REFERENCES ON PRODUCT_DESCRIPTION TO USER REPORT;
GRANT DELETE, INSERT, SELECT, UPDATE, REFERENCES ON PRODUCT_KIT TO USER REPORT;
GRANT SELECT ON PRODUCT_LAYOUT TO USER REPORT;
GRANT DELETE, INSERT, SELECT, UPDATE, REFERENCES ON PROD_PROFILE TO USER REPORT;
GRANT DELETE, INSERT, SELECT, UPDATE, REFERENCES ON PROD_TYPE TO USER REPORT;
GRANT DELETE, INSERT, SELECT, UPDATE, REFERENCES ON PURCHASE_ORDER TO USER REPORT;
GRANT DELETE, INSERT, SELECT, UPDATE, REFERENCES ON PURCHASE_ORDER_LINE TO USER REPORT;
GRANT SELECT ON PURCHASE_ORDER_LINE_TEMP TO USER REPORT;
GRANT DELETE, INSERT, SELECT, UPDATE, REFERENCES ON QTY_EAN TO USER REPORT;
GRANT SELECT ON REPORT_TEMP TO USER REPORT;
GRANT DELETE, INSERT, SELECT, UPDATE, REFERENCES ON RESUME_TEST TO USER REPORT;
GRANT DELETE, INSERT, SELECT, UPDATE, REFERENCES ON RETICULATION TO USER REPORT;
GRANT SELECT ON RETURN_ORDER TO USER REPORT;
GRANT SELECT ON RETURN_ORDER_LINE TO USER REPORT;
GRANT SELECT ON SALE_ORDER TO USER REPORT;
GRANT SELECT ON SALE_ORDER_LINE TO USER REPORT;
GRANT SELECT ON SHELFS TO USER REPORT;
GRANT DELETE, INSERT, SELECT, UPDATE, REFERENCES ON SKILL TO USER REPORT;
GRANT DELETE, INSERT, SELECT, UPDATE, REFERENCES ON SKILL_PASS TO USER REPORT;
GRANT DELETE, INSERT, SELECT, UPDATE, REFERENCES ON SSN TO USER REPORT;
GRANT SELECT ON SSN_BATCH TO USER REPORT;
GRANT DELETE, INSERT, SELECT, UPDATE, REFERENCES ON SSN_GROUP TO USER REPORT;
GRANT DELETE, INSERT, SELECT, UPDATE, REFERENCES ON SSN_HIST TO USER REPORT;
GRANT SELECT ON SSN_ITEM_CLASS TO USER REPORT;
GRANT DELETE, INSERT, SELECT, UPDATE, REFERENCES ON SSN_LEGACY TO USER REPORT;
GRANT SELECT ON SSN_MOVES TO USER REPORT;
GRANT SELECT ON SSN_MOVES_REF TO USER REPORT;
GRANT DELETE, INSERT, SELECT, UPDATE, REFERENCES ON SSN_PRODUCT TO USER REPORT;
GRANT SELECT ON SSN_SERIAL TO USER REPORT;
GRANT DELETE, INSERT, SELECT, UPDATE, REFERENCES ON SSN_SUB_TYPE TO USER REPORT;
GRANT DELETE, INSERT, SELECT, UPDATE, REFERENCES ON SSN_TEST TO USER REPORT;
GRANT DELETE, INSERT, SELECT, UPDATE, REFERENCES ON SSN_TEST_RESULTS TO USER REPORT;
GRANT DELETE, INSERT, SELECT, UPDATE, REFERENCES ON SSN_TYPE TO USER REPORT;
GRANT DELETE, INSERT, SELECT, UPDATE, REFERENCES ON SSN_TYPE_COND TO USER REPORT;
GRANT SELECT ON STARTRACK_DEPOT TO USER REPORT;
GRANT DELETE, INSERT, SELECT, UPDATE, REFERENCES ON STATUS_DEFS TO USER REPORT;
GRANT SELECT ON STORE_AREA TO USER REPORT;
GRANT SELECT ON STORE_METHOD TO USER REPORT;
GRANT SELECT ON STORE_TYPE TO USER REPORT;
GRANT SELECT ON SYS_EQUIP TO USER REPORT;
GRANT SELECT ON SYS_HH TO USER REPORT;
GRANT DELETE, INSERT, SELECT, UPDATE, REFERENCES ON SYS_MOVES TO USER REPORT;
GRANT DELETE, INSERT, SELECT, UPDATE, REFERENCES ON TASK_SCHEDULE TO USER REPORT;
GRANT SELECT ON TEST_QUESTIONS TO USER REPORT;
GRANT SELECT ON TOG TO USER REPORT;
GRANT DELETE, INSERT, SELECT, UPDATE, REFERENCES ON TRAINING_SKILL TO USER REPORT;
GRANT DELETE, INSERT, SELECT, UPDATE, REFERENCES ON TRAINING_SKILL_CODES TO USER REPORT;
GRANT DELETE, INSERT, SELECT, UPDATE, REFERENCES ON TRANSACTIONS TO USER REPORT;
GRANT DELETE, INSERT, SELECT, UPDATE, REFERENCES ON TRANSACTIONS_ARCHIVE TO USER REPORT;
GRANT DELETE, INSERT, SELECT, UPDATE, REFERENCES ON TRANSFER_REQUEST TO USER REPORT;
GRANT SELECT ON TRAN_ERROR TO USER REPORT;
GRANT SELECT ON TYPE_HEADER TO USER REPORT;
GRANT SELECT ON TYPE_LINE TO USER REPORT;
GRANT SELECT ON UDPATE_FIELDS TO USER REPORT;
GRANT SELECT ON UOM TO USER REPORT;
GRANT SELECT ON UOM_TYPE TO USER REPORT;
GRANT DELETE, INSERT, SELECT, UPDATE, REFERENCES ON VALID_RESPONSES TO USER REPORT;
GRANT DELETE, INSERT, SELECT, UPDATE, REFERENCES ON VARIANCE TO USER REPORT;
GRANT DELETE, INSERT, SELECT, UPDATE, REFERENCES ON WAREHOUSE TO USER REPORT;
GRANT SELECT ON WARRANTY TO USER REPORT;
GRANT SELECT ON WORK_FILE TO USER REPORT;
GRANT SELECT ON XREF TO USER REPORT;
GRANT DELETE, INSERT, SELECT, UPDATE, REFERENCES ON ZONE TO USER REPORT;
GRANT EXECUTE ON PROCEDURE ADD_EMP_SKILL_DEFAULT TO USER REPORT;
GRANT EXECUTE ON PROCEDURE ADD_GRN TO USER REPORT;
GRANT EXECUTE ON PROCEDURE ADD_GROUP_DATA TO USER REPORT;
GRANT EXECUTE ON PROCEDURE ADD_ISSN TO USER REPORT;
GRANT EXECUTE ON PROCEDURE ADD_MASTER_DATA TO USER REPORT;
GRANT EXECUTE ON PROCEDURE ADD_NAMED_SSN_ISSN_GRNV TO USER REPORT;
GRANT EXECUTE ON PROCEDURE ADD_PICK_ITEM_LINE_NO TO USER REPORT;
GRANT EXECUTE ON PROCEDURE ADD_PROD_COND_STATUS_TEST TO USER REPORT;
GRANT EXECUTE ON PROCEDURE ADD_SSN_HIST TO USER REPORT;
GRANT EXECUTE ON PROCEDURE ADD_SSN_ISSN_GRNV TO USER REPORT;
GRANT EXECUTE ON PROCEDURE ADD_TRAN TO USER REPORT;
GRANT EXECUTE ON PROCEDURE GET_BARCODE_LENGTH TO USER REPORT;
GRANT EXECUTE ON PROCEDURE GET_GLOBAL_CONDITION TO USER REPORT;
GRANT EXECUTE ON PROCEDURE GET_LOAD_NO TO USER REPORT;
GRANT EXECUTE ON PROCEDURE GET_LOAN_ID TO USER REPORT;
GRANT EXECUTE ON PROCEDURE GET_REFERENCE_FIELD TO USER REPORT;
GRANT EXECUTE ON PROCEDURE GET_SALE_ORDER_NO TO USER REPORT;
GRANT EXECUTE ON PROCEDURE NEXT_GRN_ORDER_LABEL TO USER REPORT;
GRANT EXECUTE ON PROCEDURE NEXT_PICK_LABEL TO USER REPORT;
GRANT EXECUTE ON PROCEDURE PC_ADD_PROD_COND_STATUS TO USER REPORT;
GRANT EXECUTE ON PROCEDURE PC_AULO TO USER REPORT;
GRANT EXECUTE ON PROCEDURE PC_AUOB TO USER REPORT;
GRANT EXECUTE ON PROCEDURE PC_DELETE_ONE_PROD_COND_STATUS TO USER REPORT;
GRANT EXECUTE ON PROCEDURE PC_DSDX TO USER REPORT;
GRANT EXECUTE ON PROCEDURE PC_GROUP_COPY TO USER REPORT;
GRANT EXECUTE ON PROCEDURE PC_NILT_NILS TO USER REPORT;
GRANT EXECUTE ON PROCEDURE PC_NIXX TO USER REPORT;
GRANT EXECUTE ON PROCEDURE PC_NIXX_P TO USER REPORT;
GRANT EXECUTE ON PROCEDURE PC_QANS TO USER REPORT;
GRANT EXECUTE ON PROCEDURE PC_QANX TO USER REPORT;
GRANT EXECUTE ON PROCEDURE PC_QTY_TROL_TRIL_P TO USER REPORT;
GRANT EXECUTE ON PROCEDURE PC_STLO TO USER REPORT;
GRANT EXECUTE ON PROCEDURE PC_STLX TO USER REPORT;
GRANT EXECUTE ON PROCEDURE PC_STOB TO USER REPORT;
GRANT EXECUTE ON PROCEDURE PC_STRC TO USER REPORT;
GRANT EXECUTE ON PROCEDURE PC_TRIS TO USER REPORT;
GRANT EXECUTE ON PROCEDURE PC_TRLO_TRLI TO USER REPORT;
GRANT EXECUTE ON PROCEDURE PC_TRMI TO USER REPORT;
GRANT EXECUTE ON PROCEDURE PC_TROL_TRIL TO USER REPORT;
GRANT EXECUTE ON PROCEDURE PC_TRSS TO USER REPORT;
GRANT EXECUTE ON PROCEDURE PC_WMAR TO USER REPORT;
GRANT EXECUTE ON PROCEDURE SEND_PICKABLE_STOCK TO USER REPORT;
GRANT EXECUTE ON PROCEDURE TRAN_ARCHIVE TO USER REPORT;
GRANT EXECUTE ON PROCEDURE UPDATE_SSN TO USER REPORT;
GRANT EXECUTE ON PROCEDURE UPDATE_SSN_QTY_TROL TO USER REPORT;
GRANT EXECUTE ON PROCEDURE UPDATE_SSN_TRIL_A TO USER REPORT;
GRANT EXECUTE ON PROCEDURE UPDATE_SSN_TROL_A TO USER REPORT;
GRANT EXECUTE ON PROCEDURE UPDATE_TRAN TO USER REPORT;

/* Comments for database objects. */
COMMENT ON DOMAIN       DUE_DATE_DAYS IS 'Used to Calculate a Default Due Date for Orders 
Null or 0 means NOW 
Otherwise the Number of days From NOW 
';
COMMENT ON DOMAIN       QUESTION IS 'Question to display when recording test results
';
COMMENT ON DOMAIN       RESPONSE_CODE IS 'Response recorded on test question
';
COMMENT ON DOMAIN       RESPONSE_HEADINGS IS 'Valid responses from test questions
';
COMMENT ON DOMAIN       TEXT_LIST IS 'Used for user definable dropdown selection in test 
questions table
';
COMMENT ON TABLE        SYS_MENU IS 'A user has a start menu coming from either the control table or a field in sys_user
so this will require a menu type to go with the start menu 
- to differentiate a whm menu versus  another sort this is the field SM_MENU_TYPE ( it was SM_VARIANT - but I extended its use)
for example the sys_user has "AM" for a start and SM_MENU_TYPE "product" 
this will be the SM_MENU_ID to look for (for that SM_MENU_TYPE)
(and matching SM_USER_TYPE, SM_DEVIVE_TYPE, SM_WH_ID and SM_COMPANY_ID) = as in the SYS_SCREEN
so that if these fields are null then this record applies to all
I have used SM_USER_TYPE rather then SM_USER_CATEGORY as that name was in the SYS_SCREEN - 

ordered by the SM_SEQUENCE
where the SM_MENU_STATUS is "OK"

If the record retrieved has a non null SM_SUBMENU_ID then this is the next menu to go to
(rather than using the SM_ACTION ...)

The Handhelds use
SM_MENU_ACTION as the action to be performed
SM_MENU_ALT as the Alt part of the menu item
SM_MENU_IMAGE as the source for the image used SRC
SM_MENU_METHOD as the Menu Code ID to search for eg "PO4" for the forth Pick by Order that FPG Use
SM_NAME as the forms Name

';
COMMENT ON TABLE        SYS_SCREEN_COLOUR IS '
set a colour for a field in sys_screen_var

so nominate a value in the result set

then for a range of values
or < a value
or > a value   

add a field ssv_colour_test_field and ssv_colour_test

then a new table for the colours and conditions
 have a less than and greater than value operators

ie operator and test value 1 eg operator <
   operator and 2 test values  eg operator between

so sys_screen_colour table
';
COMMENT ON EXTERNAL FUNCTION ABS IS '';
COMMENT ON EXTERNAL FUNCTION ABSDBL IS '';
COMMENT ON EXTERNAL FUNCTION ABSFLT IS '';
COMMENT ON EXTERNAL FUNCTION ABSINT IS '';
COMMENT ON EXTERNAL FUNCTION ABSSML IS '';
COMMENT ON EXTERNAL FUNCTION ACOS IS '';
COMMENT ON EXTERNAL FUNCTION ADD_TIME IS '';
COMMENT ON EXTERNAL FUNCTION ALLTRIM IS '';
COMMENT ON EXTERNAL FUNCTION ALLTRIMC IS '';
COMMENT ON EXTERNAL FUNCTION ASCII IS '';
COMMENT ON EXTERNAL FUNCTION ASCII_CHAR IS '';
COMMENT ON EXTERNAL FUNCTION ASCII_VAL IS '';
COMMENT ON EXTERNAL FUNCTION ASIN IS '';
COMMENT ON EXTERNAL FUNCTION ATAN IS '';
COMMENT ON EXTERNAL FUNCTION ATAN2 IS '';
COMMENT ON EXTERNAL FUNCTION BIN_AND IS '';
COMMENT ON EXTERNAL FUNCTION BIN_OR IS '';
COMMENT ON EXTERNAL FUNCTION BIN_XOR IS '';
COMMENT ON EXTERNAL FUNCTION BLOB_BYTECOUNT IS '';
COMMENT ON EXTERNAL FUNCTION BLOB_LINECOUNT IS '';
COMMENT ON EXTERNAL FUNCTION BLOB_SUBSTR IS '';
COMMENT ON EXTERNAL FUNCTION CEILING IS '';
COMMENT ON EXTERNAL FUNCTION CENTER IS '';
COMMENT ON EXTERNAL FUNCTION CENTRE IS '';
COMMENT ON EXTERNAL FUNCTION CHECK_LOGIN IS '';
COMMENT ON EXTERNAL FUNCTION CHR IS '';
COMMENT ON EXTERNAL FUNCTION COS IS '';
COMMENT ON EXTERNAL FUNCTION COSH IS '';
COMMENT ON EXTERNAL FUNCTION COT IS '';
COMMENT ON EXTERNAL FUNCTION CSTRADD IS '';
COMMENT ON EXTERNAL FUNCTION CSTRDEL IS '';
COMMENT ON EXTERNAL FUNCTION CSTR_PLUS_INT IS '';
COMMENT ON EXTERNAL FUNCTION CSTR_TO_DBL IS '';
COMMENT ON EXTERNAL FUNCTION DAY_OF_WEEK IS '';
COMMENT ON EXTERNAL FUNCTION DEGREES IS '';
COMMENT ON EXTERNAL FUNCTION DIFFDATE IS '';
COMMENT ON EXTERNAL FUNCTION DIV IS '';
COMMENT ON EXTERNAL FUNCTION DOW IS '';
COMMENT ON EXTERNAL FUNCTION DQUOTEDSTR IS '';
COMMENT ON EXTERNAL FUNCTION EXP IS '';
COMMENT ON EXTERNAL FUNCTION FACT IS '';
COMMENT ON EXTERNAL FUNCTION FILE_CONCAT IS '';
COMMENT ON EXTERNAL FUNCTION FILE_CREATE IS '';
COMMENT ON EXTERNAL FUNCTION FILE_DELETE IS '';
COMMENT ON EXTERNAL FUNCTION FILE_RENAME IS '';
COMMENT ON EXTERNAL FUNCTION FILE_WRITE IS '';
COMMENT ON EXTERNAL FUNCTION FILE_WRITELN IS '';
COMMENT ON EXTERNAL FUNCTION FIRSTDAY IS '';
COMMENT ON EXTERNAL FUNCTION FLOOR IS '';
COMMENT ON EXTERNAL FUNCTION FUD_ACOS IS '';
COMMENT ON EXTERNAL FUNCTION FUD_ASIN IS '';
COMMENT ON EXTERNAL FUNCTION FUD_ATAN IS '';
COMMENT ON EXTERNAL FUNCTION FUD_ATAN2 IS '';
COMMENT ON EXTERNAL FUNCTION FUD_COS IS '';
COMMENT ON EXTERNAL FUNCTION FUD_FLOOR IS '';
COMMENT ON EXTERNAL FUNCTION FUD_LOG IS '';
COMMENT ON EXTERNAL FUNCTION FUD_LOG10 IS '';
COMMENT ON EXTERNAL FUNCTION FUD_LOWER IS '';
COMMENT ON EXTERNAL FUNCTION FUD_PI IS '';
COMMENT ON EXTERNAL FUNCTION FUD_SIN IS '';
COMMENT ON EXTERNAL FUNCTION FUD_SOUNDEX IS '';
COMMENT ON EXTERNAL FUNCTION FUD_SQRT IS '';
COMMENT ON EXTERNAL FUNCTION FUD_TAN IS '';
COMMENT ON EXTERNAL FUNCTION FUD_TRUNCATE IS '';
COMMENT ON EXTERNAL FUNCTION FUD_TTOC IS '';
COMMENT ON EXTERNAL FUNCTION FUD_VER IS '';
COMMENT ON EXTERNAL FUNCTION INT_PLUS_CSTR IS '';
COMMENT ON EXTERNAL FUNCTION JULIAN IS '';
COMMENT ON EXTERNAL FUNCTION LASTDAY IS '';
COMMENT ON EXTERNAL FUNCTION LEFTS IS '';
COMMENT ON EXTERNAL FUNCTION LEN IS '';
COMMENT ON EXTERNAL FUNCTION LN IS '';
COMMENT ON EXTERNAL FUNCTION LOG IS '';
COMMENT ON EXTERNAL FUNCTION LOG10 IS '';
COMMENT ON EXTERNAL FUNCTION LOWER IS '';
COMMENT ON EXTERNAL FUNCTION LPAD IS '';
COMMENT ON EXTERNAL FUNCTION LTRIM IS '';
COMMENT ON EXTERNAL FUNCTION LTRIMC IS '';
COMMENT ON EXTERNAL FUNCTION MAKEDATE IS '';
COMMENT ON EXTERNAL FUNCTION MAXDBL IS '';
COMMENT ON EXTERNAL FUNCTION MAXFLT IS '';
COMMENT ON EXTERNAL FUNCTION MAXINT IS '';
COMMENT ON EXTERNAL FUNCTION MAXSML IS '';
COMMENT ON EXTERNAL FUNCTION MAXTIME IS '';
COMMENT ON EXTERNAL FUNCTION MER_DAY IS '';
COMMENT ON EXTERNAL FUNCTION MER_HOUR IS '';
COMMENT ON EXTERNAL FUNCTION MER_MINUTE IS '';
COMMENT ON EXTERNAL FUNCTION MER_MONTH IS '';
COMMENT ON EXTERNAL FUNCTION MER_YEAR IS '';
COMMENT ON EXTERNAL FUNCTION MINDBL IS '';
COMMENT ON EXTERNAL FUNCTION MINFLT IS '';
COMMENT ON EXTERNAL FUNCTION MININT IS '';
COMMENT ON EXTERNAL FUNCTION MINSML IS '';
COMMENT ON EXTERNAL FUNCTION MOD IS '';
COMMENT ON EXTERNAL FUNCTION MODQUOT IS '';
COMMENT ON EXTERNAL FUNCTION MODREM IS '';
COMMENT ON EXTERNAL FUNCTION MONTH_OF_YEAR IS '';
COMMENT ON EXTERNAL FUNCTION MSEC IS '';
COMMENT ON EXTERNAL FUNCTION NONULL IS '';
COMMENT ON EXTERNAL FUNCTION NUMBERFORMAT IS '';
COMMENT ON EXTERNAL FUNCTION PAD IS '';
COMMENT ON EXTERNAL FUNCTION PADLEFT IS '';
COMMENT ON EXTERNAL FUNCTION PADRIGHT IS '';
COMMENT ON EXTERNAL FUNCTION PARSE IS '';
COMMENT ON EXTERNAL FUNCTION PI IS '';
COMMENT ON EXTERNAL FUNCTION POS IS '';
COMMENT ON EXTERNAL FUNCTION POW IS '';
COMMENT ON EXTERNAL FUNCTION POW10 IS '';
COMMENT ON EXTERNAL FUNCTION PROPER IS '';
COMMENT ON EXTERNAL FUNCTION QUARTER IS '';
COMMENT ON EXTERNAL FUNCTION RADIANS IS '';
COMMENT ON EXTERNAL FUNCTION RAND IS '';
COMMENT ON EXTERNAL FUNCTION REPLICATE IS '';
COMMENT ON EXTERNAL FUNCTION REVERSE IS '';
COMMENT ON EXTERNAL FUNCTION RIGHTS IS '';
COMMENT ON EXTERNAL FUNCTION ROUND IS '';
COMMENT ON EXTERNAL FUNCTION RTRIM IS '';
COMMENT ON EXTERNAL FUNCTION RTRIMC IS '';
COMMENT ON EXTERNAL FUNCTION SEC IS '';
COMMENT ON EXTERNAL FUNCTION SIGN IS '';
COMMENT ON EXTERNAL FUNCTION SIN IS '';
COMMENT ON EXTERNAL FUNCTION SINH IS '';
COMMENT ON EXTERNAL FUNCTION SQRT IS '';
COMMENT ON EXTERNAL FUNCTION SQUOTEDSTR IS '';
COMMENT ON EXTERNAL FUNCTION STRFORMAT IS '';
COMMENT ON EXTERNAL FUNCTION STRLEN IS '';
COMMENT ON EXTERNAL FUNCTION SUBSTR IS '';
COMMENT ON EXTERNAL FUNCTION SUB_TIME IS '';
COMMENT ON EXTERNAL FUNCTION TAN IS '';
COMMENT ON EXTERNAL FUNCTION TANH IS '';
COMMENT ON EXTERNAL FUNCTION TRUNCATE IS '';
COMMENT ON EXTERNAL FUNCTION V4ALLTRIM IS '';
COMMENT ON EXTERNAL FUNCTION V4PARSE IS '';
COMMENT ON EXTERNAL FUNCTION V4POS IS '';
COMMENT ON EXTERNAL FUNCTION V4SUBSTRING IS '';
COMMENT ON EXTERNAL FUNCTION VALLTRIM IS '';
COMMENT ON EXTERNAL FUNCTION VALLTRIMC IS '';
COMMENT ON EXTERNAL FUNCTION VCENTER IS '';
COMMENT ON EXTERNAL FUNCTION VCENTRE IS '';
COMMENT ON EXTERNAL FUNCTION VCHARADD IS '';
COMMENT ON EXTERNAL FUNCTION VCHARDEL IS '';
COMMENT ON EXTERNAL FUNCTION VER IS '';
COMMENT ON EXTERNAL FUNCTION VLEFTS IS '';
COMMENT ON EXTERNAL FUNCTION VLEN IS '';
COMMENT ON EXTERNAL FUNCTION VLOWER IS '';
COMMENT ON EXTERNAL FUNCTION VLPAD IS '';
COMMENT ON EXTERNAL FUNCTION VLTRIM IS '';
COMMENT ON EXTERNAL FUNCTION VLTRIMC IS '';
COMMENT ON EXTERNAL FUNCTION VPAD IS '';
COMMENT ON EXTERNAL FUNCTION VPARSE IS '';
COMMENT ON EXTERNAL FUNCTION VPOS IS '';
COMMENT ON EXTERNAL FUNCTION VPROPER IS '';
COMMENT ON EXTERNAL FUNCTION VREPLICATE IS '';
COMMENT ON EXTERNAL FUNCTION VREVERSE IS '';
COMMENT ON EXTERNAL FUNCTION VRIGHTS IS '';
COMMENT ON EXTERNAL FUNCTION VRTRIM IS '';
COMMENT ON EXTERNAL FUNCTION VRTRIMC IS '';
COMMENT ON EXTERNAL FUNCTION VSUBSTRING IS '';
COMMENT ON EXTERNAL FUNCTION WEEK IS '';
COMMENT ON EXTERNAL FUNCTION ZEROTIME IS '';
