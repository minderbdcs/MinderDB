COMMIT WORK;
SET AUTODDL OFF;
SET TERM ^ ;
 
CREATE OR ALTER PROCEDURE SET_PICK_ORDER_POST_IMPORT (PICK_ORDER PICK_ORDER)
AS 

  DECLARE VARIABLE WK_PP_VOLUME FLOAT;
  DECLARE VARIABLE WK_PP_VOLUME_UOM UOM ;
  DECLARE VARIABLE WK_PICK_ORDER_QTY FLOAT;
  DECLARE VARIABLE WK_PP_WEIGHT WEIGHT_DECIMAL3;
  DECLARE VARIABLE WK_PP_WEIGHT_UOM UOM;
  DECLARE VARIABLE WK_PP_PACK_WEIGHT WEIGHT_DECIMAL3;
  DECLARE VARIABLE WK_PP_UOM UOM;
  DECLARE VARIABLE WK_LOG_FILENAME VARCHAR(80) ;
  DECLARE VARIABLE WK_LOG_RESULT   INTEGER;
  DECLARE VARIABLE WK_LOG_BUFFER VARCHAR(100) ;
  DECLARE VARIABLE WK_WEIGHT_UOM UOM;
  DECLARE VARIABLE WK_VOLUME_UOM UOM;
  DECLARE VARIABLE WK_DUMMY FLOAT;
  DECLARE VARIABLE WK_VOLUME FLOAT;
  DECLARE VARIABLE WK_WEIGHT WEIGHT_DECIMAL3;
  DECLARE VARIABLE WK_CA_MAX_WEIGHT   FLOAT;
  DECLARE VARIABLE WK_CN_UGLY_CARRIER DESPATCH_CARRIER;
  DECLARE VARIABLE WK_PO_SHIP_VIA     SHIP_VIA;
  DECLARE VARIABLE WK_WH_ADDRESS1     ADDRESS_LINE;
  DECLARE VARIABLE WK_WH_ADDRESS2     ADDRESS_LINE;
  DECLARE VARIABLE WK_WH_CITY         CITY;
  DECLARE VARIABLE WK_WH_SUBURB       CITY;
  DECLARE VARIABLE WK_WH_STATE        STATE;
  DECLARE VARIABLE WK_WH_COUNTRY      COUNTRY;
  DECLARE VARIABLE WK_WH_POST_CODE    POST_CODE;
  DECLARE VARIABLE WK_CD_DEPOT_ID     DEPOT_ID;
  DECLARE VARIABLE WK_CS_RECORD_ID    RECORD_ID;
  DECLARE VARIABLE WK_CS_SERVICE_TYPE SERVICE_TYPE;
  DECLARE VARIABLE WK_PO_SHIP_SERVICE SHIP_SERVICE;
  DECLARE VARIABLE WK_CS_CURRENT_RECORD_ID    RECORD_ID;
  DECLARE VARIABLE WK_CS_CURRENT_SERVICE_TYPE SERVICE_TYPE;
  
BEGIN

   /* update pick order other fields */
   WK_LOG_FILENAME = '/data/tmp/postimportorder.log';
   WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, 'start SET_PICK_ORDER_POST_IMPORT ');
   WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, 'order: ' || :PICK_ORDER );

   WK_DUMMY = 0.0;
   WK_WEIGHT = 0.0;
   WK_VOLUME = 0.0;
   WK_VOLUME_UOM = 'M3';
   WK_PP_UOM = 'M3';
   WK_WEIGHT_UOM = 'KG';
   WK_PO_SHIP_VIA = NULL;
   WK_CA_MAX_WEIGHT = NULL;
   WK_CN_UGLY_CARRIER = NULL;

   WK_PP_VOLUME  = 0.0;
   WK_PP_VOLUME_UOM = 'M3'; 
   WK_PICK_ORDER_QTY = 0;
   WK_PP_WEIGHT = 0.0;
   WK_PP_WEIGHT_UOM ='KG'; 
   WK_PP_PACK_WEIGHT = 0.0; 
   FOR SELECT PP.VOLUME, PP.VOLUME_UOM, PI.PICK_ORDER_QTY, PP.NET_WEIGHT, PP.NET_WEIGHT_UOM ,PP.PACK_WEIGHT
       FROM PICK_ITEM PI 
       JOIN PICK_ORDER PO ON PO.PICK_ORDER = PI.PICK_ORDER
       LEFT OUTER JOIN PROD_PROFILE PP
       ON PI.PROD_ID = PP.PROD_ID AND PO.COMPANY_ID = PP.COMPANY_ID
       WHERE PI.PICK_ORDER = :PICK_ORDER AND PI.PICK_ORDER_QTY>0 AND PI.EXPORTED_DESPATCH IN ('T','F') 
       INTO
           :WK_PP_VOLUME ,
           :WK_PP_VOLUME_UOM, 
           :WK_PICK_ORDER_QTY ,
           :WK_PP_WEIGHT ,
           :WK_PP_WEIGHT_UOM , 
           :WK_PP_PACK_WEIGHT 
   DO
   BEGIN
      IF (WK_PP_VOLUME IS NULL) THEN
         WK_PP_VOLUME = 0;
      IF (WK_PP_VOLUME_UOM IS NULL) THEN
         WK_PP_VOLUME_UOM = 'M3';
      IF (WK_PICK_ORDER_QTY IS NULL) THEN
         WK_PICK_ORDER_QTY = 0;
      IF (WK_PP_WEIGHT IS NULL) THEN
         WK_PP_WEIGHT = 0.0;
      IF (WK_PP_WEIGHT_UOM IS NULL) THEN
         WK_PP_WEIGHT_UOM = 'KG';
      IF (WK_PP_PACK_WEIGHT IS NULL) THEN
         WK_PP_PACK_WEIGHT = 0.0;
/*
		# have volume for a unit
		# volume = products volume  * order qty
*/
      WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, 'have prod volume ' || :WK_PP_VOLUME || ' order qty: ' || :WK_PICK_ORDER_QTY );
      WK_VOLUME = WK_VOLUME + (WK_PP_VOLUME * WK_PICK_ORDER_QTY);
      WK_VOLUME_UOM = WK_PP_VOLUME_UOM;
      IF (WK_PP_WEIGHT > 0.0) THEN
         WK_WEIGHT = WK_WEIGHT + (WK_PP_WEIGHT * WK_PICK_ORDER_QTY);
      ELSE
         WK_WEIGHT = WK_WEIGHT + (WK_PP_PACK_WEIGHT * WK_PICK_ORDER_QTY);
      WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, 'weight sum ' || :WK_WEIGHT || :WK_PP_WEIGHT || :WK_PP_PACK_WEIGHT || ' order qty ' || :WK_PICK_ORDER_QTY );
   END
   WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, 'weight total ' || :WK_WEIGHT  );
/*
	# have volume 
	# what is volume uom
	# 24/01/2013 carrier will have a max weight . 
	#            if the weight is bigger than that use the ugly
	#            carrier to use setup in the control  table
*/
   WK_VOLUME = ROUND(WK_VOLUME, 3);
   WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, 'update pick order volume and weight' );
   UPDATE PICK_ORDER SET VOLUME  = :WK_VOLUME, VOLUME_UOM = :WK_VOLUME_UOM , NET_WEIGHT = :WK_WEIGHT   
   WHERE PICK_ORDER = :PICK_ORDER;
   SELECT CAST(TIMESTAMP 'NOW' AS VARCHAR(26)) FROM CONTROL INTO :WK_LOG_BUFFER;
   WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, :WK_LOG_BUFFER );
/*
	# check weight overflow 25-01-2013
*/
   WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, 'get ship via and ugly carrier' );
   WK_PO_SHIP_SERVICE = NULL;
   SELECT PO.SHIP_VIA, CA.MAX_WEIGHT , CN.UGLY_CARRIER_ID, PO.SHIP_SERVICE
   FROM PICK_ORDER PO 
   JOIN CONTROL CN ON CN.RECORD_ID = 1
   JOIN CARRIER CA
   ON PO.SHIP_VIA   = CA.CARRIER_ID
   WHERE PO.PICK_ORDER = :PICK_ORDER  
   INTO :WK_PO_SHIP_VIA , :WK_CA_MAX_WEIGHT , :WK_CN_UGLY_CARRIER , :WK_PO_SHIP_SERVICE;
   SELECT CAST(TIMESTAMP 'NOW' AS VARCHAR(26)) FROM CONTROL INTO :WK_LOG_BUFFER;
   WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, :WK_LOG_BUFFER );
   WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, 'current carrier ' || COALESCE(WK_PO_SHIP_VIA,'') || ' service ' || COALESCE(:WK_PO_SHIP_SERVICE,'') );
   IF (WK_CN_UGLY_CARRIER IS NOT NULL) THEN
   BEGIN
      IF (WK_CA_MAX_WEIGHT IS NOT NULL) THEN
      BEGIN
         IF (WK_PO_SHIP_VIA IS NOT NULL) THEN
         BEGIN
            IF (WK_PO_SHIP_VIA <> WK_CN_UGLY_CARRIER) THEN
            BEGIN
               IF (WK_CA_MAX_WEIGHT < WK_WEIGHT) THEN
               BEGIN
                  WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, 'update pick order ship_via to ugly carrier' );
                  UPDATE PICK_ORDER SET SHIP_VIA  = :WK_CN_UGLY_CARRIER
                  WHERE PICK_ORDER = :PICK_ORDER ;
                  WK_PO_SHIP_VIA = WK_CN_UGLY_CARRIER;
               END
            END
         END
      END
   END
   SELECT CAST(TIMESTAMP 'NOW' AS VARCHAR(26)) FROM CONTROL INTO :WK_LOG_BUFFER;
   WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, 'after uglyfy update' || :WK_LOG_BUFFER );
/*
	# now have the weight and uglyfield due to overweight
	# have to calc the ship_service and P_CARRIER_SERVICE_RECORD_ID for the weight and state
	# and populate the s_addresses
*/
   WK_WH_ADDRESS1 = NULL;
   WK_WH_ADDRESS2 = NULL;
   WK_WH_CITY = NULL;
   WK_WH_SUBURB = NULL;
   WK_WH_STATE  = NULL;
   WK_WH_COUNTRY  = NULL;
   WK_WH_POST_CODE  = NULL;
   SELECT CAST(TIMESTAMP 'NOW' AS VARCHAR(26)) FROM CONTROL INTO :WK_LOG_BUFFER;
   WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, 'get S addresses data' || :WK_LOG_BUFFER );
   SELECT WH.ADDRESS1, WH.ADDRESS2, WH.WH_CITY, WH.WH_SUBURB, WH.WH_STATE, WH.WH_COUNTRY, WH.WH_POST_CODE 
   FROM PICK_ORDER PO 
   JOIN WAREHOUSE WH
   ON PO.WH_ID   = WH.WH_ID     
   WHERE PO.PICK_ORDER = :PICK_ORDER  
   INTO
      :WK_WH_ADDRESS1 , 
      :WK_WH_ADDRESS2 , 
      :WK_WH_CITY , 
      :WK_WH_SUBURB , 
      :WK_WH_STATE  , 
      :WK_WH_COUNTRY  ,
      :WK_WH_POST_CODE  ;
/*
	# ==========================================
	# get the depot for the wh
*/
   WK_CD_DEPOT_ID = NULL;
   SELECT FIRST 1  CD.CD_DEPOT_ID 
   FROM PICK_ORDER PO 
   JOIN CARRIER_DEPOT CD
   ON PO.SHIP_VIA   = CD.CD_CARRIER_ID AND  PO.P_STATE = CD.CD_STATE
   WHERE PO.PICK_ORDER = :PICK_ORDER  
   AND CD.CD_DEPOT_STATUS = 'CU'
   ORDER BY CD.CD_SEQUENCE
   INTO  :WK_CD_DEPOT_ID ;
   SELECT CAST(TIMESTAMP 'NOW' AS VARCHAR(26)) FROM CONTROL INTO :WK_LOG_BUFFER;
   IF (WK_CD_DEPOT_ID IS NULL) THEN
      WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, 'have null cd_depot_id' || :WK_LOG_BUFFER );
   ELSE
      WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, 'have cd_depot_id ' || :WK_CD_DEPOT_ID || ' ' || :WK_LOG_BUFFER );
/*
	# ==========================================
	# get the carrier_service for the zone and weight within the range
*/
   WK_CS_RECORD_ID = NULL;
   WK_CS_SERVICE_TYPE = NULL;
   IF (WK_CD_DEPOT_ID IS NULL) THEN
   BEGIN
      WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, 'have null cd_depot_id'  );
   END
   ELSE
   BEGIN
      WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, 'wk_cd_depot_id is ' || :WK_CD_DEPOT_ID  );
      SELECT FIRST 1  CS.RECORD_ID ,CS.SERVICE_TYPE   
      FROM PICK_ORDER PO 
      JOIN CARRIER_SERVICE CS
      ON PO.SHIP_VIA   = CS.CARRIER_ID AND  CS.DEPOT_ID = :WK_CD_DEPOT_ID
      WHERE PO.PICK_ORDER = :PICK_ORDER  
      AND COALESCE(CS.MIN_WEIGHT,0) <= (CASE WHEN PO.NET_WEIGHT = 0 THEN 0.001 ELSE PO.NET_WEIGHT END)
      AND COALESCE(CS.MAX_WEIGHT,9999.999) >= (CASE WHEN PO.NET_WEIGHT = 0 THEN 0.001 ELSE PO.NET_WEIGHT END) 
      ORDER BY CS.MAX_WEIGHT
      INTO 
         :WK_CS_RECORD_ID ,
         :WK_CS_SERVICE_TYPE ;
   END
   IF (WK_CS_RECORD_ID IS NULL) THEN
      WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, 'wk_cs_record_id is null '  );
   ELSE
      WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, 'wk_cs_record_id is ' || :WK_CS_RECORD_ID  );
   IF (WK_CS_SERVICE_TYPE IS NULL) THEN
      WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, 'wk_cs_service_type is null '  );
   ELSE
      WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, 'wk_cs_service_type is ' || :WK_CS_SERVICE_TYPE  );
/*
	# if none found try depot null and change the depot to be none
*/
   IF (WK_CS_RECORD_ID IS NULL) THEN
   BEGIN
      WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, 'try depot null '  );
      WK_CD_DEPOT_ID = NULL;
      SELECT FIRST 1  CS.RECORD_ID ,CS.SERVICE_TYPE   
      FROM PICK_ORDER PO 
      JOIN CARRIER_SERVICE CS
      ON PO.SHIP_VIA   = CS.CARRIER_ID AND  CS.DEPOT_ID IS NULL
      WHERE PO.PICK_ORDER = :PICK_ORDER  
      AND COALESCE(CS.MIN_WEIGHT,0) <= (CASE WHEN PO.NET_WEIGHT = 0 THEN 0.001 ELSE PO.NET_WEIGHT END)
      AND COALESCE(CS.MAX_WEIGHT,9999.999) >= (CASE WHEN PO.NET_WEIGHT = 0 THEN 0.001 ELSE PO.NET_WEIGHT END) 
      ORDER BY CS.MAX_WEIGHT
      INTO 
         :WK_CS_RECORD_ID ,
         :WK_CS_SERVICE_TYPE ;
   END
   IF (WK_CS_RECORD_ID IS NULL) THEN
      WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, 'wk_cs_record_id is null '  );
   ELSE
      WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, 'wk_cs_record_id is ' || :WK_CS_RECORD_ID  );
   IF (WK_CS_SERVICE_TYPE IS NULL) THEN
      WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, 'wk_cs_service_type is null '  );
   ELSE
      WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, 'wk_cs_service_type is ' || :WK_CS_SERVICE_TYPE  );
/* check the current service is ok to stay with */
   IF (WK_PO_SHIP_SERVICE IS NOT NULL) THEN
   BEGIN
      WK_CS_CURRENT_RECORD_ID = NULL;
      WK_CS_CURRENT_SERVICE_TYPE = NULL;
      SELECT FIRST 1  CS.RECORD_ID ,CS.SERVICE_TYPE   
      FROM PICK_ORDER PO 
      JOIN CARRIER_SERVICE CS
      ON PO.SHIP_VIA   = CS.CARRIER_ID AND  CS.SERVICE_TYPE = :WK_PO_SHIP_SERVICE
      WHERE PO.PICK_ORDER = :PICK_ORDER  
      AND  COALESCE(CS.DEPOT_ID,'') = COALESCE(:WK_CD_DEPOT_ID,'')
      AND COALESCE(CS.MIN_WEIGHT,0) <= (CASE WHEN PO.NET_WEIGHT = 0 THEN 0.001 ELSE PO.NET_WEIGHT END)
      AND COALESCE(CS.MAX_WEIGHT,9999.999) >= (CASE WHEN PO.NET_WEIGHT = 0 THEN 0.001 ELSE PO.NET_WEIGHT END) 
      ORDER BY CS.MAX_WEIGHT
      INTO 
         :WK_CS_CURRENT_RECORD_ID ,
         :WK_CS_CURRENT_SERVICE_TYPE ;
      IF (WK_CS_CURRENT_RECORD_ID IS NOT NULL) THEN
      BEGIN
         WK_CS_RECORD_ID = :WK_CS_CURRENT_RECORD_ID ;
         WK_CS_SERVICE_TYPE = :WK_CS_CURRENT_SERVICE_TYPE ;
      END
   END

/*
	# =========================================
	# update the order
*/
   UPDATE PICK_ORDER SET S_ADDRESS_LINE1  = :WK_WH_ADDRESS1, S_ADDRESS_LINE2 = :WK_WH_ADDRESS2, S_CITY = :WK_WH_CITY, S_STATE = :WK_WH_STATE, S_COUNTRY = :WK_WH_COUNTRY, S_POST_CODE = :WK_WH_POST_CODE, P_POST_CODE_ZONE = :WK_CD_DEPOT_ID, P_CARRIER_SERVICE_RECORD_ID = :WK_CS_RECORD_ID, SHIP_SERVICE = :WK_CS_SERVICE_TYPE, S_SUBURB = :WK_WH_SUBURB
   WHERE PICK_ORDER = :PICK_ORDER ;
   SELECT CAST(TIMESTAMP 'NOW' AS VARCHAR(26)) FROM CONTROL INTO :WK_LOG_BUFFER;
   WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, 'update orders s addresses' || :WK_LOG_BUFFER );
/*
	# now save the address in pick_item_address for type S
*/
   UPDATE PICK_ITEM_ADDRESS SET PIA_ADDRESS_LINE1  = :WK_WH_ADDRESS1, PIA_ADDRESS_LINE2 = :WK_WH_ADDRESS2, PIA_CITY = :WK_WH_CITY, PIA_STATE = :WK_WH_STATE, PIA_COUNTRY = :WK_WH_COUNTRY, PIA_POST_CODE = :WK_WH_POST_CODE, PIA_SUBURB = :WK_WH_SUBURB
   WHERE PICK_ORDER = :PICK_ORDER  AND PICK_LABEL_NO = 'ORDER' AND PIA_ADDR_TYPE = 'S';
   SELECT CAST(TIMESTAMP 'NOW' AS VARCHAR(26)) FROM CONTROL INTO :WK_LOG_BUFFER;
   WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, 'update pick_item_address s address' || :WK_LOG_BUFFER );

   WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, 'end  SET_PICK_ORDER_POST_IMPORT ');
END ^


SET TERM ; ^
COMMIT WORK;
SET AUTODDL ON;

GRANT EXECUTE ON PROCEDURE SET_PICK_ORDER_POST_IMPORT TO USER MINDER;
GRANT EXECUTE ON PROCEDURE SET_PICK_ORDER_POST_IMPORT TO USER LEGACY;
