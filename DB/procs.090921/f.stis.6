COMMIT WORK;
SET AUTODDL OFF;
SET TERM ^ ;
 
/*
add ssn hist for updated issns
*/

ALTER PROCEDURE PC_STIS (RECORD_ID INTEGER,
WH_ID CHAR(2) CHARACTER SET NONE,
LOCN_ID VARCHAR(10) CHARACTER SET NONE,
OBJECT VARCHAR(30) CHARACTER SET NONE,
TRN_TYPE VARCHAR(4) CHARACTER SET NONE,
TRN_CODE CHAR(1) CHARACTER SET NONE,
TRN_DATE TIMESTAMP,
REFERENCE VARCHAR(40) CHARACTER SET NONE,
ISSN_QTY INTEGER)
AS 
DECLARE VARIABLE LOCN_EXIST INTEGER;
  DECLARE VARIABLE WH_EXIST INTEGER;
  DECLARE VARIABLE COUNT_ISSN INTEGER;
  DECLARE VARIABLE LOCN_NAME VARCHAR(50);
  DECLARE VARIABLE LOCN_STAT CHAR(2);
  DECLARE VARIABLE LOCN_OWNER VARCHAR(10);
  DECLARE VARIABLE ST_MAX_RECORD_ID INTEGER;
  DECLARE VARIABLE ST_INITIATE_STIS INTEGER;
  DECLARE VARIABLE ST_STATUS CHAR(2);
  DECLARE VARIABLE ST_ACTION CHAR(2);
  DECLARE VARIABLE ST_VARIANCE INTEGER;
  DECLARE VARIABLE ISSN_COMPANYID VARCHAR(20);
  DECLARE VARIABLE ISSN_LOCN_ID VARCHAR(10);
  DECLARE VARIABLE ISSN_WH_ID VARCHAR(2);
  DECLARE VARIABLE QTY_ISSN_IN_LOCN INTEGER;
  DECLARE VARIABLE WK_QTY_IN_TRAN DOUBLE PRECISION;
  DECLARE VARIABLE WK_DEVICE_ID CHAR(2);
  DECLARE VARIABLE WK_USER VARCHAR(10);
  DECLARE VARIABLE ST_NEW_RECORD_ID INTEGER;
  DECLARE VARIABLE WK_NEW_ISSN CHAR(1);
  DECLARE VARIABLE WK_SUB_LOCN_ID VARCHAR(10);
  DECLARE VARIABLE WK_QTY_ISSN VARCHAR(20);
  DECLARE VARIABLE WK_STOCK_RECORD VARCHAR(20);
  DECLARE VARIABLE WK_COMMENT VARCHAR(40);
  DECLARE VARIABLE WK_RESPONSE VARCHAR(70);
  DECLARE VARIABLE WK_AUDIT CHAR(1);

  DECLARE VARIABLE WK_ORIG_SSN_ID VARCHAR(20);
  DECLARE VARIABLE WK_OWNER       VARCHAR(20);
  DECLARE VARIABLE WK_PROD_STATUS CHAR(2);
  DECLARE VARIABLE WK_PROD_DESC VARCHAR(50);
  DECLARE VARIABLE WK_PROD_TYPE VARCHAR(40);
  DECLARE VARIABLE SSN_ID INTEGER;
  DECLARE VARIABLE P_SSN_ID INTEGER;
  DECLARE VARIABLE W_SSN_ID VARCHAR(20);
  DECLARE VARIABLE LEN_SSN_ID INTEGER;
  DECLARE VARIABLE SSN_LENGTH INTEGER;

  DECLARE VARIABLE WK_LOG_FILENAME VARCHAR(80);
  DECLARE VARIABLE WK_BUFFER VARCHAR(200);
  DECLARE VARIABLE WK_LOG_RESULT INTEGER;
  
BEGIN

   WK_LOG_FILENAME = '/tmp/stis.log';
   /* DATE: 2ND FEB: DO I NEED TO FIRE THIS PROC EVEN WHEN THE LOCATION IS CORRECT */
   /* I THINK BEFORE FIRING THIS PROC I HAVE TO ESTABLISH WHETHER ST_STATUS OF LOCATION HAS BEEN UPDATED BY STLX (I THINK) ? OTHERWISE THROW ERROR AND EXIT */
/* I want to change the audit status for any seen issn so that the totals left to see work */

  ST_NEW_RECORD_ID = '0';
  LOCN_EXIST = 0;
  WH_EXIST = 0;
  COUNT_ISSN = 0;
  QTY_ISSN_IN_LOCN = 0;
  WK_QTY_IN_TRAN = 0;
  ST_INITIATE_STIS = 0;
  ISSN_COMPANYID = '';
  ISSN_LOCN_ID = '';
  ISSN_WH_ID = '';
  ST_ACTION = 'IG'; /* IGNORE */
  WK_NEW_ISSN = 'F';
  ST_MAX_RECORD_ID = NULL;
  /* get the passed qty */
  EXECUTE PROCEDURE GET_REFERENCE_FIELD :REFERENCE, 1  RETURNING_VALUES :WK_QTY_ISSN ; 
  EXECUTE PROCEDURE GET_REFERENCE_FIELD :REFERENCE, 2  RETURNING_VALUES :WK_STOCK_RECORD ; 
  EXECUTE PROCEDURE GET_REFERENCE_FIELD :REFERENCE, 3  RETURNING_VALUES :WK_COMMENT ; 
  WK_QTY_IN_TRAN  = WK_QTY_ISSN;

  IF (TRN_CODE NOT IN ('R', 'F', 'A', 'P', 'Q')) THEN
  BEGIN
     UPDATE TRANSACTIONS
     SET COMPLETE = 'F', ERROR_TEXT = 'TRN_CODE HAS TO BE R OR F'
     WHERE RECORD_ID = :RECORD_ID;
     EXIT;
  END
   
  SELECT 1,LOCN_STAT,LOCN_OWNER
  FROM LOCATION
  WHERE WH_ID = :WH_ID
  AND LOCN_ID = :LOCN_ID
  INTO :LOCN_EXIST, :LOCN_STAT, :LOCN_OWNER;

  IF (LOCN_EXIST = 0) THEN
  BEGIN
     UPDATE TRANSACTIONS
     SET COMPLETE = 'F', ERROR_TEXT = 'LOCATION DOES NOT EXIST. STLO TRANSACTION REQUIRED.'
     WHERE RECORD_ID = :RECORD_ID;
     EXIT;
  END

  IF (LOCN_STAT NOT IN ('ST')) THEN
  BEGIN
     UPDATE TRANSACTIONS
     SET COMPLETE = 'F', ERROR_TEXT = 'LOCN_STAT HAS TO BE ST. STLO TRANSACTION REQUIRED.'
     WHERE RECORD_ID = :RECORD_ID;
     EXIT;
  END
   
  SELECT PERSON_ID, DEVICE_ID, SUB_LOCN_ID
  FROM TRANSACTIONS
  WHERE RECORD_ID = :RECORD_ID
  INTO :WK_USER, :WK_DEVICE_ID, :WK_SUB_LOCN_ID;
   
  IF (WK_SUB_LOCN_ID IS NULL) THEN
  BEGIN
     WK_SUB_LOCN_ID = '';
  END

  IF ((TRN_CODE = 'R') OR (TRN_CODE = 'F')) THEN
  BEGIN
     SELECT COUNT(*) FROM ISSN
     WHERE SSN_ID = :OBJECT
     INTO :COUNT_ISSN;

     IF (COUNT_ISSN = 0) THEN
     BEGIN
        UPDATE TRANSACTIONS
        SET COMPLETE = 'F', ERROR_TEXT = 'ISSN DOES NOT EXIST'
        WHERE RECORD_ID = :RECORD_ID;
        EXIT;
        WK_NEW_ISSN = 'T';
     END

     SELECT SUM(CURRENT_QTY) 
     FROM ISSN
     WHERE SSN_ID = :OBJECT
     AND WH_ID = :WH_ID
     AND LOCN_ID = :LOCN_ID
     INTO :QTY_ISSN_IN_LOCN;

     SELECT COMPANY_ID, LOCN_ID, WH_ID 
     FROM ISSN
     WHERE SSN_ID = :OBJECT
/*
   AND WH_ID = :WH_ID
   AND LOCN_ID = :LOCN_ID
*/
     INTO :ISSN_COMPANYID, :ISSN_LOCN_ID, :ISSN_WH_ID;
  END
  IF ((TRN_CODE = 'Q') OR (TRN_CODE = 'P')) THEN
  BEGIN
     SELECT COUNT(*) FROM ISSN
     WHERE PROD_ID = :OBJECT
     AND WH_ID = :WH_ID
     AND LOCN_ID = :LOCN_ID
     INTO :COUNT_ISSN;

     IF (COUNT_ISSN = 0) THEN
     BEGIN
        WK_NEW_ISSN = 'T';
     END

     SELECT SUM(CURRENT_QTY) 
     FROM ISSN
     WHERE PROD_ID = :OBJECT
     AND WH_ID = :WH_ID
     AND LOCN_ID = :LOCN_ID
     INTO :QTY_ISSN_IN_LOCN;

     SELECT FIRST 1 COMPANY_ID, LOCN_ID, WH_ID 
     FROM ISSN
     WHERE PROD_ID = :OBJECT
     AND WH_ID = :WH_ID
     AND LOCN_ID = :LOCN_ID
     INTO :ISSN_COMPANYID, :ISSN_LOCN_ID, :ISSN_WH_ID;
  END

  IF (QTY_ISSN_IN_LOCN IS NULL) THEN
  BEGIN
     QTY_ISSN_IN_LOCN = 0;
  END
  IF (ISSN_COMPANYID IS NULL) THEN
  BEGIN
     ISSN_COMPANYID = '';
  END
  IF (ISSN_LOCN_ID IS NULL) THEN
  BEGIN
     ISSN_LOCN_ID = '';
  END
  IF (ISSN_WH_ID IS NULL) THEN
  BEGIN
     ISSN_WH_ID = '';
  END

  IF (TRN_CODE = 'R') THEN
  BEGIN
     SELECT FIRST 1 RECORD_ID FROM STOCKTAKE
     WHERE ST_SSN_ID = :OBJECT
     ORDER BY ST_AUDIT_DATE DESC
     INTO :ST_MAX_RECORD_ID;

     IF (ST_MAX_RECORD_ID IS NOT NULL) THEN
     BEGIN
        ST_INITIATE_STIS = 1;
        ST_ACTION = 'IR';
        UPDATE STOCKTAKE
           SET ST_ACTION = 'IR',
           ST_APPLIED_DATE = :TRN_DATE,
           ST_APPLIED_BY = :WK_USER,
           ST_APPLIED_DEVICE_ID = :WK_DEVICE_ID
        WHERE RECORD_ID = :ST_MAX_RECORD_ID;
               
        UPDATE STOCKTAKE
           SET ST_ACTION = 'IR',
           ST_APPLIED_DATE = :TRN_DATE,
           ST_APPLIED_BY = :WK_USER,
           ST_APPLIED_DEVICE_ID = :WK_DEVICE_ID
        WHERE ST_SSN_ID = :OBJECT
        AND ST_ACTION <> 'IR' ;
     END
     ELSE
     BEGIN
        ST_INITIATE_STIS = 0;
        UPDATE TRANSACTIONS
           SET COMPLETE = 'F', ERROR_TEXT = 'CANNOT RECOUNT:' + '|' + ' STOCKTAKE NOT INITIATED FOR THIS ISSN'
           WHERE RECORD_ID = :RECORD_ID;
        EXIT;
     END
            /* if (ST_MAX_RECORD_ID IS NULL) then */
  END     /* if (TRN_CODE = 'R') then */

  IF (TRN_CODE = 'Q') THEN
  BEGIN
     SELECT FIRST 1 RECORD_ID FROM STOCKTAKE
     WHERE ST_PROD_ID = :OBJECT
     AND ST_WH_ID = :WH_ID
     AND ST_LOCN_ID = :LOCN_ID
     ORDER BY ST_AUDIT_DATE DESC
     INTO :ST_MAX_RECORD_ID;

     IF (ST_MAX_RECORD_ID IS NOT NULL) THEN
     BEGIN
        ST_INITIATE_STIS = 3;
        ST_ACTION = 'IR';
        UPDATE STOCKTAKE
           SET ST_ACTION = 'IR',
           ST_APPLIED_DATE = :TRN_DATE,
           ST_APPLIED_BY = :WK_USER,
           ST_APPLIED_DEVICE_ID = :WK_DEVICE_ID
        WHERE RECORD_ID = :ST_MAX_RECORD_ID;
               
        UPDATE STOCKTAKE
           SET ST_ACTION = 'IR',
           ST_APPLIED_DATE = :TRN_DATE,
           ST_APPLIED_BY = :WK_USER,
           ST_APPLIED_DEVICE_ID = :WK_DEVICE_ID
        WHERE ST_PROD_ID = :OBJECT
        AND ST_WH_ID = :WH_ID
        AND ST_LOCN_ID = :LOCN_ID
        AND ST_ACTION <> 'IR' ;
     END
     ELSE
     BEGIN
        ST_INITIATE_STIS = 2;
        UPDATE TRANSACTIONS
           SET COMPLETE = 'F', ERROR_TEXT = 'CANNOT RECOUNT:' + '|' + ' STOCKTAKE NOT INITIATED FOR THIS PRODUCT'
           WHERE RECORD_ID = :RECORD_ID;
        EXIT;
     END
            /* if (ST_MAX_RECORD_ID IS NULL) then */
  END     /* if (TRN_CODE = 'Q') then */

  IF (TRN_CODE = 'F') THEN
  BEGIN
     ST_INITIATE_STIS = 1;
     UPDATE STOCKTAKE
     SET ST_ACTION = 'IR',
     ST_APPLIED_DATE = :TRN_DATE,
     ST_APPLIED_BY = :WK_USER,
     ST_APPLIED_DEVICE_ID = :WK_DEVICE_ID
     WHERE ST_SSN_ID = :OBJECT
     AND ST_ACTION <> 'IR' ;
  END
  IF (TRN_CODE = 'P') THEN
  BEGIN
     ST_INITIATE_STIS = 3;
     UPDATE STOCKTAKE
     SET ST_ACTION = 'IR',
     ST_APPLIED_DATE = :TRN_DATE,
     ST_APPLIED_BY = :WK_USER,
     ST_APPLIED_DEVICE_ID = :WK_DEVICE_ID
     WHERE ST_PROD_ID = :OBJECT
     AND ST_WH_ID = :WH_ID
     AND ST_LOCN_ID = :LOCN_ID
     AND ST_ACTION <> 'IR' ;
  END

  IF (ST_INITIATE_STIS = 1) THEN
  BEGIN
     IF (WK_NEW_ISSN = 'T') THEN
     BEGIN
        /* must create the issn but whats its company and product */
        QTY_ISSN_IN_LOCN = WK_QTY_IN_TRAN;
     END
     IF (WH_ID || LOCN_ID = ISSN_WH_ID || ISSN_LOCN_ID) THEN
          /* CORRECT LOCATION */
     BEGIN
        IF (QTY_ISSN_IN_LOCN = WK_QTY_IN_TRAN) THEN
        BEGIN
           ST_STATUS = 'CC';
           /* want to update the issns audit date audited flag  */
           UPDATE ISSN SET AUDITED = 'C', AUDIT_DATE=:TRN_DATE
           WHERE SSN_ID = :OBJECT;
           WK_AUDIT = 'C';
        END
        ELSE
        BEGIN
           ST_STATUS = 'IC';
           ST_ACTION = 'RC';
           /* want to update the issns audit date audited flag  */
           IF (ST_MAX_RECORD_ID IS NULL) THEN
           BEGIN
              /* an F trn code */
              UPDATE ISSN SET AUDITED = 'R', AUDIT_DATE=:TRN_DATE
              WHERE SSN_ID = :OBJECT;
              WK_AUDIT = 'R';
           END
           ELSE
           BEGIN
              /* an R trn code */
              UPDATE ISSN SET AUDITED = 'C', AUDIT_DATE=:TRN_DATE
              WHERE SSN_ID = :OBJECT;
              WK_AUDIT = 'C';
              /* ST_ACTION = 'CC'; */ /* ???? */
              /* ST_STATUS = 'CC'; */
           END
        END
        WK_RESPONSE = 'Processed successfully' || ' Audit ' || :WK_AUDIT || ' SubLocn ' || :WK_SUB_LOCN_ID;
        /* want to add ssn hist */
        EXECUTE PROCEDURE ADD_SSN_HIST(:WH_ID, :LOCN_ID, :OBJECT, 
                :TRN_TYPE, :TRN_CODE, :TRN_DATE,
                :WK_RESPONSE, :REFERENCE , :ISSN_QTY, :WK_USER, :WK_DEVICE_ID); 
     END

     IF (WH_ID || LOCN_ID <> ISSN_WH_ID || ISSN_LOCN_ID) THEN
        /* INCORRECT LOCATION */
     BEGIN
        IF (QTY_ISSN_IN_LOCN = WK_QTY_IN_TRAN) THEN
        BEGIN
           ST_STATUS = 'CL';
           /* want to update the issns audit date audited flag and wh and locn */
           UPDATE ISSN SET AUDITED = 'D', AUDIT_DATE=:TRN_DATE, WH_ID = :WH_ID, LOCN_ID = :LOCN_ID
           WHERE SSN_ID = :OBJECT;
           WK_AUDIT = 'D';
        END
        ELSE
        BEGIN
           ST_STATUS = 'IL';
           ST_ACTION = 'RC';
           /* want to update the issns audit date audited flag and wh and locn */
           IF (ST_MAX_RECORD_ID IS NULL) THEN
           BEGIN
              /* an F trn code */
              UPDATE ISSN SET AUDITED = 'R', AUDIT_DATE=:TRN_DATE, WH_ID = :WH_ID, LOCN_ID = :LOCN_ID
              WHERE SSN_ID = :OBJECT;
              WK_AUDIT = 'R';
           END
           ELSE
           BEGIN
              /* an R trn code */
              UPDATE ISSN SET AUDITED = 'D', AUDIT_DATE=:TRN_DATE, WH_ID = :WH_ID, LOCN_ID = :LOCN_ID
              WHERE SSN_ID = :OBJECT;
              /* ST_STATUS = 'CL'; */
              /* ST_ACTION = 'CC'; */ /* ???? */
              WK_AUDIT = 'D';
           END
        END
        WK_RESPONSE = 'Processed successfully' || ' Audit ' || :WK_AUDIT || ' SubLocn ' || :WK_SUB_LOCN_ID;
        /* want to add ssn hist */
        EXECUTE PROCEDURE ADD_SSN_HIST(:WH_ID, :LOCN_ID, :OBJECT, 
                :TRN_TYPE, :TRN_CODE, :TRN_DATE,
                :WK_RESPONSE, :REFERENCE , :ISSN_QTY, :WK_USER, :WK_DEVICE_ID); 
     END
  END

  IF (ST_INITIATE_STIS = 3) THEN
  BEGIN
     IF (WK_NEW_ISSN = 'T') THEN
     BEGIN
        /* must create the issn but whats its company and product */
        QTY_ISSN_IN_LOCN = WK_QTY_IN_TRAN;
        ISSN_WH_ID = WH_ID;
        ISSN_LOCN_ID = LOCN_ID;
        /* need 
           ssn.ssn_id to use
           initial prod status
           company
           issn.ssn_id to use */
        EXECUTE PROCEDURE GET_BARCODE_LENGTH RETURNING_VALUES SSN_LENGTH;
        WK_OWNER = NULL;
        IF (WK_OWNER IS NULL) THEN
        BEGIN
           SELECT COMPANY_ID FROM CONTROL INTO :WK_OWNER; 
        END
        SELECT NEW_PROD_STATUS 
           FROM CONTROL
           INTO :WK_PROD_STATUS;
        BEGIN
           SSN_ID = GEN_ID(ISSN_SSN_ID, 1);
           P_SSN_ID = SSN_ID - 1;
           LEN_SSN_ID = STRLEN(P_SSN_ID);
           W_SSN_ID = '';
              /* Padding leading with 0 */
           WHILE (LEN_SSN_ID < :SSN_LENGTH) DO
           BEGIN
              W_SSN_ID = W_SSN_ID || '0';
              LEN_SSN_ID = LEN_SSN_ID + 1;
           END
           W_SSN_ID = W_SSN_ID || P_SSN_ID;
        END
        SELECT FIRST 1 SSN_ID 
           FROM SSN
           WHERE PROD_ID = :OBJECT
           AND COMPANY_ID = :WK_OWNER
           INTO :WK_ORIG_SSN_ID;
        IF (WK_ORIG_SSN_ID IS NULL) THEN
        BEGIN
           SELECT SHORT_DESC, SSN_TYPE
           FROM PROD_PROFILE
           WHERE PROD_ID = :OBJECT
           INTO :WK_PROD_DESC, :WK_PROD_TYPE;
           INSERT INTO SSN (SSN_ID, WH_ID, LOCN_ID,  STATUS_SSN, LABEL_DATE, ORIGINAL_QTY,
           CURRENT_QTY, PO_RECEIVE_DATE, PROD_ID, SSN_DESCRIPTION, COMPANY_ID, CREATE_DATE, CREATED_BY, SSN_TYPE)
           VALUES (:W_SSN_ID, :WH_ID, :LOCN_ID,  :WK_PROD_STATUS, 'NOW', :QTY_ISSN_IN_LOCN, :QTY_ISSN_IN_LOCN, 'NOW', :OBJECT, :WK_PROD_DESC, :WK_OWNER, :TRN_DATE, :WK_USER, :WK_PROD_TYPE);
        END
        INSERT INTO ISSN (SSN_ID, ORIGINAL_SSN, WH_ID, LOCN_ID, CURRENT_QTY,ISSN_STATUS, PROD_ID, LABEL_DATE, COMPANY_ID, ORIGINAL_QTY, CREATE_DATE,USER_ID, INTO_DATE)
        VALUES (:W_SSN_ID, :WK_ORIG_SSN_ID, :WH_ID, :LOCN_ID, :QTY_ISSN_IN_LOCN, :WK_PROD_STATUS, :OBJECT, 'NOW', :WK_OWNER, :QTY_ISSN_IN_LOCN, :TRN_DATE, :WK_USER, :TRN_DATE );
     END
     IF (WH_ID || LOCN_ID = ISSN_WH_ID || ISSN_LOCN_ID) THEN
          /* CORRECT LOCATION */
     BEGIN
        IF (QTY_ISSN_IN_LOCN = WK_QTY_IN_TRAN) THEN
        BEGIN
           ST_STATUS = 'CC';
           /* want to update the issns audit date audited flag  */
           UPDATE ISSN SET AUDITED = 'C', AUDIT_DATE=:TRN_DATE
           WHERE PROD_ID = :OBJECT
           AND WH_ID = :WH_ID
           AND LOCN_ID = :LOCN_ID;
           WK_AUDIT = 'C';
        END
        ELSE
        BEGIN
           ST_STATUS = 'IC';
           ST_ACTION = 'RC';
           /* want to update the issns audit date audited flag  */
           IF (ST_MAX_RECORD_ID IS NULL) THEN
           BEGIN
              /* an F trn code */
              UPDATE ISSN SET AUDITED = 'R', AUDIT_DATE=:TRN_DATE
              WHERE PROD_ID = :OBJECT
              AND WH_ID = :WH_ID
              AND LOCN_ID = :LOCN_ID;
              WK_AUDIT = 'R';
           END
           ELSE
           BEGIN
              /* an R trn code */
              UPDATE ISSN SET AUDITED = 'C', AUDIT_DATE=:TRN_DATE
              WHERE PROD_ID = :OBJECT
              AND WH_ID = :WH_ID
              AND LOCN_ID = :LOCN_ID;
              WK_AUDIT = 'C';
              /* ST_ACTION = 'CC'; */ /* ???? */
              /* ST_STATUS = 'CC'; */
           END
        END
        WK_RESPONSE = 'Processed successfully' || ' Audit ' || :WK_AUDIT || ' SubLocn ' || :WK_SUB_LOCN_ID;
        /* want to add ssn hist */
        EXECUTE PROCEDURE ADD_SSN_HIST(:WH_ID, :LOCN_ID, :OBJECT, 
                :TRN_TYPE, :TRN_CODE, :TRN_DATE,
                :WK_RESPONSE, :REFERENCE , :ISSN_QTY, :WK_USER, :WK_DEVICE_ID); 
     END

     IF (WH_ID || LOCN_ID <> ISSN_WH_ID || ISSN_LOCN_ID) THEN
        /* INCORRECT LOCATION */
     BEGIN
        IF (QTY_ISSN_IN_LOCN = WK_QTY_IN_TRAN) THEN
        BEGIN
           ST_STATUS = 'CL';
           /* want to update the issns audit date audited flag and wh and locn */
           UPDATE ISSN SET AUDITED = 'D', AUDIT_DATE=:TRN_DATE, WH_ID = :WH_ID, LOCN_ID = :LOCN_ID
           WHERE PROD_ID = :OBJECT
           AND WH_ID = :WH_ID
           AND LOCN_ID = :LOCN_ID;
           WK_AUDIT = 'D';
        END
        ELSE
        BEGIN
           ST_STATUS = 'IL';
           ST_ACTION = 'RC';
           /* want to update the issns audit date audited flag and wh and locn */
           IF (ST_MAX_RECORD_ID IS NULL) THEN
           BEGIN
              /* an F trn code */
              UPDATE ISSN SET AUDITED = 'R', AUDIT_DATE=:TRN_DATE, WH_ID = :WH_ID, LOCN_ID = :LOCN_ID
              WHERE PROD_ID = :OBJECT
              AND WH_ID = :WH_ID
              AND LOCN_ID = :LOCN_ID;
              WK_AUDIT = 'R';
           END
           ELSE
           BEGIN
              /* an R trn code */
              UPDATE ISSN SET AUDITED = 'D', AUDIT_DATE=:TRN_DATE, WH_ID = :WH_ID, LOCN_ID = :LOCN_ID
              WHERE PROD_ID = :OBJECT
              AND WH_ID = :WH_ID
              AND LOCN_ID = :LOCN_ID;
              /* ST_STATUS = 'CL'; */
              /* ST_ACTION = 'CC'; */ /* ???? */
              WK_AUDIT = 'D';
           END
        END
        WK_RESPONSE = 'Processed successfully' || ' Audit ' || :WK_AUDIT || ' SubLocn ' || :WK_SUB_LOCN_ID;
        /* want to add ssn hist */
        EXECUTE PROCEDURE ADD_SSN_HIST(:WH_ID, :LOCN_ID, :OBJECT, 
                :TRN_TYPE, :TRN_CODE, :TRN_DATE,
                :WK_RESPONSE, :REFERENCE , :ISSN_QTY, :WK_USER, :WK_DEVICE_ID); 
     END
  END
  ST_VARIANCE = WK_QTY_IN_TRAN - QTY_ISSN_IN_LOCN;
  IF ((TRN_CODE = 'R') OR (TRN_CODE = 'F')) THEN
  BEGIN
     SELECT NEW_RECORD_ID FROM ADD_UPDATE_STOCKTAKE (
       0, :OBJECT, :WH_ID, :LOCN_ID, :WK_QTY_IN_TRAN, :ST_VARIANCE , :TRN_DATE, :WK_USER, :WK_DEVICE_ID, :ST_STATUS, : ST_ACTION, NULL, NULL, NULL,:ISSN_COMPANYID )
       INTO :ST_NEW_RECORD_ID;
  END
  IF ((TRN_CODE = 'Q') OR (TRN_CODE = 'P')) THEN
  BEGIN
     SELECT NEW_RECORD_ID FROM ADD_UPDATE_STOCKTAKE (
       0, NULL, :WH_ID, :LOCN_ID, :WK_QTY_IN_TRAN, :ST_VARIANCE , :TRN_DATE, :WK_USER, :WK_DEVICE_ID, :ST_STATUS, : ST_ACTION, NULL, NULL, NULL,:ISSN_COMPANYID )
       INTO :ST_NEW_RECORD_ID;
      UPDATE STOCKTAKE SET ST_PROD_ID = :OBJECT WHERE RECORD_ID = :ST_NEW_RECORD_ID;
  END

  IF (ST_NEW_RECORD_ID IS NULL) THEN
  BEGIN
    UPDATE TRANSACTIONS
    SET COMPLETE = 'F', ERROR_TEXT = 'ERROR IN INSERTING RECORD IN STOCKTAKE.'
    WHERE RECORD_ID = :RECORD_ID;
  END

  IF (ST_NEW_RECORD_ID IS NOT NULL) THEN
  BEGIN
   UPDATE TRANSACTIONS
   SET COMPLETE = 'T', ERROR_TEXT = 'Processed successfully' || '|' || :ST_NEW_RECORD_ID || '|' || :ST_ACTION || '|' || CAST(:ST_VARIANCE AS VARCHAR(10)) || '|' || :ST_STATUS || '|'
   WHERE RECORD_ID = :RECORD_ID;
  END

END ^


SET TERM ; ^
COMMIT WORK;
SET AUTODDL ON;
