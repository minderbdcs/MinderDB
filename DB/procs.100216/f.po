COMMIT WORK;
SET AUTODDL OFF;
SET TERM ^ ;
 

DROP TRIGGER ADD_PURCHASE_TYPE ^
COMMIT^

CREATE TRIGGER ADD_PURCHASE_TYPE FOR PURCHASE_ORDER 
ACTIVE BEFORE INSERT POSITION 2 
AS
DECLARE VARIABLE WK_ORDER_TYPE CHAR(2);
DECLARE VARIABLE WK_ORDER_COMPANY VARCHAR(20);
DECLARE VARIABLE WK_ORDER_STATUS CHAR(2);
DECLARE VARIABLE WK_FOUND INTEGER;
DECLARE VARIABLE WK_TEST_COMPANY VARCHAR(20);
DECLARE VARIABLE WK_TEST_COMPANY2 VARCHAR(20);
DECLARE VARIABLE WK_ORDER_NO VARCHAR(10);
BEGIN
   WK_ORDER_TYPE = '';
   WK_ORDER_COMPANY = '';
   WK_ORDER_STATUS = '';
   SELECT DEFAULT_PURCHASE_TYPE, COMPANY_ID, DEFAULT_PURCHASE_STATUS
   FROM CONTROL
   INTO :WK_ORDER_TYPE, :WK_ORDER_COMPANY, :WK_ORDER_STATUS;

   IF (NEW.ORDER_TYPE IS NULL) THEN
   BEGIN
      NEW.ORDER_TYPE = :WK_ORDER_TYPE;
   END
   IF (NEW.COMPANY_ID IS NULL) THEN
   BEGIN
      NEW.COMPANY_ID = :WK_ORDER_COMPANY;
   END
   IF (NEW.PO_STATUS IS NULL) THEN
   BEGIN
      NEW.PO_STATUS = :WK_ORDER_STATUS;
   END
   /* now check the company */
   WK_FOUND = 0;
   WK_TEST_COMPANY = NEW.COMPANY_ID;
   SELECT 1
   FROM COMPANY
   WHERE COMPANY_ID = :WK_TEST_COMPANY
   INTO :WK_FOUND;
   IF (WK_FOUND IS NULL) THEN
   BEGIN
      WK_FOUND = 0;
   END
   IF (WK_FOUND = 0) THEN
   BEGIN
      SELECT FIRST 1 1, COMPANY_ID
      FROM COMPANY
      WHERE NAME = :WK_TEST_COMPANY
      INTO :WK_FOUND, WK_TEST_COMPANY2;
      IF (WK_FOUND IS NULL) THEN
      BEGIN
         WK_FOUND = 0;
      END
      IF (WK_FOUND = 1) THEN
      BEGIN
         NEW.COMPANY_ID = WK_TEST_COMPANY2;
      END
   END
   IF (WK_FOUND = 0) THEN
   BEGIN
      NEW.COMPANY_ID = :WK_ORDER_COMPANY;
   END
   IF ((NEW.PURCHASE_ORDER IS NULL) OR (NEW.PURCHASE_ORDER = '') OR (NEW.PURCHASE_ORDER = '0')) THEN
   BEGIN
     WK_ORDER_NO = '';
     SELECT ORDER_ID FROM  GET_PO_ORDER_NO (NEW.ORDER_TYPE)
     INTO :WK_ORDER_NO;
     NEW.PURCHASE_ORDER = :WK_ORDER_NO;
   END
END ^


CREATE TRIGGER MOD_PURCHASE_TYPE FOR PURCHASE_ORDER 
ACTIVE BEFORE UPDATE POSITION 2 
AS
DECLARE VARIABLE WK_ORDER_TYPE CHAR(2);
DECLARE VARIABLE WK_ORDER_COMPANY VARCHAR(20);
DECLARE VARIABLE WK_ORDER_STATUS CHAR(2);
DECLARE VARIABLE WK_FOUND INTEGER;
DECLARE VARIABLE WK_TEST_COMPANY VARCHAR(20);
DECLARE VARIABLE WK_TEST_COMPANY2 VARCHAR(20);
DECLARE VARIABLE WK_ORDER_NO VARCHAR(10);
BEGIN
   WK_ORDER_TYPE = '';
   WK_ORDER_COMPANY = '';
   WK_ORDER_STATUS = '';
   SELECT DEFAULT_PURCHASE_TYPE, COMPANY_ID, DEFAULT_PURCHASE_STATUS
   FROM CONTROL
   INTO :WK_ORDER_TYPE, :WK_ORDER_COMPANY, :WK_ORDER_STATUS;

   IF (NEW.ORDER_TYPE IS NULL) THEN
   BEGIN
      NEW.ORDER_TYPE = :WK_ORDER_TYPE;
   END
   IF (NEW.COMPANY_ID IS NULL) THEN
   BEGIN
      NEW.COMPANY_ID = :WK_ORDER_COMPANY;
   END
   IF (NEW.PO_STATUS IS NULL) THEN
   BEGIN
      NEW.PO_STATUS = :WK_ORDER_STATUS;
   END
   /* now check the company */
   WK_FOUND = 0;
   WK_TEST_COMPANY = NEW.COMPANY_ID;
   SELECT 1
   FROM COMPANY
   WHERE COMPANY_ID = :WK_TEST_COMPANY
   INTO :WK_FOUND;
   IF (WK_FOUND IS NULL) THEN
   BEGIN
      WK_FOUND = 0;
   END
   IF (WK_FOUND = 0) THEN
   BEGIN
      SELECT FIRST 1 1, COMPANY_ID
      FROM COMPANY
      WHERE NAME = :WK_TEST_COMPANY
      INTO :WK_FOUND, WK_TEST_COMPANY2;
      IF (WK_FOUND IS NULL) THEN
      BEGIN
         WK_FOUND = 0;
      END
      IF (WK_FOUND = 1) THEN
      BEGIN
         NEW.COMPANY_ID = WK_TEST_COMPANY2;
      END
   END
   IF (WK_FOUND = 0) THEN
   BEGIN
      NEW.COMPANY_ID = :WK_ORDER_COMPANY;
   END
   IF ((NEW.PURCHASE_ORDER IS NULL) OR (NEW.PURCHASE_ORDER = '') OR (NEW.PURCHASE_ORDER = '0')) THEN
   BEGIN
     WK_ORDER_NO = '';
     SELECT ORDER_ID FROM  GET_PO_ORDER_NO (NEW.ORDER_TYPE)
     INTO :WK_ORDER_NO;
     NEW.PURCHASE_ORDER = :WK_ORDER_NO;
   END
END ^

SET TERM ; ^
COMMIT WORK;
SET AUTODDL ON;
