COMMIT WORK;
SET AUTODDL OFF;
SET TERM ^ ;
 

CREATE OR ALTER  PROCEDURE CALC_CHECK_DIGIT_BDCS(IN_INPUT VARCHAR(255),
IN_INCLUDE_LAST CHAR(1))
RETURNS (OUT_DATA VARCHAR(255) )
AS 
DECLARE VARIABLE WK_LEN_INPUT INTEGER;
DECLARE VARIABLE WK_INPUT VARCHAR(255);
DECLARE VARIABLE WK_ODD_SUM   INTEGER;
DECLARE VARIABLE WK_EVEN_SUM  INTEGER;
DECLARE VARIABLE WK_SUM  INTEGER;
DECLARE VARIABLE WK_CHECK_DIGIT INTEGER;
DECLARE VARIABLE WK_IDX         INTEGER;
BEGIN 
   /* if include last is 'F' then the last char should be the check digit - so exclude it from calc */
   IN_INCLUDE_LAST = 'F';
   IF (IN_INCLUDE_LAST = 'F') THEN
   BEGIN
      WK_LEN_INPUT = STRLEN(IN_INPUT) - 1;
      WK_INPUT = SUBSTR(IN_INPUT, 1, WK_LEN_INPUT - 1);
   END   
   ELSE
   BEGIN
      WK_LEN_INPUT = STRLEN(IN_INPUT);
      WK_INPUT = IN_INPUT;
   END   

   WK_ODD_SUM = 0;
   WK_EVEN_SUM = 0;

   WK_IDX = 1;
   WHILE (WK_IDX <= WK_LEN_INPUT) DO
   BEGIN
      IF (SUBSTR(WK_INPUT, WK_IDX, WK_IDX) > '0' AND SUBSTR(WK_INPUT, WK_IDX, WK_IDX) <= '9') THEN
      BEGIN
         WK_EVEN_SUM = WK_EVEN_SUM + SUBSTR(WK_INPUT, WK_IDX, WK_IDX);
      END
      ELSE
      BEGIN
         WK_EVEN_SUM  = WK_EVEN_SUM +  MOD(ASCII(SUBSTR(WK_INPUT, WK_IDX, WK_IDX)), 10);
      END
      WK_IDX = WK_IDX + 2;
   END
   WK_IDX = 2;
   WHILE (WK_IDX <= WK_LEN_INPUT) DO
   BEGIN
      IF (SUBSTR(WK_INPUT, WK_IDX, WK_IDX) > '0' AND SUBSTR(WK_INPUT, WK_IDX, WK_IDX) <= '9') THEN
      BEGIN
         WK_ODD_SUM = WK_ODD_SUM + SUBSTR(WK_INPUT, WK_IDX, WK_IDX);
      END
      ELSE
      BEGIN
         WK_ODD_SUM  = WK_ODD_SUM +  MOD(ASCII(SUBSTR(WK_INPUT, WK_IDX, WK_IDX)), 10);
      END
      WK_IDX = WK_IDX + 2;
   END
   WK_SUM   = (WK_ODD_SUM * 3) + WK_EVEN_SUM;
   WK_CHECK_DIGIT =  10 - MOD(WK_SUM, 10);
   OUT_DATA = WK_INPUT || WK_CHECK_DIGIT;
   SUSPEND;
END ^


SET TERM ; ^
COMMIT WORK;
SET AUTODDL ON;
