COMMIT WORK;
SET AUTODDL OFF;
SET TERM ^ ;
 

ALTER  PROCEDURE ADD_PICK_SSN_DESPATCH_ITEMS (WK_ORDER VARCHAR(15) ,
WK_STATUS CHAR(2) ,
WK_SSN VARCHAR(20) ,
WK_LINE_NO1 VARCHAR(4) ,
WK_QTY1 INTEGER,
WK_DESPATCH_LOCATION VARCHAR(10) ,
WK_FROM_LOCATION VARCHAR(10) ,
WK_TRN_DATE TIMESTAMP,
WK_PERSON_ID VARCHAR(10),
WK_DESPATCH_ID INTEGER ,
WK_DEVICE_ID CHAR(2) )
AS 
 
DECLARE VARIABLE WK_FOUND INTEGER;
DECLARE VARIABLE WK_PICK_LABEL VARCHAR(8);
DECLARE VARIABLE WK_L_PICK_LINE_NO VARCHAR(4);
DECLARE VARIABLE WK_PICK_DETAIL_ID INTEGER;
DECLARE VARIABLE WK_FROM_WH_ID CHAR(2);
DECLARE VARIABLE WK_FROM_LOCN_ID VARCHAR(10);
BEGIN
/*====================================================================*/
   /* do line stuff */
   WK_FOUND = 0;
   WK_FROM_WH_ID = '';
   WK_FROM_LOCN_ID = '';
   WK_FROM_WH_ID = SUBSTR(WK_FROM_LOCATION,1,2);
   WK_FROM_LOCN_ID = SUBSTR(WK_FROM_LOCATION,3,10);
   /* does line for ssn exist in order */
   BEGIN
      WK_FOUND = 0;
      SELECT FIRST 1  1, PICK_LABEL_NO 
      FROM PICK_ITEM
      WHERE PICK_ORDER = :WK_ORDER
        AND SSN_ID = :WK_SSN
        AND PICK_LINE_STATUS = :WK_STATUS 
      INTO :WK_FOUND, :WK_PICK_LABEL;
      IF (WK_FOUND = 0) THEN
      BEGIN
         /* no line - so create one */
         /* calc the next label and line no */
         WK_PICK_LABEL = '';
         SELECT LABEL_NO FROM NEXT_PICK_LABEL
         INTO :WK_PICK_LABEL;
         IF ((WK_LINE_NO1 > '') AND (WK_LINE_NO1 <> '0')) THEN
         BEGIN
            WK_L_PICK_LINE_NO = WK_LINE_NO1;
         END
         ELSE
         BEGIN
            SELECT PICK_ORDER_LINE_NO 
            FROM GET_SALE_LINES_NO(:WK_ORDER) 
            INTO :WK_L_PICK_LINE_NO;
         END
         INSERT INTO PICK_ITEM(
            PICK_ORDER, 
            PICK_LABEL_NO,
            PICK_ORDER_LINE_NO,
            PICK_LINE_STATUS, 
            PICK_ORDER_QTY, 
            SSN_ID,
            CREATE_DATE,
            USER_ID,
            SSN_CONFIRM,
            DESPATCH_LOCATION,
            PICKED_QTY)
         VALUES (
            :WK_ORDER, 
            :WK_PICK_LABEL,
            :WK_L_PICK_LINE_NO,
            :WK_STATUS,
            :WK_QTY1,
            :WK_SSN,
            :WK_TRN_DATE,
            :WK_PERSON_ID,
            'I',
            :WK_DESPATCH_LOCATION ,
            :WK_QTY1 );
      END
      ELSE
      BEGIN
         UPDATE PICK_ITEM 
         SET PICK_ORDER_QTY = :WK_QTY1,
             PICKED_QTY = :WK_QTY1,
            PICK_LINE_STATUS = :WK_STATUS,
            CREATE_DATE = :WK_TRN_DATE,
            USER_ID = :WK_PERSON_ID
         WHERE PICK_LABEL_NO = :WK_PICK_LABEL;
      END
   END
/*
    ok have pick item
    need pick_item_detail as well
*/
   BEGIN
      WK_FOUND = 0;
      SELECT FIRST 1  1, PICK_DETAIL_ID 
      FROM PICK_ITEM_DETAIL
      WHERE PICK_LABEL_NO = :WK_PICK_LABEL
        AND SSN_ID = :WK_SSN
      INTO :WK_FOUND, :WK_PICK_DETAIL_ID;
      IF (WK_FOUND = 0) THEN
      BEGIN
         /* no line - so create one */
         INSERT INTO PICK_ITEM_DETAIL 
             (PICK_LABEL_NO, 
              SSN_ID, 
              PICK_DETAIL_STATUS, 
              DESPATCH_LOCATION,
              QTY_PICKED,
              USER_ID, 
              CREATE_DATE,
              FROM_WH_ID,
              FROM_LOCN_ID,
              DESPATCH_ID,
              DEVICE_ID)
         VALUES (:WK_PICK_LABEL, 
              :WK_SSN,
              :WK_STATUS,
              :WK_DESPATCH_LOCATION ,
              :WK_QTY1,
              :WK_PERSON_ID,
              :WK_TRN_DATE,
              :WK_FROM_WH_ID,
              :WK_FROM_LOCN_ID,
              :WK_DESPATCH_ID,
              :WK_DEVICE_ID);
      END
      ELSE
      BEGIN
         UPDATE PICK_ITEM_DETAIL 
         SET QTY_PICKED = :WK_QTY1,
            PICK_DETAIL_STATUS = :WK_STATUS,
            CREATE_DATE = :WK_TRN_DATE,
            USER_ID = :WK_PERSON_ID,
            DESPATCH_LOCATION = :WK_DESPATCH_LOCATION,
            FROM_WH_ID = :WK_FROM_WH_ID,
            FROM_LOCN_ID = :WK_FROM_LOCN_ID,
            DESPATCH_ID = :WK_DESPATCH_ID,
            DEVICE_ID = :WK_DEVICE_ID
         WHERE PICK_DETAIL_ID = :WK_PICK_DETAIL_ID;
      END
   END
END ^


SET TERM ; ^
COMMIT WORK;
SET AUTODDL ON;
