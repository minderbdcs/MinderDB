COMMIT WORK;
SET AUTODDL OFF;
SET TERM ^ ;
 

CREATE OR ALTER TRIGGER RUN_TRANSACTION_TRLO FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 36 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_WH_ID CHAR(2);
DECLARE VARIABLE WK_LOCN_ID VARCHAR(10);
DECLARE VARIABLE WK_QTY INTEGER;
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'TRLO') THEN
  BEGIN
    WK_WH_ID = NEW.WH_ID;
    IF (WK_WH_ID IS NOT NULL) THEN
    BEGIN
       WK_WH_ID = UPPER(WK_WH_ID);
    END
    WK_LOCN_ID = NEW.LOCN_ID;
    IF (WK_LOCN_ID IS NOT NULL) THEN
    BEGIN
       WK_LOCN_ID = UPPER(WK_LOCN_ID);
    END
    IF (NEW.QTY IS NULL) THEN
    BEGIN
       WK_QTY  = 0;
    END
    ELSE
    BEGIN
       WK_QTY = NEW.QTY;
    END
   EXECUTE PROCEDURE PC_TRLO_TRLI
    NEW.RECORD_ID ,
    WK_WH_ID,
    WK_LOCN_ID,
    NEW.OBJECT,
    NEW.TRN_TYPE,
    NEW.TRN_CODE,
    NEW.TRN_DATE,
    NEW.REFERENCE,
    :WK_QTY,
    NEW.PERSON_ID,
    NEW.DEVICE_ID;
   /* EXECUTE PROCEDURE TRAN_ARCHIVE; */
  END
 END
END ^

CREATE OR ALTER TRIGGER RUN_TRANSACTION_TRLI FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 37 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_WH_ID CHAR(2);
DECLARE VARIABLE WK_LOCN_ID VARCHAR(10);
DECLARE VARIABLE WK_QTY INTEGER;
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'TRLI') THEN
  BEGIN
    WK_WH_ID = NEW.WH_ID;
    IF (WK_WH_ID IS NOT NULL) THEN
    BEGIN
       WK_WH_ID = UPPER(WK_WH_ID);
    END
    WK_LOCN_ID = NEW.LOCN_ID;
    IF (WK_LOCN_ID IS NOT NULL) THEN
    BEGIN
       WK_LOCN_ID = UPPER(WK_LOCN_ID);
    END
    IF (NEW.QTY IS NULL) THEN
    BEGIN
       WK_QTY  = 0;
    END
    ELSE
    BEGIN
       WK_QTY = NEW.QTY;
    END
   EXECUTE PROCEDURE PC_TRLO_TRLI
    NEW.RECORD_ID ,
    WK_WH_ID,
    WK_LOCN_ID,
    NEW.OBJECT,
    NEW.TRN_TYPE,
    NEW.TRN_CODE,
    NEW.TRN_DATE,
    NEW.REFERENCE,
    :WK_QTY,
    NEW.PERSON_ID,
    NEW.DEVICE_ID;
   /* EXECUTE PROCEDURE TRAN_ARCHIVE; */
  END
 END
END ^

CREATE OR ALTER TRIGGER RUN_TRANSACTION_TROL FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 38 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_WH_ID CHAR(2);
DECLARE VARIABLE WK_LOCN_ID VARCHAR(10);
DECLARE VARIABLE WK_QTY INTEGER;
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'TROL') THEN
  BEGIN
    WK_WH_ID = NEW.WH_ID;
    IF (WK_WH_ID IS NOT NULL) THEN
    BEGIN
       WK_WH_ID = UPPER(WK_WH_ID);
    END
    WK_LOCN_ID = NEW.LOCN_ID;
    IF (WK_LOCN_ID IS NOT NULL) THEN
    BEGIN
       WK_LOCN_ID = UPPER(WK_LOCN_ID);
    END
    IF (NEW.QTY IS NULL) THEN
    BEGIN
       WK_QTY  = 0;
    END
    ELSE
    BEGIN
       WK_QTY = NEW.QTY;
    END
   EXECUTE PROCEDURE PC_TROL_TRIL
    NEW.RECORD_ID ,
    WK_WH_ID,
    WK_LOCN_ID,
    NEW.OBJECT,
    NEW.TRN_TYPE,
    NEW.TRN_CODE,
    NEW.TRN_DATE,
    NEW.REFERENCE,
    :WK_QTY,
    NEW.PERSON_ID,
    NEW.DEVICE_ID;
   /* EXECUTE PROCEDURE TRAN_ARCHIVE; */
  END
 END
END ^

CREATE OR ALTER TRIGGER RUN_TRANSACTION_TRIL FOR TRANSACTIONS 
ACTIVE AFTER  INSERT POSITION 39 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_WH_ID CHAR(2);
DECLARE VARIABLE WK_LOCN_ID VARCHAR(10);
DECLARE VARIABLE WK_QTY INTEGER;
DECLARE VARIABLE WK_DEF_COMPANY_ID COMPANY;
DECLARE VARIABLE WK_SYSTEM_RET_LOCATION LOCN_ID;
DECLARE VARIABLE WK_SYSTEM_RET_WH_ID WH_ID;
DECLARE VARIABLE WK_SYSTEM_RET_LOCN_ID LOCN_ID;
DECLARE VARIABLE WK_DEVICE_WH_ID WH_ID;
DECLARE VARIABLE WK_RETURN_OPTION_CODE CODE;
DECLARE VARIABLE WK_RETURN_RET_LOCATION LOCN_ID;
DECLARE VARIABLE WK_RETURN_RET_WH_ID WH_ID;
DECLARE VARIABLE WK_RETURN_RET_LOCN_ID LOCN_ID;
DECLARE VARIABLE WK_LOG_FILENAME VARCHAR(80) ;
DECLARE VARIABLE WK_LOG_RESULT   INTEGER;
BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'TRIL') THEN
  BEGIN
   WK_LOG_FILENAME = '/tmp/tril.log';
    WK_WH_ID = NEW.WH_ID;
    IF (WK_WH_ID IS NOT NULL) THEN
    BEGIN
       WK_WH_ID = UPPER(WK_WH_ID);
    END
    WK_LOCN_ID = NEW.LOCN_ID;
    IF (WK_LOCN_ID IS NOT NULL) THEN
    BEGIN
       WK_LOCN_ID = UPPER(WK_LOCN_ID);
    END
    IF (NEW.QTY IS NULL) THEN
    BEGIN
       WK_QTY  = 0;
    END
    ELSE
    BEGIN
       WK_QTY = NEW.QTY;
    END
    /* need to check the wh and locn for downer */
    WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, 'start TRIL');
    WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, 'Start WH_ID');
    WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, :WK_WH_ID);
    WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, 'Start LOCN_ID');
    WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, :WK_LOCN_ID);
    WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, 'Device ');
    WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, NEW.DEVICE_ID);
    WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, 'Object ');
    WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, NEW.OBJECT);
    /* get the default company */
    WK_DEF_COMPANY_ID = NULL;
    SELECT COMPANY_ID FROM CONTROL INTO :WK_DEF_COMPANY_ID;
    WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, 'Company_ID');
    WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, :WK_DEF_COMPANY_ID);
    /* get the devices wh */
    WK_DEVICE_WH_ID = NULL;
    SELECT WH_ID FROM SYS_EQUIP WHERE DEVICE_ID = NEW.DEVICE_ID INTO :WK_DEVICE_WH_ID;
    WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, 'WH_ID of Device');
    WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, :WK_DEVICE_WH_ID);
    /* get the  system default return location */
    WK_SYSTEM_RET_LOCATION = NULL;
    WK_SYSTEM_RET_WH_ID = NULL;
    WK_SYSTEM_RET_LOCN_ID = NULL;
    WK_RETURN_OPTION_CODE = NULL;
    WK_RETURN_RET_LOCATION = NULL;
    WK_RETURN_RET_WH_ID = NULL;
    WK_RETURN_RET_LOCN_ID = NULL;
    SELECT DESCRIPTION
    FROM OPTIONS WHERE GROUP_CODE = 'DEF_RET_LO' AND CODE = :WK_DEF_COMPANY_ID
    INTO :WK_SYSTEM_RET_LOCATION;
    WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, 'System Return Location');
    WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, :WK_SYSTEM_RET_LOCATION );
    IF (WK_DEVICE_WH_ID IS NOT NULL) THEN
    BEGIN
       IF (WK_SYSTEM_RET_LOCATION IS NOT NULL) THEN
       BEGIN
    WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, 'device wh_id and system ret location not null');
          WK_SYSTEM_RET_WH_ID = SUBSTR(WK_SYSTEM_RET_LOCATION,1,2);
          WK_SYSTEM_RET_LOCN_ID = SUBSTR(WK_SYSTEM_RET_LOCATION,3,10);
    WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, 'System WH_ID');
    WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, :WK_SYSTEM_RET_WH_ID);
    WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, 'System LOCN_ID');
    WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, :WK_SYSTEM_RET_LOCN_ID);
          IF (WK_WH_ID = WK_SYSTEM_RET_WH_ID AND WK_LOCN_ID = WK_SYSTEM_RET_LOCN_ID) THEN
          BEGIN
    WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, 'System and current locations equal');
             /* a transfer to the old default return location */
             /* get the location to use instead */
             WK_RETURN_OPTION_CODE = :WK_DEF_COMPANY_ID || '|' || :WK_DEVICE_WH_ID;
    WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, 'OPTIONS CODE');
    WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, :WK_RETURN_OPTION_CODE);
             SELECT DESCRIPTION
             FROM OPTIONS WHERE GROUP_CODE = 'DEF_RET_LO' AND CODE = :WK_RETURN_OPTION_CODE
             INTO :WK_RETURN_RET_LOCATION;
    WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, 'Options Return Location');
    WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, :WK_RETURN_RET_LOCATION );
             IF (WK_RETURN_RET_LOCATION IS NOT NULL) THEN
             BEGIN
    WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, 'Options Return Location not null');
                WK_RETURN_RET_WH_ID = SUBSTR(WK_RETURN_RET_LOCATION,1,2);
                WK_RETURN_RET_LOCN_ID = SUBSTR(WK_RETURN_RET_LOCATION,3,10);
    WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, 'Options WH_ID');
    WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, :WK_RETURN_RET_WH_ID);
    WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, 'Options LOCN_ID');
    WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, :WK_RETURN_RET_LOCN_ID);
                WK_WH_ID = WK_RETURN_RET_WH_ID;
                WK_LOCN_ID = WK_RETURN_RET_LOCN_ID;
/*
                NEW.WH_ID = WK_RETURN_RET_WH_ID;
                NEW.LOCN_ID = WK_RETURN_RET_LOCN_ID;
*/
    WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, 'location changed');
             END
        
          END
       END
    END
   EXECUTE PROCEDURE PC_TROL_TRIL
    NEW.RECORD_ID ,
    WK_WH_ID,
    WK_LOCN_ID,
    NEW.OBJECT,
    NEW.TRN_TYPE,
    NEW.TRN_CODE,
    NEW.TRN_DATE,
    NEW.REFERENCE,
    :WK_QTY,
    NEW.PERSON_ID,
    NEW.DEVICE_ID;
    WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, 'end TRIL');
   /* EXECUTE PROCEDURE TRAN_ARCHIVE; */
  END
 END
END ^



SET TERM ; ^
COMMIT WORK;
SET AUTODDL ON;
