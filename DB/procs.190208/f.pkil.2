COMMIT WORK;
SET AUTODDL OFF;
SET TERM ^ ;
 

CREATE OR ALTER TRIGGER RUN_TRANSACTION_PKIL FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 56 
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_DEVICE CHAR(2);
DECLARE VARIABLE WK_USER VARCHAR(10);
DECLARE VARIABLE WK_RECORD INTEGER;
DECLARE VARIABLE WK_LABEL_NO VARCHAR(10);
DECLARE VARIABLE WK_WH_ID CHAR(2);
DECLARE VARIABLE WK_LOCN_ID VARCHAR(10);
DECLARE VARIABLE WK_OBJECT VARCHAR(30);
DECLARE VARIABLE WK_REF VARCHAR(1024);
DECLARE VARIABLE WK_QTY INTEGER;
DECLARE VARIABLE WK_DATE TIMESTAMP;
DECLARE VARIABLE WK_PID_ID INTEGER;
DECLARE VARIABLE WK_SSN_ID VARCHAR(20);
DECLARE VARIABLE WK_LOCN_TYPE CHAR(2);
DECLARE VARIABLE WK_PI_STATUS CHAR(2);
DECLARE VARIABLE WK_PI_STATUS2 CHAR(2);
DECLARE VARIABLE WK_TRN_TYPE VARCHAR(4);
DECLARE VARIABLE WK_TRN_CODE CHAR(1);
DECLARE VARIABLE WK_AUDIT_DESC VARCHAR(40);
DECLARE VARIABLE WK_DESC VARCHAR(80);
/* DECLARE VARIABLE WK_ORDER VARCHAR(15); */
DECLARE VARIABLE WK_ORDER VARCHAR(1024);
/* DECLARE VARIABLE WK_FROM_LOCN VARCHAR(40); */
DECLARE VARIABLE WK_FROM_LOCN VARCHAR(1024);
DECLARE VARIABLE WK_FROM_LOCN2 VARCHAR(1024);
DECLARE VARIABLE WK_FROM_WH_ID VARCHAR(40);
DECLARE VARIABLE WK_DUMMY CHAR(1);
DECLARE VARIABLE WK_LOG VARCHAR(255);
DECLARE VARIABLE WK_DATE_TXT VARCHAR(25);
DECLARE VARIABLE WK_PL_WH_ID CHAR(2);
DECLARE VARIABLE WK_PL_LOCN_ID VARCHAR(10);
DECLARE VARIABLE WK_ISS_ISSN_ID VARCHAR(20);
DECLARE VARIABLE WK_LOG_FILENAME VARCHAR(80) ;
DECLARE VARIABLE WK_LOG_RESULT   INTEGER;

BEGIN
 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'PKIL') THEN
  BEGIN
     WK_DEVICE = NEW.DEVICE_ID;
     WK_LABEL_NO = NEW.SUB_LOCN_ID;
     WK_WH_ID = NEW.WH_ID;
     WK_LOCN_ID = NEW.LOCN_ID;
     WK_USER = NEW.PERSON_ID;
     WK_OBJECT = NEW.OBJECT;
     WK_QTY = NEW.QTY;
     WK_DATE = NEW.TRN_DATE;
     WK_RECORD = NEW.RECORD_ID;
     WK_TRN_CODE = NEW.TRN_CODE;
     WK_TRN_TYPE = NEW.TRN_TYPE;
     WK_REF = NEW.REFERENCE;
     WK_DATE_TXT = CAST(CAST('NOW' AS TIMESTAMP) AS CHAR(24));
     WK_LOG = 'TRN_TYPE ' || NEW.TRN_TYPE ||
     ' TRN_CODE ' || NEW.TRN_CODE || ' date ' || WK_DATE_TXT ||
     ' OBJECT ' || NEW.OBJECT || ' date ' || WK_DATE_TXT || ' start ';
     /* INSERT INTO LOG(DESCRIPTION) VALUES(:WK_LOG); */
   WK_LOG_FILENAME = '/data/tmp/pkil.log';
   WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, 'start pkil ');
   WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, 'wh: ' || :WK_WH_ID);
   WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, 'locn: ' || :WK_LOCN_ID);
   WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, 'user: ' || :WK_USER);
   WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, 'object: ' || :WK_OBJECT);
   WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, 'sublocn: ' || :WK_LABEL_NO);
   WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, 'device: ' || :WK_DEVICE || ':');

/*
have 5 transaction classes
 for picking (ie it is on my device)
 M - transfer all on device
 D - transfer all for pick_label in sub_locn_id
 I - transfer all for issn in object
 P - transfer all for product in object
 for assembly (ie its not on my device)
 G - transfer all of product in object 
     for order in the sub_locn_id
     only take from the location specified in the reference
     across all devices 
 for pre checking (ie its on the device of the conveyor)
 L - transfer all from the location specified in the reference
     for the order in the object
 change the ssn status to DS if for a despatch location
 and the pick_item .. to PC or PS
 do the updates as happen already for pick_item and issn
 02/08/2010 
 if any pick_locations records for the issns moved (current location) 
 and location becomes empty then must update the status of the pick_locations record to 'DS'
 I have done this only to 'G' trn_code since only this form does the finishing of pick
 when using the allocated scanned trolley location
*/

     /* WK_LOCN_TYPE = 'DS'; */
     WK_LOCN_TYPE = 'PL';
     SELECT STORE_AREA
        FROM LOCATION
        WHERE LOCN_ID = :WK_LOCN_ID
          AND WH_ID = :WK_WH_ID
         INTO :WK_LOCN_TYPE; 
     IF (WK_LOCN_TYPE = 'DS') THEN
     BEGIN
        WK_PI_STATUS = 'DS';
     END
     ELSE
     BEGIN
        WK_PI_STATUS = 'PL';
     END

     WK_AUDIT_DESC = 'Picked to Location ' || :WK_LOCN_ID ;
     IF (NEW.TRN_CODE = 'M') THEN
     BEGIN
        FOR SELECT PICK_DETAIL_ID, SSN_ID 
           FROM PICK_ITEM_DETAIL 
           WHERE DEVICE_ID = :WK_DEVICE 
             AND PICK_DETAIL_STATUS = 'PL'
            INTO :WK_PID_ID, :WK_SSN_ID
        DO
        BEGIN
           UPDATE ISSN SET ISSN_STATUS = :WK_PI_STATUS,
               PREV_PREV_WH_ID = PREV_WH_ID,
               PREV_PREV_LOCN_ID = PREV_LOCN_ID,
               PREV_WH_ID = WH_ID,
               PREV_LOCN_ID = LOCN_ID,
               WH_ID = :WK_WH_ID,
               LOCN_ID = :WK_LOCN_ID
           WHERE SSN_ID = :WK_SSN_ID;
           UPDATE PICK_ITEM_DETAIL SET DESPATCH_LOCATION = :WK_LOCN_ID
           WHERE PICK_DETAIL_ID = :WK_PID_ID;
           EXECUTE PROCEDURE ADD_SSN_HIST(:WK_WH_ID, :WK_LOCN_ID, :WK_SSN_ID, :WK_TRN_TYPE, :WK_TRN_CODE, :WK_DATE,
                  :WK_AUDIT_DESC , '', :WK_QTY, :WK_USER, :WK_DEVICE); 
        END
        /* update item to PL or  DS  
        */
        IF (WK_PI_STATUS = 'DS') THEN
        BEGIN
           UPDATE PICK_ITEM SET DESPATCH_LOCATION = :WK_LOCN_ID,
              PICK_PICK_FINISH = :WK_DATE,
              PICK_LINE_STATUS = 'DS'
              WHERE DEVICE_ID = :WK_DEVICE 
              /* AND PICK_LINE_STATUS = 'PL'; */
              AND PICK_LINE_STATUS IN ( 'PL','CK','AC');
        END
        ELSE
        BEGIN
           UPDATE PICK_ITEM SET DESPATCH_LOCATION = :WK_LOCN_ID
              WHERE DEVICE_ID = :WK_DEVICE 
              /* AND PICK_LINE_STATUS = 'PL'; */
              AND PICK_LINE_STATUS IN ( 'PL','CK','AC');
        END
        IF (WK_PI_STATUS = 'DS') THEN
        BEGIN
           /* UPDATE PICK_ITEM_DETAIL SET PICK_DETAIL_STATUS = :WK_PI_STATUS */
           UPDATE PICK_ITEM_DETAIL SET DESPATCH_LOCATION = :WK_LOCN_ID,
              PICK_DETAIL_STATUS = :WK_PI_STATUS
              WHERE DEVICE_ID = :WK_DEVICE 
              AND PICK_DETAIL_STATUS = 'PL';
        END
     END
     ELSE
     BEGIN
        IF (NEW.TRN_CODE = 'D') THEN
        BEGIN
           FOR SELECT PICK_DETAIL_ID, SSN_ID 
              FROM PICK_ITEM_DETAIL 
              WHERE DEVICE_ID = :WK_DEVICE 
                AND PICK_DETAIL_STATUS = 'PL'
                AND PICK_LABEL_NO = :WK_LABEL_NO
               INTO :WK_PID_ID, :WK_SSN_ID
           DO
           BEGIN
              UPDATE ISSN SET ISSN_STATUS = :WK_PI_STATUS,
                  PREV_PREV_WH_ID = PREV_WH_ID,
                  PREV_PREV_LOCN_ID = PREV_LOCN_ID,
                  PREV_WH_ID = WH_ID,
                  PREV_LOCN_ID = LOCN_ID,
                  WH_ID = :WK_WH_ID,
                  LOCN_ID = :WK_LOCN_ID
              WHERE SSN_ID = :WK_SSN_ID;
              UPDATE PICK_ITEM_DETAIL SET DESPATCH_LOCATION = :WK_LOCN_ID
              WHERE PICK_DETAIL_ID = :WK_PID_ID;
           END
           /* update item to PL or DS  
           */
           IF (WK_PI_STATUS = 'DS') THEN
           BEGIN
              UPDATE PICK_ITEM SET DESPATCH_LOCATION = :WK_LOCN_ID,
                 PICK_LINE_STATUS = 'DS'
                 WHERE DEVICE_ID = :WK_DEVICE 
                 /* AND PICK_LINE_STATUS = 'PL' */
                 AND PICK_LINE_STATUS IN ( 'PL','CK','AC')
                 AND PICK_LABEL_NO = :WK_LABEL_NO;
           END
           ELSE
           BEGIN
              UPDATE PICK_ITEM SET DESPATCH_LOCATION = :WK_LOCN_ID
                 WHERE DEVICE_ID = :WK_DEVICE 
                 AND PICK_LABEL_NO = :WK_LABEL_NO
                 /* AND PICK_LINE_STATUS = 'PL'; */
                 AND PICK_LINE_STATUS IN ( 'PL','CK','AC');
           END
           IF (WK_PI_STATUS = 'DS') THEN
           BEGIN
              /* UPDATE PICK_ITEM_DETAIL SET PICK_DETAIL_STATUS = :WK_PI_STATUS */
              UPDATE PICK_ITEM_DETAIL SET DESPATCH_LOCATION = :WK_LOCN_ID,
                 PICK_DETAIL_STATUS = :WK_PI_STATUS
                 WHERE DEVICE_ID = :WK_DEVICE 
                 AND PICK_LABEL_NO = :WK_LABEL_NO
                 AND PICK_DETAIL_STATUS = 'PL';
           END
        END
        ELSE
        BEGIN
           IF (NEW.TRN_CODE = 'I') THEN
           BEGIN
              FOR SELECT PICK_DETAIL_ID, SSN_ID 
                 FROM PICK_ITEM_DETAIL 
                 WHERE DEVICE_ID = :WK_DEVICE 
                   AND PICK_DETAIL_STATUS = 'PL'
                   AND SSN_ID = :WK_OBJECT
                  INTO :WK_PID_ID, :WK_SSN_ID
              DO
              BEGIN
                 UPDATE ISSN SET ISSN_STATUS = :WK_PI_STATUS,
                     PREV_PREV_WH_ID = PREV_WH_ID,
                     PREV_PREV_LOCN_ID = PREV_LOCN_ID,
                     PREV_WH_ID = WH_ID,
                     PREV_LOCN_ID = LOCN_ID,
                     WH_ID = :WK_WH_ID,
                     LOCN_ID = :WK_LOCN_ID
                 WHERE SSN_ID = :WK_SSN_ID;
                 UPDATE PICK_ITEM_DETAIL SET DESPATCH_LOCATION = :WK_LOCN_ID
                 WHERE PICK_DETAIL_ID = :WK_PID_ID;
              END
              /* update item to PL or DS 
              */
              IF (WK_PI_STATUS = 'DS') THEN
              BEGIN
                 UPDATE PICK_ITEM SET DESPATCH_LOCATION = :WK_LOCN_ID,
                    PICK_LINE_STATUS = 'DS'
                    WHERE DEVICE_ID = :WK_DEVICE 
                    /* AND PICK_LINE_STATUS = 'PL' */
                    AND PICK_LINE_STATUS IN ( 'PL','CK','AC')
                    AND SSN_ID = :WK_OBJECT;
              END
              ELSE
              BEGIN
                 UPDATE PICK_ITEM SET DESPATCH_LOCATION = :WK_LOCN_ID
                    WHERE DEVICE_ID = :WK_DEVICE 
                    AND SSN_ID = :WK_OBJECT
                    /* AND PICK_LINE_STATUS = 'PL'; */
                    AND PICK_LINE_STATUS IN ( 'PL','CK','AC');
              END
              IF (WK_PI_STATUS = 'DS') THEN
              BEGIN
                 /* UPDATE PICK_ITEM_DETAIL SET PICK_DETAIL_STATUS = :WK_PI_STATUS */
                 UPDATE PICK_ITEM_DETAIL SET DESPATCH_LOCATION = :WK_LOCN_ID,
                    PICK_DETAIL_STATUS = :WK_PI_STATUS
                    WHERE DEVICE_ID = :WK_DEVICE 
                    AND SSN_ID = :WK_OBJECT
                    AND PICK_DETAIL_STATUS = 'PL';
              END
           END
           ELSE
           BEGIN
              IF (NEW.TRN_CODE = 'P') THEN
              BEGIN
                 /* class is P */
                 FOR SELECT PID.PICK_DETAIL_ID, PID.SSN_ID 
                    FROM PICK_ITEM_DETAIL PID 
                    JOIN ISSN ISS ON ISS.SSN_ID = PID.SSN_ID 
                    WHERE PID.DEVICE_ID = :WK_DEVICE 
                      AND PID.PICK_DETAIL_STATUS = 'PL'
                      AND ISS.PROD_ID = :WK_OBJECT
                     INTO :WK_PID_ID, :WK_SSN_ID
                 DO
                 BEGIN
                    UPDATE ISSN SET ISSN_STATUS = :WK_PI_STATUS,
                        PREV_PREV_WH_ID = PREV_WH_ID,
                        PREV_PREV_LOCN_ID = PREV_LOCN_ID,
                        PREV_WH_ID = WH_ID,
                        PREV_LOCN_ID = LOCN_ID,
                        WH_ID = :WK_WH_ID,
                        LOCN_ID = :WK_LOCN_ID
                    WHERE SSN_ID = :WK_SSN_ID;
                    UPDATE PICK_ITEM_DETAIL SET DESPATCH_LOCATION = :WK_LOCN_ID
                    WHERE PICK_DETAIL_ID = :WK_PID_ID;
                 END
                 /* update item to PL or DS 
                 */
                 IF (WK_PI_STATUS = 'DS') THEN
                 BEGIN
                    UPDATE PICK_ITEM SET DESPATCH_LOCATION = :WK_LOCN_ID,
                       PICK_LINE_STATUS = 'DS'
                       WHERE DEVICE_ID = :WK_DEVICE 
                       /* AND PICK_LINE_STATUS = 'PL' */
                       AND PICK_LINE_STATUS IN ( 'PL','CK','AC')
                       AND PROD_ID = :WK_OBJECT;
                 END
                 ELSE
                 BEGIN
                    UPDATE PICK_ITEM SET DESPATCH_LOCATION = :WK_LOCN_ID
                       WHERE DEVICE_ID = :WK_DEVICE 
                       AND PROD_ID = :WK_OBJECT
                       /* AND PICK_LINE_STATUS = 'PL'; */
                       AND PICK_LINE_STATUS IN ( 'PL','CK','AC');
                 END
                 IF (WK_PI_STATUS = 'DS') THEN
                 BEGIN
                    FOR SELECT PID.PICK_DETAIL_ID, PI.PICK_LINE_STATUS  
                       FROM PICK_ITEM_DETAIL  PID 
                       JOIN PICK_ITEM PI 
                       ON PI.PICK_LABEL_NO = PID.PICK_LABEL_NO
                       WHERE PID.DEVICE_ID = :WK_DEVICE 
                         AND PID.PICK_DETAIL_STATUS = 'PL'
                         AND PI.PROD_ID = :WK_OBJECT
                        INTO :WK_PID_ID, :WK_PI_STATUS2
                    DO
                    BEGIN
                       /* UPDATE PICK_ITEM_DETAIL SET PICK_DETAIL_STATUS = :WK_PI_STATUS2 */
                       UPDATE PICK_ITEM_DETAIL SET DESPATCH_LOCATION = :WK_LOCN_ID,
                          PICK_DETAIL_STATUS = :WK_PI_STATUS2
                          WHERE PICK_DETAIL_ID = :WK_PID_ID;
                    END
                 END
              END
              ELSE
              BEGIN
                 IF (NEW.TRN_CODE = 'G') THEN
                 BEGIN
   WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, 'in code G ' );
                    /* class is G */
                    /* WK_FROM_LOCN = ALLTRIM(WK_REF); */
                    WK_FROM_LOCN = V4ALLTRIM(WK_REF);
                    WK_ORDER = NEW.SUB_LOCN_ID;
                    IF (WK_ORDER = 'ORDER2BIG') THEN
                    BEGIN
                       EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_FROM_LOCN, 1  RETURNING_VALUES :WK_FROM_LOCN2 ; 
                       EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_FROM_LOCN, 2  RETURNING_VALUES :WK_ORDER ; 
                       WK_FROM_LOCN = WK_FROM_LOCN2;
                    END
                    /*   AND PID.DESPATCH_LOCATION = :WK_FROM_LOCN */
                    FOR SELECT PID.PICK_DETAIL_ID, PID.SSN_ID 
                       FROM PICK_ITEM_DETAIL PID 
                       JOIN PICK_ITEM PI ON PI.PICK_LABEL_NO = PID.PICK_LABEL_NO 
                       JOIN ISSN ISS ON ISS.SSN_ID = PID.SSN_ID 
                       WHERE PID.PICK_DETAIL_STATUS = 'PL'
                         AND PI.PICK_ORDER = :WK_ORDER
                         AND ISS.PROD_ID = :WK_OBJECT
                        INTO :WK_PID_ID, :WK_SSN_ID
                    DO
                    BEGIN
                       UPDATE ISSN SET ISSN_STATUS = :WK_PI_STATUS,
                           PREV_PREV_WH_ID = PREV_WH_ID,
                           PREV_PREV_LOCN_ID = PREV_LOCN_ID,
                           PREV_WH_ID = WH_ID,
                           PREV_LOCN_ID = LOCN_ID,
                           WH_ID = :WK_WH_ID,
                           LOCN_ID = :WK_LOCN_ID
                       WHERE SSN_ID = :WK_SSN_ID;
                       UPDATE PICK_ITEM_DETAIL SET DESPATCH_LOCATION = :WK_LOCN_ID
                       WHERE PICK_DETAIL_ID = :WK_PID_ID;
                    END
   WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, 'in 2 ' );
                    /* update item to PL or DS 
                    */
                    IF (WK_PI_STATUS = 'DS') THEN
                    BEGIN
                       /* for locations in pick_locations
                          if all issn gone from location
                          then update status */
                       FOR SELECT WH_ID, LOCN_ID 
                           FROM PICK_LOCATION
                           WHERE PICK_ORDER = :WK_ORDER
                           AND PICK_LOCATION_STATUS = 'OP'
                           AND LOCN_ID = :WK_FROM_LOCN
                           INTO :WK_PL_WH_ID, :WK_PL_LOCN_ID
                       DO
                       BEGIN
                          WK_ISS_ISSN_ID = NULL;
                          /*
                          SELECT FIRST 1 SSN_ID
                          FROM ISSN
                          WHERE WH_ID = :WK_PL_WH_ID
                          AND   LOCN_ID = :WK_PL_LOCN_ID
                          AND   CURRENT_QTY > 0
                          AND SSN_ID IN (SELECT PID.SSN_ID 
                                         FROM PICK_ITEM PI 
                                         JOIN PICK_ITEM_DETAIL PID ON PI.PICK_LABEL_NO = PID.PICK_LABEL_NO
                                         WHERE PI.PICK_ORDER = :WK_ORDER
                                         AND PID.PICK_DETAIL_STATUS <> 'XX' 
                                         AND PID.PICK_DETAIL_STATUS <> 'DX' )
                          INTO :WK_ISS_ISSN_ID;
                          */
   WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, 'in 3 ' );
                          IF (WK_ISS_ISSN_ID IS NULL) THEN
                          BEGIN
                             UPDATE PICK_LOCATION
                             SET PICK_LOCATION_STATUS = 'DS'
                             WHERE PICK_ORDER = :WK_ORDER
                             AND WH_ID = :WK_PL_WH_ID
                             AND   LOCN_ID = :WK_PL_LOCN_ID
                             AND PICK_LOCATION_STATUS = 'OP';
                          END
                       END
                       UPDATE PICK_ITEM SET DESPATCH_LOCATION = :WK_LOCN_ID,
                          PICK_LINE_STATUS = 'DS'
                          /* WHERE PICK_LINE_STATUS = 'PL' */
                          WHERE PICK_LINE_STATUS IN ( 'PL','CK','AC')
                          AND PICK_ORDER = :WK_ORDER
                          AND PROD_ID = :WK_OBJECT;
                    END
                    ELSE
                    BEGIN
                       UPDATE PICK_ITEM SET DESPATCH_LOCATION = :WK_LOCN_ID
                          /* WHERE PICK_LINE_STATUS = 'PL' */
                          WHERE PICK_LINE_STATUS IN ( 'PL','CK','AC')
                          AND PICK_ORDER = :WK_ORDER
                          AND PROD_ID = :WK_OBJECT;
                    END
   WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, 'in 4 ' );
                    IF (WK_PI_STATUS = 'DS') THEN
                    BEGIN
                       FOR SELECT PID.PICK_DETAIL_ID, PI.PICK_LINE_STATUS  
                          FROM PICK_ITEM_DETAIL  PID 
                          JOIN PICK_ITEM PI 
                          ON PI.PICK_LABEL_NO = PID.PICK_LABEL_NO
                          WHERE PID.PICK_DETAIL_STATUS = 'PL'
                            AND PI.PICK_ORDER = :WK_ORDER
                            AND PI.PROD_ID = :WK_OBJECT
                           INTO :WK_PID_ID, :WK_PI_STATUS2
                       DO
                       BEGIN
                          /* UPDATE PICK_ITEM_DETAIL SET PICK_DETAIL_STATUS = :WK_PI_STATUS2 */
                          UPDATE PICK_ITEM_DETAIL SET DESPATCH_LOCATION = :WK_LOCN_ID,
                              PICK_DETAIL_STATUS = :WK_PI_STATUS2
                             WHERE PICK_DETAIL_ID = :WK_PID_ID;
                       END
                    END
   WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, 'end code G ' );
                 END 
                 ELSE
                 BEGIN
                    /* class is L */
                    IF (NEW.TRN_CODE = 'L') THEN
                    BEGIN
                       EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_REF, 1  RETURNING_VALUES :WK_FROM_WH_ID ; 
                       EXECUTE PROCEDURE GET_REFERENCE_FIELD :WK_REF, 2  RETURNING_VALUES :WK_FROM_LOCN ; 
                       WK_ORDER = NEW.OBJECT;
                       /*   AND PID.DESPATCH_LOCATION = :WK_FROM_LOCN */
                       FOR SELECT PID.PICK_DETAIL_ID, PID.SSN_ID 
                          FROM PICK_ITEM PI 
                          JOIN PICK_ITEM_DETAIL PID ON PI.PICK_LABEL_NO = PID.PICK_LABEL_NO 
                          JOIN ISSN ISS ON ISS.SSN_ID = PID.SSN_ID 
                          WHERE PI.PICK_ORDER = :WK_ORDER
                            AND PID.PICK_DETAIL_STATUS = 'PL'
                            AND ISS.WH_ID = :WK_FROM_WH_ID
                            AND ISS.LOCN_ID = :WK_FROM_LOCN
                           INTO :WK_PID_ID, :WK_SSN_ID
                       DO
                       BEGIN
                          UPDATE ISSN SET ISSN_STATUS = :WK_PI_STATUS,
                              PREV_PREV_WH_ID = PREV_WH_ID,
                              PREV_PREV_LOCN_ID = PREV_LOCN_ID,
                              PREV_WH_ID = WH_ID,
                              PREV_LOCN_ID = LOCN_ID,
                              WH_ID = :WK_WH_ID,
                              LOCN_ID = :WK_LOCN_ID
                          WHERE SSN_ID = :WK_SSN_ID;
/*
                          UPDATE PICK_ITEM_DETAIL SET DESPATCH_LOCATION = :WK_LOCN_ID
                          WHERE PICK_DETAIL_ID = :WK_PID_ID;
*/
/*
                     update 1 pid.pick_detail_status is PL   despatch_location set
                     these records have pid and pick item and issn
                     from pick_item to pid to issn
*/
                       END
                       /* update item to PL or DS */
                       IF (WK_PI_STATUS = 'DS') THEN
                       BEGIN
                          /* for locations in pick_locations
                             if all issn gone from location
                             then update status */
                          FOR SELECT WH_ID, LOCN_ID 
                              FROM PICK_LOCATION
                              WHERE PICK_ORDER = :WK_ORDER
                              AND PICK_LOCATION_STATUS = 'OP'
                              AND PICK_LOCATION.WH_ID = :WK_FROM_WH_ID
                              AND PICK_LOCATION.LOCN_ID = :WK_FROM_LOCN
                              INTO :WK_PL_WH_ID, :WK_PL_LOCN_ID
                          DO
                          BEGIN
                             WK_ISS_ISSN_ID = NULL;
                             /*
                             SELECT FIRST 1 SSN_ID
                             FROM ISSN
                             WHERE WH_ID = :WK_PL_WH_ID
                             AND   LOCN_ID = :WK_PL_LOCN_ID
                             AND   CURRENT_QTY > 0
                             AND SSN_ID IN (SELECT PID.SSN_ID 
                                            FROM PICK_ITEM PI 
                                            JOIN PICK_ITEM_DETAIL PID ON PI.PICK_LABEL_NO = PID.PICK_LABEL_NO
                                            WHERE PI.PICK_ORDER = :WK_ORDER
                                            AND PID.PICK_DETAIL_STATUS <> 'XX' 
                                            AND PID.PICK_DETAIL_STATUS <> 'DX' )
                             INTO :WK_ISS_ISSN_ID;
                             */
                             IF (WK_ISS_ISSN_ID IS NULL) THEN
                             BEGIN
                                UPDATE PICK_LOCATION
                                SET PICK_LOCATION_STATUS = 'DS'
                                WHERE PICK_ORDER = :WK_ORDER
                                AND WH_ID = :WK_PL_WH_ID
                                AND   LOCN_ID = :WK_PL_LOCN_ID
                                AND PICK_LOCATION_STATUS = 'OP';
                             END
                          END
                          UPDATE PICK_ITEM SET DESPATCH_LOCATION = :WK_LOCN_ID,
                             PICK_LINE_STATUS = 'DS'
                             /* WHERE PICK_LINE_STATUS = 'PL' */
                             WHERE PICK_LINE_STATUS IN ( 'PL','CK','AC')
                             AND PICK_ORDER = :WK_ORDER
                             AND EXISTS( SELECT 1 
                                         FROM PICK_ITEM_DETAIL P3 
                                  WHERE  P3.PICK_LABEL_NO = PICK_ITEM.PICK_LABEL_NO
                                  AND   P3.DESPATCH_LOCATION = :WK_PL_LOCN_ID
                                  AND   P3.PICK_DETAIL_STATUS IN ('PG','PL') );
                          /* requires a pid record with despatch_location = the from_locn_id   */
                       END
                       ELSE
                       BEGIN
                          /* wk_pi_status is 'PL' */
                          /* dont know a value for WK_PL_LOCN_ID */
                          WK_PL_WH_ID = WK_FROM_WH_ID;
                          WK_PL_LOCN_ID = WK_FROM_LOCN;
                          UPDATE PICK_ITEM SET DESPATCH_LOCATION = :WK_LOCN_ID
                             /* WHERE PICK_LINE_STATUS = 'PL' */
                             WHERE PICK_LINE_STATUS IN ( 'PL','CK','AC')
                             AND PICK_ORDER = :WK_ORDER
                             AND EXISTS( SELECT 1 
                                         FROM PICK_ITEM_DETAIL P3 
                                  WHERE  P3.PICK_LABEL_NO = PICK_ITEM.PICK_LABEL_NO
                                  AND   P3.DESPATCH_LOCATION = :WK_PL_LOCN_ID
                                  AND   P3.PICK_DETAIL_STATUS IN ('PG','PL') );
                       END
                       IF (WK_PI_STATUS = 'DS') THEN
                       BEGIN
                          FOR SELECT PID.PICK_DETAIL_ID, PI.PICK_LINE_STATUS  
                             FROM PICK_ITEM_DETAIL  PID 
                             JOIN PICK_ITEM PI 
                             ON PI.PICK_LABEL_NO = PID.PICK_LABEL_NO
                             WHERE PID.PICK_DETAIL_STATUS = 'PL'
                               AND PI.PICK_ORDER = :WK_ORDER
                               AND   PID.DESPATCH_LOCATION = :WK_PL_LOCN_ID
                              INTO :WK_PID_ID, :WK_PI_STATUS2
                          DO
                          BEGIN
                             /* UPDATE PICK_ITEM_DETAIL SET PICK_DETAIL_STATUS = :WK_PI_STATUS2 */
                             UPDATE PICK_ITEM_DETAIL SET DESPATCH_LOCATION = :WK_LOCN_ID,
                                PICK_DETAIL_STATUS = :WK_PI_STATUS2
                                WHERE PICK_DETAIL_ID = :WK_PID_ID;
/*
                            update 2 this update dosnt require the issn record to exist
*/
                          END
                       END
                       ELSE
                       BEGIN
                          FOR SELECT PID.PICK_DETAIL_ID, PI.PICK_LINE_STATUS  
                             FROM PICK_ITEM_DETAIL  PID 
                             JOIN PICK_ITEM PI 
                             ON PI.PICK_LABEL_NO = PID.PICK_LABEL_NO
                             WHERE PID.PICK_DETAIL_STATUS = 'PL'
                               AND PI.PICK_ORDER = :WK_ORDER
                               AND   PID.DESPATCH_LOCATION = :WK_PL_LOCN_ID
                              INTO :WK_PID_ID, :WK_PI_STATUS2
                          DO
                          BEGIN
                             UPDATE PICK_ITEM_DETAIL SET DESPATCH_LOCATION = :WK_LOCN_ID
                                WHERE PICK_DETAIL_ID = :WK_PID_ID;
                          END
                       END
                    END
                 END
              END
           END
        END
     END
   EXECUTE PROCEDURE UPDATE_TRAN (WK_RECORD, 'T','Processed successfully');
/*
     WK_DATE_TXT = CAST(CAST('NOW' AS TIMESTAMP) AS CHAR(24));
     WK_LOG = 'TRN_TYPE ' || NEW.TRN_TYPE ||
     ' TRN_CODE ' || NEW.TRN_CODE || ' date ' || WK_DATE_TXT ||
     ' OBJECT ' || NEW.OBJECT || ' date ' || WK_DATE_TXT || ' do pkua ';
     INSERT INTO LOG(DESCRIPTION) VALUES(:WK_LOG);
   had to put pkua back for vb handheld
*/
/* stop this being here 
   EXECUTE PROCEDURE ADD_TRAN(
        :WK_DEVICE,
        '',
        '',
        'PKUA',
        'I',
        :WK_DATE,
        '',
        0,
        'F',
        '',
        'MASTER',
        0,
        '',
        'SSSSSSSSS',
        :WK_USER,
        :WK_DEVICE);
*/
   IF (NEW.COMPLETE = 'f') THEN
   BEGIN
      WK_DUMMY = '1';
   END
   ELSE
   BEGIN
     /* EXECUTE PROCEDURE TRAN_ARCHIVE; */
   END
/*
     WK_DATE_TXT = CAST(CAST('NOW' AS TIMESTAMP) AS CHAR(24));
     WK_LOG = 'TRN_TYPE ' || NEW.TRN_TYPE ||
     ' TRN_CODE ' || NEW.TRN_CODE || ' date ' || WK_DATE_TXT ||
     ' OBJECT ' || NEW.OBJECT || ' date ' || WK_DATE_TXT || ' end ';
     INSERT INTO LOG(DESCRIPTION) VALUES(:WK_LOG);
*/
   WK_LOG_RESULT = FILE_WRITELN(WK_LOG_FILENAME, 'end pkil  ' );
  END
 END
END ^


SET TERM ; ^
COMMIT WORK;
SET AUTODDL ON;
