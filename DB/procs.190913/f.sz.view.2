
CREATE OR ALTER VIEW ONSITE_SAFETY_EXPIRY (BARCODE, DESCRIPTION, WH, LOCATION_ID, INTO_DATE, LOCATION_NAME, SAFETY_CHECK, SAFETY_DATE, SAFETY_PERIOD, SAFETY_PER_NO, SAFETY_DAYS, SAFETY_EXPIRY_DATE, CALIBRATE_CHECK, CALIBRATE_DATE, CALIBRATE_PERIOD, CALIBRATE_PER_NO, CALIBRATE_DAYS, CALIBRATE_EXPIRY_DATE, SSN_TYPE, SAFETY_PASS, CALIBRATE_PASS) AS

SELECT 
     ISSN.SSN_ID AS BARCODE,
     TRIM(SSN.SSN_DESCRIPTION) AS DESCRIPTION,
     ISSN.WH_ID AS WH,
     ISSN.LOCN_ID AS LOCATION_ID,
     ISSN.INTO_DATE,
     REP_WH.DESCRIPTION AS LOCATION_NAME, 
     SSN.LOAN_SAFETY_CHECK AS SAFETY_CHECK,
     SSN.LOAN_LAST_SAFETY_CHECK_DATE AS SAFETY_DATE,
     SSN.LOAN_SAFETY_PERIOD AS SAFETY_PERIOD,
     SSN.LOAN_SAFETY_PERIOD_NO AS SAFETY_PER_NO,
     SSN.LOAN_SAFETY_PERIOD_NO * LSD.CODE AS SAFETY_DAYS, 
     CASE WHEN SSN.LOAN_SAFETY_PERIOD_NO IS NOT NULL AND SSN.LOAN_LAST_SAFETY_CHECK_DATE IS NOT NULL

     THEN DATEADD(DAY,( SSN.LOAN_SAFETY_PERIOD_NO * LSD.CODE) , SSN.LOAN_LAST_SAFETY_CHECK_DATE)

     ELSE NULL
     END  AS SAFETY_EXPIRY_DATE,
     SSN.LOAN_CALIBRATE_CHECK AS CALIBRATE_CHECK,
     SSN.LOAN_LAST_CALIBRATE_CHECK_DATE AS CALIBRATE_DATE,
     SSN.LOAN_CALIBRATE_PERIOD AS CALIBRATE_PERIOD,
     SSN.LOAN_CALIBRATE_PERIOD_NO AS CALIBRATE_PER_NO,
     SSN.LOAN_CALIBRATE_PERIOD_NO * LCD.CODE AS CALIBRATE_DAYS, 
     CASE WHEN SSN.LOAN_CALIBRATE_PERIOD_NO IS NOT NULL AND SSN.LOAN_LAST_CALIBRATE_CHECK_DATE IS NOT NULL
     THEN DATEADD(DAY,( SSN.LOAN_CALIBRATE_PERIOD_NO * LCD.CODE) , SSN.LOAN_LAST_CALIBRATE_CHECK_DATE)
     ELSE NULL
     END  AS CALIBRATE_EXPIRY_DATE,
     SSN.SSN_TYPE,
     SSN.LOAN_SAFETY_PASS AS SAFETY_PASS,
     SSN.LOAN_CALIBRATE_PASS AS CALIBRATE_PASS
FROM
     /* OPTIONS REP_WH
     JOIN ISSN ON REP_WH.GROUP_CODE = 'IRPT_WH_ID' AND REP_WH.CODE = ISSN.WH_ID  */
     WAREHOUSE REP_WH
     JOIN ISSN ON  REP_WH.WH_ID = ISSN.WH_ID 
     LEFT OUTER JOIN LOCATION ON ISSN.WH_ID = LOCATION.WH_ID AND ISSN.LOCN_ID = LOCATION.LOCN_ID
     LEFT OUTER JOIN SSN ON ISSN.ORIGINAL_SSN = SSN.SSN_ID
/*   LEFT OUTER JOIN OPTIONS LSD ON LSD.GROUP_CODE = 'LOAN_DAYS' AND SUBSTR(LSD.DESCRIPTION,1,1) = SSN.LOAN_SAFETY_PERIOD */
     LEFT OUTER JOIN OPTIONS LSD ON LSD.GROUP_CODE = 'LOAN_DAYS' AND SUBSTRING(LSD.DESCRIPTION FROM 1 FOR 1) = SSN.LOAN_SAFETY_PERIOD 
/*   LEFT OUTER JOIN OPTIONS LCD ON LCD.GROUP_CODE = 'LOAN_DAYS' AND SUBSTR(LCD.DESCRIPTION,1,1) = SSN.LOAN_CALIBRATE_PERIOD */
     LEFT OUTER JOIN OPTIONS LCD ON LCD.GROUP_CODE = 'LOAN_DAYS' AND SUBSTRING(LCD.DESCRIPTION FROM 1 FOR 1) = SSN.LOAN_CALIBRATE_PERIOD 
WHERE 
   ISSN.PROD_ID IS NULL
/*
SSN.LOAN_CALIBRATE_PERIOD IS NOT NULL OR
SSN.LOAN_SAFETY_PERIOD IS NOT NULL 
ORDER BY ISSN.WH_ID, ISSN.SSN_ID 
*/
ORDER BY ISSN.WH_ID, SSN.SSN_TYPE, ISSN.SSN_ID 
;

