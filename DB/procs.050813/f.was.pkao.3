DROP TRIGGER RUN_TRANSACTION_PKAO ^
COMMIT^
 
CREATE TRIGGER RUN_TRANSACTION_PKAO FOR TRANSACTIONS 
ACTIVE AFTER INSERT POSITION 120
AS
DECLARE VARIABLE WK_AUTORUN INTEGER;
DECLARE VARIABLE WK_DEVICE CHAR(2);
DECLARE VARIABLE WK_DEVICE_WH CHAR(2);
DECLARE VARIABLE WK_PI_PICKED_QTY INTEGER;
DECLARE VARIABLE WK_PID_PICKED_QTY INTEGER;
DECLARE VARIABLE WK_LABEL_NO VARCHAR(10);
DECLARE VARIABLE WK_PI_STATUS CHAR(2);
DECLARE VARIABLE WK_PI_SSN VARCHAR(20);
DECLARE VARIABLE WK_PI_PROD VARCHAR(30);
DECLARE VARIABLE WK_PI_ORDER_QTY INTEGER;
DECLARE VARIABLE WK_PI_PICK_QTY INTEGER;
DECLARE VARIABLE WK_PI_DESPATCH_LOCN VARCHAR(10);
DECLARE VARIABLE WK_PIR_PROD VARCHAR(30);
DECLARE VARIABLE WK_PIR_ORDER_QTY INTEGER;
DECLARE VARIABLE WK_RECORD INTEGER;
DECLARE VARIABLE WK_PID_SSN VARCHAR(20);
DECLARE VARIABLE WK_DATE TIMESTAMP;
DECLARE VARIABLE WK_USER VARCHAR(10);
DECLARE VARIABLE WK_FOUND INTEGER;
DECLARE VARIABLE WK_CANCEL CHAR(1);
DECLARE VARIABLE WK_ADJUST_TYPE CHAR(1);
DECLARE VARIABLE WK_PID_FROM_WH CHAR(2);
DECLARE VARIABLE WK_PID_FROM_LOCN VARCHAR(10);
DECLARE VARIABLE WK_ORDER VARCHAR(30);
DECLARE VARIABLE WK_FROM_WH CHAR(2);
DECLARE VARIABLE WK_FROM_LOCN VARCHAR(10);
DECLARE VARIABLE WK_TOPICK_QTY INTEGER;
DECLARE VARIABLE WK_USED_SSN VARCHAR(20);
DECLARE VARIABLE WK_IS_USED_QTY INTEGER;
DECLARE VARIABLE WK_DEFAULT_DESPATCH_LOCN VARCHAR(10);

BEGIN
/*
trn_type = PKAO
trn_code = 'O'
object = order
ref = comment
wh_id and locn_id = from_location (in pick_item_detail)

at the initial stage just cancel the order
*/

/*
then populate the changes to the pick_item from the pick_item_revised
*/

/*
later on - II
must get diferrence between pick_item and pick_item_revised
for pick_order_qty (diff = pick_item.pick_order_qty - pick_item_revised.pick_order_qty)
unpick that difference (similar to PKCN) diff > 0
*/

/*
later on - III
then pick the required remaining qty (diff < 0)
*/

 WK_AUTORUN = GEN_ID(AUTOEXEC_TRANSACTIONS,0); 
 IF (WK_AUTORUN = 1) THEN
 BEGIN
  IF (NEW.TRN_TYPE = 'PKAO') THEN
  BEGIN
     WK_DEVICE = NEW.DEVICE_ID;
     WK_DATE = NEW.TRN_DATE;
     WK_USER = NEW.PERSON_ID;
     WK_RECORD = NEW.RECORD_ID;
     WK_ADJUST_TYPE = NEW.TRN_CODE;
     WK_CANCEL = 'C';
     WK_ORDER = NEW.OBJECT;
     WK_FROM_WH = NEW.WH_ID;
     WK_FROM_LOCN = NEW.LOCN_ID;

     /* first recalc the pick_item difference qty */
  
     FOR SELECT
        PI.PROD_ID, SUM(PI.PICK_ORDER_QTY)
        FROM PICK_ITEM PI
        WHERE PI.PICK_ORDER = :WK_ORDER
        AND PI.PICK_LINE_STATUS IN ('OP','UP','CN','PG','PL','AL')
        AND (PI.PROD_ID IS NOT NULL)
        GROUP BY PI.PROD_ID 
        INTO :WK_PI_PROD, :WK_PI_ORDER_QTY
     DO
     BEGIN
        IF (WK_PI_ORDER_QTY IS NULL) THEN
        BEGIN
           WK_PI_ORDER_QTY = 0;
        END
        WK_PIR_ORDER_QTY = 0;
        SELECT PIR.PROD_ID, SUM(PIR.PICK_ORDER_QTY)
        FROM PICK_ITEM_REVISED PIR
        WHERE PIR.PICK_ORDER = :WK_ORDER
        AND PIR.PICK_LINE_STATUS IN ('OP','UP','CN')
        AND (PIR.PROD_ID = :WK_PI_PROD)
        GROUP BY PIR.PROD_ID 
        INTO :WK_PIR_PROD, :WK_PIR_ORDER_QTY;
        IF (WK_PIR_ORDER_QTY IS NULL) THEN
        BEGIN
           WK_PIR_ORDER_QTY = 0;
        END
        UPDATE PICK_ITEM 
        SET PICK_QTY_DIFFERENCE = ( :WK_PI_ORDER_QTY - :WK_PIR_ORDER_QTY )
        WHERE PICK_ORDER = :WK_ORDER
        AND PICK_LINE_STATUS IN ('OP','UP','CN','PG','PL','AL')
        AND PROD_ID = :WK_PI_PROD;
     END /* end do */
     FOR SELECT
        PIR.PROD_ID, SUM(PIR.PICK_ORDER_QTY)
        FROM PICK_ITEM_REVISED PIR
        WHERE PIR.PICK_ORDER = :WK_ORDER
        AND PIR.PICK_LINE_STATUS IN ('OP','UP','CN')
        AND (PIR.PROD_ID IS NOT NULL)
        GROUP BY PIR.PROD_ID 
        INTO :WK_PIR_PROD, :WK_PIR_ORDER_QTY
     DO
     BEGIN
        IF (WK_PIR_ORDER_QTY IS NULL) THEN
        BEGIN
           WK_PIR_ORDER_QTY = 0;
        END
        WK_PI_ORDER_QTY = 0;
        SELECT PI.PROD_ID, SUM(PI.PICK_ORDER_QTY)
        FROM PICK_ITEM PI
        WHERE PI.PICK_ORDER = :WK_ORDER
        AND PI.PICK_LINE_STATUS IN ('OP','UP','CN','AL','PG','PL')
        AND (PI.PROD_ID = :WK_PIR_PROD)
        GROUP BY PI.PROD_ID 
        INTO :WK_PI_PROD, :WK_PI_ORDER_QTY;
        IF (WK_PI_ORDER_QTY IS NULL) THEN
        BEGIN
           WK_PI_ORDER_QTY = 0;
        END
        IF ((WK_PI_ORDER_QTY = 0) AND (WK_PIR_ORDER_QTY > 0)) THEN
        BEGIN
           UPDATE PICK_ITEM 
           SET PICK_QTY_DIFFERENCE = ( :WK_PI_ORDER_QTY - :WK_PIR_ORDER_QTY )
           WHERE PICK_ORDER = :WK_ORDER
           AND PICK_LINE_STATUS IN ('OP','UP','CN','AL','PG','PL')
           AND PROD_ID = :WK_PIR_PROD;
           UPDATE PICK_ITEM_REVISED 
           SET PICK_QTY_DIFFERENCE = ( :WK_PI_ORDER_QTY - :WK_PIR_ORDER_QTY )
           WHERE PICK_ORDER = :WK_ORDER
           AND PICK_LINE_STATUS IN ('OP','UP','CN','AL','PG','PL')
           AND PROD_ID = :WK_PIR_PROD;
           
        END
     END /* do */

     /* save prev status  and from location in issn for move back */
     FOR SELECT PID.SSN_ID , PI.SSN_ID, PI.PROD_ID, PID.FROM_WH_ID, PID.FROM_LOCN_ID
         FROM PICK_ITEM_DETAIL PID
         JOIN PICK_ITEM PI ON PI.PICK_LABEL_NO = PID.PICK_LABEL_NO
         WHERE PI.PICK_ORDER = :WK_ORDER 
           AND (PID.PICK_DETAIL_STATUS = 'PG'
           OR PID.PICK_DETAIL_STATUS = 'PL')
         INTO :WK_PID_SSN, :WK_PI_SSN, :WK_PI_PROD, :WK_PID_FROM_WH, :WK_PID_FROM_LOCN
     DO
     BEGIN
        IF (WK_PI_SSN IS NOT NULL) THEN
        BEGIN
           IF (WK_CANCEL = 'C') THEN
           BEGIN
              UPDATE ISSN SET ISSN_STATUS = 'PA',
                  WH_ID = :WK_PID_FROM_WH,
                  LOCN_ID = :WK_PID_FROM_LOCN,
                  PICK_ORDER = NULL
               WHERE SSN_ID = :WK_PID_SSN;
           END
           ELSE
           BEGIN
              UPDATE ISSN SET ISSN_STATUS = 'RS',
                  WH_ID = :WK_PID_FROM_WH,
                  LOCN_ID = :WK_PID_FROM_LOCN
               WHERE SSN_ID = :WK_PID_SSN;
           END
        END
        ELSE
        BEGIN
           UPDATE ISSN SET ISSN_STATUS = 'PA',
                  WH_ID = :WK_PID_FROM_WH,
                  LOCN_ID = :WK_PID_FROM_LOCN
            WHERE SSN_ID = :WK_PID_SSN;
        END
     END
     FOR SELECT SUM(PID.QTY_PICKED), PID.PICK_LABEL_NO 
         FROM PICK_ITEM_DETAIL PID
         JOIN PICK_ITEM PI ON PI.PICK_LABEL_NO = PID.PICK_LABEL_NO
         WHERE PI.PICK_ORDER = :WK_ORDER 
           AND (PID.PICK_DETAIL_STATUS = 'PG'
           OR PID.PICK_DETAIL_STATUS = 'PL')
         GROUP BY PID.PICK_LABEL_NO
         INTO :WK_PID_PICKED_QTY, :WK_LABEL_NO
     DO
     BEGIN
        SELECT PICKED_QTY 
        FROM PICK_ITEM
        WHERE PICK_LABEL_NO = :WK_LABEL_NO
         INTO :WK_PI_PICKED_QTY;
        WK_PI_PICKED_QTY = WK_PI_PICKED_QTY - WK_PID_PICKED_QTY; 
        /* recalc pick_item status */
        IF (WK_PI_PICKED_QTY = 0) THEN
        BEGIN
           IF (WK_CANCEL = 'C') THEN
           BEGIN
              WK_PI_STATUS = 'CN';
           END
           ELSE
           BEGIN
              WK_PI_STATUS = 'OP';
           END
        END
        ELSE
        BEGIN
           WK_PI_STATUS = 'PG';
        END
        UPDATE PICK_ITEM
        SET  PICK_LINE_STATUS = :WK_PI_STATUS,
             PICKED_QTY = :WK_PI_PICKED_QTY
        WHERE PICK_LABEL_NO = :WK_LABEL_NO;
     END
     IF (WK_CANCEL = 'C') THEN
     BEGIN
        WK_PI_STATUS = 'CN';
     END
     ELSE
     BEGIN
        WK_PI_STATUS = 'UP';
     END
     FOR SELECT PICK_LABEL_NO 
         FROM PICK_ITEM
         WHERE PICK_ORDER = :WK_ORDER 
           AND (PICK_LINE_STATUS = 'PG'
           OR PICK_LINE_STATUS = 'PL')
         INTO :WK_LABEL_NO
     DO
     BEGIN
        WK_FOUND = 0;
        SELECT COUNT(*) FROM PICK_ITEM_DETAIL
           WHERE (PICK_DETAIL_STATUS = 'PG'
           OR PICK_DETAIL_STATUS = 'PL')
             AND PICK_LABEL_NO = :WK_LABEL_NO
           INTO :WK_FOUND;
        IF (WK_FOUND = 0) THEN
        BEGIN
           /* no details for pick item */
           UPDATE PICK_ITEM
           SET  PICK_LINE_STATUS = :WK_PI_STATUS,
                DEVICE_ID = NULL
           WHERE PICK_LABEL_NO = :WK_LABEL_NO;
        END
     END
     UPDATE PICK_ITEM
     SET  PICK_LINE_STATUS = :WK_PI_STATUS,
          DEVICE_ID = NULL
     WHERE PICK_ORDER = :WK_ORDER 
       AND PICK_LINE_STATUS IN ('AL');
     UPDATE PICK_ITEM_DETAIL
     SET  PICK_DETAIL_STATUS = 'XX',
          DEVICE_ID = LOWER(DEVICE_ID)
     WHERE PICK_LABEL_NO IN (SELECT PICK_LABEL_NO FROM PICK_ITEM WHERE PICK_ORDER = :WK_ORDER) 
        AND (PICK_DETAIL_STATUS = 'PG'
        OR PICK_DETAIL_STATUS = 'PL');
     
     EXECUTE PROCEDURE UPDATE_TRAN (WK_RECORD, 'T','Processed successfully');
/*
   EXECUTE PROCEDURE ADD_TRAN(
        :WK_DEVICE,
        '',
        '',
        'PKUA',
        'I',
        :WK_DATE,
        '',
        0,
        'F',
        '',
        'MASTER',
        0,
        '',
        'SSSSSSSSS',
        :WK_USER,
        :WK_DEVICE);
*/
     /* ok have canceled the order */
     /* so now put in the changes to the pick item */
  
     FOR SELECT
        PI.PROD_ID, SUM(PI.PICK_ORDER_QTY)
        FROM PICK_ITEM PI
        WHERE PI.PICK_ORDER = :WK_ORDER
        AND PI.PICK_LINE_STATUS IN ('OP','UP','CN')
        AND (PI.PROD_ID IS NOT NULL)
        GROUP BY PI.PROD_ID 
        INTO :WK_PI_PROD, :WK_PI_ORDER_QTY
     DO
     BEGIN
        IF (WK_PI_ORDER_QTY IS NULL) THEN
        BEGIN
           WK_PI_ORDER_QTY = 0;
        END
        WK_PIR_ORDER_QTY = 0;
        SELECT PIR.PROD_ID, SUM(PIR.PICK_ORDER_QTY)
        FROM PICK_ITEM_REVISED PIR
        WHERE PIR.PICK_ORDER = :WK_ORDER
        AND PIR.PICK_LINE_STATUS IN ('OP','UP','CN')
        AND (PIR.PROD_ID = :WK_PI_PROD)
        GROUP BY PIR.PROD_ID 
        INTO :WK_PIR_PROD, :WK_PIR_ORDER_QTY;
        IF (WK_PIR_ORDER_QTY IS NULL) THEN
        BEGIN
           WK_PIR_ORDER_QTY = 0;
        END
        IF (WK_PI_ORDER_QTY = WK_PIR_ORDER_QTY) THEN
        BEGIN
           /* match in both tables */
           UPDATE PICK_ITEM 
           SET PICK_LINE_STATUS = 'OP'
           WHERE PICK_ORDER = :WK_ORDER
           AND PICK_LINE_STATUS IN ('CN')
           AND PROD_ID = :WK_PI_PROD;
        END
        ELSE
        BEGIN
           IF (WK_PIR_ORDER_QTY > 0) THEN
           BEGIN
              UPDATE PICK_ITEM 
              SET PICK_LINE_STATUS = 'OP',
                  PICK_ORDER_QTY = :WK_PIR_ORDER_QTY
              WHERE PICK_ORDER = :WK_ORDER
              AND PICK_LINE_STATUS IN ('CN')
              AND PROD_ID = :WK_PI_PROD;
           END
           ELSE
           BEGIN
              UPDATE PICK_ITEM 
              SET PICK_ORDER_QTY = :WK_PIR_ORDER_QTY
              WHERE PICK_ORDER = :WK_ORDER
              AND PICK_LINE_STATUS IN ('CN')
              AND PROD_ID = :WK_PI_PROD;
           END
        END
     END /* end do */
     FOR SELECT
        PIR.PROD_ID, SUM(PIR.PICK_ORDER_QTY)
        FROM PICK_ITEM_REVISED PIR
        WHERE PIR.PICK_ORDER = :WK_ORDER
        AND PIR.PICK_LINE_STATUS IN ('OP','UP','CN')
        AND (PIR.PROD_ID IS NOT NULL)
        GROUP BY PIR.PROD_ID 
        INTO :WK_PIR_PROD, :WK_PIR_ORDER_QTY
     DO
     BEGIN
        IF (WK_PIR_ORDER_QTY IS NULL) THEN
        BEGIN
           WK_PIR_ORDER_QTY = 0;
        END
        WK_PI_ORDER_QTY = 0;
        SELECT PI.PROD_ID, SUM(PI.PICK_ORDER_QTY)
        FROM PICK_ITEM PI
        WHERE PI.PICK_ORDER = :WK_ORDER
        AND PI.PICK_LINE_STATUS IN ('OP','UP','CN')
        AND (PI.PROD_ID = :WK_PIR_PROD)
        GROUP BY PI.PROD_ID 
        INTO :WK_PI_PROD, :WK_PI_ORDER_QTY;
        IF (WK_PI_ORDER_QTY IS NULL) THEN
        BEGIN
           WK_PI_ORDER_QTY = 0;
        END
        IF ((WK_PI_ORDER_QTY = 0) AND (WK_PIR_ORDER_QTY > 0)) THEN
        BEGIN
           IF (WK_PI_PROD IS NULL) THEN
           BEGIN
              /* only in revised table */
              /* add to pick_item */
              INSERT INTO PICK_ITEM(
                 PICK_ORDER, 
                 PICK_LABEL_NO,
                 PICK_ORDER_LINE_NO,
                 PICK_LINE_STATUS, 
                 PICK_ORDER_QTY, 
                 PROD_ID,
                 PICK_RETRIEVE_STATUS,
                 CREATE_DATE,
                 USER_ID,
                 SSN_CONFIRM,
                 PICK_QTY_DIFFERENCE)
              SELECT 
                 PICK_ORDER, 
                 PICK_LABEL_NO,
                 PICK_ORDER_LINE_NO,
                 PICK_LINE_STATUS, 
                 PICK_ORDER_QTY, 
                 PROD_ID,
                 PICK_RETRIEVE_STATUS,
                 CREATE_DATE,
                 USER_ID,
                 SSN_CONFIRM,
                 PICK_QTY_DIFFERENCE
              FROM PICK_ITEM_REVISED
              WHERE PICK_ORDER = :WK_ORDER
              AND PROD_ID = :WK_PIR_PROD;
           END
           ELSE
           BEGIN
              UPDATE PICK_ITEM 
              SET PICK_LINE_STATUS = 'OP',
                  PICK_ORDER_QTY = :WK_PIR_ORDER_QTY
              WHERE PICK_ORDER = :WK_ORDER
              AND PICK_LINE_STATUS IN ('CN')
              AND PROD_ID = :WK_PIR_PROD;
           END
           
        END
     END /* end do */
     /* ok have adjusted the pick item for the differences */
     /* so must pick it - to despatch */
     SELECT FIRST 1 WH_ID 
     FROM LOCATION
     WHERE LOCN_ID = :WK_DEVICE
     INTO WK_DEVICE_WH;
     SELECT DEFAULT_DESPATCH_LOCATION
     FROM CONTROL
     INTO :WK_DEFAULT_DESPATCH_LOCN;

     FOR SELECT  PROD_ID, PICK_QTY_DIFFERENCE, PICK_LABEL_NO, PICKED_QTY, DESPATCH_LOCATION 
     FROM PICK_ITEM
     WHERE PICK_ORDER = :WK_ORDER
     AND PICK_LINE_STATUS IN ('OP','UP')
     AND PICK_QTY_DIFFERENCE < 0
     INTO :WK_PI_PROD, :WK_PI_PICK_QTY, :WK_LABEL_NO, :WK_PI_PICKED_QTY, :WK_PI_DESPATCH_LOCN
     DO
     BEGIN
        WK_TOPICK_QTY = 0 - WK_PI_PICK_QTY;
        IF (WK_PI_PICKED_QTY IS NULL) THEN
        BEGIN
           WK_PI_PICKED_QTY = 0;
        END
        /* ok have pick line */
        /* allocate it to me */
        UPDATE PICK_ITEM 
        SET USER_ID = :WK_USER,
            DEVICE_ID = :WK_DEVICE,
            PICK_LINE_STATUS = 'AL'
        WHERE PICK_LABEL_NO = :WK_LABEL_NO;
        /* create the stock */
        /* do pkol */
        WK_PI_STATUS = 'PL';
        EXECUTE PROCEDURE ADD_ISSN ('' ,
              :WK_FROM_WH,
              :WK_FROM_LOCN,
              '',
              :WK_TOPICK_QTY,
              :WK_TOPICK_QTY,
              'NOW',
              'ST',
              '',
              'NOW',
              :WK_USER ,
              :WK_PI_PROD,
              1);
        SELECT FIRST 1 CURRENT_QTY, SSN_ID
            FROM ISSN
            WHERE PROD_ID = :WK_PI_PROD
            AND WH_ID = :WK_FROM_WH
            AND LOCN_ID = :WK_FROM_LOCN
            AND ISSN.ISSN_STATUS = 'ST'
            AND CURRENT_QTY = :WK_TOPICK_QTY
            INTO :WK_IS_USED_QTY, :WK_USED_SSN;
        UPDATE ISSN SET ISSN_STATUS = :WK_PI_STATUS,
            PREV_PREV_WH_ID = PREV_WH_ID,
            PREV_PREV_LOCN_ID = PREV_LOCN_ID,
            PREV_WH_ID = WH_ID,
            PREV_LOCN_ID = LOCN_ID,
            WH_ID = :WK_DEVICE_WH,
            LOCN_ID = :WK_DEVICE
         WHERE SSN_ID = :WK_USED_SSN;
        EXECUTE PROCEDURE ADD_SSN_HIST(:WK_DEVICE_WH, :WK_DEVICE, :WK_USED_SSN, 
                 'PKOL', 'P', :WK_DATE,
                 'Automatic Pick' , '', :WK_IS_USED_QTY, :WK_USER, :WK_DEVICE); 
        /* no detail record */
        INSERT INTO PICK_ITEM_DETAIL 
            (PICK_LABEL_NO, 
             SSN_ID, 
             PICK_DETAIL_STATUS, 
             QTY_PICKED,
             USER_ID, 
             DEVICE_ID, 
             CREATE_DATE,
             FROM_WH_ID,
             FROM_LOCN_ID)
        VALUES (:WK_LABEL_NO, 
             :WK_USED_SSN,
             :WK_PI_STATUS,
             :WK_IS_USED_QTY,
             :WK_USER,
             :WK_DEVICE,
             :WK_DATE,
             :WK_FROM_WH,
             :WK_FROM_LOCN);
        WK_PI_PICKED_QTY = WK_PI_PICKED_QTY + WK_TOPICK_QTY;
        UPDATE PICK_ITEM
        SET  PICK_LINE_STATUS =
                :WK_PI_STATUS,
                PICKED_QTY = :WK_PI_PICKED_QTY
        WHERE PICK_LABEL_NO = :WK_LABEL_NO;
        /* do pkil */
        IF (WK_PI_DESPATCH_LOCN IS NULL) THEN
        BEGIN
           WK_PI_DESPATCH_LOCN = WK_DEFAULT_DESPATCH_LOCN;
        END
        EXECUTE PROCEDURE ADD_TRAN(
             :WK_DEVICE_WH,
             :WK_PI_DESPATCH_LOCN,
             :WK_PI_PROD,
             'PKIL',
             'P',
             :WK_DATE,
             '',
             :WK_PI_PICKED_QTY,
             'F',
             '',
             'MASTER',
             0,
             '',
             'SSSSSSSSS',
             :WK_USER,
             :WK_DEVICE);
        
     END
   /* EXECUTE PROCEDURE TRAN_ARCHIVE; */
  END
 END
END ^
